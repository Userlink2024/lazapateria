<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Facturación y Pagos</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'success': '#10b981', /* Color para pago y completado */
                        'background': '#f9fafb',
                        'surface': '#ffffff'
                    }
                }
            }
        }
    </script>
    <!-- Fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        /* Estilo para el contenedor de mensajes */
        #message-container {
            min-height: 40px; /* Para evitar CLS */
        }
        /* Estilo para el Canvas de Progreso */
        /* Aseguramos que el canvas siempre se vea en la lista */
        .progress-canvas {
            width: 70px;
            height: 70px;
            display: block;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Control de Facturación y Pagos</h1>
        <p class="text-gray-500 mb-2">Gestión pública de pedidos y facturación parcial.</p>
        <p class="text-sm text-gray-500 mb-6">
            <span class="font-semibold">ID de Usuario: </span>
            <span id="display-user-id" class="text-primary font-mono bg-gray-100 px-2 py-0.5 rounded text-xs">Cargando...</span>
            <span class="text-red-500 font-semibold">(Acceso de escritura PÚBLICO)</span>
        </p>

        <!-- Mensajes del Sistema (Reemplaza a alert/confirm) -->
        <div id="message-container" class="fixed top-0 left-0 right-0 z-50 flex items-start justify-center pointer-events-none">
            <!-- Los mensajes se insertarán aquí por JS -->
        </div>

        <!-- Alerta de Error de Configuración (Nueva) -->
        <div id="config-error-alert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong class="font-bold">Error de Conexión a Base de Datos:</strong>
            <span class="block sm:inline" id="config-error-message"></span>
            <p class="mt-2 text-sm">Verifica la configuración de Firebase y que las **Reglas de Seguridad** permitan `allow read, write: if request.auth != null;` para el acceso público.</p>
        </div>


        <!-- Modal Overlay para Confirmación/Input (Reemplaza a prompt/confirm) -->
        <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
            <div id="modal-content" class="bg-surface rounded-xl shadow-2xl p-6 w-full max-w-lg">
                <!-- El contenido del modal se inyectará dinámicamente -->
            </div>
        </div>
        
        <!-- --- PESTAÑAS DE NAVEGACIÓN --- -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-4">
                <button data-view="pending" class="tab-button py-2 px-4 text-sm font-medium border-b-2 border-primary text-primary transition-colors duration-200">
                    Pre-facturas Pendientes
                </button>
                <button data-view="paid" class="tab-button py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition-colors duration-200">
                    Facturas Pagadas
                </button>
            </nav>
        </div>
        <!-- --- FIN PESTAÑAS DE NAVEGACIÓN --- -->

        <!-- Vista: Pending (Registrar y Listar Pre-facturas) -->
        <div id="view-pending">
            <!-- Formulario para Nueva Pre-factura -->
            <div class="bg-surface shadow-xl rounded-xl p-6 mb-8 border border-gray-100">
                <h2 class="text-2xl font-semibold text-primary mb-4">Registrar Nueva Pre-factura</h2>
                <form id="prefactura-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Fecha -->
                        <div>
                            <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                            <input type="date" id="fecha" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-primary focus:ring-primary">
                        </div>
                        <!-- Consecutivo -->
                        <div>
                            <label for="consecutivo" class="block text-sm font-medium text-gray-700">Consecutivo (ID)</label>
                            <input type="text" id="consecutivo" placeholder="Ej: PFT-2025001" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-primary focus:ring-primary">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Valor Total -->
                        <div>
                            <label for="valor" class="block text-sm font-medium text-gray-700">Valor Total ($)</label>
                            <input type="number" id="valor" step="0.01" min="0" placeholder="1000.00" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-primary focus:ring-primary">
                        </div>
                        <!-- Ganancia de Factura -->
                        <div>
                            <label for="ganancia" class="block text-sm font-medium text-gray-700">Ganancia Total ($)</label>
                            <input type="number" id="ganancia" step="0.01" min="0" placeholder="200.00" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-primary focus:ring-primary">
                        </div>
                    </div>

                    <!-- SECCIÓN DE MÚLTIPLES REFERENCIAS -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium text-gray-700 pt-2 border-t border-gray-100">Detalle de Items por Referencia</h3>
                        <div id="item-lines-container" class="space-y-3 p-3 border rounded-lg bg-gray-50">
                            <!-- Líneas de items se insertarán aquí por JS -->
                        </div>
                        <button type="button" id="add-item-btn" class="w-full py-2 px-4 border border-primary text-primary rounded-lg hover:bg-primary/10 transition ease-in-out duration-150 font-medium">
                            + Agregar Referencia
                        </button>
                    </div>
                    
                    <!-- Resumen de Items Totales -->
                    <div class="p-3 bg-indigo-50 rounded-lg text-sm font-medium text-gray-700 border border-indigo-200">
                        Total de Items en Pre-factura (Calculado): <span id="summary-total-items" class="font-bold text-primary text-lg">0</span>
                    </div>
                    
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-md text-white font-medium bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition ease-in-out duration-150">
                        Guardar Pre-factura
                    </button>
                </form>
            </div>

            <!-- Lista de Pre-facturas -->
            <div class="bg-surface shadow-xl rounded-xl p-6 border border-gray-100">
                <h2 class="text-2xl font-semibold text-primary mb-4">Pre-facturas Pendientes y Completadas</h2>
                <div id="prefacturas-list" class="space-y-4">
                    <p id="loading-indicator" class="text-center text-gray-500">Cargando datos...</p>
                    <!-- Las pre-facturas se renderizarán aquí -->
                </div>
            </div>
        </div>

        <!-- Vista: Paid (Facturas Pagadas) -->
        <div id="view-paid" class="hidden">
            <div class="bg-surface shadow-xl rounded-xl p-6 border border-gray-100">
                <h2 class="text-2xl font-semibold text-success mb-4">Historial de Facturas Pagadas</h2>
                <div id="paid-invoices-list" class="space-y-4">
                    <p class="text-center text-gray-500 py-4">Cargando historial de pagos...</p>
                    <!-- Las facturas pagadas se renderizarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Script de Firebase y Lógica de la Aplicación -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, setDoc, updateDoc, deleteDoc, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuración de Firebase y Variables Globales
        // Usamos un ID de app por defecto si __app_id no está definido (aunque debería estarlo)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-prefactura-app'; 
        
        // OBLIGATORIO: Token de autenticación inicial proporcionado por el entorno Canvas
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // CONFIGURACIÓN DE FIREBASE DEL USUARIO (lazapateria-ce24f)
        const DEFAULT_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCwGpyvoUfbXE4rpPfLmHSdOK_VI4mT24M",
            authDomain: "lazapateria-ce24f.firebaseapp.com",
            projectId: "lazapateria-ce24f",
            storageBucket: "lazapateria-ce24f.firebasestorage.app",
            messagingSenderId: "642571845821",
            appId: "1:642571845821:web:45858a0abc0df728fd77d4",
            measurementId: "G-6JCF33H0K1"
        };


        let app, db, auth, userId = null;
        let isFirebaseReady = false; 
        setLogLevel('debug'); 
        let itemLineCounter = 0; 
        let prefacturasUnsubscribe = null; 
        let paidInvoicesUnsubscribe = null;
        let prefacturasData = []; 

        // --- Utilidades UI (showMessage, hideModal, showConfirm) ---
        
        function showMessage(text, type = 'success') {
            const container = document.getElementById('message-container');
            const color = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-secondary' : 'bg-blue-500');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-lg text-white font-medium shadow-lg pointer-events-auto ${color} m-4 transition-transform transform translate-y-0 opacity-100`;
            messageDiv.textContent = text;
            
            container.appendChild(messageDiv);
            
            while (container.children.length > 5) {
                container.removeChild(container.firstChild);
            }

            setTimeout(() => {
                messageDiv.classList.add('-translate-y-4', 'opacity-0');
                messageDiv.addEventListener('transitionend', () => messageDiv.remove());
            }, 3000);
        }

        const modalOverlay = document.getElementById('modal-overlay');
        const modalContent = document.getElementById('modal-content');

        function hideModal() {
            modalOverlay.classList.add('hidden');
            modalContent.innerHTML = '';
        }

        function showConfirm(title, message, onConfirm, onCancel = hideModal) {
            modalContent.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-900 mb-4">${title}</h3>
                <p class="text-gray-600 mb-6">${message}</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="py-2 px-4 text-sm font-medium rounded-lg text-gray-700 border border-gray-300 hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                    <button id="modal-confirm-btn" class="py-2 px-4 text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 transition">
                        Confirmar
                    </button>
                </div>
            `;
            modalOverlay.classList.remove('hidden');

            document.getElementById('modal-cancel-btn').addEventListener('click', onCancel);
            document.getElementById('modal-confirm-btn').addEventListener('click', () => {
                onConfirm();
                hideModal();
            });
        }
        
        // --- Configuración y Autenticación de Firebase (USANDO TU CONFIG) ---

        function initializeFirebase() {
            try {
                // CORRECCIÓN CLAVE: Usamos la variable global __firebase_config del entorno si existe, 
                // si no, usamos la configuración DEFAULT_FIREBASE_CONFIG del usuario.
                let firebaseConfig;
                if (typeof __firebase_config !== 'undefined') {
                    // Intenta usar la configuración del entorno Canvas
                    try {
                        firebaseConfig = JSON.parse(__firebase_config);
                        console.log("Usando configuración de Firebase proporcionada por el entorno.");
                    } catch (e) {
                        console.warn("No se pudo parsear __firebase_config. Usando configuración por defecto del usuario.", e);
                        firebaseConfig = DEFAULT_FIREBASE_CONFIG;
                    }
                } else {
                    // Si no está definida la variable global, usa la configuración por defecto del usuario
                    firebaseConfig = DEFAULT_FIREBASE_CONFIG;
                    console.warn("Variable __firebase_config no definida. Usando configuración por defecto del usuario.");
                }

                if (!firebaseConfig || !firebaseConfig.projectId) {
                    throw new Error("La configuración de Firebase no es válida (sin projectId).");
                }
                
                app = initializeApp(firebaseConfig); 
                db = getFirestore(app);
                auth = getAuth(app);
                isFirebaseReady = true;

                // 1. Intentar iniciar sesión con el token de Canvas o anónimamente
                let signInPromise;
                if (initialAuthToken) {
                    signInPromise = signInWithCustomToken(auth, initialAuthToken);
                } else {
                    signInPromise = signInAnonymously(auth);
                }

                signInPromise.catch(e => {
                    console.error("Error durante el proceso de inicio de sesión:", e);
                    // Muestra un un error si falla el proceso de autenticación inicial
                    showMessage(`ERROR DE AUTENTICACIÓN: ${e.code}. Verifica la configuración de Firebase.`, 'error');
                });

                // 2. Establecer el listener de estado de autenticación (CRUCIAL)
                onAuthStateChanged(auth, (user) => {
                    const displayUserIdElement = document.getElementById('display-user-id');
                    const loadingIndicator = document.getElementById('loading-indicator');

                    if (user) {
                        userId = user.uid;
                        displayUserIdElement.textContent = userId;
                        console.log("Usuario autenticado. ID:", userId);
                        loadingIndicator.textContent = 'Cargando datos...';
                        // IMPORTANTE: Solo configuramos los listeners cuando tenemos un ID de usuario válido.
                        setupRealtimeListeners(); 
                    } else {
                        // Si falla la autenticación, usamos un ID temporal para que las funciones no fallen, 
                        // aunque los listeners de Firestore probablemente den "Permission Denied".
                        userId = crypto.randomUUID(); 
                        displayUserIdElement.textContent = userId + ' (Anónimo Fallido - Temporal)';
                        console.warn("Usuario no autenticado, usando ID temporal. Los listeners de Firestore podrían fallar por permisos.");
                        loadingIndicator.textContent = 'Error de autenticación. Intentando cargar datos...';
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                // Mostrar la alerta de configuración
                document.getElementById('config-error-message').textContent = error.message;
                document.getElementById('config-error-alert').classList.remove('hidden');
                document.getElementById('loading-indicator').textContent = 'Error de configuración. No se pueden cargar los datos.';
                isFirebaseReady = false;
            }
        }
        
        // Llamar a la función de inicialización al cargar el script
        initializeFirebase();


        // --- RUTAS DE FIRESTORE (ACCESO PÚBLICO TOTAL) ---
        
        // RUTA: /artifacts/{appId}/public/data/prefacturas (COMO EL SHOWROOM)
        function getPrefacturasCollectionRef() {
            // Utilizamos la ruta pública que el Showroom.html usa y que concuerda con las reglas de seguridad comunes.
            const path = `artifacts/${appId}/public/data/prefacturas`;
            return collection(db, path);
        }
        
        // RUTA: /artifacts/{appId}/public/data/paid_invoices
        function getPaidInvoicesCollectionRef() {
            const path = `artifacts/${appId}/public/data/paid_invoices`;
            return collection(db, path);
        }

        // --- Lógica de Manejo de Líneas de Items (Múltiples Referencias) ---
        
        function updateItemSummary() {
            const itemLines = Array.from(document.querySelectorAll('.item-line-quantity'));
            let total = 0;
            itemLines.forEach(input => {
                const quantity = parseInt(input.value, 10) || 0;
                if (quantity > 0) {
                    total += quantity;
                }
            });
            document.getElementById('summary-total-items').textContent = total.toString();
        }

        function addItemLine(reference = 'SN01', quantity = '') {
            const container = document.getElementById('item-lines-container');
            const id = `line-${itemLineCounter++}`;

            const lineDiv = document.createElement('div');
            lineDiv.id = id;
            lineDiv.className = 'flex flex-col sm:flex-row gap-2 items-end';
            
            lineDiv.innerHTML = `
                <div class="w-full sm:w-1/2">
                    <label for="ref-${id}" class="block text-xs font-medium text-gray-500">Referencia</label>
                    <select id="ref-${id}" class="item-line-ref mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-primary focus:ring-primary text-sm">
                        <option value="SN01" ${reference === 'SN01' ? 'selected' : ''}>SN01 MULES CON ADORNO</option>
                        <option value="SN02" ${reference === 'SN02' ? 'selected' : ''}>SN02 MULES SIN ADORNO</option>
                    </select>
                </div>
                <div class="w-full sm:w-1/2">
                    <label for="qty-${id}" class="block text-xs font-medium text-gray-500">Cantidad</label>
                    <input type="number" id="qty-${id}" value="${quantity}" min="1" required 
                           class="item-line-quantity mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-primary focus:ring-primary text-sm"
                           placeholder="Cantidad">
                </div>
                <button type="button" class="remove-item-btn flex-shrink-0 p-2 text-red-500 hover:text-red-700 transition" data-line-id="${id}" title="Eliminar línea">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;

            container.appendChild(lineDiv);
            
            lineDiv.querySelector('.item-line-quantity').addEventListener('input', updateItemSummary);
            lineDiv.querySelector('.remove-item-btn').addEventListener('click', (e) => {
                const targetId = e.currentTarget.getAttribute('data-line-id');
                document.getElementById(targetId).remove();
                updateItemSummary();
            });

            updateItemSummary();
        }

        document.getElementById('add-item-btn').addEventListener('click', () => addItemLine());


        // --- Lógica de la Aplicación (CRUD) ---

        // 1. Agregar Nueva Pre-factura
        document.getElementById('prefactura-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isFirebaseReady || !userId) {
                showMessage("La base de datos no está lista o el usuario no está autenticado.", 'error');
                return;
            }

            const itemLinesElements = document.querySelectorAll('#item-lines-container > div');
            const item_lines = [];
            let aggregate_total_items = 0;

            if (itemLinesElements.length === 0) {
                showMessage("Debes agregar al menos una línea de referencia.", 'error');
                return;
            }
            
            let isValid = true;
            itemLinesElements.forEach(lineElement => {
                const reference = lineElement.querySelector('.item-line-ref').value;
                const quantityInput = lineElement.querySelector('.item-line-quantity');
                const quantity = parseInt(quantityInput.value, 10);
                
                if (isNaN(quantity) || quantity <= 0) {
                    isValid = false;
                }

                item_lines.push({
                    reference: reference,
                    quantity: quantity,
                    invoiced: 0 // Inicia facturado en 0
                });
                aggregate_total_items += quantity;
            });

            if (!isValid) {
                showMessage("Todas las cantidades de las líneas deben ser números positivos válidos.", 'error');
                return;
            }
            
            // Usamos el consecutivo como ID del documento, eliminando caracteres no válidos de Firestore.
            const docId = document.getElementById('consecutivo').value.trim().replace(/[^a-zA-Z0-9]/g, '_');
            
            if (!docId) {
                showMessage("El consecutivo no puede estar vacío.", 'error');
                return;
            }

            const data = {
                date: document.getElementById('fecha').value,
                consecutivo: document.getElementById('consecutivo').value.trim(),
                total_value: parseFloat(document.getElementById('valor').value),
                total_profit: parseFloat(document.getElementById('ganancia').value),
                
                item_lines: item_lines, 
                total_items: aggregate_total_items, 
                
                is_paid: false, 
                paid_at: null,  
                
                created_at: new Date().toISOString()
            };

            try {
                // Usamos setDoc con el consecutivo como ID del documento en la colección pública
                await setDoc(doc(getPrefacturasCollectionRef(), docId), data);
                showMessage(`Pre-factura ${data.consecutivo} guardada con éxito.`, 'success');
                
                // Limpiar formulario
                e.target.reset(); 
                document.getElementById('item-lines-container').innerHTML = ''; 
                addItemLine(); 
            } catch (error) {
                console.error("Error al guardar la pre-factura:", error);
                // Muestra un error específico sobre la conexión/permisos
                showMessage(`ERROR AL GUARDAR: ${error.message}. Revisa la consola y tus Reglas de Seguridad.`, 'error');
            }
        });

        // 2. Actualizar la Cantidad Facturada Parcialmente
        async function updateFacturacion(docId, itemLines) {
            if (!isFirebaseReady || !userId) {
                showMessage("Esperando conexión a Firebase o autenticación.", 'error');
                return;
            }
            
            const availableLines = itemLines.filter(line => line.quantity > (line.invoiced || 0));
            
            if (availableLines.length === 0) {
                showMessage(`La pre-factura ${docId} ya está totalmente facturada.`, 'info');
                return;
            }

            const currentTotalInvoiced = itemLines.reduce((acc, line) => acc + (line.invoiced || 0), 0);
            const totalItemsAggregate = itemLines.reduce((acc, line) => acc + (line.quantity || 0), 0);

            const linesInputHtml = availableLines.map(line => {
                const remaining = line.quantity - (line.invoiced || 0);
                return `
                    <div class="p-3 border rounded-lg bg-gray-50 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <label class="text-sm font-medium text-gray-700 w-full sm:w-1/3 flex-shrink-0">${line.reference}</label>
                        <div class="text-sm text-gray-500 w-full sm:w-1/3 text-center">Pendiente: <span class="font-bold text-primary">${remaining}</span></div>
                        <input type="number" 
                               data-reference="${line.reference}" 
                               data-max-qty="${remaining}"
                               value="0" 
                               min="0" 
                               max="${remaining}"
                               class="modal-invoice-qty mt-1 block w-full sm:w-1/3 rounded-lg border-gray-300 shadow-sm p-2 border focus:border-primary focus:ring-primary text-sm text-right transition"
                               placeholder="Cantidad a facturar">
                    </div>
                `;
            }).join('');


            modalContent.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Facturar Items: ${docId}</h3>
                <p class="text-gray-600 mb-4">Ingresa la cantidad a facturar en este movimiento. Solo las líneas con valor > 0 serán registradas.</p>
                
                <div id="modal-lines-container" class="mb-6 space-y-3 max-h-60 overflow-y-auto pr-2 border p-2 rounded-lg">
                    ${linesInputHtml}
                </div>

                <div class="p-3 bg-indigo-50 rounded-lg text-sm font-medium text-gray-700 border border-indigo-200 mb-6">
                    Progreso Global: ${currentTotalInvoiced} / ${totalItemsAggregate} Items facturados.
                </div>

                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                    <button id="modal-cancel-btn" class="py-2 px-4 text-sm font-medium rounded-lg text-gray-700 border border-gray-300 hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                    <button id="modal-submit-btn" class="py-2 px-4 text-sm font-medium rounded-lg text-white bg-primary hover:bg-indigo-700 transition">
                        Registrar Factura
                    </button>
                </div>
            `;
            modalOverlay.classList.remove('hidden');

            document.getElementById('modal-cancel-btn').addEventListener('click', hideModal);
            
            document.getElementById('modal-submit-btn').addEventListener('click', async () => {
                const qtyInputs = document.querySelectorAll('.modal-invoice-qty');
                const invoiceChanges = [];
                let totalInvoicedInThisMovement = 0;

                let isValid = true;
                
                qtyInputs.forEach(input => {
                    const reference = input.getAttribute('data-reference');
                    const maxQty = parseInt(input.getAttribute('data-max-qty'), 10);
                    const amount = parseInt(input.value, 10); 

                    if (isNaN(amount) || amount < 0 || amount > maxQty) {
                        isValid = false;
                        input.classList.add('border-red-500', 'ring-red-500');
                        showMessage(`Cantidad inválida para ${reference}. Máximo: ${maxQty}.`, 'error');
                        return;
                    }

                    if (amount > 0) {
                        invoiceChanges.push({ reference, amount });
                        totalInvoicedInThisMovement += amount;
                    }
                    input.classList.remove('border-red-500', 'ring-red-500'); 
                });

                if (!isValid) return;

                if (totalInvoicedInThisMovement === 0) {
                    showMessage("Debes ingresar una cantidad mayor a cero para facturar.", 'info');
                    return;
                }

                const updatedItemLines = itemLines.map(line => {
                    const change = invoiceChanges.find(c => c.reference === line.reference);
                    if (change) {
                        const currentInvoiced = line.invoiced || 0;
                        return { 
                            ...line, 
                            invoiced: currentInvoiced + change.amount 
                        };
                    }
                    return line;
                });

                try {
                    // Actualiza en la colección pública de pre-facturas
                    const docRef = doc(getPrefacturasCollectionRef(), docId);
                    await updateDoc(docRef, {
                        item_lines: updatedItemLines
                    });
                    showMessage(`Facturación de ${totalInvoicedInThisMovement} items registrada.`, 'success');
                    hideModal();
                } catch (error) {
                    console.error("Error al actualizar la facturación parcial:", error);
                    showMessage("Error al actualizar la facturación parcial. Revisa las reglas de seguridad.", 'error');
                    hideModal();
                }
            });
        }
        
        // 3. FUNCIÓN: Marcar como Pagada e Inmutable
        async function markAsPaid(prefacturaData) {
            if (!isFirebaseReady || !userId) {
                showMessage("Esperando conexión a Firebase o autenticación.", 'error');
                return;
            }
            
            const { id: docId, consecutivo } = prefacturaData;

            // 1. Mover la pre-factura a la colección de facturas pagadas (inmutable, ruta pública)
            try {
                const paidInvoiceData = {
                    ...prefacturaData,
                    is_paid: true,
                    paid_at: serverTimestamp(), // Usamos serverTimestamp para el registro del pago
                    paid_by_uid: userId, // Mantenemos el registro de quién pagó
                    prefactura_id: docId // Guardamos el ID original
                };
                delete paidInvoiceData.id; // Limpiamos el ID local antes de mover
                
                // Se guarda en la colección pública de facturas pagadas
                await setDoc(doc(getPaidInvoicesCollectionRef(), docId), paidInvoiceData);
                
                // 2. Eliminar de la colección de pre-facturas pendientes (ruta pública)
                const docRef = doc(getPrefacturasCollectionRef(), docId);
                await deleteDoc(docRef);
                
                showMessage(`Factura ${consecutivo} marcada como PAGADA y archivada.`, 'success');
                
            } catch (error) {
                console.error("Error al marcar como pagada:", error);
                showMessage("Error al marcar como pagada. Revisa la consola y las reglas de seguridad.", 'error');
            }
        }
        
        // 4. Renderizado de la lista de Pre-facturas (Con el botón de pago funcional)
        function drawProgress(canvas, total, invoiced) {
            // Check para evitar errores si el canvas no está visible (ej. en la pestaña Paid)
            if (!canvas || !canvas.offsetParent) return; 

            const ctx = canvas.getContext('2d');
            const size = canvas.width;
            const center = size / 2;
            const radius = size * 0.4;
            const percentage = total > 0 ? invoiced / total : 0;

            ctx.clearRect(0, 0, size, size);
            
            // Background ring (gris claro)
            ctx.beginPath();
            ctx.arc(center, center, radius, 0, Math.PI * 2);
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 10;
            ctx.stroke();

            // Progress arc (color primario/secundario)
            if (percentage > 0) {
                const endAngle = (Math.PI * 2 * percentage) - (Math.PI / 2);
                ctx.beginPath();
                ctx.arc(center, center, radius, -(Math.PI / 2), endAngle);
                ctx.strokeStyle = percentage === 1 ? '#10b981' : '#4f46e5';
                ctx.lineWidth = 10;
                ctx.stroke();
            }

            // Text
            ctx.font = 'bold 16px Inter';
            ctx.fillStyle = '#1f2937';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const text = `${Math.round(percentage * 100)}%`;
            // Ajuste para dibujar texto solo si hay espacio y datos
            if (size > 30) {
                 ctx.fillText(text, center, center);
            }
        }

        function renderPrefacturas(prefacturas) {
            prefacturasData = prefacturas; 
            const listContainer = document.getElementById('prefacturas-list');
            listContainer.innerHTML = ''; 
            
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }

            if (prefacturas.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No hay pre-facturas pendientes registradas.</p>';
                return;
            }

            // Filtrar solo las no pagadas (is_paid: false)
            const pendingPrefacturas = prefacturas.filter(p => !p.is_paid);

            if (pendingPrefacturas.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No hay pre-facturas pendientes registradas. ¡Todo está facturado!</p>';
                return;
            }

            pendingPrefacturas
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .forEach(p => {
                
                const safeItemLines = Array.isArray(p.item_lines) ? p.item_lines : [];
                let total_invoiced = 0;
                let total_items_aggregate = 0;

                safeItemLines.forEach(line => {
                    total_invoiced += line.invoiced || 0;
                    total_items_aggregate += line.quantity || 0;
                });
                
                const isComplete = total_items_aggregate > 0 && total_invoiced >= total_items_aggregate;
                
                const statusColor = isComplete ? 'bg-success' : 'bg-primary';
                const statusText = isComplete ? 'Fact. Completa' : 'Pendiente';
                
                const itemLinesHtml = safeItemLines.map(line => {
                    const lineProgress = line.quantity > 0 ? (line.invoiced / line.quantity) : 0;
                    const lineStatusColor = lineProgress >= 1 ? 'bg-secondary/20 text-secondary' : 'bg-indigo-100 text-indigo-700';
                    
                    return `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${lineStatusColor}">
                        ${line.reference} (${line.invoiced}/${line.quantity})
                    </span>`;
                }).join(' ') ;
                
                const card = document.createElement('div');
                card.className = `p-4 border rounded-lg shadow-sm flex flex-col sm:flex-row items-start sm:items-center justify-between transition hover:shadow-md ${isComplete ? 'border-success/30 bg-success/5' : 'border-gray-200 bg-surface'}`;
                
                // --- Determinar Botones ---
                let actionButtonsHtml = '';
                
                // 1. Botón de Facturación Parcial (Mostrar solo si NO está completa)
                if (!isComplete) {
                    actionButtonsHtml += `
                        <button data-id="${p.consecutivo}" data-lines='${JSON.stringify(safeItemLines)}'
                            class="btn-facturar w-full sm:w-auto py-2 px-4 text-sm font-medium rounded-lg text-white bg-primary hover:bg-indigo-700 transition ease-in-out duration-150">
                            Facturar Parcialmente
                        </button>
                    `;
                }
                
                // 2. Botón de Pago Final (Mostrar SIEMPRE, habilitado solo si isComplete)
                const paidDisabled = isComplete ? '' : 'disabled';
                const paidStyle = isComplete ? 'bg-success hover:bg-green-700' : 'bg-gray-400 cursor-not-allowed';

                actionButtonsHtml += `
                    <button data-id="${p.consecutivo}" ${paidDisabled}
                        data-is-complete="${isComplete}"
                        class="btn-mark-paid w-full sm:w-auto py-2 px-4 text-sm font-medium rounded-lg text-white ${paidStyle} transition ease-in-out duration-150">
                        Marcar Pago Final
                    </button>
                `;
                
                // 3. Botón de Eliminar (siempre disponible antes del pago final)
                actionButtonsHtml += `
                    <button data-id="${p.consecutivo}" class="btn-delete w-full sm:w-auto py-2 px-4 text-sm font-medium rounded-lg text-red-600 border border-red-200 bg-white hover:bg-red-50 transition ease-in-out duration-150">
                        Eliminar
                    </button>
                `;
                
                // --- Renderizar Tarjeta ---
                card.innerHTML = `
                    <div class="flex items-center w-full sm:w-auto mb-4 sm:mb-0">
                        <!-- Canvas para progreso -->
                        <canvas id="canvas-${p.consecutivo}" width="70" height="70" class="mr-4 flex-shrink-0 progress-canvas"></canvas>
                        
                        <!-- Detalles de la Pre-factura -->
                        <div class="flex-grow">
                            <div class="flex items-center space-x-2">
                                <h3 class="text-lg font-bold text-gray-900">${p.consecutivo}</h3>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white ${statusColor}">
                                    ${statusText}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-1 flex flex-wrap gap-1">
                                Líneas: ${itemLinesHtml}
                            </p>
                            <p class="text-sm font-medium text-gray-700">Items Facturados: ${total_invoiced} / ${total_items_aggregate}</p>
                            <p class="text-sm text-gray-600">Valor Total: $${p.total_value.toFixed(2)} | Ganancia: $${p.total_profit.toFixed(2)}</p>
                            <p class="text-xs text-gray-400">Fecha: ${p.date}</p>
                        </div>
                    </div>
                    
                    <!-- Botones de Acción -->
                    <div class="w-full sm:w-auto flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-3 sm:mt-0">
                        ${actionButtonsHtml}
                    </div>
                `;
                
                listContainer.appendChild(card);
                
                const canvasElement = document.getElementById(`canvas-${p.consecutivo}`);
                if (canvasElement) {
                    // Esperamos a que el elemento esté en el DOM y visible antes de dibujar
                    setTimeout(() => drawProgress(canvasElement, total_items_aggregate, total_invoiced), 0);
                }
            });

            // Asignar eventos a los botones
            document.querySelectorAll('.btn-facturar').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const linesJson = e.target.getAttribute('data-lines');
                    try {
                        const itemLines = JSON.parse(linesJson); 
                         updateFacturacion(id, itemLines);
                    } catch (error) {
                        console.error("Error al parsear item_lines:", error);
                        showMessage("Error al cargar los detalles de facturación.", 'error');
                    }
                });
            });
            
            // EVENTO: Marcar como Pagada 
            document.querySelectorAll('.btn-mark-paid').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const isReadyToPay = e.target.getAttribute('data-is-complete') === 'true'; 
                    // Se busca el objeto completo de la prefactura, el ID de Firestore (p.id) se usa en markAsPaid
                    const prefacturaToPay = prefacturasData.find(p => p.consecutivo === id); 

                    if (!prefacturaToPay) return;

                    if (!isReadyToPay) {
                        showMessage(`La factura ${id} aún no está 100% facturada. Debes facturar todos los ítems primero.`, 'info');
                        return;
                    }
                    
                    showConfirm(
                        'Confirmar Pago Final',
                        `¿Estás seguro de que la factura ${id} ha sido completamente pagada por el cliente? Esto la archivará y la hará inmutable.`,
                        async () => { 
                            // Pasamos el objeto completo de la prefactura, que incluye el 'id' de Firestore
                            await markAsPaid(prefacturaToPay); 
                        },
                        () => showMessage(`Pago de ${id} cancelado.`, 'info') 
                    );
                });
            });

            document.querySelectorAll('.btn-delete').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    
                    showConfirm(
                        'Confirmar Eliminación',
                        `¿Estás seguro de que quieres eliminar permanentemente la pre-factura ${id}?`,
                        async () => { 
                            // El ID para eliminar debe ser el ID real de Firestore (p.id)
                            const prefacturaToDelete = prefacturasData.find(p => p.consecutivo === id);
                            if (prefacturaToDelete) {
                                await deletePrefactura(prefacturaToDelete.id);
                            }
                        },
                        () => showMessage(`Eliminación de ${id} cancelada.`, 'info') 
                    );
                });
            });
        }
        
        // 5. Renderizado del módulo de Facturas Pagadas
        function renderPaidInvoices(invoices) {
            const listContainer = document.getElementById('paid-invoices-list');
            listContainer.innerHTML = '';
            
            if (invoices.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No hay facturas marcadas como pagadas en el historial.</p>';
                return;
            }

            invoices
                .sort((a, b) => {
                    // Manejo de Firestore Timestamp vs string ISO para la fecha de pago
                    const dateA = a.paid_at ? (a.paid_at.toDate ? a.paid_at.toDate() : new Date(a.paid_at)) : 0;
                    const dateB = b.paid_at ? (b.paid_at.toDate ? b.paid_at.toDate() : new Date(b.paid_at)) : 0;
                    return dateB - dateA;
                })
                .forEach(p => {
                    // Manejo de Firestore Timestamp
                    let paidDateString = 'N/A';
                    if (p.paid_at) {
                        try {
                            // Convertir Firestore Timestamp a Date si es necesario
                            const dateObj = typeof p.paid_at.toDate === 'function' ? p.paid_at.toDate() : new Date(p.paid_at);
                            // Usar toLocaleDateString con opciones para el formato que prefieras
                            paidDateString = dateObj.toLocaleDateString('es-CO', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        } catch (e) {
                             paidDateString = 'Fecha inválida';
                        }
                    }
                    
                    const itemLinesHtml = Array.isArray(p.item_lines) ? p.item_lines.map(line => {
                        return `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-green-100 text-green-700">
                            ${line.reference} (${line.quantity})
                        </span>`;
                    }).join(' ') : 'Sin detalle';
                    
                    const card = document.createElement('div');
                    card.className = `p-4 border rounded-lg shadow-sm bg-green-50 border-green-300`;
                    
                    card.innerHTML = `
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between">
                            <div class="flex-grow">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h3 class="text-lg font-bold text-gray-900">${p.consecutivo}</h3>
                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white bg-success">PAGADA</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-1 flex flex-wrap gap-1">
                                    Líneas: ${itemLinesHtml}
                                </p>
                                <p class="text-sm font-medium text-gray-700">Valor Total: <span class="font-bold text-success">$${p.total_value.toFixed(2)}</span> | Ganancia: $${p.total_profit.toFixed(2)}</p>
                                <p class="text-xs text-gray-500">Fecha de Pago: ${paidDateString}</p>
                                <p class="text-xs text-gray-400">Archivado por: ${p.paid_by_uid ? p.paid_by_uid.substring(0, 8) + '...' : 'Usuario anónimo'}</p>
                            </div>
                        </div>
                    `;
                    
                    listContainer.appendChild(card);
                });
        }


        // 6. Listener en Tiempo Real (AMBOS)
        function setupRealtimeListeners() {
            // CRÍTICO: Aseguramos que db y userId existan antes de configurar listeners.
            if (!db || !isFirebaseReady || !userId) {
                console.warn("No se pueden configurar listeners: Firebase no está completamente listo o el ID de usuario es nulo.");
                return;
            }
            
            // --- Listener para Pre-facturas Pendientes (PÚBLICO) ---
            if (prefacturasUnsubscribe) {
                prefacturasUnsubscribe();
            }

            // Usamos la colección pública: getPrefacturasCollectionRef()
            const qPrefacturas = query(getPrefacturasCollectionRef());
            
            prefacturasUnsubscribe = onSnapshot(qPrefacturas, (querySnapshot) => {
                const prefacturas = [];
                querySnapshot.forEach((doc) => {
                    // Importante: Guardar el doc.id real de Firestore para usarlo en delete/update
                    prefacturas.push({ id: doc.id, ...doc.data() }); 
                });
                renderPrefacturas(prefacturas);
            }, (error) => {
                console.error("Error al escuchar pre-facturas:", error);
                // Muestra un error específico sobre la conexión/permisos
                showMessage(`ERROR: No se pueden cargar pre-facturas. Revisa que tus Reglas de Seguridad permitan el acceso público (allow read: if request.auth != null;).`, 'error');
            });
            
            // --- Listener para Facturas Pagadas (Público) ---
            if (paidInvoicesUnsubscribe) {
                paidInvoicesUnsubscribe();
            }
            
            const qPaid = query(getPaidInvoicesCollectionRef());
            
            paidInvoicesUnsubscribe = onSnapshot(qPaid, (querySnapshot) => {
                const paidInvoices = [];
                querySnapshot.forEach((doc) => {
                    paidInvoices.push({ id: doc.id, ...doc.data() });
                });
                renderPaidInvoices(paidInvoices);
            }, (error) => {
                 console.error("Error al escuchar facturas pagadas:", error);
                 // Muestra un error específico sobre la conexión/permisos
                 showMessage(`ERROR: No se pueden cargar facturas pagadas. Revisa que tus Reglas de Seguridad permitan el acceso público (allow read: if request.auth != null;).`, 'error');
            });
        }
        
        // 7. Eliminar Pre-factura (Usando el ID de Firestore)
        async function deletePrefactura(docId) {
             if (!isFirebaseReady || !userId) return;
             
             try {
                // Usa la colección pública corregida (getPrefacturasCollectionRef)
                const docRef = doc(getPrefacturasCollectionRef(), docId);
                await deleteDoc(docRef);
                showMessage(`Pre-factura ${docId} eliminada.`, 'success');
            } catch (error) {
                console.error("Error al eliminar la pre-factura:", error);
                showMessage("Error al eliminar la pre-factura. Revisa las reglas de seguridad.", 'error');
            }
        }
        
        // --- Lógica de Pestañas ---
        let currentView = 'pending';
        const tabButtons = document.querySelectorAll('.tab-button');
        const views = {
            'pending': document.getElementById('view-pending'),
            'paid': document.getElementById('view-paid')
        };
        
        function switchView(viewName) {
            currentView = viewName;

            tabButtons.forEach(btn => {
                const isSelected = btn.getAttribute('data-view') === viewName;
                if (isSelected) {
                    btn.classList.add('border-primary', 'text-primary');
                    btn.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                } else {
                    btn.classList.remove('border-primary', 'text-primary');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                }
            });
            
            Object.keys(views).forEach(key => {
                if (key === viewName) {
                    views[key].classList.remove('hidden');
                } else {
                    views[key].classList.add('hidden');
                }
            });
            
            // Redibujar canvas al cambiar de pestaña si es necesario
            if (viewName === 'pending') {
                // Pequeño timeout para asegurar que el canvas es visible antes de dibujar
                setTimeout(() => {
                    document.querySelectorAll('.progress-canvas').forEach(canvas => {
                         const id = canvas.id.replace('canvas-', '');
                         // Buscar el objeto de prefactura por su consecutivo
                         const prefactura = prefacturasData.find(p => p.consecutivo === id); 
                         
                         if (prefactura) {
                             let total_invoiced = 0;
                             let total_items_aggregate = 0;
                             prefactura.item_lines.forEach(line => {
                                 total_invoiced += line.invoiced || 0;
                                 total_items_aggregate += line.quantity || 0;
                             });
                             drawProgress(canvas, total_items_aggregate, total_invoiced);
                         }
                    });
                }, 100); 
            }
        }
        
        tabButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                switchView(e.target.getAttribute('data-view'));
            });
        });

        // Configurar la fecha de hoy y la línea inicial
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = today;
            addItemLine(); // Añadir la primera línea de item al cargar
            switchView('pending'); // Mostrar la vista inicial
        });

    </script>
</body>
</html>
