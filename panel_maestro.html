<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Maestro - Firebase</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --muted:#64748b;
      --text:#1e293b;
      --border:#e2e8f0;
      --primary:#2563eb;
      --danger:#ef4444;
      --ok:#10b981;
      --warning:#f59e0b;
      --shadow:0 4px 20px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1400px;margin:0 auto;padding:20px}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;margin-bottom:16px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;border-radius:14px;background:linear-gradient(135deg, #2563eb, #1d4ed8);color:#fff;display:grid;place-items:center;box-shadow:0 6px 20px rgba(37,99,235,.3)}
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .brand .sub{margin-top:4px;color:var(--muted);font-size:12px}

    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .btn{border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:700;font-size:12px;transition:all .15s}
    .btn:hover{background:#f1f5f9;border-color:#cbd5e1}
    .btn.primary{background:linear-gradient(135deg, #2563eb, #1d4ed8);border:none;color:#fff}
    .btn.primary:hover{opacity:.9}
    .btn.danger{background:linear-gradient(135deg, #ef4444, #dc2626);border:none;color:#fff}
    .btn.ok{background:linear-gradient(135deg, #10b981, #059669);border:none;color:#fff}
    .btn.warning{background:linear-gradient(135deg, #f59e0b, #d97706);border:none;color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow)}
    .card-h{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .card-h h2{margin:0;font-size:14px;display:flex;align-items:center;gap:8px}
    .card-b{padding:16px}

    .sidebar{width:280px;flex-shrink:0}
    .main{flex:1;min-width:0}
    .layout{display:flex;gap:16px}
    @media(max-width:900px){.layout{flex-direction:column}.sidebar{width:100%}}

    .collection-list{display:flex;flex-direction:column;gap:6px}
    .collection-item{padding:12px 14px;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:10px;font-weight:600;font-size:13px;transition:all .15s;border:1px solid transparent}
    .collection-item:hover{background:#f1f5f9}
    .collection-item.active{background:linear-gradient(135deg, rgba(37,99,235,.1), rgba(37,99,235,.05));border-color:rgba(37,99,235,.3);color:#1d4ed8}
    .collection-item i{width:20px;text-align:center;color:var(--muted)}
    .collection-item.active i{color:#2563eb}
    .collection-badge{margin-left:auto;font-size:11px;font-weight:800;padding:3px 8px;border-radius:999px;background:#f1f5f9;color:var(--muted)}

    .filters{display:grid;grid-template-columns:1fr auto;gap:12px;margin-bottom:16px}
    @media(max-width:600px){.filters{grid-template-columns:1fr}}

    label{display:block;color:var(--muted);font-size:11px;font-weight:800;margin:0 0 6px;text-transform:uppercase;letter-spacing:.5px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:#fff;color:var(--text);outline:none;font-size:13px}
    input:focus,select:focus,textarea:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.1)}

    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th{text-align:left;padding:10px 12px;background:#f8fafc;border-bottom:2px solid var(--border);font-weight:800;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted)}
    td{padding:12px;border-bottom:1px solid #f1f5f9;vertical-align:top}
    tr:hover td{background:#fafbfc}
    .cell-id{font-family:monospace;font-size:11px;color:var(--muted);max-width:120px;overflow:hidden;text-overflow:ellipsis}
    .cell-value{max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .cell-actions{white-space:nowrap}

    .pill{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:700}
    .pill.blue{background:rgba(37,99,235,.1);color:#1d4ed8}
    .pill.green{background:rgba(16,185,129,.1);color:#059669}
    .pill.red{background:rgba(239,68,68,.1);color:#dc2626}
    .pill.gray{background:#f1f5f9;color:#64748b}

    .empty{text-align:center;padding:40px 20px;color:var(--muted)}
    .empty i{font-size:32px;margin-bottom:12px;opacity:.5}

    .footer{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
    .pager{display:flex;gap:6px;align-items:center}

    .modal{position:fixed;inset:0;background:rgba(15,23,42,.4);display:none;align-items:center;justify-content:center;padding:20px;z-index:100}
    .modal.open{display:flex}
    .modal-card{width:min(700px,100%);max-height:90vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,.15)}
    .modal-head{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;position:sticky;top:0;background:#fff;z-index:1}
    .modal-head h3{margin:0;font-size:15px;display:flex;align-items:center;gap:8px}
    .modal-body{padding:16px}
    .modal-actions{padding:16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;position:sticky;bottom:0;background:#fff}

    .field-row{display:grid;grid-template-columns:180px 1fr;gap:12px;padding:10px 0;border-bottom:1px solid #f1f5f9;align-items:start}
    .field-row:last-child{border-bottom:none}
    .field-label{font-weight:700;font-size:12px;color:var(--muted);padding-top:10px}
    .field-input input,.field-input textarea{width:100%}
    .field-type{font-size:10px;color:#94a3b8;margin-top:4px}

    .hint{color:var(--muted);font-size:12px}
    .loading{text-align:center;padding:40px;color:var(--muted)}
    .loading i{font-size:24px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .toast{position:fixed;right:20px;bottom:20px;z-index:200;display:none}
    .toast.show{display:block}
    .toast-card{background:#1e293b;color:#fff;border-radius:10px;padding:14px 18px;box-shadow:0 10px 30px rgba(0,0,0,.2);min-width:240px}
    .toast-title{font-weight:700;font-size:13px}
    .toast-msg{margin-top:4px;font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-database"></i></div>
        <div>
          <h1>Panel Maestro</h1>
          <div class="sub">Administrador de Firebase ‚Ä¢ Ver, editar y eliminar documentos</div>
        </div>
      </div>
      <div class="actions">
        <select id="dbSelector" style="padding:10px 14px;border-radius:10px;border:1px solid #e2e8f0;font-weight:700;font-size:13px;cursor:pointer;background:#fff">
          <option value="principal">üè¢ Principal (Pedidos)</option>
          <option value="china">üá®üá≥ China (Inventario)</option>
        </select>
        <button class="btn" type="button" id="btnRefresh"><i class="fa-solid fa-rotate"></i> Recargar</button>
      </div>
    </div>

    <div class="layout">
      <div class="sidebar">
        <div class="card">
          <div class="card-h">
            <h2><i class="fa-solid fa-folder-tree"></i> Colecciones</h2>
            <span class="pill gray" id="dbLabel">Principal</span>
          </div>
          <div class="card-b">
            <div class="collection-list" id="collectionList">
              <div class="loading"><i class="fa-solid fa-spinner"></i></div>
            </div>
          </div>
        </div>
      </div>

      <div class="main">
        <div class="card">
          <div class="card-h">
            <h2 id="mainTitle"><i class="fa-solid fa-table"></i> Selecciona una colecci√≥n</h2>
            <div style="display:flex;gap:8px">
              <button class="btn ok" type="button" id="btnAdd" style="display:none"><i class="fa-solid fa-plus"></i> Agregar</button>
            </div>
          </div>
          <div class="card-b">
            <div class="filters" id="filtersBox" style="display:none">
              <div>
                <label for="searchInput">Buscar</label>
                <input type="text" id="searchInput" placeholder="Buscar en todos los campos...">
              </div>
              <div style="display:flex;align-items:end">
                <button class="btn" type="button" id="btnSearch"><i class="fa-solid fa-magnifying-glass"></i> Buscar</button>
              </div>
            </div>
            <div class="table-wrap">
              <div id="tableContainer">
                <div class="empty">
                  <i class="fa-solid fa-hand-pointer"></i>
                  <div>Selecciona una colecci√≥n de la izquierda para ver sus documentos</div>
                </div>
              </div>
            </div>
            <div class="footer" id="footerBox" style="display:none">
              <div class="hint">Mostrando <strong id="rangeLabel">0</strong> de <strong id="totalLabel">0</strong> documentos</div>
              <div class="pager">
                <button class="btn" type="button" id="btnPrev"><i class="fa-solid fa-chevron-left"></i></button>
                <span class="pill gray">P√°gina <strong id="pageLabel">1</strong></span>
                <button class="btn" type="button" id="btnNext"><i class="fa-solid fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="editModalTitle"><i class="fa-solid fa-pen"></i> Editar documento</h3>
        <button class="btn" type="button" id="btnCloseEdit"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-body" id="editModalBody">
      </div>
      <div class="modal-actions">
        <button class="btn danger" type="button" id="btnDeleteDoc"><i class="fa-solid fa-trash"></i> Eliminar</button>
        <div style="flex:1"></div>
        <button class="btn" type="button" id="btnCancelEdit">Cancelar</button>
        <button class="btn ok" type="button" id="btnSaveDoc"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="addModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="addModalTitle"><i class="fa-solid fa-plus"></i> Agregar documento</h3>
        <button class="btn" type="button" id="btnCloseAdd"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-body" id="addModalBody">
        <div class="hint" style="margin-bottom:16px">Escribe el JSON del nuevo documento:</div>
        <textarea id="addJsonInput" rows="12" placeholder='{"campo1": "valor1", "campo2": 123}'></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn" type="button" id="btnCancelAdd">Cancelar</button>
        <button class="btn ok" type="button" id="btnConfirmAdd"><i class="fa-solid fa-plus"></i> Crear documento</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="toast-card">
      <div class="toast-title" id="toastTitle">Listo</div>
      <div class="toast-msg" id="toastMsg"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc, query, orderBy, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ========== DOS FIREBASE ==========
    // Firebase PRINCIPAL (Sistema general: registros, usuarios, transportadoras, gu√≠as)
    const firebaseConfigPrincipal = {
      apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
      authDomain: "lazapateria-c4157.firebaseapp.com",
      projectId: "lazapateria-c4157",
      storageBucket: "lazapateria-c4157.firebasestorage.app",
      measurementId: "G-HVG7615JEE"
    };

    // Firebase CHINA (Inventario China, facturas, caja menor)
    const firebaseConfigChina = {
      apiKey: "AIzaSyCwGpyvoUfbXE4rpPfLmHSdOK_VI4mT24M",
      authDomain: "lazapateria-ce24f.firebaseapp.com",
      projectId: "lazapateria-ce24f",
      storageBucket: "lazapateria-ce24f.firebasestorage.app",
      messagingSenderId: "642571845821",
      appId: "1:642571845821:web:45858a0abc0df728fd77d4",
      measurementId: "G-6JCF33H0K1"
    };

    // Inicializar ambos Firebase
    const appPrincipal = initializeApp(firebaseConfigPrincipal, 'principal');
    const appChina = initializeApp(firebaseConfigChina, 'china');
    const dbPrincipal = getFirestore(appPrincipal);
    const dbChina = getFirestore(appChina);

    // Base de datos activa
    let currentDbName = 'principal';
    let db = dbPrincipal;

    const $ = id => document.getElementById(id);
    const safeStr = v => (v === undefined || v === null) ? '' : String(v);
    const escapeHtml = s => safeStr(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    // Colecciones por base de datos
    const COLLECTIONS_PRINCIPAL = [
      { id: 'registros', name: 'Registros (Pedidos)', icon: 'fa-clipboard-list' },
      { id: 'usuarios', name: 'Usuarios', icon: 'fa-users' },
      { id: 'empresas', name: 'Empresas', icon: 'fa-briefcase' },
      { id: 'transportadoras', name: 'Transportadoras', icon: 'fa-truck' },
      { id: 'cuentas', name: 'Cuentas Bancarias', icon: 'fa-building-columns' },
      { id: 'guias_envia', name: 'Gu√≠as Env√≠a', icon: 'fa-barcode' },
      { id: 'guias_interrapidissimo', name: 'Gu√≠as Inter', icon: 'fa-barcode' },
      { id: 'novedades', name: 'Novedades', icon: 'fa-triangle-exclamation' },
      { id: 'auditoria_fondos_refs', name: 'Auditor√≠a Fondos Refs', icon: 'fa-link' },
      { id: 'asistencia_diaria', name: 'Asistencia Diaria', icon: 'fa-calendar-check' },
      { id: 'asistencia_eventos', name: 'Asistencia Eventos', icon: 'fa-clock' },
      { id: 'asistencia_settings', name: 'Asistencia Config', icon: 'fa-sliders' },
      { id: 'dashboard_settings', name: 'Dashboard Config', icon: 'fa-chart-pie' },
      { id: 'settings', name: 'Configuraci√≥n General', icon: 'fa-gear' },
      { id: 'users', name: 'Users (ventas diarias)', icon: 'fa-chart-line' }
    ];

    const COLLECTIONS_CHINA = [
      { id: 'facturas', name: 'Facturas China', icon: 'fa-file-invoice-dollar' },
      { id: 'inventario', name: 'Inventario China', icon: 'fa-boxes-stacked' },
      { id: 'caja_menor', name: 'Caja Menor', icon: 'fa-cash-register' }
    ];

    let COLLECTIONS = COLLECTIONS_PRINCIPAL;

    const PAGE_SIZE = 30;
    let currentCollection = null;
    let allDocs = [];
    let filteredDocs = [];
    let currentPage = 1;
    let editingDoc = null;

    function toast(title, msg) {
      $('toastTitle').textContent = title;
      $('toastMsg').textContent = msg || '';
      $('toast').classList.add('show');
      setTimeout(() => $('toast').classList.remove('show'), 2500);
    }

    async function loadCollectionCounts() {
      const listEl = $('collectionList');
      listEl.innerHTML = '';

      for (const col of COLLECTIONS) {
        const item = document.createElement('div');
        item.className = 'collection-item' + (currentCollection === col.id ? ' active' : '');
        item.innerHTML = `
          <i class="fa-solid ${col.icon}"></i>
          <span>${escapeHtml(col.name)}</span>
          <span class="collection-badge" id="count_${col.id}">...</span>
        `;
        item.addEventListener('click', () => selectCollection(col.id));
        listEl.appendChild(item);

        // Load count async
        getDocs(collection(db, col.id)).then(snap => {
          const badge = $('count_' + col.id);
          if (badge) badge.textContent = snap.size;
        }).catch(() => {
          const badge = $('count_' + col.id);
          if (badge) badge.textContent = '0';
        });
      }
    }

    async function selectCollection(colId) {
      currentCollection = colId;
      currentPage = 1;
      $('searchInput').value = '';

      // Update sidebar
      document.querySelectorAll('.collection-item').forEach(el => el.classList.remove('active'));
      const items = document.querySelectorAll('.collection-item');
      COLLECTIONS.forEach((col, i) => {
        if (col.id === colId && items[i]) items[i].classList.add('active');
      });

      const colInfo = COLLECTIONS.find(c => c.id === colId);
      $('mainTitle').innerHTML = `<i class="fa-solid ${colInfo?.icon || 'fa-table'}"></i> ${escapeHtml(colInfo?.name || colId)}`;
      $('btnAdd').style.display = '';
      $('filtersBox').style.display = '';
      $('footerBox').style.display = '';

      $('tableContainer').innerHTML = '<div class="loading"><i class="fa-solid fa-spinner"></i> Cargando...</div>';

      try {
        const snap = await getDocs(collection(db, colId));
        allDocs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        filteredDocs = [...allDocs];
        renderTable();
      } catch (e) {
        $('tableContainer').innerHTML = `<div class="empty"><i class="fa-solid fa-circle-exclamation"></i><div>Error: ${escapeHtml(e.message)}</div></div>`;
      }
    }

    function applyFilter() {
      const q = safeStr($('searchInput').value).toLowerCase();
      if (!q) {
        filteredDocs = [...allDocs];
      } else {
        filteredDocs = allDocs.filter(doc => {
          const str = JSON.stringify(doc).toLowerCase();
          return str.includes(q);
        });
      }
      currentPage = 1;
      renderTable();
    }

    function renderTable() {
      const total = filteredDocs.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage - 1) * PAGE_SIZE;
      const end = Math.min(total, start + PAGE_SIZE);
      const slice = filteredDocs.slice(start, end);

      $('totalLabel').textContent = total;
      $('rangeLabel').textContent = total ? `${start + 1}-${end}` : '0';
      $('pageLabel').textContent = currentPage;

      if (!slice.length) {
        $('tableContainer').innerHTML = '<div class="empty"><i class="fa-solid fa-inbox"></i><div>No hay documentos</div></div>';
        return;
      }

      // Get all unique keys
      const allKeys = new Set(['id']);
      slice.forEach(doc => Object.keys(doc).forEach(k => allKeys.add(k)));
      const keys = Array.from(allKeys).slice(0, 8); // Limit columns

      let html = '<table><thead><tr>';
      keys.forEach(k => {
        html += `<th>${escapeHtml(k)}</th>`;
      });
      html += '<th>Acciones</th></tr></thead><tbody>';

      slice.forEach(doc => {
        html += '<tr>';
        keys.forEach(k => {
          let val = doc[k];
          if (k === 'id') {
            html += `<td class="cell-id" title="${escapeHtml(val)}">${escapeHtml(val)}</td>`;
          } else if (val && typeof val === 'object') {
            if (val.toDate) {
              html += `<td>${val.toDate().toLocaleString('es-CO')}</td>`;
            } else if (Array.isArray(val)) {
              html += `<td><span class="pill blue">${val.length} items</span></td>`;
            } else {
              html += `<td><span class="pill gray">objeto</span></td>`;
            }
          } else if (typeof val === 'boolean') {
            html += `<td><span class="pill ${val ? 'green' : 'red'}">${val ? 'S√≠' : 'No'}</span></td>`;
          } else {
            html += `<td class="cell-value" title="${escapeHtml(val)}">${escapeHtml(val)}</td>`;
          }
        });
        html += `<td class="cell-actions">
          <button class="btn" type="button" data-edit="${escapeHtml(doc.id)}"><i class="fa-solid fa-pen"></i></button>
          <button class="btn danger" type="button" data-delete="${escapeHtml(doc.id)}"><i class="fa-solid fa-trash"></i></button>
        </td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      $('tableContainer').innerHTML = html;

      // Attach events
      document.querySelectorAll('[data-edit]').forEach(btn => {
        btn.addEventListener('click', () => openEditModal(btn.dataset.edit));
      });
      document.querySelectorAll('[data-delete]').forEach(btn => {
        btn.addEventListener('click', () => deleteDocument(btn.dataset.delete));
      });
    }

    function openEditModal(docId) {
      const docData = allDocs.find(d => d.id === docId);
      if (!docData) return;

      editingDoc = { id: docId, data: { ...docData } };
      delete editingDoc.data.id;

      $('editModalTitle').innerHTML = `<i class="fa-solid fa-pen"></i> Editar: ${escapeHtml(docId.substring(0, 20))}...`;

      let html = '';
      Object.entries(editingDoc.data).forEach(([key, val]) => {
        const isTimestamp = val && typeof val === 'object' && val.toDate;
        const isArray = Array.isArray(val);
        const isObject = val && typeof val === 'object' && !isTimestamp && !isArray;

        let inputHtml = '';
        let typeLabel = '';

        if (isTimestamp) {
          const d = val.toDate();
          inputHtml = `<input type="datetime-local" data-field="${escapeHtml(key)}" data-type="timestamp" value="${d.toISOString().slice(0,16)}">`;
          typeLabel = 'Timestamp';
        } else if (isArray || isObject) {
          inputHtml = `<textarea data-field="${escapeHtml(key)}" data-type="json" rows="4">${escapeHtml(JSON.stringify(val, null, 2))}</textarea>`;
          typeLabel = isArray ? 'Array (JSON)' : 'Objeto (JSON)';
        } else if (typeof val === 'boolean') {
          inputHtml = `<select data-field="${escapeHtml(key)}" data-type="boolean">
            <option value="true" ${val ? 'selected' : ''}>S√≠ (true)</option>
            <option value="false" ${!val ? 'selected' : ''}>No (false)</option>
          </select>`;
          typeLabel = 'Boolean';
        } else if (typeof val === 'number') {
          inputHtml = `<input type="number" step="any" data-field="${escapeHtml(key)}" data-type="number" value="${val}">`;
          typeLabel = 'N√∫mero';
        } else {
          const strVal = safeStr(val);
          if (strVal.length > 100) {
            inputHtml = `<textarea data-field="${escapeHtml(key)}" data-type="string" rows="3">${escapeHtml(strVal)}</textarea>`;
          } else {
            inputHtml = `<input type="text" data-field="${escapeHtml(key)}" data-type="string" value="${escapeHtml(strVal)}">`;
          }
          typeLabel = 'Texto';
        }

        html += `
          <div class="field-row">
            <div class="field-label">${escapeHtml(key)}<div class="field-type">${typeLabel}</div></div>
            <div class="field-input">${inputHtml}</div>
          </div>
        `;
      });

      $('editModalBody').innerHTML = html || '<div class="hint">Este documento no tiene campos editables.</div>';
      $('editModal').classList.add('open');
    }

    async function saveDocument() {
      if (!editingDoc || !currentCollection) return;

      const updates = {};
      document.querySelectorAll('#editModalBody [data-field]').forEach(input => {
        const key = input.dataset.field;
        const type = input.dataset.type;
        let val = input.value;

        if (type === 'number') {
          val = parseFloat(val) || 0;
        } else if (type === 'boolean') {
          val = val === 'true';
        } else if (type === 'json') {
          try { val = JSON.parse(val); } catch { /* keep as string */ }
        } else if (type === 'timestamp') {
          val = new Date(val);
        }

        updates[key] = val;
      });

      try {
        await updateDoc(doc(db, currentCollection, editingDoc.id), updates);
        toast('Guardado', 'Documento actualizado correctamente');
        $('editModal').classList.remove('open');
        await selectCollection(currentCollection);
      } catch (e) {
        toast('Error', e.message);
      }
    }

    async function deleteDocument(docId) {
      if (!currentCollection) return;
      if (!confirm(`¬øEliminar documento ${docId}? Esta acci√≥n no se puede deshacer.`)) return;

      try {
        await deleteDoc(doc(db, currentCollection, docId));
        toast('Eliminado', 'Documento eliminado');
        await selectCollection(currentCollection);
        loadCollectionCounts();
      } catch (e) {
        toast('Error', e.message);
      }
    }

    async function addDocument() {
      if (!currentCollection) return;

      let data;
      try {
        data = JSON.parse($('addJsonInput').value);
        if (typeof data !== 'object' || Array.isArray(data)) throw new Error('Debe ser un objeto');
      } catch (e) {
        toast('Error', 'JSON inv√°lido: ' + e.message);
        return;
      }

      try {
        await addDoc(collection(db, currentCollection), data);
        toast('Creado', 'Documento agregado correctamente');
        $('addModal').classList.remove('open');
        $('addJsonInput').value = '';
        await selectCollection(currentCollection);
        loadCollectionCounts();
      } catch (e) {
        toast('Error', e.message);
      }
    }

    // Events
    $('btnRefresh').addEventListener('click', () => {
      loadCollectionCounts();
      if (currentCollection) selectCollection(currentCollection);
    });

    $('btnSearch').addEventListener('click', applyFilter);
    $('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') applyFilter(); });

    $('btnPrev').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderTable(); } });
    $('btnNext').addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil(filteredDocs.length / PAGE_SIZE));
      if (currentPage < totalPages) { currentPage++; renderTable(); }
    });

    $('btnAdd').addEventListener('click', () => {
      $('addModalTitle').innerHTML = `<i class="fa-solid fa-plus"></i> Agregar a ${escapeHtml(COLLECTIONS.find(c => c.id === currentCollection)?.name || currentCollection)}`;
      $('addJsonInput').value = '{\n  \n}';
      $('addModal').classList.add('open');
    });

    $('btnCloseEdit').addEventListener('click', () => $('editModal').classList.remove('open'));
    $('btnCancelEdit').addEventListener('click', () => $('editModal').classList.remove('open'));
    $('btnSaveDoc').addEventListener('click', saveDocument);
    $('btnDeleteDoc').addEventListener('click', () => {
      if (editingDoc) {
        deleteDocument(editingDoc.id);
        $('editModal').classList.remove('open');
      }
    });

    $('btnCloseAdd').addEventListener('click', () => $('addModal').classList.remove('open'));
    $('btnCancelAdd').addEventListener('click', () => $('addModal').classList.remove('open'));
    $('btnConfirmAdd').addEventListener('click', addDocument);

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        $('editModal').classList.remove('open');
        $('addModal').classList.remove('open');
      }
    });

    // Cambiar base de datos
    function switchDatabase(dbName) {
      currentDbName = dbName;
      if (dbName === 'china') {
        db = dbChina;
        COLLECTIONS = COLLECTIONS_CHINA;
        $('dbLabel').textContent = 'China';
        $('dbLabel').style.background = 'rgba(239,68,68,.1)';
        $('dbLabel').style.color = '#dc2626';
      } else {
        db = dbPrincipal;
        COLLECTIONS = COLLECTIONS_PRINCIPAL;
        $('dbLabel').textContent = 'Principal';
        $('dbLabel').style.background = '#f1f5f9';
        $('dbLabel').style.color = '#64748b';
      }
      currentCollection = null;
      allDocs = [];
      filteredDocs = [];
      currentPage = 1;
      $('mainTitle').innerHTML = '<i class="fa-solid fa-table"></i> Selecciona una colecci√≥n';
      $('btnAdd').style.display = 'none';
      $('filtersBox').style.display = 'none';
      $('footerBox').style.display = 'none';
      $('tableContainer').innerHTML = '<div class="empty"><i class="fa-solid fa-hand-pointer"></i><div>Selecciona una colecci√≥n de la izquierda para ver sus documentos</div></div>';
      loadCollectionCounts();
    }

    $('dbSelector').addEventListener('change', (e) => {
      switchDatabase(e.target.value);
    });

    // Init
    loadCollectionCounts();
  </script>
</body>
</html>
