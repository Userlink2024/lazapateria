<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Maestro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --border:rgba(148,163,184,.22);
      --primary:#2563eb;
      --danger:#ef4444;
      --ok:#10b981;
      --warning:#f59e0b;
      --shadow:0 18px 45px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(900px 550px at 15% 0%, rgba(37,99,235,.28), transparent), radial-gradient(850px 520px at 85% 5%, rgba(16,185,129,.18), transparent), var(--bg);color:var(--text);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;border-radius:14px;background:linear-gradient(135deg, rgba(37,99,235,.95), rgba(29,78,216,.75));display:grid;place-items:center;box-shadow:0 10px 26px rgba(37,99,235,.25)}
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .brand .sub{margin-top:4px;color:var(--muted);font-size:12px}

    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .btn{border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:700;font-size:12px}
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn.primary{background:linear-gradient(135deg, rgba(37,99,235,.95), rgba(29,78,216,.75));border:none}
    .btn.danger{background:linear-gradient(135deg, rgba(239,68,68,.95), rgba(185,28,28,.75));border:none}
    .btn.ok{background:linear-gradient(135deg, rgba(16,185,129,.95), rgba(5,150,105,.75));border:none}

    .card{background:rgba(15,23,42,.78);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .card-h{padding:14px 14px 10px 14px;border-bottom:1px solid rgba(148,163,184,.16)}
    .card-b{padding:14px}

    .grid{display:grid;grid-template-columns:1.2fr .8fr .8fr;gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    label{display:block;color:var(--muted);font-size:12px;font-weight:800;margin:0 0 8px}
    input,select,textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(2,6,23,.35);color:var(--text);outline:none}
    input:focus,select:focus,textarea:focus{border-color:rgba(37,99,235,.6);box-shadow:0 0 0 4px rgba(37,99,235,.14)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);cursor:pointer;font-weight:900;font-size:12px;display:flex;gap:8px;align-items:center}
    .tab.active{background:linear-gradient(135deg, rgba(37,99,235,.32), rgba(37,99,235,.12));border-color:rgba(37,99,235,.55)}
    .badge{font-size:11px;font-weight:900;padding:2px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.25);color:var(--muted)}

    .table{width:100%;border-collapse:separate;border-spacing:0 10px}
    .row{background:rgba(2,6,23,.28);border:1px solid rgba(148,163,184,.18);border-radius:14px}
    .row td{padding:12px 12px;vertical-align:top}
    .title{font-weight:900}
    .meta{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.35}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:rgba(255,255,255,.03);font-size:11px;font-weight:900;color:var(--muted)}
    .pill.ok{border-color:rgba(16,185,129,.4);color:#86efac;background:rgba(16,185,129,.08)}
    .pill.off{border-color:rgba(239,68,68,.4);color:#fecaca;background:rgba(239,68,68,.08)}

    .row-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:11px}

    .footer{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:12px;color:var(--muted);font-size:12px}
    .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:22px;z-index:100}
    .modal.open{display:flex}
    .modal-card{width:min(680px,100%);background:rgba(15,23,42,.92);border:1px solid rgba(148,163,184,.22);border-radius:16px;box-shadow:var(--shadow)}
    .modal-head{padding:14px;border-bottom:1px solid rgba(148,163,184,.16);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal-head h3{margin:0;font-size:14px}
    .modal-body{padding:14px}
    .modal-actions{padding:14px;border-top:1px solid rgba(148,163,184,.16);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .hint{color:var(--muted);font-size:12px}

    .toast{position:fixed;right:18px;bottom:18px;z-index:110;display:none}
    .toast.show{display:block}
    .toast-card{background:rgba(2,6,23,.72);border:1px solid rgba(148,163,184,.22);border-radius:14px;padding:12px 14px;box-shadow:var(--shadow);min-width:260px}
    .toast-title{font-weight:900}
    .toast-msg{margin-top:4px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-layer-group"></i></div>
        <div>
          <h1>Panel Maestro</h1>
          <div class="sub">Módulos HTML • filtros • paginación (30) • agregar / editar / eliminar</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" type="button" id="btnNuevo"><i class="fa-solid fa-plus"></i> Agregar módulo</button>
        <button class="btn" type="button" id="btnImport"><i class="fa-solid fa-file-import"></i> Importar</button>
        <button class="btn" type="button" id="btnExport"><i class="fa-solid fa-file-export"></i> Exportar</button>
        <button class="btn danger" type="button" id="btnReset"><i class="fa-solid fa-rotate"></i> Restaurar</button>
      </div>
    </div>

    <div class="card" style="margin-bottom:14px">
      <div class="card-h">
        <div class="tabs" id="tabs"></div>
      </div>
      <div class="card-b">
        <div class="grid">
          <div>
            <label for="q">Buscar</label>
            <input id="q" type="text" placeholder="Buscar por nombre, archivo, tags..." />
          </div>
          <div>
            <label for="cat">Categoría</label>
            <select id="cat"></select>
          </div>
          <div>
            <label for="estado">Estado</label>
            <select id="estado">
              <option value="all">Todos</option>
              <option value="on">Activos</option>
              <option value="off">Inactivos</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h" style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="pill" id="countPill"><i class="fa-solid fa-list"></i> 0 módulos</div>
          <div class="hint" id="rangeHint"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" type="button" id="btnPrev"><i class="fa-solid fa-chevron-left"></i> Anterior</button>
          <button class="btn" type="button" id="btnNext">Siguiente <i class="fa-solid fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="card-b" style="padding-top:6px">
        <table class="table" id="table"></table>
        <div class="footer">
          <div>Página <strong id="pageLabel">1</strong></div>
          <div class="pager">
            <span class="pill">Paginación fija: 30</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalEdit">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="modalTitle">Módulo</h3>
        <button class="btn" type="button" id="btnCloseEdit"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
          <div style="grid-column:1 / -1">
            <label for="mTitulo">Nombre</label>
            <input id="mTitulo" type="text" placeholder="Ej: Auditoría de Fondos" />
          </div>
          <div>
            <label for="mArchivo">Archivo / URL</label>
            <input id="mArchivo" type="text" placeholder="Ej: auditoriadefondos.html" />
          </div>
          <div>
            <label for="mCategoria">Categoría</label>
            <input id="mCategoria" type="text" placeholder="Ej: Auditoría" />
          </div>
          <div style="grid-column:1 / -1">
            <label for="mTags">Tags (separados por coma)</label>
            <input id="mTags" type="text" placeholder="Ej: china, caja, auditoria" />
          </div>
          <div style="grid-column:1 / -1">
            <label for="mNota">Nota (opcional)</label>
            <textarea id="mNota" rows="3" placeholder="Descripción corta"></textarea>
          </div>
          <div style="grid-column:1 / -1;display:flex;align-items:center;gap:10px">
            <input id="mActivo" type="checkbox" style="width:18px;height:18px" />
            <label for="mActivo" style="margin:0">Activo</label>
          </div>
          <div class="hint" id="editHint" style="grid-column:1 / -1"></div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn danger" type="button" id="btnDelete"><i class="fa-solid fa-trash"></i> Eliminar</button>
        <div style="flex:1"></div>
        <button class="btn" type="button" id="btnCancel"><i class="fa-solid fa-xmark"></i> Cancelar</button>
        <button class="btn ok" type="button" id="btnSave"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalImport">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Importar / Exportar</h3>
        <button class="btn" type="button" id="btnCloseImport"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="hint" style="margin-bottom:10px">Pega un JSON con el arreglo de módulos. También puedes copiar el JSON para guardarlo.</div>
        <textarea id="io" rows="12" style="width:100%"></textarea>
        <div class="hint" id="ioHint" style="margin-top:10px"></div>
      </div>
      <div class="modal-actions">
        <button class="btn" type="button" id="btnCopy"><i class="fa-solid fa-copy"></i> Copiar</button>
        <button class="btn" type="button" id="btnPaste"><i class="fa-solid fa-clipboard"></i> Pegar</button>
        <div style="flex:1"></div>
        <button class="btn" type="button" id="btnCloseImport2"><i class="fa-solid fa-xmark"></i> Cerrar</button>
        <button class="btn ok" type="button" id="btnApplyImport"><i class="fa-solid fa-check"></i> Aplicar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="toast-card">
      <div class="toast-title" id="toastTitle">Listo</div>
      <div class="toast-msg" id="toastMsg"></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const safeStr = (v) => (v === undefined || v === null) ? '' : String(v).trim();
    const escapeHtml = (s) => safeStr(s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');

    const STORAGE_KEY = 'panel_maestro_modules_v1';
    const PAGE_SIZE = 30;

    const DEFAULT_MODULES = [
      { id: crypto.randomUUID(), titulo: 'Auditoría de Fondos', archivo: 'auditoriadefondos.html', categoria: 'Auditoría', tags: ['caja','china'], nota: '', activo: true, updatedAt: Date.now() },
      { id: crypto.randomUUID(), titulo: 'Inventario China', archivo: 'chinainventario.html', categoria: 'China', tags: ['inventario','facturas'], nota: '', activo: true, updatedAt: Date.now() },
      { id: crypto.randomUUID(), titulo: 'Bodega', archivo: 'bodega.html', categoria: 'Bodega', tags: [], nota: '', activo: true, updatedAt: Date.now() },
      { id: crypto.randomUUID(), titulo: 'Configuración Usuarios', archivo: 'configuracion_usuarios.html', categoria: 'Configuración', tags: ['usuarios'], nota: '', activo: true, updatedAt: Date.now() },
      { id: crypto.randomUUID(), titulo: 'Control de Asistencia', archivo: 'controldeasistencia.html', categoria: 'Personal', tags: ['asistencia'], nota: '', activo: true, updatedAt: Date.now() },
      { id: crypto.randomUUID(), titulo: 'Cuentas Bancarias', archivo: 'cuentasbancarias.html', categoria: 'Finanzas', tags: ['bancos'], nota: '', activo: true, updatedAt: Date.now() },
      { id: crypto.randomUUID(), titulo: 'Generar Pedidos', archivo: 'generar_pedidos.html', categoria: 'Pedidos', tags: [], nota: '', activo: true, updatedAt: Date.now() },
      { id: crypto.randomUUID(), titulo: 'Gráfica General', archivo: 'graficageneral.html', categoria: 'Reportes', tags: ['graficas'], nota: '', activo: true, updatedAt: Date.now() },
      { id: crypto.randomUUID(), titulo: 'Gráfica por Asesor', archivo: 'graficaporasesor.html', categoria: 'Reportes', tags: ['graficas'], nota: '', activo: true, updatedAt: Date.now() },
      { id: crypto.randomUUID(), titulo: 'Historial Disponible', archivo: 'historial_disponible.html', categoria: 'Historial', tags: [], nota: '', activo: true, updatedAt: Date.now() },
      { id: crypto.randomUUID(), titulo: 'Indicador de Bodega', archivo: 'indicadordebodega.html', categoria: 'Bodega', tags: ['indicadores'], nota: '', activo: true, updatedAt: Date.now() }
    ];

    let modules = [];
    let activeTab = 'Todos';
    let currentPage = 1;
    let editingId = null;

    function toast(title, msg){
      $('toastTitle').textContent = title;
      $('toastMsg').textContent = msg || '';
      $('toast').classList.add('show');
      setTimeout(() => $('toast').classList.remove('show'), 2200);
    }

    function loadModules(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          modules = DEFAULT_MODULES.slice();
          saveModules();
          return;
        }
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) throw new Error('Formato inválido');
        modules = parsed.map(m => ({
          id: safeStr(m.id) || crypto.randomUUID(),
          titulo: safeStr(m.titulo),
          archivo: safeStr(m.archivo),
          categoria: safeStr(m.categoria) || 'Otros',
          tags: Array.isArray(m.tags) ? m.tags.map(t => safeStr(t)).filter(Boolean) : safeStr(m.tags).split(',').map(x => safeStr(x)).filter(Boolean),
          nota: safeStr(m.nota),
          activo: m.activo !== false,
          updatedAt: Number(m.updatedAt || Date.now())
        }));
      }catch{
        modules = DEFAULT_MODULES.slice();
        saveModules();
      }
    }

    function saveModules(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(modules));
    }

    function categories(){
      const cats = new Set(['Todos']);
      modules.forEach(m => cats.add(safeStr(m.categoria) || 'Otros'));
      return Array.from(cats);
    }

    function computeFiltered(){
      const q = safeStr($('q').value).toLowerCase();
      const estado = $('estado').value;
      const cat = $('cat').value;

      return modules
        .filter(m => {
          if (activeTab !== 'Todos' && safeStr(m.categoria) !== activeTab) return false;
          if (cat !== 'all' && safeStr(m.categoria) !== cat) return false;
          if (estado === 'on' && m.activo !== true) return false;
          if (estado === 'off' && m.activo === true) return false;
          if (!q) return true;
          const hay = [m.titulo, m.archivo, m.categoria, m.nota, (m.tags || []).join(',')].join(' ').toLowerCase();
          return hay.includes(q);
        })
        .sort((a,b) => (b.updatedAt || 0) - (a.updatedAt || 0));
    }

    function renderTabs(){
      const tabsEl = $('tabs');
      tabsEl.innerHTML = '';
      const cats = categories();
      const filteredAll = computeFilteredAllNoTab();

      cats.forEach(c => {
        const count = (c === 'Todos') ? filteredAll.length : filteredAll.filter(m => safeStr(m.categoria) === c).length;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'tab' + (c === activeTab ? ' active' : '');
        btn.innerHTML = `${escapeHtml(c)} <span class="badge">${count}</span>`;
        btn.addEventListener('click', () => {
          activeTab = c;
          currentPage = 1;
          render();
        });
        tabsEl.appendChild(btn);
      });
    }

    function computeFilteredAllNoTab(){
      const q = safeStr($('q').value).toLowerCase();
      const estado = $('estado').value;
      const cat = $('cat').value;

      return modules
        .filter(m => {
          if (cat !== 'all' && safeStr(m.categoria) !== cat) return false;
          if (estado === 'on' && m.activo !== true) return false;
          if (estado === 'off' && m.activo === true) return false;
          if (!q) return true;
          const hay = [m.titulo, m.archivo, m.categoria, m.nota, (m.tags || []).join(',')].join(' ').toLowerCase();
          return hay.includes(q);
        })
        .sort((a,b) => (b.updatedAt || 0) - (a.updatedAt || 0));
    }

    function renderCategorySelect(){
      const sel = $('cat');
      const current = sel.value || 'all';
      const cats = categories().filter(c => c !== 'Todos');

      sel.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = 'all';
      optAll.textContent = 'Todas';
      sel.appendChild(optAll);

      cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });

      sel.value = cats.includes(current) ? current : 'all';
    }

    function renderTable(){
      const data = computeFiltered();
      const table = $('table');
      table.innerHTML = '';

      const total = data.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage - 1) * PAGE_SIZE;
      const end = Math.min(total, start + PAGE_SIZE);
      const slice = data.slice(start, end);

      $('countPill').innerHTML = `<i class="fa-solid fa-list"></i> ${total} módulos`;
      $('rangeHint').textContent = total ? `Mostrando ${start + 1}-${end} de ${total}` : 'Sin resultados';
      $('pageLabel').textContent = String(currentPage);

      if (!slice.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.innerHTML = `<div class="hint" style="padding:10px">No hay módulos con los filtros actuales.</div>`;
        tr.appendChild(td);
        table.appendChild(tr);
        return;
      }

      slice.forEach(m => {
        const tr = document.createElement('tr');
        tr.className = 'row';

        const estadoPill = m.activo ? '<span class="pill ok"><i class="fa-solid fa-circle-check"></i> Activo</span>' : '<span class="pill off"><i class="fa-solid fa-circle-xmark"></i> Inactivo</span>';
        const tags = (m.tags || []).slice(0, 6).map(t => `<span class="pill">#${escapeHtml(t)}</span>`).join(' ');

        const td1 = document.createElement('td');
        td1.innerHTML = `
          <div class="title">${escapeHtml(m.titulo || 'Sin nombre')}</div>
          <div class="meta">
            <div><i class="fa-solid fa-link"></i> <strong>${escapeHtml(m.archivo || '—')}</strong></div>
            <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <span class="pill"><i class="fa-solid fa-folder"></i> ${escapeHtml(m.categoria || 'Otros')}</span>
              ${estadoPill}
            </div>
            ${m.nota ? `<div style="margin-top:8px">${escapeHtml(m.nota)}</div>` : ''}
            ${tags ? `<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">${tags}</div>` : ''}
          </div>
        `;

        const td2 = document.createElement('td');
        td2.innerHTML = `
          <div class="meta">
            <div><strong>Actualizado:</strong> ${new Date(m.updatedAt || Date.now()).toLocaleString('es-CO')}</div>
          </div>
        `;

        const td3 = document.createElement('td');
        const openDisabled = (!m.activo || !m.archivo) ? 'disabled' : '';
        const openStyle = (!m.activo || !m.archivo) ? 'opacity:.45;pointer-events:none' : '';
        td3.innerHTML = `
          <div class="row-actions">
            <button class="btn small primary" type="button" data-open="${escapeHtml(m.id)}" style="${openStyle}"><i class="fa-solid fa-arrow-up-right-from-square"></i> Abrir</button>
            <button class="btn small" type="button" data-edit="${escapeHtml(m.id)}"><i class="fa-solid fa-pen"></i> Editar</button>
            <button class="btn small" type="button" data-dup="${escapeHtml(m.id)}"><i class="fa-solid fa-copy"></i> Duplicar</button>
            <button class="btn small danger" type="button" data-del="${escapeHtml(m.id)}"><i class="fa-solid fa-trash"></i> Eliminar</button>
          </div>
        `;

        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        table.appendChild(tr);

        tr.querySelector('[data-open]')?.addEventListener('click', () => {
          const url = safeStr(m.archivo);
          if (!url) return;
          window.open(url, '_blank');
        });

        tr.querySelector('[data-edit]')?.addEventListener('click', () => openEdit(m.id));

        tr.querySelector('[data-dup]')?.addEventListener('click', () => {
          const copy = { ...m, id: crypto.randomUUID(), titulo: safeStr(m.titulo) + ' (copia)', updatedAt: Date.now() };
          modules.unshift(copy);
          saveModules();
          toast('Duplicado', 'Se creó una copia del módulo.');
          render();
        });

        tr.querySelector('[data-del]')?.addEventListener('click', () => {
          if (!confirm('¿Eliminar este módulo?')) return;
          modules = modules.filter(x => x.id !== m.id);
          saveModules();
          toast('Eliminado', 'Módulo eliminado.');
          render();
        });
      });
    }

    function openEdit(id){
      editingId = id || null;
      const isNew = !editingId;
      $('modalTitle').textContent = isNew ? 'Agregar módulo' : 'Editar módulo';
      $('btnDelete').style.display = isNew ? 'none' : '';

      const m = isNew ? { titulo:'', archivo:'', categoria:'', tags:[], nota:'', activo:true } : modules.find(x => x.id === editingId);
      if (!m) return;

      $('mTitulo').value = safeStr(m.titulo);
      $('mArchivo').value = safeStr(m.archivo);
      $('mCategoria').value = safeStr(m.categoria);
      $('mTags').value = (m.tags || []).join(', ');
      $('mNota').value = safeStr(m.nota);
      $('mActivo').checked = m.activo !== false;

      $('editHint').textContent = isNew ? 'Tip: usa nombres cortos y un archivo relativo (ej: chinainventario.html).' : '';
      $('modalEdit').classList.add('open');
      $('mTitulo').focus();
    }

    function closeEdit(){
      $('modalEdit').classList.remove('open');
      editingId = null;
    }

    function saveEdit(){
      const titulo = safeStr($('mTitulo').value);
      const archivo = safeStr($('mArchivo').value);
      const categoria = safeStr($('mCategoria').value) || 'Otros';
      const tags = safeStr($('mTags').value).split(',').map(x => safeStr(x)).filter(Boolean);
      const nota = safeStr($('mNota').value);
      const activo = $('mActivo').checked;

      if (!titulo || !archivo) {
        $('editHint').textContent = 'Nombre y archivo son obligatorios.';
        return;
      }

      if (!editingId) {
        modules.unshift({ id: crypto.randomUUID(), titulo, archivo, categoria, tags, nota, activo, updatedAt: Date.now() });
        toast('Agregado', 'Módulo creado.');
      } else {
        modules = modules.map(m => m.id === editingId ? ({...m, titulo, archivo, categoria, tags, nota, activo, updatedAt: Date.now()}) : m);
        toast('Guardado', 'Cambios aplicados.');
      }

      saveModules();
      closeEdit();
      render();
    }

    function exportJson(){
      $('io').value = JSON.stringify(modules, null, 2);
      $('ioHint').textContent = 'Copia este JSON para respaldar tu lista.';
      $('modalImport').classList.add('open');
    }

    function importJson(openOnly){
      if (openOnly) {
        $('io').value = '';
        $('ioHint').textContent = 'Pega el JSON y pulsa Aplicar.';
        $('modalImport').classList.add('open');
        return;
      }

      try{
        const raw = $('io').value;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) throw new Error('Debe ser un arreglo');
        modules = parsed.map(m => ({
          id: safeStr(m.id) || crypto.randomUUID(),
          titulo: safeStr(m.titulo),
          archivo: safeStr(m.archivo),
          categoria: safeStr(m.categoria) || 'Otros',
          tags: Array.isArray(m.tags) ? m.tags.map(t => safeStr(t)).filter(Boolean) : safeStr(m.tags).split(',').map(x => safeStr(x)).filter(Boolean),
          nota: safeStr(m.nota),
          activo: m.activo !== false,
          updatedAt: Number(m.updatedAt || Date.now())
        }));
        saveModules();
        $('modalImport').classList.remove('open');
        toast('Importado', 'Lista aplicada.');
        currentPage = 1;
        render();
      }catch(e){
        $('ioHint').textContent = 'Error: ' + (e && e.message ? e.message : String(e));
      }
    }

    function render(){
      renderCategorySelect();
      renderTabs();
      renderTable();
    }

    function bind(){
      $('q').addEventListener('input', () => { currentPage = 1; render(); });
      $('cat').addEventListener('change', () => { currentPage = 1; render(); });
      $('estado').addEventListener('change', () => { currentPage = 1; render(); });

      $('btnPrev').addEventListener('click', () => {
        currentPage = Math.max(1, currentPage - 1);
        render();
      });
      $('btnNext').addEventListener('click', () => {
        const total = computeFiltered().length;
        const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        currentPage = Math.min(totalPages, currentPage + 1);
        render();
      });

      $('btnNuevo').addEventListener('click', () => openEdit(null));
      $('btnCloseEdit').addEventListener('click', closeEdit);
      $('btnCancel').addEventListener('click', closeEdit);
      $('btnSave').addEventListener('click', saveEdit);
      $('btnDelete').addEventListener('click', () => {
        if (!editingId) return;
        const m = modules.find(x => x.id === editingId);
        if (!m) return;
        if (!confirm('¿Eliminar este módulo?')) return;
        modules = modules.filter(x => x.id !== editingId);
        saveModules();
        closeEdit();
        toast('Eliminado', 'Módulo eliminado.');
        render();
      });

      $('btnExport').addEventListener('click', exportJson);
      $('btnImport').addEventListener('click', () => importJson(true));

      $('btnCloseImport').addEventListener('click', () => $('modalImport').classList.remove('open'));
      $('btnCloseImport2').addEventListener('click', () => $('modalImport').classList.remove('open'));
      $('btnApplyImport').addEventListener('click', () => importJson(false));

      $('btnCopy').addEventListener('click', async () => {
        try{
          await navigator.clipboard.writeText($('io').value || '');
          $('ioHint').textContent = 'Copiado al portapapeles.';
        }catch{
          $('ioHint').textContent = 'No se pudo copiar (permiso del navegador).';
        }
      });
      $('btnPaste').addEventListener('click', async () => {
        try{
          $('io').value = await navigator.clipboard.readText();
          $('ioHint').textContent = 'Pegado desde el portapapeles.';
        }catch{
          $('ioHint').textContent = 'No se pudo pegar (permiso del navegador).';
        }
      });

      $('btnReset').addEventListener('click', () => {
        if (!confirm('¿Restaurar la lista por defecto? Se perderán cambios locales.')) return;
        modules = DEFAULT_MODULES.slice();
        saveModules();
        toast('Restaurado', 'Lista por defecto cargada.');
        currentPage = 1;
        activeTab = 'Todos';
        $('q').value = '';
        $('estado').value = 'all';
        render();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          $('modalEdit').classList.remove('open');
          $('modalImport').classList.remove('open');
        }
      });
    }

    loadModules();
    bind();
    render();
  </script>
</body>
</html>
