<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>La Zapater√≠a ‚Äî Facturas de Fabricantes</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

<!-- SheetJS (exportar Excel) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f4f7fb; --card:#fff; --accent:#0984e3; --muted:#6b7280; --danger:#d63031;
}
*{box-sizing:border-box}
body{font-family:Inter, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:#111}
.topbar{
  background:linear-gradient(90deg,#2d3436,#1e272e); color:white; padding:12px 18px; display:flex; justify-content:space-between; align-items:center;
}
.topbar .left{display:flex; gap:12px; align-items:center}
.btn-back{background:transparent; color:white; border:none; font-size:18px; cursor:pointer}
.topbar .right{display:flex; gap:12px; align-items:center}
.badge{background:rgba(255,255,255,0.06); padding:6px 10px; border-radius:8px; font-size:13px}
.btn-logout{background:#d63031;color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
.toggle-dark{background:#222;color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}

.container{max-width:1200px;margin:18px auto;padding:14px;display:flex;gap:18px}
.panel{background:var(--card); border-radius:10px; padding:16px; box-shadow:0 8px 24px rgba(16,24,40,0.06)}
.left{width:320px}
.right{flex:1; min-width:0}

h2{margin:6px 0 12px;color:#222;font-size:18px}
label{font-size:13px;color:var(--muted);display:block;margin-top:8px}
input[type="text"], input[type="date"], input[type="number"], select{
  width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #e6eef5; font-size:14px;
}
.checkbox{display:flex; align-items:center; gap:8px; margin-top:8px; font-size:14px}

.btn{padding:10px 12px; border-radius:8px; border:none; cursor:pointer;}
.btn-primary{background:var(--accent); color:white; width:100%}
.btn-secondary{background:#2d3436;color:white;width:100%}
.btn-excel{background:#27ae60;color:white}
.muted{color:var(--muted); font-size:13px}

.search-row{display:flex; gap:10px; margin-bottom:8px; align-items:center}
.table-wrap{overflow:auto; max-height:520px; border-radius:8px; border:1px solid #eef3f6}
table{width:100%; border-collapse:collapse; font-size:14px}
th, td{padding:8px 10px; border-bottom:1px solid #f2f5f7; text-align:left}
th{background:#f7fafc; font-weight:700}
.name-link{color:var(--accent); cursor:pointer; text-decoration:underline}
.footer-stats{display:flex; justify-content:space-between; margin-top:8px; align-items:center}

/* modal */
.modal-back{position:fixed; inset:0; display:none; background:rgba(0,0,0,0.45); justify-content:center; align-items:flex-start; padding-top:48px; z-index:80}
.modal{background:white; width:94%; max-width:980px; border-radius:12px; padding:16px; max-height:84vh; overflow:auto}

/* dark mode */
body.dark{background:#121217; color:#e8e8e8}
body.dark .panel{background:#15161a}
body.dark .topbar{background:#0d0f11}
body.dark input{background:#0f1113; border:1px solid #222; color:#ddd}
body.dark th{background:#0b0c0e}
body.dark table, body.dark td{border-color:#17181a}
</style>
</head>
<body>

<div class="topbar">
  <div class="left">
    <button class="btn-back" onclick="location.href='https://userlink2024.github.io/lazapateria/paneldecuentas.html'">‚Üê Atr√°s</button>
    <div style="font-weight:600">La Zapater√≠a ‚Äî Facturas de Fabricantes</div>
  </div>
  <div class="right">
    <div id="user-info" class="badge">Cargando...</div>
    <button class="toggle-dark" id="toggleDark">üåô</button>
    <button id="logout" class="btn-logout">Cerrar sesi√≥n</button>
  </div>
</div>

<div class="container">
  <!-- LEFT -->
  <div class="panel left">
    <h2>Formulario de factura / abono</h2>

    <!-- BANNER MODO ABONO -->
    <div id="bannerAbono" 
         style="display:none; background:#0984e3; color:white; padding:8px;
                text-align:center; margin-bottom:10px; border-radius:8px; font-weight:600;">
      MODO ABONO GENERAL
    </div>

    <label>Fecha</label>
    <input type="date" id="fecha">

    <label>NIT</label>
    <input type="text" id="nit">

    <label>Nombre fabricante</label>
    <input type="text" id="nombre">

    <label>N¬∞ Factura</label>
    <input type="text" id="numFactura">

    <label>Valor</label>
    <input type="number" id="valor" value="0">

    <label>Abono (ABONO GENERAL)</label>
    <input type="number" id="abono" value="0">

    <label class="checkbox">
      <input type="checkbox" id="soloAbonar"> Solo abonar (ABONO GENERAL)
    </label>

    <button class="btn btn-primary" id="btnGuardar">GUARDAR</button>
    <button class="btn btn-secondary" id="btnLimpiar" style="margin-top:8px">Limpiar</button>

  </div>

  <!-- RIGHT -->
  <div class="panel right">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0">Lista de cuentas</h2>
      <div style="text-align:right">
        <div class="muted">Deuda total</div>
        <div id="totalGeneral" style="font-weight:700; font-size:18px">$0</div>
      </div>
    </div>

    <div class="search-row" style="margin-top:12px">
      <input type="text" id="buscar" placeholder="Buscar..." style="flex:1" oninput="filtrar()">
      <button class="btn btn-excel" onclick="exportarExcel()">Excel</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>NIT</th><th>Nombre</th><th>N¬∞ Factura</th><th>Valor</th>
            <th>Abono</th><th>Saldo</th><th>Fecha</th><th>Tipo</th>
          </tr>
        </thead>
        <tbody id="tablaFabricantes"></tbody>
      </table>
    </div>

    <div class="footer-stats">
      <div class="muted">Registros: <span id="countRegs">0</span></div>
      <div class="muted">Deuda filtro: <strong id="deudaFiltro">$0</strong></div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modalBackdrop" class="modal-back">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h3 id="modalTitle" style="margin:0"></h3>
        <div class="muted">NIT: <span id="modalNit"></span></div>
      </div>
      <button class="btn btn-secondary" onclick="cerrarModal()">Cerrar</button>
    </div>

    <div style="display:flex; gap:12px; margin-top:12px;">
      <div style="flex:1">
        <table>
          <thead>
            <tr><th>#</th><th>N¬∞ Factura</th><th>Total Factura</th><th>Total Abonos</th><th>Saldo</th><th></th></tr>
          </thead>
          <tbody id="modalSummary"></tbody>
        </table>
      </div>

      <div style="width:340px; background:#fafbfd; padding:8px; border-radius:8px">
        <canvas id="chartBar"></canvas>
        <canvas id="chartDonut" style="margin-top:8px"></canvas>
        <div style="margin-top:8px; text-align:right; font-weight:700">Total deuda: <span id="modalTotal">$0</span></div>
      </div>
    </div>

    <div id="detalleList" style="margin-top:12px"></div>
  </div>
</div>

<script>
/* FIREBASE */
const firebaseConfig = {
  apiKey:"AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
  authDomain:"lazapateria-c4157.firebaseapp.com",
  projectId:"lazapateria-c4157",
  storageBucket:"lazapateria-c4157.firebasestorage.app",
  messagingSenderId:"300241769138",
  appId:"1:300241769138:web:8ca1847de3c4fb5042afab"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const COLECCION = "fabricantes";

/* SESI√ìN */
const usuario = JSON.parse(localStorage.getItem('datosUsuario')||'null');
if(!usuario){ alert("No hay sesi√≥n activa"); location.href="index.html"; }
if(usuario.permisos !== "Administrador"){ alert("Acceso denegado"); location.href="index.html"; }
document.getElementById("user-info").textContent = usuario.usuario + " ‚Äî " + usuario.permisos;
document.getElementById("logout").onclick = ()=>{ localStorage.removeItem('datosUsuario'); location.href="index.html"; };

/* DARK MODE */
if(localStorage.getItem("dark")==="1"){ document.body.classList.add("dark"); toggleDark.textContent="‚òÄÔ∏è"; }
toggleDark.onclick = ()=>{
  document.body.classList.toggle("dark");
  const on = document.body.classList.contains("dark");
  toggleDark.textContent = on ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("dark", on ? "1":"0");
};

let registros = [];
let currentModalNit = null;
let grouped = {};
let chartBar=null, chartDonut=null;

/* CARGAR TODO */
async function cargarTodos(){
  const snap = await db.collection(COLECCION).get();
  registros = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  registros.forEach(r=>{
    if(r.fecha?.seconds)
      r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10);
  });
  renderTabla(registros);
  actualizarTotales(registros);
}
cargarTodos();

/* TABLA PRINCIPAL */
function renderTabla(list){
  const tbody = document.getElementById("tablaFabricantes");
  tbody.innerHTML = "";

  list.forEach(r=>{
    const valor = Number(r.valor||0);
    const abono = Number(r.abono||0);
    const saldo = valor - abono;
    const tipo = valor>0 ? "Factura" : "ABONO GENERAL";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.nit}</td>
      <td><span class="name-link">${r.nombre}</span></td>
      <td>${r.numFactura}</td>
      <td>$${valor.toLocaleString()}</td>
      <td>$${abono.toLocaleString()}</td>
      <td>$${saldo.toLocaleString()}</td>
      <td>${r.fecha||''}</td>
      <td>${tipo}</td>
    `;

    tr.ondblclick = ()=> openModal(r.nit, r.nombre);
    tr.querySelector(".name-link").onclick = e=>{
      e.stopPropagation();
      document.getElementById("nit").value = r.nit;
      document.getElementById("nombre").value = r.nombre;
    };

    tbody.appendChild(tr);
  });

  document.getElementById("countRegs").textContent = list.length;
}

/* FILTRAR */
function filtrar(){
  const q = buscar.value.trim().toLowerCase();
  const out = registros.filter(r => 
     r.nit.toLowerCase().includes(q) ||
     r.nombre.toLowerCase().includes(q) ||
     r.numFactura.toLowerCase().includes(q)
  );
  renderTabla(out);
  actualizarTotales(out);
}

/* TOTALES */
function actualizarTotales(list){
  let totF = list.reduce((s,x)=> s+Number(x.valor||0),0);
  let totA = list.reduce((s,x)=> s+Number(x.abono||0),0);
  let saldo = totF - totA;
  document.getElementById("totalGeneral").textContent = "$" + saldo.toLocaleString();
  document.getElementById("deudaFiltro").textContent = "$" + saldo.toLocaleString();
}

/* SOLO ABONAR */
document.getElementById("soloAbonar").onchange = function(){
  const numFact = document.getElementById("numFactura");
  const valor = document.getElementById("valor");
  const abono = document.getElementById("abono");
  const banner = document.getElementById("bannerAbono");

  if(this.checked){
    banner.style.display = "block";
    valor.value = 0;
    valor.disabled = true;

    numFact.value = "ABONO";
    numFact.disabled = true;

    abono.focus();
  } else {
    banner.style.display = "none";
    valor.disabled = false;

    numFact.disabled = false;
    numFact.value = "";
  }
};

/* GUARDAR */
btnGuardar.onclick = async ()=>{
  const fecha = fechaInput.value || new Date().toISOString().slice(0,10);
  const nit = nitInput.value.trim();
  const nombre = nombreInput.value.trim();
  const numFactura = numFacturaInput.value.trim() || "-";
  const valor = Number(valorInput.value||0);
  const abono = Number(abonoInput.value||0);
  const solo = soloAbonar.checked;

  if(!nit || !nombre){ alert("Completa NIT y Nombre"); return; }

  if(solo){
    if(abono<=0){ alert("Debes ingresar un valor en Abono."); return; }
    await db.collection(COLECCION).add({fecha,nit,nombre,numFactura:"ABONO",valor:0,abono});
    alert("Abono registrado.");
  } else {
    if(valor<=0){ alert("Debes ingresar un Valor mayor a 0."); return; }
    await db.collection(COLECCION).add({fecha,nit,nombre,numFactura,valor,abono:0});
    alert("Factura registrada.");
  }

  limpiar();
  cargarTodos();
};

/* LIMPIAR */
function limpiar(){
  fechaInput.value="";
  nitInput.value="";
  nombreInput.value="";
  numFacturaInput.value="";
  valorInput.value=0;
  abonoInput.value=0;
  soloAbonar.checked=false;
  numFacturaInput.disabled=false;
  valorInput.disabled=false;
  document.getElementById("bannerAbono").style.display="none";
}

/* MODAL */
async function openModal(nit, nombre){
  currentModalNit = nit;
  modalTitle.textContent = "Historial: " + nombre;
  modalNit.textContent = nit;
  modalBackdrop.style.display = "flex";

  const snap = await db.collection(COLECCION).where("nit","==",nit).get();
  if(snap.empty){
    modalSummary.innerHTML = "<tr><td colspan='6'>Sin datos</td></tr>";
    modalTotal.textContent = "$0";
    return;
  }

  const rows = snap.docs.map(d=>({id:d.id, ...d.data()}));
  rows.forEach(r=>{ if(r.fecha?.seconds) r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10); });

  grouped = {};
  rows.forEach(r=>{
    const k = r.numFactura || "-";
    if(!grouped[k]) grouped[k] = {fact:[], abo:[]};
    if(r.valor>0) grouped[k].fact.push(r);
    if(r.abono>0) grouped[k].abo.push(r);
  });

  renderSummary(rows);
  renderDetalle(rows);
}

function renderSummary(rows){
  modalSummary.innerHTML="";
  let totF=0, totA=0;
  let i=1;

  for(const f in grouped){
    const sumF = grouped[f].fact.reduce((s,x)=>s+Number(x.valor),0);
    const sumA = grouped[f].abo.reduce((s,x)=>s+Number(x.abono),0);
    totF += sumF; totA += sumA;
    const saldo = sumF - sumA;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i++}</td>
      <td>${f}</td>
      <td>$${sumF.toLocaleString()}</td>
      <td>$${sumA.toLocaleString()}</td>
      <td>$${saldo.toLocaleString()}</td>
      <td><button onclick="verFactura('${f}')">Ver</button></td>
    `;
    modalSummary.appendChild(tr);
  }

  modalTotal.textContent = "$" + (totF - totA).toLocaleString();
  drawCharts(Object.keys(grouped), grouped);
}

function renderDetalle(rows){
  detalleList.innerHTML="<h4>Detalles</h4>";
  let html=`<table style="width:100%"><thead>
  <tr><th>#</th><th>Tipo</th><th>Factura</th><th>Valor</th><th>Abono</th><th>Fecha</th></tr>
  </thead><tbody>`;
  rows.forEach((r,i)=>{
    html += `
      <tr>
        <td>${i+1}</td>
        <td>${r.valor>0?'Factura':'ABONO GENERAL'}</td>
        <td>${r.numFactura}</td>
        <td>$${Number(r.valor).toLocaleString()}</td>
        <td>$${Number(r.abono).toLocaleString()}</td>
        <td>${r.fecha}</td>
      </tr>`;
  });
  html+="</tbody></table>";
  detalleList.innerHTML += html;
}

/* GR√ÅFICOS */
function drawCharts(keys, grouped){
  if(chartBar) chartBar.destroy();
  if(chartDonut) chartDonut.destroy();

  let dataF = keys.map(k=> grouped[k].fact.reduce((s,x)=>s+Number(x.valor),0));
  let dataA = keys.map(k=> grouped[k].abo.reduce((s,x)=>s+Number(x.abono),0));

  chartBar = new Chart(chartBarCanvas,{
    type:"bar",
    data:{labels:keys, datasets:[
      {label:"Facturas", data:dataF, backgroundColor:"#0984e3"},
      {label:"Abonos", data:dataA, backgroundColor:"#00b894"}
    ]}
  });

  let totF = dataF.reduce((a,b)=>a+b,0);
  let totA = dataA.reduce((a,b)=>a+b,0);

  chartDonut = new Chart(chartDonutCanvas,{
    type:"doughnut",
    data:{labels:["Facturas","Abonos"], datasets:[{data:[totF,totA], backgroundColor:["#0984e3","#00b894"]}]}
  });
}

/* VER SOLO UNA FACTURA */
async function verFactura(num){
  const snap = await db.collection(COLECCION)
        .where("nit","==",currentModalNit)
        .where("numFactura","==",num)
        .get();
  const rows = snap.docs.map(d=>({id:d.id, ...d.data()}));
  rows.forEach(r=>{if(r.fecha?.seconds) r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10);});
  renderDetalle(rows);
}

/* CERRAR MODAL */
function cerrarModal(){
  modalBackdrop.style.display="none";
  grouped={};
  if(chartBar) chartBar.destroy();
  if(chartDonut) chartDonut.destroy();
}

/* EXPORTAR */
function exportarExcel(){
  const q = buscar.value.trim().toLowerCase();
  const out = registros.filter(r=>
     r.nit.toLowerCase().includes(q) ||
     r.nombre.toLowerCase().includes(q) ||
     r.numFactura.toLowerCase().includes(q)
  ).map(r=>({
    NIT:r.nit, Nombre:r.nombre,
    "Factura":r.numFactura,
    Valor:r.valor, Abono:r.abono,
    "Saldo":r.valor-r.abono,
    Fecha:r.fecha
  }));
  let ws = XLSX.utils.json_to_sheet(out);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Reporte");
  XLSX.writeFile(wb,"Fabricantes.xlsx");
}
</script>

</body>
</html>
