<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>La Zapater√≠a ‚Äî Facturas de Fabricantes (Final)</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

<!-- SheetJS para exportar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Chart.js para gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f4f7fb; --card:#fff; --accent:#0984e3; --muted:#6b7280; --danger:#d63031;
}
*{box-sizing:border-box}
body{font-family:Inter, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:#111}
.topbar{
  background:linear-gradient(90deg,#2d3436,#1e272e); color:white; padding:12px 18px; display:flex; justify-content:space-between; align-items:center;
}
.topbar .left{display:flex; gap:12px; align-items:center}
.btn-back{background:transparent; color:white; border:none; font-size:18px; cursor:pointer}
.topbar .right{display:flex; gap:12px; align-items:center}
.badge{background:rgba(255,255,255,0.06); padding:6px 10px; border-radius:8px; font-size:13px}
.btn-logout{background:#d63031;color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
.toggle-dark{background:#222;color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}

.container{max-width:1200px;margin:18px auto;padding:14px;display:flex;gap:18px}
.panel{background:var(--card); border-radius:10px; padding:16px; box-shadow:0 8px 24px rgba(16,24,40,0.06)}
.left{width:320px}
.right{flex:1; min-width:0}

h2{margin:6px 0 12px;color:#222;font-size:18px}
label{font-size:13px;color:var(--muted);display:block;margin-top:8px}
input[type="text"], input[type="date"], input[type="number"], select{
  width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #e6eef5; font-size:14px;
}
.checkbox{display:flex; align-items:center; gap:8px; margin-top:8px; font-size:14px}

.btn{padding:10px 12px; border-radius:8px; border:none; cursor:pointer;}
.btn-primary{background:var(--accent); color:white; width:100%}
.btn-secondary{background:#2d3436;color:white;width:100%}
.btn-excel{background:#27ae60;color:white}
.muted{color:var(--muted); font-size:13px}

.search-row{display:flex; gap:10px; margin-bottom:8px; align-items:center}
.table-wrap{overflow:auto; max-height:520px; border-radius:8px; border:1px solid #eef3f6}
table{width:100%; border-collapse:collapse; font-size:14px}
th, td{padding:8px 10px; border-bottom:1px solid #f2f5f7; text-align:left}
th{background:#f7fafc; font-weight:700}
.name-link{color:var(--accent); cursor:pointer; text-decoration:underline}

.footer-stats{display:flex; justify-content:space-between; margin-top:8px; align-items:center}

/* modal */
.modal-back{position:fixed; inset:0; display:none; background:rgba(0,0,0,0.45); justify-content:center; align-items:flex-start; padding-top:48px; z-index:80}
.modal{background:white; width:94%; max-width:980px; border-radius:12px; padding:16px; max-height:84vh; overflow:auto}
.modal .row{display:flex; gap:10px}
.small{flex:1}
.editor-row{display:none; margin-top:12px; border-top:1px dashed #eef2f4; padding-top:12px}

/* dark mode */
body.dark{background:#121217; color:#e8e8e8}
body.dark .panel{background:#15161a}
body.dark .topbar{background:#0d0f11}
body.dark input, body.dark select{background:#0f1113; border:1px solid #222; color:#ddd}
body.dark th{background:#0b0c0e}
body.dark table, body.dark td{border-color:#17181a}
</style>
</head>
<body>

<div class="topbar">
  <div class="left">
    <button class="btn-back" onclick="location.href='https://userlink2024.github.io/lazapateria/paneldecuentas.html'">‚Üê Atr√°s</button>
    <div style="font-weight:600">La Zapater√≠a ‚Äî Facturas de Fabricantes</div>
  </div>
  <div class="right">
    <div id="user-info" class="badge">Cargando...</div>
    <button class="toggle-dark" id="toggleDark">üåô</button>
    <button id="logout" class="btn-logout">Cerrar sesi√≥n</button>
  </div>
</div>

<div class="container">
  <!-- LEFT: FORM -->
  <div class="panel left">
    <h2>Formulario de factura / abono</h2>

    <label>Fecha</label>
    <input type="date" id="fecha">

    <label>NIT</label>
    <input type="text" id="nit" placeholder="Ej: 3014428937">

    <label>Nombre fabricante</label>
    <input type="text" id="nombre" placeholder="Ej: FABISA">

    <label>N¬∞ Factura</label>
    <input type="text" id="numFactura">

    <label>Valor</label>
    <input type="number" id="valor" value="0">

    <label>Abono (ABONO GENERAL)</label>
    <input type="number" id="abono" value="0">

    <label class="checkbox"><input type="checkbox" id="soloAbonar"> Solo abonar (ABONO GENERAL)</label>

    <button class="btn btn-primary" id="btnGuardar">GUARDAR (Factura o Abono)</button>
    <button class="btn btn-secondary" id="btnLimpiar" style="margin-top:8px">Limpiar formulario</button>

    <p class="muted" style="margin-top:12px">Cada abono crea un documento independiente. El saldo se calcula como suma(VALOR) - suma(ABONO).</p>
  </div>

  <!-- RIGHT: LIST -->
  <div class="panel right">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h2 style="margin:0">Buscar / Lista</h2>
        <div class="muted">Doble clic ‚Üí historial (agrupado por factura)</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Total deuda general</div>
        <div id="totalGeneral" style="font-weight:700; font-size:18px">$0</div>
      </div>
    </div>

    <div class="search-row" style="margin-top:12px">
      <input type="text" id="buscar" placeholder="Buscar NIT o nombre..." style="flex:1" oninput="filtrar()">
      <button class="btn btn-excel" onclick="exportarExcel()">Exportar Excel</button>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table>
        <thead>
          <tr>
            <th>NIT</th><th>Nombre</th><th>N¬∞ Factura</th><th>Valor</th><th>Abono</th><th>Saldo</th><th>Fecha</th><th>Tipo</th>
          </tr>
        </thead>
        <tbody id="tablaFabricantes"></tbody>
      </table>
    </div>

    <div class="footer-stats">
      <div class="muted">Registros: <span id="countRegs">0</span></div>
      <div class="muted">Deuda filtro: <strong id="deudaFiltro">$0</strong></div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modalBackdrop" class="modal-back">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h3 id="modalTitle" style="margin:0">Historial</h3>
        <div class="muted">NIT: <span id="modalNit"></span></div>
      </div>
      <div>
        <button class="btn btn-secondary" onclick="cerrarModal()">Cerrar</button>
      </div>
    </div>

    <div style="display:flex; gap:12px; margin-top:12px;">
      <div style="flex:1">
        <table style="width:100%;">
          <thead>
            <tr><th>#</th><th>N¬∞ Factura</th><th>Total Factura</th><th>Total Abonos</th><th>Saldo</th><th>Acciones</th></tr>
          </thead>
          <tbody id="modalSummary"></tbody>
        </table>
      </div>

      <div style="width:340px; background:#fafbfd; padding:8px; border-radius:8px">
        <canvas id="chartBar" style="width:100%;height:180px"></canvas>
        <canvas id="chartDonut" style="width:100%;height:160px;margin-top:8px"></canvas>
        <div style="margin-top:8px; text-align:right; font-weight:700">Total deuda: <span id="modalTotal">$0</span></div>
      </div>
    </div>

    <!-- detalle (facturas y abonos) -->
    <div id="detalleList" style="margin-top:12px"></div>

    <!-- editor inline -->
    <div id="editorPanel" class="editor-row">
      <h4 style="margin:6px 0">Editar documento</h4>
      <div class="row">
        <input id="edit_numFactura" class="small" placeholder="N¬∞ Factura">
        <input id="edit_valor" class="small" type="number" placeholder="Valor">
      </div>
      <div class="row" style="margin-top:8px">
        <input id="edit_abono" class="small" type="number" placeholder="Abono">
        <input id="edit_fecha" class="small" type="date">
      </div>
      <div style="margin-top:8px; display:flex; gap:8px">
        <button class="btn btn-primary" id="saveEditBtn">Guardar cambios</button>
        <button class="btn btn-secondary" onclick="cancelEdit()">Cancelar</button>
      </div>
    </div>

  </div>
</div>

<script>
/* ========== FIREBASE ========== */
const firebaseConfig = {
  apiKey:"AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
  authDomain:"lazapateria-c4157.firebaseapp.com",
  projectId:"lazapateria-c4157",
  storageBucket:"lazapateria-c4157.firebasestorage.app",
  messagingSenderId:"300241769138",
  appId:"1:300241769138:web:8ca1847de3c4fb5042afab"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const COLECCION = "fabricantes";

/* ========== SESI√ìN ========== */
const usuario = JSON.parse(localStorage.getItem('datosUsuario') || 'null');
if(!usuario){ alert('No hay sesi√≥n activa'); location.href='index.html'; }
if(usuario.permisos !== 'Administrador'){ alert('Acceso denegado. Solo administradores'); location.href='index.html'; }
document.getElementById('user-info').textContent = `${usuario.usuario} ‚Äî ${usuario.permisos}`;
document.getElementById('logout').onclick = ()=>{ localStorage.removeItem('datosUsuario'); location.href='index.html'; };

/* ========== ESTADO ========== */
let registros = []; // todos los docs
let currentModalNit = null;
let grouped = {}; // agrupados por numFactura
let editingDocId = null;
let chartBar = null, chartDonut = null;

/* ========== DARK MODE ========== */
const body = document.body;
const toggleDark = document.getElementById('toggleDark');
if(localStorage.getItem('dark')==='1'){ body.classList.add('dark'); toggleDark.textContent='‚òÄÔ∏è' }
toggleDark.onclick = ()=>{
  body.classList.toggle('dark');
  const on = body.classList.contains('dark');
  toggleDark.textContent = on ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('dark', on? '1':'0');
};

/* ========== CARGAR TODOS ========== */
async function cargarTodos(){
  const snap = await db.collection(COLECCION).orderBy('fecha','desc').get();
  registros = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  // normalizar fecha string
  registros = registros.map(r => {
    if(r.fecha && r.fecha.seconds) r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10);
    return r;
  });
  renderTabla(registros);
  actualizarTotales(registros);
}
cargarTodos();

/* ========== RENDER TABLA PRINCIPAL ========== */
function renderTabla(list){
  const tbody = document.getElementById('tablaFabricantes');
  tbody.innerHTML = '';
  list.forEach(r=>{
    const valor = Number(r.valor||0);
    const abono = Number(r.abono||0);
    const saldo = valor - abono;
    const tipo = valor>0 ? 'Factura' : 'ABONO GENERAL';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.nit||''}</td>
      <td><span class="name-link">${escapeHtml(r.nombre||'')}</span></td>
      <td>${r.numFactura||''}</td>
      <td>$${valor.toLocaleString()}</td>
      <td>$${abono.toLocaleString()}</td>
      <td>$${saldo.toLocaleString()}</td>
      <td>${r.fecha||''}</td>
      <td>${tipo}</td>
    `;
    // double click -> modal
    tr.ondblclick = ()=> openModal(r.nit, r.nombre);
    // click nombre -> autollenar
    tr.querySelector('.name-link').onclick = (e)=>{ e.stopPropagation(); document.getElementById('nit').value = r.nit||''; document.getElementById('nombre').value = r.nombre||''; document.getElementById('numFactura').focus(); };
    tbody.appendChild(tr);
  });
  document.getElementById('countRegs').textContent = list.length;
}

/* ========== FILTRAR ========== */
function filtrar(){
  const q = document.getElementById('buscar').value.trim().toLowerCase();
  const out = registros.filter(r=>{
    return (!q) || ( (r.nit||'').toLowerCase().includes(q) || (r.nombre||'').toLowerCase().includes(q) || (r.numFactura||'').toLowerCase().includes(q) );
  });
  renderTabla(out);
  actualizarTotales(out);
}

/* ========== TOTALES ========== */
function actualizarTotales(list){
  const totalFact = list.reduce((s,x)=> s + Number(x.valor||0), 0);
  const totalAb = list.reduce((s,x)=> s + Number(x.abono||0), 0);
  document.getElementById('totalGeneral').textContent = '$' + (totalFact - totalAb).toLocaleString();

  // deuda filtro
  document.getElementById('deudaFiltro').textContent = '$' + ((totalFact - totalAb).toLocaleString());
}

/* ========== AUTOLLENAR ========== */
function autollenar(nit, nombre){
  document.getElementById('nit').value = nit;
  document.getElementById('nombre').value = nombre;
  document.getElementById('numFactura').focus();
}

/* ========== SOLO ABONAR ========== */
document.getElementById('soloAbonar').onchange = function(){
  if(this.checked){
    document.getElementById('valor').value = 0;
    document.getElementById('valor').disabled = true;
    document.getElementById('abono').focus();
  } else {
    document.getElementById('valor').disabled = false;
  }
};

/* ========== GUARDAR (Factura o Abono como doc independiente) ========== */
document.getElementById('btnGuardar').onclick = async function(){
  const fecha = document.getElementById('fecha').value || new Date().toISOString().slice(0,10);
  const nit = (document.getElementById('nit').value||'').trim();
  const nombre = (document.getElementById('nombre').value||'').trim();
  const numFactura = (document.getElementById('numFactura').value||'').trim() || '-';
  const valor = Number(document.getElementById('valor').value||0);
  const abono = Number(document.getElementById('abono').value||0);
  const solo = document.getElementById('soloAbonar').checked;

  if(!nit || !nombre){ alert('Completa NIT y Nombre'); return; }

  // Si solo abonar -> creamos documento con abono
  if(solo || abono>0){
    await db.collection(COLECCION).add({ fecha, nit, nombre, numFactura, valor:0, abono: abono, creadoPor: usuario.usuario, creadoEn: new Date() });
  }
  // Si valor > 0 -> crear factura documento
  if(!solo && valor>0){
    await db.collection(COLECCION).add({ fecha, nit, nombre, numFactura, valor: valor, abono: 0, creadoPor: usuario.usuario, creadoEn: new Date() });
  }

  alert('Guardado correctamente');
  limpiarFormulario();
  await cargarTodos();
};

/* limpiar */
document.getElementById('btnLimpiar').onclick = limpiarFormulario;
function limpiarFormulario(){
  document.getElementById('fecha').value = '';
  document.getElementById('nit').value = '';
  document.getElementById('nombre').value = '';
  document.getElementById('numFactura').value = '';
  document.getElementById('valor').value = 0;
  document.getElementById('abono').value = 0;
  document.getElementById('soloAbonar').checked = false;
  document.getElementById('valor').disabled = false;
}

/* ========== MODAL: abrir, agrupar por factura, mostrar resumen y gr√°ficos ========== */
async function openModal(nit, nombre){
  currentModalNit = nit;
  document.getElementById('modalTitle').textContent = `Historial: ${nombre || nit}`;
  document.getElementById('modalNit').textContent = nit;
  document.getElementById('modalBackdrop').style.display = 'flex';
  // traer docs por nit
  const snap = await db.collection(COLECCION).where('nit','==',nit).orderBy('fecha','desc').get();
  const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  // normalizar fecha
  rows.forEach(r=> { if(r.fecha && r.fecha.seconds) r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10); });

  // agrupar por numFactura
  grouped = {};
  rows.forEach(r=>{
    const key = r.numFactura || '__sin__';
    if(!grouped[key]) grouped[key] = { numFactura: key, facturas: [], abonos: [], docs: [] };
    grouped[key].docs.push(r);
    if(Number(r.valor||0) > 0) grouped[key].facturas.push(r);
    if(Number(r.abono||0) > 0) grouped[key].abonos.push(r);
  });

  renderModalSummaryAndCharts();
  renderDetalleRows(rows);
}

/* render resumen (tabla agrupada) y generar gr√°ficos */
function renderModalSummaryAndCharts(){
  const tbody = document.getElementById('modalSummary'); tbody.innerHTML = '';
  let totalFact = 0, totalAb = 0;
  const keys = Object.keys(grouped);
  keys.forEach((k,i)=>{
    const g = grouped[k];
    const sumFact = g.facturas.reduce((s,x)=> s + Number(x.valor||0), 0);
    const sumAb = g.abonos.reduce((s,x)=> s + Number(x.abono||0), 0);
    const saldo = sumFact - sumAb;
    totalFact += sumFact; totalAb += sumAb;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${escapeHtml(g.numFactura)}</td>
      <td>$${sumFact.toLocaleString()}</td>
      <td>$${sumAb.toLocaleString()}</td>
      <td>$${saldo.toLocaleString()}</td>
      <td><button class="btn" onclick="mostrarDetalles('${escapeForJs(g.numFactura)}')">Ver</button></td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('modalTotal').textContent = '$' + (totalFact - totalAb).toLocaleString();

  // charts: barra (facturas vs abonos por factura)
  const labels = keys.map(k=> k);
  const dataFact = keys.map(k=> grouped[k].facturas.reduce((s,x)=> s + Number(x.valor||0),0));
  const dataAbonos = keys.map(k=> grouped[k].abonos.reduce((s,x)=> s + Number(x.abono||0),0));
  renderCharts(labels, dataFact, dataAbonos, totalFact, totalAb);
}

/* render detalle (lista doc) */
function renderDetalleRows(rows){
  const cont = document.getElementById('detalleList');
  cont.innerHTML = `<h4 style="margin:8px 0">Detalles (facturas y abonos)</h4>`;
  let html = `<table style="width:100%; border-collapse:collapse;"><thead><tr><th>#</th><th>Tipo</th><th>N¬∞ Factura</th><th>Valor</th><th>Abono</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody>`;
  rows.forEach((r,i)=>{
    const tipo = Number(r.valor||0) > 0 ? 'Factura' : 'ABONO GENERAL';
    html += `<tr><td>${i+1}</td><td>${tipo}</td><td>${r.numFactura||''}</td><td>$${Number(r.valor||0).toLocaleString()}</td><td>$${Number(r.abono||0).toLocaleString()}</td><td>${r.fecha||''}</td>
      <td>
        <button class="btn" onclick="startEdit('${r.id}')">Editar</button>
        <button class="btn" style="background:${'#d63031'}; color:#fff" onclick="confirmDelete('${r.id}')">Eliminar</button>
      </td></tr>`;
  });
  html += `</tbody></table>`;
  cont.innerHTML += html;
}

/* mostrar solo los docs de una factura (bot√≥n ver) */
async function mostrarDetalles(numFactura){
  const snap = await db.collection(COLECCION).where('nit','==',currentModalNit).where('numFactura','==',numFactura).orderBy('fecha','desc').get();
  const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  rows.forEach(r=>{ if(r.fecha && r.fecha.seconds) r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10); });
  renderDetalleRows(rows);
}

/* ========== GR√ÅFICOS ========== */
function renderCharts(labels, dataFact, dataAbonos, totalFact, totalAb){
  // destroy previous
  if(chartBar) chartBar.destroy();
  if(chartDonut) chartDonut.destroy();

  const ctxBar = document.getElementById('chartBar').getContext('2d');
  chartBar = new Chart(ctxBar, {
    type:'bar',
    data:{
      labels,
      datasets:[
        { label:'Facturas', data: dataFact, backgroundColor:'#0984e3' },
        { label:'Abonos', data: dataAbonos, backgroundColor:'#00b894' }
      ]
    },
    options:{ responsive:true, plugins:{legend:{position:'bottom'}} }
  });

  const ctxDonut = document.getElementById('chartDonut').getContext('2d');
  chartDonut = new Chart(ctxDonut, {
    type:'doughnut',
    data:{
      labels:['Facturas','Abonos'],
      datasets:[{ data:[totalFact || 0, totalAb || 0], backgroundColor:['#0984e3','#00b894'] }]
    },
    options:{ responsive:true, plugins:{legend:{position:'bottom'}} }
  });
}

/* ========== EDIT INLINE ========== */
function startEdit(docId){
  editingDocId = docId;
  // find doc in registros (if present) otherwise fetch
  const doc = registros.find(r=> r.id === docId);
  if(doc){
    document.getElementById('edit_numFactura').value = doc.numFactura || '';
    document.getElementById('edit_valor').value = doc.valor || 0;
    document.getElementById('edit_abono').value = doc.abono || 0;
    document.getElementById('edit_fecha').value = doc.fecha || '';
  } else {
    // fetch single doc
    db.collection(COLECCION).doc(docId).get().then(d=>{
      if(d.exists){ const data = d.data();
        document.getElementById('edit_numFactura').value = data.numFactura||'';
        document.getElementById('edit_valor').value = data.valor||0;
        document.getElementById('edit_abono').value = data.abono||0;
        document.getElementById('edit_fecha').value = data.fecha || '';
      }
    });
  }
  document.getElementById('editorPanel').style.display = 'block';
  document.getElementById('editorPanel').scrollIntoView({behavior:'smooth'});
}

document.getElementById('saveEditBtn').onclick = async function(){
  if(!editingDocId) return alert('No hay documento seleccionado');
  const numFactura = document.getElementById('edit_numFactura').value.trim();
  const valor = Number(document.getElementById('edit_valor').value || 0);
  const abono = Number(document.getElementById('edit_abono').value || 0);
  const fecha = document.getElementById('edit_fecha').value || new Date().toISOString().slice(0,10);

  await db.collection(COLECCION).doc(editingDocId).update({ numFactura, valor, abono, fecha });
  alert('Documento actualizado');
  editingDocId = null;
  document.getElementById('editorPanel').style.display = 'none';
  await cargarTodos();
  if(currentModalNit) openModal(currentModalNit, document.getElementById('modalTitle').textContent.replace('Historial: ',''));
};

function cancelEdit(){ editingDocId = null; document.getElementById('editorPanel').style.display = 'none'; }

/* ========== ELIMINAR ========== */
function confirmDelete(docId){
  if(confirm('¬øEliminar este documento?')) {
    db.collection(COLECCION).doc(docId).delete().then(()=>{ alert('Eliminado'); cargarTodos(); if(currentModalNit) openModal(currentModalNit, document.getElementById('modalTitle').textContent.replace('Historial: ','')); });
  }
}

/* ========== CERRAR MODAL ========== */
function cerrarModal(){
  document.getElementById('modalBackdrop').style.display = 'none';
  grouped = {}; currentModalNit = null;
  if(chartBar){ chartBar.destroy(); chartBar = null; }
  if(chartDonut){ chartDonut.destroy(); chartDonut = null; }
}

/* ========== EXPORTAR A EXCEL (FORMATO IGUAL A TU EXCEL) ========== */
function exportarExcel(){
  // Usar la lista actual filtrada
  const q = document.getElementById('buscar').value.trim().toLowerCase();
  const data = registros.filter(r => {
    if(!q) return true;
    return (r.nit||'').toLowerCase().includes(q) || (r.nombre||'').toLowerCase().includes(q) || (r.numFactura||'').toLowerCase().includes(q);
  }).map(r=>({
    NIT: r.nit || '',
    NOMBRE: r.nombre || '',
    "N√öMERO DE FACTURA": r.numFactura || '',
    VALOR: Number(r.valor||0),
    ABONO: Number(r.abono||0),
    "VALOR TOT": Number(r.valor||0) - Number(r.abono||0),
    FECHA: r.fecha || ''
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Fabricantes");
  XLSX.writeFile(wb, "Fabricantes.xlsx");
}

/* ========== UTIL ========== */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeForJs(s){ if(s===undefined||s===null) return ''; return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

/* ========== RECARGAR DATOS PRINCIPALES Y UI ========== */
async function cargarTodos(){
  const snap = await db.collection(COLECCION).orderBy('fecha','desc').get();
  registros = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  registros = registros.map(r=>{ if(r.fecha && r.fecha.seconds) r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10); return r; });
  renderTabla(registros);
  actualizarTotales(registros);
}
window.cargarTodos = cargarTodos;

/* iniciar */
cargarTodos();

</script>
</body>
</html>
