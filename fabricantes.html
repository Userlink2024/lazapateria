<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>La Zapater√≠a ‚Äî Facturas de Fabricantes</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f4f7fb; --card:#fff; --accent:#0984e3; --muted:#6b7280; --danger:#d63031;
}
*{box-sizing:border-box}
body{font-family:Inter, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:#111}

.topbar{
  background:linear-gradient(90deg,#2d3436,#1e272e);
  color:white; padding:12px 18px;
  display:flex; justify-content:space-between; align-items:center;
}
.btn-back{background:none;color:white;border:none;font-size:18px;cursor:pointer}

.panel{background:var(--card); padding:16px; border-radius:10px;
  box-shadow:0 8px 24px rgba(16,24,40,0.06)}

.container{max-width:1200px;margin:18px auto;padding:10px;display:flex;gap:20px}
.left{width:320px}
.right{flex:1}

input,select{
  width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #e6eef5
}

.table-wrap{max-height:520px;overflow:auto;border:1px solid #e6eef5;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid #eef3f6}
th{background:#f7fafc}

.name-link{color:#0984e3;cursor:pointer;text-decoration:underline}

.modal-back{
  position:fixed;inset:0;display:none;background:rgba(0,0,0,0.45);
  justify-content:center;align-items:flex-start;padding-top:50px;z-index:99;
}
.modal{
  background:white;width:94%;max-width:950px;border-radius:12px;
  padding:16px;max-height:85vh;overflow:auto;
}

/* Dark Mode */
body.dark{background:#1e1e1e;color:#e5e5e5}
body.dark .panel{background:#2a2a2a}
body.dark input{background:#222;border-color:#444;color:white}
body.dark th{background:#333}
body.dark td{border-color:#333}
body.dark .table-wrap{border-color:#333}
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <button class="btn-back" onclick="location.href='https://userlink2024.github.io/lazapateria/paneldecuentas.html'">‚Üê Atr√°s</button>
  <div style="font-size:15px;font-weight:600">La Zapater√≠a ‚Äî Facturaci√≥n y Abonos</div>
  <div style="display:flex;gap:10px;align-items:center">
    <div id="user-info" style="background:rgba(255,255,255,0.1);padding:4px 10px;border-radius:6px;font-size:13px;">Cargando...</div>
    <button id="toggleDark" style="background:#0003;color:white;border:none;padding:8px;border-radius:6px;cursor:pointer">üåô</button>
    <button id="logout" style="background:#d63031;color:white;border:none;padding:8px;border-radius:6px;cursor:pointer">Salir</button>
  </div>
</div>

<div class="container">

  <!-- PANEL IZQUIERDO -->
  <div class="panel left">

    <h2>Formulario</h2>

    <!-- BANNER ABONO -->
    <div id="bannerAbono" 
         style="display:none;background:#0984e3;color:white;padding:8px;text-align:center;margin-bottom:10px;border-radius:8px;font-weight:600;">
      MODO ABONO GENERAL
    </div>

    <label>Fecha</label>
    <input id="fecha" type="date">

    <label>NIT</label>
    <input id="nit" type="text">

    <label>Nombre fabricante</label>
    <input id="nombre" type="text">

    <label>N¬∞ Factura</label>
    <input id="numFactura" type="text">

    <label>Valor</label>
    <input id="valor" type="number" value="0">

    <label>Abono (ABONO GENERAL)</label>
    <input id="abono" type="number" value="0">

    <label style="display:flex;gap:8px;align-items:center;margin-top:10px;">
      <input type="checkbox" id="soloAbonar"> Solo abonar (ABONO GENERAL)
    </label>

    <button id="btnGuardar" style="margin-top:12px;width:100%;background:#0984e3;color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;">
      Guardar
    </button>

    <button id="btnLimpiar" style="margin-top:8px;width:100%;background:#2d3436;color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;">
      Limpiar
    </button>

  </div>

  <!-- PANEL DERECHO -->
  <div class="panel right">

    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Lista</h2>
      <div>
        <small>Deuda total:</small><br>
        <strong id="totalGeneral">$0</strong>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:12px;">
      <input id="buscar" type="text" placeholder="Buscar..." oninput="filtrar()" style="flex:1">
      <button onclick="exportarExcel()" style="background:#27ae60;color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;">
        Excel
      </button>
    </div>

    <div class="table-wrap" style="margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>NIT</th><th>Nombre</th><th>Factura</th><th>Valor</th><th>Abono</th><th>Saldo</th><th>Fecha</th><th>Tipo</th>
          </tr>
        </thead>
        <tbody id="tablaFabricantes"></tbody>
      </table>
    </div>

    <div style="margin-top:6px;font-size:13px;display:flex;justify-content:space-between;">
      <span>Registros: <b id="countRegs">0</b></span>
      <span>Deuda filtro: <b id="deudaFiltro">$0</b></span>
    </div>

  </div>

</div>

<!-- MODAL -->
<div id="modalBackdrop" class="modal-back">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <h3 id="modalTitle" style="margin:0"></h3>
        <small>NIT: <span id="modalNit"></span></small>
      </div>
      <button onclick="cerrarModal()" style="background:#2d3436;color:white;border:none;padding:8px;border-radius:6px;cursor:pointer;">Cerrar</button>
    </div>

    <div style="display:flex;gap:12px;margin-top:10px;">

      <div style="flex:1">
        <table style="width:100%;">
          <thead>
            <tr><th>#</th><th>Factura</th><th>Facturas</th><th>Abonos</th><th>Saldo</th><th></th></tr>
          </thead>
          <tbody id="modalSummary"></tbody>
        </table>
      </div>

      <div style="width:300px;padding:8px;background:#f8f8f8;border-radius:10px;">
        <canvas id="chartBar"></canvas>
        <canvas id="chartDonut" style="margin-top:12px"></canvas>
        <div style="margin-top:10px;text-align:right;font-weight:700;font-size:15px;">
          Total: <span id="modalTotal">$0</span>
        </div>
      </div>

    </div>

    <div id="detalleList" style="margin-top:15px;"></div>

  </div>
</div>

<script>
/* =============================================
   FIREBASE
============================================= */
const firebaseConfig = {
  apiKey:"AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
  authDomain:"lazapateria-c4157.firebaseapp.com",
  projectId:"lazapateria-c4157",
  storageBucket:"lazapateria-c4157.firebasestorage.app",
  messagingSenderId:"300241769138",
  appId:"1:300241769138:web:8ca1847de3c4fb5042afab"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const COLECCION = "fabricantes";

/* =============================================
   SESI√ìN
============================================= */
const usuario = JSON.parse(localStorage.getItem("datosUsuario") || "null");
if(!usuario){ alert("No hay sesi√≥n activa"); location.href="index.html"; }
if(usuario.permisos !== "Administrador"){ alert("Acceso denegado"); location.href="index.html"; }

document.getElementById("user-info").textContent = usuario.usuario + " ‚Äî " + usuario.permisos;
document.getElementById("logout").onclick = ()=>{ localStorage.removeItem("datosUsuario"); location.href="index.html"; };

/* =============================================
   DARK MODE
============================================= */
const toggleDark = document.getElementById("toggleDark");
if(localStorage.getItem("dark")==="1"){ document.body.classList.add("dark"); toggleDark.textContent="‚òÄÔ∏è"; }
toggleDark.onclick = ()=>{
  document.body.classList.toggle("dark");
  let on = document.body.classList.contains("dark");
  toggleDark.textContent = on ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("dark", on ? "1":"0");
};

/* =============================================
   VARIABLES
============================================= */
let registros = [];
let currentModalNit = null;
let grouped = {};
let chartBar = null, chartDonut = null;

/* =============================================
   CARGAR TODOS
============================================= */
async function cargarTodos(){
  const snap = await db.collection(COLECCION).get();
  registros = snap.docs.map(d=>({ id:d.id, ...d.data() }));

  registros.forEach(r=>{
    if(r.fecha?.seconds)
      r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10);
  });

  renderTabla(registros);
  actualizarTotales(registros);
}
cargarTodos();

/* =============================================
   RENDER TABLA PRINCIPAL
============================================= */
function renderTabla(list){
  const tbody = document.getElementById("tablaFabricantes");
  tbody.innerHTML = "";

  list.forEach(r=>{
    const valor = Number(r.valor||0);
    const abono = Number(r.abono||0);
    const saldo = valor - abono;
    const tipo = valor>0 ? "Factura" : "ABONO GENERAL";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.nit}</td>
      <td><span class="name-link">${r.nombre}</span></td>
      <td>${r.numFactura}</td>
      <td>$${valor.toLocaleString()}</td>
      <td>$${abono.toLocaleString()}</td>
      <td>$${saldo.toLocaleString()}</td>
      <td>${r.fecha}</td>
      <td>${tipo}</td>
    `;

    tr.ondblclick = ()=> openModal(r.nit,r.nombre);

    tr.querySelector(".name-link").onclick = e=>{
      e.stopPropagation();
      document.getElementById("nit").value = r.nit;
      document.getElementById("nombre").value = r.nombre;
      if(document.getElementById("soloAbonar").checked){
        document.getElementById("numFactura").value = "ABONO";
      }
    };

    tbody.appendChild(tr);
  });

  document.getElementById("countRegs").textContent = list.length;
}

/* =============================================
   FILTRAR
============================================= */
function filtrar(){
  const q = document.getElementById("buscar").value.trim().toLowerCase();
  const out = registros.filter(r =>
    r.nit.toLowerCase().includes(q) ||
    r.nombre.toLowerCase().includes(q) ||
    r.numFactura.toLowerCase().includes(q)
  );
  renderTabla(out);
  actualizarTotales(out);
}

/* =============================================
   TOTALES
============================================= */
function actualizarTotales(list){
  let totF = list.reduce((s,x)=> s + Number(x.valor||0),0);
  let totA = list.reduce((s,x)=> s + Number(x.abono||0),0);
  document.getElementById("totalGeneral").textContent = "$" + (totF - totA).toLocaleString();
  document.getElementById("deudaFiltro").textContent = "$" + (totF - totA).toLocaleString();
}

/* =============================================
   SOLO ABONAR
============================================= */
document.getElementById("soloAbonar").onchange = function(){
  const banner = document.getElementById("bannerAbono");
  const numFactura = document.getElementById("numFactura");
  const valor = document.getElementById("valor");

  if(this.checked){
    banner.style.display="block";
    valor.disabled = true;
    valor.value = 0;

    numFactura.value = "ABONO";
    numFactura.disabled = true;

    document.getElementById("abono").focus();
  }
  else{
    banner.style.display="none";
    valor.disabled = false;

    numFactura.disabled = false;
    numFactura.value = "";
  }
};

/* =============================================
   GUARDAR (CORREGIDO)
============================================= */
document.getElementById("btnGuardar").onclick = async function(){

  const fecha = document.getElementById("fecha").value || new Date().toISOString().slice(0,10);
  const nit = document.getElementById("nit").value.trim();
  const nombre = document.getElementById("nombre").value.trim();
  const numFactura = document.getElementById("numFactura").value.trim() || "-";
  const valor = Number(document.getElementById("valor").value || 0);
  const abono = Number(document.getElementById("abono").value || 0);
  const solo = document.getElementById("soloAbonar").checked;

  if(!nit || !nombre){
    alert("Debes ingresar NIT y NOMBRE.");
    return;
  }

  if(solo){
    if(abono <= 0){
      alert("En modo ABONO GENERAL debes ingresar un abono mayor a 0.");
      return;
    }

    await db.collection(COLECCION).add({
      fecha, nit, nombre,
      numFactura:"ABONO",
      valor:0,
      abono:abono
    });

    alert("Abono guardado.");
  }
  else{
    if(valor <= 0){
      alert("El valor de la factura debe ser mayor a 0.");
      return;
    }

    await db.collection(COLECCION).add({
      fecha, nit, nombre,
      numFactura,
      valor:valor,
      abono:0
    });

    alert("Factura guardada.");
  }

  limpiar();
  cargarTodos();
};

/* =============================================
   LIMPIAR
============================================= */
function limpiar(){
  document.getElementById("fecha").value="";
  document.getElementById("nit").value="";
  document.getElementById("nombre").value="";
  document.getElementById("numFactura").value="";
  document.getElementById("valor").value=0;
  document.getElementById("abono").value=0;
  document.getElementById("soloAbonar").checked=false;

  document.getElementById("bannerAbono").style.display="none";
  document.getElementById("numFactura").disabled=false;
  document.getElementById("valor").disabled=false;
}

/* =============================================
   MODAL
============================================= */
async function openModal(nit,nombre){
  currentModalNit = nit;
  document.getElementById("modalTitle").textContent = "Historial: " + nombre;
  document.getElementById("modalNit").textContent = nit;

  modalBackdrop.style.display="flex";

  const snap = await db.collection(COLECCION)
        .where("nit","==",nit).get();

  if(snap.empty){
    modalSummary.innerHTML="<tr><td colspan='6'>Sin datos</td></tr>";
    modalTotal.textContent="$0";
    return;
  }

  const rows = snap.docs.map(d=>({id:d.id,...d.data()}));

  rows.forEach(r=>{
    if(r.fecha?.seconds)
      r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10);
  });

  grouped = {};
  rows.forEach(r=>{
    let k = r.numFactura || "-";
    if(!grouped[k]) grouped[k] = {fact:[],abo:[]};
    if(r.valor > 0) grouped[k].fact.push(r);
    if(r.abono > 0) grouped[k].abo.push(r);
  });

  renderSummary(rows);
  renderDetalle(rows);
}

/* =============================================
   RESUMEN FACTURA
============================================= */
function renderSummary(rows){
  const tbody = document.getElementById("modalSummary");
  tbody.innerHTML = "";
  let i=1,totalF=0,totalA=0;

  for(const k in grouped){
    const f = grouped[k];
    const sF = f.fact.reduce((s,x)=>s+Number(x.valor),0);
    const sA = f.abo.reduce((s,x)=>s+Number(x.abono),0);
    totalF += sF; totalA += sA;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i++}</td>
      <td>${k}</td>
      <td>$${sF.toLocaleString()}</td>
      <td>$${sA.toLocaleString()}</td>
      <td>$${(sF-sA).toLocaleString()}</td>
      <td><button onclick="verFactura('${k}')">Ver</button></td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById("modalTotal").textContent = "$" + (totalF-totalA).toLocaleString();

  drawCharts(Object.keys(grouped),grouped);
}

/* =============================================
   DETALLES
============================================= */
function renderDetalle(rows){
  let html = `<h4>Detalle de movimientos</h4>
    <table style="width:100%">
      <thead>
        <tr><th>#</th><th>Tipo</th><th>N¬∞ Factura</th><th>Valor</th>
            <th>Abono</th><th>Fecha</th></tr>
      </thead><tbody>`;

  rows.forEach((r,i)=>{
    html += `
      <tr>
        <td>${i+1}</td>
        <td>${r.valor>0 ? "Factura" : "ABONO GENERAL"}</td>
        <td>${r.numFactura}</td>
        <td>$${r.valor.toLocaleString()}</td>
        <td>$${r.abono.toLocaleString()}</td>
        <td>${r.fecha}</td>
      </tr>`;
  });

  html += "</tbody></table>";
  document.getElementById("detalleList").innerHTML = html;
}

/* =============================================
   VER SOLO UNA FACTURA
============================================= */
async function verFactura(num){
  const snap = await db.collection(COLECCION)
    .where("nit","==",currentModalNit)
    .where("numFactura","==",num).get();

  const rows = snap.docs.map(d=>({id:d.id,...d.data()}));

  rows.forEach(r=>{
    if(r.fecha?.seconds)
      r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10);
  });

  renderDetalle(rows);
}

/* =============================================
   GR√ÅFICOS
============================================= */
function drawCharts(keys, grouped){
  if(chartBar) chartBar.destroy();
  if(chartDonut) chartDonut.destroy();

  let f = keys.map(k=> grouped[k].fact.reduce((s,x)=>s+Number(x.valor),0));
  let a = keys.map(k=> grouped[k].abo.reduce((s,x)=>s+Number(x.abono),0));

  chartBar = new Chart(document.getElementById("chartBar"),{
    type:"bar",
    data:{labels:keys,datasets:[
      {label:"Facturas",data:f,backgroundColor:"#0984e3"},
      {label:"Abonos",data:a,backgroundColor:"#00b894"}
    ]}
  });

  chartDonut = new Chart(document.getElementById("chartDonut"),{
    type:"doughnut",
    data:{
      labels:["Facturas","Abonos"],
      datasets:[{data:[f.reduce((a,b)=>a+b,0),a.reduce((a,b)=>a+b,0)],
        backgroundColor:["#0984e3","#00b894"]}]
    }
  });
}

/* =============================================
   CERRAR MODAL
============================================= */
function cerrarModal(){
  document.getElementById("modalBackdrop").style.display="none";
  if(chartBar) chartBar.destroy();
  if(chartDonut) chartDonut.destroy();
}

/* =============================================
   EXPORTAR EXCEL
============================================= */
function exportarExcel(){
  const q = document.getElementById("buscar").value.trim().toLowerCase();

  const data = registros.filter(r=>
    r.nit.toLowerCase().includes(q) ||
    r.nombre.toLowerCase().includes(q) ||
    r.numFactura.toLowerCase().includes(q)
  ).map(r=>({
    NIT:r.nit,
    NOMBRE:r.nombre,
    FACTURA:r.numFactura,
    VALOR:r.valor,
    ABONO:r.abono,
    SALDO:r.valor - r.abono,
    FECHA:r.fecha
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Reporte");
  XLSX.writeFile(wb,"Fabricantes.xlsx");
}
</script>

</body>
</html>
