<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>La Zapater√≠a ‚Äî Cuentas Fabricantes</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

<!-- SheetJS para Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f4f7fb;
  --card:#ffffff;
  --accent:#0984e3;
  --danger:#d63031;
  --muted:#6b7280;
}

*{box-sizing:border-box;}
body{
  margin:0;
  font-family: Inter, Roboto, Arial;
  background:var(--bg);
  color:#111;
}

/* Top bar */
.topbar{
  background:#1e272e;
  color:white;
  padding:12px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.btn-back{
  background:none;
  border:none;
  color:white;
  font-size:18px;
  cursor:pointer;
}

/* Layout */
.container{
  max-width:1300px;
  margin:20px auto;
  padding:10px;
  display:flex;
  gap:20px;
}

.panel{
  background:var(--card);
  padding:16px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
}

.left{width:340px;}
.right{flex:1;}

input{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #dfe6ef;
  margin-top:5px;
  background:white;
}

button{
  cursor:pointer;
}

/* Tabla */
.table-wrap{
  max-height:500px;
  overflow:auto;
  border:1px solid #e2e8f0;
  border-radius:8px;
  margin-top:10px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th{
  background:#f1f5f9;
  padding:8px;
}

td{
  padding:8px;
  border-bottom:1px solid #e2e8f0;
}

.name-link{
  color:#0984e3;
  cursor:pointer;
  text-decoration:underline;
}

/* Banner ABONO */
#bannerAbono{
  display:none;
  background:#0984e3;
  color:white;
  padding:8px;
  text-align:center;
  border-radius:8px;
  margin-bottom:12px;
  font-weight:600;
}

/* Modal */
.modal-back{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:60px;
  z-index:100;
}

.modal{
  background:white;
  padding:20px;
  width:95%;
  max-width:1100px;
  border-radius:12px;
  max-height:85vh;
  overflow:auto;
}

/* Edici√≥n */
.editing-row{
  background:#fff9c4 !important;
}

.btn-small{
  padding:4px 8px;
  border:none;
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
}

.btn-edit{background:#0984e3;color:white;}
.btn-delete{background:#d63031;color:white;}
.btn-save{background:#00b894;color:white;}
.btn-cancel{background:#636e72;color:white;}

/* Dark Mode */
body.dark{
  background:#111;
  color:white;
}

body.dark .panel{background:#1f1f1f;}
body.dark input{background:#111;color:white;border-color:#333;}
body.dark table td{border-color:#333;}
body.dark table th{background:#333;}
body.dark .table-wrap{border-color:#333;}
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <button class="btn-back" onclick="location.href='https://userlink2024.github.io/lazapateria/paneldecuentas.html'">‚Üê Atr√°s</button>
  <div style="font-size:16px;font-weight:600;">La Zapater√≠a ‚Äî Cuentas de Fabricantes</div>

  <div style="display:flex;gap:10px;align-items:center">
    <div id="user-info" style="background:#ffffff22;padding:6px 10px;border-radius:6px;font-size:13px;">
      Cargando...
    </div>

    <button id="toggleDark" style="background:#ffffff22;color:white;border:none;padding:8px;border-radius:6px;">
      üåô
    </button>

    <button id="logout" style="background:#d63031;color:white;border:none;padding:8px 14px;border-radius:6px;">
      Salir
    </button>
  </div>
</div>

<div class="container">

<!-- PANEL IZQUIERDO -->
<div class="panel left">

  <h2>Formulario</h2>

  <div id="bannerAbono">MODO ABONO GENERAL</div>

  <label>Fecha</label>
  <input id="fecha" type="date">

  <label>NIT</label>
  <input id="nit" type="text">

  <label>Nombre fabricante</label>
  <input id="nombre" type="text">

  <label>N¬∞ Factura</label>
  <input id="numFactura" type="text">

  <label>Valor</label>
  <input id="valor" type="number" value="0">

  <label>Abono (ABONO GENERAL)</label>
  <input id="abono" type="number" value="0">

  <label style="margin-top:10px;display:flex;gap:8px;align-items:center;">
    <input id="soloAbonar" type="checkbox"> Solo abonar (ABONO GENERAL)
  </label>

  <button id="btnGuardar" style="width:100%;background:#0984e3;color:white;border:none;padding:10px;border-radius:8px;margin-top:12px;">
    Guardar
  </button>

  <button id="btnLimpiar" style="width:100%;background:#636e72;color:white;border:none;padding:10px;border-radius:8px;margin-top:8px;">
    Limpiar
  </button>

</div>

<!-- PANEL DERECHO -->
<div class="panel right">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="margin:0;">Lista</h2>

    <div>
      <small>Deuda total:</small><br>
      <strong id="totalGeneral">$0</strong>
    </div>
  </div>

  <div style="display:flex;gap:10px;margin-top:12px;">
    <input id="buscar" type="text" placeholder="Buscar..." oninput="filtrar()" style="flex:1">
    <button onclick="exportarExcel()" style="background:#27ae60;color:white;border:none;padding:10px;border-radius:8px;">
      Excel
    </button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>NIT</th>
          <th>Nombre</th>
          <th>Factura</th>
          <th>Valor</th>
          <th>Abono</th>
          <th>Saldo</th>
          <th>Fecha</th>
          <th>Tipo</th>
        </tr>
      </thead>
      <tbody id="tablaFabricantes"></tbody>
    </table>
  </div>

  <div style="margin-top:6px;font-size:13px;display:flex;justify-content:space-between;">
    <span>Registros: <b id="countRegs">0</b></span>
    <span>Deuda filtro: <b id="deudaFiltro">$0</b></span>
  </div>
</div>

</div> <!-- container -->

<!-- MODAL -->
<div id="modalBackdrop" class="modal-back">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <h3 id="modalTitle" style="margin:0;"></h3>
        <small>NIT: <span id="modalNit"></span></small>
      </div>

      <button onclick="cerrarModal()" style="background:#636e72;color:white;border:none;padding:8px 12px;border-radius:6px;">
        Cerrar
      </button>
    </div>

    <div style="display:flex;gap:14px;margin-top:12px;">

      <div style="flex:1;">
        <table style="width:100%;">
          <thead>
            <tr>
              <th>#</th>
              <th>Factura</th>
              <th>Facturas</th>
              <th>Abonos</th>
              <th>Saldo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="modalSummary"></tbody>
        </table>
      </div>

      <div style="width:320px;background:#f1f5f9;padding:10px;border-radius:10px;">
        <canvas id="chartBar"></canvas>
        <canvas id="chartDonut" style="margin-top:14px;"></canvas>

        <div style="margin-top:12px;text-align:right;font-weight:bold;font-size:15px;">
          Total: <span id="modalTotal">$0</span>
        </div>
      </div>

    </div>

    <div id="detalleList" style="margin-top:20px;"></div>
  </div>
</div>

<!-- ========================== -->
<!-- FIN PARTE 1 -->
<!-- ========================== -->
<script>
/* =======================================================
   FIREBASE
======================================================= */
const firebaseConfig = {
  apiKey:"AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
  authDomain:"lazapateria-c4157.firebaseapp.com",
  projectId:"lazapateria-c4157",
  storageBucket:"lazapateria-c4157.firebasestorage.app",
  messagingSenderId:"300241769138",
  appId:"1:300241769138:web:8ca1847de3c4fb5042afab"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const COLECCION = "fabricantes";

/* =======================================================
   SESI√ìN
======================================================= */
const usuario = JSON.parse(localStorage.getItem("datosUsuario") || "null");
if(!usuario){ alert("No hay sesi√≥n activa."); location.href="index.html"; }
if(usuario.permisos !== "Administrador"){ alert("Acceso denegado."); location.href="index.html"; }

document.getElementById("user-info").textContent =
  usuario.usuario + " ‚Äî " + usuario.permisos;

document.getElementById("logout").onclick = ()=>{
  localStorage.removeItem("datosUsuario");
  location.href="index.html";
};

/* =======================================================
   DARK MODE
======================================================= */
const toggleDark = document.getElementById("toggleDark");

if(localStorage.getItem("dark")==="1"){
  document.body.classList.add("dark");
  toggleDark.textContent = "‚òÄÔ∏è";
}

toggleDark.onclick = ()=>{
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  toggleDark.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("dark", isDark ? "1":"0");
};

/* =======================================================
   VARIABLES
======================================================= */
let registros = [];
let currentModalNit = null;
let currentModalNombre = null;
let grouped = {};
let chartBar = null;
let chartDonut = null;

/* =======================================================
   CARGAR TODOS LOS REGISTROS
======================================================= */
async function cargarTodos(){
  const snap = await db.collection(COLECCION).get();
  registros = snap.docs.map(d=>({id:d.id, ...d.data()}));

  registros.forEach(r=>{
    if(r.fecha?.seconds){
      r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10);
    }
  });

  renderTabla(registros);
  actualizarTotales(registros);
}
cargarTodos();

/* =======================================================
   RENDER TABLA PRINCIPAL
======================================================= */
function renderTabla(list){
  const tbody = document.getElementById("tablaFabricantes");
  tbody.innerHTML = "";

  list.forEach(r=>{
    const valor = Number(r.valor||0);
    const abono = Number(r.abono||0);
    const saldo = valor - abono;
    const tipo = valor>0 ? "Factura" : "ABONO GENERAL";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.nit}</td>
      <td><span class="name-link">${r.nombre}</span></td>
      <td>${r.numFactura}</td>
      <td>$${valor.toLocaleString()}</td>
      <td>$${abono.toLocaleString()}</td>
      <td>$${saldo.toLocaleString()}</td>
      <td>${r.fecha}</td>
      <td>${tipo}</td>
    `;

    /* Doble clic ‚Üí modal */
    tr.ondblclick = ()=> openModal(r.nit, r.nombre);

    /* Autollenar formulario al hacer clic en nombre */
    tr.querySelector(".name-link").onclick = e=>{
      e.stopPropagation();
      document.getElementById("nit").value = r.nit;
      document.getElementById("nombre").value = r.nombre;

      if(document.getElementById("soloAbonar").checked){
        document.getElementById("numFactura").value = "ABONO";
      }
    };

    tbody.appendChild(tr);
  });

  document.getElementById("countRegs").textContent = list.length;
}

/* =======================================================
   FILTRAR
======================================================= */
function filtrar(){
  const q = document.getElementById("buscar").value.trim().toLowerCase();

  const out = registros.filter(r =>
    r.nit.toLowerCase().includes(q) ||
    r.nombre.toLowerCase().includes(q) ||
    r.numFactura.toLowerCase().includes(q)
  );

  renderTabla(out);
  actualizarTotales(out);
}

/* =======================================================
   TOTALES
======================================================= */
function actualizarTotales(list){
  let totF = list.reduce((s,x)=> s + Number(x.valor||0), 0);
  let totA = list.reduce((s,x)=> s + Number(x.abono||0), 0);

  document.getElementById("totalGeneral").textContent =
    "$" + (totF-totA).toLocaleString();

  document.getElementById("deudaFiltro").textContent =
    "$" + (totF-totA).toLocaleString();
}

/* =======================================================
   MODO ABONO GENERAL
======================================================= */
document.getElementById("soloAbonar").onchange = function(){
  const banner = document.getElementById("bannerAbono");
  const numFactura = document.getElementById("numFactura");
  const valor = document.getElementById("valor");

  if(this.checked){
    banner.style.display="block";
    valor.disabled = true;
    valor.value = 0;

    numFactura.value = "ABONO";
    numFactura.disabled = true;

    document.getElementById("abono").focus();
  }
  else{
    banner.style.display="none";
    valor.disabled = false;

    numFactura.disabled = false;
    numFactura.value = "";
  }
};

/* =======================================================
   GUARDAR FACTURA / ABONO
======================================================= */
document.getElementById("btnGuardar").onclick = async function(){

  const fecha = document.getElementById("fecha").value || new Date().toISOString().slice(0,10);
  const nit = document.getElementById("nit").value.trim();
  const nombre = document.getElementById("nombre").value.trim();
  const numFactura = document.getElementById("numFactura").value.trim() || "-";
  const valor = Number(document.getElementById("valor").value || 0);
  const abono = Number(document.getElementById("abono").value || 0);
  const solo = document.getElementById("soloAbonar").checked;

  if(!nit || !nombre){
    alert("Debes ingresar NIT y Nombre.");
    return;
  }

  if(solo){
    if(abono <= 0){
      alert("En ABONO GENERAL, el abono debe ser mayor a 0.");
      return;
    }

    await db.collection(COLECCION).add({
      fecha, nit, nombre,
      numFactura:"ABONO",
      valor:0,
      abono:abono
    });

    alert("Abono registrado.");
  }
  else{
    if(valor <= 0){
      alert("El valor de la factura debe ser mayor a 0.");
      return;
    }

    await db.collection(COLECCION).add({
      fecha, nit, nombre,
      numFactura,
      valor:valor,
      abono:0
    });

    alert("Factura registrada.");
  }

  limpiar();
  cargarTodos();
};

/* =======================================================
   LIMPIAR FORMULARIO
======================================================= */
function limpiar(){
  document.getElementById("fecha").value="";
  document.getElementById("nit").value="";
  document.getElementById("nombre").value="";
  document.getElementById("numFactura").value="";
  document.getElementById("valor").value=0;
  document.getElementById("abono").value=0;
  document.getElementById("soloAbonar").checked=false;

  document.getElementById("bannerAbono").style.display="none";
  document.getElementById("numFactura").disabled=false;
  document.getElementById("valor").disabled=false;
}

/* =======================================================
   MODAL ‚Äî ABRIR
======================================================= */
async function openModal(nit, nombre){
  currentModalNit = nit;
  currentModalNombre = nombre;

  document.getElementById("modalTitle").textContent = "Historial: " + nombre;
  document.getElementById("modalNit").textContent = nit;
  modalBackdrop.style.display="flex";

  const snap = await db.collection(COLECCION)
    .where("nit","==",nit).get();

  if(snap.empty){
    document.getElementById("modalSummary").innerHTML =
      "<tr><td colspan='6'>Sin registros</td></tr>";
    document.getElementById("detalleList").innerHTML = "";
    return;
  }

  const rows = snap.docs.map(d=>({id:d.id, ...d.data()}));

  rows.forEach(r=>{
    if(r.fecha?.seconds){
      r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10);
    }
  });

  /* Agrupar facturas/abonos */
  grouped = {};
  rows.forEach(r=>{
    const key = r.numFactura || "-";
    if(!grouped[key]) grouped[key] = {fact:[], abo:[]};

    if(r.valor > 0) grouped[key].fact.push(r);
    if(r.abono > 0) grouped[key].abo.push(r);
  });

  renderSummary(rows);
  renderDetalle(rows);
}

/* =======================================================
   RENDER RESUMEN DEL MODAL
======================================================= */
function renderSummary(rows){
  const tbody = document.getElementById("modalSummary");
  tbody.innerHTML = "";

  let i=1;
  let totalF=0, totalA=0;

  for(const key in grouped){
    const g = grouped[key];
    const sumaF = g.fact.reduce((s,x)=> s + Number(x.valor),0);
    const sumaA = g.abo.reduce((s,x)=> s + Number(x.abono),0);

    totalF += sumaF;
    totalA += sumaA;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i++}</td>
      <td>${key}</td>
      <td>$${sumaF.toLocaleString()}</td>
      <td>$${sumaA.toLocaleString()}</td>
      <td>$${(sumaF-sumaA).toLocaleString()}</td>
      <td>
        <button class='btn-small btn-edit' onclick="editarGrupo('${key}')">Editar</button>
        <button class='btn-small btn-delete' onclick="eliminarGrupo('${key}')">Eliminar</button>
      </td>
    `;

    tbody.appendChild(tr);
  }

  document.getElementById("modalTotal").textContent =
    "$" + (totalF-totalA).toLocaleString();

  drawCharts(Object.keys(grouped), grouped);
}

/* =======================================================
   RENDER DETALLE
======================================================= */
function renderDetalle(rows){
  let html = `
    <h3>Detalle de movimientos</h3>
    <table style='width:100%;border-collapse:collapse;'>
      <thead>
        <tr>
          <th>#</th>
          <th>Tipo</th>
          <th>N¬∞ Factura</th>
          <th>Valor</th>
          <th>Abono</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
  `;

  rows.forEach((r,i)=>{
    html += `
      <tr>
        <td>${i+1}</td>
        <td>${r.valor>0 ? "Factura" : "ABONO GENERAL"}</td>
        <td>${r.numFactura}</td>
        <td>$${r.valor.toLocaleString()}</td>
        <td>$${r.abono.toLocaleString()}</td>
        <td>${r.fecha}</td>
        <td>
          <button class="btn-small btn-edit" onclick="editarDocumento('${r.id}')">Editar</button>
          <button class="btn-small btn-delete" onclick="eliminarDocumento('${r.id}')">Eliminar</button>
        </td>
      </tr>`;
  });

  html += "</tbody></table>";

  document.getElementById("detalleList").innerHTML = html;
}

/* =======================================================
   GR√ÅFICOS
======================================================= */
function drawCharts(keys, grouped){
  if(chartBar) chartBar.destroy();
  if(chartDonut) chartDonut.destroy();

  let f = keys.map(k => grouped[k].fact.reduce((s,x)=> s+Number(x.valor),0));
  let a = keys.map(k => grouped[k].abo.reduce((s,x)=> s+Number(x.abono),0));

  /* BARRAS */
  chartBar = new Chart(document.getElementById("chartBar"),{
    type: "bar",
    data:{
      labels:keys,
      datasets:[
        { label:"Facturas", data:f, backgroundColor:"#0984e3" },
        { label:"Abonos", data:a, backgroundColor:"#00b894" }
      ]
    }
  });

  /* DONUT */
  chartDonut = new Chart(document.getElementById("chartDonut"),{
    type:"doughnut",
    data:{
      labels:["Facturas","Abonos"],
      datasets:[
        {
          data:[
            f.reduce((s,x)=>s+x,0),
            a.reduce((s,x)=>s+x,0)
          ],
          backgroundColor:["#0984e3","#00b894"]
        }
      ]
    }
  });
}

/* =======================================================
   CERRAR MODAL
======================================================= */
function cerrarModal(){
  modalBackdrop.style.display="none";
  if(chartBar) chartBar.destroy();
  if(chartDonut) chartDonut.destroy();
}

/* =======================================================
   EXPORTAR EXCEL
======================================================= */
function exportarExcel(){

  const q = document.getElementById("buscar").value.trim().toLowerCase();

  const data = registros.filter(r =>
    r.nit.toLowerCase().includes(q) ||
    r.nombre.toLowerCase().includes(q) ||
    r.numFactura.toLowerCase().includes(q)
  ).map(r=>({
    NIT:r.nit,
    NOMBRE:r.nombre,
    FACTURA:r.numFactura,
    VALOR:r.valor,
    ABONO:r.abono,
    SALDO:r.valor - r.abono,
    FECHA:r.fecha
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Reporte");

  XLSX.writeFile(wb,"Fabricantes.xlsx");
}
</script>
/* =======================================================
    =====================  PARTE 3  ======================
          SISTEMA DE EDICI√ìN COMPLETO
======================================================= */

/* =======================================================
   VARIABLES DE EDICI√ìN
======================================================= */
let editandoGrupo = null;     // factura y sus abonos
let editandoDocumento = null; // un documento individual

/* =======================================================
   INICIAR EDICI√ìN DE UNA FACTURA COMPLETA (GRUPO)
======================================================= */
function editarGrupo(numFactura){
  editandoGrupo = numFactura;
  editandoDocumento = null;

  // Marcar fila en amarillo
  document.querySelectorAll("#modalSummary tr").forEach(tr=>{
    if(tr.children[1].textContent === numFactura){
      tr.classList.add("editing-row");
      tr.children[5].innerHTML = `
        <button class="btn-small btn-save" onclick="guardarGrupo('${numFactura}')">Guardar</button>
        <button class="btn-small btn-cancel" onclick="cancelarEdicion()">Cancelar</button>
      `;
    }
  });

  // Cargar datos en el formulario izquierdo usando la factura principal
  const facturaPrincipal = registros.find(r => r.numFactura === numFactura && r.valor > 0);

  if(facturaPrincipal){
    document.getElementById("nit").value = facturaPrincipal.nit;
    document.getElementById("nombre").value = facturaPrincipal.nombre;
    document.getElementById("numFactura").value = facturaPrincipal.numFactura;
    document.getElementById("valor").value = facturaPrincipal.valor;
    document.getElementById("abono").value = 0;
    document.getElementById("soloAbonar").checked = false;
    document.getElementById("bannerAbono").style.display = "none";
  }

  alert("Editando factura principal. Modifica en el formulario y presiona GUARDAR.");
}

/* =======================================================
   GUARDAR CAMBIOS DE FACTURA COMPLETA
======================================================= */
async function guardarGrupo(numFactura){

  const fecha = document.getElementById("fecha").value || new Date().toISOString().slice(0,10);
  const nit = document.getElementById("nit").value.trim();
  const nombre = document.getElementById("nombre").value.trim();
  const nuevoNum = document.getElementById("numFactura").value.trim();
  const valor = Number(document.getElementById("valor").value || 0);

  if(!nit || !nombre){
    alert("Debes ingresar NIT y Nombre.");
    return;
  }

  if(valor <= 0){
    alert("El valor de una factura debe ser mayor a 0.");
    return;
  }

  // Buscar la factura principal
  const snap = await db.collection(COLECCION)
    .where("nit","==",currentModalNit)
    .where("numFactura","==",numFactura)
    .where("valor",">",0)
    .get();

  if(snap.empty){
    alert("No se encontr√≥ la factura principal.");
    return;
  }

  const docId = snap.docs[0].id;

  await db.collection(COLECCION).doc(docId).update({
    fecha, nit, nombre,
    numFactura: nuevoNum,
    valor
  });

  alert("Factura actualizada correctamente.");

  editandoGrupo = null;
  cerrarModal();
  cargarTodos();
  openModal(nit, nombre);
}

/* =======================================================
   CANCELAR EDICI√ìN GENERAL
======================================================= */
function cancelarEdicion(){
  editandoGrupo = null;
  editandoDocumento = null;

  document.querySelectorAll("#modalSummary tr").forEach(tr=>{
    tr.classList.remove("editing-row");
  });

  cerrarModal();
  openModal(currentModalNit, currentModalNombre);
}

/* =======================================================
   ELIMINAR GRUPO COMPLETO (FACTURA + ABONOS)
======================================================= */
async function eliminarGrupo(numFactura){
  if(!confirm("¬øEliminar ESTA factura y TODOS sus abonos?")) return;

  const snap = await db.collection(COLECCION)
      .where("nit","==",currentModalNit)
      .where("numFactura","==",numFactura)
      .get();

  const batch = db.batch();
  snap.docs.forEach(d => batch.delete(d.ref));
  await batch.commit();

  alert("Factura y abonos eliminados.");

  cerrarModal();
  cargarTodos();
  openModal(currentModalNit, currentModalNombre);
}

/* =======================================================
   EDITAR DOCUMENTO INDIVIDUAL (Factura o Abono)
======================================================= */
async function editarDocumento(id){
  editandoDocumento = id;
  editandoGrupo = null;

  const doc = registros.find(r => r.id === id);
  if(!doc){
    alert("Documento no encontrado.");
    return;
  }

  // Marcar visualmente el documento en el detalle
  document.querySelectorAll("#detalleList tr").forEach(tr=>{
    if(tr.children[0].textContent === (Number(doc.index)+1+"")){
      tr.classList.add("editing-row");
    }
  });

  // Cargar al formulario
  document.getElementById("nit").value = doc.nit;
  document.getElementById("nombre").value = doc.nombre;
  document.getElementById("numFactura").value = doc.numFactura;
  document.getElementById("fecha").value = doc.fecha;

  if(doc.valor > 0){
    // Es FACTURA
    document.getElementById("valor").disabled = false;
    document.getElementById("valor").value = doc.valor;

    document.getElementById("abono").value = 0;
    document.getElementById("soloAbonar").checked = false;
  }else{
    // Es ABONO
    document.getElementById("soloAbonar").checked = true;
    document.getElementById("bannerAbono").style.display="block";

    document.getElementById("numFactura").value = "ABONO";
    document.getElementById("numFactura").disabled = true;

    document.getElementById("valor").value = 0;
    document.getElementById("valor").disabled = true;

    document.getElementById("abono").value = doc.abono;
  }

  // Cambiar bot√≥n guardar ‚Üí guardar individual
  document.getElementById("btnGuardar").textContent = "Guardar Edici√≥n";
  document.getElementById("btnGuardar").onclick = ()=> guardarDocumento(id);

  alert("Editando registro individual. Haz cambios y presiona GUARDAR.");
}

/* =======================================================
   GUARDAR CAMBIOS DE DOCUMENTO INDIVIDUAL
======================================================= */
async function guardarDocumento(id){
  const fecha = document.getElementById("fecha").value || new Date().toISOString().slice(0,10);
  const nit = document.getElementById("nit").value.trim();
  const nombre = document.getElementById("nombre").value.trim();
  const numFactura = document.getElementById("numFactura").value.trim();
  const valor = Number(document.getElementById("valor").value || 0);
  const abono = Number(document.getElementById("abono").value || 0);
  const solo = document.getElementById("soloAbonar").checked;

  if(!nit || !nombre){
    alert("Debes ingresar NIT y Nombre.");
    return;
  }

  if(solo){
    if(abono <= 0){
      alert("El abono debe ser mayor a 0.");
      return;
    }

    await db.collection(COLECCION).doc(id).update({
      fecha, nit, nombre,
      numFactura:"ABONO",
      valor:0,
      abono
    });

    alert("Abono actualizado.");
  }
  else{
    if(valor <= 0){
      alert("El valor de una factura debe ser mayor a 0.");
      return;
    }

    await db.collection(COLECCION).doc(id).update({
      fecha, nit, nombre,
      numFactura,
      valor,
      abono:0
    });

    alert("Factura actualizada.");
  }

  // Restaurar bot√≥n
  document.getElementById("btnGuardar").textContent = "Guardar";
  document.getElementById("btnGuardar").onclick = guardar;

  editarDocumento = null;

  limpiar();
  cerrarModal();
  cargarTodos();
  openModal(nit, nombre);
}

/* =======================================================
   ELIMINAR DOCUMENTO INDIVIDUAL
======================================================= */
async function eliminarDocumento(id){
  if(!confirm("¬øEliminar este registro?")) return;

  await db.collection(COLECCION).doc(id).delete();

  alert("Registro eliminado.");

  cerrarModal();
  cargarTodos();
  openModal(currentModalNit, currentModalNombre);
}

/* =======================================================
   =======================================================
   FIN PARTE 3
   =======================================================
======================================================= */
</script>
</body>
</html>
