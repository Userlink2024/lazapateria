<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>La Zapater√≠a ‚Äî Facturas de Fabricantes</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

<!-- SheetJS para exportar a Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    background:#f0f2f5;
    margin:0;
}
header{
    background:#2d3436;
    padding:15px;
    color:white;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
header .back{
    cursor:pointer;
    font-size:20px;
    margin-right:20px;
}
.main{
    display:flex;
    padding:20px;
    gap:25px;
}
.card{
    background:white;
    padding:20px;
    border-radius:8px;
    box-shadow:0 3px 10px rgba(0,0,0,0.1);
}
.left{ width:30%; }
.right{ width:70%; }

input, select{
    width:100%;
    padding:10px;
    margin-top:5px;
    margin-bottom:15px;
    border:1px solid #ccc;
    border-radius:6px;
}
button{
    padding:10px 15px;
    border:none;
    border-radius:5px;
    cursor:pointer;
}
.btn-main{
    width:100%;
    background:#0984e3;
    color:white;
}
.btn-clean{
    width:100%;
    background:#636e72;
    color:white;
}
.btn-excel{
    background:#27ae60;
    color:white;
}
.btn-close{
    background:#d63031;
    color:white;
    float:right;
}

/* Tabla */
table{
    width:100%;
    border-collapse:collapse;
}
th, td{
    padding:8px;
    border-bottom:1px solid #ddd;
    font-size:14px;
}
th{
    background:#dfe6e9;
    font-weight:bold;
}

/* Modal */
#modalHistorial{
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.5);
    display:none;
    justify-content:center;
    align-items:center;
}
.modal-content{
    background:white;
    width:80%;
    padding:20px;
    border-radius:10px;
}
</style>
</head>
<body>

<header>
    <div class="back" onclick="location.href='https://userlink2024.github.io/lazapateria/paneldecuentas.html'">
        ‚Üê Atr√°s
    </div>
    <div>
        <span id="user-info"></span>
        <button id="logout" class="btn-close">Cerrar sesi√≥n</button>
    </div>
</header>

<div class="main">

    <!-- ========================== FORMULARIO ============================== -->
    <div class="card left">
        <h2>Formulario de factura / abono</h2>

        <label>Fecha</label>
        <input type="date" id="fecha">

        <label>NIT</label>
        <input type="text" id="nit" placeholder="Ej: 3014428937">

        <label>Nombre fabricante</label>
        <input type="text" id="nombre" placeholder="Ej: FABISA">

        <label>N¬∞ Factura</label>
        <input type="text" id="numFactura">

        <label>Valor</label>
        <input type="number" id="valor" value="0">

        <label>Abono (si es abono general)</label>
        <input type="number" id="abono" value="0">

        <label>
            <input type="checkbox" id="soloAbonar"> Solo abonar (ABONO GENERAL)
        </label>

        <button class="btn-main" onclick="guardarFactura()">GUARDAR (Factura o Abono)</button>
        <button class="btn-clean" onclick="limpiar()">Limpiar formulario</button>
    </div>

    <!-- ========================== LISTA ============================== -->
    <div class="card right">
        <h2>Buscar / Lista</h2>

        <input type="text" id="buscar" placeholder="Buscar NIT o nombre..." onkeyup="filtrar()">
        <button class="btn-excel" onclick="exportarExcel()">Exportar a Excel</button>

        <div id="totalGeneral" style="text-align:right; margin-top:10px; font-size:20px; font-weight:bold;"></div>

        <table>
            <thead>
                <tr>
                    <th>NIT</th>
                    <th>Nombre</th>
                    <th>N¬∞ Factura</th>
                    <th>Valor</th>
                    <th>Abono</th>
                    <th>Saldo</th>
                    <th>Fecha</th>
                    <th>Tipo</th>
                </tr>
            </thead>
            <tbody id="tablaFabricantes"></tbody>
        </table>
    </div>

</div>

<!-- ========================== MODAL ============================== -->
<div id="modalHistorial">
    <div class="modal-content">
        <h3>Historial: <span id="modalNombre"></span></h3>
        <p>NIT: <span id="modalNit"></span></p>
        <button class="btn-close" onclick="cerrarModal()">Cerrar</button>

        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>N¬∞ Factura</th>
                    <th>Total Factura</th>
                    <th>Total Abonos</th>
                    <th>Saldo</th>
                    <th>Detalles</th>
                </tr>
            </thead>
            <tbody id="tablaModal"></tbody>
        </table>

        <p style="text-align:right; font-size:20px; font-weight:bold;">
            Total deuda del fabricante: <span id="totalFabricante"></span>
        </p>
    </div>
</div>

<!-- ========================== FIREBASE Y L√ìGICA ============================== -->
<script>
// üî• FIREBASE CONFIG
const firebaseConfig = {
    apiKey:"AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
    authDomain:"lazapateria-c4157.firebaseapp.com",
    projectId:"lazapateria-c4157",
    storageBucket:"lazapateria-c4157.firebasestorage.app",
    messagingSenderId:"300241769138",
    appId:"1:300241769138:web:8ca1847de3c4fb5042afab"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();


// ====================== SESI√ìN Y PERMISOS ======================
const usuario = JSON.parse(localStorage.getItem("datosUsuario") || "null");

if (!usuario){
    alert("No hay sesi√≥n activa");
    location.href = "index.html";
}
if(usuario.permisos !== "Administrador"){
    alert("Acceso solo para administradores");
    location.href = "index.html";
}

document.getElementById("user-info").textContent =
    `${usuario.usuario} ‚Äî ${usuario.permisos}`;

document.getElementById("logout").onclick = ()=>{
    localStorage.removeItem("datosUsuario");
    location.href = "index.html";
};



// ====================== CARGAR LISTA ======================
let fabricantes = [];

async function cargar(){
    const snap = await db.collection("fabricantes")
        .orderBy("fecha", "desc")
        .get();

    fabricantes = snap.docs.map(d=>({ id:d.id, ...d.data() }));

    renderTabla(fabricantes);
    calcularTotalGeneral();
}

function renderTabla(lista){
    const tbody = document.getElementById("tablaFabricantes");
    tbody.innerHTML = "";

    lista.forEach(doc=>{
        const saldo = doc.valor - doc.abono;
        const tipo = (doc.valor > 0) ? "Factura" : "ABONO GENERAL";

        tbody.innerHTML += `
        <tr ondblclick="abrirModal('${doc.nit}','${doc.nombre}')">
            <td>${doc.nit}</td>
            <td onclick="autollenar('${doc.nit}','${doc.nombre}')" style="cursor:pointer; color:#0984e3;">
                ${doc.nombre}
            </td>
            <td>${doc.numFactura}</td>
            <td>$${Number(doc.valor).toLocaleString()}</td>
            <td>$${Number(doc.abono).toLocaleString()}</td>
            <td>$${saldo.toLocaleString()}</td>
            <td>${doc.fecha}</td>
            <td>${tipo}</td>
        </tr>`;
    });
}

function filtrar(){
    const q = document.getElementById("buscar").value.toLowerCase();
    const f = fabricantes.filter(x =>
        x.nombre.toLowerCase().includes(q) ||
        x.nit.toLowerCase().includes(q)
    );
    renderTabla(f);
}



// ====================== TOTAL GENERAL ======================
function calcularTotalGeneral(){
    let totalFact = 0, totalAb = 0;

    fabricantes.forEach(f=>{
        totalFact += Number(f.valor);
        totalAb += Number(f.abono);
    });

    document.getElementById("totalGeneral").textContent =
        "Total deuda general: $" + (totalFact - totalAb).toLocaleString();
}



// ====================== AUTOLLENAR ======================
function autollenar(nit, nombre){
    document.getElementById("nit").value = nit;
    document.getElementById("nombre").value = nombre;
    document.getElementById("numFactura").focus();
}



// ====================== GUARDAR ======================
async function guardarFactura(){

    const fecha = document.getElementById("fecha").value;
    const nit = document.getElementById("nit").value;
    const nombre = document.getElementById("nombre").value;
    const numFactura = document.getElementById("numFactura").value;
    const valor = Number(document.getElementById("valor").value);
    const abono = Number(document.getElementById("abono").value);
    const solo = document.getElementById("soloAbonar").checked;

    if(!fecha || !nit || !nombre){
        alert("Debe llenar fecha, NIT y nombre");
        return;
    }

    const data = {
        fecha,
        nit,
        nombre,
        numFactura: solo ? "-" : numFactura,
        valor: solo ? 0 : valor,
        abono: solo ? abono : 0
    };

    await db.collection("fabricantes").add(data);

    alert("Guardado correctamente");
    limpiar();
    cargar();
}



// ====================== LIMPIAR ======================
function limpiar(){
    document.getElementById("fecha").value="";
    document.getElementById("nit").value="";
    document.getElementById("nombre").value="";
    document.getElementById("numFactura").value="";
    document.getElementById("valor").value=0;
    document.getElementById("abono").value=0;
    document.getElementById("soloAbonar").checked=false;
}



// ====================== SOLO ABONAR ======================
document.getElementById("soloAbonar").onchange = ()=>{
    if(document.getElementById("soloAbonar").checked){
        document.getElementById("valor").value = 0;
        document.getElementById("valor").disabled = true;
        document.getElementById("abono").focus();
    } else {
        document.getElementById("valor").disabled = false;
    }
};



// ====================== MODAL ======================
async function abrirModal(nit, nombre){
    document.getElementById("modalNombre").textContent = nombre;
    document.getElementById("modalNit").textContent = nit;

    const snap = await db.collection("fabricantes")
        .where("nit","==",nit)
        .orderBy("fecha","desc")
        .get();

    let totalF = 0, totalA = 0;
    let html = "";
    let i = 1;

    snap.forEach(doc=>{
        let d = doc.data();
        totalF += Number(d.valor);
        totalA += Number(d.abono);

        const saldo = d.valor - d.abono;

        html += `
        <tr>
            <td>${i++}</td>
            <td>${d.numFactura}</td>
            <td>$${Number(d.valor).toLocaleString()}</td>
            <td>$${Number(d.abono).toLocaleString()}</td>
            <td>$${saldo.toLocaleString()}</td>
            <td>
                <button onclick="eliminarDoc('${doc.id}')" style="color:red;">Eliminar</button>
            </td>
        </tr>
        `;
    });

    document.getElementById("tablaModal").innerHTML = html;
    document.getElementById("totalFabricante").textContent =
        "$" + (totalF - totalA).toLocaleString();

    document.getElementById("modalHistorial").style.display = "flex";
}

function cerrarModal(){
    document.getElementById("modalHistorial").style.display = "none";
}



// ====================== ELIMINAR DOCUMENTO ======================
async function eliminarDoc(id){
    if(confirm("¬øSeguro que quieres eliminar este registro?")){
        await db.collection("fabricantes").doc(id).delete();
        alert("Registro eliminado");
        cerrarModal();
        cargar();
    }
}



// ====================== EXPORTAR A EXCEL ======================
function exportarExcel(){

    const datos = fabricantes.map(f => ({
        NIT: f.nit,
        NOMBRE: f.nombre,
        "N¬∞ FACTURA": f.numFactura,
        VALOR: f.valor,
        ABONO: f.abono,
        "VALOR TOT": f.valor - f.abono,
        FECHA: f.fecha
    }));

    const hoja = XLSX.utils.json_to_sheet(datos);
    const libro = XLSX.utils.book_new();

    XLSX.utils.book_append_sheet(libro, hoja, "Fabricantes");

    XLSX.writeFile(libro, "Fabricantes.xlsx");
}



// INICIO
cargar();
</script>
</body>
</html>
