<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>La Zapater√≠a ‚Äî Cuentas Fabricantes</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

<!-- SheetJS para Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
  --card:#ffffff;
  --accent:#4CAF50;
  --accent-hover:#45a049;
  --danger:#e74c3c;
  --muted:#6b7280;
  --shadow: 0 8px 24px rgba(0,0,0,0.08);
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
}

body{
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
  background-attachment: fixed;
  color:#2c3e50;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn{
  from{ opacity:0; }
  to{ opacity:1; }
}

/* Top bar */
.topbar{
  background: linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%);
  color:white;
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  position: sticky;
  top: 0;
  z-index: 50;
  animation: slideDown 0.4s ease;
}

@keyframes slideDown{
  from{ transform: translateY(-100%); }
  to{ transform: translateY(0); }
}

.btn-back{
  background: rgba(255,255,255,0.2);
  border:none;
  color:white;
  font-size:18px;
  cursor:pointer;
  padding: 8px 16px;
  border-radius: 8px;
  transition: all 0.3s ease;
  font-weight: 600;
}

.btn-back:hover{
  background: rgba(255,255,255,0.3);
  transform: translateX(-3px);
}

/* Layout */
.container{
  max-width:1400px;
  margin:24px auto;
  padding:0 16px;
  display:flex;
  gap:24px;
  animation: slideUp 0.5s ease;
}

@keyframes slideUp{
  from{ opacity:0; transform: translateY(30px); }
  to{ opacity:1; transform: translateY(0); }
}

.panel{
  background:var(--card);
  padding:24px;
  border-radius:16px;
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
}

.panel:hover{
  box-shadow: 0 12px 32px rgba(0,0,0,0.12);
}

.left{
  width:380px;
  animation: slideInLeft 0.5s ease;
}

@keyframes slideInLeft{
  from{ opacity:0; transform: translateX(-30px); }
  to{ opacity:1; transform: translateX(0); }
}

.right{
  flex:1;
  animation: slideInRight 0.5s ease;
}

@keyframes slideInRight{
  from{ opacity:0; transform: translateX(30px); }
  to{ opacity:1; transform: translateX(0); }
}

h2{
  color: #2e7d32;
  font-size: 22px;
  margin-bottom: 20px;
  font-weight: 700;
}

label{
  display: block;
  color: #555;
  font-size: 14px;
  font-weight: 600;
  margin-top: 14px;
  margin-bottom: 6px;
}

/* Checkbox personalizado */
.checkbox-container{
  margin-top: 20px;
  margin-bottom: 10px;
}

.checkbox-container input[type="checkbox"]{
  display: none;
}

.checkbox-label{
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
  padding: 12px;
  border-radius: 10px;
  transition: all 0.3s ease;
  background: #f8f9fa;
}

.checkbox-label:hover{
  background: #e8f5e9;
}

.checkbox-custom{
  width: 24px;
  height: 24px;
  border: 2px solid #4CAF50;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.checkbox-container input[type="checkbox"]:checked + .checkbox-label .checkbox-custom{
  background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
  border-color: #4CAF50;
}

.checkbox-container input[type="checkbox"]:checked + .checkbox-label .checkbox-custom::after{
  content: '‚úì';
  color: white;
  font-size: 16px;
  font-weight: bold;
}

.checkbox-text{
  color: #2c3e50;
  font-size: 15px;
  font-weight: 600;
}

input{
  width:100%;
  padding:12px 14px;
  border-radius:10px;
  border:2px solid #e0e0e0;
  font-size:15px;
  background:white;
  transition: all 0.3s ease;
}

input:focus{
  outline:none;
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.1);
  transform: scale(1.01);
}

button{
  cursor:pointer;
  transition: all 0.3s ease;
  font-weight: 600;
}

button:active{
  transform: scale(0.97);
}

/* Tabla */
.table-wrap{
  max-height:550px;
  overflow:auto;
  border:2px solid #e8f5e9;
  border-radius:12px;
  margin-top:16px;
  background: white;
}

.table-wrap::-webkit-scrollbar{
  width: 8px;
  height: 8px;
}

.table-wrap::-webkit-scrollbar-thumb{
  background: #4CAF50;
  border-radius: 4px;
}

.table-wrap::-webkit-scrollbar-track{
  background: #f1f8e9;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th{
  background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
  color: white;
  padding:12px 10px;
  font-weight: 700;
  position: sticky;
  top: 0;
  z-index: 10;
}

td{
  padding:12px 10px;
  border-bottom:1px solid #e8f5e9;
  transition: background 0.2s ease;
}

tr:hover td{
  background: #f1f8e9;
}

.name-link{
  color: var(--accent);
  cursor:pointer;
  text-decoration:none;
  font-weight: 600;
  transition: all 0.2s ease;
}

.name-link:hover{
  text-decoration:underline;
  color: var(--accent-hover);
}

/* Banner ABONO */
#bannerAbono{
  display:none;
  background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
  color:white;
  padding:12px;
  text-align:center;
  border-radius:10px;
  margin-bottom:16px;
  font-weight:700;
  animation: bounceIn 0.5s ease;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

@keyframes bounceIn{
  0%{ transform: scale(0.8); opacity: 0; }
  50%{ transform: scale(1.05); }
  100%{ transform: scale(1); opacity: 1; }
}

/* Modal */
.modal-back{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:40px;
  z-index:100;
  animation: fadeIn 0.3s ease;
}

.modal{
  background:white;
  padding:28px;
  width:95%;
  max-width:1200px;
  border-radius:20px;
  max-height:90vh;
  overflow:auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: modalSlide 0.4s ease;
}

@keyframes modalSlide{
  from{ opacity:0; transform: translateY(-50px) scale(0.9); }
  to{ opacity:1; transform: translateY(0) scale(1); }
}

/* Edici√≥n */
.editing-row{
  background:#fff9c4 !important;
  animation: pulse 0.5s ease;
}

@keyframes pulse{
  0%, 100%{ transform: scale(1); }
  50%{ transform: scale(1.02); }
}

.btn-small{
  padding:6px 12px;
  border:none;
  border-radius:8px;
  font-size:13px;
  cursor:pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.btn-small:hover{
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.btn-edit{
  background: linear-gradient(135deg, #2196F3 0%, #42A5F5 100%);
  color:white;
}

.btn-delete{
  background: linear-gradient(135deg, #e74c3c 0%, #ec7063 100%);
  color:white;
}

.btn-save{
  background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
  color:white;
}

.btn-cancel{
  background: linear-gradient(135deg, #636e72 0%, #95a5a6 100%);
  color:white;
}

/* Botones principales */
#btnGuardar{
  width:100%;
  background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
  color:white;
  border:none;
  padding:14px;
  border-radius:12px;
  margin-top:20px;
  font-size: 16px;
  box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
}

#btnGuardar:hover{
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(76, 175, 80, 0.4);
}

#btnLimpiar{
  width:100%;
  background: linear-gradient(135deg, #636e72 0%, #95a5a6 100%);
  color:white;
  border:none;
  padding:12px;
  border-radius:12px;
  margin-top:10px;
  font-size: 15px;
}

#btnLimpiar:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(99, 110, 114, 0.3);
}

/* Modal de Alerta Personalizado */
.alert-modal-back{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:200;
  animation: fadeIn 0.3s ease;
}

.alert-modal{
  background:white;
  padding:28px;
  width:90%;
  max-width:450px;
  border-radius:16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: modalSlide 0.4s ease;
  text-align: center;
}

.alert-modal h3{
  color: #2e7d32;
  margin-bottom: 16px;
  font-size: 22px;
}

.alert-modal p{
  color: #555;
  margin-bottom: 24px;
  font-size: 16px;
  line-height: 1.5;
}

.alert-modal.error h3{
  color: #e74c3c;
}

.alert-modal.success h3{
  color: #4CAF50;
}

.alert-modal.warning h3{
  color: #ff9800;
}

.alert-modal-buttons{
  display: flex;
  gap: 12px;
  justify-content: center;
}

.alert-btn{
  padding: 12px 28px;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.alert-btn-primary{
  background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
  color: white;
}

.alert-btn-primary:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

.alert-btn-secondary{
  background: linear-gradient(135deg, #636e72 0%, #95a5a6 100%);
  color: white;
}

.alert-btn-secondary:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(99, 110, 114, 0.3);
}

.alert-btn-danger{
  background: linear-gradient(135deg, #e74c3c 0%, #ec7063 100%);
  color: white;
}

.alert-btn-danger:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
}

/* Modal de Edici√≥n */
.edit-modal-back{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:150;
  animation: fadeIn 0.3s ease;
}

.edit-modal{
  background:white;
  padding:32px;
  width:90%;
  max-width:500px;
  border-radius:20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: modalSlide 0.4s ease;
  max-height: 90vh;
  overflow-y: auto;
}

.edit-modal h3{
  color: #2e7d32;
  margin-bottom: 24px;
  font-size: 24px;
  text-align: center;
}

.edit-modal label{
  display: block;
  color: #555;
  font-size: 14px;
  font-weight: 600;
  margin-top: 14px;
  margin-bottom: 6px;
}

.edit-modal input{
  width:100%;
  padding:12px 14px;
  border-radius:10px;
  border:2px solid #e0e0e0;
  font-size:15px;
  background:white;
  transition: all 0.3s ease;
}

.edit-modal input:focus{
  outline:none;
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.1);
}

.edit-modal-buttons{
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.edit-modal-buttons button{
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

/* Dark Mode */
body.dark{
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  color:#e0e0e0;
}

body.dark .panel{
  background:#2a2a2a;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
}

body.dark input{
  background:#1a1a1a;
  color:white;
  border-color:#444;
}

body.dark table td{
  border-color:#444;
}

body.dark table th{
  background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);
}

body.dark .table-wrap{
  border-color:#444;
  background: #2a2a2a;
}

body.dark tr:hover td{
  background: #333;
}

body.dark .modal{
  background: #2a2a2a;
}

body.dark .alert-modal,
body.dark .edit-modal{
  background: #2a2a2a;
}

body.dark .alert-modal p,
body.dark .edit-modal label{
  color: #e0e0e0;
}

body.dark h2{
  color: #66BB6A;
}

body.dark .checkbox-label{
  background: #1a1a1a;
}

body.dark .checkbox-label:hover{
  background: #2a2a2a;
}

body.dark .checkbox-text{
  color: #e0e0e0;
}

/* Responsive */
@media (max-width: 1024px){
  .container{
    flex-direction: column;
  }
  
  .left{
    width: 100%;
  }
}

@media (max-width: 768px){
  .topbar{
    flex-direction: column;
    gap: 12px;
    padding: 16px;
  }
  
  .container{
    padding: 0 12px;
    margin: 16px auto;
  }
  
  .panel{
    padding: 20px 16px;
  }
  
  table{
    font-size: 13px;
  }
  
  th, td{
    padding: 10px 6px;
  }
  
  .edit-modal,
  .alert-modal{
    width: 95%;
    padding: 24px 20px;
  }
}
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <button class="btn-back" onclick="location.href='https://userlink2024.github.io/lazapateria/paneldecuentas.html'">‚Üê Atr√°s</button>
  <div style="font-size:16px;font-weight:600;">La Zapater√≠a ‚Äî Cuentas de Fabricantes</div>

  <div style="display:flex;gap:10px;align-items:center">
    <div id="user-info" style="background:#ffffff22;padding:6px 10px;border-radius:6px;font-size:13px;">
      Cargando...
    </div>

    <button id="toggleDark" style="background:#ffffff22;color:white;border:none;padding:8px;border-radius:6px;">
      üåô
    </button>

    <button id="logout" style="background:#d63031;color:white;border:none;padding:8px 14px;border-radius:6px;">
      Salir
    </button>
  </div>
</div>

<div class="container">

<!-- PANEL IZQUIERDO -->
<div class="panel left">

  <h2>Formulario</h2>

  <div id="bannerAbono">MODO ABONO GENERAL</div>

  <label>Fecha</label>
  <input id="fecha" type="date">

  <label>NIT</label>
  <input id="nit" type="text">

  <label>Nombre fabricante</label>
  <input id="nombre" type="text">

  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;margin-bottom:6px;gap:10px;">
    <label style="margin:0;">N¬∞ Factura</label>
    <button id="btnGenFactura" type="button" style="background:#2e7d32;color:white;border:none;padding:8px 10px;border-radius:8px;font-size:12px;white-space:nowrap;">
      Generar c√≥digo de factura
    </button>
  </div>
  <input id="numFactura" type="text">

  <label>Valor</label>
  <input id="valor" type="text" inputmode="numeric" value="0">

  <label>Abono (ABONO GENERAL)</label>
  <input id="abono" type="text" inputmode="numeric" value="0">

  <div class="checkbox-container">
    <input id="soloAbonar" type="checkbox">
    <label for="soloAbonar" class="checkbox-label">
      <span class="checkbox-custom"></span>
      <span class="checkbox-text">Solo abonar (ABONO GENERAL)</span>
    </label>
  </div>

  <button id="btnGuardar" style="width:100%;background:#0984e3;color:white;border:none;padding:10px;border-radius:8px;margin-top:12px;">
    Guardar
  </button>

  <button id="btnLimpiar" onclick="limpiar()" style="width:100%;background:#636e72;color:white;border:none;padding:10px;border-radius:8px;margin-top:8px;">
    Limpiar
  </button>

</div>

<!-- PANEL DERECHO -->
<div class="panel right">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="margin:0;">Lista</h2>

    <div>
      <small>Deuda total:</small><br>
      <strong id="totalGeneral">$0</strong>
    </div>
  </div>

  <div style="display:flex;gap:10px;margin-top:12px;">
    <input id="buscar" type="text" placeholder="Buscar..." oninput="filtrar()" style="flex:1">
    <button onclick="exportarExcel()" style="background:#27ae60;color:white;border:none;padding:10px;border-radius:8px;">
      Excel
    </button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>NIT</th>
          <th>Nombre</th>
          <th>Factura</th>
          <th>Valor</th>
          <th>Abono</th>
          <th>Saldo</th>
          <th>Fecha</th>
          <th>Tipo</th>
        </tr>
      </thead>
      <tbody id="tablaFabricantes"></tbody>
    </table>
  </div>

  <div style="margin-top:6px;font-size:13px;display:flex;justify-content:space-between;">
    <span>Registros: <b id="countRegs">0</b></span>
    <span>Deuda filtro: <b id="deudaFiltro">$0</b></span>
  </div>

  <div id="pagination" style="margin-top:10px;display:flex;justify-content:flex-end;gap:10px;align-items:center;font-size:13px;">
    <button id="pagePrev" type="button" style="background:#636e72;color:white;border:none;padding:8px 12px;border-radius:8px;">‚óÄ</button>
    <span id="pageInfo">1 / 1</span>
    <button id="pageNext" type="button" style="background:#636e72;color:white;border:none;padding:8px 12px;border-radius:8px;">‚ñ∂</button>
  </div>
</div>

</div> <!-- container -->

<!-- MODAL -->
<div id="modalBackdrop" class="modal-back">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <h3 id="modalTitle" style="margin:0;"></h3>
        <small>NIT: <span id="modalNit"></span></small>
      </div>

      <button onclick="cerrarModal()" style="background:#636e72;color:white;border:none;padding:8px 12px;border-radius:6px;">
        Cerrar
      </button>
    </div>

    <div style="margin-top:12px;background:#f1f5f9;padding:10px;border-radius:10px;">
      <canvas id="chartDonut"></canvas>
      <div style="margin-top:12px;text-align:right;font-weight:bold;font-size:15px;">
        Total: <span id="modalTotal">$0</span>
      </div>
    </div>

    <div id="detalleList" style="margin-top:20px;"></div>
  </div>
</div>

<!-- MODAL DE ALERTA -->
<div id="alertModalBackdrop" class="alert-modal-back">
  <div id="alertModalContent" class="alert-modal">
    <h3 id="alertTitle">Mensaje</h3>
    <p id="alertMessage"></p>
    <div class="alert-modal-buttons" id="alertButtons"></div>
  </div>
</div>

<!-- MODAL DE EDICI√ìN -->
<div id="editModalBackdrop" class="edit-modal-back">
  <div class="edit-modal">
    <h3 id="editModalTitle">Editar Registro</h3>
    
    <label>Fecha</label>
    <input id="editFecha" type="date">
    
    <label>NIT</label>
    <input id="editNit" type="text">
    
    <label>Nombre fabricante</label>
    <input id="editNombre" type="text">
    
    <label>N¬∞ Factura</label>
    <input id="editNumFactura" type="text">
    
    <label>Valor</label>
    <input id="editValor" type="text" inputmode="numeric" value="0">
    
    <label>Abono</label>
    <input id="editAbono" type="text" inputmode="numeric" value="0">
    
    <div class="edit-modal-buttons">
      <button onclick="cancelarEdicionModal()" style="background: linear-gradient(135deg, #636e72 0%, #95a5a6 100%); color:white;">
        Cancelar
      </button>
      <button id="btnGuardarEdicion" style="background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color:white;">
        Guardar Cambios
      </button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
  authDomain:"lazapateria-c4157.firebaseapp.com",
  projectId:"lazapateria-c4157",
  storageBucket:"lazapateria-c4157.firebasestorage.app",
  messagingSenderId:"300241769138",
  appId:"1:300241769138:web:8ca1847de3c4fb5042afab"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const COLECCION = "fabricantes";

/* =======================================================
   FUNCIONES DE MODAL DE ALERTA
======================================================= */
function showAlert(message, type = 'info', callback = null) {
  const backdrop = document.getElementById('alertModalBackdrop');
  const modal = document.getElementById('alertModalContent');
  const title = document.getElementById('alertTitle');
  const messageEl = document.getElementById('alertMessage');
  const buttonsEl = document.getElementById('alertButtons');
  
  // Limpiar clases previas
  modal.className = 'alert-modal';
  
  // Configurar tipo
  if (type === 'error') {
    modal.classList.add('error');
    title.textContent = '‚ùå Error';
  } else if (type === 'success') {
    modal.classList.add('success');
    title.textContent = '‚úÖ √âxito';
  } else if (type === 'warning') {
    modal.classList.add('warning');
    title.textContent = '‚ö†Ô∏è Advertencia';
  } else {
    title.textContent = '‚ÑπÔ∏è Informaci√≥n';
  }
  
  messageEl.textContent = message;
  
  // Bot√≥n OK
  buttonsEl.innerHTML = `
    <button class="alert-btn alert-btn-primary" onclick="closeAlert()">Aceptar</button>
  `;
  
  backdrop.style.display = 'flex';
  
  // Callback despu√©s de cerrar
  if (callback) {
    window.alertCallback = callback;
  }
}

function showConfirm(message, onConfirm, onCancel = null) {
  const backdrop = document.getElementById('alertModalBackdrop');
  const modal = document.getElementById('alertModalContent');
  const title = document.getElementById('alertTitle');
  const messageEl = document.getElementById('alertMessage');
  const buttonsEl = document.getElementById('alertButtons');
  
  modal.className = 'alert-modal warning';
  title.textContent = '‚ö†Ô∏è Confirmaci√≥n';
  messageEl.textContent = message;
  
  buttonsEl.innerHTML = `
    <button class="alert-btn alert-btn-secondary" onclick="closeAlert(); ${onCancel ? 'window.confirmCancelCallback()' : ''}">Cancelar</button>
    <button class="alert-btn alert-btn-danger" onclick="closeAlert(); window.confirmCallback()">Confirmar</button>
  `;
  
  backdrop.style.display = 'flex';
  
  window.confirmCallback = onConfirm;
  if (onCancel) window.confirmCancelCallback = onCancel;
}

function closeAlert() {
  document.getElementById('alertModalBackdrop').style.display = 'none';
  if (window.alertCallback) {
    window.alertCallback();
    window.alertCallback = null;
  }
}

/* =======================================================
   VARIABLES GLOBALES
======================================================= */
const usuario = JSON.parse(localStorage.getItem("datosUsuario") || "null");
if(!usuario){ showAlert("No hay sesi√≥n activa.", "error", () => location.href="index.html"); }
if(usuario.permisos !== "Administrador"){ showAlert("Acceso denegado.", "error", () => location.href="index.html"); }

document.getElementById("user-info").textContent =
  usuario.usuario + " ‚Äî " + usuario.permisos;

document.getElementById("logout").onclick = ()=>{
  localStorage.removeItem("datosUsuario");
  location.href="index.html";
};

const toggleDark = document.getElementById("toggleDark");

if(localStorage.getItem("dark")==="1"){
  document.body.classList.add("dark");
  toggleDark.textContent = "‚òÄÔ∏è";
}

toggleDark.onclick = ()=>{
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  toggleDark.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("dark", isDark ? "1":"0");
};

let registros = [];
let currentModalNit = null;
let currentModalNombre = null;
let grouped = {};
let chartDonut = null;

const PAGE_SIZE = 50;
let currentPage = 1;
let currentList = [];

async function cargarTodos(){
  const snap = await db.collection(COLECCION).get();
  registros = snap.docs.map(d=>({id:d.id, ...d.data()}));

  registros.forEach(r=>{
    if(r.fecha?.seconds){
      r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10);
    }
  });

  currentPage = 1;
  renderTabla(registros);
  actualizarTotales(registros);
}
cargarTodos();
function renderTabla(list){
  currentList = Array.isArray(list) ? list : [];
  const tbody = document.getElementById("tablaFabricantes");
  tbody.innerHTML = "";

  const start = (currentPage - 1) * PAGE_SIZE;
  const pageItems = currentList.slice(start, start + PAGE_SIZE);

  pageItems.forEach(r=>{
    const valor = Number(r.valor||0);
    const abono = Number(r.abono||0);
    const saldo = valor - abono;
    const tipo = valor>0 ? "Factura" : "ABONO GENERAL";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.nit}</td>
      <td><span class="name-link">${r.nombre}</span></td>
      <td>${r.numFactura}</td>
      <td>$${valor.toLocaleString()}</td>
      <td>$${abono.toLocaleString()}</td>
      <td>$${saldo.toLocaleString()}</td>
      <td>${r.fecha}</td>
      <td>${tipo}</td>
    `;

    /* Doble clic ‚Üí modal */
    tr.ondblclick = ()=> openModal(r.nit, r.nombre);

    /* Autollenar formulario al hacer clic en nombre */
    tr.querySelector(".name-link").onclick = e=>{
      e.stopPropagation();
      document.getElementById("nit").value = r.nit;
      document.getElementById("nombre").value = r.nombre;

      if(document.getElementById("soloAbonar").checked){
        document.getElementById("numFactura").value = "ABONO";
      }
    };

    tbody.appendChild(tr);
  });

  document.getElementById("countRegs").textContent = currentList.length;
  renderPagination();
}

function renderPagination(){
  const total = currentList.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if (currentPage > totalPages) currentPage = totalPages;
  document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
  const prevBtn = document.getElementById('pagePrev');
  const nextBtn = document.getElementById('pageNext');
  prevBtn.disabled = currentPage <= 1;
  nextBtn.disabled = currentPage >= totalPages;
  prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
  nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
}

function filtrar(){
  const q = document.getElementById("buscar").value.trim().toLowerCase();

  const out = registros.filter(r =>
    r.nit.toLowerCase().includes(q) ||
    r.nombre.toLowerCase().includes(q) ||
    r.numFactura.toLowerCase().includes(q)
  );

  currentPage = 1;
  renderTabla(out);
  actualizarTotales(out);
}
function actualizarTotales(list){
  let totF = list.reduce((s,x)=> s + Number(x.valor||0), 0);
  let totA = list.reduce((s,x)=> s + Number(x.abono||0), 0);

  document.getElementById("totalGeneral").textContent =
    "$" + (totF-totA).toLocaleString();

  document.getElementById("deudaFiltro").textContent =
    "$" + (totF-totA).toLocaleString();
}

document.getElementById("soloAbonar").onchange = function(){
  const banner = document.getElementById("bannerAbono");
  const numFactura = document.getElementById("numFactura");
  const valor = document.getElementById("valor");
  const btnGenFactura = document.getElementById("btnGenFactura");

  if(this.checked){
    banner.style.display="block";
    valor.disabled = true;
    setMoneyInputValue(valor, 0);

    numFactura.value = "ABONO";
    numFactura.disabled = true;
    btnGenFactura.disabled = true;
    btnGenFactura.style.opacity = '0.5';

    document.getElementById("abono").focus();
  }
  else{
    banner.style.display="none";
    valor.disabled = false;

    numFactura.disabled = false;
    numFactura.value = "";
    btnGenFactura.disabled = false;
    btnGenFactura.style.opacity = '1';
  }
};
document.getElementById("btnGuardar").onclick = async function(){

  const fecha = document.getElementById("fecha").value || new Date().toISOString().slice(0,10);
  const nit = document.getElementById("nit").value.trim();
  const nombre = document.getElementById("nombre").value.trim();
  const numFactura = document.getElementById("numFactura").value.trim() || "-";
  const valor = parseMoney(document.getElementById("valor").value);
  const abono = parseMoney(document.getElementById("abono").value);
  const solo = document.getElementById("soloAbonar").checked;

  if(!nit || !nombre){
    showAlert("Debes ingresar NIT y Nombre.", "error");
    return;
  }

  if(solo){
    if(abono <= 0){
      showAlert("En ABONO GENERAL, el abono debe ser mayor a 0.", "error");
      return;
    }

    await db.collection(COLECCION).add({
      fecha, nit, nombre,
      numFactura:"ABONO",
      valor:0,
      abono:abono
    });

    showAlert("Abono registrado correctamente.", "success");
  }
  else{
    if(valor <= 0){
      showAlert("El valor de la factura debe ser mayor a 0.", "error");
      return;
    }

    await db.collection(COLECCION).add({
      fecha, nit, nombre,
      numFactura,
      valor:valor,
      abono:0
    });

    showAlert("Factura registrada correctamente.", "success");
  }

  limpiar();
  cargarTodos();
};

/* =======================================================
   LIMPIAR FORMULARIO
======================================================= */
function limpiar(){
  document.getElementById("fecha").value="";
  document.getElementById("nit").value="";
  document.getElementById("nombre").value="";
  document.getElementById("numFactura").value="";
  setMoneyInputValue(document.getElementById("valor"), 0);
  setMoneyInputValue(document.getElementById("abono"), 0);
  document.getElementById("soloAbonar").checked=false;

  document.getElementById("bannerAbono").style.display="none";
  document.getElementById("numFactura").disabled=false;
  document.getElementById("valor").disabled=false;
}

/* =======================================================
   MODAL ‚Äî ABRIR
======================================================= */
async function openModal(nit, nombre){
  currentModalNit = nit;
  currentModalNombre = nombre;

  document.getElementById("modalTitle").textContent = "Historial: " + nombre;
  document.getElementById("modalNit").textContent = nit;
  modalBackdrop.style.display="flex";

  const snap = await db.collection(COLECCION)
    .where("nit","==",nit).get();

  if(snap.empty){
    document.getElementById("modalTotal").textContent = "$0";
    if(chartDonut) chartDonut.destroy();
    document.getElementById("detalleList").innerHTML = "";
    return;
  }

  const rows = snap.docs.map(d=>({id:d.id, ...d.data()}));

  rows.forEach(r=>{
    if(r.fecha?.seconds){
      r.fecha = new Date(r.fecha.seconds*1000).toISOString().slice(0,10);
    }
  });

  renderDonut(rows);
  renderDetalle(rows);
}

function renderDonut(rows){
  const totalF = rows.reduce((s,x)=> s + Number(x.valor||0), 0);
  const totalA = rows.reduce((s,x)=> s + Number(x.abono||0), 0);
  document.getElementById("modalTotal").textContent = "$" + (totalF-totalA).toLocaleString();
  drawCharts(totalF, totalA);
}

/* =======================================================
   RENDER DETALLE
======================================================= */
function renderDetalle(rows){
  let html = `
    <h3>Detalle de movimientos</h3>
    <table style='width:100%;border-collapse:collapse;'>
      <thead>
        <tr>
          <th>#</th>
          <th>Tipo</th>
          <th>N¬∞ Factura</th>
          <th>Valor</th>
          <th>Abono</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
  `;

  rows.forEach((r,i)=>{
    html += `
      <tr>
        <td>${i+1}</td>
        <td>${r.valor>0 ? "Factura" : "ABONO GENERAL"}</td>
        <td>${r.numFactura}</td>
        <td>$${r.valor.toLocaleString()}</td>
        <td>$${r.abono.toLocaleString()}</td>
        <td>${r.fecha}</td>
        <td>
          <button class="btn-small btn-edit" onclick="editarDocumento('${r.id}')">Editar</button>
          <button class="btn-small btn-delete" onclick="eliminarDocumento('${r.id}')">Eliminar</button>
        </td>
      </tr>`;
  });

  html += "</tbody></table>";

  document.getElementById("detalleList").innerHTML = html;
}

/* =======================================================
   GR√ÅFICOS
======================================================= */
function drawCharts(keys, grouped){
  if(chartDonut) chartDonut.destroy();

  chartDonut = new Chart(document.getElementById("chartDonut"),{
    type:"doughnut",
    data:{
      labels:["Facturas","Abonos"],
      datasets:[
        {
          data:[
            Number(keys||0),
            Number(grouped||0)
          ],
          backgroundColor:["#0984e3","#00b894"]
        }
      ]
    }
  });
}

/* =======================================================
   CERRAR MODAL
======================================================= */
function cerrarModal(){
  modalBackdrop.style.display="none";
  if(chartDonut) chartDonut.destroy();
}

document.getElementById('pagePrev').onclick = ()=>{
  if (currentPage > 1) {
    currentPage -= 1;
    renderTabla(currentList);
  }
};

document.getElementById('pageNext').onclick = ()=>{
  const totalPages = Math.max(1, Math.ceil(currentList.length / PAGE_SIZE));
  if (currentPage < totalPages) {
    currentPage += 1;
    renderTabla(currentList);
  }
};

function formatMoneyInput(raw) {
  const digits = String(raw || '').replace(/\D/g, '').slice(0, 15);
  const n = digits ? Number(digits) : 0;
  return n.toLocaleString('es-CO');
}

function parseMoney(raw) {
  const digits = String(raw || '').replace(/\D/g, '');
  return digits ? Number(digits) : 0;
}

function setMoneyInputValue(el, n) {
  if (!el) return;
  const safe = Number.isFinite(Number(n)) ? Number(n) : 0;
  el.value = safe.toLocaleString('es-CO');
}

function bindMoneyInput(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('input', (e) => {
    const formatted = formatMoneyInput(e.target.value);
    e.target.value = formatted;
  });
  el.addEventListener('blur', (e) => {
    const formatted = formatMoneyInput(e.target.value);
    e.target.value = formatted;
  });
}

bindMoneyInput('valor');
bindMoneyInput('abono');
bindMoneyInput('editValor');
bindMoneyInput('editAbono');

function generateFacturaCode() {
  const ts = Date.now().toString(36).toUpperCase();
  const rnd = Math.random().toString(36).slice(2, 6).toUpperCase();
  return `F-${ts}-${rnd}`;
}

document.getElementById('btnGenFactura').onclick = ()=>{
  const solo = document.getElementById('soloAbonar').checked;
  if (solo) return;
  const el = document.getElementById('numFactura');
  el.value = generateFacturaCode();
  el.focus();
};

/* =======================================================
   EXPORTAR EXCEL
======================================================= */
function exportarExcel(){

  const q = document.getElementById("buscar").value.trim().toLowerCase();

  const data = registros.filter(r =>
    r.nit.toLowerCase().includes(q) ||
    r.nombre.toLowerCase().includes(q) ||
    r.numFactura.toLowerCase().includes(q)
  ).map(r=>({
    NIT:r.nit,
    NOMBRE:r.nombre,
    FACTURA:r.numFactura,
    VALOR:r.valor,
    ABONO:r.abono,
    SALDO:r.valor - r.abono,
    FECHA:r.fecha
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Reporte");

  XLSX.writeFile(wb,"Fabricantes.xlsx");
}
/* =======================================================
    =============  PARTE 3 - EDICI√ìN COMPLETA  ============
======================================================= */

let editandoGrupo = null;
let editandoDocumento = null;

/* =======================================================
   EDITAR GRUPO COMPLETO (FACTURA + ABONOS)
======================================================= */
function editarGrupo(numFactura){
  editandoGrupo = numFactura;
  editandoDocumento = null;

  // Cargar datos de la factura principal en el formulario
  const facturaPrincipal = registros.find(r => r.numFactura === numFactura && Number(r.valor || 0) > 0);
  if(facturaPrincipal){
    document.getElementById("nit").value = facturaPrincipal.nit;
    document.getElementById("nombre").value = facturaPrincipal.nombre;
    document.getElementById("numFactura").value = facturaPrincipal.numFactura;
    setMoneyInputValue(document.getElementById("valor"), Number(facturaPrincipal.valor || 0));
    setMoneyInputValue(document.getElementById("abono"), 0);
    document.getElementById("soloAbonar").checked = false;
    document.getElementById("bannerAbono").style.display = "none";
    document.getElementById("fecha").value = facturaPrincipal.fecha;
  }

  showAlert("Editando factura principal. Modifica los datos en el formulario y presiona GUARDAR.", "info");
}

/* =======================================================
   GUARDAR GRUPO COMPLETO
======================================================= */
async function guardarGrupo(numFactura){

  const fecha = document.getElementById("fecha").value || new Date().toISOString().slice(0,10);
  const nit = document.getElementById("nit").value.trim();
  const nombre = document.getElementById("nombre").value.trim();
  const nuevoNum = document.getElementById("numFactura").value.trim();
  const valor = parseMoney(document.getElementById("valor").value);

  if(!nit || !nombre){
    showAlert("Debes ingresar NIT y Nombre.", "error");
    return;
  }

  if(valor <= 0){
    showAlert("El valor de una factura debe ser mayor a 0.", "error");
    return;
  }

  // Buscar factura principal
  const snap = await db.collection(COLECCION)
    .where("nit","==",currentModalNit)
    .where("numFactura","==",numFactura)
    .where("valor",">",0)
    .get();

  if(snap.empty){
    showAlert("Factura principal no encontrada.", "error");
    return;
  }

  const docId = snap.docs[0].id;

  await db.collection(COLECCION).doc(docId).update({
    fecha, nit, nombre,
    numFactura: nuevoNum,
    valor
  });

  showAlert("Factura principal actualizada correctamente.", "success");

  editandoGrupo = null;
  cerrarModal();
  cargarTodos();
  openModal(nit, nombre);
}

/* =======================================================
   CANCELAR EDICI√ìN
======================================================= */
function cancelarEdicion(){
  editandoGrupo = null;
  editandoDocumento = null;

  cerrarModal();
  openModal(currentModalNit, currentModalNombre);
}

/* =======================================================
   ELIMINAR TODO EL GRUPO (FACTURA + ABONOS)
======================================================= */
async function eliminarGrupo(numFactura){
  showConfirm("¬øEliminar la factura y TODOS sus abonos?", async () => {
    const snap = await db.collection(COLECCION)
      .where("nit","==",currentModalNit)
      .where("numFactura","==",numFactura)
      .get();

    const batch = db.batch();
    snap.docs.forEach(d => batch.delete(d.ref));
    await batch.commit();

    showAlert("Factura y abonos eliminados correctamente.", "success");

    cerrarModal();
    await cargarTodos();
    openModal(currentModalNit, currentModalNombre);
  });
}

/* =======================================================
   EDITAR DOCUMENTO INDIVIDUAL (FACTURA / ABONO)
======================================================= */
let currentEditId = null;

async function editarDocumento(id){
  currentEditId = id;
  
  const doc = registros.find(r => r.id === id);
  if(!doc){
    showAlert("Documento no encontrado.", "error");
    return;
  }

  // Abrir modal de edici√≥n
  document.getElementById('editModalBackdrop').style.display = 'flex';
  
  // Cargar datos en el modal
  document.getElementById("editFecha").value = doc.fecha;
  document.getElementById("editNit").value = doc.nit;
  document.getElementById("editNombre").value = doc.nombre;
  document.getElementById("editNumFactura").value = doc.numFactura;
  
  if(doc.valor > 0){
    // Es FACTURA
    document.getElementById("editModalTitle").textContent = "Editar Factura";
    setMoneyInputValue(document.getElementById("editValor"), Number(doc.valor || 0));
    document.getElementById("editValor").disabled = false;
    setMoneyInputValue(document.getElementById("editAbono"), 0);
    document.getElementById("editAbono").disabled = true;
    document.getElementById("editNumFactura").disabled = false;
  }
  else{
    // Es ABONO
    document.getElementById("editModalTitle").textContent = "Editar Abono";
    setMoneyInputValue(document.getElementById("editValor"), 0);
    document.getElementById("editValor").disabled = true;
    setMoneyInputValue(document.getElementById("editAbono"), Number(doc.abono || 0));
    document.getElementById("editAbono").disabled = false;
    document.getElementById("editNumFactura").value = "ABONO";
    document.getElementById("editNumFactura").disabled = true;
  }
  
  // Configurar bot√≥n guardar
  document.getElementById("btnGuardarEdicion").onclick = () => guardarDocumentoModal(id);
}

function cancelarEdicionModal(){
  document.getElementById('editModalBackdrop').style.display = 'none';
  currentEditId = null;
}

/* =======================================================
   GUARDAR DOCUMENTO DESDE MODAL
======================================================= */
async function guardarDocumentoModal(id){
  const fecha = document.getElementById("editFecha").value || new Date().toISOString().slice(0,10);
  const nit = document.getElementById("editNit").value.trim();
  const nombre = document.getElementById("editNombre").value.trim();
  const numFactura = document.getElementById("editNumFactura").value.trim();
  const valor = parseMoney(document.getElementById("editValor").value);
  const abono = parseMoney(document.getElementById("editAbono").value);

  if(!nit || !nombre){
    showAlert("Debes ingresar NIT y Nombre.", "error");
    return;
  }

  // Determinar si es factura o abono
  const esAbono = numFactura === "ABONO" || valor === 0;

  if(esAbono){
    if(abono <= 0){
      showAlert("El abono debe ser mayor a 0.", "error");
      return;
    }

    await db.collection(COLECCION).doc(id).update({
      fecha, nit, nombre,
      numFactura:"ABONO",
      valor:0,
      abono
    });

    showAlert("Abono actualizado correctamente.", "success");
  }
  else{
    if(valor <= 0){
      showAlert("El valor de una factura debe ser mayor a 0.", "error");
      return;
    }

    await db.collection(COLECCION).doc(id).update({
      fecha, nit, nombre,
      numFactura,
      valor,
      abono:0
    });

    showAlert("Factura actualizada correctamente.", "success");
  }

  // Cerrar modal
  cancelarEdicionModal();
  
  // Recargar datos
  cerrarModal();
  await cargarTodos();
  openModal(nit, nombre);
}

/* =======================================================
   ELIMINAR DOCUMENTO INDIVIDUAL
======================================================= */
async function eliminarDocumento(id){
  showConfirm("¬øEliminar este registro?", async () => {
    await db.collection(COLECCION).doc(id).delete();

    showAlert("Registro eliminado correctamente.", "success");

    cerrarModal();
    await cargarTodos();
    openModal(currentModalNit, currentModalNombre);
  });
}
</script>
