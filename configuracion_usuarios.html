<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Usuarios</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            width: 100%;
            max-width: 600px;
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        label {
            margin-top: 10px;
            font-weight: bold;
            color: #555;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #218838;
        }
        .actions {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .actions button {
            flex: 1 1 auto;
            margin: 5px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBVtSkeQe1WZna6nKC4vGxd4ISaRBQ5SVY",
            authDomain: "facba-a160c.firebaseapp.com",
            projectId: "facba-a160c",
            storageBucket: "facba-a160c.appspot.com",
            messagingSenderId: "585530132394",
            appId: "1:585530132394:web:a25cda63f883f786804dd3",
            measurementId: "G-S29LSYM8TQ"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        window.onload = () => {
            const rolUsuario = localStorage.getItem('rolUsuario');
            if (!rolUsuario) {
                alert("No se encontró el rol del usuario.");
                window.location.href = 'index.html';
            } else {
                console.log("Rol del usuario recuperado del localStorage:", rolUsuario); // Depuración
                cargarUsuarios();
                cargarEmpresas();
            }
        };

        async function cargarUsuarios() {
            document.getElementById('estadoUsuarios').textContent = "Cargando usuarios...";
            try {
                const snapshot = await db.collection('usuarios').get();
                const usuariosSelect = document.getElementById('usuariosSelect');
                if (!usuariosSelect) {
                    throw new Error("usuariosSelect no está definido.");
                }
                usuariosSelect.innerHTML = '<option value="">Seleccionar Usuario</option>';
                snapshot.forEach(doc => {
                    const usuario = doc.data().nombreCompleto;
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = usuario;
                    usuariosSelect.appendChild(option);
                });
                document.getElementById('estadoUsuarios').textContent = "Usuarios cargados correctamente.";
            } catch (error) {
                document.getElementById('estadoUsuarios').textContent = "Error al cargar usuarios: " + error.message;
            }
        }

        async function cargarEmpresas() {
            const empresaSelect = document.getElementById('empresaSeleccionadaRegistro');
            empresaSelect.innerHTML = '<option value="">Seleccionar Empresa</option>';
            try {
                const snapshot = await db.collection('empresas').get();
                snapshot.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.data().nombre;
                    option.textContent = doc.data().nombre;
                    empresaSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error cargando empresas: ", error);
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Configuración de Usuarios</h1>
        <p id="estadoUsuarios"></p>
    <script>
        async function registrarUsuario() {
            const nombreCompleto = document.getElementById("nombreCompleto").value;
            const tipoDocumento = document.getElementById("tipoDocumento").value;
            const celular = document.getElementById("celular").value;
            const correo = document.getElementById("correo").value;
            const direccion = document.getElementById("direccion").value;
            const municipio = document.getElementById("municipio").value;
            const tipoContrato = document.getElementById("tipoContrato").value;
            const permisos = document.getElementById("permisos").value;
            const nuevaEmpresa = document.getElementById("nuevaEmpresa").value;
            const empresaSeleccionada = document.getElementById("empresaSeleccionadaRegistro").value;
            const usuario = document.getElementById("usuarioRegistro").value;
            const contraseña = document.getElementById("contraseña").value;
            const empresa = nuevaEmpresa || empresaSeleccionada;

            if (!nombreCompleto || !empresa || !usuario || !contraseña) {
                alert("Por favor, complete todos los campos obligatorios.");
                return;
            }

            if (nuevaEmpresa && !(await empresaExiste(nuevaEmpresa))) {
                await db.collection('empresas').add({ nombre: nuevaEmpresa });
            }

            try {
                await db.collection('usuarios').add({
                    nombreCompleto,
                    tipoDocumento,
                    celular,
                    correo,
                    direccion,
                    municipio,
                    tipoContrato,
                    permisos,
                    empresa,
                    usuario,
                    contraseña // Agregando contraseña a la colección
                });
                alert("Usuario registrado: " + nombreCompleto + " (Usuario: " + usuario + ") en la empresa " + empresa);
                cargarUsuarios();
                cargarEmpresas();
            } catch (error) {
                console.error("Error registrando usuario: ", error);
            }
        }

        async function empresaExiste(nombreEmpresa) {
            const snapshot = await db.collection('empresas').where('nombre', '==', nombreEmpresa).get();
            return !snapshot.empty;
        }

        async function modificarUsuario() {
            const usuarioId = document.getElementById('usuariosSelect').value;
            const nombreCompleto = document.getElementById("nombreCompleto").value;
            const tipoDocumento = document.getElementById("tipoDocumento").value;
            const celular = document.getElementById("celular").value;
            const correo = document.getElementById("correo").value;
            const direccion = document.getElementById("direccion").value;
            const municipio = document.getElementById("municipio").value;
            const tipoContrato = document.getElementById("tipoContrato").value;
            const permisos = document.getElementById("permisos").value;
            const empresa = document.getElementById("empresaSeleccionadaRegistro").value;
            const contraseña = document.getElementById("contraseña").value;

            if (!nombreCompleto || !empresa || !usuarioId || !contraseña) {
                alert("Por favor, complete todos los campos obligatorios.");
                return;
            }

            try {
                await db.collection('usuarios').doc(usuarioId).update({
                    nombreCompleto,
                    tipoDocumento,
                    celular,
                    correo,
                    direccion,
                    municipio,
                    tipoContrato,
                    permisos,
                    empresa,
                    contraseña // Agregando contraseña a la actualización
                });
                alert("Usuario modificado con éxito.");
                cargarUsuarios();
            } catch (error) {
                console.error("Error modificando usuario: ", error);
            }
        }

        async function eliminarUsuario() {
            const usuarioId = document.getElementById('usuariosSelect').value;

            if (!usuarioId) {
                alert("Por favor, seleccione un usuario.");
                return;
            }

            try {
                await db.collection('usuarios').doc(usuarioId).delete();
                alert("Usuario eliminado con éxito.");
                cargarUsuarios();
            } catch (error) {
                console.error("Error eliminando usuario: ", error);
            }
        }
    </script>
    <script>
        async function mostrarDatosUsuario() {
            const usuarioId = document.getElementById('usuariosSelect').value;
            if (usuarioId) {
                try {
                    const usuarioDoc = await db.collection('usuarios').doc(usuarioId).get();
                    if (usuarioDoc.exists) {
                        const usuario = usuarioDoc.data();
                        document.getElementById('usuarioRegistro').value = usuario.usuario;
                        document[_{{{CITATION{{{_1{](https://github.com/la9una/web/tree/ba1073ae044ebb7b538a3b13f0f9598f7c410bb6/docs%2Fbootstrap%2Falignci.md)[_{{{CITATION{{{_2{](https://github.com/CLONATORE/markdowns/tree/82cfb03683ceb807a7091de48045e6a7485acd72/webpack.md)
                                                                             document.getElementById('usuarioRegistro').value = usuario.usuario;
                        document.getElementById('nombreCompleto').value = usuario.nombreCompleto;
                        document.getElementById('tipoDocumento').value = usuario.tipoDocumento;
                        document.getElementById('celular').value = usuario.celular;
                        document.getElementById('correo').value = usuario.correo;
                        document.getElementById('direccion').value = usuario.direccion;
                        document.getElementById('municipio').value = usuario.municipio;
                        document.getElementById('tipoContrato').value = usuario.tipoContrato;
                        document.getElementById('permisos').value = usuario.permisos;
                        document.getElementById('empresaSeleccionadaRegistro').value = usuario.empresa;
                        document.getElementById('contraseña').value = usuario.contraseña; // Mostrar la contraseña
                    }
                } catch (error) {
                    console.error("Error obteniendo datos del usuario: ", error);
                }
            }
        }

        // Asegurarse de que el DOM esté completamente cargado antes de llamar a estas funciones
        window.onload = function() {
            const rolUsuario = localStorage.getItem('rolUsuario');
            if (!rolUsuario) {
                alert("No se encontró el rol del usuario.");
                window.location.href = 'index.html';
            } else {
                console.log("Rol del usuario recuperado del localStorage:", rolUsuario); // Depuración
                cargarUsuarios();
                cargarEmpresas();
            }
        };
    </script>

    <h2>Usuarios Registrados</h2>
    <select id="usuariosSelect" onchange="mostrarDatosUsuario()">
        <option value="">Seleccionar Usuario</option>
    </select>
</div>
</body>
</html>
