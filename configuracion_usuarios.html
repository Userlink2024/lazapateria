<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Usuarios</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            width: 100%;
            max-width: 600px;
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        label {
            margin-top: 10px;
            font-weight: bold;
            color: #555;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #218838;
        }
        .actions {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .actions button {
            flex: 1 1 auto;
            margin: 5px;
        }
        .restricted-access {
            text-align: center;
            color: red;
            font-weight: bold;
            margin-top: 20px;
        }
        .loading-message {
            text-align: center;
            font-style: italic;
            color: #777;
            margin-top: 20px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script>
        // firebaseConfig.js
const firebaseConfig = {
    apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
    authDomain: "lazapateria-c4157.firebaseapp.com",
    projectId: "lazapateria-c4157",
    storageBucket: "lazapateria-c4157.firebasestorage.app",
    messagingSenderId: "300241769138",
    appId: "1:300241769138:web:8ca1847de3c4fb5042afab",
    measurementId: "G-HVG7615JEE"
};

        // Inicializar Firebase App
        const app = firebase.initializeApp(firebaseConfig);

        // Inicializar Firebase Authentication
        const auth = firebase.auth(app);

        // Inicializar Firebase Realtime Database
        const database = firebase.database(app);

        let authCheckComplete = false; // Flag para indicar que la verificación inicial de auth se completó

        async function verificarAutenticacionYRol() {
            const container = document.querySelector('.container');
            container.innerHTML = '<div class="loading-message">Verificando autenticación...</div>';

            auth.onAuthStateChanged(async (user) => {
                console.log("Estado de autenticación en configuración:", user);
                authCheckComplete = true;

                if (user) {
                    try {
                        const userRef = database.ref(`usuarios/${user.uid}`);
                        userRef.once('value', (snapshot) => {
                            const userData = snapshot.val();
                            console.log("Datos del usuario desde Realtime Database:", userData);
                            if (userData && userData.permisos) {
                                const rolUsuario = userData.permisos;
                                console.log("Rol del usuario desde Realtime Database:", rolUsuario);
                                if (rolUsuario === 'Administrador') {
                                    // Si es administrador, cargar la configuración
                                    renderAdminPanel(container);
                                    cargarUsuarios();
                                    cargarEmpresas();
                                } else {
                                    // Si no es administrador, mostrar mensaje de acceso denegado
                                    container.innerHTML = '<div class="restricted-access">Acceso denegado. No tienes permisos de administrador para ver esta página.</div>';
                                    console.warn("Acceso denegado: El usuario no es administrador.");
                                    // Opcionalmente, redirigir a otra página para operadores
                                    // window.location.href = 'pagina_para_operadores.html';
                                }
                            } else {
                                console.warn("No se encontraron permisos de usuario en Realtime Database para el UID:", user.uid);
                                alert("No se encontraron los permisos del usuario. Por favor, inicia sesión nuevamente.");
                                window.location.href = 'index.html';
                            }
                        });
                    } catch (error) {
                        console.error("Error al obtener la información del usuario desde Realtime Database:", error);
                        alert("Error al cargar la configuración. Intenta nuevamente.");
                        window.location.href = 'index.html';
                    }
                } else {
                    console.log("Usuario no autenticado en configuración.");
                    alert("No estás autenticado. Por favor, inicia sesión.");
                    window.location.href = 'index.html';
                }
            });
        }

        function renderAdminPanel(container) {
            container.innerHTML = `
                <h1>Configuración de Usuarios</h1>
                <p id="estadoUsuarios">Cargando...</p>
                <div id="usuarios-content"></div>
                <h2>Registrar un nuevo usuario</h2>
                <form id="registroForm" onsubmit="event.preventDefault(); registrarUsuario();">
                    <label for="usuarioRegistro">Usuario:</label>
                    <input type="text" id="usuarioRegistro" name="usuarioRegistro">
                    <label for="nombreCompleto">Nombre completo:</label>
                    <input type="text" id="nombreCompleto" name="nombreCompleto">
                    <label for="tipoDocumento">Tipo de documento:</label>
                    <input type="text" id="tipoDocumento" name="tipoDocumento">
                    <label for="celular">Celular:</label>
                    <input type="text" id="celular" name="celular">
                    <label for="correo">Correo:</label>
                    <input type="email" id="correo" name="correo">
                    <label for="direccion">Dirección:</label>
                    <input type="text" id="direccion" name="direccion">
                    <label for="municipio">Municipio:</label>
                    <input type="text" id="municipio" name="municipio">
                    <label for="tipoContrato">Tipo de contrato:</label>
                    <select id="tipoContrato" name="tipoContrato">
                        <option value="Fijo">Fijo</option>
                        <option value="Temporal">Temporal</option>
                        <option value="Indefinido">Indefinido</option>
                    </select>
                    <label for="permisos">Permisos:</label>
                    <select id="permisos" name="permisos">
                        <option value="Administrador">Administrador</option>
                        <option value="Operador">Operador</option>
                    </select>
                    <label for="nuevaEmpresa">Nueva Empresa (si no está en la lista):</label>
                    <input type="text" id="nuevaEmpresa" name="nuevaEmpresa">
                    <label for="empresaSeleccionadaRegistro">Seleccionar Empresa:</label>
                    <select id="empresaSeleccionadaRegistro" name="empresaSeleccionadaRegistro">
                        <option value="">Seleccionar Empresa</option>
                    </select>
                    <label for="contraseña">Contraseña:</label>
                    <input type="password" id="contraseña" name="contraseña">
                    <div class="actions">
                        <button type="submit">Registrar</button>
                        <button type="button" onclick="modificarUsuario()">Modificar</button>
                        <button type="button" onclick="eliminarUsuario()">Eliminar</button>
                    </div>
                </form>
                <h2>Usuarios Registrados</h2>
                <select id="usuariosSelect" onchange="mostrarDatosUsuario()">
                    <option value="">Seleccionar Usuario</option>
                </select>
            `;
            // No es necesario re-enlazar scripts aquí si las funciones ya están definidas globalmente
        }

        window.onload = () => {
            verificarAutenticacionYRol();
        };

        // Funciones para cargar empresas y usuarios
        async function cargarUsuarios() {
            document.getElementById('estadoUsuarios').textContent = "Cargando usuarios...";
            try {
                const snapshot = await database.ref('usuarios').once('value');
                const usuariosData = snapshot.val();
                const usuariosSelect = document.getElementById('usuariosSelect');
                if (!usuariosSelect) {
                    throw new Error("usuariosSelect no está definido.");
                }
                usuariosSelect.innerHTML = '<option value="">Seleccionar Usuario</option>';
                if (usuariosData) {
                    Object.keys(usuariosData).forEach(uid => {
                        const usuario = usuariosData[uid];
                        const option = document.createElement('option');
                        option.value = uid;
                        option.textContent = usuario.nombreCompleto || usuario.usuario || uid; // Intenta mostrar nombre, usuario o UID
                        usuariosSelect.appendChild(option);
                    });
                }
                document.getElementById('estadoUsuarios').textContent = "Usuarios cargados correctamente.";
            } catch (error) {
                document.getElementById('estadoUsuarios').textContent = "Error al cargar usuarios: " + error.message;
            }
        }

        async function cargarEmpresas() {
            const empresaSelect = document.getElementById('empresaSeleccionadaRegistro');
            empresaSelect.innerHTML = '<option value="">Seleccionar Empresa</option>';
            try {
                const snapshot = await database.ref('empresas').once('value');
                const empresasData = snapshot.val();
                if (empresasData) {
                    Object.values(empresasData).forEach(empresa => {
                        const option = document.createElement('option');
                        option.value = empresa.nombre;
                        option.textContent = empresa.nombre;
                        empresaSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error cargando empresas: ", error);
            }
        }
    </script>
</head>
<body>
    <div class="container">
        Cargando...
    </div>
</body>
</html>
<script>
        // ... (Aquí iría la Parte 1 del código HTML y los scripts de inicialización de Firebase,
        //        la función verificarAutenticacionYRol, renderAdminPanel, cargarUsuarios y cargarEmpresas)

        async function registrarUsuario() {
            const nombreCompleto = document.getElementById("nombreCompleto").value;
            const tipoDocumento = document.getElementById("tipoDocumento").value;
            const celular = document.getElementById("celular").value;
            const correo = document.getElementById("correo").value;
            const direccion = document.getElementById("direccion").value;
            const municipio = document.getElementById("municipio").value;
            const tipoContrato = document.getElementById("tipoContrato").value;
            const permisos = document.getElementById("permisos").value;
            const nuevaEmpresa = document.getElementById("nuevaEmpresa").value;
            const empresaSeleccionada = document.getElementById("empresaSeleccionadaRegistro").value;
            const usuario = document.getElementById("usuarioRegistro").value;
            const contraseña = document.getElementById("contraseña").value;
            const empresa = nuevaEmpresa || empresaSeleccionada;

            if (!nombreCompleto || !empresa || !usuario || !contraseña || !correo) {
                alert("Por favor, complete todos los campos obligatorios.");
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(correo, contraseña);
                const uid = userCredential.user.uid;

                await database.ref(`usuarios/${uid}`).set({
                    nombreCompleto,
                    tipoDocumento,
                    celular,
                    correo,
                    direccion,
                    municipio,
                    tipoContrato,
                    permisos,
                    empresa,
                    usuario
                });

                if (nuevaEmpresa && !(await empresaExiste(nuevaEmpresa))) {
                    const newEmpresaRef = database.ref(`empresas`).push();
                    await newEmpresaRef.set({ nombre: nuevaEmpresa });
                }

                alert("Usuario registrado: " + nombreCompleto + " (Usuario: " + usuario + ") en la empresa " + empresa);
                cargarUsuarios();
                cargarEmpresas();
                document.getElementById('registroForm').reset();

            } catch (error) {
                console.error("Error al registrar usuario:", error);
                alert("Error al registrar usuario: " + error.message);
            }
        }

        async function empresaExiste(nombreEmpresa) {
            const snapshot = await database.ref('empresas').orderByChild('nombre').equalTo(nombreEmpresa).once('value');
            return snapshot.val() !== null;
        }

        async function modificarUsuario() {
            const usuarioId = document.getElementById('usuariosSelect').value;
            const nombreCompleto = document.getElementById("nombreCompleto").value;
            const tipoDocumento = document.getElementById("tipoDocumento").value;
            const celular = document.getElementById("celular").value;
            const correo = document.getElementById("correo").value;
            const direccion = document.getElementById("direccion").value;
            const municipio = document.getElementById("municipio").value;
            const tipoContrato = document.getElementById("tipoContrato").value;
            const permisos = document.getElementById("permisos").value;
            const empresa = document.getElementById("empresaSeleccionadaRegistro").value;
            const contraseña = document.getElementById("contraseña").value;
            const usuarioRegistro = document.getElementById("usuarioRegistro").value;

            if (!usuarioId || !nombreCompleto || !empresa || !usuarioRegistro || !contraseña || !correo) {
                alert("Por favor, seleccione un usuario y complete los campos obligatorios.");
                return;
            }

            const userRef = database.ref(`usuarios/${usuarioId}`);
            await userRef.update({
                nombreCompleto,
                tipoDocumento,
                celular,
                correo,
                direccion,
                municipio,
                tipoContrato,
                permisos,
                empresa,
                usuario: usuarioRegistro,
                contraseña
            });

            alert("Usuario modificado con éxito.");
            cargarUsuarios();
        }

        async function eliminarUsuario() {
            const usuarioId = document.getElementById('usuariosSelect').value;

            if (!usuarioId) {
                alert("Por favor, seleccione un usuario.");
                return;
            }

            if (confirm("¿Está seguro de que desea eliminar este usuario?")) {
                try {
                    // Obtener el correo electrónico del usuario antes de intentar eliminarlo de Auth
                    const snapshot = await database.ref(`usuarios/${usuarioId}`).once('value');
                    const userData = snapshot.val();
                    if (userData && userData.correo) {
                        try {
                            await auth.deleteUser(usuarioId);
                            console.log(`Usuario con UID ${usuarioId} eliminado de Authentication.`);
                        } catch (authError) {
                            console.error("Error al eliminar usuario de Authentication:", authError);
                            alert("Error al eliminar la cuenta de autenticación del usuario. Es posible que deba hacerlo manualmente desde Firebase.");
                        }
                    }
                    await database.ref(`usuarios/${usuarioId}`).remove();
                    alert("Usuario eliminado con éxito de la base de datos.");
                    cargarUsuarios();
                    document.getElementById('registroForm').reset();
                } catch (error) {
                    console.error("Error al eliminar usuario de la base de datos:", error);
                    alert("Error al eliminar usuario: " + error.message);
                }
            }
        }

        async function mostrarDatosUsuario() {
            const usuarioId = document.getElementById('usuariosSelect').value;
            if (usuarioId) {
                const userRef = database.ref(`usuarios/${usuarioId}`);
                userRef.once('value', (snapshot) => {
                    const usuario = snapshot.val();
                    if (usuario) {
                        document.getElementById('usuarioRegistro').value = usuario.usuario || '';
                        document.getElementById('nombreCompleto').value = usuario.nombreCompleto || '';
                        document.getElementById('tipoDocumento').value = usuario.tipoDocumento || '';
                        document.getElementById('celular').value = usuario.celular || '';
                        document.getElementById('correo').value = usuario.correo || '';
                        document.getElementById('direccion').value = usuario.direccion || '';
                        document.getElementById('municipio').value = usuario.municipio || '';
                        document.getElementById('tipoContrato').value = usuario.tipoContrato || '';
                        document.getElementById('permisos').value = usuario.permisos || '';
                        document.getElementById('empresaSeleccionadaRegistro').value = usuario.empresa || '';
                        document.getElementById('contraseña').value = usuario.contraseña || '';
                    }
                });
            } else {
                document.getElementById('registroForm').reset();
            }
        }
    </script>
