<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Usuarios</title>
    <style>
        /* ... (Tu CSS original) ... */
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <script>
        // Configuración de Firebase
const firebaseConfig = {
    apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
    authDomain: "lazapateria-c4157.firebaseapp.com",
    projectId: "lazapateria-c4157",
    storageBucket: "lazapateria-c4157.firebasestorage.app",
    messagingSenderId: "300241769138",
    appId: "1:300241769138:web:8ca1847de3c4fb5042afab",
    measurementId: "G-HVG7615JEE"
};

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); // Inicializar Firebase Auth

        async function verificarAutenticacionYRol() {
            auth.onAuthStateChanged(async (user) => {
                console.log("Estado de autenticación:", user);
                if (user) {
                    // Usuario autenticado, ahora obtener su rol desde Firestore
                    try {
                        const userDoc = await db.collection('usuarios').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            const rolUsuario = userData.permisos; // Asumiendo que el rol está en el campo 'permisos'
                            console.log("Rol del usuario desde Firestore:", rolUsuario);

                            if (rolUsuario === 'Administrador') {
                                // El usuario es administrador, cargar la página de configuración
                                cargarUsuarios();
                                cargarEmpresas();
                                // Puedes mostrar el contenido de la página aquí o dejar que las funciones de carga lo hagan
                            } else {
                                // El usuario no es administrador, mostrar mensaje de acceso denegado
                                alert("Acceso denegado. Solo los administradores pueden acceder a esta página.");
                                window.location.href = 'index.html'; // Redirigir a otra página
                            }
                        } else {
                            console.warn("No se encontraron datos del usuario en Firestore para el UID:", user.uid);
                            alert("No se encontraron los datos del usuario. Por favor, inicia sesión nuevamente.");
                            window.location.href = 'index.html';
                        }
                    } catch (error) {
                        console.error("Error al obtener la información del usuario:", error);
                        alert("Error al cargar la configuración. Intenta nuevamente.");
                        window.location.href = 'index.html';
                    }
                } else {
                    // No hay usuario autenticado, redirigir a la página de inicio de sesión
                    alert("No estás autenticado. Por favor, inicia sesión.");
                    window.location.href = 'index.html';
                }
            });
        }

        window.onload = verificarAutenticacionYRol;

        async function cargarUsuarios() {
            document.getElementById('estadoUsuarios').textContent = "Cargando usuarios...";
            try {
                const snapshot = await db.collection('usuarios').get();
                const usuariosSelect = document.getElementById('usuariosSelect');
                if (!usuariosSelect) {
                    throw new Error("usuariosSelect no está definido.");
                }
                usuariosSelect.innerHTML = '<option value="">Seleccionar Usuario</option>';
                snapshot.forEach(doc => {
                    const usuario = doc.data().nombreCompleto;
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = usuario;
                    usuariosSelect.appendChild(option);
                });
                document.getElementById('estadoUsuarios').textContent = "Usuarios cargados correctamente.";
            } catch (error) {
                document.getElementById('estadoUsuarios').textContent = "Error al cargar usuarios: " + error.message;
            }
        }

        async function cargarEmpresas() {
            const empresaSelect = document.getElementById('empresaSeleccionadaRegistro');
            empresaSelect.innerHTML = '<option value="">Seleccionar Empresa</option>';
            try {
                const snapshot = await db.collection('empresas').get();
                snapshot.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.data().nombre;
                    option.textContent = doc.data().nombre;
                    empresaSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error cargando empresas: ", error);
            }
        }

        async function registrarUsuario() {
            const nombreCompleto = document.getElementById("nombreCompleto").value;
            const tipoDocumento = document.getElementById("tipoDocumento").value;
            const celular = document.getElementById("celular").value;
            const correo = document.getElementById("correo").value;
            const direccion = document.getElementById("direccion").value;
            const municipio = document.getElementById("municipio").value;
            const tipoContrato = document.getElementById("tipoContrato").value;
            const permisos = document.getElementById("permisos").value;
            const nuevaEmpresa = document.getElementById("nuevaEmpresa").value;
            const empresaSeleccionada = document.getElementById("empresaSeleccionadaRegistro").value;
            const usuario = document.getElementById("usuarioRegistro").value;
            const contraseña = document.getElementById("contraseña").value;
            const empresa = nuevaEmpresa || empresaSeleccionada;

            if (!nombreCompleto || !empresa || !usuario || !contraseña || !correo) {
                alert("Por favor, complete todos los campos obligatorios.");
                return;
            }

            if (nuevaEmpresa && !(await empresaExiste(nuevaEmpresa))) {
                await db.collection('empresas').add({ nombre: nuevaEmpresa });
            }

            try {
                await db.collection('usuarios').add({
                    nombreCompleto,
                    tipoDocumento,
                    celular,
                    correo,
                    direccion,
                    municipio,
                    tipoContrato,
                    permisos,
                    empresa,
                    usuario,
                    contraseña // ¡Importante! Considera la seguridad de almacenar contraseñas en Firestore
                });
                alert("Usuario registrado: " + nombreCompleto + " (Usuario: " + usuario + ") en la empresa " + empresa);
                cargarUsuarios();
                cargarEmpresas();
                document.querySelector('form').reset();
            } catch (error) {
                console.error("Error registrando usuario: ", error);
            }
        }

        async function empresaExiste(nombreEmpresa) {
            const snapshot = await db.collection('empresas').where('nombre', '==', nombreEmpresa).get();
            return !snapshot.empty;
        }

        async function modificarUsuario() {
            const usuarioId = document.getElementById('usuariosSelect').value;
            const nombreCompleto = document.getElementById("nombreCompleto").value;
            const tipoDocumento = document.getElementById("tipoDocumento").value;
            const celular = document.getElementById("celular").value;
            const correo = document.getElementById("correo").value;
            const direccion = document.getElementById("direccion").value;
            const municipio = document.getElementById("municipio").value;
            const tipoContrato = document.getElementById("tipoContrato").value;
            const permisos = document.getElementById("permisos").value;
            const empresa = document.getElementById("empresaSeleccionadaRegistro").value;
            const contraseña = document.getElementById("contraseña").value;

            if (!nombreCompleto || !empresa || !usuarioId || !contraseña || !correo) {
                alert("Por favor, complete todos los campos obligatorios.");
                return;
            }

            try {
                await db.collection('usuarios').doc(usuarioId).update({
                    nombreCompleto,
                    tipoDocumento,
                    celular,
                    correo,
                    direccion,
                    municipio,
                    tipoContrato,
                    permisos,
                    empresa,
                    usuario: document.getElementById("usuarioRegistro").value,
                    contraseña // ¡Importante! Considera la seguridad de almacenar contraseñas en Firestore
                });
                alert("Usuario modificado con éxito.");
                cargarUsuarios();
            } catch (error) {
                console.error("Error modificando usuario: ", error);
            }
        }

        async function eliminarUsuario() {
            const usuarioId = document.getElementById('usuariosSelect').value;

            if (!usuarioId) {
                alert("Por favor, seleccione un usuario.");
                return;
            }

            try {
                await db.collection('usuarios').doc(usuarioId).delete();
                alert("Usuario eliminado con éxito.");
                cargarUsuarios();
                document.querySelector('form').reset();
            } catch (error) {
                console.error("Error eliminando usuario: ", error);
            }
        }

        async function mostrarDatosUsuario() {
            const usuarioId = document.getElementById('usuariosSelect').value;
            if (usuarioId) {
                try {
                    const usuarioDoc = await db.collection('usuarios').doc(usuarioId).get();
                    if (usuarioDoc.exists) {
                        const usuario = usuarioDoc.data();
                        document.getElementById('usuarioRegistro').value = usuario.usuario || '';
                        document.getElementById('nombreCompleto').value = usuario.nombreCompleto || '';
                        document.getElementById('tipoDocumento').value = usuario.tipoDocumento || '';
                        document.getElementById('celular').value = usuario.celular || '';
                        document.getElementById('correo').value = usuario.correo || '';
                        document.getElementById('direccion').value = usuario.direccion || '';
                        document.getElementById('municipio').value = usuario.municipio || '';
                        document.getElementById('tipoContrato').value = usuario.tipoContrato || '';
                        document.getElementById('permisos').value = usuario.permisos || '';
                        document.getElementById('empresaSeleccionadaRegistro').value = usuario.empresa || '';
                        document.getElementById('contraseña').value = usuario.contraseña || ''; // Mostrar la contraseña
                    }
                } catch (error) {
                    console.error("Error obteniendo datos del usuario: ", error);
                }
            } else {
                document.querySelector('form').reset();
            }
        }
    </script>

    <div class="container">
        <h1>Configuración de Usuarios</h1>
        <p id="estadoUsuarios"></p>
        <h2>Registrar un nuevo usuario</h2>
        <form onsubmit="event.preventDefault(); registrarUsuario();">
            <label for="usuarioRegistro">Usuario:</label>
            <input type="text" id="usuarioRegistro" name="usuarioRegistro">

            <label for="nombreCompleto">Nombre completo:</label>
            <input type="text" id="nombreCompleto" name="nombreCompleto">

            <label for="tipoDocumento">Tipo de documento:</label>
            <input type="text" id="tipoDocumento" name="tipoDocumento">

            <label for="celular">Celular:</label>
            <input type="text" id="celular" name="celular">

            <label for="correo">Correo:</label>
            <input type="email" id="correo" name="correo">

            <label for="direccion">Dirección:</label>
            <input type="text" id="direccion" name="direccion">

            <label for="municipio">Municipio:</label>
            <input type="text" id="municipio" name="municipio">

            <label for="tipoContrato">Tipo de contrato:</label>
            <select id="tipoContrato" name="tipoContrato">
                <option value="Fijo">Fijo</option>
                <option value="Temporal">Temporal</option>
                <option value="Indefinido">Indefinido</option>
            </select>

            <label for="permisos">Permisos:</label>
            <select id="permisos" name="permisos">
                <option value="Administrador">Administrador</option>
                <option value="Operador">Operador</option>
            </select>

            <label for="nuevaEmpresa">Nueva Empresa (si no está en la lista):</label>
            <input type="text" id="nuevaEmpresa" name="nuevaEmpresa">

            <label for="empresaSeleccionadaRegistro">Seleccionar Empresa:</label>
            <select id="empresaSeleccionadaRegistro" name="empresaSeleccionadaRegistro">
                <option value="">Seleccionar Empresa</option>
            </select>

            <label for="contraseña">Contraseña:</label>
            <input type="password" id="contraseña" name="contraseña">

            <div class="actions">
                <button type="submit">Registrar</button>
                <button type="button" onclick="modificarUsuario()">Modificar</button>
                <button type="button" onclick="eliminarUsuario()">Eliminar</button>
            </div>
        </form>

        <h2>Usuarios Registrados</h2>
        <select id="usuariosSelect" onchange="mostrarDatosUsuario()">
            <option value="">Seleccionar Usuario</option>
        </select>
    </div>
</body>
</html>
