<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Historial de Ventas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root{
            --bg:#f6f8ff;
            --panel:#ffffff;
            --stroke:#e6eaf2;
            --text:#0b1220;
            --muted:#52607a;
            --brand1:#6d5efc; --brand2:#25b1ff;
            --good:#18c37e; --warn:#ffb020; --bad:#ff4d4f;
            --shadow:0 18px 50px rgba(16, 24, 40, .12);
        }
        *{box-sizing:border-box}
        body{
            margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
            background:
                radial-gradient(1200px 600px at 15% 10%, rgba(109,94,252,.16), transparent 62%),
                radial-gradient(1100px 700px at 85% 15%, rgba(37,177,255,.12), transparent 62%),
                var(--bg);
        }
        .wrap{max-width:1280px;margin:0 auto;padding:22px 16px 38px}
        .top{
            display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
            padding:14px 14px;border:1px solid var(--stroke);background:var(--panel);border-radius:16px;box-shadow:var(--shadow)
        }
        h1{margin:0;font-size:18px;letter-spacing:-.02em}
        .sub{margin-top:4px;color:var(--muted);font-size:12px}
        .btn{
            border:1px solid var(--stroke);
            background:#ffffff;
            color:var(--text);
            padding:10px 12px;
            border-radius:12px;
            cursor:pointer;
            font-weight:700;
            text-decoration:none;
            display:inline-flex;
            gap:8px;
            align-items:center
        }
        .btn.primary{border-color:rgba(109,94,252,.35);background:linear-gradient(135deg, rgba(109,94,252,.95), rgba(37,177,255,.85))}
        .btn.danger{border-color:rgba(255,77,79,.4);background:linear-gradient(135deg, rgba(255,77,79,.92), rgba(255,176,32,.5))}
        .panel{margin-top:12px;border:1px solid var(--stroke);background:var(--panel);border-radius:16px;box-shadow:var(--shadow)}
        .filters{display:grid;grid-template-columns:1.2fr .8fr .7fr .7fr .6fr;gap:10px;padding:12px;border-bottom:1px solid var(--stroke)}
        @media(max-width:1100px){.filters{grid-template-columns:1fr 1fr}}
        @media(max-width:620px){.filters{grid-template-columns:1fr}}
        label{font-size:12px;color:var(--muted)}
        input,select,textarea{
            width:100%;
            border:1px solid var(--stroke);
            background:#ffffff;
            color:var(--text);
            border-radius:12px;
            padding:10px 12px;
            outline:none
        }
        .summary{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--stroke)}
        .chip{padding:8px 10px;border:1px solid var(--stroke);border-radius:999px;background:#f4f7ff;color:var(--muted);font-size:12px;font-weight:700}
        .chip strong{color:var(--text)}
        .list{padding:10px;display:grid;grid-template-columns:1fr;gap:10px}
        .card{border:1px solid var(--stroke);background:#ffffff;border-radius:14px;padding:12px}
        .head{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;border-bottom:1px dashed rgba(20, 30, 60, .18);padding-bottom:10px;margin-bottom:10px}
        .code{font-weight:900;font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(109,94,252,.10);border:1px solid rgba(109,94,252,.22)}
        .meta .dt{color:var(--muted);font-size:12px;font-weight:700;margin-left:8px}
        .meta .cliente{margin-top:6px;font-weight:900}
        .meta .line{margin-top:4px;color:var(--muted);font-size:13px}
        .badges{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
        .badge{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;border:1px solid var(--stroke);background:#f7f9ff}
        .badge.good{border-color:rgba(24,195,126,.35);background:rgba(24,195,126,.10)}
        .badge.warn{border-color:rgba(255,176,32,.35);background:rgba(255,176,32,.12)}
        .badge.bad{border-color:rgba(255,77,79,.35);background:rgba(255,77,79,.10)}
        .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
        @media(max-width:980px){.grid{grid-template-columns:1fr}}
        .box{border:1px solid var(--stroke);background:#f7f9ff;border-radius:12px;padding:10px}
        .box .lbl{color:var(--muted);font-size:12px}
        .box .val{margin-top:4px;font-weight:900}
        ul{margin:8px 0 0;padding-left:18px;color:var(--muted)}
        .actions{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:10px}
        .toggle{display:inline-flex;gap:10px;align-items:center;padding:8px 10px;border-radius:12px;border:1px solid var(--stroke);background:#f4f7ff}
        .toggle input{width:18px;height:18px}

        .tools{position:relative;display:inline-flex;align-items:center}
        .tools-menu{position:absolute;right:0;top:calc(100% + 10px);min-width:220px;z-index:999;
            border:1px solid var(--stroke);background:#ffffff;border-radius:14px;box-shadow:var(--shadow);padding:8px;display:none}
        .tools-menu.open{display:block}
        .tools-menu .btn{width:100%;justify-content:center}
        .iconbtn{width:42px;justify-content:center}

        .pagination{display:flex;gap:10px;align-items:center;justify-content:center;padding:12px;border-top:1px solid var(--stroke);background:#ffffff}
        .page-info{color:var(--muted);font-size:12px;font-weight:800}

        /* Modal tema claro */
        .modal{position:fixed;inset:0;background:rgba(240,245,255,.92);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
        .modal.open{display:flex}
        .modal-card{width:min(760px,100%);border:1px solid rgba(20, 30, 60, .10);background:#ffffff;border-radius:16px;box-shadow:0 24px 70px rgba(8, 15, 35, .20);overflow:hidden;color:var(--text);display:flex;flex-direction:column;max-height:calc(100vh - 36px)}
        .modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(20, 30, 60, .10);flex:0 0 auto}
        .modal-head h3{margin:0;font-size:15px}
        .x{width:38px;height:38px;border-radius:12px;border:1px solid rgba(20, 30, 60, .14);background:rgba(240,245,255,.9);color:#0b1220;cursor:pointer;font-size:18px;font-weight:900}
        .modal-body{padding:14px;overflow:auto;flex:1 1 auto;min-height:0}
        .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        @media(max-width:760px){.form-grid{grid-template-columns:1fr}}
        textarea{min-height:92px;resize:vertical}
        .modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid rgba(20, 30, 60, .10);flex:0 0 auto}

        /* Inputs claros dentro del modal */
        .modal-card input, .modal-card textarea, .modal-card select{
            border:1px solid rgba(20, 30, 60, .14);
            background:#ffffff;
            color:var(--text);
        }
        .modal-card label{color:var(--muted)}

        .checklist{border:1px solid rgba(20, 30, 60, .14);border-radius:12px;background:#ffffff;padding:10px;max-height:180px;overflow:auto}
        .checklist .row{display:flex;align-items:center;gap:10px;padding:6px 4px}
        .checklist .row input{width:18px;height:18px}
        .checklist .row span{color:var(--text);font-weight:700;font-size:13px}

        .abonos{border:1px solid rgba(20, 30, 60, .14);border-radius:12px;background:#ffffff;padding:10px;display:grid;gap:8px}
        .abono-row{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end}
        @media(max-width:620px){.abono-row{grid-template-columns:1fr;align-items:stretch}}
        .abono-row .btn{justify-content:center}
    </style>
</head>
<body>
    <div class="wrap">
        <div class="top">
            <div>
                <h1>Historial de Ventas</h1>
                <div class="sub" id="subtitle">Vista administrativa en tiempo real</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                <div class="tools">
                    <button class="btn iconbtn" id="toolsBtn" type="button" title="Herramientas">⚙</button>
                    <div class="tools-menu" id="toolsMenu" aria-hidden="true">
                        <button class="btn" id="exportExcelBtn" type="button">Descargar Excel</button>
                        <button class="btn" id="importExcelBtn" type="button">Importar</button>
                        <input id="importExcelFile" type="file" accept=".xlsx,.xls" style="display:none" />
                    </div>
                </div>
                <a class="btn" href="https://userlink2024.github.io/lazapateria/paneldecuentas.html">Volver</a>
                <a class="btn" href="generar_pedidos.html">Volver a Generar Pedidos</a>
                <button class="btn primary" id="resetBtn" type="button">Limpiar filtros</button>
            </div>
        </div>

        <div class="panel">
            <div class="filters">
                <div>
                    <label for="searchInput">Búsqueda</label>
                    <input id="searchInput" type="text" placeholder="Cliente, código, productos, asesor, transportadora..." />
                </div>
                <div>
                    <label for="asesorSelect">Asesor</label>
                    <select id="asesorSelect"><option value="">Todos</option></select>
                </div>
                <div>
                    <label for="fromDate">Desde</label>
                    <input id="fromDate" type="date" />
                </div>
                <div>
                    <label for="toDate">Hasta</label>
                    <input id="toDate" type="date" />
                </div>
                <div>
                    <label for="statusSelect">Estado</label>
                    <select id="statusSelect">
                        <option value="all">Todos</option>
                        <option value="despachados">Despachados</option>
                        <option value="noDespachados">No despachados</option>
                    </select>
                </div>
                <div>
                    <label for="bloqueadoSelect">Bloqueado</label>
                    <select id="bloqueadoSelect">
                        <option value="all">Todos</option>
                        <option value="si">Sí</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div style="display:flex; align-items:flex-end;">
                    <button class="btn primary" id="searchBtn" type="button" style="width:100%; justify-content:center;">Buscar</button>
                </div>
            </div>

            <div class="summary">
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div class="chip">Registros: <strong id="sumCount">0</strong></div>
                    <div class="chip">Pares: <strong id="sumPares">0</strong></div>
                    <div class="chip">Valor: <strong id="sumValor">$0</strong></div>
                </div>
                <div style="color:var(--muted); font-size:12px; font-weight:700;" id="liveState">Conectando…</div>
            </div>

            <div class="list" id="list"></div>

            <div class="pagination" id="pagination" style="display:none;">
                <button class="btn" type="button" id="prevPage">Anterior</button>
                <div class="page-info" id="pageInfo">Página 1 de 1</div>
                <button class="btn" type="button" id="nextPage">Siguiente</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editModal" aria-hidden="true">
        <div class="modal-card">
            <div class="modal-head">
                <h3>Editar pedido</h3>
                <button class="x" type="button" id="closeEdit">×</button>
            </div>
            <div class="modal-body">
                <div style="color:var(--muted); font-size:12px; font-weight:700; margin-bottom:10px;">
                    ID: <span id="editId" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;"></span>
                </div>
                <div class="form-grid">
                    <div>
                        <label for="editCliente">Cliente</label>
                        <input id="editCliente" type="text" />
                    </div>
                    <div>
                        <label for="editAsesor">Asesor</label>
                        <select id="editAsesor"></select>
                    </div>
                    <div>
                        <label for="editFecha">Fecha</label>
                        <input id="editFecha" type="date" />
                    </div>
                    <div>
                        <label for="editHora">Hora</label>
                        <input id="editHora" type="time" step="1" />
                    </div>
                    <div>
                        <label for="editTransportadora">Transportadora</label>
                        <select id="editTransportadora"></select>
                    </div>
                    <div>
                        <label for="editModalidadEnvio">Modalidad</label>
                        <select id="editModalidadEnvio">
                            <option value="">(sin definir)</option>
                            <option value="PAGO_EN_CASA">Pago en casa</option>
                            <option value="ENVIO_NORMAL">Envío normal</option>
                        </select>
                    </div>
                    <div>
                        <label for="editNumPares">Número de pares</label>
                        <input id="editNumPares" type="number" />
                    </div>
                    <div>
                        <label for="editValorTotal">Valor total</label>
                        <input id="editValorTotal" type="number" />
                    </div>
                    <div>
                        <label for="editSaldo">Saldo a favor</label>
                        <input id="editSaldo" type="number" />
                    </div>
                    <div>
                        <label for="editDespachadoPor">Despachado por</label>
                        <select id="editDespachadoPor"></select>
                    </div>
                    <div>
                        <label style="display:flex;align-items:center;gap:10px;color:var(--text);font-weight:900;">
                            <input id="editBloqueado" type="checkbox" />
                            Bloqueado
                        </label>
                    </div>
                    <div>
                        <label for="editBloqueadoPor">Bloqueado por</label>
                        <select id="editBloqueadoPor"></select>
                    </div>
                    <div style="grid-column:1 / -1;">
                        <label>Bodeguero(s)</label>
                        <div id="editBodeguerosList" class="checklist"></div>
                    </div>
                    <div style="grid-column:1 / -1;">
                        <label>Abonos</label>
                        <div id="editAbonosList" class="abonos"></div>
                        <div style="display:flex;justify-content:flex-end;margin-top:8px;">
                            <button class="btn" type="button" id="addAbonoBtn">Agregar abono</button>
                        </div>
                    </div>
                    <div style="grid-column:1 / -1;">
                        <label for="editObs">Observaciones</label>
                        <textarea id="editObs"></textarea>
                    </div>
                    <div style="grid-column:1 / -1;">
                        <label style="display:flex;align-items:center;gap:10px;color:var(--text);font-weight:900;">
                            <input id="editEnviadoEmpaque" type="checkbox" />
                            Enviado a empaque
                        </label>
                        <div style="color:var(--muted);font-size:12px;margin-top:6px;font-weight:600;">Este checkbox solo se puede marcar (no desmarcar) para mantener la lógica del sistema.</div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn" type="button" id="cancelEdit">Cancelar</button>
                <button class="btn primary" type="button" id="saveEdit">Guardar cambios</button>
            </div>
        </div>
    </div>

    <div class="modal" id="appModal" aria-hidden="true">
        <div class="modal-card" style="width:min(560px,100%);">
            <div class="modal-head">
                <h3 id="appModalTitle">Mensaje</h3>
                <button class="x" type="button" id="appModalClose">×</button>
            </div>
            <div class="modal-body" style="padding-top:12px;">
                <div id="appModalMessage" style="color:var(--text);font-weight:700;line-height:1.35;"></div>
            </div>
            <div class="modal-actions" id="appModalActions"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
            authDomain: "lazapateria-c4157.firebaseapp.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.firebasestorage.app",
            measurementId: "G-HVG7615JEE"
        };

        if (!firebase.apps || !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        let datosUsuario = null;
        try { datosUsuario = JSON.parse(localStorage.getItem('datosUsuario')); } catch (e) { datosUsuario = null; }

        const $ = (id) => document.getElementById(id);

        // --- Sonidos (igual que generar_pedidos.html) ---
        let audioContext = null;

        function initAudioContext() {
            if (!audioContext) {
                try {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    audioContext = AC ? new AC() : null;
                } catch (e) {
                    audioContext = null;
                }
            }
        }

        function playTone(frequency, duration, volume, type) {
            initAudioContext();
            if (!audioContext) return;
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.type = type || 'square';
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                gainNode.gain.setValueAtTime(volume || 0.7, audioContext.currentTime);
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + (duration || 0.05));
            } catch (e) {
                // Silencioso
            }
        }

        function playConfirmationSound() {
            playTone(880, 0.05, 0.7, 'square');
        }

        function enforceAdminAccess() {
            const permisos = (datosUsuario && datosUsuario.permisos) ? String(datosUsuario.permisos).toLowerCase() : '';
            if (permisos !== 'administrador') {
                modalAlert('Acceso restringido', 'Esta página es solo para administradores.').finally(() => {
                    window.location.href = 'https://userlink2024.github.io/lazapateria/index.html';
                });
                throw new Error('Acceso denegado');
            }
        }

        enforceAdminAccess();

        const listEl = $('list');
        const liveStateEl = $('liveState');
        const asesorSelect = $('asesorSelect');
        const searchInput = $('searchInput');
        const statusSelect = $('statusSelect');
        const bloqueadoSelect = $('bloqueadoSelect');
        const fromDate = $('fromDate');
        const toDate = $('toDate');
        const sumCount = $('sumCount');
        const sumPares = $('sumPares');
        const sumValor = $('sumValor');

        const paginationEl = $('pagination');
        const prevPageBtn = $('prevPage');
        const nextPageBtn = $('nextPage');
        const pageInfoEl = $('pageInfo');

        let appModalResolve = null;

        function openAppModal({ title, message, actions }) {
            $('appModalTitle').textContent = title || 'Mensaje';
            $('appModalMessage').textContent = message || '';
            const actionsEl = $('appModalActions');
            actionsEl.innerHTML = '';
            (actions || []).forEach(a => {
                const b = document.createElement('button');
                b.type = 'button';
                b.className = a.className || 'btn';
                b.textContent = a.label || 'Aceptar';
                b.addEventListener('click', () => {
                    if (typeof a.onClick === 'function') {
                        a.onClick();
                    } else {
                        closeAppModal(null);
                    }
                });
                actionsEl.appendChild(b);
            });
            $('appModal').classList.add('open');
            $('appModal').setAttribute('aria-hidden', 'false');
        }

        function closeAppModal(result) {
            $('appModal').classList.remove('open');
            $('appModal').setAttribute('aria-hidden', 'true');
            const r = appModalResolve;
            appModalResolve = null;
            if (typeof r === 'function') r(result);
        }

        function modalAlert(title, message, buttonLabel) {
            return new Promise((resolve) => {
                appModalResolve = resolve;
                openAppModal({
                    title: title || 'Mensaje',
                    message: message || '',
                    actions: [{ label: buttonLabel || 'Aceptar', className: 'btn primary', onClick: () => closeAppModal(true) }]
                });
            });
        }

        function modalConfirm(title, message, yesLabel, noLabel) {
            return new Promise((resolve) => {
                appModalResolve = resolve;
                openAppModal({
                    title: title || 'Confirmar',
                    message: message || '',
                    actions: [
                        { label: noLabel || 'Cancelar', className: 'btn', onClick: () => closeAppModal(false) },
                        { label: yesLabel || 'Sí', className: 'btn primary', onClick: () => closeAppModal(true) }
                    ]
                });
            });
        }

        $('appModalClose').addEventListener('click', () => closeAppModal(null));
        $('appModal').addEventListener('click', (e) => { if (e.target === $('appModal')) closeAppModal(null); });

        function formatCurrency(value) {
            const n = Number(value || 0);
            return '$' + (Number.isFinite(n) ? n.toLocaleString('es-CO') : '0');
        }

        function formatDateTime(ts) {
            if (!ts || typeof ts.toDate !== 'function') return 'N/A';
            const d = ts.toDate();
            const datePart = d.toLocaleDateString('es-CO');
            const timePart = d.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            return datePart + ', ' + timePart;
        }

        function formatDateYMD(d) {
            const yyyy = String(d.getFullYear());
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function formatTimeHMS(d) {
            const hh = String(d.getHours()).padStart(2, '0');
            const mi = String(d.getMinutes()).padStart(2, '0');
            const ss = String(d.getSeconds()).padStart(2, '0');
            return `${hh}:${mi}:${ss}`;
        }

        function normalizeStr(v) { return String(v || '').trim().toLowerCase(); }

        function buildSearchBlob(r) {
            const productos = Array.isArray(r.productos) ? r.productos : [];
            const abonos = Array.isArray(r.abonos) ? r.abonos : [];
            const bodegueros = Array.isArray(r.bodegueros_encargados) ? r.bodegueros_encargados : [];
            const prodText = productos.map(p => [p.referencia, p.color, p.talla, p.precio].filter(Boolean).join(' ')).join(' | ');
            const abonosText = abonos.map(a => [a.fecha, a.monto].filter(Boolean).join(' ')).join(' | ');
            return normalizeStr([
                r.codigo_unico, r.cliente, r.asesor, r.transportadora, r.modalidad_envio, r.usuario, r.observaciones,
                prodText, abonosText, bodegueros.join(' ')
            ].join(' '));
        }

        let allRegistros = [];
        let unsubscribe = null;
        let editingRecord = null;

        let hasLoaded = false;
        let editMetaLoaded = false;
        let editMetaLoadingPromise = null;

        const usuariosCollection = db.collection('usuarios');
        let cachedAsesores = [];
        let cachedBodegueros = [];
        let cachedAdmins = [];
        let usuariosMap = new Map(); // usuario -> nombreCompleto

        const transportadorasCollection = db.collection('transportadoras');
        let cachedTransportadoras = [];

        const PAGE_SIZE = 10;
        const REALTIME_LIMIT = 300;
        let currentPage = 1;
        let totalPages = 1;

        const RANGE_FETCH_BATCH_SIZE = 500;
        const RANGE_FETCH_MAX_ROWS = 20000;

        async function ensureEditMetaLoaded() {
            if (editMetaLoaded) return;
            if (editMetaLoadingPromise) return editMetaLoadingPromise;
            editMetaLoadingPromise = Promise.all([
                loadUsuariosForEdit().catch(() => {}),
                loadTransportadorasForEdit().catch(() => {})
            ]).finally(() => {
                editMetaLoaded = true;
                editMetaLoadingPromise = null;
            });
            return editMetaLoadingPromise;
        }

        function clampPage() {
            if (!Number.isFinite(currentPage) || currentPage < 1) currentPage = 1;
            if (!Number.isFinite(totalPages) || totalPages < 1) totalPages = 1;
            if (currentPage > totalPages) currentPage = totalPages;
        }

        function updatePaginationUI() {
            clampPage();
            if (totalPages <= 1) {
                paginationEl.style.display = 'none';
                return;
            }
            paginationEl.style.display = 'flex';
            pageInfoEl.textContent = `Página ${currentPage} de ${totalPages}`;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }

        function updateAsesorOptions() {
            const current = asesorSelect.value;
            const set = new Set();
            allRegistros.forEach(r => { if (r.asesor) set.add(String(r.asesor)); });
            const sorted = Array.from(set).sort((a, b) => a.localeCompare(b, 'es'));
            asesorSelect.innerHTML = '<option value="">Todos</option>';
            sorted.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a;
                opt.textContent = a;
                asesorSelect.appendChild(opt);
            });
            const still = Array.from(asesorSelect.options).some(o => o.value === current);
            asesorSelect.value = still ? current : '';
        }

        async function loadUsuariosForEdit() {
            try {
                const [operadoresSnapshot, bodeguerosSnapshot, adminsSnapshot] = await Promise.all([
                    usuariosCollection.where('permisos', '==', 'Operador').get(),
                    usuariosCollection.where('permisos', '==', 'Bodeguero').get(),
                    usuariosCollection.where('permisos', '==', 'Administrador').get()
                ]);

                cachedAsesores = [];
                operadoresSnapshot.forEach(doc => {
                    const d = doc.data() || {};
                    if (d.nombreCompleto && d.usuario) {
                        cachedAsesores.push(String(d.nombreCompleto));
                        usuariosMap.set(String(d.nombreCompleto), String(d.usuario));
                    }
                });
                cachedAsesores = Array.from(new Set(cachedAsesores)).sort((a, b) => a.localeCompare(b, 'es'));

                cachedBodegueros = [];
                bodeguerosSnapshot.forEach(doc => {
                    const d = doc.data() || {};
                    if (d.nombreCompleto) cachedBodegueros.push(String(d.nombreCompleto));
                });
                cachedBodegueros = Array.from(new Set(cachedBodegueros)).sort((a, b) => a.localeCompare(b, 'es'));

                cachedAdmins = [];
                adminsSnapshot.forEach(doc => {
                    const d = doc.data() || {};
                    if (d.nombreCompleto) cachedAdmins.push(String(d.nombreCompleto));
                });
                cachedAdmins = Array.from(new Set(cachedAdmins)).sort((a, b) => a.localeCompare(b, 'es'));

                const editAsesorSelect = $('editAsesor');
                if (editAsesorSelect) {
                    editAsesorSelect.innerHTML = '';
                    if (!cachedAsesores.length) {
                        const opt = document.createElement('option');
                        opt.value = '';
                        opt.textContent = 'Sin asesores';
                        editAsesorSelect.appendChild(opt);
                    } else {
                        cachedAsesores.forEach(n => {
                            const opt = document.createElement('option');
                            opt.value = n;
                            opt.textContent = n;
                            editAsesorSelect.appendChild(opt);
                        });
                    }
                }

                renderBodeguerosChecklist([]);
            } catch (e) {
                renderBodeguerosChecklist([]);
            }
        }

        function renderAdminsSelect(selectEl, currentValue) {
            if (!selectEl) return;
            selectEl.innerHTML = '';

            const empty = document.createElement('option');
            empty.value = '';
            empty.textContent = '—';
            selectEl.appendChild(empty);

            cachedAdmins.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                opt.textContent = n;
                selectEl.appendChild(opt);
            });

            const desired = String(currentValue || '').trim();
            const exists = Array.from(selectEl.options).some(o => o.value === desired);
            selectEl.value = exists ? desired : '';
        }

        async function loadTransportadorasForEdit() {
            try {
                const snap = await transportadorasCollection.orderBy('name').get();
                cachedTransportadoras = [];
                snap.forEach(doc => {
                    const d = doc.data() || {};
                    if (d.name) cachedTransportadoras.push(String(d.name));
                });
                cachedTransportadoras = Array.from(new Set(cachedTransportadoras)).sort((a, b) => a.localeCompare(b, 'es'));

                const sel = $('editTransportadora');
                if (sel) {
                    sel.innerHTML = '';
                    if (!cachedTransportadoras.length) {
                        const opt = document.createElement('option');
                        opt.value = '';
                        opt.textContent = 'Sin transportadoras';
                        sel.appendChild(opt);
                    } else {
                        cachedTransportadoras.forEach(n => {
                            const opt = document.createElement('option');
                            opt.value = n;
                            opt.textContent = n;
                            sel.appendChild(opt);
                        });
                    }
                }
            } catch (e) {
                cachedTransportadoras = [];
                const sel = $('editTransportadora');
                if (sel) {
                    sel.innerHTML = '';
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'Error cargando transportadoras';
                    sel.appendChild(opt);
                }
            }
        }

        function renderBodeguerosChecklist(selected) {
            const selectedSet = new Set((Array.isArray(selected) ? selected : []).map(String));
            const container = $('editBodeguerosList');
            if (!container) return;
            container.innerHTML = '';

            if (!cachedBodegueros.length) {
                container.innerHTML = '<div style="color:var(--muted);font-weight:700;font-size:12px;">No hay bodegueros cargados.</div>';
                return;
            }

            const frag = document.createDocumentFragment();
            cachedBodegueros.forEach(nombre => {
                const row = document.createElement('label');
                row.className = 'row';

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = nombre;
                cb.checked = selectedSet.has(nombre);

                const sp = document.createElement('span');
                sp.textContent = nombre;

                row.appendChild(cb);
                row.appendChild(sp);
                frag.appendChild(row);
            });
            container.appendChild(frag);
        }

        function renderAbonosEditor(abonos) {
            const container = $('editAbonosList');
            if (!container) return;
            container.innerHTML = '';

            const list = Array.isArray(abonos) ? abonos : [];
            if (!list.length) {
                container.innerHTML = '<div style="color:var(--muted);font-weight:700;font-size:12px;">Sin abonos.</div>';
                return;
            }

            const frag = document.createDocumentFragment();
            list.forEach((a) => {
                const row = document.createElement('div');
                row.className = 'abono-row';

                const fechaWrap = document.createElement('div');
                const fechaLabel = document.createElement('label');
                fechaLabel.textContent = 'Fecha';
                const fecha = document.createElement('input');
                fecha.type = 'date';
                fecha.value = String((a && a.fecha) || '').trim();
                fecha.dataset.field = 'fecha';
                fechaWrap.appendChild(fechaLabel);
                fechaWrap.appendChild(fecha);

                const montoWrap = document.createElement('div');
                const montoLabel = document.createElement('label');
                montoLabel.textContent = 'Monto';
                const monto = document.createElement('input');
                monto.type = 'number';
                monto.step = '1';
                monto.value = (a && a.monto != null) ? String(a.monto) : '';
                monto.dataset.field = 'monto';
                montoWrap.appendChild(montoLabel);
                montoWrap.appendChild(monto);

                const del = document.createElement('button');
                del.type = 'button';
                del.className = 'btn danger';
                del.textContent = 'Quitar';
                del.addEventListener('click', () => {
                    row.remove();
                    if (!container.querySelector('.abono-row')) {
                        container.innerHTML = '<div style="color:var(--muted);font-weight:700;font-size:12px;">Sin abonos.</div>';
                    }
                });

                row.appendChild(fechaWrap);
                row.appendChild(montoWrap);
                row.appendChild(del);
                frag.appendChild(row);
            });
            container.appendChild(frag);
        }

        function addEmptyAbonoRow() {
            const container = $('editAbonosList');
            if (!container) return;
            if (!container.querySelector('.abono-row')) container.innerHTML = '';

            const row = document.createElement('div');
            row.className = 'abono-row';

            const fechaWrap = document.createElement('div');
            const fechaLabel = document.createElement('label');
            fechaLabel.textContent = 'Fecha';
            const fecha = document.createElement('input');
            fecha.type = 'date';
            fecha.dataset.field = 'fecha';
            fechaWrap.appendChild(fechaLabel);
            fechaWrap.appendChild(fecha);

            const montoWrap = document.createElement('div');
            const montoLabel = document.createElement('label');
            montoLabel.textContent = 'Monto';
            const monto = document.createElement('input');
            monto.type = 'number';
            monto.step = '1';
            monto.dataset.field = 'monto';
            montoWrap.appendChild(montoLabel);
            montoWrap.appendChild(monto);

            const del = document.createElement('button');
            del.type = 'button';
            del.className = 'btn danger';
            del.textContent = 'Quitar';
            del.addEventListener('click', () => {
                row.remove();
                if (!container.querySelector('.abono-row')) {
                    container.innerHTML = '<div style="color:var(--muted);font-weight:700;font-size:12px;">Sin abonos.</div>';
                }
            });

            row.appendChild(fechaWrap);
            row.appendChild(montoWrap);
            row.appendChild(del);
            container.appendChild(row);
        }

        function getAbonosFromEditor() {
            const container = $('editAbonosList');
            if (!container) return [];
            const rows = Array.from(container.querySelectorAll('.abono-row'));
            const parsed = rows.map(row => {
                const fecha = row.querySelector('input[data-field="fecha"]');
                const monto = row.querySelector('input[data-field="monto"]');
                const fechaVal = String((fecha && fecha.value) || '').trim();
                const montoVal = Number((monto && monto.value) || NaN);
                return { fecha: fechaVal, monto: montoVal };
            }).filter(a => a.fecha && Number.isFinite(a.monto));
            return parsed;
        }

        function getSelectedBodeguerosFromChecklist() {
            const container = $('editBodeguerosList');
            if (!container) return [];
            return Array.from(container.querySelectorAll('input[type="checkbox"]'))
                .filter(x => x.checked)
                .map(x => String(x.value));
        }

        function applyFilters(list) {
            const q = normalizeStr(searchInput.value);
            const asesor = normalizeStr(asesorSelect.value);
            const status = statusSelect.value;
            const bloqueadoFilter = bloqueadoSelect ? String(bloqueadoSelect.value || 'all') : 'all';
            const from = fromDate.value ? new Date(fromDate.value + 'T00:00:00') : null;
            const to = toDate.value ? new Date(toDate.value + 'T23:59:59') : null;

            return list.filter(r => {
                if (asesor && normalizeStr(r.asesor) !== asesor) return false;
                if (status === 'despachados' && r.despachado !== true) return false;
                if (status === 'noDespachados' && r.despachado === true) return false;
                if (bloqueadoFilter === 'si' && r.bloqueado !== true) return false;
                if (bloqueadoFilter === 'no' && r.bloqueado === true) return false;
                if (from || to) {
                    if (!r.fecha_hora || typeof r.fecha_hora.toDate !== 'function') return false;
                    const d = r.fecha_hora.toDate();
                    if (from && d < from) return false;
                    if (to && d > to) return false;
                }
                if (q) {
                    const blob = r._searchBlob || (r._searchBlob = buildSearchBlob(r));
                    if (!blob.includes(q)) return false;
                }
                return true;
            });
        }

        async function openEditModal(r) {
            await ensureEditMetaLoaded();
            editingRecord = r;
            $('editId').textContent = r.id;
            $('editCliente').value = r.cliente || '';
            $('editBloqueado').checked = r.bloqueado === true;
            renderAdminsSelect($('editDespachadoPor'), r.despachadoPor || '');
            renderAdminsSelect($('editBloqueadoPor'), r.bloqueadoPor || '');
            if (r.fecha_hora && typeof r.fecha_hora.toDate === 'function') {
                const d = r.fecha_hora.toDate();
                const yyyy = String(d.getFullYear());
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const hh = String(d.getHours()).padStart(2, '0');
                const mi = String(d.getMinutes()).padStart(2, '0');
                const ss = String(d.getSeconds()).padStart(2, '0');
                $('editFecha').value = `${yyyy}-${mm}-${dd}`;
                $('editHora').value = `${hh}:${mi}:${ss}`;
            } else {
                $('editFecha').value = '';
                $('editHora').value = '';
            }
            if (cachedAsesores.length) {
                const desired = String(r.asesor || '').trim();
                const exists = Array.from($('editAsesor').options).some(o => o.value === desired);
                $('editAsesor').value = exists ? desired : (cachedAsesores[0] || '');
            } else {
                $('editAsesor').innerHTML = '';
                const opt = document.createElement('option');
                opt.value = r.asesor || '';
                opt.textContent = r.asesor || '';
                $('editAsesor').appendChild(opt);
                $('editAsesor').value = r.asesor || '';
            }
            if (cachedTransportadoras.length) {
                $('editTransportadora').value = r.transportadora || cachedTransportadoras[0] || '';
            } else {
                $('editTransportadora').innerHTML = '';
                const opt = document.createElement('option');
                opt.value = r.transportadora || '';
                opt.textContent = r.transportadora || '';
                $('editTransportadora').appendChild(opt);
                $('editTransportadora').value = r.transportadora || '';
            }
            const modSel = $('editModalidadEnvio');
            if (modSel) modSel.value = String(r.modalidad_envio || '').trim();
            $('editNumPares').value = r.num_pares != null ? r.num_pares : '';
            $('editValorTotal').value = r.valor_total != null ? r.valor_total : '';
            $('editSaldo').value = r.saldo_a_favor != null ? r.saldo_a_favor : 0;
            renderBodeguerosChecklist(Array.isArray(r.bodegueros_encargados) ? r.bodegueros_encargados : []);
            renderAbonosEditor(Array.isArray(r.abonos) ? r.abonos : []);
            $('editObs').value = r.observaciones || '';
            $('editEnviadoEmpaque').checked = r.enviadoAEmpaque === true;
            $('editModal').classList.add('open');
            $('editModal').setAttribute('aria-hidden', 'false');
        }

        $('editBloqueado').addEventListener('change', () => {
            const isOn = $('editBloqueado').checked === true;
            const sel = $('editBloqueadoPor');
            if (!sel) return;

            if (isOn) {
                if (!sel.value) {
                    const fallback = (datosUsuario && datosUsuario.nombreCompleto) ? String(datosUsuario.nombreCompleto) : '';
                    const exists = Array.from(sel.options).some(o => o.value === fallback);
                    sel.value = exists ? fallback : sel.value;
                }
            } else {
                sel.value = '';
            }
        });

        function closeEditModal() {
            $('editModal').classList.remove('open');
            $('editModal').setAttribute('aria-hidden', 'true');
            editingRecord = null;
        }

        $('closeEdit').addEventListener('click', closeEditModal);
        $('cancelEdit').addEventListener('click', closeEditModal);
        $('editModal').addEventListener('click', (e) => { if (e.target === $('editModal')) closeEditModal(); });

        $('addAbonoBtn').addEventListener('click', () => {
            addEmptyAbonoRow();
        });

        async function toggleDespachado(id, nuevoEstado) {
            await ensureEditMetaLoaded();
            if (!nuevoEstado) {
                const ok = await modalConfirm('Confirmar', '¿Estás seguro de que quieres desverificar (quitar despachado) este pedido?', 'Sí', 'Cancelar');
                if (!ok) return { reverted: true };
                await db.collection('registros').doc(id).update({ despachado: false, despachadoPor: '' });
                playConfirmationSound();
                return { reverted: false };
            }

            const docRef = db.collection('registros').doc(id);
            const snap = await docRef.get();
            const updateData = {
                despachado: true,
                despachadoPor: (cachedAdmins && cachedAdmins.length)
                    ? ((datosUsuario && datosUsuario.nombreCompleto && cachedAdmins.includes(datosUsuario.nombreCompleto)) ? datosUsuario.nombreCompleto : cachedAdmins[0])
                    : ((datosUsuario && datosUsuario.nombreCompleto) ? datosUsuario.nombreCompleto : 'Administrador')
            };

            if (snap.exists) {
                const d = snap.data();
                if (d.enviadoAEmpaque !== true) {
                    updateData.enviadoAEmpaque = true;
                    updateData.enviadoAEmpaqueTimestamp = firebase.firestore.Timestamp.fromDate(new Date());
                } else if (d.enviadoAEmpaque === true && !d.enviadoAEmpaqueTimestamp) {
                    updateData.enviadoAEmpaqueTimestamp = firebase.firestore.Timestamp.fromDate(new Date());
                }
            }

            await docRef.update(updateData);
            playConfirmationSound();
            return { reverted: false };
        }

        async function saveEdit() {
            if (!editingRecord) return;
            const docRef = db.collection('registros').doc(editingRecord.id);
            const updateData = {
                cliente: $('editCliente').value.trim(),
                asesor: String($('editAsesor').value || '').trim(),
                transportadora: String($('editTransportadora').value || '').trim(),
                modalidad_envio: String($('editModalidadEnvio') ? $('editModalidadEnvio').value : '').trim(),
                num_pares: Number($('editNumPares').value || 0),
                valor_total: Number($('editValorTotal').value || 0),
                saldo_a_favor: Number($('editSaldo').value || 0),
                despachadoPor: String($('editDespachadoPor').value || '').trim(),
                bloqueado: $('editBloqueado').checked === true,
                bloqueadoPor: ($('editBloqueado').checked === true) ? String($('editBloqueadoPor').value || '').trim() : '',
                abonos: getAbonosFromEditor(),
                bodegueros_encargados: getSelectedBodeguerosFromChecklist(),
                observaciones: $('editObs').value
            };

            // Actualizar automáticamente el campo 'usuario' si cambia el asesor
            const nuevoAsesor = String($('editAsesor').value || '').trim();
            if (nuevoAsesor && usuariosMap.has(nuevoAsesor)) {
                updateData.usuario = usuariosMap.get(nuevoAsesor);
            }

            const fechaStr = String($('editFecha').value || '').trim();
            const horaStr = String($('editHora').value || '').trim();
            if (fechaStr || horaStr) {
                const base = (editingRecord.fecha_hora && typeof editingRecord.fecha_hora.toDate === 'function')
                    ? editingRecord.fecha_hora.toDate()
                    : new Date();

                const yyyy = String(base.getFullYear());
                const mm = String(base.getMonth() + 1).padStart(2, '0');
                const dd = String(base.getDate()).padStart(2, '0');

                const hh = String(base.getHours()).padStart(2, '0');
                const mi = String(base.getMinutes()).padStart(2, '0');
                const ss = String(base.getSeconds()).padStart(2, '0');

                const finalDate = fechaStr || `${yyyy}-${mm}-${dd}`;
                const finalTime = horaStr || `${hh}:${mi}:${ss}`;
                const d = new Date(`${finalDate}T${finalTime}`);
                if (!Number.isNaN(d.getTime())) {
                    updateData.fecha_hora = firebase.firestore.Timestamp.fromDate(d);
                }
            }

            const wantsEnviado = $('editEnviadoEmpaque').checked === true;
            const snap = await docRef.get();
            if (snap.exists) {
                const d = snap.data();
                if (wantsEnviado) {
                    if (d.enviadoAEmpaque !== true) {
                        updateData.enviadoAEmpaque = true;
                        updateData.enviadoAEmpaqueTimestamp = firebase.firestore.Timestamp.fromDate(new Date());
                    } else if (d.enviadoAEmpaque === true && !d.enviadoAEmpaqueTimestamp) {
                        updateData.enviadoAEmpaqueTimestamp = firebase.firestore.Timestamp.fromDate(new Date());
                    }
                } else {
                    if (d.enviadoAEmpaque === true) {
                        $('editEnviadoEmpaque').checked = true;
                        await modalAlert('Acción no permitida', 'Enviado a empaque no se puede desmarcar.');
                    }
                }
            }

            await docRef.update(updateData);
            closeEditModal();
        }

        $('saveEdit').addEventListener('click', async () => {
            try { await saveEdit(); } catch (e) { await modalAlert('Error', 'Error al guardar cambios.'); }
        });

        function render() {
            if (!hasLoaded) {
                listEl.innerHTML = '<div class="card" style="color:var(--muted); font-weight:700;">Selecciona un rango de fechas y pulsa <strong>Buscar</strong>.</div>';
                paginationEl.style.display = 'none';
                sumCount.textContent = '0';
                sumPares.textContent = '0';
                sumValor.textContent = '$0';
                return;
            }
            const filtered = applyFilters(allRegistros);

            totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
            clampPage();
            updatePaginationUI();

            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageItems = filtered.slice(start, end);

            let totalPares = 0;
            let totalValor = 0;
            filtered.forEach(r => {
                totalPares += Number(r.num_pares || 0);
                totalValor += Number(r.valor_total || 0);
            });
            sumCount.textContent = String(filtered.length);
            sumPares.textContent = String(totalPares);
            sumValor.textContent = formatCurrency(totalValor);

            if (!filtered.length) {
                listEl.innerHTML = '<div class="card" style="color:var(--muted); font-weight:700;">No hay registros con los filtros actuales.</div>';
                updatePaginationUI();
                return;
            }

            listEl.innerHTML = '';
            const frag = document.createDocumentFragment();

            pageItems.forEach(r => {
                const card = document.createElement('div');
                card.className = 'card';

                const codigo = r.codigo_unico || 'SIN-CODIGO';
                const cliente = r.cliente || 'Sin cliente';
                const asesor = r.asesor || 'N/A';
                const transportadora = r.transportadora || 'N/A';
                const modalidadLabel = (String(r.modalidad_envio || '').toUpperCase() === 'PAGO_EN_CASA') ? 'Pago en casa'
                    : (String(r.modalidad_envio || '').toUpperCase() === 'ENVIO_NORMAL') ? 'Envío normal'
                    : 'N/A';
                const fechaStr = formatDateTime(r.fecha_hora);
                const bloqueado = r.bloqueado === true;
                const despachado = r.despachado === true;
                const bodegueros = Array.isArray(r.bodegueros_encargados) ? r.bodegueros_encargados : [];

                const productos = Array.isArray(r.productos) ? r.productos : [];

                const badges = [
                    despachado ? '<span class="badge good">DESPACHADO</span>' : '<span class="badge warn">NO DESPACHADO</span>',
                    bloqueado ? '<span class="badge bad">BLOQUEADO</span>' : ''
                ].join('');

                const productsHtml = productos.length
                    ? '<ul>' + productos.map(p => {
                        const ref = p.referencia || '';
                        const color = p.color || '';
                        const talla = p.talla || '';
                        const precio = p.precio != null ? formatCurrency(p.precio) : '';
                        const text = [ref, color, talla].filter(Boolean).join(' - ') + (precio ? (' - ' + precio) : '');
                        return '<li>' + (text || 'Producto') + '</li>';
                    }).join('') + '</ul>'
                    : '<ul><li>Sin productos</li></ul>';

                const obsText = String(r.observaciones || '').trim();
                const observacionesHtml = obsText 
                    ? `<div style="border-top:1px solid #e2e8f0;margin-top:10px;padding-top:10px"><span style="color:#64748b;font-size:11px;font-weight:700">OBSERVACIONES:</span><div style="color:#334155;font-size:13px;margin-top:4px">${obsText}</div></div>`
                    : '';

                card.innerHTML = `
                    <div class="head">
                        <div class="meta">
                            <div><span class="code">${codigo}</span><span class="dt">${fechaStr}</span></div>
                            <div class="cliente">${cliente}</div>
                            <div class="line">Asesor: <strong>${asesor}</strong> · Transportadora: <strong>${transportadora}</strong> · Modalidad: <strong>${modalidadLabel}</strong></div>
                        </div>
                        <div class="badges">${badges}</div>
                    </div>

                    <div class="grid">
                        <div class="box">
                            <div class="lbl">Productos</div>
                            ${productsHtml}
                            ${observacionesHtml}
                        </div>
                        <div style="display:grid; gap:10px;">
                            <div class="box"><div class="lbl">Pares</div><div class="val">${Number(r.num_pares || 0)}</div></div>
                            <div class="box"><div class="lbl">Valor total</div><div class="val">${formatCurrency(r.valor_total || 0)}</div></div>
                            <div class="box"><div class="lbl">Saldo a favor</div><div class="val">${formatCurrency(r.saldo_a_favor || 0)}</div></div>
                            <div class="box"><div class="lbl">Bodegueros</div><div class="val">${bodegueros.length ? bodegueros.join(', ') : 'N/A'}</div></div>
                        </div>
                    </div>

                    <div class="actions">
                        <label class="toggle" title="Marcar/Desmarcar despachado">
                            <input type="checkbox" ${despachado ? 'checked' : ''} data-action="toggle-despachado" />
                            <span style="font-weight:900">Despachado</span>
                        </label>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                            <button class="btn" type="button" data-action="edit">Editar</button>
                            <button class="btn danger" type="button" data-action="delete">Eliminar</button>
                        </div>
                    </div>
                `;

                const toggle = card.querySelector('[data-action="toggle-despachado"]');
                toggle.addEventListener('change', async (ev) => {
                    const nuevo = ev.target.checked;
                    try {
                        const res = await toggleDespachado(r.id, nuevo);
                        if (res.reverted) ev.target.checked = !nuevo;
                        render();
                    } catch (e) {
                        ev.target.checked = !nuevo;
                        await modalAlert('Error', 'Error al actualizar despachado.');
                    }
                });

                card.querySelector('[data-action="edit"]').addEventListener('click', () => openEditModal(r));
                card.querySelector('[data-action="delete"]').addEventListener('click', async () => {
                    const ok = await modalConfirm('Confirmar', '¿Eliminar este pedido definitivamente?', 'Eliminar', 'Cancelar');
                    if (!ok) return;
                    try {
                        await db.collection('registros').doc(r.id).delete();
                        allRegistros = allRegistros.filter(x => String(x.id) !== String(r.id));
                        const remaining = applyFilters(allRegistros);
                        totalPages = Math.max(1, Math.ceil(remaining.length / PAGE_SIZE));
                        if (currentPage > totalPages) currentPage = totalPages;
                        render();
                        await modalAlert('Eliminado', 'El pedido fue eliminado.');
                    }
                    catch (e) {
                        console.error('Error eliminando registro:', e);
                        await modalAlert('Error', 'Error al eliminar.');
                    }
                });

                frag.appendChild(card);
            });

            listEl.appendChild(frag);
        }

        function attachFilterListeners() {
            const rerenderResetPage = () => { currentPage = 1; render(); };
            searchInput.addEventListener('input', rerenderResetPage);
            asesorSelect.addEventListener('change', rerenderResetPage);
            statusSelect.addEventListener('change', rerenderResetPage);
            if (bloqueadoSelect) bloqueadoSelect.addEventListener('change', rerenderResetPage);
            fromDate.addEventListener('change', rerenderResetPage);
            toDate.addEventListener('change', rerenderResetPage);

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage -= 1;
                    render();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage += 1;
                    render();
                }
            });

            $('resetBtn').addEventListener('click', () => {
                searchInput.value = '';
                asesorSelect.value = '';
                statusSelect.value = 'all';
                if (bloqueadoSelect) bloqueadoSelect.value = 'all';
                fromDate.value = '';
                toDate.value = '';
                currentPage = 1;
                allRegistros = [];
                hasLoaded = false;
                liveStateEl.textContent = 'Selecciona fechas y pulsa Buscar';
                render();
            });
        }

        async function loadRegistrosByDateRange() {
            const fromStr = String(fromDate.value || '').trim();
            const toStr = String(toDate.value || '').trim();
            if (!fromStr || !toStr) {
                await modalAlert('Falta rango de fechas', 'Selecciona <strong>Desde</strong> y <strong>Hasta</strong> para buscar.');
                return;
            }

            const from = new Date(fromStr + 'T00:00:00');
            const to = new Date(toStr + 'T23:59:59');
            if (Number.isNaN(from.getTime()) || Number.isNaN(to.getTime()) || from > to) {
                await modalAlert('Rango inválido', 'Revisa las fechas seleccionadas.');
                return;
            }

            if (unsubscribe) { unsubscribe(); unsubscribe = null; }
            hasLoaded = false;
            liveStateEl.textContent = 'Buscando…';
            listEl.innerHTML = '<div class="card" style="color:var(--muted); font-weight:700;">Buscando registros…</div>';
            paginationEl.style.display = 'none';

            try {
                const fromTs = firebase.firestore.Timestamp.fromDate(from);
                const toTs = firebase.firestore.Timestamp.fromDate(to);

                async function fetchRegistrosByDateRangePaged() {
                    const rows = [];
                    let lastDoc = null;
                    while (true) {
                        let q = db.collection('registros')
                            .orderBy('fecha_hora', 'desc')
                            .where('fecha_hora', '>=', fromTs)
                            .where('fecha_hora', '<=', toTs)
                            .limit(RANGE_FETCH_BATCH_SIZE);
                        if (lastDoc) q = q.startAfter(lastDoc);

                        const snap = await q.get();
                        const docs = snap.docs || [];
                        docs.forEach(d => {
                            const data = d.data() || {};
                            data.id = d.id;
                            data._searchBlob = null;
                            rows.push(data);
                        });
                        if (!docs.length) break;
                        lastDoc = docs[docs.length - 1];
                        if (docs.length < RANGE_FETCH_BATCH_SIZE) break;
                        if (rows.length >= RANGE_FETCH_MAX_ROWS) break;
                    }
                    return rows;
                }

                function mergeSnapshotIntoAllRegistros(snap) {
                    const byId = new Map();
                    (Array.isArray(allRegistros) ? allRegistros : []).forEach(r => {
                        if (r && r.id != null) byId.set(String(r.id), r);
                    });
                    (snap && snap.docs ? snap.docs : []).forEach(d => {
                        const data = d.data() || {};
                        data.id = d.id;
                        data._searchBlob = null;
                        byId.set(String(d.id), data);
                    });
                    allRegistros = Array.from(byId.values()).sort((a, b) => {
                        const at = a.fecha_hora && typeof a.fecha_hora.toMillis === 'function' ? a.fecha_hora.toMillis() : 0;
                        const bt = b.fecha_hora && typeof b.fecha_hora.toMillis === 'function' ? b.fecha_hora.toMillis() : 0;
                        return bt - at;
                    });
                }

                // 1) Carga completa del rango (sin límite)
                allRegistros = await fetchRegistrosByDateRangePaged();
                hasLoaded = true;
                currentPage = 1;
                updateAsesorOptions();
                liveStateEl.textContent = 'Cargado · ' + new Date().toLocaleTimeString('es-CO');
                render();

                // 2) Listener en vivo (mergea, no reemplaza)
                const qLive = db.collection('registros')
                    .orderBy('fecha_hora', 'desc')
                    .where('fecha_hora', '>=', fromTs)
                    .where('fecha_hora', '<=', toTs)
                    .limit(REALTIME_LIMIT);

                unsubscribe = qLive.onSnapshot((snap) => {
                    mergeSnapshotIntoAllRegistros(snap);
                    updateAsesorOptions();
                    liveStateEl.textContent = 'En vivo · ' + new Date().toLocaleTimeString('es-CO');
                    render();
                }, (e) => {
                    console.error('Error cargando por fecha (tiempo real):', e);
                    liveStateEl.textContent = 'Error';
                    if (!hasLoaded) {
                        listEl.innerHTML = '<div class="card" style="color:var(--muted); font-weight:700;">Error al cargar datos.</div>';
                        modalAlert('Error', 'No se pudo cargar la información.');
                    }
                });
            } catch (e) {
                console.error('Error cargando por fecha:', e);
                liveStateEl.textContent = 'Error';
                listEl.innerHTML = '<div class="card" style="color:var(--muted); font-weight:700;">Error al cargar datos.</div>';
                await modalAlert('Error', 'No se pudo cargar la información.');
            }
        }

        attachFilterListeners();
        $('searchBtn').addEventListener('click', loadRegistrosByDateRange);

        function closeToolsMenu() {
            const m = $('toolsMenu');
            if (!m) return;
            m.classList.remove('open');
            m.setAttribute('aria-hidden', 'true');
        }

        function toggleToolsMenu() {
            const m = $('toolsMenu');
            if (!m) return;
            const isOpen = m.classList.contains('open');
            if (isOpen) closeToolsMenu();
            else {
                m.classList.add('open');
                m.setAttribute('aria-hidden', 'false');
            }
        }

        const EXCEL_HEADERS_V1 = [
            'Fecha',
            'Hora',
            'Código',
            'Cliente',
            'Asesor',
            'Usuario',
            'Transportadora',
            'Pares',
            'Valor total',
            'Saldo a favor',
            'Despachado',
            'Bloqueado',
            'Bodegueros',
            'Observaciones',
            'Productos(JSON)',
            'Abonos(JSON)',
            'ID'
        ];

        const EXCEL_HEADERS_V2 = [
            'Fecha',
            'Hora',
            'Código',
            'Cliente',
            'Asesor',
            'Usuario',
            'Transportadora',
            'Modalidad',
            'Pares',
            'Valor total',
            'Saldo a favor',
            'Despachado',
            'Bloqueado',
            'Bodegueros',
            'Observaciones',
            'Productos(JSON)',
            'Abonos(JSON)',
            'ID'
        ];

        const EXCEL_HEADERS = EXCEL_HEADERS_V2;

        function normalizeHeader(v) {
            return String(v || '').trim().toLowerCase();
        }

        function headersMatch(actual, expected) {
            if (!Array.isArray(actual)) return false;
            if (actual.length < expected.length) return false;
            for (let i = 0; i < expected.length; i++) {
                if (normalizeHeader(actual[i]) !== normalizeHeader(expected[i])) return false;
            }
            return true;
        }

        function buildExcelAoAFromRegistros(registros) {
            const aoa = [EXCEL_HEADERS.slice()];

            (Array.isArray(registros) ? registros : []).forEach(r => {
                const ts = r.fecha_hora;
                const d = (ts && typeof ts.toDate === 'function') ? ts.toDate() : null;
                const fecha = d ? formatDateYMD(d) : '';
                const hora = d ? formatTimeHMS(d) : '';

                const productos = Array.isArray(r.productos) ? r.productos : [];
                const abonos = Array.isArray(r.abonos) ? r.abonos : [];
                const bodegueros = Array.isArray(r.bodegueros_encargados) ? r.bodegueros_encargados : [];

                const modalidad = String(r.modalidad_envio || '').trim();

                aoa.push([
                    fecha,
                    hora,
                    String(r.codigo_unico || ''),
                    String(r.cliente || ''),
                    String(r.asesor || ''),
                    String(r.usuario || ''),
                    String(r.transportadora || ''),
                    modalidad,
                    Number(r.num_pares || 0),
                    Number(r.valor_total || 0),
                    Number(r.saldo_a_favor || 0),
                    (r.despachado === true ? 'SI' : 'NO'),
                    (r.bloqueado === true ? 'SI' : 'NO'),
                    bodegueros.join(', '),
                    String(r.observaciones || ''),
                    JSON.stringify(productos),
                    JSON.stringify(abonos),
                    String(r.id || '')
                ]);
            });

            return aoa;
        }

        async function exportExcel() {
            closeToolsMenu();

            if (!(window.XLSX && XLSX.utils && XLSX.writeFile)) {
                await modalAlert('No disponible', 'No se pudo cargar la librería de Excel (xlsx).');
                return;
            }

            if (!hasLoaded) {
                await modalAlert('Sin datos', 'Primero selecciona un rango de fechas y pulsa Buscar.');
                return;
            }

            const filtered = applyFilters(allRegistros);
            if (!filtered.length) {
                await modalAlert('Sin datos', 'No hay registros con los filtros actuales para exportar.');
                return;
            }

            const aoa = buildExcelAoAFromRegistros(filtered);
            const ws = XLSX.utils.aoa_to_sheet(aoa);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ventas');

            const fromStr = String(fromDate.value || '').trim();
            const toStr = String(toDate.value || '').trim();
            const suffix = (fromStr && toStr) ? `${fromStr}_a_${toStr}` : formatDateYMD(new Date());
            const filename = `ventas_${suffix}.xlsx`;

            XLSX.writeFile(wb, filename);
        }

        function parseBoolSiNo(v) {
            const s = String(v || '').trim().toLowerCase();
            if (!s) return false;
            return s === 'si' || s === 'sí' || s === 'true' || s === '1' || s === 'x';
        }

        function safeParseJson(v, fallback) {
            if (v == null) return fallback;
            const s = String(v).trim();
            if (!s) return fallback;
            try { return JSON.parse(s); } catch (e) { return fallback; }
        }

        async function importExcelFile(file) {
            closeToolsMenu();

            if (!(window.XLSX && XLSX.utils)) {
                await modalAlert('No disponible', 'No se pudo cargar la librería de Excel (xlsx).');
                return;
            }

            if (!file) return;

            const btnImport = $('importExcelBtn');
            const btnExport = $('exportExcelBtn');
            btnImport.disabled = true;
            btnExport.disabled = true;

            try {
                const buf = await file.arrayBuffer();
                const wb = XLSX.read(buf, { type: 'array' });
                const sheetName = wb.SheetNames && wb.SheetNames[0];
                if (!sheetName) {
                    await modalAlert('Archivo inválido', 'El archivo no contiene hojas.');
                    return;
                }

                const ws = wb.Sheets[sheetName];
                const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
                if (!Array.isArray(aoa) || aoa.length < 2) {
                    await modalAlert('Archivo vacío', 'No hay filas para importar.');
                    return;
                }

                const header = aoa[0];
                const okV2WithId = headersMatch(header, EXCEL_HEADERS_V2);
                const okV2NoId = headersMatch(header, EXCEL_HEADERS_V2.slice(0, EXCEL_HEADERS_V2.length - 1));
                const okV1WithId = headersMatch(header, EXCEL_HEADERS_V1);
                const okV1NoId = headersMatch(header, EXCEL_HEADERS_V1.slice(0, EXCEL_HEADERS_V1.length - 1));
                const okAny = okV2WithId || okV2NoId || okV1WithId || okV1NoId;
                if (!okAny) {
                    await modalAlert('Formato inválido', 'El Excel no tiene el formato esperado. Exporta primero un Excel desde aquí y úsalo como plantilla.');
                    return;
                }

                const hasModalidad = okV2WithId || okV2NoId;
                const hasId = okV2WithId || okV1WithId;
                const rows = aoa.slice(1).filter(r => Array.isArray(r) && r.some(c => String(c || '').trim() !== ''));
                if (!rows.length) {
                    await modalAlert('Archivo vacío', 'No hay filas para importar.');
                    return;
                }

                const ok = await modalConfirm('Confirmar', `Se importarán ${rows.length} fila(s). ${hasId ? 'Se actualizará por ID cuando exista.' : 'Las filas sin ID se crearán como nuevos registros.'}`, 'Importar', 'Cancelar');
                if (!ok) return;

                let created = 0;
                let updated = 0;
                let skipped = 0;

                for (const r of rows) {
                    const fecha = String(r[0] || '').trim();
                    const hora = String(r[1] || '').trim();
                    const codigo = String(r[2] || '').trim();
                    const cliente = String(r[3] || '').trim();
                    const asesor = String(r[4] || '').trim();
                    const usuario = String(r[5] || '').trim();
                    const transportadora = String(r[6] || '').trim();
                    const modalidad = hasModalidad ? String(r[7] || '').trim() : '';
                    const pares = Number(r[hasModalidad ? 8 : 7] || 0);
                    const valorTotal = Number(r[hasModalidad ? 9 : 8] || 0);
                    const saldo = Number(r[hasModalidad ? 10 : 9] || 0);
                    const despachado = parseBoolSiNo(r[hasModalidad ? 11 : 10]);
                    const bloqueado = parseBoolSiNo(r[hasModalidad ? 12 : 11]);
                    const bodeguerosTxt = String(r[hasModalidad ? 13 : 12] || '').trim();
                    const observaciones = String(r[hasModalidad ? 14 : 13] || '');
                    const productos = safeParseJson(r[hasModalidad ? 15 : 14], []);
                    const abonos = safeParseJson(r[hasModalidad ? 16 : 15], []);
                    const id = hasId ? String(r[hasModalidad ? 17 : 16] || '').trim() : '';

                    if (!fecha) {
                        skipped += 1;
                        continue;
                    }

                    const dt = new Date(`${fecha}T${hora || '00:00:00'}`);
                    if (Number.isNaN(dt.getTime())) {
                        skipped += 1;
                        continue;
                    }

                    const data = {
                        codigo_unico: codigo,
                        cliente: cliente,
                        asesor: asesor,
                        usuario: usuario,
                        transportadora: transportadora,
                        modalidad_envio: modalidad,
                        num_pares: Number.isFinite(pares) ? pares : 0,
                        valor_total: Number.isFinite(valorTotal) ? valorTotal : 0,
                        saldo_a_favor: Number.isFinite(saldo) ? saldo : 0,
                        despachado: despachado,
                        bloqueado: bloqueado,
                        bodegueros_encargados: bodeguerosTxt ? bodeguerosTxt.split(',').map(s => s.trim()).filter(Boolean) : [],
                        observaciones: observaciones,
                        fecha_hora: firebase.firestore.Timestamp.fromDate(dt),
                        productos: Array.isArray(productos) ? productos : [],
                        abonos: Array.isArray(abonos) ? abonos : []
                    };

                    if (id) {
                        await db.collection('registros').doc(id).set(data, { merge: true });
                        updated += 1;
                    } else {
                        await db.collection('registros').add(data);
                        created += 1;
                    }
                }

                await modalAlert('Importación finalizada', `Actualizados: ${updated}\nCreados: ${created}\nOmitidos: ${skipped}`);
            } catch (e) {
                console.error('Error importando Excel:', e);
                await modalAlert('Error', 'No se pudo importar el archivo.');
            } finally {
                btnImport.disabled = false;
                btnExport.disabled = false;
                const inp = $('importExcelFile');
                if (inp) inp.value = '';
            }
        }

        $('toolsBtn').addEventListener('click', (e) => {
            e.preventDefault();
            toggleToolsMenu();
        });

        document.addEventListener('click', (e) => {
            const menu = $('toolsMenu');
            const btn = $('toolsBtn');
            if (!menu || !btn) return;
            if (menu.contains(e.target) || btn.contains(e.target)) return;
            closeToolsMenu();
        });

        $('exportExcelBtn').addEventListener('click', () => { exportExcel(); });
        $('importExcelBtn').addEventListener('click', () => {
            closeToolsMenu();
            $('importExcelFile').click();
        });

        $('importExcelFile').addEventListener('change', async (e) => {
            const f = e.target && e.target.files ? e.target.files[0] : null;
            await importExcelFile(f);
        });

        liveStateEl.textContent = 'Selecciona fechas y pulsa Buscar';
        render();
    </script>
</body>
</html>
