<!DOCTYPE html>
<html>
<head>
    <title>Dashboard de Metas de Ventas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base Styles - Adapted for Tailwind CSS */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f2f5 0%, #e0e6ec 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .container {
            width: 100%;
            max-width: 1200px; /* Wider container for more content */
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            padding: 2.5rem;
        }

        h1 {
            color: #2e7d32;
        }
        h2 {
            color: #28a745;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        .stat-card {
            background-color: #fdfdfd;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
        }

        .progress-bar-container {
            background-color: #e0e0e0;
            border-radius: 9999px; /* Full rounded corners */
            height: 0.75rem; /* Equivalent to h-3 */
            overflow: hidden;
        }
        .progress-bar-fill {
            background-color: #28a745; /* Green */
            height: 100%;
            width: 0%; /* Initial width */
            transition: width 0.5s ease-out;
            border-radius: 9999px; /* Full rounded corners */
        }
        .progress-bar-fill.warning {
            background-color: #ffc107; /* Yellow */
        }
        .progress-bar-fill.danger {
            background-color: #dc3545; /* Red */
        }
        .progress-bar-fill.success {
            background-color: #28a745; /* Green */
        }
    </style>
</head>
<body class="p-8 min-h-screen">
    <div class="container mx-auto p-8 bg-white shadow-xl rounded-xl">
        <h1 class="text-4xl font-bold text-center text-green-700 mb-8">Dashboard de Metas de Ventas</h1>
        <p class="text-center text-gray-600 mb-8">Sigue tu progreso de ventas diario, semanal y mensual.</p>

        <!-- Current Date and Time -->
        <div class="text-center text-lg font-semibold text-gray-700 mb-8">
            <span id="current-date"></span> <span id="current-time"></span>
        </div>

        <!-- Daily Goals Section -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-6 pb-2 border-b border-gray-200">Metas Diarias</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
            <!-- Daily Pairs -->
            <div class="stat-card p-6 rounded-lg">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Pares Vendidos Hoy</h3>
                <p class="text-3xl font-bold text-green-600 mb-4" id="daily-pairs-sold">0</p>
                <div class="text-gray-600 text-sm mb-2">Meta: <span id="daily-pairs-goal">0</span> pares</div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="daily-pairs-progress"></div>
                </div>
                <p class="text-gray-600 text-sm mt-3">Faltan: <span id="daily-pairs-remaining">0</span> pares</p>
            </div>
            <!-- Daily Value -->
            <div class="stat-card p-6 rounded-lg">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Valor de Venta Hoy</h3>
                <p class="text-3xl font-bold text-green-600 mb-4" id="daily-value-sold">$0</p>
                <div class="text-gray-600 text-sm mb-2">Meta: <span id="daily-value-goal">$0</span></div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="daily-value-progress"></div>
                </div>
                <p class="text-gray-600 text-sm mt-3">Faltan: <span id="daily-value-remaining">$0</span></p>
            </div>
        </div>

        <!-- Weekly Goals Section -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-6 pb-2 border-b border-gray-200">Metas Semanales</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
            <!-- Weekly Pairs -->
            <div class="stat-card p-6 rounded-lg">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Pares Vendidos Esta Semana</h3>
                <p class="text-3xl font-bold text-green-600 mb-4" id="weekly-pairs-sold">0</p>
                <div class="text-gray-600 text-sm mb-2">Meta: <span id="weekly-pairs-goal">0</span> pares</div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="weekly-pairs-progress"></div>
                </div>
                <p class="text-gray-600 text-sm mt-3">Faltan: <span id="weekly-pairs-remaining">0</span> pares</p>
            </div>
            <!-- Weekly Value -->
            <div class="stat-card p-6 rounded-lg">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Valor de Venta Esta Semana</h3>
                <p class="text-3xl font-bold text-green-600 mb-4" id="weekly-value-sold">$0</p>
                <div class="text-gray-600 text-sm mb-2">Meta: <span id="weekly-value-goal">$0</span></div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="weekly-value-progress"></div>
                </div>
                <p class="text-gray-600 text-sm mt-3">Faltan: <span id="weekly-value-remaining">$0</span></p>
            </div>
        </div>

        <!-- Monthly Goals Section -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-6 pb-2 border-b border-gray-200">Metas Mensuales</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Monthly Pairs -->
            <div class="stat-card p-6 rounded-lg">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Pares Vendidos Este Mes</h3>
                <p class="text-3xl font-bold text-green-600 mb-4" id="monthly-pairs-sold">0</p>
                <div class="text-gray-600 text-sm mb-2">Meta: <span id="monthly-pairs-goal">0</span> pares</div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="monthly-pairs-progress"></div>
                </div>
                <p class="text-gray-600 text-sm mt-3">Faltan: <span id="monthly-pairs-remaining">0</span> pares</p>
            </div>
            <!-- Monthly Value -->
            <div class="stat-card p-6 rounded-lg">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Valor de Venta Este Mes</h3>
                <p class="text-3xl font-bold text-green-600 mb-4" id="monthly-value-sold">$0</p>
                <div class="text-gray-600 text-sm mb-2">Meta: <span id="monthly-value-goal">$0</span></div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="monthly-value-progress"></div>
                </div>
                <p class="text-gray-600 text-sm mt-3">Faltan: <span id="monthly-value-remaining">$0</span></p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
        // Configuración de Firebase (reemplaza con tu configuración real)
        const firebaseConfig = {
            apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
            authDomain: "lazapateria-c4157.firebaseapp.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.firebasestorage.app",
            measurementId: "G-HVG7615JEE"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Datos del usuario (asumimos que ya están cargados desde localStorage o similar)
        let datosUsuario = JSON.parse(localStorage.getItem('datosUsuario')) || {
            permisos: 'operador', // Default to operator for dashboard view
            nombreCompleto: 'Asesor',
            usuario: 'asesor_default'
        };

        // Metas de ventas
        const MONTHLY_PAIRS_GOAL = 17500; // 17,500 pares al mes
        const WEEKLY_VALUE_GOAL = 17500000; // 17,500,000 por semana

        // Helper function to format currency
        const formatCurrency = (value) => `$${value.toLocaleString('es-CO')}`;

        // Function to get start and end of day/week/month
        const getStartAndEndOfPeriod = (date) => {
            // Start of today
            const startOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0);
            // End of today
            const endOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59, 999);

            // Start of the current week (Monday)
            const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Days to subtract to get to Monday
            const startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() - diff);
            startOfWeek.setHours(0, 0, 0, 0);

            // End of the current week (Sunday)
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            // Start of the current month
            const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1, 0, 0, 0, 0);
            // End of the current month
            const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59, 999); // Day 0 of next month is last day of current month

            return {
                startOfDay: firebase.firestore.Timestamp.fromDate(startOfDay),
                endOfDay: firebase.firestore.Timestamp.fromDate(endOfDay),
                startOfWeek: firebase.firestore.Timestamp.fromDate(startOfWeek),
                endOfWeek: firebase.firestore.Timestamp.fromDate(endOfWeek),
                startOfMonth: firebase.firestore.Timestamp.fromDate(startOfMonth),
                endOfMonth: firebase.firestore.Timestamp.fromDate(endOfMonth),
            };
        };

        // Function to calculate progress and update UI
        const updateProgressBar = (elementId, currentValue, goal) => {
            const progressBar = document.getElementById(elementId);
            let percentage = (goal > 0) ? (currentValue / goal) * 100 : 0;
            if (percentage > 100) percentage = 100; // Cap at 100%

            progressBar.style.width = `${percentage}%`;

            // Remove previous classes
            progressBar.classList.remove('warning', 'danger', 'success');

            // Apply color based on progress
            if (percentage < 50) {
                progressBar.classList.add('danger'); // Red
            } else if (percentage < 100) {
                progressBar.classList.add('warning'); // Yellow
            } else {
                progressBar.classList.add('success'); // Green
            }
        };

        /**
         * Fetches sales data and updates the dashboard.
         */
        const fetchSalesData = async () => {
            const now = new Date();
            const { startOfDay, endOfDay, startOfWeek, endOfWeek, startOfMonth, endOfMonth } = getStartAndEndOfPeriod(now);
            const currentUserId = datosUsuario.usuario;

            // --- Fetch Daily Sales ---
            let dailyPairsSold = 0;
            let dailyValueSold = 0;
            try {
                const dailySalesSnapshot = await db.collection('registros')
                    .where('usuario', '==', currentUserId)
                    .where('fecha_hora', '>=', startOfDay)
                    .where('fecha_hora', '<', endOfDay)
                    .get();

                dailySalesSnapshot.forEach(doc => {
                    const data = doc.data();
                    dailyPairsSold += parseInt(data.num_pares || 0);
                    dailyValueSold += parseFloat(data.valor_total || 0);
                });
            } catch (error) {
                console.error("Error fetching daily sales data:", error);
            }

            // --- Fetch Weekly Sales ---
            let weeklyPairsSold = 0;
            let weeklyValueSold = 0;
            try {
                const weeklySalesSnapshot = await db.collection('registros')
                    .where('usuario', '==', currentUserId)
                    .where('fecha_hora', '>=', startOfWeek)
                    .where('fecha_hora', '<', endOfWeek)
                    .get();

                weeklySalesSnapshot.forEach(doc => {
                    const data = doc.data();
                    weeklyPairsSold += parseInt(data.num_pares || 0);
                    weeklyValueSold += parseFloat(data.valor_total || 0);
                });
            } catch (error) {
                console.error("Error fetching weekly sales data:", error);
            }

            // --- Fetch Monthly Sales ---
            let monthlyPairsSold = 0;
            let monthlyValueSold = 0;
            try {
                const monthlySalesSnapshot = await db.collection('registros')
                    .where('usuario', '==', currentUserId)
                    .where('fecha_hora', '>=', startOfMonth)
                    .where('fecha_hora', '<', endOfMonth)
                    .get();

                monthlySalesSnapshot.forEach(doc => {
                    const data = doc.data();
                    monthlyPairsSold += parseInt(data.num_pares || 0);
                    monthlyValueSold += parseFloat(data.valor_total || 0);
                });
            } catch (error) {
                console.error("Error fetching monthly sales data:", error);
            }

            // --- Calculate Goals for Display ---
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const daysPassedInMonth = now.getDate();
            const daysRemainingInMonth = daysInMonth - daysPassedInMonth;

            // Daily Goals
            const dailyPairsGoal = MONTHLY_PAIRS_GOAL / daysInMonth; // Daily average based on monthly goal
            const dailyValueGoal = WEEKLY_VALUE_GOAL / 7; // Daily average based on weekly goal

            // Weekly Goals
            const weeklyPairsGoal = MONTHLY_PAIRS_GOAL * (7 / daysInMonth); // Weekly average based on monthly goal
            const actualDaysInCurrentWeek = 7; // A week always has 7 days for calculation purposes

            // Monthly Goals
            const monthlyValueGoal = WEEKLY_VALUE_GOAL * (daysInMonth / 7); // Monthly value based on weekly goal and days in month


            // --- Update UI ---
            // Current Date and Time
            document.getElementById('current-date').textContent = now.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('current-time').textContent = now.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });

            // Daily
            document.getElementById('daily-pairs-sold').textContent = dailyPairsSold;
            document.getElementById('daily-pairs-goal').textContent = Math.round(dailyPairsGoal);
            document.getElementById('daily-pairs-remaining').textContent = Math.max(0, Math.round(dailyPairsGoal - dailyPairsSold));
            updateProgressBar('daily-pairs-progress', dailyPairsSold, dailyPairsGoal);

            document.getElementById('daily-value-sold').textContent = formatCurrency(dailyValueSold);
            document.getElementById('daily-value-goal').textContent = formatCurrency(Math.round(dailyValueGoal));
            document.getElementById('daily-value-remaining').textContent = formatCurrency(Math.max(0, Math.round(dailyValueGoal - dailyValueSold)));
            updateProgressBar('daily-value-progress', dailyValueSold, dailyValueGoal);

            // Weekly
            document.getElementById('weekly-pairs-sold').textContent = weeklyPairsSold;
            document.getElementById('weekly-pairs-goal').textContent = Math.round(weeklyPairsGoal);
            document.getElementById('weekly-pairs-remaining').textContent = Math.max(0, Math.round(weeklyPairsGoal - weeklyPairsSold));
            updateProgressBar('weekly-pairs-progress', weeklyPairsSold, weeklyPairsGoal);

            document.getElementById('weekly-value-sold').textContent = formatCurrency(weeklyValueSold);
            document.getElementById('weekly-value-goal').textContent = formatCurrency(WEEKLY_VALUE_GOAL);
            document.getElementById('weekly-value-remaining').textContent = formatCurrency(Math.max(0, WEEKLY_VALUE_GOAL - weeklyValueSold));
            updateProgressBar('weekly-value-progress', weeklyValueSold, WEEKLY_VALUE_GOAL);

            // Monthly
            document.getElementById('monthly-pairs-sold').textContent = monthlyPairsSold;
            document.getElementById('monthly-pairs-goal').textContent = MONTHLY_PAIRS_GOAL;
            document.getElementById('monthly-pairs-remaining').textContent = Math.max(0, MONTHLY_PAIRS_GOAL - monthlyPairsSold);
            updateProgressBar('monthly-pairs-progress', monthlyPairsSold, MONTHLY_PAIRS_GOAL);

            document.getElementById('monthly-value-sold').textContent = formatCurrency(monthlyValueSold);
            document.getElementById('monthly-value-goal').textContent = formatCurrency(Math.round(monthlyValueGoal));
            document.getElementById('monthly-value-remaining').textContent = formatCurrency(Math.max(0, Math.round(monthlyValueGoal - monthlyValueSold)));
            updateProgressBar('monthly-value-progress', monthlyValueSold, monthlyValueGoal);
        };

        // Initial load and periodic refresh
        document.addEventListener('DOMContentLoaded', () => {
            fetchSalesData();
            setInterval(fetchSalesData, 60000); // Refresh data every minute (60 seconds)
        });
    </script>
</body>
</html>
