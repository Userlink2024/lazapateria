<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Consignaciones - Blindado y Final</title>

  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
      --card: rgba(255, 255, 255, 0.95);
      --accent: #4CAF50;
      --accent-hover: #45a049;
      --muted: #555;
      --border: #e8f5e8;
      --danger: #f44336;
      --ok: #4CAF50;
      --admin-gray: #e5e7eb;
      --manager-yellow: rgba(255, 193, 7, 0.2);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.15);
    }
    *{
      box-sizing:border-box;
      margin: 0;
      padding: 0;
    }
    
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin:0;
      background: var(--bg);
      color: #2e7d32;
      animation: fadeIn 0.8s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    #topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:5px 10px;
      background: var(--card);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--border);
      box-shadow: var(--shadow);
      position: relative;
      z-index: 100;
    }
    
    .layout{
      display:flex;
      height:calc(100vh - 40px);
    }
    
    .sidebar{
      width:250px;
      padding:8px;
      background: var(--card);
      backdrop-filter: blur(10px);
      border-right: 2px solid var(--border);
      overflow:auto;
      box-shadow: var(--shadow);
    }
    
    .main{
      flex:1;
      padding:8px;
      overflow:auto;
    }
    h2,h3{
      margin:0 0 5px 0;
      color: #2e7d32;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 1em;
    }

    h3 {
      position: relative;
    }

    h3::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 30px;
      height: 2px;
      background: linear-gradient(90deg, var(--accent), #66BB6A);
      border-radius: 2px;
    }
    
    label{
      display:block;
      font-size:11px;
      color: var(--muted);
      margin-bottom:2px;
      font-weight: 600;
    }
    
    input[type=text], input[type=number], input[type=date], select, textarea, input[type=password]{
      width:100%;
      padding:5px 8px;
      border: 1px solid var(--border);
      border-radius:6px;
      background: rgba(255, 255, 255, 0.9);
      font-size: 12px;
      transition: all 0.3s ease;
      color: #2e7d32;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      transform: translateY(-1px);
    }

    input:hover, select:hover, textarea:hover {
      border-color: #66BB6A;
    }
    
    textarea{resize:vertical}
    
    .btn{
      background: linear-gradient(135deg, var(--accent), #66BB6A);
      color:white;
      border:none;
      padding:4px 8px;
      border-radius:6px;
      cursor:pointer;
      font-size: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      background: linear-gradient(135deg, var(--accent-hover), #5cb85c);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
    }
    
    .btn.ghost{
      background: rgba(255, 255, 255, 0.9);
      color: var(--accent);
      border: 2px solid var(--accent);
    }

    .btn.ghost:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
    }
    
    .btn.danger{
      background: linear-gradient(135deg, var(--danger), #ef5350);
    }

    .btn.danger:hover {
      background: linear-gradient(135deg, #d32f2f, #e53935);
      box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
    }
    
    .btn.success{
      background: linear-gradient(135deg, var(--ok), #66BB6A);
    }

    .btn.success:hover {
      background: linear-gradient(135deg, var(--accent-hover), #5cb85c);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
    }
    
    .panel{
      background: var(--card);
      backdrop-filter: blur(10px);
      padding:8px;
      border-radius:8px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      margin-bottom:8px;
      animation: slideUp 0.6s ease-out;
    }

    .panel:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
      transition: all 0.3s ease;
    }
    
    .account-item{
      padding:5px;
      border-radius:6px;
      border: 1px solid var(--border);
      margin-bottom:4px;
      cursor:pointer;
      background: rgba(255, 255, 255, 0.9);
      position: relative;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      font-size: 12px;
    }

    .account-item:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
    }
    
    .account-item.selected{
      border-left: 6px solid var(--accent);
      background: rgba(76, 175, 80, 0.1);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
    }
    
    .account-item .del-btn {
      position: absolute; 
      top: 12px; 
      right: 12px; 
      color: var(--danger); 
      font-size: 18px; 
      display: none; 
      padding: 6px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .account-item .del-btn:hover { 
      background: rgba(244, 67, 54, 0.1);
      transform: scale(1.1);
    }

    .flex-row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap: wrap;
    }
    
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      table-layout: fixed;
    }
    
    th,td{
      padding:4px 6px;
      border: 1px solid var(--border);
      background:transparent;
      text-align: center;
      font-size: 11px;
    }

    th {
      background: linear-gradient(135deg, var(--accent), #66BB6A);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      font-size: 10px;
    }

    /* Filas sin verificar - fondo blanco */
    tr:nth-child(even) {
      background: transparent;
    }

    tr:hover {
      background: rgba(76, 175, 80, 0.08);
      transition: all 0.3s ease;
    }
    
    /* Filas verificadas por administrador - gris intenso */
    tr.verified-admin{
      background: var(--admin-gray) !important;
      border-left: 4px solid #6b7280;
    }
    
    tr.verified-admin:hover{
      background: #d1d5db !important;
    }
    
    /* Filas verificadas por gerente - amarillo */
    tr.verified-gerente{
      background: var(--manager-yellow) !important;
      border-left: 4px solid #FFC107;
    }
    
    tr.verified-gerente:hover{
      background: rgba(255, 193, 7, 0.3) !important;
    }
    
    /* Separadores */
    tr.separator{
      font-weight:700;
      text-align:center;
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    tr.sep-green{
      background: linear-gradient(135deg, #d1fae5, #a7f3d0)!important; 
      color: #065f46;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
    }
    
    tr.sep-red{
      background: linear-gradient(135deg, #fee2e2, #fecaca)!important; 
      color: #991b1b;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
    }
    
    /* Foco teclado */
    tr.keyboard-focus { 
      outline: 3px solid var(--accent); 
      z-index: 10; 
      position: relative;
      box-shadow: 0 0 0 6px rgba(76, 175, 80, 0.2);
    }

    .muted{
      color:var(--muted);
      font-size:14px;
      font-style: italic;
    }
    
    .top-totals{
      display:flex;
      gap:5px;
      align-items:center;
      flex-wrap: wrap;
    }
    
    .top-totals .card{
      padding:3px 6px;
      border-radius:6px;
      border: 1px solid var(--border);
      background: var(--card);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .top-totals .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .small{
      font-size:9px;
      color: var(--muted);
      font-weight: 500;
    }
    
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      animation: fadeIn 0.3s ease;
    }
    
    .modal .card{
      width:750px;
      max-width:96%;
      padding:25px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.4s ease;
    }
    
    .hidden{display:none}
    
    .gear{
      cursor:pointer;
      padding:8px;
      border-radius:10px;
      border: 2px solid var(--border);
      background: var(--card);
      transition: all 0.3s ease;
      font-size: 16px;
    }

    .gear:hover {
      border-color: var(--accent);
      background: rgba(76, 175, 80, 0.1);
      transform: scale(1.1);
    }
    
    /* Nuevo modal gen√©rico */
    #generic-modal .card{
      width:500px!important; 
      max-width:96%; 
      padding:25px; 
      position:relative;
      border-radius: 20px;
      overflow: hidden;
    }
    
    #modal-title{
      color: var(--accent); 
      margin-bottom:20px;
      font-size: 1.4em;
      font-weight: 600;
      text-align: center;
    }
    
    #modal-body{
      margin-bottom:20px;
      line-height: 1.6;
      color: #2e7d32;
    }
    
    #modal-password-input{
      margin-top:10px;
    }

    /* ESTILO DIN√ÅMICO DE ADVERTENCIA MODERNIZADO */
    .warning-icon {
        font-size: 36px;
        color: var(--danger);
        margin-right: 15px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .warning-title-container {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px 0;
        border-bottom: 2px solid var(--border);
        background: rgba(244, 67, 54, 0.05);
        border-radius: 10px;
        padding: 15px;
    }
    
    .warning-message {
        font-weight: 500;
        line-height: 1.6;
        padding-top: 10px;
        color: #2e7d32;
        background: rgba(76, 175, 80, 0.05);
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid var(--accent);
    }

    /* Modal de datos grandes */
    #data-modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      animation: fadeIn 0.3s ease;
    }

    #data-modal .modal-content {
      background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
      margin: 5% auto;
      padding: 0;
      border-radius: 20px;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      animation: slideDown 0.4s ease;
      overflow: hidden;
    }

    #data-modal .modal-header {
      background: linear-gradient(135deg, #4CAF50, #66BB6A);
      color: white;
      padding: 25px;
      text-align: center;
      position: relative;
    }

    #data-modal .modal-header h2 {
      margin: 0;
      font-size: 2em;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    #data-modal .modal-header .close {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 35px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
    }

    #data-modal .modal-header .close:hover {
      transform: translateY(-50%) scale(1.2);
      opacity: 0.8;
    }

    #data-modal .modal-body {
      padding: 40px;
      text-align: center;
      background: rgba(255, 255, 255, 0.95);
    }

    #data-modal .data-value {
      font-size: 4em;
      font-weight: 900;
      color: #2e7d32;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
    }

    #data-modal .data-label {
      font-size: 1.3em;
      color: #555;
      font-weight: 600;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #data-modal .data-icon {
      font-size: 3em;
      margin-bottom: 20px;
      opacity: 0.8;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .layout {
        flex-direction: column;
        height: auto;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 2px solid var(--border);
      }

      .top-totals {
        flex-direction: column;
        gap: 10px;
      }

      .flex-row {
        flex-direction: column;
        gap: 8px;
      }

      .modal .card {
        width: 95%;
        padding: 20px;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 8px 4px;
      }

      #data-modal .modal-content {
        width: 95%;
        margin: 10% auto;
      }

      #data-modal .data-value {
        font-size: 2.5em;
      }

      #data-modal .modal-body {
        padding: 25px;
      }
    }
  </style>
</head>
<body>

  <div id="topbar">
    <div style="display:flex;gap:6px;align-items:center">
      <strong style="font-size: 1em; color: #2e7d32; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">üí∞ Sistema de Consignaciones</strong>
      <div class="small" style="background: rgba(76, 175, 80, 0.1); padding: 1px 5px; border-radius: 10px; color: #2e7d32; font-weight: 600;">Gerencia</div>
    </div>

    <div class="top-totals">
      <div class="card small">
        <div class="muted">üíµ Total general</div>
        <div id="total-general" style="font-weight: 700; color: #2e7d32; font-size: 0.8em;">0</div>
      </div>
      <div class="card small">
        <div class="muted">üè¶ Total cuenta actual</div>
        <div id="total-cuenta" style="font-weight: 700; color: #2e7d32; font-size: 0.8em;">0</div>
      </div>
      <div class="card small">
        <div class="muted">üë§ Usuario</div>
        <div id="user-info" style="font-weight: 600; color: #2e7d32; font-size: 0.8em;">...</div>
      </div>
      <button id="open-options" class="btn ghost">‚öôÔ∏è Opciones</button>
      <button id="logout" class="btn ghost">üö™ Salir</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <h3>üîç Buscar / Cuentas</h3>
      <label>üè∑Ô∏è Buscar por nombre</label>
      <input id="search-name" type="text" placeholder="Nombre de cuenta...">
      <label style="margin-top:8px">üî¢ Buscar por n√∫mero</label>
      <input id="search-account" type="text" placeholder="N√∫mero de cuenta...">

      <div style="margin-top:6px" class="panel">
        <h4 style="margin-bottom:5px; color: #2e7d32; font-weight: 600; font-size: 0.9em;">‚ûï Nueva cuenta</h4>
        <label>üìù Nombre</label>
        <input id="new-account-name" type="text" placeholder="Nombre">
        <label style="margin-top:4px">üî¢ N√∫mero</label>
        <input id="new-account-number" type="text" placeholder="N√∫mero">
        <div style="margin-top:5px" class="flex-row">
          <button id="add-account" class="btn" style="flex:1">‚úÖ Agregar</button>
        </div>
      </div>

      <div>
        <div class="muted" style="margin-bottom:4px; font-weight: 600; color: #2e7d32; font-size: 10px;">üìã Lista de Cuentas</div>
        <div id="accounts-list" style="max-height:50vh;overflow:auto;padding-right:5px;"></div>
      </div>
    </div>

    <div class="main">
      <div class="panel">
        <h3>üí∞ Agregar consignaci√≥n</h3>
        <div id="selected-account-info" class="muted" style="margin-bottom:5px; padding: 4px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 2px solid var(--accent); font-size: 10px;">Ninguna cuenta seleccionada</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;">
            <label>üìÖ FECHA DE CONSIGNACI√ìN</label>
            <div style="display:flex;gap:5px;align-items:center;flex-wrap:wrap;margin-bottom:4px;">
              <label style="display:flex;align-items:center;gap:5px;"><input type="radio" name="dateOpt" value="today"> üìÖ Hoy</label>
              <label style="display:flex;align-items:center;gap:5px;"><input type="radio" name="dateOpt" value="yesterday"> üìÖ Ayer</label>
              <label style="display:flex;align-items:center;gap:5px;"><input type="radio" name="dateOpt" value="daybefore"> üìÖ Antier</label>
              <label style="margin-left:10px;font-weight:600;">üìù Manual:</label>
            </div>
            <input id="date-picker" type="date">
          </div>
          <div style="flex:1;min-width:200px;">
            <label>üëÅÔ∏è FECHA DE OBSERVACI√ìN</label>
            <div style="display:flex;gap:5px;align-items:center;flex-wrap:wrap;margin-bottom:4px;">
              <label style="display:flex;align-items:center;gap:5px;"><input type="radio" name="obsOpt" value="today"> üìÖ Hoy</label>
              <label style="display:flex;align-items:center;gap:5px;"><input type="radio" name="obsOpt" value="yesterday"> üìÖ Ayer</label>
              <label style="display:flex;align-items:center;gap:5px;"><input type="radio" name="obsOpt" value="daybefore"> üìÖ Antier</label>
              <label style="margin-left:10px;font-weight:600;">üìù Manual:</label>
            </div>
            <input id="obsdate-picker" type="date">
          </div>
        </div>
        <div style="margin-top:8px;display:flex;gap:6px;align-items:end;flex-wrap:wrap;">
          <div style="flex:1;min-width:120px;">
            <label>üíµ VALOR (COP)</label>
            <input id="valor" type="number" placeholder="Ingrese el valor..." style="font-size:12px;font-weight:600;">
          </div>
          <div style="min-width:140px;">
            <button id="add-consign" class="btn" style="width:100%;padding:5px;font-size:10px;">‚úÖ Agregar Consignaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center; flex-wrap:wrap; gap:5px;">
          <h3 style="margin:0">üìä Movimientos</h3>
          <div style="display:flex; gap:4px; flex-wrap:wrap;">
            <button id="btn-export-excel" class="btn success">üì• Descargar Cuenta</button>
            <button id="btn-export-master" class="btn success" style="display:none; background:linear-gradient(135deg, #7c3aed, #8b5cf6); color:white;">üì• Descargar Maestra (G)</button>

            <div style="width:2px; background:var(--border); margin:0 8px; border-radius:1px;"></div>
            <button id="btn-verify" class="btn">‚úÖ Verificado</button>
            <button id="btn-unverify" class="btn ghost">‚ùå Desverificar</button>
            <button id="btn-delete" class="btn danger" style="display:none">üóëÔ∏è Eliminar</button>
            <button id="btn-sumar" class="btn ghost">‚ûï Sumar</button>
            <button id="btn-cuadrar" class="btn ghost" style="display:none; border:2px solid var(--accent); color:var(--accent); font-weight:600;">‚úÖ Cuadrar (Corte)</button>
          </div>
        </div>

        <div style="margin-top:6px;max-height:58vh;overflow:auto;border-radius:6px;width:100%;" tabindex="0" id="table-container"></div>
          <table>
            <thead>
              <tr>
                <th>‚òëÔ∏è Sel</th>
                <th>üìÖ FECHA</th>
                <th>üíµ VALOR</th>
                <th>üëÅÔ∏è FECHA OBS</th>
                <th>üìã ESTADO</th>
              </tr>
            </thead>
            <tbody id="consigns-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-options" class="modal hidden">
    <div class="panel card" style="width:750px;max-width:96%">
      <h3 style="text-align:center; color:#2e7d32; margin-bottom:25px;">‚öôÔ∏è Opciones de Acceso</h3>
      <div style="margin-top:20px; display:flex; gap:20px; justify-content:center;">
        <label style="display:flex; align-items:center; gap:8px; padding:10px 20px; border:2px solid var(--border); border-radius:10px; cursor:pointer; transition:all 0.3s ease;">
          <input type="radio" name="sessionRole" value="Administrativo" checked> 
          <span style="font-weight:600;">üë§ Administrativo</span>
        </label>
        <label style="display:flex; align-items:center; gap:8px; padding:10px 20px; border:2px solid var(--border); border-radius:10px; cursor:pointer; transition:all 0.3s ease;">
          <input type="radio" name="sessionRole" value="Gerente"> 
          <span style="font-weight:600;">üëë Gerente</span>
        </label>
      </div>
      <div id="manager-pass-area" class="hidden" style="margin-top:20px">
        <label>üîê Clave Gerente</label>
        <input id="manager-pass" type="password" placeholder="Ingrese la clave de gerente">
      </div>
      <div style="margin-top:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="gear" id="gear-change" title="Cambiar clave">‚öôÔ∏è</span>
          <small class="muted" style="font-weight:500;">Configurar clave</small>
        </div>
        <div style="display:flex;gap:10px;">
          <button id="options-continue" class="btn">‚úÖ Continuar</button>
          <button id="options-cancel" class="btn ghost">‚ùå Cancelar</button>
        </div>
      </div>
      <div id="gear-panel" class="hidden" style="margin-top:20px; padding:15px; background:rgba(76,175,80,0.05); border-radius:10px; border:2px solid var(--border);">
        <label>üîë Nueva clave Gerente</label>
        <input id="new-manager-pass" type="text" placeholder="Ingrese nueva clave">
        <div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end">
          <button id="save-manager-pass" class="btn">üíæ Guardar</button>
          <button id="cancel-gear" class="btn ghost">‚ùå Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="generic-modal" class="modal hidden">
    <div class="panel card">
        <h4 id="modal-title" style="margin-top:0;"></h4>
        <div id="modal-body"></div>
        <div id="modal-password-area" class="hidden" style="margin-top:20px">
            <label>üîê CLAVE DE GERENTE</label>
            <input id="modal-password-input" type="password" placeholder="Ingrese la clave de gerente">
        </div>
        <div style="margin-top:25px;display:flex;gap:12px;justify-content:flex-end">
            <button id="modal-cancel-btn" class="btn ghost hidden">‚ùå Cancelar</button>
            <button id="modal-ok-btn" class="btn">‚úÖ Aceptar</button>
        </div>
    </div>
  </div>

  <!-- Modal de Datos Grandes -->
  <div id="data-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="data-modal-title">Informaci√≥n</h2>
        <span class="close" onclick="closeDataModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="data-modal-icon" class="data-icon">üí∞</div>
        <div id="data-modal-label" class="data-label">Total</div>
        <div id="data-modal-value" class="data-value">0</div>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
<script>
/* CONFIGURACI√ìN FIREBASE */
const firebaseConfig = {
  apiKey:"AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
  authDomain:"lazapateria-c4157.firebaseapp.com",
  projectId:"lazapateria-c4157",
  storageBucket:"lazapateria-c4157.firebasestorage.app",
  messagingSenderId:"300241769138",
  appId:"1:300241769138:web:8ca1847de3c4fb5042afab"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ESTADO GLOBAL */
const usuario = JSON.parse(localStorage.getItem('datosUsuario') || 'null');
if(!usuario){ showModal('Error', 'No hay sesi√≥n activa.', false, ()=>location.href='index.html'); }
if(usuario.permisos !== 'Administrador'){ showModal('Error', 'Acceso denegado.', false, ()=>location.href='index.html'); }

$('user-info').textContent = usuario.usuario;
$('logout').onclick = ()=>{ localStorage.removeItem('datosUsuario'); location.href='index.html'; };

let sessionRole = 'Administrativo';
let managerPass = '0000'; 
const settingsRef = db.collection('settings').doc('managerPassword');

function loadManagerPass() {
    settingsRef.onSnapshot(doc => {
        if (doc.exists && doc.data().password) {
            managerPass = doc.data().password;
        } else {
            // Si el documento no existe, lo creamos con una clave por defecto
            if (!doc.exists) {
                settingsRef.set({ password: '0000' }).catch(e => console.error("Error creando clave por defecto:", e));
            }
            managerPass = '0000'; 
        }
    }, error => {
        console.error("Error al cargar la clave de gerente:", error);
    });
}
loadManagerPass();

let selectedAccountId = null;
let selectedAccountName = "SinNombre";
let currentConsignsSnapshot = []; 
let selectedConsignIds = new Set(); // Almacenamiento local de IDs seleccionados (para persistencia en UI)

/* UTILIDADES */
function $(id){ return document.getElementById(id); }
function fmtCOP(n){ return new Intl.NumberFormat('es-CO').format(Number(n||0)); }
function parseDateRadio(name, pickerId){ 
  const opts = document.getElementsByName(name); 
  let sel = null; 
  for(const r of opts) if(r.checked) sel = r.value; 
  
  // Crear fechas en zona horaria de Colombia (UTC-5)
  const now = new Date();
  const colombiaOffset = -5 * 60; // UTC-5 en minutos
  const localOffset = now.getTimezoneOffset();
  const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
  
  if(sel === 'today') return colombiaTime; 
  if(sel === 'yesterday'){ 
    const d = new Date(colombiaTime); 
    d.setDate(d.getDate()-1); 
    return d; 
  } 
  if(sel === 'daybefore'){ 
    const d = new Date(colombiaTime); 
    d.setDate(d.getDate()-2); 
    return d; 
  } 
  
  // Si no hay radio button seleccionado, usar el date picker
  const v = $(pickerId).value; 
  if(v) {
    // Crear fecha local correctamente para Colombia
    const parts = v.split('-');
    const selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    // Ajustar a hora de Colombia (mediod√≠a para evitar problemas de zona horaria)
    selectedDate.setHours(12, 0, 0, 0);
    return selectedDate;
  }
  
  return null; 
}

/* FUNCIONES DE MODAL GEN√âRICO */
function showModal(title, message, isConfirm, onOk, onCancel){
    $('modal-title').textContent = title;
    $('modal-body').innerHTML = message;
    $('modal-password-area').classList.add('hidden');
    $('modal-password-input').value = '';

    $('modal-cancel-btn').textContent = "Cancelar";
    $('modal-cancel-btn').classList.toggle('hidden', !isConfirm);
    $('modal-ok-btn').textContent = "Aceptar";
    $('modal-ok-btn').onclick = () => { $('generic-modal').classList.add('hidden'); if(onOk) onOk(); };
    $('modal-cancel-btn').onclick = () => { $('generic-modal').classList.add('hidden'); if(onCancel) onCancel(); };

    $('generic-modal').classList.remove('hidden');
}

function showPasswordModal(title, message){
    return new Promise((resolve, reject) => {
        $('modal-title').textContent = title;
        $('modal-body').textContent = message;
        $('modal-password-area').classList.remove('hidden');
        $('modal-password-input').value = '';
        $('modal-password-input').focus();
        
        $('modal-cancel-btn').textContent = "Cancelar";
        $('modal-cancel-btn').classList.remove('hidden');
        $('modal-ok-btn').textContent = "Aceptar";

        const checkPass = () => {
            const pass = $('modal-password-input').value;
            if (pass === managerPass) {
                $('generic-modal').classList.add('hidden');
                resolve(true);
            } else {
                showModal('Error de Seguridad', 'Clave incorrecta. Intente de nuevo.', false);
                $('modal-password-input').value = '';
                $('modal-password-input').focus();
            }
        };

        const handleCancel = () => {
            $('generic-modal').classList.add('hidden');
            reject(new Error("Acci√≥n cancelada."));
        };

        $('modal-ok-btn').onclick = checkPass;
        $('modal-cancel-btn').onclick = handleCancel;
        
        // Permite usar Enter en el input de contrase√±a
        $('modal-password-input').onkeydown = (e) => {
            if(e.key === 'Enter') { e.preventDefault(); checkPass(); }
        };

        $('generic-modal').classList.remove('hidden');
    }).catch(e => {
        if(e.message !== "Acci√≥n cancelada.") {
            showModal('Error', e.message, false);
        }
        throw e; // Re-throw to propagate rejection
    });
}

/** Muestra advertencia din√°mica (Cierre/Cuadre) y pregunta si continuar */
function showSuperWarning(title, message, onContinue) {
    return new Promise((resolve) => {
        $('modal-title').innerHTML = `
            <div class="warning-title-container">
                <span class="warning-icon">üö®</span>
                <span style="font-size: 1.2em; font-weight: bold; color: var(--danger);">${title}</span>
            </div>
        `;
        $('modal-body').innerHTML = `<p class="warning-message">${message}</p>`;
        $('modal-password-area').classList.add('hidden');
        
        $('modal-cancel-btn').textContent = "Cancelar Acci√≥n";
        $('modal-cancel-btn').classList.remove('hidden');
        
        $('modal-ok-btn').textContent = "S√≠, Continuar Agregando";
        $('modal-ok-btn').classList.remove('danger');
        
        $('modal-ok-btn').onclick = () => { 
            $('generic-modal').classList.add('hidden'); 
            resolve(true);
        };
        $('modal-cancel-btn').onclick = () => { 
            $('generic-modal').classList.add('hidden'); 
            resolve(false);
        };

        $('generic-modal').classList.remove('hidden');
    });
}

/** Funci√≥n para Inserci√≥n Retroactiva (Doble Clic) */
async function handleDoubleClick(clickedConsign, index) {
    if (sessionRole !== 'Gerente') {
        showModal('Acceso Denegado', 'Solo el **Gerente** puede insertar movimientos retroactivos.', false);
        return;
    }
    
    if (clickedConsign.isSeparator || !clickedConsign.verifiedRole) {
         showModal('Atenci√≥n', 'Solo puede insertar antes de consignaciones verificadas.', false);
         return;
    }
    
    // 3. Preparar datos
    const clickedDate = clickedConsign.fecha.toDate();
    const clickedTimestamp = clickedDate.getTime();
    // Obtener fecha actual en zona horaria de Colombia
    const now = new Date();
    const colombiaOffset = -5 * 60; // UTC-5 en minutos
    const localOffset = now.getTimezoneOffset();
    const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
    const today = colombiaTime.toISOString().substring(0, 10);
    const clickedDateStr = clickedDate.toLocaleDateString('es-CO');

    // 4. Configurar el Modal Din√°mico con inputs de Fecha y Observaci√≥n
    $('modal-title').innerHTML = `
        <div class="warning-title-container">
            <span class="warning-icon" style="color: var(--accent);">üìù</span> 
            <span style="font-size: 1.2em; font-weight: bold; color: var(--accent);">Inserci√≥n Retroactiva</span>
        </div>
    `;
    $('modal-body').innerHTML = `
        <p class="warning-message">
            El nuevo movimiento se insertar√° con la fecha y valor que especifique, garantizando que aparezca **justo encima** de la consignaci√≥n del **${clickedDateStr}** y se marcar√° como Verificado (Gerente).
        </p>
        <div style="display:flex; gap:10px;">
            <div style="flex:1">
                <label style="font-size:13px; color:var(--muted); margin-bottom:6px;">FECHA CONSIGNACI√ìN:</label>
                <input type="date" id="modal-retro-fecha" required value="${today}" style="width: 100%;">
            </div>
            <div style="flex:1">
                <label style="font-size:13px; color:var(--muted); margin-bottom:6px;">FECHA DE OBSERVACI√ìN (Opcional):</label>
                <input type="date" id="modal-retro-obsdate" style="width: 100%;">
            </div>
        </div>
        <div style="margin-top:12px;">
            <label style="font-size:13px; color:var(--muted); margin-bottom:6px;">VALOR (COP) a insertar:</label>
            <input type="number" id="modal-retro-valor" placeholder="0.00" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; width: 100%;">
        </div>
    `;
    
    $('modal-password-area').classList.add('hidden');
    $('modal-cancel-btn').textContent = "Cancelar";
    $('modal-cancel-btn').classList.remove('hidden');
    $('modal-ok-btn').textContent = "Insertar";

    // 5. L√≥gica de Aceptar
    const insertAction = async () => {
        const valorInput = document.getElementById('modal-retro-valor');
        const fechaInput = document.getElementById('modal-retro-fecha');
        const obsdateInput = document.getElementById('modal-retro-obsdate');
        
        const valor = Number(valorInput.value);
        const fechaStr = fechaInput.value;
        const obsdateStr = obsdateInput.value;

        if (isNaN(valor) || valor <= 0) {
            showModal('Error', 'Valor inv√°lido o no ingresado. Intente de nuevo.', false);
            return handleDoubleClick(clickedConsign, index); 
        }
        if (!fechaStr) {
            showModal('Error', 'Debe seleccionar una fecha para la consignaci√≥n.', false);
            return handleDoubleClick(clickedConsign, index);
        }

        // Crear fechas correctamente para Colombia
        const fechaParts = fechaStr.split('-');
        const userFecha = new Date(parseInt(fechaParts[0]), parseInt(fechaParts[1]) - 1, parseInt(fechaParts[2]), 12, 0, 0, 0);
        
        let userObsdate = null;
        if (obsdateStr) {
            const obsParts = obsdateStr.split('-');
            userObsdate = new Date(parseInt(obsParts[0]), parseInt(obsParts[1]) - 1, parseInt(obsParts[2]), 12, 0, 0, 0);
        }
        
        // CLAVE: Para que aparezca justo encima de la fila clickeada, usar timestamp ligeramente anterior
        // pero guardar la fecha original que el usuario especific√≥ para mostrar
        const timestampParaOrden = new Date(clickedTimestamp - 1); // 1ms antes del clickeado
        
        console.log('üîÑ INSERCI√ìN RETROACTIVA:');
        console.log('  - Fecha clickeada:', clickedDate);
        console.log('  - Timestamp clickeado:', clickedTimestamp);
        console.log('  - Fecha usuario:', userFecha);
        console.log('  - Timestamp para orden:', timestampParaOrden);
        
        try {
            await db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').add({ 
                fecha: firebase.firestore.Timestamp.fromDate(timestampParaOrden), // Para ordenamiento
                fechaOriginal: firebase.firestore.Timestamp.fromDate(userFecha), // Para mostrar
                obsdate: userObsdate ? firebase.firestore.Timestamp.fromDate(userObsdate) : null,
                valor: valor, 
                verifiedBy: usuario.usuario, 
                verifiedRole: 'Gerente'
            });
            
            console.log('‚úÖ Consignaci√≥n retroactiva agregada exitosamente');
            
            // Forzar actualizaci√≥n de totales despu√©s de inserci√≥n retroactiva
            setTimeout(() => {
              console.log('üîÑ Actualizando totales despu√©s de inserci√≥n retroactiva...');
              updateSelectedTotals();
              updateTotalGeneral();
            }, 1000);
            
            setTimeout(() => {
              console.log('üîÑ Segunda actualizaci√≥n de totales...');
              updateSelectedTotals();
              updateTotalGeneral();
            }, 2500);
            
        } catch(e) { 
            showModal('Error', 'Error al insertar consignaci√≥n: '+e.message, false); 
        } finally {
            $('generic-modal').classList.add('hidden');
        }
    };

    $('modal-ok-btn').onclick = insertAction;
    $('modal-cancel-btn').onclick = () => {
        $('generic-modal').classList.add('hidden');
    };
    
    $('generic-modal').classList.remove('hidden');
    document.getElementById('modal-retro-valor').focus();
}


/* MODAL DE OPCIONES Y ROLES */
$('open-options').addEventListener('click', ()=> {
  $('modal-options').classList.remove('hidden');
  document.querySelector('input[name="sessionRole"][value="Administrativo"]').checked = true;
  $('manager-pass-area').classList.add('hidden');
  $('manager-pass').value = '';
  $('gear-panel').classList.add('hidden');
});

document.querySelectorAll('input[name="sessionRole"]').forEach(r=>{
  r.addEventListener('change', (e)=>{
    if(e.target.value === 'Gerente') $('manager-pass-area').classList.remove('hidden');
    else $('manager-pass-area').classList.add('hidden');
  });
});

$('options-cancel').addEventListener('click', ()=> $('modal-options').classList.add('hidden'));
$('gear-change').addEventListener('click', ()=> $('gear-panel').classList.toggle('hidden'));
$('cancel-gear').addEventListener('click', ()=> $('gear-panel').classList.add('hidden'));

$('save-manager-pass').addEventListener('click', async ()=>{
  const p = $('new-manager-pass').value.trim(); 
  if(!p){ showModal('Atenci√≥n', 'Ingrese nueva clave.', false); return; }
  
  try {
    // Guardar la nueva clave en Firebase
    await settingsRef.set({ password: p }, { merge: true }); 
    managerPass = p; // Actualiza el estado local inmediatamente
    showModal('√âxito', 'Clave actualizada en el sistema.', false); 
    $('gear-panel').classList.add('hidden');
  } catch(e) {
    showModal('Error', 'Error al guardar la clave: ' + e.message, false);
  }
});

$('options-continue').addEventListener('click', ()=>{
  const chosen = document.querySelector('input[name="sessionRole"]:checked').value;
  if(chosen === 'Gerente'){
    if($('manager-pass').value !== managerPass){ showModal('Error', 'Clave incorrecta.', false); return; }
    sessionRole = 'Gerente';
  } else sessionRole = 'Administrativo';

  const isMgr = (sessionRole === 'Gerente');
  $('btn-delete').style.display = isMgr ? 'inline-block' : 'none';
  $('btn-cuadrar').style.display = isMgr ? 'inline-block' : 'none';
  $('btn-export-master').style.display = isMgr ? 'inline-block' : 'none';
  document.querySelectorAll('.del-btn').forEach(b => b.style.display = isMgr ? 'block' : 'none');
  
  // Habilita/Deshabilita los toggles de cierre de cuenta
  document.querySelectorAll('.close-account-toggle').forEach(t => t.disabled = !isMgr);

  $('modal-options').classList.add('hidden');
  showModal('Acceso', 'Rol activo: ' + sessionRole, false);
  
  // Actualizar indicadores de jerarqu√≠a cuando cambia el rol
  setTimeout(() => {
    updateVerificationIndicators();
  }, 200);
});

/* SEGURIDAD EXTRA: Proteger cambios en items verificados */
async function checkSensitiveAction(selectedData) {
  const lockedItems = selectedData.filter(i => i.verifiedRole || i.isSeparator);
  
  if (lockedItems.length > 0) {
    try {
        await showPasswordModal(
            "‚ö†Ô∏è ACCI√ìN RESTRINGIDA ‚ö†Ô∏è", 
            "Est√° intentando modificar/eliminar registros VERIFICADOS o CORTES. Ingrese la CLAVE DE GERENTE para continuar:"
        );
        return true;
    } catch (e) {
        return false;
    }
  }
  return true; 
}

/* GESTI√ìN DE CUENTAS (Incluye l√≥gica de cierre y re-apertura con clave) */
function subscribeAccounts(){
  db.collection('cuentas').orderBy('name').onSnapshot(snapshot=>{
    const container = $('accounts-list'); container.innerHTML = '';
    
    let firstAccount = null;
    let accountsData = [];
    snapshot.forEach(doc => accountsData.push({ id: doc.id, ...doc.data() }));

    // Si no hay ninguna cuenta seleccionada, seleccionamos la primera
    if(!selectedAccountId && accountsData.length > 0){
        firstAccount = accountsData[0];
        selectedAccountId = firstAccount.id; 
        selectedAccountName = firstAccount.name;
    }

    // Renderizar cuentas
    accountsData.forEach(a=>{
      const isClosed = a.closed || false; 
      const isMgr = (sessionRole === 'Gerente');

      const div = document.createElement('div'); 
      // *** FIX 1: Aplicar el resalte visual correctamente ***
      div.className = 'account-item' + (selectedAccountId === a.id ? ' selected' : '');
      div.innerHTML = `
        <div style="font-weight:600; padding-right:20px;">${a.name} ${isClosed ? ' (üîí CERRADA)' : ''}</div>
        <div class="muted">${a.number || ''}</div>
        <label style="margin-top:4px; display: block; font-size:12px;">
            <input type="checkbox" data-id="${a.id}" class="close-account-toggle" ${isClosed ? 'checked' : ''} ${isMgr ? '' : 'disabled'}> 
            ${isClosed ? 'Cuenta Cerrada' : 'Marcar para Cerrar'}
        </label>
      `;
      
      const delBtn = document.createElement('span');
      delBtn.className = 'del-btn';
      delBtn.textContent = 'üóëÔ∏è';
      delBtn.title = "Eliminar cuenta";
      if(isMgr) delBtn.style.display = 'block';
      delBtn.onclick = (e) => { e.stopPropagation(); deleteAccount(a.id, a.name); };
      div.appendChild(delBtn);

      div.onclick = ()=>{ 
        selectedAccountId = a.id; 
        selectedAccountName = a.name;
        
        // LIMPIAR LA SELECCI√ìN AL CAMBIAR DE CUENTA
        selectedConsignIds.clear(); 
        document.querySelectorAll('#consigns-body input[type="checkbox"]').forEach(chk => chk.checked = false);
        activeRowIndex = -1; // Limpiar √≠ndice activo/ancla
        anchorRowIndex = -1;
        
        // La actualizaci√≥n de la UI se maneja mejor forzando el resalto localmente 
        // y dejando que la pr√≥xima snapshot de cuentas actualice todo el sidebar.
        document.querySelectorAll('#accounts-list .account-item').forEach(el => el.classList.remove('selected'));
        div.classList.add('selected');

        const isClosedState = a.closed || false;
        $('selected-account-info').textContent = `Cuenta: ${a.name} ‚Äî ${a.number || ''}${isClosedState ? ' (üîí CERRADA)' : ''}`; 
        updateSelectedTotals(); 
        renderConsigns(); 
      };
      container.appendChild(div);
    });

    // *** FIX 2: Asegurar que el t√≠tulo se actualice en la carga inicial si se seleccion√≥ la primera cuenta ***
    if(firstAccount){ 
        const isClosed = firstAccount.closed || false;
        $('selected-account-info').textContent = `Cuenta: ${selectedAccountName} ‚Äî ${firstAccount.number || ''}${isClosed ? ' (üîí CERRADA)' : ''}`; 
        renderConsigns(); 
        updateSelectedTotals(); 
    }
    // Aseguramos que el total general se actualice al cargar las cuentas por primera vez
    updateTotalGeneral(); 
  });
}
subscribeAccounts();

// Listener para el Toggle de Cierre de Cuenta
document.addEventListener('change', async (e) => {
    if (e.target.classList.contains('close-account-toggle')) {
        const accountId = e.target.dataset.id;
        const newState = e.target.checked;
        
        // Obtener el nombre de la cuenta para el modal de confirmaci√≥n
        const accountDoc = await db.collection('cuentas').doc(accountId).get();
        const accountName = accountDoc.data()?.name || 'Seleccionada';

        try {
            if (newState) {
                // Requiere clave para CERRAR
                await showPasswordModal("Confirmaci√≥n de Cierre", `¬øDesea CERRAR la cuenta "${accountName}" permanentemente? Esto evitar√° nuevas consignaciones, a menos que se fuerce la acci√≥n.`);
            } else {
                // REQUISITO NUEVO: Requiere clave para REABRIR (quitar el cerrado)
                await showPasswordModal("Confirmaci√≥n de Apertura", `¬øDesea REABRIR la cuenta "${accountName}"? Esto permitir√° nuevas consignaciones. Ingrese CLAVE DE GERENTE.`);
            }
            
            await db.collection('cuentas').doc(accountId).update({ closed: newState });
        } catch (error) {
            e.target.checked = !newState; // Revertir estado en la UI si falla o cancela
            if (error.message !== "Acci√≥n cancelada.") {
                showModal('Error', "Error al actualizar el estado de la cuenta: " + error.message, false);
            }
        }
    }
});

async function deleteAccount(id, name){
    if(sessionRole !== 'Gerente') return showModal('Error', "Solo Gerente puede eliminar cuentas.", false);
    
    showModal('Confirmaci√≥n', `¬øEliminar cuenta "${name}" permanentemente?`, true, async () => {
        try {
            await showPasswordModal(
                "‚ö†Ô∏è PELIGRO ‚ö†Ô∏è",
                `Va a eliminar la cuenta "${name}" y todo su historial. Ingrese CLAVE DE GERENTE para confirmar:`
            );

            await db.collection('cuentas').doc(id).delete();
            if(selectedAccountId === id) { selectedAccountId=null; $('consigns-body').innerHTML=''; $('selected-account-info').textContent='...'; }
            showModal('√âxito', "Cuenta eliminada.", false);
        } catch(e) { 
            if(e.message !== "Acci√≥n cancelada.") showModal('Error', "Error: " + e.message, false);
        }
    });
}

/** L√≥gica para agregar cuentas nuevas */
$('add-account').addEventListener('click', async ()=>{
  const name = $('new-account-name').value.trim();
  const number = $('new-account-number').value.trim();
  
  if(!name){
    return showModal('Atenci√≥n', 'El nombre de la cuenta es obligatorio.', false);
  }
  
  try {
    await db.collection('cuentas').add({
      name: name,
      number: number,
      closed: false // Default to open
    });
    
    // Success: Clear fields and notify user
    $('new-account-name').value = '';
    $('new-account-number').value = '';
    showModal('√âxito', 'Cuenta agregada con √©xito. Ya puede seleccionarla de la lista.', false); 
  } catch(e) {
    showModal('Error', 'Error al agregar la cuenta: ' + e.message, false);
  }
});


/* RENDER CONSIGNACIONES */
let consignsUnsub = null;
function renderConsigns(){ 
  if(consignsUnsub) consignsUnsub(); 
  const tbody = $('consigns-body'); tbody.innerHTML = '';
  currentConsignsSnapshot = [];

  if(!selectedAccountId) return;

  // Ordenar por fecha DESCENDENTE (m√°s nuevas arriba)
  consignsUnsub = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').orderBy('fecha', 'desc').onSnapshot(snapshot=>{
    tbody.innerHTML = '';
    currentConsignsSnapshot = [];
    
    // 1. FILTRAR LA SELECCI√ìN: Eliminar de la "memoria" IDs que ya no existen en el snapshot
    const newSnapshotIds = new Set(snapshot.docs.map(doc => doc.id));
    selectedConsignIds = new Set([...selectedConsignIds].filter(id => newSnapshotIds.has(id)));
    
    snapshot.forEach(doc => currentConsignsSnapshot.push({id: doc.id, ...doc.data()}));

    currentConsignsSnapshot.forEach((c, index)=>{
      
      const isSelected = selectedConsignIds.has(c.id); // <-- Verificar el estado en la "memoria"
      const checkedAttr = isSelected ? 'checked' : ''; // <-- Atributo 'checked'

      if(c.isSeparator){
        const tr=document.createElement('tr');
        tr.classList.add('separator');
        if(c.type==='green') tr.classList.add('sep-green');
        if(c.type==='red') tr.classList.add('sep-red');
        let labelText = `--- ${c.label} ---`;
        if(c.type === 'green') labelText = `üí∞ TOTAL: ${fmtCOP(c.total)}`;
        if(c.type === 'red') labelText = `üõë CORTE (${c.label})`;
        tr.innerHTML = `<td><input type="checkbox" data-id="${c.id}" data-idx="${index}" data-separator="true" ${checkedAttr}></td><td colspan="3">${labelText}</td><td></td>`;
        tbody.appendChild(tr);
        return;
      }

      const tr = document.createElement('tr');
      tr.setAttribute('data-index', index);
      if(c.verifiedRole === 'Administrativo') tr.classList.add('verified-admin');
      if(c.verifiedRole === 'Gerente') tr.classList.add('verified-gerente');
      
      // Usar fechaOriginal si existe, sino usar fecha normal
      const fechaParaMostrar = c.fechaOriginal || c.fecha;
      const fechaText = fechaParaMostrar && fechaParaMostrar.toDate ? new Date(fechaParaMostrar.toDate()).toLocaleDateString() : '';
      const obsText = c.obsdate && c.obsdate.toDate ? new Date(c.obsdate.toDate()).toLocaleDateString() : '';
      
      tr.innerHTML = `
        <td style="width:56px; text-align:center;"><input type="checkbox" data-id="${c.id}" data-idx="${index}" ${checkedAttr}></td>
        <td style="width:160px">${fechaText}</td>
        <td style="width:140px">${fmtCOP(c.valor)}</td>
        <td style="width:160px">${obsText}</td>
        <td style="width:160px">${c.verifiedRole ? (c.verifiedRole === 'Gerente' ? 'Verificado (Amarillo)' : 'Verificado (Gris)') : 'Pendiente'}</td>
      `;
      
      // *** MODIFICACI√ìN CRUCIAL AQU√ç ***
      tr.addEventListener('click', (e)=>{
        if(e.target.type !== 'checkbox') {
            activeRowIndex = index;
            anchorRowIndex = index; // <-- FIX: Establecer el ancla al hacer clic en la fila
            
            // Comportamiento est√°ndar: Un clic simple en la fila limpia la selecci√≥n previa
            if(!e.shiftKey && !e.ctrlKey && !e.metaKey) {
                selectedConsignIds.clear();
                document.querySelectorAll('#consigns-body input[type="checkbox"]').forEach(chk => chk.checked = false);
            }

            highlightRow(index);
        }
      });
      // Listener para doble clic (inserci√≥n retroactiva)
      tr.addEventListener('dblclick', (e) => handleDoubleClick(c, index));

      tbody.appendChild(tr);
    });
    
    // Actualizaci√≥n de totales aqu√≠, cada vez que la lista cambia
    setTimeout(() => {
      updateSelectedTotals(); 
      updateTotalGeneral();
    }, 100);
    
    // Actualizar indicadores de jerarqu√≠a despu√©s de renderizar
    setTimeout(() => {
      if (typeof updateVerificationIndicators === 'function') {
        updateVerificationIndicators();
      }
    }, 300);
  });
}

/* L√ìGICA DE TECLADO Y SELECCI√ìN */
let activeRowIndex = -1;
let anchorRowIndex = -1;
function getRows(){ return Array.from(document.querySelectorAll('#consigns-body tr')); }
function highlightRow(idx){
    const rows = getRows();
    rows.forEach(r => r.classList.remove('keyboard-focus'));
    if(idx >= 0 && idx < rows.length){
        rows[idx].classList.add('keyboard-focus');
        rows[idx].scrollIntoView({block:'nearest'});
    }
}

// SINCRONIZA LA SELECCI√ìN DEL CHECKBOX CON LA MEMORIA LOCAL
$('consigns-body').addEventListener('change', (e)=>{
    if(e.target.type === 'checkbox'){
        const id = e.target.dataset.id;
        const idx = parseInt(e.target.dataset.idx);
        
        // ACTUALIZA EL SET GLOBAL DE SELECCI√ìN (MEMORIA LOCAL)
        if(e.target.checked) {
            selectedConsignIds.add(id);
        } else {
            selectedConsignIds.delete(id);
        }
        
        if(!lastShiftState) anchorRowIndex = idx; // Se actualiza el ancla si NO se usa Shift
    }
});

let lastShiftState = false;
document.addEventListener('keydown', e => { if(e.key === 'Shift') lastShiftState = true; });
document.addEventListener('keyup', e => { if(e.key === 'Shift') lastShiftState = false; });

document.addEventListener('keydown', e => {
    if(e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') return;
    const rows = getRows();
    if(rows.length === 0) return;
    if(['ArrowUp','ArrowDown'].includes(e.key)){
        e.preventDefault();
        
        // Inicializa o corrige el √≠ndice activo/ancla
        if(activeRowIndex === -1) { 
            activeRowIndex = 0; 
            anchorRowIndex = 0; 
        }
        
        let newIndex = activeRowIndex;
        if(e.key === 'ArrowDown') newIndex++;
        if(e.key === 'ArrowUp') newIndex--;
        newIndex = Math.max(0, Math.min(newIndex, rows.length - 1));
        
        if(e.shiftKey){
            // L√≥gica de selecci√≥n de rango (Shift + Flechas)
            
            // Calcula el rango entre el ancla y la nueva posici√≥n
            const start = Math.min(anchorRowIndex, newIndex);
            const end = Math.max(anchorRowIndex, newIndex);
            
            // Limpia la selecci√≥n actual para re-aplicar el nuevo rango
            selectedConsignIds.clear(); 
            
            rows.forEach((r, i) => {
                const chk = r.querySelector('input[type="checkbox"]');
                if(!chk) return;
                
                // Selecciona solo los elementos dentro del nuevo rango
                if(i >= start && i <= end){
                    chk.checked = true;
                    selectedConsignIds.add(chk.dataset.id); 
                } else {
                    chk.checked = false; // Deselecciona los que quedan fuera
                }
            });
            
        } else {
            // Sin Shift: se mueve el cursor y se establece un nuevo ancla
            anchorRowIndex = newIndex;
            // Opcional: limpiar la selecci√≥n si no se usa Shift (ya manejado en click, pero aqu√≠ garantiza que solo se mueva el foco)
            selectedConsignIds.clear(); 
            document.querySelectorAll('#consigns-body input[type="checkbox"]').forEach(chk => chk.checked = false);
        }
        
        activeRowIndex = newIndex;
        highlightRow(activeRowIndex);
    }
    
    // Toggle Checkbox con barra espaciadora
    if(e.key === ' '){
        e.preventDefault();
        if(activeRowIndex >= 0 && activeRowIndex < rows.length){
            const chk = rows[activeRowIndex].querySelector('input[type="checkbox"]');
            if(chk) {
                // Toggla el estado del checkbox
                chk.checked = !chk.checked;
                
                // SINCRONIZA EL ESTADO CON EL SET
                if(chk.checked) {
                    selectedConsignIds.add(chk.dataset.id);
                } else {
                    selectedConsignIds.delete(chk.dataset.id);
                }
                
                // Actualiza el ancla si no se us√≥ Shift (aunque ya est√° en el change listener, lo ponemos aqu√≠ por si acaso)
                if(!e.shiftKey) {
                    anchorRowIndex = activeRowIndex;
                }
            }
        }
    }
});

/* BOTONES DE EXPORTACI√ìN (Con formato de fecha corregido) */
const longDateFormat = '[$-es-ES]d\ \d\e\ mmmm\ \d\e\ aaaa'; 
const shortDateFormat = 'DD/MM/YYYY'; 

function applyExcelDateFormats(ws) {
    if (!ws['!ref']) return;
    const range = XLSX.utils.decode_range(ws['!ref']);
    
    for (let R = range.s.r + 1; R <= range.e.r; ++R) { 
        const cell_fecha_addr = XLSX.utils.encode_cell({ r: R, c: 0 }); // FECHA
        const cell_valor_addr = XLSX.utils.encode_cell({ r: R, c: 1 }); // VALOR
        const cell_obs_addr = XLSX.utils.encode_cell({ r: R, c: 2 }); // OBSERVACIONES

        // FECHA: Formato de fecha LARGO
        if (ws[cell_fecha_addr] && ws[cell_fecha_addr].t === 'n') {
            ws[cell_fecha_addr].z = longDateFormat; 
        }
        // OBSERVACIONES: Formato de fecha CORTO (dd/mm/yyyy)
        if (ws[cell_obs_addr] && ws[cell_obs_addr].t === 'n') {
            ws[cell_obs_addr].z = shortDateFormat; 
        }
        
        // Formato de moneda
        if (ws[cell_valor_addr]) {
            ws[cell_valor_addr].z = '_("$"* #,##0_);_("$"* (#,##0);_("$"* "-"??_);_(@_)';
        }
    }
    // Ajuste de anchos 
    ws['!cols'] = [{wch: 25}, {wch: 15}, {wch: 25}, {wch: 20}];
}

// Funci√≥n de exportaci√≥n de cuenta seleccionada
$('btn-export-excel').addEventListener('click', () => {
  if(!selectedAccountId || currentConsignsSnapshot.length === 0) return showModal('Atenci√≥n', "No hay datos para exportar.", false);

  const dataForExcel = currentConsignsSnapshot
    .filter(c => !c.isSeparator)
    .map(c => {
      // Es crucial pasar los objetos Date para que el formato de Excel funcione
      // Usar fechaOriginal si existe, sino usar fecha normal
      const fechaParaExportar = c.fechaOriginal || c.fecha;
      const fechaDate = fechaParaExportar && fechaParaExportar.toDate ? fechaParaExportar.toDate() : null;
      const obsDate = c.obsdate && c.obsdate.toDate ? c.obsdate.toDate() : null;
      
      const estado = !c.verifiedRole 
          ? 'Pendiente' 
          : c.verifiedRole === 'Administrativo' 
            ? 'Verificado (Gris)' 
            : 'Verificado (Amarillo)';

      return {
        FECHA: fechaDate, 
        VALOR: Number(c.valor || 0),
        OBSERVACIONES: obsDate,
        'ESTADO/COLOR': estado 
      };
    });

  if(dataForExcel.length === 0) return showModal('Atenci√≥n', "No hay movimientos v√°lidos (solo separadores).", false);

  const wb = XLSX.utils.book_new();
  // El orden de la exportaci√≥n es el mismo que el del snapshot (descendente), que es lo que el usuario ve.
  const ws = XLSX.utils.json_to_sheet(dataForExcel, { header: ["FECHA", "VALOR", "OBSERVACIONES", "ESTADO/COLOR"] }); 

  applyExcelDateFormats(ws);
  
  XLSX.utils.book_append_sheet(wb, ws, selectedAccountName.substring(0, 31)); 
  XLSX.writeFile(wb, `Consignaciones_${selectedAccountName.replace(/\s+/g,'_')}.xlsx`);
});

// Funci√≥n de exportaci√≥n de maestra
$('btn-export-master').addEventListener('click', async () => {
  if (sessionRole !== 'Gerente') return;
  
  try {
    await showPasswordModal(
        "‚ö†Ô∏è DESCARGA DE MAESTRA ‚ö†Ô∏è",
        "Esta acci√≥n descarga toda la informaci√≥n del sistema. Ingrese la CLAVE DE GERENTE para continuar:"
    );

    const accountsSnapshot = await db.collection('cuentas').get();
    const wb = XLSX.utils.book_new();

    for (const doc of accountsSnapshot.docs) {
      const account = { id: doc.id, ...doc.data() };
      const accountName = account.name.substring(0, 31).replace(/[\/\?\[\]\*\\\: ]/g, '_'); 

      // Las consignaciones se ordenan cronol√≥gicamente para la maestra (por convenci√≥n de archivo hist√≥rico)
      const consignsSnapshot = await db.collection('cuentas').doc(account.id).collection('consignaciones').orderBy('fecha').get();

      const dataForExcel = consignsSnapshot.docs
        .map(d => d.data())
        .filter(c => !c.isSeparator)
        .map(c => {
          // Usar fechaOriginal si existe, sino usar fecha normal
          const fechaParaExportar = c.fechaOriginal || c.fecha;
          const fechaDate = fechaParaExportar && fechaParaExportar.toDate ? fechaParaExportar.toDate() : null;
          const obsDate = c.obsdate && c.obsdate.toDate ? c.obsdate.toDate() : null;
          
          const estado = !c.verifiedRole 
              ? 'Pendiente' 
              : c.verifiedRole === 'Administrativo' 
                ? 'Verificado (Gris)' 
                : 'Verificado (Amarillo)';

          return {
            FECHA: fechaDate, 
            VALOR: Number(c.valor || 0),
            OBSERVACIONES: obsDate,
            'ESTADO/COLOR': estado 
          };
        });

      if (dataForExcel.length === 0) continue; 

      const ws = XLSX.utils.json_to_sheet(dataForExcel, { header: ["FECHA", "VALOR", "OBSERVACIONES", "ESTADO/COLOR"] }); 

      applyExcelDateFormats(ws);

      XLSX.utils.book_append_sheet(wb, ws, accountName);
    }
    
    if (wb.SheetNames.length > 0) {
      XLSX.writeFile(wb, `Maestra_Consignaciones_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
    } else {
      showModal('Atenci√≥n', "No se encontraron movimientos en ninguna cuenta para exportar.", false);
    }
  } catch (e) {
    if(e.message !== "Acci√≥n cancelada.") showModal('Error', "Ocurri√≥ un error al intentar exportar la maestra: " + e.message, false);
  }
});


/* OPERACIONES DE DATOS (Sin modal de √©xito) */
$('add-consign').addEventListener('click', async ()=>{
  if(!selectedAccountId) return showModal('Atenci√≥n', 'Seleccione una cuenta.', false);
  
  // 1. Validar datos
  const fecha = parseDateRadio('dateOpt','date-picker'); 
  const obsdate = parseDateRadio('obsOpt','obsdate-picker'); 
  const valor = Number(getNumericValue($('valor').value) || 0);
  
  if(!fecha) return showModal('Atenci√≥n', 'Fecha inv√°lida.', false);

  // --- L√ìGICA DE ADVERTENCIA DIN√ÅMICA ---
  
  const accountDoc = await db.collection('cuentas').doc(selectedAccountId).get();
  const isClosed = accountDoc.data()?.closed || false;
  
  let proceed = true;

  if (isClosed) {
    proceed = await showSuperWarning(
      "CUENTA CERRADA DETECTADA", 
      `La cuenta "${selectedAccountName}" ha sido marcada como CERRADA. Agregar una consignaci√≥n puede indicar un error.`,
      null
    );
  } 
  
  if (!proceed) {
      return; // Detiene la acci√≥n si el usuario selecciona "Cancelar Acci√≥n"
  }
  
  // --- FIN DE L√ìGICA DE ADVERTENCIA ---

  // 2. Ejecutar adici√≥n
  try{ 
    // Usar timestamp actual + milisegundos √∫nicos para garantizar que aparezca al principio
    const ahora = new Date();
    // Agregar milisegundos √∫nicos para evitar conflictos de timestamp
    const timestampUnico = new Date(ahora.getTime() + Math.random() * 1000);
    
    console.log('Agregando consignaci√≥n con timestamp:', timestampUnico.toISOString());
    console.log('Fecha original seleccionada:', fecha.toISOString());
    
    await db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').add({ 
        fecha: firebase.firestore.Timestamp.fromDate(timestampUnico), // Timestamp √∫nico para ordenamiento
        fechaOriginal: firebase.firestore.Timestamp.fromDate(fecha), // Fecha seleccionada por el usuario
        obsdate: obsdate? firebase.firestore.Timestamp.fromDate(obsdate): null, 
        valor, 
        verifiedBy:null, 
        verifiedRole:null 
    }); 
    $('valor').value=''; 
    $('valor').focus();
    
    console.log('Consignaci√≥n agregada exitosamente, forzando actualizaci√≥n...');
    
    // Forzar actualizaci√≥n inmediata y m√∫ltiple
    setTimeout(() => {
      console.log('Actualizando totales - paso 1');
      updateSelectedTotals();
      updateTotalGeneral();
    }, 500);
    
    setTimeout(() => {
      console.log('Actualizando totales - paso 2');
      updateSelectedTotals();
      updateTotalGeneral();
    }, 1500);
    
    setTimeout(() => {
      console.log('Actualizando totales - paso 3');
      updateSelectedTotals();
      updateTotalGeneral();
    }, 3000);
    
  }catch(e){ showModal('Error', 'Error al agregar consignaci√≥n: '+e.message, false); }
});

$('valor').addEventListener('keydown', e=>{ if(e.key==='Enter') $('add-consign').click(); });

// Funcionalidad para deseleccionar radio buttons
let lastSelectedDate = null;
let lastSelectedObs = null;

// Funci√≥n para validar jerarqu√≠a de verificaci√≥n
function validateVerificationHierarchy(currentRole, newRole) {
  // Reglas de jerarqu√≠a CORRECTAS:
  // - Blanco (null) ‚Üí Puede cambiar a Gris (Administrativo) o Amarillo (Gerente) ‚úÖ
  // - Amarillo (Gerente) ‚Üí Puede cambiar a Gris (Administrativo) ‚úÖ  
  // - Gris (Administrativo) ‚Üí NO puede cambiar a Amarillo (Gerente) ‚ùå
  
  if (currentRole === 'Gerente' && newRole === 'Administrativo') {
    return false; // Admin NO puede cambiar Gerente (amarillo) a Admin (gris)
  }
  return true; // Permitido
}

// Funci√≥n para mostrar indicadores visuales de jerarqu√≠a (versi√≥n simplificada)
function updateVerificationIndicators() {
  try {
    const rows = document.querySelectorAll('#consigns-body tr');
    
    rows.forEach((row, index) => {
      const data = currentConsignsSnapshot[index];
      if (!data || data.isSeparator) return;
      
      const checkbox = row.querySelector('input[type="checkbox"]');
      if (!checkbox) return;
      
      const canVerify = validateVerificationHierarchy(data.verifiedRole, sessionRole);
      
      if (!canVerify) {
        // Solo cambiar el checkbox, sin agregar elementos adicionales
        checkbox.style.opacity = '0.4';
        checkbox.style.cursor = 'not-allowed';
        checkbox.title = `Jerarqu√≠a: Administrador no puede cambiar elementos verificados por Gerente`;
        checkbox.disabled = true;
      } else {
        // Restaurar apariencia normal
        checkbox.style.opacity = '1';
        checkbox.style.cursor = 'pointer';
        checkbox.title = '';
        checkbox.disabled = false;
      }
    });
  } catch (error) {
    console.log('Error en updateVerificationIndicators:', error);
  }
}

// Event listeners para radio buttons de fecha
document.querySelectorAll('input[name="dateOpt"]').forEach(radio => {
  radio.addEventListener('click', function() {
    if (lastSelectedDate === this) {
      this.checked = false;
      lastSelectedDate = null;
    } else {
      lastSelectedDate = this;
      // Limpiar el calendario cuando se selecciona un radio button
      $('date-picker').value = '';
    }
  });
});

// Event listeners para radio buttons de fecha de observaci√≥n
document.querySelectorAll('input[name="obsOpt"]').forEach(radio => {
  radio.addEventListener('click', function() {
    if (lastSelectedObs === this) {
      this.checked = false;
      lastSelectedObs = null;
    } else {
      lastSelectedObs = this;
      // Limpiar el calendario cuando se selecciona un radio button
      $('obsdate-picker').value = '';
    }
  });
});

// Limpiar selecci√≥n cuando se usa el date picker
$('date-picker').addEventListener('change', function() {
  document.querySelectorAll('input[name="dateOpt"]').forEach(radio => {
    radio.checked = false;
  });
  lastSelectedDate = null;
});

$('obsdate-picker').addEventListener('change', function() {
  document.querySelectorAll('input[name="obsOpt"]').forEach(radio => {
    radio.checked = false;
  });
  lastSelectedObs = null;
});

// Formateo de n√∫meros con separadores de miles
function formatNumberWithSeparators(value) {
  // Remover todo excepto n√∫meros
  const numericValue = value.replace(/[^\d]/g, '');
  
  if (numericValue === '') return '';
  
  // Formatear con separadores de miles usando punto
  return new Intl.NumberFormat('es-CO').format(parseInt(numericValue));
}

function getNumericValue(formattedValue) {
  // Remover separadores y devolver solo n√∫meros
  return formattedValue.replace(/[^\d]/g, '');
}

// Event listeners para formateo del campo valor
$('valor').addEventListener('input', function(e) {
  const cursorPosition = e.target.selectionStart;
  const oldValue = e.target.value;
  const oldLength = oldValue.length;
  
  // Formatear el valor
  const formattedValue = formatNumberWithSeparators(oldValue);
  e.target.value = formattedValue;
  
  // Ajustar posici√≥n del cursor
  const newLength = formattedValue.length;
  const lengthDiff = newLength - oldLength;
  const newCursorPosition = cursorPosition + lengthDiff;
  
  // Establecer nueva posici√≥n del cursor
  setTimeout(() => {
    e.target.setSelectionRange(newCursorPosition, newCursorPosition);
  }, 0);
});

// Limpiar formato al hacer focus para facilitar edici√≥n
$('valor').addEventListener('focus', function(e) {
  const numericValue = getNumericValue(e.target.value);
  if (numericValue !== '') {
    e.target.value = numericValue;
  }
});

// Restaurar formato al perder focus
$('valor').addEventListener('blur', function(e) {
  if (e.target.value !== '') {
    e.target.value = formatNumberWithSeparators(e.target.value);
  }
});

// Funci√≥n para obtener los IDs seleccionados usando la memoria local (Nuevo)
function getSelectedConsignIds(){ 
    return Array.from(selectedConsignIds); 
}

$('btn-verify').addEventListener('click', async ()=>{
  const ids=getSelectedConsignIds(); 
  if(ids.length===0) return showModal('Atenci√≥n', 'Seleccione al menos un movimiento para verificar.', false);
  
  // Obtener los datos de los elementos seleccionados
  const selectedData = currentConsignsSnapshot.filter(c => ids.includes(c.id));
  
  // Validar jerarqu√≠a de verificaci√≥n
  const invalidItems = [];
  const validItems = [];
  
  selectedData.forEach(item => {
    const currentRole = item.verifiedRole;
    const newRole = sessionRole;
    
    // Reglas de jerarqu√≠a CORRECTAS:
    // - Blanco (null) ‚Üí Puede cambiar a Gris (Administrativo) o Amarillo (Gerente) ‚úÖ
    // - Amarillo (Gerente) ‚Üí Puede cambiar a Gris (Administrativo) ‚úÖ  
    // - Gris (Administrativo) ‚Üí NO puede cambiar a Amarillo (Gerente) ‚ùå
    
    if (currentRole === 'Gerente' && newRole === 'Administrativo') {
      // Admin NO puede cambiar Gerente (amarillo) a Admin (gris)
      invalidItems.push(item);
    } else {
      // Todos los dem√°s casos son v√°lidos
      validItems.push(item);
    }
  });
  
  // Si hay elementos inv√°lidos, mostrar mensaje y solo procesar los v√°lidos
  if (invalidItems.length > 0) {
    const message = `‚ö†Ô∏è JERARQU√çA DE VERIFICACI√ìN ‚ö†Ô∏è\n\n` +
      `${invalidItems.length} elemento(s) verificado(s) por Gerente (amarillo) no pueden ser cambiados por Administrador (gris).\n\n` +
      `Solo se verificar√°n ${validItems.length} elemento(s) v√°lido(s) (en blanco).`;
    
    showModal('Advertencia de Jerarqu√≠a', message, false);
  }
  
  // Procesar solo los elementos v√°lidos
  if (validItems.length > 0) {
    const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones'); 
    const batch = db.batch(); 
    
    validItems.forEach(item => {
      batch.update(col.doc(item.id), { verifiedBy: usuario.usuario, verifiedRole: sessionRole });
    });
    
    await batch.commit();
    
    // Mensaje de √©xito
    const successMessage = invalidItems.length > 0 
      ? `${validItems.length} movimientos verificados correctamente. ${invalidItems.length} elementos omitidos por jerarqu√≠a.`
      : `${validItems.length} movimientos verificados correctamente.`;
    
    showModal('√âxito', successMessage, false);
  } else if (invalidItems.length > 0) {
    // Solo hab√≠a elementos inv√°lidos
    showModal('Error de Jerarqu√≠a', 'No se pudo verificar ning√∫n elemento. Los elementos verificados por Gerente (amarillo) no pueden ser cambiados por Administrador (gris).', false);
  }
  
  // Limpia la selecci√≥n despu√©s de la acci√≥n
  selectedConsignIds.clear();
});

$('btn-unverify').addEventListener('click', async ()=>{
  const ids=getSelectedConsignIds(); if(ids.length===0) return showModal('Atenci√≥n', 'Seleccione al menos un movimiento para desverificar.', false);
  const selectedData = currentConsignsSnapshot.filter(c => ids.includes(c.id));
  
  if(!await checkSensitiveAction(selectedData)) return;

  const batch = db.batch(); const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
  ids.forEach(id=> batch.update(col.doc(id), { verifiedBy:null, verifiedRole:null })); 
  await batch.commit();
  // Limpia la selecci√≥n despu√©s de la acci√≥n
  selectedConsignIds.clear();
  showModal('√âxito', `${ids.length} movimientos desverificados.`, false);
});

// FUNCI√ìN DE ELIMINACI√ìN CORREGIDA CON RECALCULO GENERAL
$('btn-delete').addEventListener('click', async ()=>{ 
  if(sessionRole!=='Gerente') return showModal('Error', 'Solo Gerente puede eliminar movimientos.', false); 
  const ids=getSelectedConsignIds(); if(ids.length===0) return showModal('Atenci√≥n', 'Seleccione al menos un movimiento para eliminar.', false);
  const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
  const selectedData = currentConsignsSnapshot.filter(c => ids.includes(c.id));
  
  if(!await checkSensitiveAction(selectedData)) return;

  showModal('Confirmaci√≥n', `¬øEliminar ${ids.length} items permanentemente?`, true, async () => {
    try {
        // 1. Eliminar los documentos seleccionados
        const deletionBatch = db.batch(); 
        ids.forEach(id=> deletionBatch.delete(col.doc(id))); 
        await deletionBatch.commit();
        
        // --- L√ìGICA DE RECALCULO DE CORTES AFECTADOS ---
        const affectedGreenSeparatorIds = new Set();
        // Solo las consignaciones verificadas por Gerente que se acaban de borrar
        const deletedVerifiedConsigns = selectedData.filter(c => c.verifiedRole === 'Gerente' && !c.isSeparator);
        
        // 2. Identificar los cortes (separadores verdes) que conten√≠an el movimiento eliminado
        deletedVerifiedConsigns.forEach(deletedConsign => {
            const deletedDate = deletedConsign.fecha.toDate().getTime();

            // Buscar el Green separator cronol√≥gicamente m√°s NUEVO que la consignaci√≥n eliminada.
            // (Este es el que deb√≠a haber cerrado el ciclo, y el que necesita correcci√≥n de su total)
            const affectedGreenSeparator = currentConsignsSnapshot.find(c => 
                c.type === 'green' && c.fecha.toDate().getTime() > deletedDate
            );
            
            if (affectedGreenSeparator) {
                affectedGreenSeparatorIds.add(affectedGreenSeparator.id);
            }
        });

        if (affectedGreenSeparatorIds.size > 0) {
            
            // 3. Obtener la lista de consignaciones REMANENTES (data fresca post-eliminaci√≥n)
            // Se usa el orden ascendente (orderBy('fecha')) para un c√°lculo cronol√≥gico m√°s f√°cil de los per√≠odos
            const updatedSnapshot = await col.orderBy('fecha').get();
            const updatedConsigns = [];
            updatedSnapshot.forEach(doc => updatedConsigns.push({id: doc.id, ...doc.data()}));

            const updateBatch = db.batch();
            let recalculationCount = 0;

            // 4. Recalcular cada corte afectado
            for (const greenId of affectedGreenSeparatorIds) {
                const affectedGreenSeparator = currentConsignsSnapshot.find(c => c.id === greenId);
                if (!affectedGreenSeparator) continue; 

                // Encontrar el RED separator inmediatamente precedente al corte afectado
                // Como el snapshot local (currentConsignsSnapshot) est√° en orden descendente, 
                // el Red Separator (1ms m√°s nuevo) est√° justo ANTES del Green Separator.
                const greenIndex = currentConsignsSnapshot.indexOf(affectedGreenSeparator);
                let precedingRedSeparator = null;
                if (greenIndex > 0) {
                    precedingRedSeparator = currentConsignsSnapshot[greenIndex - 1];
                }
                // Si el precedingRedSeparator no es un red (o no existe) se usa el inicio de los tiempos
                if (!precedingRedSeparator || precedingRedSeparator.type !== 'red') {
                     precedingRedSeparator = null;
                }


                // Definir el inicio del periodo de c√°lculo
                const queryStart = precedingRedSeparator ? precedingRedSeparator.fecha.toDate().getTime() : new Date(0).getTime();
                const queryEnd = affectedGreenSeparator.fecha.toDate().getTime();

                // Sumar las consignaciones restantes verificadas por Gerente en ese periodo
                const remainingConsignsInPeriod = updatedConsigns
                    .filter(c => 
                        !c.isSeparator && 
                        c.verifiedRole === 'Gerente' && 
                        c.fecha.toDate().getTime() > queryStart && 
                        c.fecha.toDate().getTime() < queryEnd
                    );

                const newCutTotal = remainingConsignsInPeriod.reduce((sum, c) => sum + Number(c.valor || 0), 0);
                
                // Aplicar la actualizaci√≥n al separador verde
                updateBatch.update(col.doc(greenId), { 
                    total: newCutTotal,
                    label: `üö® Recalculado ${new Date().toLocaleDateString()}` 
                });
                recalculationCount++;
            }
            
            await updateBatch.commit();
            // Limpia la selecci√≥n despu√©s de la acci√≥n
            selectedConsignIds.clear();
            showModal('¬°Atenci√≥n!', `Eliminaci√≥n exitosa. ${recalculationCount} CORTES afectados han sido recalculados y corregidos.`, false);
        } else {
            // Limpia la selecci√≥n despu√©s de la acci√≥n
            selectedConsignIds.clear();
            
            // Forzar actualizaci√≥n de totales despu√©s de eliminar
            setTimeout(() => {
              updateSelectedTotals();
              updateTotalGeneral();
            }, 1000);
            
            showModal('√âxito', `${ids.length} items eliminados.`, false);
        }

    } catch(e) { 
        if(e.message !== "Acci√≥n cancelada.") showModal('Error', 'Error al eliminar: '+e.message, false);
    }
  });
});

/** FUNCI√ìN CUADRAR: Solo inserta separadores, no toca el estado de la cuenta */
$('btn-cuadrar').addEventListener('click', async () => {
  if (!selectedAccountId) return showModal('Atenci√≥n', 'Seleccione una cuenta.', false);
  
  // Adaptaci√≥n a la lista DESCENDENTE (m√°s nueva arriba)
  let pendingItems = [];
  for(const item of currentConsignsSnapshot){
    // Al ir de lo nuevo a lo viejo, sumamos hasta que encontramos el primer separador de corte (el m√°s reciente)
    if(item.isSeparator && item.type === 'red') {
        break; 
    }
    if (!item.isSeparator) {
        pendingItems.push(item);
    }
  }
  
  if(pendingItems.length === 0) return showModal('Atenci√≥n', "Nada nuevo para cuadrar. No hay movimientos pendientes desde el √∫ltimo corte.", false);

  const nonYellow = pendingItems.filter(i => i.verifiedRole !== 'Gerente');
  if(nonYellow.length > 0) return showModal('Atenci√≥n', `Hay ${nonYellow.length} items sin verificar por Gerente. Verifique todos los √≠tems primero.`, false);

  const total = pendingItems.reduce((acc, curr) => acc + Number(curr.valor || 0), 0);
  
  showModal('Confirmaci√≥n', `¬øRealizar corte?\nTotal a Cuadrar: ${fmtCOP(total)}`, true, async () => {
    const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
    const batch = db.batch();
    
    // Crear fecha en zona horaria de Colombia
    const nowUTC = new Date();
    const colombiaOffset = -5 * 60; // UTC-5 en minutos
    const localOffset = nowUTC.getTimezoneOffset();
    const now = new Date(nowUTC.getTime() + (localOffset + colombiaOffset) * 60000);
    
    // Inserta separador Verde (Total del Corte)
    batch.set(col.doc(), { isSeparator:true, type:'green', label: now.toLocaleDateString('es-CO'), total: total, fecha: firebase.firestore.Timestamp.fromDate(now) });
    // Inserta separador Rojo (Nuevo punto de partida) - 1ms m√°s nuevo que el verde para aparecer ARRIBA en la lista descendente
    batch.set(col.doc(), { isSeparator:true, type:'red', label: now.toLocaleDateString('es-CO'), total: 0, fecha: firebase.firestore.Timestamp.fromDate(new Date(now.getTime()+1)) });

    await batch.commit();
    // Limpia la selecci√≥n despu√©s de la acci√≥n
    selectedConsignIds.clear();
    showModal('√âxito', '¬°Corte realizado con √©xito!', false);
  });
});

$('btn-sumar').addEventListener('click', ()=>{
  const ids = getSelectedConsignIds();
  let suma = 0;
  ids.forEach(id=>{
    const item = currentConsignsSnapshot.find(c => c.id === id);
    if(item && !item.isSeparator) {
        suma += Number(item.valor || 0);
    }
  });
  showModal('Suma de Selecci√≥n', `La suma de los √≠tems seleccionados es: ${fmtCOP(suma)}`, false);
});

/* CALCULOS TOTALES */
// ** Total de Cuenta Actual (Depende de la lista actual en memoria) **
async function updateSelectedTotals(){ 
  if(!selectedAccountId){ 
    $('total-cuenta').textContent = fmtCOP(0); 
    console.log('No hay cuenta seleccionada');
    return; 
  }
  
  console.log('=== INICIANDO ACTUALIZACI√ìN DE TOTALES ===');
  console.log('Cuenta seleccionada:', selectedAccountId);
  console.log('Elementos en snapshot:', currentConsignsSnapshot.length);
  
  // M√©todo 1: Usar snapshot en memoria
  let totalMemoria = 0; 
  let foundRedSeparator = false;
  let elementosContados = 0;
  
  currentConsignsSnapshot.forEach((d, index) => { 
    console.log(`Elemento ${index}:`, {
      isSeparator: d.isSeparator,
      type: d.type,
      valor: d.valor,
      foundRedSeparator
    });
    
    // Si encontramos un separador rojo, paramos el conteo
    if (d.isSeparator && d.type === 'red') {
      foundRedSeparator = true;
      console.log('Encontrado separador rojo, parando conteo');
      return;
    }
    
    // Solo contar consignaciones normales del per√≠odo actual
    if (!foundRedSeparator && !d.isSeparator) {
      totalMemoria += Number(d.valor || 0);
      elementosContados++;
      console.log(`Sumando: ${d.valor}, total acumulado: ${totalMemoria}`);
    }
  }); 
  
  console.log(`Total calculado desde memoria: ${totalMemoria} (${elementosContados} elementos)`);
  
  // M√©todo 2: Consulta fresca a Firebase como backup
  try {
    const snapshot = await db.collection('cuentas').doc(selectedAccountId).collection('consignaciones')
      .orderBy('fecha', 'desc').get();
    
    let totalFirebase = 0;
    let foundRedSeparatorFB = false;
    
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.isSeparator && data.type === 'red') {
        foundRedSeparatorFB = true;
        return;
      }
      if (!foundRedSeparatorFB && !data.isSeparator) {
        totalFirebase += Number(data.valor || 0);
      }
    });
    
    console.log(`Total calculado desde Firebase: ${totalFirebase}`);
    
    // Usar el mayor de los dos totales (por si hay diferencias de sincronizaci√≥n)
    const totalFinal = Math.max(totalMemoria, totalFirebase);
    
    $('total-cuenta').textContent = fmtCOP(totalFinal);
    console.log(`=== TOTAL FINAL APLICADO: ${totalFinal} ===`);
    
    // Actualizar separador verde
    const greenSeparator = currentConsignsSnapshot.find(d => d.isSeparator && d.type === 'green');
    if (greenSeparator && greenSeparator.total !== totalFinal) {
      await db.collection('cuentas').doc(selectedAccountId).collection('consignaciones')
        .doc(greenSeparator.id).update({ total: totalFinal });
      console.log('Separador verde actualizado');
    }
    
  } catch(e) {
    console.error('Error en consulta Firebase:', e);
    // Usar solo el total de memoria si falla Firebase
    $('total-cuenta').textContent = fmtCOP(totalMemoria);
    console.log(`Total de memoria aplicado como fallback: ${totalMemoria}`);
  }
}

// ** Total General (Implementaci√≥n m√°s robusta sin CollectionGroup) **
async function updateTotalGeneral(){ 
  try{ 
    // 1. Obtener todas las cuentas
    const accountsSnapshot = await db.collection('cuentas').get();
    let total = 0; 
    
    // 2. Obtener las consignaciones para cada cuenta (en paralelo)
    const consignPromises = accountsSnapshot.docs.map(doc => 
        db.collection('cuentas').doc(doc.id).collection('consignaciones').get()
    );
    
    const allConsignSnapshots = await Promise.all(consignPromises);

    // 3. Sumar todas las consignaciones no-separadoras de todas las cuentas
    allConsignSnapshots.forEach(snap => {
        snap.forEach(d => {
            const data = d.data();
            if(!data.isSeparator) {
                total += Number(data.valor || 0);
            }
        });
    });

    $('total-general').textContent = fmtCOP(total); 
  }catch(e){ 
    console.error("Error al actualizar total general (VERIFIQUE CONSOLA):", e);
    // En caso de fallo, se asegura de mostrar 0 para evitar valores incorrectos o vac√≠os.
    $('total-general').textContent = fmtCOP(0); 
  } 
}
// Se llama al inicio en subscribeAccounts y luego cada vez que se actualiza una cuenta.
setInterval(updateTotalGeneral,15000); 

/* BUSQUEDA */
const filter = (id) => {
    const q = $(id).value.toLowerCase();
    document.querySelectorAll('#accounts-list .account-item').forEach(it => {
        it.style.display = it.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
};
$('search-name').addEventListener('input', () => filter('search-name'));
$('search-account').addEventListener('input', () => filter('search-account'));

window.addEventListener('load', ()=>{ 
    if(!usuario){ return; } 
    $('modal-options').classList.remove('hidden'); $('manager-pass').value=''; 
});
window.addEventListener('beforeunload', ()=>{ if(consignsUnsub) consignsUnsub(); });

// Funciones para el modal de datos grandes
function showDataModal(title, label, value, icon) {
    document.getElementById('data-modal-title').textContent = title;
    document.getElementById('data-modal-label').textContent = label;
    document.getElementById('data-modal-value').textContent = value;
    document.getElementById('data-modal-icon').textContent = icon;
    document.getElementById('data-modal').style.display = 'block';
}

function closeDataModal() {
    document.getElementById('data-modal').style.display = 'none';
}

// Cerrar modal al hacer clic fuera
window.addEventListener('click', function(event) {
    const dataModal = document.getElementById('data-modal');
    if (event.target === dataModal) {
        closeDataModal();
    }
});

// Cerrar modal con Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeDataModal();
    }
});

// Agregar eventos de doble clic a las tarjetas de totales
setTimeout(() => {
    // Total General
    const totalGeneralCard = document.querySelector('.top-totals .card:nth-child(1)');
    if (totalGeneralCard) {
        totalGeneralCard.addEventListener('dblclick', function() {
            const value = document.getElementById('total-general').textContent;
            showDataModal('üí∞ TOTAL GENERAL', 'Suma de todas las cuentas', value, 'üè¶');
        });
        totalGeneralCard.style.cursor = 'pointer';
        totalGeneralCard.title = 'Doble clic para ver en grande';
    }

    // Total Cuenta Actual
    const totalCuentaCard = document.querySelector('.top-totals .card:nth-child(2)');
    if (totalCuentaCard) {
        totalCuentaCard.addEventListener('dblclick', function() {
            const value = document.getElementById('total-cuenta').textContent;
            const accountName = selectedAccountName || 'Cuenta Actual';
            showDataModal('üè¶ TOTAL CUENTA ACTUAL', accountName, value, 'üí≥');
        });
        totalCuentaCard.style.cursor = 'pointer';
        totalCuentaCard.title = 'Doble clic para ver en grande';
    }

    // Usuario
    const usuarioCard = document.querySelector('.top-totals .card:nth-child(3)');
    if (usuarioCard) {
        usuarioCard.addEventListener('dblclick', function() {
            const value = document.getElementById('user-info').textContent;
            showDataModal('üë§ USUARIO ACTIVO', 'Sesi√≥n actual', value, 'üîê');
        });
        usuarioCard.style.cursor = 'pointer';
        usuarioCard.title = 'Doble clic para ver en grande';
    }
}, 1000);

</script>
</body>
</html>
