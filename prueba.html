<!DOCTYPE html>
<html>
<head>
    <title>Panel de Control del Asesor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles - Inherited and adapted from generar_pedidos.html */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f2f5 0%, #e0e6ec 100%);
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow-x: hidden;
            animation: fadeInBackground 1s ease-out;
        }

        @keyframes fadeInBackground {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .container {
            width: 95%;
            max-width: 1000px; /* Wider container for dashboard */
            margin: 30px auto;
            padding: 30px;
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            display: flex; /* Use flexbox for main layout */
            flex-direction: column; /* Stack sections vertically */
            gap: 25px; /* Space between sections */
        }

        /* Titles */
        h1, h2 {
            color: #28a745;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        h1 {
            font-size: 2.2em;
            margin-bottom: 30px;
            color: #2e7d32;
        }
        h2 {
            font-size: 1.6em;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            text-align: left; /* Align section titles to left */
        }

        /* Welcome section */
        .welcome-section {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(45deg, #e6f7ed, #d9f0e3); /* Lighter green gradient */
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
        }
        .welcome-section p {
            font-size: 1.2em;
            color: #2e7d32;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: #fdfdfd;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
        }
        .stat-card h3 {
            margin-top: 0;
            color: #555;
            font-size: 1.1em;
            font-weight: 600;
        }
        .stat-card p {
            font-size: 1.8em;
            font-weight: 700;
            color: #28a745; /* Green for positive stats */
            margin: 10px 0 0;
        }
        .stat-card.retard-count p {
            color: #dc3545; /* Red for retarded count */
        }

        /* Buttons */
        .dashboard-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        .dashboard-actions button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            background-image: linear-gradient(135deg, #007bff 0%, #0056b3 100%); /* Blue gradient */
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
        }
        .dashboard-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.3);
            background-image: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        }

        /* Recent Orders Section */
        .recent-orders-list {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Space between order items */
        }

        .order-card {
            background-color: #fdfdfd;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            border-left: 5px solid transparent; /* Default border */
            transition: border-color 0.3s ease, box-shadow 0.2s ease;
        }
        .order-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .order-card.despachado {
            border-left-color: #28a745; /* Green for dispatched */
        }
        .order-card.retardado {
            border-left-color: #dc3545; /* Red for retarded */
            animation: pulseRedBorder 1.5s infinite alternate; /* Add pulse animation for retarded */
        }
        @keyframes pulseRedBorder {
            0% { border-left-color: #dc3545; box-shadow: 0 0 5px rgba(220, 53, 69, 0.3); }
            100% { border-left-color: #ff6347; box-shadow: 0 0 15px rgba(220, 53, 69, 0.7); }
        }

        .order-card.enviado-empaque {
            border-left-color: #007bff; /* Blue for in packing */
        }

        .order-card p {
            margin: 0;
            font-size: 0.95em;
            color: #555;
        }
        .order-card strong {
            color: #333;
        }

        .order-card .status-indicators {
            position: absolute;
            top: 10px;
            right: 15px;
            display: flex;
            gap: 10px;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
        }
        .status-badge.despachado-badge {
            background-color: #28a745;
        }
        .status-badge.retardado-badge {
            background-color: #dc3545;
            animation: pulseBadge 1.5s infinite alternate;
        }
        @keyframes pulseBadge {
            0% { transform: scale(1); opacity: 0.9; }
            100% { transform: scale(1.05); opacity: 1; }
        }
        .status-badge.enviado-empaque-badge {
            background-color: #007bff;
        }

        /* No orders message */
        .no-orders-message {
            text-align: center;
            font-style: italic;
            color: #777;
            padding: 20px;
            border: 1px dashed #ddd;
            border-radius: 8px;
            margin-top: 20px;
        }

        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            .container {
                margin: 20px auto;
                padding: 20px;
                border-radius: 8px;
                gap: 15px;
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.4em;
            }
            .welcome-section p {
                font-size: 1em;
            }
            .stats-grid {
                grid-template-columns: 1fr; /* Stack stats vertically on small screens */
            }
            .stat-card p {
                font-size: 1.5em;
            }
            .dashboard-actions {
                flex-direction: column; /* Stack buttons vertically */
                gap: 10px;
            }
            .dashboard-actions button {
                width: 100%;
            }
            .order-card {
                padding: 12px 15px;
                font-size: 0.9em;
            }
            .order-card .status-indicators {
                position: relative; /* Adjust position for smaller screens */
                top: auto;
                right: auto;
                margin-top: 10px;
                justify-content: flex-end; /* Align badges to the right if space allows */
                flex-wrap: wrap; /* Allow badges to wrap */
            }
            .status-badge {
                padding: 4px 8px;
                font-size: 0.75em;
            }
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="welcome-section">
            <p>¡Bienvenido de nuevo, <span id="advisor_name">Asesor</span>!</p>
            <h1>Panel de Control de Ventas</h1>
        </div>

        <h2>Tus Estadísticas Rápidas</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total de Pares Vendidos</h3>
                <p id="total_pairs_sold">0</p>
            </div>
            <div class="stat-card">
                <h3>Valor Total de Ventas</h3>
                <p id="total_sales_value">$0</p>
            </div>
            <div class="stat-card retard-count">
                <h3>Pedidos en Retardo</h3>
                <p id="retarded_orders_count">0</p>
            </div>
        </div>

        <div class="dashboard-actions">
            <button onclick="window.location.href='generar_pedidos.html';">Crear Nuevo Pedido</button>
            <button onclick="window.location.href='generar_pedidos.html?view=all';">Ver Todos Mis Pedidos</button>
        </div>

        <h2>Tus Últimos Pedidos</h2>
        <div id="recent_orders_list" class="recent-orders-list">
            <p class="no-orders-message">Cargando tus pedidos recientes...</p>
        </div>
    </div>

    <script>
        // NOTE: La lógica y funcionalidad de Firebase, autenticación y manejo de datos
        // permanece INALTERADA según los requisitos del usuario de generar_pedidos.html.
        // Se ha adaptado para este nuevo panel.

        const firebaseConfig = {
            apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU", // Asegúrate que esta API Key esté bien protegida y restringida
            authDomain: "lazapateria-c4157.firebaseapp.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.firebasestorage.app",
            measurementId: "G-HVG7615JEE"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log("Firebase configurado correctamente.");

        // Referencia al documento de configuración global para obtener el tiempo de retardo
        const globalSettingsRef = db.collection('settings').doc('global_block');
        let retardTimeMinutes = 20; // Default retard time

        let datosUsuario = JSON.parse(localStorage.getItem('datosUsuario'));
        console.log("Datos del usuario al inicio:", datosUsuario);

        if (!datosUsuario || !datosUsuario.permisos || !datosUsuario.nombreCompleto || !datosUsuario.usuario) {
            // If user data is missing, redirect to login or show an error
            alert("Error: No se pudieron cargar los datos del usuario. Por favor, inicie sesión de nuevo.");
            window.location.href = "login.html"; // Redirect to a login page if necessary
        }

        window.onload = function() {
            // Update advisor name
            document.getElementById('advisor_name').textContent = datosUsuario.nombreCompleto;

            // Fetch global settings to get retard time
            globalSettingsRef.get().then(doc => {
                if (doc.exists) {
                    retardTimeMinutes = doc.data().retardTimeMinutes !== undefined ? doc.data().retardTimeMinutes : 20;
                    console.log(`Tiempo de retardo configurado: ${retardTimeMinutes} minutos`);
                }
                fetchAdvisorData(); // Fetch advisor data after getting retard time
                setInterval(fetchAdvisorData, 30000); // Refresh data every 30 seconds
            }).catch(error => {
                console.error("Error fetching global settings:", error);
                fetchAdvisorData(); // Proceed with default retard time if error
                setInterval(fetchAdvisorData, 30000); // Refresh data every 30 seconds
            });
        };

        async function fetchAdvisorData() {
            console.log("Fetching advisor data...");
            const currentUserId = datosUsuario.usuario;
            const now = new Date();
            let totalPairsSold = 0;
            let totalSalesValue = 0;
            let retardedOrdersCount = 0;
            let recentOrdersHtml = '';

            try {
                // Fetch orders for the current advisor, ordered by date (most recent first)
                const querySnapshot = await db.collection('registros')
                    .where('usuario', '==', currentUserId)
                    .orderBy('fecha_hora', 'desc')
                    .limit(10) // Display only the 10 most recent orders
                    .get();

                if (querySnapshot.empty) {
                    recentOrdersHtml = '<p class="no-orders-message">No tienes pedidos registrados todavía.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const registro = doc.data();
                        const fechaHoraCreacion = registro.fecha_hora ? registro.fecha_hora.toDate() : null;

                        // Calculate stats
                        totalPairsSold += parseInt(registro.num_pares || 0);
                        totalSalesValue += parseFloat(registro.valor_total || 0);

                        // Check for retarded status for this specific order
                        const estaDespachado = registro.despachado === true;
                        const enviadoAEmpaque = registro.enviadoAEmpaque === true;
                        const isCurrentlyRetarded = !enviadoAEmpaque && !estaDespachado && fechaHoraCreacion && ((now.getTime() - fechaHoraCreacion.getTime()) / (1000 * 60) > retardTimeMinutes);

                        if (isCurrentlyRetarded) {
                            retardedOrdersCount++;
                        }

                        // Build recent orders list item
                        const orderDate = fechaHoraCreacion ? fechaHoraCreacion.toLocaleDateString('es-CO') : 'N/A';
                        const orderTime = fechaHoraCreacion ? fechaHoraCreacion.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', hour12: true }) : 'N/A';
                        const orderValue = (registro.valor_total || 0).toLocaleString('es-CO');

                        let statusBadges = '';
                        let cardClass = '';

                        if (isCurrentlyRetarded) {
                            statusBadges += `<span class="status-badge retardado-badge"><i class="fas fa-exclamation-triangle"></i> En Retardo</span>`;
                            cardClass += ' retardado';
                        }
                        if (registro.despachado) {
                            statusBadges += `<span class="status-badge despachado-badge"><i class="fas fa-check-circle"></i> Despachado</span>`;
                            cardClass += ' despachado';
                        } else if (registro.enviadoAEmpaque) {
                             statusBadges += `<span class="status-badge enviado-empaque-badge"><i class="fas fa-box"></i> En Empaque</span>`;
                             cardClass += ' enviado-empaque';
                        }


                        recentOrdersHtml += `
                            <div class="order-card${cardClass}">
                                <div class="status-indicators">${statusBadges}</div>
                                <p><strong>Cliente:</strong> ${registro.cliente || 'N/A'}</p>
                                <p><strong>Código:</strong> ${registro.codigo_unico || 'N/A'}</p>
                                <p><strong>Fecha:</strong> ${orderDate} ${orderTime}</p>
                                <p><strong>Pares:</strong> ${registro.num_pares || 0}</p>
                                <p><strong>Valor:</strong> $${orderValue}</p>
                            </div>
                        `;
                    });
                }

                // Update UI with fetched data
                document.getElementById('total_pairs_sold').textContent = totalPairsSold;
                document.getElementById('total_sales_value').textContent = `$${totalSalesValue.toLocaleString('es-CO')}`;
                document.getElementById('retarded_orders_count').textContent = retardedOrdersCount;
                document.getElementById('recent_orders_list').innerHTML = recentOrdersHtml;

            } catch (error) {
                console.error("Error fetching advisor data:", error);
                document.getElementById('recent_orders_list').innerHTML = '<p class="no-orders-message">Error al cargar tus pedidos. Por favor, inténtalo de nuevo.</p>';
            }
        }
    </script>
</body>
</html>
