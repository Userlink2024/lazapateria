<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Permisos - La Zapateria, UPM y Milan</title>
    <!-- Font Awesome para los iconos (engranaje y salir) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos generales (adaptados de permisos.html) */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            box-sizing: border-box; /* Incluye padding en el ancho total */
        }
        h1, h2 {
            color: #00BFFF; /* Azul claro */
            text-align: center;
        }
        h1 {
            font-size: 1.6em;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        .form-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        input:focus, textarea:focus, select:focus, button:focus {
            border-color: #00BFFF;
            outline: none;
        }
        button {
            background-color: #00BFFF;
            color: white;
            cursor: pointer;
            margin-top: 10px;
            padding: 10px 15px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button:hover {
            background-color: #009ACD;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* Botón específico para Denegar */
        button.deny-button {
            background-color: #dc3545; /* Rojo */
        }
        button.deny-button:hover {
            background-color: #c82333; /* Rojo más oscuro */
        }

        /* Estilos de Modales */
        .modal {
            display: none; /* Oculto por defecto */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px; /* Ancho por defecto para modales pequeños */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Estilo específico para el modal de lista de permisos */
        #view_permits_modal .modal-content {
            max-width: 95%; /* Más ancho para la lista de permisos */
            width: 95%;
            padding: 15px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
        }

        /* Estilo para los Registros de Permisos */
        .permit-record {
            background-color: #f9f9f9;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 0.9em;
            position: relative;
            overflow: hidden;
        }
        .permit-record p {
            margin: 5px 0;
        }
        .permit-record strong {
            color: #00BFFF;
        }
        .permit-record .buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas pequeñas */
        }
        .permit-record .buttons button {
            flex: 1; /* Distribuye el espacio equitativamente */
            min-width: 120px; /* Ancho mínimo para los botones */
        }

        /* Indicadores de Estado */
        .status-container {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .status-pendiente {
            background-color: #ffc107; /* Amarillo */
            color: #333;
        }
        .status-autorizado {
            background-color: #66CDAA; /* Verde-azul claro */
            color: white;
        }
        .status-rechazado {
            background-color: #dc3545; /* Rojo */
            color: white;
        }
        .signature-section {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
        }
        .signature-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .signature-item input[type="checkbox"] {
            margin-right: 10px;
            width: auto;
            height: auto;
        }
        .signature-item label {
            margin-bottom: 0;
            font-weight: normal;
        }
        .signature-details {
            margin-left: auto; /* Empuja los detalles a la derecha */
            font-size: 0.85em;
            color: #555;
            font-weight: bold;
        }
        .signature-details.signed {
            color: #00BFFF;
        }
        .signature-details.pending {
            color: #ffc107;
        }

        /* Filtros y Búsqueda */
        .filters-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-end;
        }
        .filters-container .form-field {
            flex: 1;
            min-width: 180px;
        }
        .filters-container button {
            margin-top: 0;
        }

        /* Barra de Carga */
        #loading-bar {
            width: 100%;
            background-color: #e0e0e0;
            margin-top: 20px;
            border-radius: 5px;
            overflow: hidden;
            display: none;
        }
        #loading-bar-fill {
            height: 25px;
            width: 0%;
            background-color: #00BFFF;
            text-align: center;
            line-height: 25px;
            color: white;
            border-radius: 5px;
        }

        /* Ajustes Responsivos */
        @media (max-width: 600px) {
            .container {
                margin: 10px auto;
                padding: 15px;
            }
            h1 {
                font-size: 1.3em;
            }
            h2 {
                font-size: 1.1em;
            }
            button {
                padding: 8px 12px;
                font-size: 0.9em;
            }
            .modal-content {
                padding: 15px;
            }
            #view_permits_modal .modal-content {
                max-width: 98%;
                width: 98%;
                padding: 10px;
            }
            .filters-container {
                flex-direction: column;
                align-items: stretch;
            }
            .filters-container .form-field {
                min-width: unset;
                width: 100%;
            }
            .permit-record .buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .permit-record .buttons button {
                min-width: unset;
                width: 100%;
            }
        }

        /* --- Estilos personalizados para el Login y Configuración --- */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5; /* Mismo fondo que el body */
            width: 100%; /* Asegura que ocupe todo el ancho para centrar */
        }
        #login-form-box, #change-password-box {
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        #login-form-box h2, #change-password-box h2 {
            margin-bottom: 30px;
            color: #00BFFF;
        }
        #login-form-box input[type="text"], /* Cambiado de email a text */
        #login-form-box input[type="password"],
        #change-password-box input[type="password"],
        #change-password-box input[type="text"] {
            width: calc(100% - 20px); /* Ancho total menos padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #login-form-box button,
        #change-password-box button {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            margin-top: 20px;
        }
        .error-message {
            color: red;
            margin-top: 10px;
            font-size: 0.9em;
            min-height: 20px; /* Reserva espacio para evitar saltos de diseño */
        }
        .success-message {
            color: green;
            margin-top: 10px;
            font-size: 0.9em;
            min-height: 20px;
        }

        /* Encabezado de la aplicación (cuando se ha iniciado sesión) */
        #app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #00BFFF;
            color: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #app-header h1 {
            margin: 0;
            color: white;
            font-size: 1.5em;
            text-align: left;
        }
        #app-header .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #app-header .header-controls button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
            margin-top: 0; /* Anula el margen general de botón */
        }
        #app-header .header-controls button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        #current-user-info {
            font-size: 0.9em;
            margin-right: 15px;
            white-space: nowrap; /* Evita que el texto se rompa */
        }
    </style>
</head>
<body>

    <!-- Contenedor de Inicio de Sesión -->
    <div id="login-container">
        <div id="login-form-box">
            <h2>Iniciar Sesión</h2>
            <form id="login-form" onsubmit="handleLogin(event)">
                <input type="text" id="login_username" placeholder="Nombre de Usuario" required>
                <input type="password" id="login_password" placeholder="Contraseña" required>
                <button type="submit">Entrar</button>
                <p id="login-error-message" class="error-message"></p>
            </form>
        </div>
    </div>

    <!-- Contenedor Principal de la Aplicación (Oculto por defecto) -->
    <div id="app-container" style="display: none;">
        <div class="container">
            <!-- Encabezado de la aplicación con información de usuario y controles -->
            <div id="app-header">
                <h1>Sistema de Solicitud de Permisos</h1>
                <div class="header-controls">
                    <span id="current-user-info">Cargando usuario...</span>
                    <button onclick="showModal('change_password_modal')" title="Cambiar Contraseña">
                        <i class="fas fa-cog"></i> <!-- Icono de Engranaje -->
                    </button>
                    <button onclick="handleLogout()" title="Cerrar Sesión">
                        <i class="fas fa-sign-out-alt"></i> <!-- Icono de Salir -->
                    </button>
                </div>
            </div>

            <!-- Contenido del formulario de permisos y gestión (copiado de permisos.html) -->
            <section style="margin-top: 20px;">
                <h2>Solicitar Nuevo Permiso</h2>
                <form id="permit_form" onsubmit="submitPermit(event)">
                    <div class="form-field">
                        <label for="worker_name">Nombre del Trabajador:</label>
                        <input type="text" id="worker_name" required readonly>
                    </div>
                    <div class="form-field">
                        <label for="document_id">Documento:</label>
                        <input type="text" id="document_id" required>
                    </div>
                    <div class="form-field">
                        <label for="cellphone">Celular:</label>
                        <input type="tel" id="cellphone" required>
                    </div>
                    <div class="form-field">
                        <label for="cargo">Cargo:</label>
                        <input type="text" id="cargo" required>
                    </div>
                    <div class="form-field">
                        <label for="immediate_boss">Jefe Inmediato:</label>
                        <input type="text" id="immediate_boss" value="Juan Carlos Barrios" required readonly>
                    </div>
                    <div class="form-field">
                        <label for="permit_type">Tipo de Permiso:</label>
                        <select id="permit_type" required>
                            <option value="">Seleccione uno</option>
                            <option value="Personal">Personal</option>
                            <option value="Remunerado">Remunerado</option>
                            <option value="No Remunerado">No Remunerado</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="reason">Motivo del Permiso:</label>
                        <textarea id="reason" rows="3" required></textarea>
                    </div>

                    <h3>Información del Permiso:</h3>
                    <div class="form-field">
                        <label for="start_date">INICIO:</label>
                        <input type="date" id="start_date" onchange="updateTimeAuthorized()" required>
                    </div>
                    <div class="form-field">
                        <label for="end_date">Finalización:</label>
                        <input type="date" id="end_date" onchange="updateTimeAuthorized()" required>
                    </div>
                    <div class="form-field">
                        <label for="start_time">Hora Inicio:</label>
                        <input type="time" id="start_time" onchange="updateTimeAuthorized()" required>
                    </div>
                    <div class="form-field">
                        <label for="end_time">Hora Finalización:</label>
                        <input type="time" id="end_time" onchange="updateTimeAuthorized()" required>
                    </div>
                    <div class="form-field">
                        <label for="time_authorized">Tiempo autorizado:</label>
                        <input type="text" id="time_authorized" readonly>
                    </div>

                    <button type="submit">Enviar Solicitud</button>
                </form>
            </section>

            <hr style="margin: 40px 0; border: none; border-top: 1px dashed #ccc;">

            <!-- Botón para abrir el Modal de Gestión de Permisos -->
            <button onclick="showModal('view_permits_modal')" style="display: block; margin: 20px auto;">Ver Solicitudes</button>

            <!-- Barra de Carga -->
            <div id="loading-bar">
                <div id="loading-bar-fill">0%</div>
            </div>

            <!-- Modal de Gestión de Permisos -->
            <div id="view_permits_modal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeModal('view_permits_modal')">&times;</span>
                    <h2>Gestión de Permisos</h2>
                    <div class="filters-container">
                        <div class="form-field">
                            <label for="filter_worker_name">Filtrar por Trabajador:</label>
                            <select id="filter_worker_name">
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="filter_permit_type">Tipo de Permiso:</label>
                            <select id="filter_permit_type">
                                <option value="all">Todos</option>
                                <option value="Personal">Personal</option>
                                <option value="Remunerado">Remunerado</option>
                                <option value="No Remunerado">No Remunerado</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="filter_status">Estado:</label>
                            <select id="filter_status">
                                <option value="all">Todos</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Autorizado">Autorizado</option>
                                <option value="Rechazado">Rechazado</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="filter_start_date">Fecha Inicio:</label>
                            <input type="date" id="filter_start_date">
                        </div>
                        <div class="form-field">
                            <label for="filter_end_date">Fecha Fin:</label>
                            <input type="date" id="filter_end_date">
                        </div>
                        <button onclick="applyFilters()">Aplicar Filtros</button>
                        <button onclick="document.getElementById('filter_worker_name').value = 'all'; document.getElementById('filter_permit_type').value = 'all'; document.getElementById('filter_status').value = 'all'; document.getElementById('filter_start_date').value = ''; document.getElementById('filter_end_date').value = ''; applyFilters();">Limpiar Filtros</button>
                    </div>

                    <button onclick="exportPermitsToExcel()" id="export_excel_btn" style="margin-bottom: 20px;">Exportar a Excel</button>

                    <div id="permit_list">
                        <p>Cargando permisos...</p>
                    </div>
                </div>
            </div>

            <!-- Modal para Editar Permiso -->
            <div id="edit_permit_modal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeModal('edit_permit_modal')">&times;</span>
                    <h2>Editar Permiso</h2>
                    <form id="edit_permit_form" onsubmit="saveEditedPermit(event)">
                        <div class="form-field">
                            <label for="edit_worker_name">Nombre del Trabajador:</label>
                            <input type="text" id="edit_worker_name" required>
                        </div>
                        <div class="form-field">
                            <label for="edit_document_id">Documento:</label>
                            <input type="text" id="edit_document_id" required>
                        </div>
                        <div class="form-field">
                            <label for="edit_cellphone">Celular:</label>
                            <input type="tel" id="edit_cellphone" required>
                        </div>
                        <div class="form-field">
                            <label for="edit_cargo">Cargo:</label>
                            <input type="text" id="edit_cargo" required>
                        </div>
                        <div class="form-field">
                            <label for="edit_immediate_boss">Jefe Inmediato:</label>
                            <input type="text" id="edit_immediate_boss" value="Juan Carlos Barrios" required readonly>
                        </div>
                        <div class="form-field">
                            <label for="edit_permit_type">Tipo de Permiso:</label>
                            <select id="edit_permit_type" required>
                                <option value="Personal">Personal</option>
                                <option value="Remunerado">Remunerado</option>
                                <option value="No Remunerado">No Remunerado</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="edit_reason">Motivo del Permiso:</label>
                            <textarea id="edit_reason" rows="3" required></textarea>
                        </div>

                        <h3>Información del Permiso:</h3>
                        <div class="form-field">
                            <label for="edit_start_date">INICIO:</label>
                            <input type="date" id="edit_start_date" onchange="updateEditTimeAuthorized()" required>
                        </div>
                        <div class="form-field">
                            <label for="edit_end_date">Finalización:</label>
                            <input type="date" id="edit_end_date" onchange="updateEditTimeAuthorized()" required>
                        </div>
                        <div class="form-field">
                            <label for="edit_start_time">Hora Inicio:</label>
                            <input type="time" id="edit_start_time" onchange="updateEditTimeAuthorized()" required>
                        </div>
                        <div class="form-field">
                            <label for="edit_end_time">Hora Finalización:</label>
                            <input type="time" id="edit_end_time" onchange="updateEditTimeAuthorized()" required>
                        </div>
                        <div class="form-field">
                            <label for="edit_time_authorized">Tiempo autorizado:</label>
                            <input type="text" id="edit_time_authorized" readonly>
                        </div>

                        <button type="submit">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Cambiar Contraseña -->
    <div id="change_password_modal" class="modal">
        <div class="modal-content" id="change-password-box">
            <span class="close" onclick="closeModal('change_password_modal')">&times;</span>
            <h2>Cambiar Contraseña</h2>
            <form id="change-password-form" onsubmit="handleChangePassword(event)">
                <div class="form-field">
                    <label for="cp_username">Nombre de Usuario (Correo Electrónico de la cuenta):</label>
                    <input type="text" id="cp_username" readonly> <!-- Se rellena automáticamente con el correo del usuario loggeado -->
                </div>
                <div class="form-field">
                    <label for="cp_current_password">Contraseña Actual:</label>
                    <input type="password" id="cp_current_password" required>
                </div>
                <div class="form-field">
                    <label for="cp_new_password">Nueva Contraseña:</label>
                    <input type="password" id="cp_new_password" required>
                </div>
                <div class="form-field">
                    <label for="cp_confirm_new_password">Confirmar Nueva Contraseña:</label>
                    <input type="password" id="cp_confirm_new_password" required>
                </div>
                <button type="submit">Cambiar Contraseña</button>
                <p id="password-change-error-message" class="error-message"></p>
                <p id="password-change-success-message" class="success-message"></p>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs y otras bibliotecas -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <!-- XLSX para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- jsPDF y html2canvas para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Inicialización de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
            authDomain: "lazapateria-c4157.firebaseapp.com",
            databaseURL: "https://lazapateria-c4157-default-rtdb.firebaseio.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.firebasestorage.app",
            messagingSenderId: "300241769138",
            appId: "1:300241769138:web:8ca1847de3c4fb5042afab",
            measurementId: "G-HVG7615JEE"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        console.log("Firebase configurado correctamente.");

        let datosUsuario = null; // Se poblará después del inicio de sesión exitoso con datos de Firestore

        // Estado global para permisos y filtros
        let permitsListenerUnsubscribe = null;
        let currentPermitsData = []; // Para almacenar todos los permisos obtenidos de Firestore
        let currentFilters = {
            workerName: 'all',
            permitType: 'all',
            status: 'all',
            startDate: '',
            endDate: ''
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // Escucha cambios en el estado de autenticación de Firebase
            auth.onAuthStateChanged(async (user) => {
                const loginContainer = document.getElementById('login-container');
                const appContainer = document.getElementById('app-container');
                const currentUserInfoSpan = document.getElementById('current-user-info');

                if (user) {
                    console.log("Usuario autenticado:", user.uid);
                    loginContainer.style.display = 'none'; // Oculta el formulario de login
                    appContainer.style.display = 'block'; // Muestra el contenido de la aplicación

                    // Carga los detalles del usuario desde Firestore (ej. rol, nombre completo)
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            datosUsuario = userDoc.data();
                            datosUsuario.usuario = user.uid; // Añade el UID de Firebase al objeto datosUsuario
                            console.log("Datos de usuario cargados de Firestore:", datosUsuario);

                            currentUserInfoSpan.textContent = `Bienvenido, ${datosUsuario.nombreCompleto || user.email}`;
                            document.getElementById('worker_name').value = datosUsuario.nombreCompleto;
                            // Configura el campo del jefe inmediato como "Juan Carlos Barrios" y lo hace de solo lectura
                            document.getElementById('immediate_boss').value = "Juan Carlos Barrios";
                            document.getElementById('immediate_boss').readOnly = true;

                            // Ajusta la visibilidad del botón "Exportar a Excel" según el rol del usuario
                            if (datosUsuario.permisos && datosUsuario.permisos.toLowerCase() === 'administrador') {
                                document.getElementById('export_excel_btn').style.display = 'block';
                            } else {
                                document.getElementById('export_excel_btn').style.display = 'none';
                            }

                            // Inicializa filtros y el listener de permisos en tiempo real
                            document.getElementById('filter_worker_name').addEventListener('change', applyFilters);
                            document.getElementById('filter_permit_type').addEventListener('change', applyFilters);
                            document.getElementById('filter_status').addEventListener('change', applyFilters);
                            document.getElementById('filter_start_date').addEventListener('change', applyFilters);
                            document.getElementById('filter_end_date').addEventListener('change', applyFilters);

                            // Establece la fecha actual como valor por defecto para las fechas en el formulario de creación
                            const today = new Date().toISOString().slice(0, 10);
                            document.getElementById('start_date').value = today;
                            document.getElementById('end_date').value = today;
                            updateTimeAuthorized();

                            startPermitsRealtimeListener();

                        } else {
                            console.warn("Documento de usuario no encontrado en Firestore para UID:", user.uid);
                            currentUserInfoSpan.textContent = `Bienvenido, ${user.email} (Rol no definido)`;
                            // Si no se encuentra el documento del usuario, cierra la sesión para evitar acceso no autorizado a las funciones de la aplicación
                            handleLogout();
                        }
                    } catch (error) {
                        console.error("Error al cargar datos del usuario desde Firestore:", error);
                        // No usar alert(), usar modal personalizado
                        document.getElementById('login-error-message').textContent = 'Error al cargar los datos del usuario. Por favor, intente de nuevo.';
                        handleLogout(); // Forzar cierre de sesión en caso de error
                    }

                } else {
                    console.log("Ningún usuario autenticado.");
                    loginContainer.style.display = 'flex'; // Muestra el formulario de login
                    appContainer.style.display = 'none'; // Oculta el contenido de la aplicación
                    datosUsuario = null; // Limpia los datos del usuario
                    if (permitsListenerUnsubscribe) {
                        permitsListenerUnsubscribe(); // Desvincula el listener si el usuario cierra sesión
                    }
                }
            });
        });

        // --- Funciones de Autenticación ---
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login_username').value;
            const password = document.getElementById('login_password').value;
            const errorMessageDiv = document.getElementById('login-error-message');
            errorMessageDiv.textContent = ''; // Limpia el error anterior

            // Construir el "email" para Firebase usando el nombre de usuario
            // Asegúrate de que este dominio coincida con cómo configuras los usuarios en Firebase Auth
            const emailForFirebase = `${username}@lazapateria.com`;

            try {
                showLoadingBar();
                await auth.signInWithEmailAndPassword(emailForFirebase, password);
                // El listener onAuthStateChanged se encargará de actualizar la UI
                // No usar alert() aquí, el listener ya manejará el éxito
            } catch (error) {
                console.error("Error de inicio de sesión:", error);
                let message = "Error al iniciar sesión.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-email') {
                    // Combinar user-not-found y wrong-password e invalid-email para dar un mensaje genérico por seguridad
                    message = "Nombre de usuario o contraseña incorrectos. Por favor, verifique sus credenciales.";
                } else if (error.code === 'auth/too-many-requests') {
                    message = "Demasiados intentos fallidos. Intente de nuevo más tarde.";
                }
                errorMessageDiv.textContent = message;
            } finally {
                hideLoadingBar();
            }
        }

        async function handleLogout() {
            // Utiliza un modal personalizado o un mensaje en la UI para la confirmación
            const confirmed = await new Promise(resolve => {
                const logoutConfirmDiv = document.createElement('div');
                logoutConfirmDiv.style.position = 'fixed';
                logoutConfirmDiv.style.top = '0';
                logoutConfirmDiv.style.left = '0';
                logoutConfirmDiv.style.width = '100%';
                logoutConfirmDiv.style.height = '100%';
                logoutConfirmDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
                logoutConfirmDiv.style.display = 'flex';
                logoutConfirmDiv.style.justifyContent = 'center';
                logoutConfirmDiv.style.alignItems = 'center';
                logoutConfirmDiv.style.zIndex = '1001';
                logoutConfirmDiv.innerHTML = `
                    <div style="background-color: white; padding: 20px; border-radius: 8px; text-align: center; max-width: 300px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        <p>¿Está seguro de que desea cerrar la sesión?</p>
                        <button id="confirmLogoutBtn" style="margin-right: 10px; background-color: #00BFFF;">Sí</button>
                        <button id="cancelLogoutBtn" style="background-color: #dc3545;">No</button>
                    </div>
                `;
                document.body.appendChild(logoutConfirmDiv);

                document.getElementById('confirmLogoutBtn').onclick = () => {
                    document.body.removeChild(logoutConfirmDiv);
                    resolve(true);
                };
                document.getElementById('cancelLogoutBtn').onclick = () => {
                    document.body.removeChild(logoutConfirmDiv);
                    resolve(false);
                };
            });

            if (!confirmed) {
                return;
            }

            try {
                showLoadingBar();
                await auth.signOut();
                // El listener onAuthStateChanged se encargará de actualizar la UI
                // No usar alert() aquí, el listener ya manejará el éxito
                // Limpiar el mensaje de error/éxito del login después de cerrar sesión
                document.getElementById('login-error-message').textContent = '';
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                document.getElementById('login-error-message').textContent = "Error al cerrar sesión. Por favor, intente de nuevo.";
                document.getElementById('login-error-message').style.color = 'red';
            } finally {
                hideLoadingBar();
            }
        }

        async function handleChangePassword(event) {
            event.preventDefault();
            const currentUser = auth.currentUser;
            const currentPassword = document.getElementById('cp_current_password').value;
            const newPassword = document.getElementById('cp_new_password').value;
            const confirmNewPassword = document.getElementById('cp_confirm_new_password').value;
            const errorMessageDiv = document.getElementById('password-change-error-message');
            const successMessageDiv = document.getElementById('password-change-success-message');

            errorMessageDiv.textContent = '';
            successMessageDiv.textContent = '';

            if (newPassword !== confirmNewPassword) {
                errorMessageDiv.textContent = 'La nueva contraseña y su confirmación no coinciden.';
                return;
            }
            if (newPassword.length < 6) {
                errorMessageDiv.textContent = 'La nueva contraseña debe tener al menos 6 caracteres.';
                return;
            }

            if (!currentUser) {
                errorMessageDiv.textContent = 'No hay usuario autenticado.';
                return;
            }

            try {
                showLoadingBar();
                // Reautenticar al usuario para operaciones sensibles como el cambio de contraseña
                const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPassword);
                await currentUser.reauthenticateWithCredential(credential);
                await currentUser.updatePassword(newPassword);

                successMessageDiv.textContent = 'Contraseña cambiada con éxito. Por favor, inicie sesión de nuevo con su nueva contraseña.';
                // Opcional: Forzar cierre de sesión para que el usuario inicie con la nueva contraseña
                setTimeout(() => {
                    closeModal('change_password_modal');
                    handleLogout();
                }, 2000);

            } catch (error) {
                console.error("Error al cambiar contraseña:", error);
                let message = "Error al cambiar la contraseña.";
                if (error.code === 'auth/requires-recent-login') {
                    message = "Por favor, inicie sesión de nuevo para cambiar su contraseña. (Necesita reautenticarse).";
                } else if (error.code === 'auth/wrong-password') {
                    message = "La contraseña actual es incorrecta.";
                } else if (error.code === 'auth/weak-password') {
                    message = "La nueva contraseña es demasiado débil. Necesita ser más compleja.";
                }
                errorMessageDiv.textContent = message;
            } finally {
                hideLoadingBar();
            }
        }


        // --- Funciones de Utilidad (Copiadas de permisos.html, con ajustes menores) ---
        function showLoadingBar() {
            const loadingBar = document.getElementById("loading-bar");
            const loadingBarFill = document.getElementById("loading-bar-fill");
            if (loadingBar && loadingBarFill) {
                loadingBar.style.display = "block";
                loadingBarFill.style.width = "0%";
                let width = 0;
                const interval = setInterval(() => {
                    if (width >= 100) {
                        clearInterval(interval);
                    } else {
                        width++;
                        loadingBarFill.style.width = width + "%";
                        loadingBarFill.innerText = width + "%";
                    }
                }, 10);
            }
        }

        function hideLoadingBar() {
            const loadingBar = document.getElementById("loading-bar");
            if (loadingBar) {
                loadingBar.style.display = "none";
            }
        }

        function showModal(id) {
            document.getElementById(id).style.display = 'flex';
            // Si se abre el modal de cambio de contraseña, precarga el correo del usuario
            if (id === 'change_password_modal' && auth.currentUser) {
                document.getElementById('cp_username').value = auth.currentUser.email;
                document.getElementById('cp_current_password').value = '';
                document.getElementById('cp_new_password').value = '';
                document.getElementById('cp_confirm_new_password').value = '';
                document.getElementById('password-change-error-message').textContent = '';
                document.getElementById('password-change-success-message').textContent = '';
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            // Si se cierra el modal de permisos, limpia los filtros para la próxima apertura
            if (id === 'view_permits_modal') {
                document.getElementById('filter_worker_name').value = 'all';
                document.getElementById('filter_permit_type').value = 'all';
                document.getElementById('filter_status').value = 'all';
                document.getElementById('filter_start_date').value = '';
                document.getElementById('filter_end_date').value = '';
                applyFilters();
            }
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('es-CO');
        }

        function formatTime(timeString) {
            if (!timeString) return 'N/A';
            const [hours, minutes] = timeString.split(':');
            const date = new Date();
            date.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return date.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', hour12: true });
        }

        function calculateTimeAuthorized(start_date, end_date, start_time, end_time) {
            const startDateTime = new Date(`${start_date}T${start_time}`);
            const endDateTime = new Date(`${end_date}T${end_time}`);

            if (isNaN(startDateTime.getTime()) || isNaN(endDateTime.getTime())) {
                return "Fechas/Horas inválidas";
            }

            const diffMs = endDateTime - startDateTime;
            if (diffMs < 0) {
                return "Fecha/hora final debe ser posterior a la inicial";
            }

            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMinutes / 60);
            const remainingMinutes = diffMinutes % 60;
            const diffDays = Math.floor(diffHours / 24);
            const remainingHours = diffHours % 24;

            let result = [];
            if (diffDays > 0) result.push(`${diffDays} día(s)`);
            if (remainingHours > 0) result.push(`${remainingHours} hora(s)`);
            if (remainingMinutes > 0) result.push(`${remainingMinutes} minuto(s)`);

            return result.length > 0 ? result.join(', ') : '0 minutos';
        }

        function updateTimeAuthorized() {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;

            const timeAuthorized = calculateTimeAuthorized(startDate, endDate, startTime, endTime);
            document.getElementById('time_authorized').value = timeAuthorized;
        }

        function updateEditTimeAuthorized() {
            const startDate = document.getElementById('edit_start_date').value;
            const endDate = document.getElementById('edit_end_date').value;
            const startTime = document.getElementById('edit_start_time').value;
            const endTime = document.getElementById('edit_end_time').value;

            const timeAuthorized = calculateTimeAuthorized(startDate, endDate, startTime, endTime);
            document.getElementById('edit_time_authorized').value = timeAuthorized;
        }

        // --- Envío de Formulario de Permisos (Adaptado para usar datosUsuario global) ---
        async function submitPermit(event) {
            event.preventDefault();
            if (!datosUsuario || !datosUsuario.usuario || !datosUsuario.nombreCompleto) {
                document.getElementById('login-error-message').textContent = "Error: Datos de usuario no disponibles. Por favor, inicie sesión correctamente.";
                document.getElementById('login-error-message').style.color = 'red';
                return;
            }
            showLoadingBar();

            const workerName = document.getElementById('worker_name').value;
            const documentId = document.getElementById('document_id').value;
            const cellphone = document.getElementById('cellphone').value;
            const cargo = document.getElementById('cargo').value;
            const immediateBoss = document.getElementById('immediate_boss').value;
            const permitType = document.getElementById('permit_type').value;
            const reason = document.getElementById('reason').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;
            const timeAuthorized = document.getElementById('time_authorized').value;

            const permitData = {
                workerName,
                documentId,
                cellphone,
                cargo,
                immediateBoss,
                permitType,
                reason,
                startDate,
                endDate,
                startTime,
                endTime,
                timeAuthorized,
                submissionDate: firebase.firestore.Timestamp.fromDate(new Date()),
                submittedBy: datosUsuario.nombreCompleto,
                userId: datosUsuario.usuario, // Usa el campo 'usuario' del Firestore
                signedByWorker: false,
                workerSignatureName: null,
                workerSignatureDate: null,
                signedByJefe: false,
                jefeSignatureName: '',
                jefeSignatureDate: null,
                signedByRRHH: false,
                rrhhSignatureName: '',
                rrhhSignatureDate: null,
                status: 'Pendiente',
                denialReason: ''
            };

            try {
                await db.collection('permisos').add(permitData);
                document.getElementById('login-error-message').textContent = 'Solicitud de permiso enviada con éxito!';
                document.getElementById('login-error-message').style.color = 'green';
                document.getElementById('permit_form').reset();
                document.getElementById('immediate_boss').value = "Juan Carlos Barrios";
                document.getElementById('worker_name').value = datosUsuario.nombreCompleto;
                updateTimeAuthorized();
            } catch (error) {
                console.error("Error al enviar el permiso:", error);
                document.getElementById('login-error-message').textContent = 'Error al enviar la solicitud de permiso.';
                document.getElementById('login-error-message').style.color = 'red';
            } finally {
                hideLoadingBar();
                setTimeout(() => {
                    document.getElementById('login-error-message').textContent = '';
                    document.getElementById('login-error-message').style.color = 'red'; // Reset color
                }, 3000);
            }
        }

        // --- Visualización y Filtrado de Permisos (Adaptado para usar datosUsuario global) ---
        function startPermitsRealtimeListener() {
            if (permitsListenerUnsubscribe) {
                permitsListenerUnsubscribe();
            }

            let query = db.collection('permisos').orderBy('submissionDate', 'desc');

            // Operadores y Bodegueros solo ven sus propios permisos
            if (datosUsuario && datosUsuario.permisos) {
                if (datosUsuario.permisos.toLowerCase() === 'operador' || datosUsuario.permisos.toLowerCase() === 'bodeguero') {
                    console.log(`[Firestore Query] Filtrando permisos para el usuario: ${datosUsuario.usuario}`);
                    query = query.where('userId', '==', datosUsuario.usuario);
                } else {
                    console.log(`[Firestore Query] Obteniendo todos los permisos para Administrador/otros roles.`);
                }
            } else {
                console.warn("[Firestore Query] datosUsuario o permisos no definidos. Obteniendo todos los permisos (podría ser un riesgo de seguridad si no es intencionado).");
            }


            permitsListenerUnsubscribe = query.onSnapshot(snapshot => {
                console.log(`[Firestore Listener] Documentos devueltos por Firestore: ${snapshot.size}`);
                currentPermitsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateWorkerNameFilter(currentPermitsData);
                applyFilters();
            }, error => {
                console.error("Error al escuchar permisos:", error);
                console.error("Detalle del error:", error);
                if (error.code === 'failed-precondition' && error.message.includes('The query requires an index')) {
                    document.getElementById('permit_list').innerHTML = `
                        <p style="color: red; font-weight: bold;">Error: Se requiere un índice de Firestore.</p>
                        <p>Por favor, visita la consola de Firebase para crear el índice necesario para esta consulta:</p>
                        <p><a href="${error.message.split('You can create it here: ')[1]}" target="_blank" style="color: #00BFFF;">Crear Índice de Firestore</a></p>
                        <p>Una vez creado, la visibilidad de los permisos debería funcionar correctamente.</p>
                    `;
                } else {
                    document.getElementById('permit_list').innerHTML = '<p>Error al cargar los permisos. Revisa la consola para más detalles.</p>';
                }
            });
        }

        function populateWorkerNameFilter(permits) {
            const filterDropdown = document.getElementById('filter_worker_name');
            const originalValue = filterDropdown.value;
            filterDropdown.innerHTML = '<option value="all">Todos</option>';

            const uniqueWorkerNames = new Set();
            permits.forEach(permit => {
                if (permit.workerName) {
                    uniqueWorkerNames.add(permit.workerName);
                }
            });

            Array.from(uniqueWorkerNames).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                filterDropdown.appendChild(option);
            });

            if (originalValue && uniqueWorkerNames.has(originalValue)) {
                filterDropdown.value = originalValue;
            } else {
                filterDropdown.value = 'all';
            }
        }

        function applyFilters() {
            currentFilters.workerName = document.getElementById('filter_worker_name').value;
            currentFilters.permitType = document.getElementById('filter_permit_type').value;
            currentFilters.status = document.getElementById('filter_status').value;
            currentFilters.startDate = document.getElementById('filter_start_date').value;
            currentFilters.endDate = document.getElementById('filter_end_date').value;

            let filteredPermits = currentPermitsData.filter(permit => {
                const matchesWorkerName = currentFilters.workerName === 'all' || permit.workerName === currentFilters.workerName;
                const matchesType = currentFilters.permitType === 'all' || permit.permitType === currentFilters.permitType;
                const matchesStatus = currentFilters.status === 'all' || permit.status === currentFilters.status;

                let matchesDate = true;
                if (currentFilters.startDate && permit.startDate) {
                    matchesDate = matchesDate && (permit.startDate >= currentFilters.startDate);
                }
                if (currentFilters.endDate && permit.endDate) {
                    matchesDate = matchesDate && (permit.endDate <= currentFilters.endDate);
                }

                return matchesWorkerName && matchesType && matchesStatus && matchesDate;
            });

            renderPermits(filteredPermits);
        }

        function renderPermits(permitsToRender) {
            const permitListDiv = document.getElementById('permit_list');
            permitListDiv.innerHTML = '';

            if (permitsToRender.length === 0) {
                permitListDiv.innerHTML = '<p>No hay permisos para mostrar con los filtros aplicados.</p>';
                return;
            }

            permitsToRender.forEach(permit => {
                const isAdministrator = datosUsuario && datosUsuario.permisos && datosUsuario.permisos.toLowerCase() === 'administrador';
                const currentUserUID = auth.currentUser ? auth.currentUser.uid : null;

                const permitDiv = document.createElement('div');
                permitDiv.className = 'permit-record';
                permitDiv.dataset.id = permit.id;

                let statusClass = '';
                if (permit.status === 'Pendiente') statusClass = 'status-pendiente';
                else if (permit.status === 'Autorizado') statusClass = 'status-autorizado';
                else if (permit.status === 'Rechazado') statusClass = 'status-rechazado';

                const isWorkerSigned = permit.signedByWorker;
                const isJefeSigned = permit.signedByJefe;
                const isRrhhSigned = permit.signedByRRHH;

                const hasAnySignature = isWorkerSigned || isJefeSigned || isRrhhSigned;
                // Un usuario solo puede editar su propio permiso si no está firmado y no tiene estado final
                const canEdit = isAdministrator || (permit.userId === datosUsuario.usuario && !hasAnySignature && permit.status !== 'Autorizado' && permit.status !== 'Rechazado');
                const canDeny = isAdministrator && permit.status !== 'Autorizado' && permit.status !== 'Rechazado';
                const canDelete = isAdministrator;

                permitDiv.innerHTML = `
                    <p><strong>Trabajador:</strong> ${permit.workerName}</p>
                    <p><strong>Tipo de Permiso:</strong> ${permit.permitType}</p>
                    <p><strong>Motivo:</strong> ${permit.reason}</p>
                    <p><strong>Periodo:</strong> ${formatDate(permit.startDate)} ${formatTime(permit.startTime)} - ${formatDate(permit.endDate)} ${formatTime(permit.endTime)}</p>
                    <p><strong>Tiempo Autorizado:</strong> ${permit.timeAuthorized}</p>
                    ${permit.status === 'Rechazado' && permit.denialReason ? `<p style="color:red; font-weight:bold;">Motivo de Negación: ${permit.denialReason}</p>` : ''}
                    <div class="signature-section">
                        <h4>Firmas:</h4>
                        <div class="signature-item">
                            <input type="checkbox" id="worker_sign_${permit.id}" ${isWorkerSigned ? 'checked' : ''} ${!(permit.userId === datosUsuario.usuario || isAdministrator) || isWorkerSigned ? 'disabled' : ''} onchange="handleWorkerSignature('${permit.id}', this.checked)">
                            <label for="worker_sign_${permit.id}">Firma Trabajador</label>
                            <span class="signature-details ${isWorkerSigned ? 'signed' : 'pending'}">${isWorkerSigned ? `Firmado por ${permit.workerSignatureName || 'N/A'} (${permit.workerSignatureDate ? formatDate(permit.workerSignatureDate) : 'N/A'})` : 'Pendiente'}</span>
                        </div>
                        <div class="signature-item">
                            <input type="checkbox" id="jefe_sign_${permit.id}" ${isJefeSigned ? 'checked' : ''} ${!isAdministrator ? 'disabled' : ''} onchange="handleJefeSignature('${permit.id}', this.checked)">
                            <label for="jefe_sign_${permit.id}">Firma Jefe Inmediato</label>
                            <span class="signature-details ${isJefeSigned ? 'signed' : 'pending'}">${isJefeSigned ? `Firmado por ${permit.jefeSignatureName} (${permit.jefeSignatureDate ? formatDate(permit.jefeSignatureDate) : 'N/A'})` : 'Pendiente'}</span>
                        </div>
                        <div class="signature-item">
                            <input type="checkbox" id="rrhh_sign_${permit.id}" ${isRrhhSigned ? 'checked' : ''} ${!isAdministrator ? 'disabled' : ''} onchange="handleRRHHSignature('${permit.id}', this.checked)">
                            <label for="rrhh_sign_${permit.id}">Firma RR. HH</label>
                            <span class="signature-details ${isRrhhSigned ? 'signed' : 'pending'}">${isRrhhSigned ? `Firmado por ${permit.rrhhSignatureName} (${permit.rrhhSignatureDate ? formatDate(permit.rrhhSignatureDate) : 'N/A'})` : 'Pendiente'}</span>
                        </div>
                    </div>
                    <div class="status-container ${statusClass}">
                        Estado: ${permit.status}
                    </div>
                    <div class="buttons">
                        <button onclick="openEditPermitModal('${permit.id}')" ${!canEdit ? 'disabled' : ''}>Editar</button>
                        <button class="deny-button" onclick="denyPermit('${permit.id}')" ${!canDeny ? 'disabled' : ''}>Negar</button>
                        <button onclick="deletePermit('${permit.id}')" ${!canDelete ? 'disabled' : ''}>Eliminar</button>
                        <button onclick="printPermitToPDF('${permit.id}')">Imprimir PDF</button>
                    </div>
                `;
                permitListDiv.appendChild(permitDiv);
            });
        }


        // --- Manejo de Firmas (Adaptado para usar datosUsuario global y UID de Firebase) ---
        async function handleWorkerSignature(permitId, isChecked) {
            const currentUserUID = auth.currentUser ? auth.currentUser.uid : null;
            const isAdministrator = datosUsuario && datosUsuario.permisos && datosUsuario.permisos.toLowerCase() === 'administrador';

            if (!isChecked) { // Intentando desmarcar
                if (!isAdministrator) {
                    document.getElementById(`worker_sign_${permitId}`).checked = true;
                    document.getElementById('login-error-message').textContent = "Solo un administrador puede desmarcar la firma del trabajador.";
                    document.getElementById('login-error-message').style.color = 'red';
                    setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                    return;
                }
                const confirmed = await new Promise(resolve => {
                    const confirmDiv = document.createElement('div');
                    confirmDiv.style.position = 'fixed'; confirmDiv.style.top = '0'; confirmDiv.style.left = '0';
                    confirmDiv.style.width = '100%'; confirmDiv.style.height = '100%';
                    confirmDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    confirmDiv.style.display = 'flex'; confirmDiv.style.justifyContent = 'center'; confirmDiv.style.alignItems = 'center';
                    confirmDiv.style.zIndex = '1001';
                    confirmDiv.innerHTML = `
                        <div style="background-color: white; padding: 20px; border-radius: 8px; text-align: center; max-width: 300px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                            <p>¿Está seguro de que un administrador quiere desmarcar la firma del trabajador?</p>
                            <button id="confirmBtn" style="margin-right: 10px; background-color: #00BFFF;">Sí</button>
                            <button id="cancelBtn" style="background-color: #dc3545;">No</button>
                        </div>
                    `;
                    document.body.appendChild(confirmDiv);
                    document.getElementById('confirmBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(true); };
                    document.getElementById('cancelBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(false); };
                });
                if (!confirmed) {
                    document.getElementById(`worker_sign_${permitId}`).checked = true;
                    return;
                }
                const updates = { signedByWorker: false, workerSignatureName: null, workerSignatureDate: null, status: 'Pendiente' };
                await updatePermitInFirestore(permitId, updates);

            } else { // Intentando marcar
                const permitRef = db.collection('permisos').doc(permitId);
                const docSnap = await permitRef.get();
                const permit = docSnap.data();

                // Solo el trabajador que solicitó el permiso o un admin puede firmar como trabajador
                if (permit.userId !== datosUsuario.usuario && !isAdministrator) {
                    document.getElementById(`worker_sign_${permitId}`).checked = false;
                    document.getElementById('login-error-message').textContent = "Solo el trabajador que solicitó el permiso o un administrador puede firmar esto.";
                    document.getElementById('login-error-message').style.color = 'red';
                    setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                    return;
                }

                const confirmed = await new Promise(resolve => {
                    const confirmDiv = document.createElement('div');
                    confirmDiv.style.position = 'fixed'; confirmDiv.style.top = '0'; confirmDiv.style.left = '0';
                    confirmDiv.style.width = '100%'; confirmDiv.style.height = '100%';
                    confirmDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    confirmDiv.style.display = 'flex'; confirmDiv.style.justifyContent = 'center'; confirmDiv.style.alignItems = 'center';
                    confirmDiv.style.zIndex = '1001';
                    confirmDiv.innerHTML = `
                        <div style="background-color: white; padding: 20px; border-radius: 8px; text-align: center; max-width: 300px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                            <p>¿Está seguro de firmar? Una vez firmado por el trabajador, los Operadores y Bodegueros no podrán modificar el permiso.</p>
                            <button id="confirmBtn" style="margin-right: 10px; background-color: #00BFFF;">Sí</button>
                            <button id="cancelBtn" style="background-color: #dc3545;">No</button>
                        </div>
                    `;
                    document.body.appendChild(confirmDiv);
                    document.getElementById('confirmBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(true); };
                    document.getElementById('cancelBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(false); };
                });

                if (!confirmed) {
                    document.getElementById(`worker_sign_${permitId}`).checked = false;
                    return;
                }
                const updates = {
                    signedByWorker: true,
                    workerSignatureName: datosUsuario ? datosUsuario.nombreCompleto : (auth.currentUser ? auth.currentUser.email : 'Usuario Desconocido'),
                    workerSignatureDate: firebase.firestore.Timestamp.fromDate(new Date())
                };
                await updatePermitInFirestore(permitId, updates);
            }
        }

        async function handleJefeSignature(permitId, isChecked) {
            const isAdministrator = datosUsuario && datosUsuario.permisos && datosUsuario.permisos.toLowerCase() === 'administrador';
            if (!isAdministrator) {
                document.getElementById(`jefe_sign_${permitId}`).checked = !isChecked;
                document.getElementById('login-error-message').textContent = "Solo un administrador puede firmar o desmarcar la firma del Jefe Inmediato.";
                document.getElementById('login-error-message').style.color = 'red';
                setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                return;
            }
            if (!isChecked) {
                const confirmed = await new Promise(resolve => {
                    const confirmDiv = document.createElement('div');
                    confirmDiv.style.position = 'fixed'; confirmDiv.style.top = '0'; confirmDiv.style.left = '0';
                    confirmDiv.style.width = '100%'; confirmDiv.style.height = '100%';
                    confirmDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    confirmDiv.style.display = 'flex'; confirmDiv.style.justifyContent = 'center'; confirmDiv.style.alignItems = 'center';
                    confirmDiv.style.zIndex = '1001';
                    confirmDiv.innerHTML = `
                        <div style="background-color: white; padding: 20px; border-radius: 8px; text-align: center; max-width: 300px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                            <p>¿Está seguro de que un administrador quiere desmarcar la firma del Jefe Inmediato?</p>
                            <button id="confirmBtn" style="margin-right: 10px; background-color: #00BFFF;">Sí</button>
                            <button id="cancelBtn" style="background-color: #dc3545;">No</button>
                        </div>
                    `;
                    document.body.appendChild(confirmDiv);
                    document.getElementById('confirmBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(true); };
                    document.getElementById('cancelBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(false); };
                });
                if (!confirmed) {
                    document.getElementById(`jefe_sign_${permitId}`).checked = true;
                    return;
                }
                const updates = { signedByJefe: false, jefeSignatureName: '', jefeSignatureDate: null, status: 'Pendiente' };
                await updatePermitInFirestore(permitId, updates);
            } else {
                const updates = {
                    signedByJefe: true,
                    jefeSignatureName: datosUsuario ? datosUsuario.nombreCompleto : (auth.currentUser ? auth.currentUser.email : 'Usuario Desconocido'),
                    jefeSignatureDate: firebase.firestore.Timestamp.fromDate(new Date())
                };
                await updatePermitInFirestore(permitId, updates);
            }
        }

        async function handleRRHHSignature(permitId, isChecked) {
            const isAdministrator = datosUsuario && datosUsuario.permisos && datosUsuario.permisos.toLowerCase() === 'administrador';
            if (!isAdministrator) {
                document.getElementById(`rrhh_sign_${permitId}`).checked = !isChecked;
                document.getElementById('login-error-message').textContent = "Solo un administrador puede firmar o desmarcar la firma de RR. HH.";
                document.getElementById('login-error-message').style.color = 'red';
                setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                return;
            }
            if (!isChecked) {
                const confirmed = await new Promise(resolve => {
                    const confirmDiv = document.createElement('div');
                    confirmDiv.style.position = 'fixed'; confirmDiv.style.top = '0'; confirmDiv.style.left = '0';
                    confirmDiv.style.width = '100%'; confirmDiv.style.height = '100%';
                    confirmDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    confirmDiv.style.display = 'flex'; confirmDiv.style.justifyContent = 'center'; confirmDiv.style.alignItems = 'center';
                    confirmDiv.style.zIndex = '1001';
                    confirmDiv.innerHTML = `
                        <div style="background-color: white; padding: 20px; border-radius: 8px; text-align: center; max-width: 300px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                            <p>¿Está seguro de que un administrador quiere desmarcar la firma de RR. HH?</p>
                            <button id="confirmBtn" style="margin-right: 10px; background-color: #00BFFF;">Sí</button>
                            <button id="cancelBtn" style="background-color: #dc3545;">No</button>
                        </div>
                    `;
                    document.body.appendChild(confirmDiv);
                    document.getElementById('confirmBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(true); };
                    document.getElementById('cancelBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(false); };
                });
                if (!confirmed) {
                    document.getElementById(`rrhh_sign_${permit.id}`).checked = true;
                    return;
                }
                const updates = { signedByRRHH: false, rrhhSignatureName: '', rrhhSignatureDate: null, status: 'Pendiente' };
                await updatePermitInFirestore(permitId, updates);
            } else {
                const updates = {
                    signedByRRHH: true,
                    rrhhSignatureName: datosUsuario ? datosUsuario.nombreCompleto : (auth.currentUser ? auth.currentUser.email : 'Usuario Desconocido'),
                    rrhhSignatureDate: firebase.firestore.Timestamp.fromDate(new Date())
                };
                await updatePermitInFirestore(permitId, updates);
            }
        }

        async function updatePermitInFirestore(permitId, updates) {
            showLoadingBar();
            try {
                const permitRef = db.collection('permisos').doc(permitId);
                await permitRef.update(updates);

                const docSnap = await permitRef.get();
                if (docSnap.exists) {
                    const updatedPermit = docSnap.data();
                    let newStatus = 'Pendiente';
                    if (updatedPermit.signedByWorker && updatedPermit.signedByJefe && updatedPermit.signedByRRHH) {
                        newStatus = 'Autorizado';
                    }
                    if (updatedPermit.status === 'Rechazado' && !updates.status) {
                        newStatus = 'Rechazado';
                    } else if (updates.status) {
                        newStatus = updates.status;
                    }

                    if (updatedPermit.status !== newStatus) {
                        await permitRef.update({ status: newStatus });
                    }
                }
                console.log(`Permiso ${permitId} actualizado con éxito.`);
            }
            catch (error) {
                console.error("Error al actualizar el permiso en Firestore:", error);
                document.getElementById('login-error-message').textContent = "Error al actualizar el permiso.";
                document.getElementById('login-error-message').style.color = 'red';
            }
            finally {
                hideLoadingBar();
                setTimeout(() => {
                    document.getElementById('login-error-message').textContent = '';
                    document.getElementById('login-error-message').style.color = 'red';
                }, 3000);
            }
        }

        // --- Editar Permiso (Adaptado para usar datosUsuario global y UID de Firebase) ---
        let currentEditPermitId = null;

        async function openEditPermitModal(permitId) {
            showLoadingBar();
            try {
                const docRef = db.collection('permisos').doc(permitId);
                const docSnap = await docRef.get();

                if (!docSnap.exists) {
                    document.getElementById('login-error-message').textContent = "El permiso no existe.";
                    document.getElementById('login-error-message').style.color = 'red';
                    setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                    return;
                }
                const permit = docSnap.data();

                const isAdministrator = datosUsuario && datosUsuario.permisos && datosUsuario.permisos.toLowerCase() === 'administrador';
                const hasAnySignatureOrFinalStatus = permit.signedByWorker || permit.signedByJefe || permit.signedByRRHH || permit.status === 'Autorizado' || permit.status === 'Rechazado';

                // Si no es administrador y el permiso no pertenece al usuario actual
                if (!isAdministrator && permit.userId !== datosUsuario.usuario) {
                    document.getElementById('login-error-message').textContent = "No tiene permisos para editar este permiso.";
                    document.getElementById('login-error-message').style.color = 'red';
                    hideLoadingBar();
                    setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                    return;
                }

                // Si no es administrador y el permiso ya tiene alguna firma o estado final
                if (!isAdministrator && hasAnySignatureOrFinalStatus) {
                    document.getElementById('login-error-message').textContent = "Este permiso ya ha sido firmado o su estado es final y no puede ser modificado.";
                    document.getElementById('login-error-message').style.color = 'red';
                    hideLoadingBar();
                    setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                    return;
                }

                currentEditPermitId = permitId;
                document.getElementById('edit_worker_name').value = permit.workerName;
                document.getElementById('edit_document_id').value = permit.documentId;
                document.getElementById('edit_cellphone').value = permit.cellphone;
                document.getElementById('edit_cargo').value = permit.cargo;
                document.getElementById('edit_immediate_boss').value = permit.immediateBoss;
                document.getElementById('edit_immediate_boss').readOnly = true;
                document.getElementById('edit_permit_type').value = permit.permitType;
                document.getElementById('edit_reason').value = permit.reason;
                document.getElementById('edit_start_date').value = permit.startDate;
                document.getElementById('edit_end_date').value = permit.endDate;
                document.getElementById('edit_start_time').value = permit.startTime;
                document.getElementById('edit_end_time').value = permit.endTime;
                document.getElementById('edit_time_authorized').value = permit.timeAuthorized;

                // Deshabilita campos si no es administrador y el permiso ya está firmado/estado final
                const editFields = ['edit_worker_name', 'edit_document_id', 'edit_cellphone', 'edit_cargo', 'edit_permit_type', 'edit_reason', 'edit_start_date', 'edit_end_date', 'edit_start_time', 'edit_end_time'];
                editFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.disabled = !isAdministrator && hasAnySignatureOrFinalStatus;
                });

                showModal('edit_permit_modal');
            } catch (error) {
                console.error("Error al cargar permiso para editar:", error);
                document.getElementById('login-error-message').textContent = "Error al cargar permiso.";
                document.getElementById('login-error-message').style.color = 'red';
                setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
            } finally {
                hideLoadingBar();
            }
        }

        async function saveEditedPermit(event) {
            event.preventDefault();
            showLoadingBar();

            const isAdministrator = datosUsuario && datosUsuario.permisos && datosUsuario.permisos.toLowerCase() === 'administrador';
            const permitRef = db.collection('permisos').doc(currentEditPermitId);
            const docSnap = await permitRef.get();
            const permit = docSnap.data();
            const hasAnySignatureOrFinalStatus = permit.signedByWorker || permit.signedByJefe || permit.signedByRRHH || permit.status === 'Autorizado' || permit.status === 'Rechazado';

            if (!isAdministrator && permit.userId !== datosUsuario.usuario) {
                document.getElementById('login-error-message').textContent = "No tiene permisos para editar este permiso.";
                document.getElementById('login-error-message').style.color = 'red';
                hideLoadingBar();
                closeModal('edit_permit_modal');
                setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                return;
            }

            if (!isAdministrator && hasAnySignatureOrFinalStatus) {
                document.getElementById('login-error-message').textContent = "Este permiso ya ha sido firmado o su estado es final y no puede ser modificado.";
                document.getElementById('login-error-message').style.color = 'red';
                hideLoadingBar();
                closeModal('edit_permit_modal');
                setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                return;
            }

            const updatedData = {
                workerName: document.getElementById('edit_worker_name').value,
                documentId: document.getElementById('edit_document_id').value,
                cellphone: document.getElementById('edit_cellphone').value,
                cargo: document.getElementById('edit_cargo').value,
                immediateBoss: document.getElementById('edit_immediate_boss').value,
                permitType: document.getElementById('edit_permit_type').value,
                reason: document.getElementById('edit_reason').value,
                startDate: document.getElementById('edit_start_date').value,
                endDate: document.getElementById('edit_end_date').value,
                startTime: document.getElementById('edit_start_time').value,
                endTime: document.getElementById('edit_end_time').value,
                timeAuthorized: document.getElementById('edit_time_authorized').value,
            };

            try {
                await permitRef.update(updatedData);
                document.getElementById('login-error-message').textContent = 'Permiso actualizado con éxito!';
                document.getElementById('login-error-message').style.color = 'green';
                closeModal('edit_permit_modal');
            } catch (error) {
                console.error("Error al guardar permiso editado:", error);
                document.getElementById('login-error-message').textContent = 'Error al guardar el permiso.';
                document.getElementById('login-error-message').style.color = 'red';
            } finally {
                hideLoadingBar();
                setTimeout(() => {
                    document.getElementById('login-error-message').textContent = '';
                    document.getElementById('login-error-message').style.color = 'red';
                }, 3000);
            }
        }

        // --- Negar Permiso (Adaptado para usar datosUsuario global) ---
        async function denyPermit(permitId) {
            if (!datosUsuario || datosUsuario.permisos.toLowerCase() !== 'administrador') {
                document.getElementById('login-error-message').textContent = "Solo un administrador puede negar permisos.";
                document.getElementById('login-error-message').style.color = 'red';
                setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                return;
            }

            const reason = prompt("Ingrese el motivo de la negación del permiso:");
            if (reason === null || reason.trim() === '') {
                document.getElementById('login-error-message').textContent = "Debe ingresar un motivo para negar el permiso.";
                document.getElementById('login-error-message').style.color = 'red';
                setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                return;
            }

            const confirmed = await new Promise(resolve => {
                const confirmDiv = document.createElement('div');
                confirmDiv.style.position = 'fixed'; confirmDiv.style.top = '0'; confirmDiv.style.left = '0';
                confirmDiv.style.width = '100%'; confirmDiv.style.height = '100%';
                confirmDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
                confirmDiv.style.display = 'flex'; confirmDiv.style.justifyContent = 'center'; confirmDiv.style.alignItems = 'center';
                confirmDiv.style.zIndex = '1001';
                confirmDiv.innerHTML = `
                    <div style="background-color: white; padding: 20px; border-radius: 8px; text-align: center; max-width: 300px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        <p>¿Está seguro de que desea negar este permiso?</p>
                        <button id="confirmBtn" style="margin-right: 10px; background-color: #00BFFF;">Sí</button>
                        <button id="cancelBtn" style="background-color: #dc3545;">No</button>
                    </div>
                `;
                document.body.appendChild(confirmDiv);
                document.getElementById('confirmBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(true); };
                document.getElementById('cancelBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(false); };
            });

            if (!confirmed) {
                return;
            }

            const updates = { status: 'Rechazado', denialReason: reason };
            await updatePermitInFirestore(permitId, updates);
        }

        // --- Eliminar Permiso (Adaptado para usar datosUsuario global) ---
        async function deletePermit(permitId) {
            if (!datosUsuario || datosUsuario.permisos.toLowerCase() !== 'administrador') {
                document.getElementById('login-error-message').textContent = "Solo un administrador puede eliminar permisos.";
                document.getElementById('login-error-message').style.color = 'red';
                setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                return;
            }

            const confirmed = await new Promise(resolve => {
                const confirmDiv = document.createElement('div');
                confirmDiv.style.position = 'fixed'; confirmDiv.style.top = '0'; confirmDiv.style.left = '0';
                confirmDiv.style.width = '100%'; confirmDiv.style.height = '100%';
                confirmDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
                confirmDiv.style.display = 'flex'; confirmDiv.style.justifyContent = 'center'; confirmDiv.style.alignItems = 'center';
                confirmDiv.style.zIndex = '1001';
                confirmDiv.innerHTML = `
                    <div style="background-color: white; padding: 20px; border-radius: 8px; text-align: center; max-width: 300px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        <p>¿Está seguro de que desea eliminar este permiso? Esta acción no se puede deshacer.</p>
                        <button id="confirmBtn" style="margin-right: 10px; background-color: #00BFFF;">Sí</button>
                        <button id="cancelBtn" style="background-color: #dc3545;">No</button>
                    </div>
                `;
                document.body.appendChild(confirmDiv);
                document.getElementById('confirmBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(true); };
                document.getElementById('cancelBtn').onclick = () => { document.body.removeChild(confirmDiv); resolve(false); };
            });

            if (!confirmed) {
                return;
            }

            showLoadingBar();
            try {
                await db.collection('permisos').doc(permitId).delete();
                document.getElementById('login-error-message').textContent = "Permiso eliminado correctamente.";
                document.getElementById('login-error-message').style.color = 'green';
            } catch (error) {
                console.error("Error al eliminar permiso:", error);
                document.getElementById('login-error-message').textContent = "Error al eliminar el permiso.";
                document.getElementById('login-error-message').style.color = 'red';
            } finally {
                hideLoadingBar();
                setTimeout(() => {
                    document.getElementById('login-error-message').textContent = '';
                    document.getElementById('login-error-message').style.color = 'red';
                }, 3000);
            }
        }

        // --- Exportar a Excel (Adaptado para usar datosUsuario global) ---
        async function exportPermitsToExcel() {
            if (!datosUsuario || datosUsuario.permisos.toLowerCase() !== 'administrador') {
                document.getElementById('login-error-message').textContent = "Solo un administrador puede exportar a Excel.";
                document.getElementById('login-error-message').style.color = 'red';
                setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                return;
            }
            showLoadingBar();
            try {
                const snapshot = await db.collection('permisos').orderBy('submissionDate', 'asc').get();
                const data = snapshot.docs.map(doc => {
                    const permit = doc.data();
                    return {
                        "ID Permiso": doc.id,
                        "Fecha Solicitud": permit.submissionDate ? formatDate(permit.submissionDate) : 'N/A',
                        "Solicitado Por (ID)": permit.userId || 'N/A',
                        "Nombre Trabajador": permit.workerName,
                        "Documento": permit.documentId,
                        "Celular": permit.cellphone,
                        "Cargo": permit.cargo,
                        "Jefe Inmediato": permit.immediateBoss,
                        "Tipo de Permiso": permit.permitType,
                        "Motivo": permit.reason,
                        "Fecha Inicio": permit.startDate,
                        "Hora Inicio": permit.startTime,
                        "Fecha Fin": permit.endDate,
                        "Hora Fin": permit.endTime,
                        "Tiempo Autorizado": permit.timeAuthorized,
                        "Firma Trabajador": permit.signedByWorker ? `Sí (${permit.workerSignatureName || 'N/A'} - ${permit.workerSignatureDate ? formatDate(permit.workerSignatureDate) : 'N/A'})` : 'No',
                        "Firma Jefe": permit.signedByJefe ? `Sí (${permit.jefeSignatureName} - ${permit.jefeSignatureDate ? formatDate(permit.jefeSignatureDate) : 'N/A'})` : 'No',
                        "Firma RR.HH": permit.signedByRRHH ? `Sí (${permit.rrhhSignatureName} - ${permit.rrhhSignatureDate ? formatDate(permit.rrhhSignatureDate) : 'N/A'})` : 'No',
                        "Estado": permit.status,
                        "Motivo Negación": permit.denialReason || 'N/A'
                    };
                });

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Permisos");
                XLSX.writeFile(wb, "solicitudes_permisos.xlsx");
                document.getElementById('login-error-message').textContent = "Datos exportados a Excel con éxito.";
                document.getElementById('login-error-message').style.color = 'green';
            } catch (error) {
                console.error("Error al exportar a Excel:", error);
                document.getElementById('login-error-message').textContent = "Error al exportar los permisos a Excel.";
                document.getElementById('login-error-message').style.color = 'red';
            } finally {
                hideLoadingBar();
                setTimeout(() => {
                    document.getElementById('login-error-message').textContent = '';
                    document.getElementById('login-error-message').style.color = 'red';
                }, 3000);
            }
        }

        // --- Imprimir a PDF (Copiado de permisos.html) ---
        async function printPermitToPDF(permitId) {
            showLoadingBar();
            try {
                const docSnap = await db.collection('permisos').doc(permitId).get();
                if (!docSnap.exists) {
                    document.getElementById('login-error-message').textContent = "El permiso no existe.";
                    document.getElementById('login-error-message').style.color = 'red';
                    setTimeout(() => document.getElementById('login-error-message').textContent = '', 3000);
                    return;
                }
                const permit = docSnap.data();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');

                const tempDiv = document.createElement('div');
                tempDiv.style.fontFamily = 'Arial, sans-serif';
                tempDiv.style.fontSize = '10pt';
                tempDiv.style.padding = '20px';
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.width = '190mm';
                document.body.appendChild(tempDiv);

                tempDiv.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px; font-size: 24pt; font-weight: bold; color: red;">PROPULSAR BPO</div>
                    <h1 style="text-align: center; font-size: 14pt; margin-bottom: 5px; color: red;">SISTEMA DE GESTIÓN DE LA SEGURIDAD Y SALUD EN EL TRABAJO</h1>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 8pt;">
                        <tr>
                            <td style="border: 1px solid #000; padding: 5px; width: 25%;"><strong>Código SST - FR 04</strong></td>
                            <td style="border: 1px solid #000; padding: 5px; width: 25%;"><strong>Fecha Actualización:</strong> 8/02/2021</td>
                            <td style="border: 1px solid #000; padding: 5px; width: 25%;"><strong>Versión:</strong> 01</td>
                            <td style="border: 1px solid #000; padding: 5px; width: 25%;"><strong>Pág:</strong> 1 de 1</td>
                        </tr>
                    </table>
                    <h2 style="text-align: center; font-size: 12pt; margin-top: 15px; margin-bottom: 20px; color: red;">FORMATO DE SOLICITUD DE PERMISO (ESPECIAL, REMUNERADO, NO REMUNERADO)</h2>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;"><strong>Nombre del Trabajador:</strong> ${permit.workerName || 'N/A'}</td>
                            <td style="border: 1px solid #000; padding: 8px;"><strong>Documento:</strong> ${permit.documentId || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;"><strong>Celular:</strong> ${permit.cellphone || 'N/A'}</td>
                            <td style="border: 1px solid #000; padding: 8px;"><strong>Cargo:</strong> ${permit.cargo || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;" colspan="2"><strong>Jefe Inmediato:</strong> ${permit.immediateBoss || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;" colspan="2"><strong>Tipo de Permiso:</strong> ${permit.permitType || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;" colspan="2"><strong>MOTIVO DEL PERMISO:</strong> ${permit.reason || 'N/A'}</td>
                        </tr>
                    </table>

                    <h3 style="font-size: 11pt; margin-top: 20px; margin-bottom: 10px;">Información del Permiso:</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;"><strong>INICIO:</strong> ${formatDate(permit.startDate)}</td>
                            <td style="border: 1px solid #000; padding: 8px;"><strong>Finalización:</strong> ${formatDate(permit.endDate)}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;"><strong>Hora Inicio:</strong> ${formatTime(permit.startTime)}</td>
                            <td style="border: 1px solid #000; padding: 8px;"><strong>Hora Finalización:</strong> ${formatTime(permit.endTime)}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;" colspan="2"><strong>Tiempo autorizado:</strong> ${permit.timeAuthorized || 'N/A'}</td>
                        </tr>
                    </table>

                    <h3 style="font-size: 11pt; margin-top: 20px; margin-bottom: 10px;">Firmas:</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px; width: 33%;">
                                <strong>Firma digital del trabajador:</strong> ${permit.signedByWorker ? 'Firmado' : 'Pendiente'}
                                <br><em>${permit.workerSignatureName || ''} ${permit.workerSignatureDate ? formatDate(permit.workerSignatureDate) : ''}</em>
                            </td>
                            <td style="border: 1px solid #000; padding: 8px; width: 33%;">
                                <strong>Firma digital del Jefe Inmediato:</strong> ${permit.signedByJefe ? 'Firmado' : 'Pendiente'}
                                <br><em>${permit.jefeSignatureName || ''} ${permit.jefeSignatureDate ? formatDate(permit.jefeSignatureDate) : ''}</em>
                            </td>
                            <td style="border: 1px solid #000; padding: 8px; width: 34%;">
                                <strong>Firma digital de RR. HH:</strong> ${permit.signedByRRHH ? 'Firmado' : 'Pendiente'}
                                <br><em>${permit.rrhhSignatureName || ''} ${permit.rrhhSignatureDate ? formatDate(permit.rrhhSignatureDate) : ''}</em>
                            </td>
                        </tr>
                    </table>
                    <p style="text-align: right; margin-top: 30px; font-size: 9pt;">Estado del Permiso: <strong>${permit.status || 'N/A'}</strong></p>
                    ${permit.status === 'Rechazado' && permit.denialReason ? `<p style="text-align: right; margin-top: 5px; font-size: 9pt; color:red;">Motivo de Negación: ${permit.denialReason}</p>` : ''}
                    <p style="text-align: right; margin-top: 5px; font-size: 8pt;">Fecha de Solicitud: ${formatDate(permit.submissionDate)}</p>
                `;

                const canvas = await html2canvas(tempDiv, { scale: 2 });

                document.body.removeChild(tempDiv);

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const pageHeight = doc.internal.pageSize.height;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                doc.addImage(imgData, 'PNG', 10, position + 10, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 10, position + 10, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save(`Permiso_${permit.workerName.replace(/\s/g, '_')}_${permit.id}.pdf`);
                document.getElementById('login-error-message').textContent = "Permiso generado en PDF con éxito.";
                document.getElementById('login-error-message').style.color = 'green';
            } catch (error) {
                console.error("Error al imprimir PDF:", error);
                document.getElementById('login-error-message').textContent = "Error al generar el PDF del permiso. Asegúrese de que el permiso contenga todos los datos necesarios.";
                document.getElementById('login-error-message').style.color = 'red';
            } finally {
                hideLoadingBar();
                setTimeout(() => {
                    document.getElementById('login-error-message').textContent = '';
                    document.getElementById('login-error-message').style.color = 'red';
                }, 3000);
            }
        }
    </script>
</body>
</html>
