<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gráfica General</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root{
            --bg:#f6f8ff;
            --panel:#ffffff;
            --stroke:#e6eaf2;
            --text:#0b1220;
            --muted:#52607a;
            --brand1:#6d5efc; --brand2:#25b1ff;
            --good:#18c37e; --warn:#ffb020; --bad:#ff4d4f;
            --shadow:0 18px 50px rgba(16, 24, 40, .12);
        }
        *{box-sizing:border-box}
        body{
            margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
            background:
                radial-gradient(1200px 600px at 15% 10%, rgba(109,94,252,.16), transparent 62%),
                radial-gradient(1100px 700px at 85% 15%, rgba(37,177,255,.12), transparent 62%),
                var(--bg);
        }
        .wrap{max-width:1280px;margin:0 auto;padding:22px 16px 38px}
        .top{
            display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
            padding:14px 14px;border:1px solid var(--stroke);background:var(--panel);border-radius:16px;box-shadow:var(--shadow)
        }
        h1{margin:0;font-size:18px;letter-spacing:-.02em}
        .sub{margin-top:4px;color:var(--muted);font-size:12px}
        .btn{
            border:1px solid var(--stroke);
            background:#ffffff;
            color:var(--text);
            padding:10px 12px;
            border-radius:12px;
            cursor:pointer;
            font-weight:800;
            text-decoration:none;
            display:inline-flex;
            gap:8px;
            align-items:center
        }
        .btn.primary{border-color:rgba(109,94,252,.35);background:linear-gradient(135deg, rgba(109,94,252,.95), rgba(37,177,255,.85));color:#fff}
        .btn.ghost{background:#fff}
        .panel{margin-top:12px;border:1px solid var(--stroke);background:var(--panel);border-radius:16px;box-shadow:var(--shadow)}
        .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:end;padding:12px;border-bottom:1px solid var(--stroke)}
        label{font-size:12px;color:var(--muted)}
        input,select{
            border:1px solid var(--stroke);
            background:#ffffff;
            color:var(--text);
            border-radius:12px;
            padding:10px 12px;
            outline:none
        }
        .mini{color:var(--muted);font-size:12px;font-weight:800}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
        @media(max-width:980px){.grid{grid-template-columns:1fr}}
        .card{border:1px solid var(--stroke);background:#fff;border-radius:14px;padding:12px}
        .card h3{margin:0 0 10px 0;font-size:14px}
        .summary{display:grid;grid-template-columns:repeat(3, 1fr);gap:10px;padding:12px;border-bottom:1px solid var(--stroke)}
        @media(max-width:900px){.summary{grid-template-columns:1fr}}
        .chip{border:1px solid var(--stroke);background:#f7f9ff;border-radius:14px;padding:12px}
        .chip .lbl{color:var(--muted);font-size:12px;font-weight:800}
        .chip .val{margin-top:6px;font-weight:900;font-size:18px}
        table{width:100%;border-collapse:collapse}
        th,td{border-bottom:1px solid rgba(20, 30, 60, .10);padding:10px 8px;text-align:left;font-size:13px}
        th{font-size:12px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.04em}
        .pct{font-weight:900}
        .pct.good{color:var(--good)}
        .pct.warn{color:var(--warn)}
        .pct.bad{color:var(--bad)}

        .modal{position:fixed;inset:0;background:rgba(240,245,255,.92);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
        .modal.open{display:flex}
        .modal-card{width:min(920px,100%);border:1px solid rgba(20, 30, 60, .10);background:#ffffff;border-radius:16px;box-shadow:0 24px 70px rgba(8, 15, 35, .20);overflow:hidden;color:var(--text);display:flex;flex-direction:column;max-height:calc(100vh - 36px)}
        .modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(20, 30, 60, .10);flex:0 0 auto}
        .modal-head h3{margin:0;font-size:15px}
        .x{width:38px;height:38px;border-radius:12px;border:1px solid rgba(20, 30, 60, .14);background:rgba(240,245,255,.9);color:#0b1220;cursor:pointer;font-size:18px;font-weight:900}
        .modal-body{padding:14px;overflow:auto;flex:1 1 auto;min-height:0}
        .modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid rgba(20, 30, 60, .10);flex:0 0 auto}
        .meta-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
        @media(max-width:840px){.meta-grid{grid-template-columns:1fr}}
        .meta-row{border:1px solid var(--stroke);border-radius:14px;padding:12px;background:#f7f9ff}
        .meta-row strong{display:block;margin-bottom:8px}
        .meta-row .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    </style>
</head>
<body>
    <div class="wrap">
        <div class="top">
            <div>
                <h1>Gráfica general (año en curso)</h1>
                <div class="sub">Pares y valor total por mes, con metas configurables.</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <a class="btn ghost" href="ventas.html">Volver a ventas</a>
                <button class="btn" type="button" id="openMeta">Configurar metas</button>
                <button class="btn primary" type="button" id="reloadBtn">Recargar</button>
            </div>
        </div>

        <div class="panel">
            <div class="controls">
                <div>
                    <label for="yearSelect">Año</label>
                    <select id="yearSelect"></select>
                </div>
                <div class="mini" id="state" style="margin-left:auto">Conectando…</div>
            </div>
            <div class="summary">
                <div class="chip">
                    <div class="lbl">Total pares (año)</div>
                    <div class="val" id="sumPares">0</div>
                </div>
                <div class="chip">
                    <div class="lbl">Total valor (año)</div>
                    <div class="val" id="sumValor">$0</div>
                </div>
                <div class="chip">
                    <div class="lbl">Mes actual</div>
                    <div class="val" id="currentMonth">—</div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Valor total por mes</h3>
                    <canvas id="chartValor" height="130"></canvas>
                </div>
                <div class="card">
                    <h3>Pares por mes</h3>
                    <canvas id="chartPares" height="130"></canvas>
                </div>
            </div>

            <div class="card" style="margin:12px;">
                <h3>Resumen mensual</h3>
                <div style="overflow:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Mes</th>
                                <th>Pares</th>
                                <th>Meta pares</th>
                                <th>%</th>
                                <th>Valor</th>
                                <th>Meta valor</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="metaModal" aria-hidden="true">
        <div class="modal-card">
            <div class="modal-head">
                <h3>Metas mensuales</h3>
                <button class="x" type="button" id="metaClose">×</button>
            </div>
            <div class="modal-body">
                <div class="mini" style="margin-bottom:10px;">Define la meta de cada mes. Se guarda por año.</div>
                <div class="meta-grid" id="metaGrid"></div>
            </div>
            <div class="modal-actions">
                <div class="mini" id="metaState" style="margin-right:auto">—</div>
                <button class="btn" type="button" id="metaCancel">Cancelar</button>
                <button class="btn primary" type="button" id="metaSave">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
            authDomain: "lazapateria-c4157.firebaseapp.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.appspot.com",
            messagingSenderId: "514023223216",
            appId: "1:514023223216:web:56e8c870137d50e57ac0b2",
            measurementId: "G-L4F5HTZCW4"
        };

        if (!firebase.apps || !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        const $ = (id) => document.getElementById(id);
        const MONTHS = [
            { key: 'ene', label: 'Ene' },
            { key: 'feb', label: 'Feb' },
            { key: 'mar', label: 'Mar' },
            { key: 'abr', label: 'Abr' },
            { key: 'may', label: 'May' },
            { key: 'jun', label: 'Jun' },
            { key: 'jul', label: 'Jul' },
            { key: 'ago', label: 'Ago' },
            { key: 'sep', label: 'Sep' },
            { key: 'oct', label: 'Oct' },
            { key: 'nov', label: 'Nov' },
            { key: 'dic', label: 'Dic' }
        ];

        function formatCurrency(n) {
            const v = Number(n || 0);
            try {
                return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(v);
            } catch (e) {
                return '$' + Math.round(v).toLocaleString('es-CO');
            }
        }

        function pctClass(p) {
            if (!Number.isFinite(p)) return '';
            if (p >= 100) return 'good';
            if (p >= 80) return 'warn';
            return 'bad';
        }

        function safeTsToDate(ts) {
            if (!ts) return null;
            if (typeof ts.toDate === 'function') return ts.toDate();
            if (typeof ts === 'string' || typeof ts === 'number') {
                const d = new Date(ts);
                if (!Number.isNaN(d.getTime())) return d;
            }
            return null;
        }

        function defaultMetas() {
            return MONTHS.map(() => ({ pares: 0, valor: 0 }));
        }

        function metasLocalKey(year) {
            return `gg_metas_${year}`;
        }

        async function loadMetas(year) {
            const local = (() => {
                try {
                    const raw = localStorage.getItem(metasLocalKey(year));
                    if (!raw) return null;
                    const parsed = JSON.parse(raw);
                    if (!Array.isArray(parsed) || parsed.length !== 12) return null;
                    return parsed.map(x => ({ pares: Number(x && x.pares || 0), valor: Number(x && x.valor || 0) }));
                } catch (e) {
                    return null;
                }
            })();

            try {
                const docId = `graficageneral_${year}`;
                const snap = await db.collection('dashboard_settings').doc(docId).get();
                if (snap.exists) {
                    const d = snap.data() || {};
                    const metas = Array.isArray(d.metas) ? d.metas : null;
                    if (metas && metas.length === 12) {
                        const arr = metas.map(x => ({ pares: Number(x && x.pares || 0), valor: Number(x && x.valor || 0) }));
                        try { localStorage.setItem(metasLocalKey(year), JSON.stringify(arr)); } catch (e) {}
                        return arr;
                    }
                }
            } catch (e) {
                // fallback a local
            }

            return local || defaultMetas();
        }

        async function saveMetas(year, metas) {
            try { localStorage.setItem(metasLocalKey(year), JSON.stringify(metas)); } catch (e) {}
            try {
                const docId = `graficageneral_${year}`;
                await db.collection('dashboard_settings').doc(docId).set({
                    year: Number(year),
                    metas: metas,
                    updatedAt: firebase.firestore.Timestamp.fromDate(new Date())
                }, { merge: true });
                return { ok: true };
            } catch (e) {
                return { ok: false, error: e };
            }
        }

        let chartValor = null;
        let chartPares = null;
        let currentMetas = defaultMetas();

        function destroyCharts() {
            if (chartValor) { chartValor.destroy(); chartValor = null; }
            if (chartPares) { chartPares.destroy(); chartPares = null; }
        }

        function renderCharts(monthTotals) {
            destroyCharts();

            const labels = MONTHS.map(m => m.label);
            const dataValor = monthTotals.map(m => m.valor);
            const dataPares = monthTotals.map(m => m.pares);
            const goalValor = currentMetas.map(m => Number(m.valor || 0));
            const goalPares = currentMetas.map(m => Number(m.pares || 0));

            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, labels: { boxWidth: 10, boxHeight: 10 } },
                    tooltip: { mode: 'index', intersect: false }
                },
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { grid: { display: false } },
                    y: { grid: { color: 'rgba(20, 30, 60, .10)' }, ticks: { callback: (v) => String(v).toString() } }
                }
            };

            chartValor = new Chart($('chartValor').getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Valor',
                            data: dataValor,
                            backgroundColor: 'rgba(109, 94, 252, .75)',
                            borderColor: 'rgba(109, 94, 252, 1)',
                            borderWidth: 1,
                            borderRadius: 10
                        },
                        {
                            label: 'Meta valor',
                            data: goalValor,
                            type: 'line',
                            borderColor: 'rgba(255, 176, 32, 1)',
                            backgroundColor: 'rgba(255, 176, 32, .15)',
                            borderWidth: 3,
                            tension: .25,
                            pointRadius: 2
                        }
                    ]
                },
                options: Object.assign({}, baseOptions, {
                    scales: {
                        x: { grid: { display: false } },
                        y: { grid: { color: 'rgba(20, 30, 60, .10)' }, ticks: { callback: (v) => {
                            const n = Number(v || 0);
                            if (n >= 1000000) return (n / 1000000).toFixed(0) + 'M';
                            if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
                            return String(n);
                        } } }
                    }
                })
            });

            chartPares = new Chart($('chartPares').getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Pares',
                            data: dataPares,
                            backgroundColor: 'rgba(37, 177, 255, .70)',
                            borderColor: 'rgba(37, 177, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 10
                        },
                        {
                            label: 'Meta pares',
                            data: goalPares,
                            type: 'line',
                            borderColor: 'rgba(24, 195, 126, 1)',
                            backgroundColor: 'rgba(24, 195, 126, .15)',
                            borderWidth: 3,
                            tension: .25,
                            pointRadius: 2
                        }
                    ]
                },
                options: baseOptions
            });
        }

        function renderTable(monthTotals) {
            const tbody = $('tbody');
            tbody.innerHTML = '';

            monthTotals.forEach((m, idx) => {
                const goalP = Number(currentMetas[idx] && currentMetas[idx].pares || 0);
                const goalV = Number(currentMetas[idx] && currentMetas[idx].valor || 0);
                const pctP = goalP > 0 ? (m.pares / goalP) * 100 : NaN;
                const pctV = goalV > 0 ? (m.valor / goalV) * 100 : NaN;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:900;">${MONTHS[idx].key}</td>
                    <td>${Number(m.pares || 0).toLocaleString('es-CO')}</td>
                    <td>${goalP ? Number(goalP).toLocaleString('es-CO') : '—'}</td>
                    <td>${Number.isFinite(pctP) ? `<span class="pct ${pctClass(pctP)}">${pctP.toFixed(0)}%</span>` : '—'}</td>
                    <td>${formatCurrency(m.valor || 0)}</td>
                    <td>${goalV ? formatCurrency(goalV) : '—'}</td>
                    <td>${Number.isFinite(pctV) ? `<span class="pct ${pctClass(pctV)}">${pctV.toFixed(0)}%</span>` : '—'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderMetaInputs(year, metas) {
            const grid = $('metaGrid');
            grid.innerHTML = '';
            metas.forEach((m, idx) => {
                const box = document.createElement('div');
                box.className = 'meta-row';
                box.innerHTML = `
                    <strong>${MONTHS[idx].label} (${year})</strong>
                    <div class="row">
                        <div>
                            <label>Pares</label>
                            <input type="number" min="0" step="1" data-meta="pares" data-idx="${idx}" value="${Number(m.pares || 0)}" />
                        </div>
                        <div>
                            <label>Valor</label>
                            <input type="number" min="0" step="1" data-meta="valor" data-idx="${idx}" value="${Number(m.valor || 0)}" />
                        </div>
                    </div>
                `;
                grid.appendChild(box);
            });
        }

        function openMetaModal() {
            $('metaState').textContent = '—';
            $('metaModal').classList.add('open');
            $('metaModal').setAttribute('aria-hidden', 'false');
        }

        function closeMetaModal() {
            $('metaModal').classList.remove('open');
            $('metaModal').setAttribute('aria-hidden', 'true');
        }

        async function loadYearData(year) {
            $('state').textContent = 'Cargando ventas del año…';

            const start = new Date(Number(year), 0, 1, 0, 0, 0, 0);
            const end = new Date(Number(year), 11, 31, 23, 59, 59, 999);
            const fromTs = firebase.firestore.Timestamp.fromDate(start);
            const toTs = firebase.firestore.Timestamp.fromDate(end);

            const monthTotals = MONTHS.map(() => ({ pares: 0, valor: 0 }));

            try {
                const snap = await db.collection('registros')
                    .orderBy('fecha_hora', 'asc')
                    .where('fecha_hora', '>=', fromTs)
                    .where('fecha_hora', '<=', toTs)
                    .get();

                (snap.docs || []).forEach(doc => {
                    const r = doc.data() || {};
                    const d = safeTsToDate(r.fecha_hora);
                    if (!d) return;
                    const m = d.getMonth();
                    if (m < 0 || m > 11) return;
                    monthTotals[m].pares += Number(r.num_pares || 0);
                    monthTotals[m].valor += Number(r.valor_total || 0);
                });

                const totalPares = monthTotals.reduce((a, x) => a + Number(x.pares || 0), 0);
                const totalValor = monthTotals.reduce((a, x) => a + Number(x.valor || 0), 0);
                $('sumPares').textContent = Number(totalPares).toLocaleString('es-CO');
                $('sumValor').textContent = formatCurrency(totalValor);

                lastMonthTotals = monthTotals;

                const now = new Date();
                $('currentMonth').textContent = `${MONTHS[now.getMonth()].label} ${now.getFullYear()}`;

                renderCharts(monthTotals);
                renderTable(monthTotals);
                $('state').textContent = `Listo. Registros: ${(snap.docs || []).length}`;
            } catch (e) {
                console.error('Error cargando registros:', e);
                $('state').textContent = 'Error cargando datos.';
                lastMonthTotals = monthTotals;
                renderCharts(monthTotals);
                renderTable(monthTotals);
            }
        }

        function fillYearOptions() {
            const y = new Date().getFullYear();
            const sel = $('yearSelect');
            sel.innerHTML = '';
            for (let i = y - 2; i <= y + 1; i += 1) {
                const opt = document.createElement('option');
                opt.value = String(i);
                opt.textContent = String(i);
                if (i === y) opt.selected = true;
                sel.appendChild(opt);
            }
        }

        let lastMonthTotals = null;

        async function reloadAll() {
            const year = Number($('yearSelect').value || new Date().getFullYear());
            currentMetas = await loadMetas(year);
            renderMetaInputs(year, currentMetas);
            await loadYearData(year);
        }

        $('openMeta').addEventListener('click', () => {
            openMetaModal();
        });
        $('metaClose').addEventListener('click', closeMetaModal);
        $('metaCancel').addEventListener('click', closeMetaModal);
        $('metaModal').addEventListener('click', (e) => { if (e.target === $('metaModal')) closeMetaModal(); });

        $('metaSave').addEventListener('click', async () => {
            const year = Number($('yearSelect').value || new Date().getFullYear());
            const inputs = Array.from(document.querySelectorAll('#metaGrid input[data-meta]'));
            const metas = defaultMetas();
            inputs.forEach(inp => {
                const idx = Number(inp.getAttribute('data-idx'));
                const k = String(inp.getAttribute('data-meta'));
                if (!(idx >= 0 && idx <= 11)) return;
                const v = Number(inp.value || 0);
                metas[idx][k] = Number.isFinite(v) ? v : 0;
            });

            $('metaState').textContent = 'Guardando…';
            const res = await saveMetas(year, metas);
            currentMetas = metas;
            $('metaState').textContent = res.ok ? 'Guardado.' : 'No se pudo guardar en Firestore. Se guardó solo en este dispositivo.';
            if (lastMonthTotals) {
                renderCharts(lastMonthTotals);
                renderTable(lastMonthTotals);
            }
        });

        $('reloadBtn').addEventListener('click', () => { reloadAll(); });
        $('yearSelect').addEventListener('change', () => { reloadAll(); });

        fillYearOptions();
        reloadAll();
    </script>
</body>
</html>
