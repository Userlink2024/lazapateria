<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Transportadoras</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles - Modern, Clean, Mobile-First */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f2f5 0%, #e0e6ec 100%);
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top initially */
            min-height: 100vh;
            overflow-x: hidden;
            animation: fadeInBackground 1s ease-out;
        }

        @keyframes fadeInBackground {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .container {
            width: 95%; /* Wider for mobile, adjust as needed */
            max-width: 900px; /* Max width for desktop */
            margin: 20px auto; /* More vertical margin */
            padding: 20px; /* More padding */
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-sizing: border-box; /* Include padding in width/height */
        }

        /* Titles */
        h1, h2 {
            color: #2e7d32; /* Deep green */
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-size: 1.8em; /* Responsive font size */
        }
        h1 {
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        h2 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* Form Fields & Inputs */
        .form-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }
        input, select {
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background-color: #fcfcfc;
            width: 100%; /* Full width for inputs */
            box-sizing: border-box; /* Include padding in width */
        }
        input:focus, select:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
            outline: none;
            background-color: #fff;
        }

        /* Buttons */
        button, input[type="submit"] {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            color: white;
            background-image: linear-gradient(135deg, #28a745 0%, #218838 100%);
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
            letter-spacing: 0.5px;
            width: 100%; /* Full width for buttons */
            box-sizing: border-box;
        }

        button:hover, input[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
            background-image: linear-gradient(135deg, #218838 0%, #1e7030 100%);
        }

        button:active, input[type="submit"]:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(40, 167, 69, 0.2);
        }

        /* Login Screen Specifics */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh; /* Full height for login screen */
            position: fixed; /* Fixed to cover entire viewport */
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, #e0e6ec 0%, #f0f2f5 100%); /* Subtle gradient background */
            z-index: 2000; /* Ensure it's on top */
        }

        #login-screen .login-card {
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative; /* Needed for absolute positioning of gear icon */
        }

        #login-screen h1 {
            color: #28a745;
            margin-bottom: 25px;
        }

        #login-screen input[type="password"] {
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        #login-screen button {
            margin-top: 20px;
        }

        #login-error {
            color: #dc3545;
            margin-top: 15px;
            font-weight: 600;
        }
        
        #disclaimer-text {
            font-size: 0.75em; /* Smaller text for disclaimer */
            color: #777;
            margin-top: 20px;
            line-height: 1.3;
            text-align: center;
        }


        /* Dashboard Content */
        #dashboard-content {
            display: none; /* Hidden by default until login */
            padding: 10px;
        }

        .dashboard-section {
            background-color: #fdfdfd;
            padding: 15px;
            border: 1px solid #e9e9e9;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        .dashboard-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .dashboard-section h3 {
            color: #28a745;
            font-size: 1.3em;
            margin-bottom: 15px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 8px;
            text-align: center;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #e0e0e0;
            font-size: 0.95em;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item strong {
            color: #333;
        }
        .summary-item span.value {
            font-weight: 600;
            color: #007bff;
        }
        .summary-item span.green-value {
            color: #28a745;
        }
        .summary-item span.red-value {
            color: #dc3545;
        }

        .global-summary {
            text-align: center;
            font-size: 1.1em;
            font-weight: 600;
            padding: 10px;
            background-color: #e6f7ed;
            border: 1px solid #28a745;
            border-radius: 8px;
            margin-top: 15px;
            color: #28a745;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data-message {
            text-align: center;
            color: #777;
            padding: 20px;
            font-style: italic;
        }

        /* Media Queries for Responsiveness */
        @media (min-width: 768px) {
            h1 {
                font-size: 2.5em;
            }
            h2 {
                font-size: 1.8em;
            }
            .dashboard-sections-grid {
                display: grid;
                grid-template-columns: 1fr 1fr; /* Two columns on larger screens */
                gap: 20px;
            }
            button, input[type="submit"] {
                width: auto; /* Auto width for buttons on desktop */
                min-width: 180px;
            }
            .login-card {
                padding: 50px;
            }
        }

        /* Generic Alert Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            transform: translateY(0);
            animation: slideInFromTop 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center; /* Center content within modal */
        }

        @keyframes slideInFromTop {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h2 {
            color: #dc3545; /* Red for alerts */
            margin-bottom: 20px;
            border-bottom: none; /* No border for modal title */
            padding-bottom: 0;
            font-size: 1.5em;
        }

        .modal-content p {
            font-size: 1.1em;
            margin-bottom: 25px;
            line-height: 1.4;
        }

        .modal-content button {
            background-image: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            width: 150px; /* Specific width for modal buttons */
            margin: 0 auto; /* Center button */
        }
        .modal-content button:hover {
            background-image: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        }
        .modal-content .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            color: #888;
            cursor: pointer;
        }
        .modal-content .close:hover {
            color: #333;
        }

        /* Generic Confirm Modal Styles (added from previous version) */
        #generic_confirm_modal .modal-content {
            max-width: 450px;
            padding: 30px;
        }

        #generic_confirm_modal .modal-content button {
            width: 120px; /* Adjust button width */
            margin: 0 10px; /* Spacing between buttons */
            display: inline-block; /* Allow buttons to be side-by-side */
        }

        #generic_confirm_modal button[onclick*="genericConfirmProceed"] {
            background-image: linear-gradient(135deg, #28a745 0%, #218838 100%); /* Green for Proceed */
        }
        #generic_confirm_modal button[onclick*="genericConfirmProceed"]:hover {
            background-image: linear-gradient(135deg, #218838 0%, #1e7030 100%);
        }

        #generic_confirm_modal button[onclick*="genericConfirmCancel"] {
            background-image: linear-gradient(135deg, #dc3545 0%, #c82333 100%); /* Red for Cancel */
        }
        #generic_confirm_modal button[onclick*="genericConfirmCancel"]:hover {
            background-image: linear-gradient(135deg, #c82333 0%, #bb2d3b 100%);
        }

        #generic_confirm_modal .button-group {
            display: flex;
            justify-content: center;
            gap: 15px; /* Spacing between buttons */
            margin-top: 20px;
        }

        /* Admin Gear Icon */
        #admin_gear_icon {
            position: absolute; /* Changed to absolute for login card */
            top: 15px;
            left: 20px; /* Positioned on the left for login screen */
            font-size: 2em;
            color: #2e7d32;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: none; /* Hidden by default */
        }
        #admin_gear_icon:hover {
            transform: rotate(30deg);
        }

        /* User Management Modal Styles */
        #user_management_modal .user-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        #user_management_modal .user-item {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px dashed #ddd;
            margin-bottom: 5px;
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #user_management_modal .user-item:last-child {
            border-bottom: none;
        }
        #user_management_modal .user-info {
            flex-grow: 1;
            text-align: left;
            margin-right: 10px;
            margin-bottom: 5px; /* Space for wrapped elements */
        }
        #user_management_modal .user-info strong {
            display: block; /* Username on new line */
            color: #333;
            font-size: 1.1em;
            margin-bottom: 3px;
        }
        #user_management_modal .user-info span {
            display: block;
            font-size: 0.85em;
            color: #666;
        }
        #user_management_modal .user-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap; /* Allow buttons to wrap */
            justify-content: flex-end;
        }
        #user_management_modal .user-actions button {
            padding: 8px 12px;
            font-size: 0.85em;
            margin-top: 0; /* Override default button margin */
            width: auto; /* Shrink to content */
            box-shadow: none; /* Remove button shadow */
        }
        #user_management_modal .user-actions .kick-btn {
            background-image: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); /* Yellow */
            color: #333;
        }
        #user_management_modal .user-actions .kick-btn:hover {
            background-image: linear-gradient(135deg, #e0a800 0%, #c28800 100%);
        }
        #user_management_modal .user-actions .block-btn {
            background-image: linear-gradient(135deg, #dc3545 0%, #c82333 100%); /* Red */
        }
        #user_management_modal .user-actions .block-btn:hover {
            background-image: linear-gradient(135deg, #c82333 0%, #bb2d3b 100%);
        }
        #user_management_modal .user-actions .unblock-btn {
            background-image: linear-gradient(135deg, #28a745 0%, #218838 100%); /* Green */
        }
        #user_management_modal .user-actions .unblock-btn:hover {
            background-image: linear-gradient(135deg, #218838 0%, #1e7030 100%);
        }
        #user_management_modal .modal-error-message {
            color: #dc3545;
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* Styling for blocked user items */
        #user_management_modal .user-item.blocked {
            background-color: #fbe6e6; /* Light red background */
            border-color: #dc3545;
            opacity: 0.8;
        }

    </style>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="login-screen">
        <div class="login-card">
            <span id="admin_gear_icon" title="Gestión de Usuarios Activos" onclick="mostrarModal('user_management_modal')">&#9881;</span>
            <h1>Dashboard Transportadoras</h1>
            <p>Por favor, ingresa la contraseña para acceder.</p>
            <div class="form-field">
                <label for="password_input">Contraseña:</label>
                <input type="password" id="password_input" placeholder="Ingresa la contraseña" autocomplete="off">
            </div>
            <button onclick="checkPassword()">Acceder al Dashboard</button>
            <p id="login-error"></p>
            <p id="disclaimer-text">Al ingresar, acepta los términos de manera automática donde el sistema tendrá acceso a su IP, y demás, que podrán ser usados únicamente para fines legales en caso de violar las políticas de uso. No se accederá a la cámara o micrófono.</p>
        </div>
    </div>

    <div class="container" id="dashboard-content">
        <h1>Resumen de Despachos por Transportadora</h1>

        <div class="form-field">
            <label for="transportadora_select">Seleccionar Transportadora:</label>
            <select id="transportadora_select" onchange="handleTransportadoraChange()">
                <option value="">Cargando transportadoras...</option>
            </select>
        </div>

        <div class="loading-spinner" id="loading_spinner"></div>
        <div id="no_data_message" class="no-data-message" style="display:none;">
            <p>No hay datos disponibles para la transportadora seleccionada o con los filtros actuales.</p>
        </div>

        <div class="dashboard-sections-grid">
            <div class="dashboard-section">
                <h3>Pedidos Despachados</h3>
                <div id="despachos_despachados_asesor">
                    <p class="no-data-message">Seleccione una transportadora para ver el resumen de despachos.</p>
                </div>
            </div>

            <div class="dashboard-section">
                <h3>Pedidos Pendientes por Despachar</h3>
                <div id="pedidos_pendientes_global">
                    <p class="global-summary">Total Paquetes Pendientes: <span id="total_paquetes_pendientes" class="red-value">0</span></p>
                    <div id="pedidos_pendientes_asesor">
                        <p class="no-data-message">Seleccione una transportadora para ver los pedidos pendientes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Alert Modal -->
    <div id="generic_alert_modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('generic_alert_modal')">&times;</span>
            <h2 id="generic_alert_title">Alerta</h2>
            <p id="generic_alert_message"></p>
            <button type="button" onclick="cerrarModal('generic_alert_modal')">Aceptar</button>
        </div>
    </div>

    <!-- Generic Confirm Modal (from previous version, ensuring it's present) -->
    <div id="generic_confirm_modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="genericConfirmCancel()"></span>
            <h2 id="generic_confirm_title">Confirmar Acción</h2>
            <p id="generic_confirm_message"></p>
            <div class="button-group">
                <button type="button" onclick="genericConfirmProceed()">Sí</button>
                <button type="button" onclick="genericConfirmCancel()">No</button>
            </div>
        </div>
    </div>

    <!-- User Management Modal (NEW) -->
    <div id="user_management_modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('user_management_modal')">&times;</span>
            <h2>Gestión de Usuarios Activos</h2>
            <p id="user_management_error" class="modal-error-message"></p>
            <div class="user-list" id="active_users_list">
                <p>Cargando usuarios activos...</p>
            </div>
            <button type="button" onclick="cerrarModal('user_management_modal')">Cerrar</button>
        </div>
    </div>

    <script>
        const LOGIN_PASSWORD = "2025"; // Contraseña para acceder al dashboard
        const SESSION_DURATION_MS = 3 * 60 * 1000; // 3 minutos en milisegundos
        const LOCKOUT_DURATION_MS = 5 * 60 * 1000; // 5 minutos en milisegundos para bloqueo por cambio de transportadora
        const ACTIVE_SESSION_THRESHOLD_MS = 5 * 60 * 1000; // 5 minutos para considerar una sesión activa en la lista

        // Firebase Configuration (Same as generar_pedidos.html)
        const firebaseConfig = {
            apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
            authDomain: "lazapateria-c4157.firebaseapp.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.firebasestorage.app",
            measurementId: "G-HVG7615JEE"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const transportadorasCollection = db.collection('transportadoras');
        const registrosCollection = db.collection('registros');
        const globalSettingsRef = db.collection('settings').doc('global_block'); // To get block status and retard time
        const activeSessionsCollection = db.collection('active_sessions'); // NEW: For active user sessions

        let dashboardListenerUnsubscribe = null; // Listener for real-time updates on dashboard data
        let sessionCheckInterval = null; // Interval for session expiration and block check
        let activeUsersListenerUnsubscribe = null; // NEW: Listener for active users in admin modal

        // Global variables to store current block status from Firestore listener
        let isGlobalManualBlock = false;
        let isAutoBlockedPermanently = false;

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const dashboardContent = document.getElementById('dashboard-content');
        const passwordInput = document.getElementById('password_input');
        const loginError = document.getElementById('login-error');
        const transportadoraSelect = document.getElementById('transportadora_select');
        const despachosDespachadosAsesorDiv = document.getElementById('despachos_despachados_asesor');
        const totalPaquetesPendientesSpan = document.getElementById('total_paquetes_pendientes');
        const pedidosPendientesAsesorDiv = document.getElementById('pedidos_pendientes_asesor');
        const loadingSpinner = document.getElementById('loading_spinner');
        const noDataMessage = document.getElementById('no_data_message');
        const adminGearIcon = document.getElementById('admin_gear_icon'); // NEW
        const activeUsersListDiv = document.getElementById('active_users_list'); // NEW
        const userManagementErrorP = document.getElementById('user_management_error'); // NEW

        // --- Generic Alert Modal Functions ---
        function showAlert(message, title = "Alerta") {
            document.getElementById('generic_alert_title').textContent = title;
            document.getElementById('generic_alert_message').textContent = message;
            document.getElementById('generic_alert_modal').style.display = 'flex';
        }

        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
            if (id === 'user_management_modal' && activeUsersListenerUnsubscribe) {
                activeUsersListenerUnsubscribe(); // Detach listener when modal closes
                activeUsersListenerUnsubscribe = null;
                console.log("User management listener detached.");
            }
        }

        // --- Generic Confirm Modal Functions ---
        let confirmCallback = null;
        let cancelCallback = null;
        let originalTransportadoraSelection = ''; // To store the transportadora before a potential change

        function showConfirm(message, onConfirm, onCancel, title = "Confirmar Acción") {
            document.getElementById('generic_confirm_title').textContent = title;
            document.getElementById('generic_confirm_message').textContent = message;
            confirmCallback = onConfirm;
            cancelCallback = onCancel;
            document.getElementById('generic_confirm_modal').style.display = 'flex';
        }

        function genericConfirmProceed() {
            if (confirmCallback) {
                confirmCallback();
            }
            cerrarModal('generic_confirm_modal');
        }

        function genericConfirmCancel() {
            if (cancelCallback) {
                cancelCallback();
            }
            cerrarModal('generic_confirm_modal');
            // Revert the dropdown selection if the user cancels
            transportadoraSelect.value = originalTransportadoraSelection;
        }

        /**
         * Simula la obtención de una IP pública. En un entorno real, esto provendría de un servidor.
         */
        async function getSimulatedPublicIP() {
            try {
                // Using a public API to get client IP. This might be blocked by CORS or security policies
                // in some environments (e.g., iframes).
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log("Fetched IP:", data.ip);
                return data.ip;
            } catch (error) {
                console.warn("Error fetching IP from API, using placeholder:", error);
                // Fallback to a placeholder or a random string if API fails
                return '0.0.0.0 (Simulated)';
            }
        }

        /**
         * Logs the user out, clears session data, and shows the login screen.
         * Does NOT clear lockoutEndTime if active.
         * @param {string} message - Message to display on the login screen.
         */
        async function logoutUser(message) {
            console.log("Attempting to log out user...");
            const currentUserId = localStorage.getItem('user_id'); // Assuming user_id is stored during login

            if (currentUserId) {
                try {
                    // Delete the active session record from Firestore
                    const sessionRef = activeSessionsCollection.doc(currentUserId);
                    await sessionRef.delete();
                    console.log(`Active session for user ${currentUserId} removed from Firestore.`);
                } catch (error) {
                    console.error("Error removing active session from Firestore:", error);
                }
            }

            localStorage.removeItem('lastLoginTime'); // Clear session timestamp
            localStorage.removeItem('currentSelectedTransportadora'); // Clear the locked transportadora selection
            localStorage.removeItem('user_id'); // Clear the user_id upon logout
            localStorage.removeItem('datosUsuario'); // Clear user data

            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval); // Stop session check
                sessionCheckInterval = null;
            }
            if (dashboardListenerUnsubscribe) {
                dashboardListenerUnsubscribe(); // Detach dashboard data listener
                dashboardListenerUnsubscribe = null;
            }

            dashboardContent.style.display = 'none';
            loginScreen.style.display = 'flex';
            loginError.textContent = message;
            passwordInput.value = ''; // Clear password field
            console.log("User logged out:", message);
            // After logout, hide admin gear icon
            adminGearIcon.style.display = 'none';
        }

        /**
         * Checks the entered password and grants access to the dashboard if correct.
         * Also checks for global block status from Firestore and internal lockout.
         */
        async function checkPassword() {
            const dashboardLockoutEndTime = localStorage.getItem('dashboardLockoutEndTime');
            const currentTime = Date.now();

            if (dashboardLockoutEndTime && currentTime < parseInt(dashboardLockoutEndTime)) {
                // User is actively locked out, show generic message without time
                loginError.textContent = `Su acceso ha sido bloqueado debido a una violación de las políticas de uso. Por favor, contacte al administrador para revisar su situación.`;
                passwordInput.value = '';
                return; // Prevent login if actively locked out
            } else if (dashboardLockoutEndTime && currentTime >= parseInt(dashboardLockoutEndTime)) {
                // Lockout expired, clear it
                localStorage.removeItem('dashboardLockoutEndTime');
                console.log("Dashboard lockout expired and cleared.");
            }

            if (passwordInput.value === LOGIN_PASSWORD) {
                let currentIp = await getSimulatedPublicIP();
                let simulatedUserId = `user_${btoa(passwordInput.value).slice(0, 10)}`; // Simple ID based on password, for demo

                // For a real app, 'datosUsuario' would come from an authentication system (e.g., Firebase Auth)
                // For this example, if the password is "2025", we'll assume it's an "administrador".
                // Otherwise, it's an "operador".
                let userRole = 'operador';
                let userName = 'Operador';
                if (passwordInput.value === "2025") {
                    userRole = 'administrador';
                    userName = 'Administrador';
                }

                // Store simplified user data in localStorage for this demo
                const datosUsuario = {
                    usuario: simulatedUserId, // Use the simulated ID as 'usuario'
                    nombreCompleto: userName,
                    permisos: userRole
                };
                localStorage.setItem('datosUsuario', JSON.stringify(datosUsuario));
                localStorage.setItem('user_id', simulatedUserId); // Store user_id separately for easy access

                try {
                    // Check if user is blocked in active_sessions
                    const userSessionDoc = await activeSessionsCollection.doc(simulatedUserId).get();
                    if (userSessionDoc.exists && userSessionDoc.data().isBlocked) {
                        logoutUser('Su usuario ha sido bloqueado por un administrador. Contacte al soporte.');
                        return;
                    }

                    // Check global block status directly from Firestore
                    const doc = await globalSettingsRef.get();
                    if (doc.exists) {
                        const settings = doc.data();
                        isGlobalManualBlock = settings.isBlocked || false; // Manual global block
                        isAutoBlockedPermanently = settings.isAutoBlockedPermanently || false; // Auto block triggered

                        if (isGlobalManualBlock || isAutoBlockedPermanently) {
                            logoutUser('El sistema de pedidos está actualmente bloqueado y no se puede acceder al dashboard.');
                            return;
                        }
                    } else {
                        isGlobalManualBlock = false;
                        isAutoBlockedPermanently = false;
                    }

                    // If not blocked, create/update active session
                    await activeSessionsCollection.doc(simulatedUserId).set({
                        userId: simulatedUserId,
                        username: userName,
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp(), // Firestore timestamp
                        ipAddress: currentIp, // Store the IP
                        isBlocked: false // Ensure not blocked initially
                    }, { merge: true });

                    localStorage.setItem('lastLoginTime', currentTime); // Store login time
                    localStorage.setItem('currentSessionIP', currentIp); // Store the IP for session validation

                    loginScreen.style.display = 'none';
                    dashboardContent.style.display = 'block';

                    // Show/hide admin gear icon based on role
                    if (userRole === 'administrador') {
                        adminGearIcon.style.display = 'block';
                    } else {
                        adminGearIcon.style.display = 'none';
                    }

                    loadTransportadorasAndDashboard();

                    // Start periodic session and block status check
                    if (sessionCheckInterval) {
                        clearInterval(sessionCheckInterval);
                    }
                    sessionCheckInterval = setInterval(checkSessionAndBlockStatus, 10 * 1000); // Check every 10 seconds

                } catch (error) {
                    console.error("Error during login or session creation:", error);
                    logoutUser('Error al acceder. Inténtelo de nuevo.');
                    return;
                }
            } else {
                loginError.textContent = 'Contraseña incorrecta. Inténtalo de nuevo.';
                passwordInput.value = ''; // Clear password input
            }
        }

        /**
         * Checks for session expiration, current global block status, and IP/user blocking.
         * If session expired or system/user is blocked, logs out the user.
         */
        async function checkSessionAndBlockStatus() {
            const lastLoginTime = localStorage.getItem('lastLoginTime');
            const currentTime = Date.now();
            const dashboardLockoutEndTime = localStorage.getItem('dashboardLockoutEndTime');
            const currentUserId = localStorage.getItem('user_id');
            const currentSessionIP = localStorage.getItem('currentSessionIP');
            const userRole = JSON.parse(localStorage.getItem('datosUsuario'))?.permisos;


            // 1. Check for internal dashboard lockout first
            if (dashboardLockoutEndTime && currentTime < parseInt(dashboardLockoutEndTime)) {
                logoutUser(`Su acceso ha sido bloqueado debido a una violación de las políticas de uso. Por favor, contacte al administrador para revisar su situación.`);
                return;
            } else if (dashboardLockoutEndTime && currentTime >= parseInt(dashboardLockoutEndTime)) {
                localStorage.removeItem('dashboardLockoutEndTime');
                console.log("Dashboard lockout expired and cleared.");
            }

            // 2. Check session expiration
            if (!lastLoginTime || (currentTime - parseInt(lastLoginTime) > SESSION_DURATION_MS)) {
                logoutUser('Su sesión ha expirado. Por favor, ingrese la contraseña de nuevo.');
                return;
            }

            // If a user is logged in, continuously update their lastActivity and check their specific session status
            if (currentUserId) {
                try {
                    const sessionRef = activeSessionsCollection.doc(currentUserId);
                    const sessionDoc = await sessionRef.get();

                    if (!sessionDoc.exists) {
                        // If the session was deleted by an admin, log out
                        logoutUser('Su sesión ha sido terminada por un administrador.');
                        return;
                    }

                    const sessionData = sessionDoc.data();
                    const fetchedIp = await getSimulatedPublicIP(); // Get current IP for comparison

                    if (sessionData.isBlocked) {
                        // User specifically blocked by admin
                        logoutUser('Su usuario ha sido bloqueado por un administrador. Contacte al soporte.');
                        return;
                    }

                    // Check IP consistency - only if an IP was stored and if it's different
                    if (sessionData.ipAddress && fetchedIp !== '0.0.0.0 (Simulated)' && sessionData.ipAddress !== fetchedIp) {
                        logoutUser('Su sesión ha sido detectada desde una ubicación diferente. Por favor, ingrese de nuevo.');
                        return;
                    }

                    // Update lastActivity timestamp to keep session alive in Firestore
                    await sessionRef.update({
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                        ipAddress: fetchedIp // Update IP in case it changed slightly or for better tracking
                    });
                } catch (error) {
                    console.error("Error checking active session status:", error);
                    // In case of Firestore error, consider logging out for security
                    logoutUser('Error de verificación de sesión. Por favor, ingrese de nuevo.');
                    return;
                }
            }


            // 3. Check real-time global block status from main app (Firebase listener already updates globals)
            if (isGlobalManualBlock || isAutoBlockedPermanently) {
                logoutUser('El sistema de pedidos ha sido bloqueado. No se puede acceder al dashboard.');
                return;
            }

            // Show/hide admin gear icon based on role
            if (userRole === 'administrador') {
                adminGearIcon.style.display = 'block';
            } else {
                adminGearIcon.style.display = 'none';
            }
        }


        /**
         * Loads the list of transportadoras into the dropdown and then loads dashboard data.
         */
        async function loadTransportadorasAndDashboard() {
            transportadoraSelect.innerHTML = '<option value="">Cargando transportadoras...</option>';
            try {
                const snapshot = await transportadorasCollection.orderBy('name').get();
                transportadoraSelect.innerHTML = '<option value="">Seleccione una transportadora</option>';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = data.name;
                    option.textContent = data.name;
                    transportadoraSelect.appendChild(option);
                });

                // Set initial transportadora from localStorage if exists
                const storedTransportadora = localStorage.getItem('currentSelectedTransportadora');
                if (storedTransportadora && Array.from(transportadoraSelect.options).some(option => option.value === storedTransportadora)) {
                    transportadoraSelect.value = storedTransportadora;
                }
                // Store the current selection as the "original" to compare against
                originalTransportadoraSelection = transportadoraSelect.value;

                // Call loadDashboardDataInternal explicitly, not via onchange yet
                loadDashboardDataInternal(); 
            } catch (error) {
                console.error("Error cargando transportadoras:", error);
                transportadoraSelect.innerHTML = '<option value="">Error cargando transportadoras</option>';
                showNoDataMessage();
            }
        }

        /**
         * Handles the change event for the transportadora select dropdown.
         * Implements the warning and lockout logic.
         */
        function handleTransportadoraChange() {
            const newSelectedTransportadora = transportadoraSelect.value;
            const currentSelectedTransportadora = localStorage.getItem('currentSelectedTransportadora');
            const currentTime = Date.now();

            // Scenario 1: No transportadora was selected yet, and user selected one
            if (!currentSelectedTransportadora && newSelectedTransportadora) {
                localStorage.setItem('currentSelectedTransportadora', newSelectedTransportadora);
                originalTransportadoraSelection = newSelectedTransportadora; // Lock it in as the original
                loadDashboardDataInternal();
                return; // Exit after first valid selection
            }
            
            // Scenario 2: User is trying to deselect (go back to empty option) or switch after a selection was locked
            // This is the "violation" check.
            if (newSelectedTransportadora === '' && currentSelectedTransportadora !== '') {
                // User deselected after a transportadora was already locked
                showConfirm(
                    '¡Advertencia! Al seleccionar una transportadora, solo podrá ver los datos de esa transportadora durante su sesión activa. Intentar deseleccionar la transportadora es una violación de las políticas de uso de la aplicación y resultará en un bloqueo inmediato y el reporte al administrador. ¿Desea continuar con esta acción?',
                    () => { // User confirmed (Sí)
                        localStorage.setItem('dashboardLockoutEndTime', currentTime + LOCKOUT_DURATION_MS);
                        logoutUser('Su acceso ha sido bloqueado debido a una violación de las políticas de uso. Por favor, contacte al administrador para revisar su situación.');
                    },
                    () => { // User cancelled (No) - genericConfirmCancel already handles reverting dropdown
                        // No specific action needed here as genericConfirmCancel handles UI revert.
                    },
                    'Violación de Derechos'
                );
                return; // Exit after showing confirmation
            } else if (currentSelectedTransportadora && newSelectedTransportadora !== currentSelectedTransportadora) {
                 // User tried to switch to a different transportadora
                showConfirm(
                    '¡Advertencia! Al seleccionar una transportadora, solo podrá ver los datos de esa transportadora durante su sesión activa. Intentar cambiar a otra transportadora es una violación de las políticas de uso de la aplicación y resultará en un bloqueo inmediato y el reporte al administrador. ¿Desea continuar con esta acción?',
                    () => { // User confirmed (Sí)
                        localStorage.setItem('dashboardLockoutEndTime', currentTime + LOCKOUT_DURATION_MS);
                        logoutUser('Su acceso ha sido bloqueado debido a una violación de las políticas de uso. Por favor, contacte al administrador para revisar su situación.');
                    },
                    () => { // User cancelled (No) - genericConfirmCancel already handles reverting dropdown
                        // No specific action needed here as genericConfirmCancel handles UI revert.
                    },
                    'Violación de Derechos'
                );
                return; // Exit after showing confirmation
            }

            // Scenario 3: User re-selected the SAME transportadora (not a violation)
            if (newSelectedTransportadora === currentSelectedTransportadora) {
                loadDashboardDataInternal();
            }
            // If we reach here and no special action was taken (e.g. initial load or no change needed to current locked value)
            // loadDashboardDataInternal() will be called through the initial setup or re-selection.
        }


        /**
         * Internal function to load dashboard data without additional lockout checks,
         * called after transportadora selection is confirmed or on initial load.
         */
        async function loadDashboardDataInternal() {
            showLoadingSpinner();
            noDataMessage.style.display = 'none';

            if (dashboardListenerUnsubscribe) {
                dashboardListenerUnsubscribe(); // Detach previous listener
                console.log("Previous dashboard listener detached.");
            }

            const selectedTransportadora = transportadoraSelect.value;
            console.log("Selected Transportadora for data load:", selectedTransportadora);

            if (!selectedTransportadora) {
                despachosDespachadosAsesorDiv.innerHTML = '<p class="no-data-message">Seleccione una transportadora para ver el resumen de despachos.</p>';
                totalPaquetesPendientesSpan.textContent = '0';
                pedidosPendientesAsesorDiv.innerHTML = '<p class="no-data-message">Seleccione una transportadora para ver los pedidos pendientes.</p>';
                hideLoadingSpinner();
                return;
            }

            // Set up real-time listener for records filtered by selected transportadora
            dashboardListenerUnsubscribe = registrosCollection
                .where('transportadora', '==', selectedTransportadora)
                .onSnapshot(snapshot => {
                    console.log("Registros updated for selected transportadora:", selectedTransportadora);
                    processDashboardData(snapshot.docs);
                    hideLoadingSpinner();
                }, error => {
                    console.error("Error listening to dashboard data:", error);
                    despachosDespachadosAsesorDiv.innerHTML = '<p class="no-data-message">Error al cargar los datos.</p>';
                    totalPaquetesPendientesSpan.textContent = 'Error';
                    pedidosPendientesAsesorDiv.innerHTML = '<p class="no-data-message"></p>'; // Clear this on error
                    hideLoadingSpinner();
                });
        }

        /**
         * Processes the snapshot data to aggregate and display dashboard summaries.
         * @param {Array<firebase.firestore.DocumentSnapshot>} docs - Array of document snapshots.
         */
        function processDashboardData(docs) {
            let despachadosPorAsesor = {};
            let pendientesPorAsesor = {}; // New: for pending by asesor
            let totalPaquetesDespachados = 0; // New: total for dispatched
            let totalPaquetesPendientes = 0;
            const now = new Date();

            if (docs.length === 0) {
                showNoDataMessage();
                despachosDespachadosAsesorDiv.innerHTML = '<p class="no-data-message">No hay despachos para esta transportadora.</p>';
                totalPaquetesPendientesSpan.textContent = '0';
                pedidosPendientesAsesorDiv.innerHTML = '<p class="no-data-message">No hay pedidos pendientes para esta transportadora.</p>';
                return;
            }

            docs.forEach(doc => {
                const data = doc.data();
                const asesor = data.asesor || 'Desconocido';
                const numPares = parseInt(data.num_pares || 0);
                const despachado = data.despachado === true;
                const enviadoAEmpaque = data.enviadoAEmpaque === true;
                const fechaHoraCreacion = data.fecha_hora ? data.fecha_hora.toDate() : null;

                if (despachado) {
                    if (!despachadosPorAsesor[asesor]) {
                        despachadosPorAsesor[asesor] = { paquetes: 0 }; // Removed valor
                    }
                    despachadosPorAsesor[asesor].paquetes += numPares;
                    totalPaquetesDespachados += numPares; // Accumulate total dispatched
                } else {
                    // Check for "pending" status: NOT dispatched AND NOT sent to packing
                    const isPending = !despachado && !enviadoAEmpaque;
                    if (isPending) {
                        totalPaquetesPendientes += numPares;
                        if (!pendientesPorAsesor[asesor]) {
                            pendientesPorAsesor[asesor] = { paquetes: 0 };
                        }
                        pendientesPorAsesor[asesor].paquetes += numPares;
                    }
                }
            });

            renderDespachosDespachados(despachadosPorAsesor, totalPaquetesDespachados); // Pass total dispatched
            renderPedidosPendientes(pendientesPorAsesor); // New: call rendering for pending
            totalPaquetesPendientesSpan.textContent = totalPaquetesPendientes;

            // If there's data, hide the general no data message
            if (Object.keys(despachadosPorAsesor).length > 0 || totalPaquetesPendientes > 0) {
                noDataMessage.style.display = 'none';
            } else {
                showNoDataMessage();
            }
        }

        /**
         * Renders the "Pedidos Despachados" section.
         * @param {Object} data - Aggregated data of dispatched items by asesor.
         * @param {number} totalDispatchedPackages - Total dispatched packages for the selected transportadora.
         */
        function renderDespachosDespachados(data, totalDispatchedPackages) {
            let html = `<p class="global-summary">Total Paquetes Despachados: <span class="green-value">${totalDispatchedPackages}</span></p>`; // Add total dispatched
            const asesores = Object.keys(data).sort(); // Sort by asesor name

            if (asesores.length === 0 && totalDispatchedPackages === 0) {
                html += '<p class="no-data-message">No hay pedidos despachados para esta transportadora.</p>';
            } else {
                asesores.forEach(asesor => {
                    html += `
                        <div class="summary-item">
                            <span><strong>Asesor:</strong> ${asesor}</span>
                            <span>Paquetes: <span class="value green-value">${data[asesor].paquetes}</span></span>
                        </div>
                    `;
                });
            }
            despachosDespachadosAsesorDiv.innerHTML = html;
        }

        /**
         * Renders the "Pedidos Pendientes por Despachar" section by asesor.
         * @param {Object} data - Aggregated data of pending items by asesor.
         */
        function renderPedidosPendientes(data) {
            let html = '';
            const asesores = Object.keys(data).sort(); // Sort by asesor name

            if (asesores.length === 0) {
                html = '<p class="no-data-message">No hay pedidos pendientes para esta transportadora.</p>';
            } else {
                asesores.forEach(asesor => {
                    html += `
                        <div class="summary-item">
                            <span><strong>Asesor:</strong> ${asesor}</span>
                            <span>Paquetes: <span class="value red-value">${data[asesor].paquetes}</span></span>
                        </div>
                    `;
                });
            }
            pedidosPendientesAsesorDiv.innerHTML = html;
        }

        function showLoadingSpinner() {
            loadingSpinner.style.display = 'block';
            despachosDespachadosAsesorDiv.innerHTML = ''; // Clear content while loading
            totalPaquetesPendientesSpan.textContent = 'Cargando...';
            pedidosPendientesAsesorDiv.innerHTML = ''; // Clear content while loading
            noDataMessage.style.display = 'none';
        }

        function hideLoadingSpinner() {
            loadingSpinner.style.display = 'none';
        }

        function showNoDataMessage() {
            noDataMessage.style.display = 'block';
            despachosDespachadosAsesorDiv.innerHTML = '<p class="no-data-message">No hay datos disponibles para la transportadora seleccionada.</p>';
            pedidosPendientesAsesorDiv.innerHTML = ''; // Keep this empty or show pending-specific message
            totalPaquetesPendientesSpan.textContent = '0'; // Ensure total is 0
        }

        // --- User Management Functions (NEW) ---
        /**
         * Loads active users into the user management modal.
         */
        async function loadActiveUsers() {
            userManagementErrorP.textContent = ''; // Clear previous errors
            activeUsersListDiv.innerHTML = '<p>Cargando usuarios activos...</p>';

            if (activeUsersListenerUnsubscribe) {
                activeUsersListenerUnsubscribe(); // Detach previous listener if any
            }

            activeUsersListenerUnsubscribe = activeSessionsCollection
                .orderBy('lastActivity', 'desc')
                .onSnapshot(snapshot => {
                    activeUsersListDiv.innerHTML = ''; // Clear list
                    if (snapshot.empty) {
                        activeUsersListDiv.innerHTML = '<p>No hay usuarios activos en este momento.</p>';
                        return;
                    }

                    let html = '';
                    const now = Date.now();
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const userId = doc.id; // Document ID is the userId
                        const lastActivityDate = user.lastActivity ? user.lastActivity.toDate() : null;
                        const isRecent = lastActivityDate && (now - lastActivityDate.getTime() < ACTIVE_SESSION_THRESHOLD_MS);
                        const isBlocked = user.isBlocked || false;
                        const className = isBlocked ? 'user-item blocked' : 'user-item';

                        // Only show if recent activity or explicitly blocked
                        if (isRecent || isBlocked) {
                            html += `
                                <div class="${className}" data-user-id="${userId}">
                                    <div class="user-info">
                                        <strong>${user.username || userId}</strong>
                                        <span>ID: ${userId}</span>
                                        <span>IP: ${user.ipAddress || 'N/A'}</span>
                                        <span>Última actividad: ${lastActivityDate ? lastActivityDate.toLocaleString('es-CO') : 'N/A'}</span>
                                        ${isBlocked ? '<span>Estado: <strong style="color: red;">BLOQUEADO</strong></span>' : ''}
                                    </div>
                                    <div class="user-actions">
                                        <button class="kick-btn" onclick="kickUser('${userId}')">Sacar del Sistema</button>
                                        ${isBlocked ?
                                            `<button class="unblock-btn" onclick="toggleUserBlock('${userId}', false)">Desbloquear</button>` :
                                            `<button class="block-btn" onclick="toggleUserBlock('${userId}', true)">Bloquear</button>`
                                        }
                                    </div>
                                </div>
                            `;
                        }
                    });
                    activeUsersListDiv.innerHTML = html;
                    if (!html) {
                        activeUsersListDiv.innerHTML = '<p>No hay usuarios activos en este momento.</p>';
                    }
                }, error => {
                    console.error("Error fetching active users:", error);
                    userManagementErrorP.textContent = 'Error al cargar la lista de usuarios activos.';
                    activeUsersListDiv.innerHTML = '<p>Error al cargar usuarios.</p>';
                });
        }

        /**
         * Kicks a user out by deleting their active session.
         * @param {string} userId - The ID of the user to kick out.
         */
        function kickUser(userId) {
            showConfirm(`¿Está seguro de que desea sacar a ${userId} del sistema? Esto terminará su sesión.`, async () => {
                try {
                    await activeSessionsCollection.doc(userId).delete();
                    console.log(`User ${userId} kicked out.`);
                    userManagementErrorP.textContent = `Usuario ${userId} sacado del sistema.`;
                    setTimeout(() => userManagementErrorP.textContent = '', 3000);
                } catch (error) {
                    console.error("Error kicking user:", error);
                    userManagementErrorP.textContent = `Error al sacar a ${userId} del sistema.`;
                }
            });
        }

        /**
         * Blocks or unblocks a user.
         * @param {string} userId - The ID of the user to block/unblock.
         * @param {boolean} blockStatus - true to block, false to unblock.
         */
        function toggleUserBlock(userId, blockStatus) {
            const actionText = blockStatus ? 'bloquear' : 'desbloquear';
            showConfirm(`¿Está seguro de que desea ${actionText} a ${userId}?`, async () => {
                try {
                    await activeSessionsCollection.doc(userId).update({ isBlocked: blockStatus });
                    console.log(`User ${userId} block status set to ${blockStatus}.`);
                    userManagementErrorP.textContent = `Usuario ${userId} ${blockStatus ? 'bloqueado' : 'desbloqueado'} correctamente.`;
                    setTimeout(() => userManagementErrorP.textContent = '', 3000);
                } catch (error) {
                    console.error(`Error ${actionText} user:`, error);
                    userManagementErrorP.textContent = `Error al ${actionText} a ${userId}.`;
                }
            });
        }


        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // Make admin gear icon visible if user is admin (after initial check)
            const storedDatosUsuario = JSON.parse(localStorage.getItem('datosUsuario'));
            if (storedDatosUsuario && storedDatosUsuario.permisos && storedDatosUsuario.permisos.toLowerCase() === 'administrador') {
                adminGearIcon.style.display = 'block';
            } else {
                adminGearIcon.style.display = 'none';
            }
            
            // Listener for global settings immediately to catch block changes
            globalSettingsRef.onSnapshot(doc => {
                if (doc.exists) {
                    const settings = doc.data();
                    isGlobalManualBlock = settings.isBlocked || false;
                    isAutoBlockedPermanently = settings.isAutoBlockedPermanently || false;
                    console.log("Global block status updated:", isGlobalManualBlock, isAutoBlockedPermanently);
                    checkSessionAndBlockStatus(); // Check immediately if user should be logged out due to block
                } else {
                    isGlobalManualBlock = false;
                    isAutoBlockedPermanently = false;
                    checkSessionAndBlockStatus();
                }
            }, error => {
                console.error("Error al escuchar cambios en global_block:", error);
                isGlobalManualBlock = false;
                isAutoBlockedPermanently = false;
                checkSessionAndBlockStatus();
            });

            // On initial load, check if a session exists
            const lastLoginTime = localStorage.getItem('lastLoginTime');
            const dashboardLockoutEndTime = localStorage.getItem('dashboardLockoutEndTime');
            const currentTime = Date.now();

            if (dashboardLockoutEndTime && currentTime < parseInt(dashboardLockoutEndTime)) {
                logoutUser(`Su acceso ha sido bloqueado debido a una violación de las políticas de uso. Por favor, contacte al administrador para revisar su situación.`);
            } else if (lastLoginTime && (currentTime - parseInt(lastLoginTime)) < SESSION_DURATION_MS) {
                dashboardContent.style.display = 'block';
                loginScreen.style.display = 'none';
                loadTransportadorasAndDashboard();
                if (!sessionCheckInterval) {
                    sessionCheckInterval = setInterval(checkSessionAndBlockStatus, 10 * 1000);
                }
                // Show/hide admin gear icon on load based on already determined role from localStorage
                const userDatos = JSON.parse(localStorage.getItem('datosUsuario'));
                if (userDatos && userDatos.permisos && userDatos.permisos.toLowerCase() === 'administrador') {
                    adminGearIcon.style.display = 'block';
                } else {
                    adminGearIcon.style.display = 'none';
                }

            } else {
                logoutUser('Por favor, ingrese su contraseña.');
            }
        });

        // Event listener for opening the user management modal
        adminGearIcon.addEventListener('click', () => {
            mostrarModal('user_management_modal');
            loadActiveUsers(); // Load users when modal opens
        });
    </script>
</body>
</html>
