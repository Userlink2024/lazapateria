<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Transportadoras</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles - Modern, Clean, Mobile-First */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f2f5 0%, #e0e6ec 100%);
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top initially */
            min-height: 100vh;
            overflow-x: hidden;
            animation: fadeInBackground 1s ease-out;
        }

        @keyframes fadeInBackground {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .container {
            width: 95%; /* Wider for mobile, adjust as needed */
            max-width: 900px; /* Max width for desktop */
            margin: 20px auto; /* More vertical margin */
            padding: 20px; /* More padding */
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-sizing: border-box; /* Include padding in width/height */
        }

        /* Titles */
        h1, h2 {
            color: #2e7d32; /* Deep green */
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-size: 1.8em; /* Responsive font size */
        }
        h1 {
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        h2 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* Form Fields & Inputs */
        .form-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }
        input, select {
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background-color: #fcfcfc;
            width: 100%; /* Full width for inputs */
            box-sizing: border-box; /* Include padding in width */
        }
        input:focus, select:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
            outline: none;
            background-color: #fff;
        }

        /* Buttons */
        button, input[type="submit"] {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            color: white;
            background-image: linear-gradient(135deg, #28a745 0%, #218838 100%);
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
            letter-spacing: 0.5px;
            width: 100%; /* Full width for buttons */
            box-sizing: border-box;
        }

        button:hover, input[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
            background-image: linear-gradient(135deg, #218838 0%, #1e7030 100%);
        }

        button:active, input[type="submit"]:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(40, 167, 69, 0.2);
        }

        /* Login Screen Specifics */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh; /* Full height for login screen */
            position: fixed; /* Fixed to cover entire viewport */
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, #e0e6ec 0%, #f0f2f5 100%); /* Subtle gradient background */
            z-index: 2000; /* Ensure it's on top */
        }

        #login-screen .login-card {
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        #login-screen h1 {
            color: #28a745;
            margin-bottom: 25px;
        }

        #login-screen input[type="password"] {
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        #login-screen button {
            margin-top: 20px;
        }

        #login-error {
            color: #dc3545;
            margin-top: 15px;
            font-weight: 600;
        }

        /* Dashboard Content */
        #dashboard-content {
            display: none; /* Hidden by default until login */
            padding: 10px;
        }

        .dashboard-section {
            background-color: #fdfdfd;
            padding: 15px;
            border: 1px solid #e9e9e9;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        .dashboard-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .dashboard-section h3 {
            color: #28a745;
            font-size: 1.3em;
            margin-bottom: 15px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 8px;
            text-align: center;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #e0e0e0;
            font-size: 0.95em;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item strong {
            color: #333;
        }
        .summary-item span.value {
            font-weight: 600;
            color: #007bff;
        }
        .summary-item span.green-value {
            color: #28a745;
        }
        .summary-item span.red-value {
            color: #dc3545;
        }

        .global-summary {
            text-align: center;
            font-size: 1.1em;
            font-weight: 600;
            padding: 10px;
            background-color: #e6f7ed;
            border: 1px solid #28a745;
            border-radius: 8px;
            margin-top: 15px;
            color: #28a745;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data-message {
            text-align: center;
            color: #777;
            padding: 20px;
            font-style: italic;
        }

        /* Media Queries for Responsiveness */
        @media (min-width: 768px) {
            h1 {
                font-size: 2.5em;
            }
            h2 {
                font-size: 1.8em;
            }
            .dashboard-sections-grid {
                display: grid;
                grid-template-columns: 1fr 1fr; /* Two columns on larger screens */
                gap: 20px;
            }
            button, input[type="submit"] {
                width: auto; /* Auto width for buttons on desktop */
                min-width: 180px;
            }
            .login-card {
                padding: 50px;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="login-screen">
        <div class="login-card">
            <h1>Dashboard Transportadoras</h1>
            <p>Por favor, ingresa la contraseña para acceder.</p>
            <div class="form-field">
                <label for="password_input">Contraseña:</label>
                <input type="password" id="password_input" placeholder="Ingresa la contraseña" autocomplete="off">
            </div>
            <button onclick="checkPassword()">Acceder al Dashboard</button>
            <p id="login-error"></p>
        </div>
    </div>

    <div class="container" id="dashboard-content">
        <h1>Resumen de Despachos por Transportadora</h1>

        <div class="form-field">
            <label for="transportadora_select">Seleccionar Transportadora:</label>
            <select id="transportadora_select" onchange="loadDashboardData()">
                <option value="">Cargando transportadoras...</option>
            </select>
        </div>

        <div class="loading-spinner" id="loading_spinner"></div>
        <div id="no_data_message" class="no-data-message" style="display:none;">
            <p>No hay datos disponibles para la transportadora seleccionada o con los filtros actuales.</p>
        </div>

        <div class="dashboard-sections-grid">
            <div class="dashboard-section">
                <h3>Despachos Despachados por Asesor</h3>
                <div id="despachos_despachados_asesor">
                    <p class="no-data-message">Seleccione una transportadora para ver el resumen de despachos.</p>
                </div>
            </div>

            <div class="dashboard-section">
                <h3>Pedidos Pendientes por Despachar</h3>
                <div id="pedidos_pendientes_global">
                    <p class="global-summary">Total Paquetes Pendientes: <span id="total_paquetes_pendientes" class="red-value">0</span></p>
                    <div id="pedidos_pendientes_asesor">
                        <p class="no-data-message">Seleccione una transportadora para ver los pedidos pendientes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LOGIN_PASSWORD = "2025"; // Contraseña para acceder al dashboard
        const RETARD_MINUTES = 20; // Default retard time in minutes (same as generar_pedidos.html)

        // Firebase Configuration (Same as generar_pedidos.html)
        const firebaseConfig = {
            apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
            authDomain: "lazapateria-c4157.firebaseapp.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.firebasestorage.app",
            measurementId: "G-HVG7615JEE"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const transportadorasCollection = db.collection('transportadoras');
        const registrosCollection = db.collection('registros');
        const globalSettingsRef = db.collection('settings').doc('global_block'); // To get retard time

        let retardTimeMinutes = RETARD_MINUTES; // Local variable for retard time

        let dashboardListenerUnsubscribe = null; // Listener for real-time updates on dashboard data

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const dashboardContent = document.getElementById('dashboard-content');
        const passwordInput = document.getElementById('password_input');
        const loginError = document.getElementById('login-error');
        const transportadoraSelect = document.getElementById('transportadora_select');
        const despachosDespachadosAsesorDiv = document.getElementById('despachos_despachados_asesor');
        const totalPaquetesPendientesSpan = document.getElementById('total_paquetes_pendientes');
        const pedidosPendientesAsesorDiv = document.getElementById('pedidos_pendientes_asesor'); // New: for pending by asesor
        const loadingSpinner = document.getElementById('loading_spinner');
        const noDataMessage = document.getElementById('no_data_message');


        // --- Functions ---

        /**
         * Checks the entered password and grants access to the dashboard if correct.
         */
        function checkPassword() {
            if (passwordInput.value === LOGIN_PASSWORD) {
                loginScreen.style.display = 'none';
                dashboardContent.style.display = 'block';
                loadTransportadorasAndDashboard();
            } else {
                loginError.textContent = 'Contraseña incorrecta. Inténtalo de nuevo.';
                passwordInput.value = ''; // Clear password input
            }
        }

        /**
         * Loads the list of transportadoras into the dropdown and then loads dashboard data.
         */
        async function loadTransportadorasAndDashboard() {
            transportadoraSelect.innerHTML = '<option value="">Cargando transportadoras...</option>';
            try {
                const snapshot = await transportadorasCollection.orderBy('name').get();
                transportadoraSelect.innerHTML = '<option value="">Seleccione una transportadora</option>';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = data.name;
                    option.textContent = data.name;
                    transportadoraSelect.appendChild(option);
                });
                loadDashboardData(); // Load data after transportadoras are loaded
            } catch (error) {
                console.error("Error cargando transportadoras:", error);
                transportadoraSelect.innerHTML = '<option value="">Error cargando transportadoras</option>';
                showNoDataMessage();
            }
        }

        /**
         * Loads and displays dashboard data based on the selected transportadora.
         * Sets up a real-time listener for 'registros' collection.
         */
        async function loadDashboardData() {
            showLoadingSpinner();
            noDataMessage.style.display = 'none';

            if (dashboardListenerUnsubscribe) {
                dashboardListenerUnsubscribe(); // Detach previous listener
                console.log("Previous dashboard listener detached.");
            }

            const selectedTransportadora = transportadoraSelect.value;
            console.log("Selected Transportadora:", selectedTransportadora);

            if (!selectedTransportadora) {
                despachosDespachadosAsesorDiv.innerHTML = '<p class="no-data-message">Seleccione una transportadora para ver el resumen de despachos.</p>';
                totalPaquetesPendientesSpan.textContent = '0';
                pedidosPendientesAsesorDiv.innerHTML = '<p class="no-data-message">Seleccione una transportadora para ver los pedidos pendientes.</p>';
                hideLoadingSpinner();
                return;
            }

            // Fetch retard time from global settings
            try {
                const globalSettingsSnap = await globalSettingsRef.get();
                if (globalSettingsSnap.exists && globalSettingsSnap.data().retardTimeMinutes !== undefined) {
                    retardTimeMinutes = globalSettingsSnap.data().retardTimeMinutes;
                    console.log(`Retard time fetched from settings: ${retardTimeMinutes} minutes.`);
                } else {
                    retardTimeMinutes = RETARD_MINUTES; // Fallback to default
                    console.log(`Retard time not found in settings, using default: ${retardTimeMinutes} minutes.`);
                }
            } catch (error) {
                console.error("Error fetching global settings for retard time:", error);
                retardTimeMinutes = RETARD_MINUTES; // Fallback to default on error
            }

            // Set up real-time listener for records filtered by selected transportadora
            dashboardListenerUnsubscribe = registrosCollection
                .where('transportadora', '==', selectedTransportadora)
                .onSnapshot(snapshot => {
                    console.log("Registros updated for selected transportadora:", selectedTransportadora);
                    processDashboardData(snapshot.docs);
                    hideLoadingSpinner();
                }, error => {
                    console.error("Error listening to dashboard data:", error);
                    despachosDespachadosAsesorDiv.innerHTML = '<p class="no-data-message">Error al cargar los datos.</p>';
                    totalPaquetesPendientesSpan.textContent = 'Error';
                    pedidosPendientesAsesorDiv.innerHTML = '<p class="no-data-message"></p>'; // Clear this on error
                    hideLoadingSpinner();
                });
        }

        /**
         * Processes the snapshot data to aggregate and display dashboard summaries.
         * @param {Array<firebase.firestore.DocumentSnapshot>} docs - Array of document snapshots.
         */
        function processDashboardData(docs) {
            let despachadosPorAsesor = {};
            let pendientesPorAsesor = {}; // New: for pending by asesor
            let totalPaquetesDespachados = 0; // New: total for dispatched
            let totalPaquetesPendientes = 0;
            const now = new Date();

            if (docs.length === 0) {
                showNoDataMessage();
                despachosDespachadosAsesorDiv.innerHTML = '<p class="no-data-message">No hay despachos para esta transportadora.</p>';
                totalPaquetesPendientesSpan.textContent = '0';
                pedidosPendientesAsesorDiv.innerHTML = '<p class="no-data-message">No hay pedidos pendientes para esta transportadora.</p>';
                return;
            }

            docs.forEach(doc => {
                const data = doc.data();
                const asesor = data.asesor || 'Desconocido';
                const numPares = parseInt(data.num_pares || 0);
                const despachado = data.despachado === true;
                const enviadoAEmpaque = data.enviadoAEmpaque === true;
                const fechaHoraCreacion = data.fecha_hora ? data.fecha_hora.toDate() : null;

                if (despachado) {
                    if (!despachadosPorAsesor[asesor]) {
                        despachadosPorAsesor[asesor] = { paquetes: 0 }; // Removed valor
                    }
                    despachadosPorAsesor[asesor].paquetes += numPares;
                    totalPaquetesDespachados += numPares; // Accumulate total dispatched
                } else {
                    // Check for "pending" status: NOT dispatched AND NOT sent to packing
                    const isPending = !despachado && !enviadoAEmpaque;
                    if (isPending) {
                        totalPaquetesPendientes += numPares;
                        if (!pendientesPorAsesor[asesor]) {
                            pendientesPorAsesor[asesor] = { paquetes: 0 };
                        }
                        pendientesPorAsesor[asesor].paquetes += numPares;
                    }
                }
            });

            renderDespachosDespachados(despachadosPorAsesor, totalPaquetesDespachados); // Pass total dispatched
            renderPedidosPendientes(pendientesPorAsesor); // New: call rendering for pending
            totalPaquetesPendientesSpan.textContent = totalPaquetesPendientes;

            // If there's data, hide the general no data message
            if (Object.keys(despachadosPorAsesor).length > 0 || totalPaquetesPendientes > 0) {
                noDataMessage.style.display = 'none';
            } else {
                showNoDataMessage();
            }
        }

        /**
         * Renders the "Despachos Despachados por Asesor" section.
         * @param {Object} data - Aggregated data of dispatched items by asesor.
         * @param {number} totalDispatchedPackages - Total dispatched packages for the selected transportadora.
         */
        function renderDespachosDespachados(data, totalDispatchedPackages) {
            let html = `<p class="global-summary">Total Paquetes Despachados: <span class="green-value">${totalDispatchedPackages}</span></p>`; // Add total dispatched
            const asesores = Object.keys(data).sort(); // Sort by asesor name

            if (asesores.length === 0 && totalDispatchedPackages === 0) {
                html += '<p class="no-data-message">No hay despachos DESPACHADOS para esta transportadora.</p>';
            } else {
                asesores.forEach(asesor => {
                    html += `
                        <div class="summary-item">
                            <span><strong>Asesor:</strong> ${asesor}</span>
                            <span>Paquetes: <span class="value green-value">${data[asesor].paquetes}</span></span>
                        </div>
                    `;
                });
            }
            despachosDespachadosAsesorDiv.innerHTML = html;
        }

        /**
         * Renders the "Pedidos Pendientes por Despachar" section by asesor.
         * @param {Object} data - Aggregated data of pending items by asesor.
         */
        function renderPedidosPendientes(data) {
            let html = '';
            const asesores = Object.keys(data).sort(); // Sort by asesor name

            if (asesores.length === 0) {
                html = '<p class="no-data-message">No hay pedidos pendientes para esta transportadora.</p>';
            } else {
                asesores.forEach(asesor => {
                    html += `
                        <div class="summary-item">
                            <span><strong>Asesor:</strong> ${asesor}</span>
                            <span>Paquetes: <span class="value red-value">${data[asesor].paquetes}</span></span>
                        </div>
                    `;
                });
            }
            pedidosPendientesAsesorDiv.innerHTML = html;
        }

        function showLoadingSpinner() {
            loadingSpinner.style.display = 'block';
            despachosDespachadosAsesorDiv.innerHTML = ''; // Clear content while loading
            totalPaquetesPendientesSpan.textContent = 'Cargando...';
            pedidosPendientesAsesorDiv.innerHTML = ''; // Clear content while loading
            noDataMessage.style.display = 'none';
        }

        function hideLoadingSpinner() {
            loadingSpinner.style.display = 'none';
        }

        function showNoDataMessage() {
            noDataMessage.style.display = 'block';
            despachosDespachadosAsesorDiv.innerHTML = '<p class="no-data-message">No hay datos disponibles para la transportadora seleccionada.</p>';
            pedidosPendientesAsesorDiv.innerHTML = ''; // Keep this empty or show pending-specific message
            totalPaquetesPendientesSpan.textContent = '0'; // Ensure total is 0
        }

        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if already authenticated (e.g., from a previous session using local storage or similar)
            // For simplicity, this dashboard only uses the password for direct access, no session persistence.
            // If the user wants session persistence, a more robust authentication system is needed.
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // Initial load of transportadoras and dashboard data
            // This will be called only after successful login
        });

        // Optional: If you want to automatically check for password on load if saved in local storage (not recommended for simple password)
        // For this simple dashboard, we force password entry each time.
    </script>
</body>
</html>
