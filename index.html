<head>
    <!-- Firebase Configuration -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCwGpyvoUfbXE4rpPfLmHSdOK_VI4mT24M",
            authDomain: "lazapateria-ce24f.firebaseapp.com",
            projectId: "lazapateria-ce24f",
            storageBucket: "lazapateria-ce24f.firebasestorage.app",
            messagingSenderId: "642571845821",
            appId: "1:642571845821:web:45858a0abc0df728fd77d4",
            measurementId: "G-6JCF33H0K1"
        };
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>
</head>
        function guardarEnBaseDeDatos(datos) {
            const registrosRef = firebase.database().ref('registros');
            registrosRef.push(datos, function(error) {
                if (error) {
                    console.error('Error al guardar el registro:', error);
                } else {
                    console.log('Registro guardado exitosamente.');
                }
            });
        }
        function mostrarRegistros() {
            const registrosRef = firebase.database().ref('registros');
            registrosRef.on('value', function(snapshot) {
                let registrosHTML = '';
                snapshot.forEach(function(childSnapshot) {
                    let registro = childSnapshot.val();
                    registrosHTML += `<div class="record">
                        <p><strong>Registro</strong></p>
                        <p>Fecha y Hora: ${registro.fecha_hora}</p>
                        <p>Código Único: ${registro.codigo_unico}</p>
                        <p>Cliente: ${registro.cliente}</p>
                        <p>Referencia: ${registro.referencia.replace(/\n/g, '<br>')}</p>
                        <p>Asesor: ${registro.asesor}</p>
                        <p>Número de Pares: ${registro.num_pares}</p>
                        <p>Valor Total: ${registro.valor_total}</p>
                        <p>Observaciones: ${registro.observaciones}</p>
                        <p>Saldo a Favor: ${registro.saldo_a_favor}</p>
                        <p>Abonos: ${registro.abonos}</p>
                        <button onclick="modificarRegistro('${childSnapshot.key}')">Modificar</button>
                        <button onclick="eliminarRegistro('${childSnapshot.key}')">Eliminar</button>
                        <hr>
                    </div>`;
                });
                document.getElementById('registros').innerHTML = registrosHTML;

                // Mostrar el botón de exportar a Excel si el usuario es administrador
                if (rolActual === 'Administrador') {
                    document.getElementById('exportar').classList.remove('hidden');
                } else {
                    document.getElementById('exportar').classList.add('hidden');
                }
            });
        }
        function eliminarRegistro(key) {
            if (confirm('¿Estás seguro de que deseas eliminar este registro?')) {
                const registroRef = firebase.database().ref('registros/' + key);
                registroRef.remove()
                .then(function() {
                    alert('Registro eliminado con éxito.');
                })
                .catch(function(error) {
                    console.error('Error al eliminar el registro:', error);
                });
            }
        }
        function modificarRegistro(key) {
            const registroRef = firebase.database().ref('registros/' + key);
            registroRef.once('value', function(snapshot) {
                let registro = snapshot.val();
                let nuevoCliente = prompt('Modificar Nombre del Cliente:', registro.cliente);
                if (nuevoCliente !== null) registro.cliente = nuevoCliente;

                let nuevaReferencia = prompt('Modificar Referencia, Color, Talla, Precio:', registro.referencia);
                if (nuevaReferencia !== null) registro.referencia = nuevaReferencia;

                let nuevoNumPares = prompt('Modificar Número de Pares:', registro.num_pares);
                if (nuevoNumPares !== null) registro.num_pares = nuevoNumPares;

                let nuevoValorTotal = prompt('Modificar Valor Total del Pedido:', registro.valor_total);
                if (nuevoValorTotal !== null) registro.valor_total = nuevoValorTotal;

                let nuevasObservaciones = prompt('Modificar Observaciones:', registro.observaciones);
                if (nuevasObservaciones !== null) registro.observaciones = nuevasObservaciones;

                let nuevoSaldoAFavor = prompt('Modificar Saldo a Favor:', registro.saldo_a_favor);
                if (nuevoSaldoAFavor !== null) registro.saldo_a_favor = nuevoSaldoAFavor;

                let nuevosAbonos = prompt('Modificar Abonos:', registro.abonos);
                if (nuevosAbonos !== null) registro.abonos = nuevosAbonos;

                registroRef.update(registro, function(error) {
                    if (error) {
                        console.error('Error al modificar el registro:', error);
                    } else {
                        alert('Registro modificado con éxito.');
                    }
                });
            });
        }
        function iniciarSesion() {
            let usuariosRef = firebase.database().ref('usuarios');
            let usuario = document.getElementById('login_usuario').value;
            let contrasena = document.getElementById('login_contrasena').value;

            usuariosRef.orderByChild('usuario').equalTo(usuario).once('value', function(snapshot) {
                if (snapshot.exists()) {
                    snapshot.forEach(function(childSnapshot) {
                        let usuarioEncontrado = childSnapshot.val();
                        if (usuarioEncontrado.contrasena === contrasena) {
                            usuarioActual = usuario; // Guardar el usuario actual
                            rolActual = usuarioEncontrado.rol; // Guardar el rol del usuario actual
                            localStorage.setItem('usuarioActual', usuarioActual); // Guardar en localStorage
                            localStorage.setItem('rolActual', rolActual); // Guardar en localStorage
                            document.getElementById('login').classList.add('hidden');
                            document.getElementById('formulario').classList.remove('hidden');
                            document.querySelector('input[name="asesor"]').value = usuarioActual; // Asignar usuario como asesor
                            mostrarRegistros();
                        } else {
                            alert('Contraseña incorrecta.');
                        }
                    });
                } else {
                    alert('Usuario no encontrado.');
                }
            });
        }
        function registrarUsuario() {
            let usuariosRef = firebase.database().ref('usuarios');
            let usuario = document.getElementById('reg_usuario').value;
            let contrasena = document.getElementById('reg_contrasena').value;
            let rol = document.getElementById('reg_rol').value; // Capturar el rol del usuario

            usuariosRef.orderByChild('usuario').equalTo(usuario).once('value', function(snapshot) {
                if (snapshot.exists()) {
                    alert('El usuario ya existe.');
                } else {
                    let nuevoUsuarioRef = usuariosRef.push();
                    nuevoUsuarioRef.set({
                        usuario: usuario,
                        contrasena: contrasena,
                        rol: rol
                    }, function(error) {
                        if (error) {
                            console.error('Error al registrar el usuario:', error);
                        } else {
                            alert('Usuario registrado con éxito. Ahora puedes iniciar sesión.');
                            document.getElementById('registro-form').reset();
                            document.getElementById('registro').classList.add('hidden');
                            document.getElementById('login').classList.remove('hidden');
                        }
                    });
                }
            });
        }
        window.onload = function() {
            // Restaurar la sesión del usuario si existe
            usuarioActual = localStorage.getItem('usuarioActual') || '';
            rolActual = localStorage.getItem('rolActual') || '';

            if (usuarioActual && rolActual) {
                document.getElementById('login').classList.add('hidden');
                document.getElementById('formulario').classList.remove('hidden');
                document.querySelector('input[name="asesor"]').value = usuarioActual; // Asignar usuario como asesor
                mostrarRegistros();
            } else {
                document.getElementById('login').classList.remove('hidden');
            }
        }
        function enviarFormulario() {
            mostrarBarraCargando();

            let fechaHora = new Date().toLocaleString();
            let codigoUnico = 'COD-' + Math.random().toString(36).substr(2, 9).toUpperCase();

            let datos = {
                fecha_hora: fechaHora,
                codigo_unico: codigoUnico,
                cliente: document.querySelector('input[name="cliente"]').value,
                referencia: document.querySelector('textarea[name="referencia"]').value,
                asesor: usuarioActual, // Usar el usuario registrado como asesor
                num_pares: document.querySelector('input[name="num_pares"]').value,
                valor_total: document.querySelector('input[name="valor_total"]').value,
                observaciones: document.querySelector('textarea[name="observaciones"]').value,
                saldo_a_favor: document.querySelector('input[name="saldo_a_favor"]').value,
                abonos: document.querySelector('input[name="abonos"]').value
            };

            guardarEnBaseDeDatos(datos);
            mostrarRegistros();

            document.querySelector('form').reset(); // Limpiar el formulario
            return false; // Evitar recargar la página
        }
