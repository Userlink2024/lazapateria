<!DOCTYPE html>
<html>
<head>
    <title>Base de Datos con Autenticación</title>
    <style>
        /* Estilos CSS mantenidos */
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCwGpyvoUfbXE4rpPfLmHSdOK_VI4mT24M",
            authDomain: "lazapateria-ce24f.firebaseapp.com",
            projectId: "lazapateria-ce24f",
            storageBucket: "lazapateria-ce24f.firebasestorage.app",
            messagingSenderId: "642571845821",
            appId: "1:642571845821:web:45858a0abc0df728fd77d4",
            measurementId: "G-6JCF33H0K1"
        };
        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let usuarioActual = '';
        let rolActual = '';

        // Restaurar la sesión del usuario al cargar la página
        window.onload = function() {
            usuarioActual = localStorage.getItem('usuarioActual') || '';
            rolActual = localStorage.getItem('rolActual') || '';
            if (usuarioActual && rolActual) {
                document.getElementById('login').classList.add('hidden');
                document.getElementById('formulario').classList.remove('hidden');
                document.querySelector('input[name="asesor"]').value = usuarioActual;
                mostrarRegistros();
            } else {
                document.getElementById('login').classList.remove('hidden');
            }
        }
    </script>
</head>
function registrarUsuario() {
    let usuariosRef = firebase.database().ref('usuarios');
    let usuario = document.getElementById('reg_usuario').value;
    let contrasena = document.getElementById('reg_contrasena').value;
    let rol = document.getElementById('reg_rol').value;

    usuariosRef.orderByChild('usuario').equalTo(usuario).once('value', function(snapshot) {
        if (snapshot.exists()) {
            alert('El usuario ya existe.');
        } else {
            let nuevoUsuarioRef = usuariosRef.push();
            nuevoUsuarioRef.set({
                usuario: usuario,
                contrasena: contrasena,
                rol: rol
            }, function(error) {
                if (error) {
                    console.error('Error al registrar el usuario:', error);
                } else {
                    alert('Usuario registrado con éxito. Ahora puedes iniciar sesión.');
                    document.getElementById('registro-form').reset();
                    document.getElementById('registro').classList.add('hidden');
                    document.getElementById('login').classList.remove('hidden');
                }
            });
        }
    });
}
function guardarEnBaseDeDatos(datos) {
    const registrosRef = firebase.database().ref('registros');
    registrosRef.push(datos, function(error) {
        if (error) {
            console.error('Error al guardar el registro:', error);
        } else {
            console.log('Registro guardado exitosamente.');
        }
    });
}

function mostrarRegistros() {
    const registrosRef = firebase.database().ref('registros');
    registrosRef.on('value', function(snapshot) {
        let registrosHTML = '';
        snapshot.forEach(function(childSnapshot) {
            let registro = childSnapshot.val();
            let registroKey = childSnapshot.key;
            registrosHTML += `<div class="record">
                <p><strong>Registro</strong></p>
                <p>Fecha y Hora: ${registro.fecha_hora}</p>
                <p>Código Único: ${registro.codigo_unico}</p>
                <p>Cliente: ${registro.cliente}</p>
                <p>Referencia: ${registro.referencia.replace(/\n/g, '<br>')}</p>
                <p>Asesor: ${registro.asesor}</p>
                <p>Número de Pares: ${registro.num_pares}</p>
                <p>Valor Total: ${registro.valor_total}</p>
                <p>Observaciones: ${registro.observaciones}</p>
                <p>Saldo a Favor: ${registro.saldo_a_favor}</p>
                <p>Abonos: ${registro.abonos}</p>`;
            if (rolActual === 'Administrador') {
                registrosHTML += `
                <button onclick="modificarRegistro('${registroKey}')">Modificar</button>
                <button onclick="eliminarRegistro('${registroKey}')">Eliminar</button>`;
            }
            registrosHTML += `<hr>
            </div>`;
        });
        document.getElementById('registros').innerHTML = registrosHTML;

        // Mostrar el botón de exportar a Excel si el usuario es administrador
        if (rolActual === 'Administrador') {
            document.getElementById('exportar').classList.remove('hidden');
        } else {
            document.getElementById('exportar').classList.add('hidden');
        }
    });
}
function eliminarRegistro(key) {
    if (confirm('¿Estás seguro de que deseas eliminar este registro?')) {
        const registroRef = firebase.database().ref('registros/' + key);
        registroRef.remove()
        .then(function() {
            alert('Registro eliminado con éxito.');
        })
        .catch(function(error) {
            console.error('Error al eliminar el registro:', error);
        });
    }
}

function modificarRegistro(key) {
    const registroRef = firebase.database().ref('registros/' + key);
    registroRef.once('value', function(snapshot) {
        let registro = snapshot.val();
        let nuevoCliente = prompt('Modificar Nombre del Cliente:', registro.cliente);
        if (nuevoCliente !== null) registro.cliente = nuevoCliente;

        let nuevaReferencia = prompt('Modificar Referencia, Color, Talla, Precio:', registro.referencia);
        if (nuevaReferencia !== null) registro.referencia = nuevaReferencia;

        let nuevoNumPares = prompt('Modificar Número de Pares:', registro.num_pares);
        if (nuevoNumPares !== null) registro.num_pares = nuevoNumPares;

        let nuevoValorTotal = prompt('Modificar Valor Total del Pedido:', registro.valor_total);
        if (nuevoValorTotal !== null) registro.valor_total = nuevoValorTotal;

        let nuevasObservaciones = prompt('Modificar Observaciones:', registro.observaciones);
        if (nuevasObservaciones !== null) registro.observaciones = nuevasObservaciones;

        let nuevoSaldoAFavor = prompt('Modificar Saldo a Favor:', registro.saldo_a_favor);
        if (nuevoSaldoAFavor !== null) registro.saldo_a_favor = nuevoSaldoAFavor;

        let nuevosAbonos = prompt('Modificar Abonos:', registro.abonos);
        if (nuevosAbonos !== null) registro.abonos = nuevosAbonos;

        registroRef.update(registro, function(error) {
            if (error) {
                console.error('Error al modificar el registro:', error);
            } else {
                alert('Registro modificado con éxito.');
            }
        });
    });
}
