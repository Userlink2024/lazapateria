<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auditoría de Fondos - La Zapatería</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--text:#111827;--muted:#6b7280;--border:rgba(17,24,39,.10);--shadow:0 10px 25px rgba(0,0,0,.08);--primary:#2563eb;--primary2:#1d4ed8;--danger:#dc2626;--ok:#16a34a}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 600px at 15% 10%, rgba(37,99,235,.10), transparent 65%),radial-gradient(1000px 500px at 85% 15%, rgba(245,158,11,.10), transparent 60%),var(--bg);color:var(--text)}
    .app{max-width:1280px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 16px;box-shadow:var(--shadow);position:sticky;top:0;z-index:30}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary2));display:flex;align-items:center;justify-content:center;color:#fff;box-shadow:0 10px 20px rgba(37,99,235,.25)}
    h1{margin:0;font-size:16px}
    .sub{color:var(--muted);font-size:12px;font-weight:700;margin-top:2px}
    .actions{display:flex;gap:10px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(17,24,39,.04);border:1px solid var(--border);font-size:12px;font-weight:800;color:var(--muted)}
    .pill strong{color:var(--text)}
    .btn{border:none;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:800;font-size:13px;display:inline-flex;align-items:center;gap:8px}
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn.danger{background:rgba(220,38,38,.12);color:var(--danger);border:1px solid rgba(220,38,38,.25)}
    .layout{display:grid;grid-template-columns:380px 1fr;gap:16px;margin-top:16px}
    @media(max-width:1100px){.layout{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:14px}
    .card h2{margin:0 0 10px 0;font-size:14px;display:flex;align-items:center;gap:10px}
    label{font-size:12px;font-weight:900;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:#fff;outline:none;font-size:13px}
    textarea{min-height:84px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:520px){.grid{grid-template-columns:1fr}}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted);font-weight:700}
    .list{display:grid;gap:10px}
    .item{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff}
    .ref-suggest{position:relative}
    .ref-suggest-list{position:absolute;left:0;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 18px 40px rgba(0,0,0,.12);max-height:240px;overflow:auto;z-index:20;display:none}
    .ref-suggest-list.open{display:block}
    .ref-opt{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 10px;border-bottom:1px solid var(--border);cursor:pointer;font-weight:900;font-size:12px}
    .ref-opt:last-child{border-bottom:none}
    .ref-opt:hover{background:rgba(37,99,235,.06)}
    .ref-opt.disabled{cursor:not-allowed;opacity:.6}
    .ref-opt.disabled:hover{background:transparent}
    .ref-meta{display:flex;align-items:center;gap:8px;min-width:0}
    .ref-code{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ref-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;min-width:120px}
    .ref-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-weight:900;font-size:11px}
    .ref-badge.ok{background:rgba(22,163,74,.10);color:var(--ok);border-color:rgba(22,163,74,.20)}
    .ref-badge.bad{background:rgba(220,38,38,.10);color:var(--danger);border-color:rgba(220,38,38,.20)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(37,99,235,.06);font-size:12px;font-weight:900;color:var(--primary)}
    .chip.danger{background:rgba(220,38,38,.10);color:var(--danger);border-color:rgba(220,38,38,.20)}
    .chip.ok{background:rgba(22,163,74,.10);color:var(--ok);border-color:rgba(22,163,74,.20)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
    .modal.open{display:flex}
    .modal-card{width:min(560px,100%);background:var(--card);border-radius:16px;border:1px solid var(--border);box-shadow:0 30px 90px rgba(0,0,0,.35);overflow:hidden}
    .modal-head{padding:14px 16px;background:linear-gradient(135deg,rgba(37,99,235,.12),rgba(245,158,11,.08));display:flex;justify-content:space-between;align-items:center;gap:12px}
    .modal-head h3{margin:0;font-size:14px}
    .modal-body{padding:14px 16px}
    .modal-actions{padding:14px 16px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--border)}

    #cajaModal .modal-card.caja-modal-card{width:min(1120px,100%)}
    #cajaModal .modal-body{max-height:82vh;overflow:auto}
    #cajaModal .btn{padding:9px 11px;border-radius:12px}
    #cajaModal label{margin-bottom:4px}
    #cajaModal textarea{min-height:68px}

    #cajaModal .caja-top{justify-content:space-between;align-items:flex-end;gap:12px}
    #cajaModal .caja-tabs{gap:8px}
    #cajaModal .caja-filters{gap:8px;justify-content:flex-end}

    #cajaModal .caja-tab{margin-top:12px}
    #cajaModal .caja-section-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(max-width:980px){#cajaModal .caja-section-grid{grid-template-columns:1fr}}
    #cajaModal .caja-panel{border:1px solid var(--border);background:rgba(17,24,39,.02);border-radius:14px;padding:12px}
    #cajaModal .caja-panel > label{color:var(--text);font-weight:1000;margin-bottom:10px}

    #cajaListTiras,#cajaListLocal,#tirasPendientesList,#localFletesList{max-height:260px;overflow:auto;padding-right:4px}

    /* China Dashboard Styles */
    .china-dashboard{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
    @media(max-width:900px){.china-dashboard{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.china-dashboard{grid-template-columns:1fr}}
    .china-stat-card{display:flex;align-items:center;gap:14px;padding:16px;border-radius:16px;background:#fff;border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .china-stat-icon{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:20px}
    .china-stat-green .china-stat-icon{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
    .china-stat-orange .china-stat-icon{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
    .china-stat-blue .china-stat-icon{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff}
    .china-stat-purple .china-stat-icon{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff}
    .china-stat-content{display:flex;flex-direction:column;gap:2px}
    .china-stat-label{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
    .china-stat-value{font-size:18px;font-weight:900;color:var(--text)}

    .china-modules{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:16px}
    @media(max-width:800px){.china-modules{grid-template-columns:1fr}}
    .china-module{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .china-module-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:linear-gradient(135deg,rgba(37,99,235,.08),rgba(139,92,246,.05));border-bottom:1px solid var(--border)}
    .china-module-header h4{margin:0;font-size:14px;display:flex;align-items:center;gap:10px}
    .china-module-badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900}
    .china-module-badge.ok{background:rgba(22,163,74,.15);color:var(--ok)}
    .china-module-badge.danger{background:rgba(220,38,38,.15);color:var(--danger)}
    .china-module-body{padding:12px;max-height:320px;overflow:auto}
    .china-empty{text-align:center;padding:30px 16px;color:var(--muted);font-size:13px;display:flex;flex-direction:column;align-items:center;gap:8px}
    .china-empty i{font-size:28px;opacity:.5}

    .china-item{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px;background:rgba(249,250,251,1)}
    .china-item:last-child{margin-bottom:0}
    .china-item-info{flex:1;min-width:0}
    .china-item-title{font-weight:800;font-size:13px;color:var(--text);margin-bottom:4px}
    .china-item-meta{font-size:11px;color:var(--muted);line-height:1.5}
    .china-item-meta strong{color:var(--text)}
    .china-item-actions{display:flex;flex-direction:column;align-items:flex-end;gap:6px}

    .china-forms{display:flex;flex-direction:column;gap:10px}
    .china-form-section{border:1px solid var(--border);border-radius:14px;background:#fff;overflow:hidden}
    .china-form-section summary{padding:12px 16px;font-weight:800;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:10px;background:rgba(249,250,251,1);border-bottom:1px solid transparent}
    .china-form-section[open] summary{border-bottom-color:var(--border);background:linear-gradient(135deg,rgba(37,99,235,.06),rgba(139,92,246,.03))}
    .china-form-section summary:hover{background:rgba(37,99,235,.06)}
    .china-form-content{padding:14px 16px}
    .china-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:520px){.china-form-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><i class="fas fa-clipboard-check"></i></div>
        <div>
          <h1>Auditoría de Fondos</h1>
          <div class="sub">Vinculación de referencias + bloqueo + caja menor</div>
        </div>
      </div>
      <div class="actions">
        <div class="pill" id="userPill"><i class="fas fa-user"></i> <strong>...</strong></div>
        <button class="btn ghost" type="button" onclick="location.href='https://userlink2024.github.io/lazapateria/paneldecuentas.html'">
          <i class="fas fa-arrow-left"></i> Volver
        </button>
      </div>
    </div>

    <div class="layout">
      <div class="card" id="filtersCard">
        <h2><i class="fas fa-filter" style="color:var(--primary)"></i> Filtros</h2>
        <div class="grid">
          <div>
            <label for="fromDate">Desde</label>
            <input id="fromDate" type="date" />
          </div>
          <div>
            <label for="toDate">Hasta</label>
            <input id="toDate" type="date" />
          </div>
          <div>
            <label for="empaqueSelect">Enviado a empaque</label>
            <select id="empaqueSelect"><option value="all" selected>Todos</option><option value="no">No</option><option value="si">Sí</option></select>
          </div>
          <div>
            <label for="bodeguerosSelect">Tiene bodegueros</label>
            <select id="bodeguerosSelect"><option value="all" selected>Todos</option><option value="no">No</option><option value="si">Sí</option></select>
          </div>
          <div>
            <label for="asesorSelect">Asesor</label>
            <select id="asesorSelect"><option value="">Todos</option></select>
          </div>
          <div>
            <label for="bloqueadoSelect">Bloqueado</label>
            <select id="bloqueadoSelect"><option value="all" selected>Todos</option><option value="si">Sí</option><option value="no">No</option></select>
          </div>
        </div>
        <div style="margin-top:10px">
          <label for="searchInput">Búsqueda</label>
          <input id="searchInput" type="text" placeholder="Cliente, código único, observaciones, referencia..." />
        </div>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn primary" type="button" id="btnReload"><i class="fas fa-rotate"></i> Recargar</button>
          <button class="btn ghost" type="button" id="btnOpenHistory"><i class="fas fa-clock-rotate-left"></i> Historial por Referencia</button>
        </div>
        <div class="hint" style="margin-top:10px">Este módulo se conectará con consignaciones (cuentas) y ventas (registros).</div>
      </div>

      <div class="card" id="resultsCard">
        <h2><i class="fas fa-list" style="color:var(--primary)"></i> Pedidos</h2>
        <div id="errorBox" class="hint" style="display:none;color:var(--danger);font-weight:900"></div>
        <div id="loadingBox" class="hint" style="display:none">Cargando...</div>
        <div id="results" class="list"></div>
        <div class="toolbar" id="pager" style="margin-top:12px; justify-content:space-between; align-items:center; gap:10px; display:none">
          <button class="btn ghost" type="button" id="btnPrevPage"><i class="fas fa-chevron-left"></i> Anterior</button>
          <div class="hint" id="pageLabel" style="text-align:center; flex:1"></div>
          <button class="btn ghost" type="button" id="btnNextPage">Siguiente <i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal open" id="modeModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3><i class="fas fa-circle-question" style="color:var(--primary)"></i> Selecciona el módulo</h3>
        <span class="hint"><i class="fas fa-lock"></i></span>
      </div>
      <div class="modal-body">
        <div class="hint" style="margin-bottom:12px">¿Vas para caja menor o para auditar referencias bancarias?</div>
        <div class="grid">
          <button class="btn primary" type="button" id="btnGoAuditoria"><i class="fas fa-building-columns"></i> Auditoría Bancaria</button>
          <button class="btn" type="button" id="btnGoCaja" style="background:#dc2626;color:#fff;border:none"><i class="fas fa-cash-register"></i> Caja Menor</button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" type="button" onclick="location.href='https://userlink2024.github.io/lazapateria/paneldecuentas.html'">
          <i class="fas fa-arrow-left"></i> Volver
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="historyModal">
    <div class="modal-card" style="width:min(860px,100%)">
      <div class="modal-head">
        <h3><i class="fas fa-clock-rotate-left" style="color:var(--primary)"></i> Historial por Referencia</h3>
        <button class="btn ghost" type="button" onclick="closeHistory()"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="grid">
          <div>
            <label for="historyRef">Referencia</label>
            <input id="historyRef" type="text" placeholder="Ej: ABC123" />
          </div>
          <div style="display:flex;align-items:end">
            <button class="btn primary" type="button" id="btnSearchRef"><i class="fas fa-magnifying-glass"></i> Buscar</button>
          </div>
        </div>
        <div id="historyResults" class="list" style="margin-top:12px"></div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" type="button" onclick="closeHistory()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Movimiento -->
  <div class="modal" id="editMovModal" style="z-index:250">
    <div class="modal-card" style="max-width:400px">
      <div class="modal-head">
        <h3><i class="fas fa-edit" style="color:var(--primary)"></i> Editar Movimiento</h3>
        <button class="btn ghost" type="button" onclick="closeEditMovModal()"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="grid" style="gap:12px">
          <div>
            <label for="editMovValor">Valor</label>
            <input id="editMovValor" type="text" inputmode="numeric" placeholder="0" class="valor-moneda" />
          </div>
          <div>
            <label for="editMovObs">Observaciones</label>
            <textarea id="editMovObs" rows="3" placeholder="Observaciones..."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn primary" type="button" onclick="saveEditMov()"><i class="fas fa-save"></i> Guardar</button>
        <button class="btn ghost" type="button" onclick="closeEditMovModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Factura China -->
  <div class="modal" id="editFacModal" style="z-index:250">
    <div class="modal-card" style="max-width:400px">
      <div class="modal-head">
        <h3><i class="fas fa-edit" style="color:var(--primary)"></i> Editar Factura</h3>
        <button class="btn ghost" type="button" onclick="closeEditFacModal()"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="grid" style="gap:12px">
          <div>
            <label for="editFacValor">Valor Total</label>
            <input id="editFacValor" type="text" inputmode="numeric" placeholder="0" class="valor-moneda" />
          </div>
          <div>
            <label for="editFacCliente">Cliente</label>
            <input id="editFacCliente" type="text" placeholder="Nombre del cliente" />
          </div>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn primary" type="button" onclick="saveEditFac()"><i class="fas fa-save"></i> Guardar</button>
        <button class="btn ghost" type="button" onclick="closeEditFacModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Ver Abonos de Factura China -->
  <div class="modal" id="verAbonosModal" style="z-index:250">
    <div class="modal-card" style="max-width:500px">
      <div class="modal-head">
        <h3><i class="fas fa-list-check" style="color:#10b981"></i> Historial de Abonos</h3>
        <button class="btn ghost" type="button" onclick="closeVerAbonosModal()"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div id="verAbonosInfo" style="background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(37,99,235,.05));padding:12px;border-radius:10px;margin-bottom:16px;border:1px solid rgba(59,130,246,.2)">
          <div style="font-size:13px;color:#374151"><strong>Factura:</strong> <span id="verAbonosFacCodigo">-</span></div>
          <div style="font-size:13px;color:#374151"><strong>Cliente:</strong> <span id="verAbonosFacCliente">-</span></div>
          <div style="display:flex;gap:16px;margin-top:8px">
            <div style="font-size:13px"><strong>Total:</strong> <span id="verAbonosFacTotal">$0</span></div>
            <div style="font-size:13px;color:#10b981"><strong>Abonado:</strong> <span id="verAbonosFacAbonado">$0</span></div>
            <div style="font-size:13px;color:#ef4444"><strong>Saldo:</strong> <span id="verAbonosFacSaldo">$0</span></div>
          </div>
        </div>
        <div id="verAbonosList" style="max-height:300px;overflow-y:auto">
          <div class="china-empty"><i class="fas fa-inbox"></i> Sin abonos registrados</div>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn ghost" type="button" onclick="closeVerAbonosModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Ver Todos los Movimientos -->
  <div class="modal" id="localMovModal" style="z-index:200">
    <div class="modal-card" style="max-width:900px;width:100%">
      <div class="modal-head">
        <h3><i class="fas fa-list" style="color:var(--primary)"></i> Historial Completo - Local La Zapatería</h3>
        <button class="btn ghost" type="button" onclick="closeLocalMovModal()"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body" style="max-height:70vh;overflow:auto">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
          <div class="chips">
            <span class="chip ok" id="localMovModalIngresos">Ingresos: $0</span>
            <span class="chip danger" id="localMovModalEgresos">Egresos: $0</span>
            <span class="chip" id="localMovModalSaldo">Saldo: $0</span>
          </div>
          <div class="hint" id="localMovModalPaginacion">Página 1 de 1</div>
        </div>
        <div id="localMovModalList" class="list"></div>
        <div style="display:flex;justify-content:center;gap:12px;margin-top:16px" id="localMovModalPagBtns">
          <button class="btn ghost" type="button" id="localMovModalPrev"><i class="fas fa-chevron-left"></i> Anterior</button>
          <button class="btn ghost" type="button" id="localMovModalNext">Siguiente <i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" type="button" onclick="closeLocalMovModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="cajaModal">
    <div class="modal-card caja-modal-card">
      <div class="modal-head">
        <h3><i class="fas fa-cash-register" style="color:var(--primary)"></i> Caja Menor</h3>
        <button class="btn ghost" type="button" onclick="closeCaja()"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="toolbar caja-top">
          <div class="toolbar caja-tabs">
            <button class="btn primary" type="button" id="btnCajaTabTiras"><i class="fas fa-store"></i> China</button>
            <button class="btn ghost" type="button" id="btnCajaTabLocal"><i class="fas fa-shop"></i> Local La Zapatería</button>
          </div>
          <div class="toolbar caja-filters">
            <div>
              <label for="cajaFrom" style="margin-bottom:4px">Desde</label>
              <input id="cajaFrom" type="date" />
            </div>
            <div>
              <label for="cajaTo" style="margin-bottom:4px">Hasta</label>
              <input id="cajaTo" type="date" />
            </div>
            <button class="btn ghost" type="button" id="btnCajaRecargar"><i class="fas fa-rotate"></i> Recargar</button>
            <button class="btn ghost" type="button" onclick="window.open('historial_disponible.html','_blank')"><i class="fas fa-up-right-from-square"></i> Historial disponible</button>
          </div>
        </div>

        <div id="cajaTabTiras" class="caja-tab">
          <!-- Dashboard de Resumen -->
          <div class="china-dashboard">
            <div class="china-stat-card china-stat-green">
              <div class="china-stat-icon"><i class="fas fa-check-circle"></i></div>
              <div class="china-stat-content">
                <span class="china-stat-label">Dinero Recibido</span>
                <span class="china-stat-value" id="chinaStatCompras">$0</span>
              </div>
            </div>
            <div class="china-stat-card china-stat-orange">
              <div class="china-stat-icon"><i class="fas fa-clock"></i></div>
              <div class="china-stat-content">
                <span class="china-stat-label">Por Recibir / Créditos</span>
                <span class="china-stat-value" id="chinaStatPendientes">$0</span>
              </div>
            </div>
            <div class="china-stat-card china-stat-blue">
              <div class="china-stat-icon"><i class="fas fa-receipt"></i></div>
              <div class="china-stat-content">
                <span class="china-stat-label">Total Ventas Contado</span>
                <span class="china-stat-value" id="chinaStatIngresos">$0</span>
              </div>
            </div>
            <div class="china-stat-card china-stat-purple">
              <div class="china-stat-icon"><i class="fas fa-calculator"></i></div>
              <div class="china-stat-content">
                <span class="china-stat-label">Total Recibido</span>
                <span class="china-stat-value" id="chinaStatBalance">$0</span>
              </div>
            </div>
          </div>

          <!-- Módulos principales -->
          <div class="china-modules">
            <!-- Módulo: Ventas de Contado - Recibir dinero -->
            <div class="china-module">
              <div class="china-module-header">
                <h4><i class="fas fa-hand-holding-dollar"></i> Ventas Contado (Recibir dinero)</h4>
                <span class="china-module-badge ok" id="chinaComprasCount">0</span>
              </div>
              <div class="china-module-body" id="chinaComprasList">
                <div class="china-empty"><i class="fas fa-inbox"></i> Sin ventas de contado en el rango</div>
              </div>
            </div>

            <!-- Módulo: Ventas a Crédito -->
            <div class="china-module">
              <div class="china-module-header">
                <h4><i class="fas fa-credit-card"></i> Ventas a Crédito (Pendientes)</h4>
                <span class="china-module-badge danger" id="chinaPendientesCount">0</span>
              </div>
              <div class="china-module-body" id="chinaPendientesList">
                <div class="china-empty"><i class="fas fa-inbox"></i> Sin créditos pendientes en el rango</div>
              </div>
            </div>

            <!-- Módulo: Créditos Pagados -->
            <div class="china-module">
              <div class="china-module-header">
                <h4><i class="fas fa-check-double"></i> Créditos Pagados</h4>
                <span class="china-module-badge" style="background:linear-gradient(135deg,#10b981,#059669)" id="chinaPagadosCount">0</span>
              </div>
              <div class="china-module-body" id="chinaPagadosList">
                <div class="china-empty"><i class="fas fa-inbox"></i> Sin créditos pagados en el rango</div>
              </div>
            </div>
          </div>

          <!-- Formularios de operaciones manuales -->
          <div class="china-forms">
            <details class="china-form-section">
              <summary><i class="fas fa-plus-circle"></i> Registrar Ingreso Base</summary>
              <div class="china-form-content">
                <div class="china-form-grid">
                  <div>
                    <label for="tirasIngresoFecha">Fecha</label>
                    <input id="tirasIngresoFecha" type="date" />
                  </div>
                  <div>
                    <label for="tirasIngresoValor">Valor</label>
                    <input id="tirasIngresoValor" type="text" inputmode="numeric" placeholder="0" class="valor-moneda" />
                  </div>
                </div>
                <div style="margin-top:10px">
                  <label for="tirasIngresoObs">Observación</label>
                  <textarea id="tirasIngresoObs" placeholder="Notas..."></textarea>
                </div>
                <div class="toolbar" style="margin-top:10px; justify-content:flex-end">
                  <button class="btn primary" type="button" id="btnTirasIngresoGuardar"><i class="fas fa-floppy-disk"></i> Guardar</button>
                </div>
              </div>
            </details>

            <details class="china-form-section">
              <summary><i class="fas fa-arrow-right-from-bracket"></i> Registrar Salida de Dinero</summary>
              <div class="china-form-content">
                <div class="china-form-grid">
                  <div>
                    <label for="tirasSalidaFecha">Fecha</label>
                    <input id="tirasSalidaFecha" type="date" />
                  </div>
                  <div>
                    <label for="tirasSalidaValor">Valor</label>
                    <input id="tirasSalidaValor" type="text" inputmode="numeric" placeholder="0" class="valor-moneda" />
                  </div>
                </div>
                <div style="margin-top:10px">
                  <label for="tirasSalidaObs">Observación</label>
                  <textarea id="tirasSalidaObs" placeholder="Motivo..."></textarea>
                </div>
                <div class="toolbar" style="margin-top:10px; justify-content:flex-end">
                  <button class="btn primary" type="button" id="btnTirasSalidaGuardar"><i class="fas fa-floppy-disk"></i> Guardar</button>
                </div>
              </div>
            </details>

            <details class="china-form-section">
              <summary><i class="fas fa-calendar-week"></i> Cuadre Semanal (Gerente)</summary>
              <div class="china-form-content">
                <div style="background:linear-gradient(135deg,rgba(139,92,246,.1),rgba(37,99,235,.05));padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(139,92,246,.2)">
                  <div style="font-weight:800;font-size:13px;color:#7c3aed;margin-bottom:6px"><i class="fas fa-info-circle"></i> Cuadre Semanal</div>
                  <div style="font-size:12px;color:#6b7280">El gerente realiza el cuadre cada semana (viernes o sábado). Ingresa el valor total entregado y confirma el cierre.</div>
                </div>
                <div class="china-form-grid">
                  <div>
                    <label for="tirasCierreFecha">Fecha del cuadre</label>
                    <input id="tirasCierreFecha" type="date" />
                  </div>
                  <div>
                    <label for="tirasCierreValor">Total entregado al gerente</label>
                    <input id="tirasCierreValor" type="text" inputmode="numeric" placeholder="0" class="valor-moneda" />
                  </div>
                </div>
                <div style="margin-top:10px">
                  <label for="tirasCierreObs">Observaciones del cuadre</label>
                  <textarea id="tirasCierreObs" placeholder="Ej: Cuadre semana 1-7 Febrero, entregado sin novedades..."></textarea>
                </div>
                <div class="toolbar" style="margin-top:10px; justify-content:flex-end">
                  <button class="btn primary" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)" type="button" id="btnTirasCierreGuardar"><i class="fas fa-check-double"></i> Confirmar Cuadre Semanal</button>
                </div>
              </div>
            </details>
          </div>

          <!-- Resumen de movimientos -->
          <div class="china-dashboard" style="grid-template-columns:repeat(3,1fr);margin-top:16px">
            <div class="china-stat-card china-stat-green">
              <div class="china-stat-icon"><i class="fas fa-arrow-down"></i></div>
              <div class="china-stat-content">
                <span class="china-stat-label">Ingresos Base</span>
                <span class="china-stat-value" id="tirasResumenIngresos">$0</span>
              </div>
            </div>
            <div class="china-stat-card china-stat-orange">
              <div class="china-stat-icon"><i class="fas fa-arrow-up"></i></div>
              <div class="china-stat-content">
                <span class="china-stat-label">Salidas / Egresos</span>
                <span class="china-stat-value" id="tirasResumenEgresos">$0</span>
              </div>
            </div>
            <div class="china-stat-card china-stat-purple">
              <div class="china-stat-icon"><i class="fas fa-wallet"></i></div>
              <div class="china-stat-content">
                <span class="china-stat-label">Saldo en Caja</span>
                <span class="china-stat-value" id="tirasResumenSaldo">$0</span>
              </div>
            </div>
          </div>

          <!-- Historial de movimientos (abierto por defecto) -->
          <details class="china-form-section" style="margin-top:16px" open>
            <summary><i class="fas fa-list"></i> Historial de Movimientos Manuales (<span id="tirasMovCount">0</span>)</summary>
            <div class="china-form-content">
              <div id="cajaListTiras" class="list"></div>
            </div>
          </details>
        </div>

        <div id="cajaTabLocal" class="caja-tab" style="display:none">
          <!-- Dashboard de Resumen Local -->
          <div class="china-dashboard" style="grid-template-columns:repeat(3,1fr)">
            <div class="china-stat-card china-stat-green">
              <div class="china-stat-icon"><i class="fas fa-arrow-down"></i></div>
              <div class="china-stat-content">
                <span class="china-stat-label">Ingresos</span>
                <span class="china-stat-value" id="localResumenIngresos">$0</span>
              </div>
            </div>
            <div class="china-stat-card china-stat-orange">
              <div class="china-stat-icon"><i class="fas fa-arrow-up"></i></div>
              <div class="china-stat-content">
                <span class="china-stat-label">Egresos</span>
                <span class="china-stat-value" id="localResumenEgresos">$0</span>
              </div>
            </div>
            <div class="china-stat-card china-stat-blue">
              <div class="china-stat-icon"><i class="fas fa-wallet"></i></div>
              <div class="china-stat-content">
                <span class="china-stat-label">Saldo en Caja</span>
                <span class="china-stat-value" id="localResumenSaldo">$0</span>
              </div>
            </div>
          </div>

          <!-- Formularios colapsables -->
          <div class="china-forms">
            <details class="china-form-section">
              <summary><i class="fas fa-cash-register"></i> Registrar Ingreso (Venta)</summary>
              <div class="china-form-content">
                <div class="china-form-grid">
                  <div>
                    <label for="localVentaFecha">Fecha</label>
                    <input id="localVentaFecha" type="date" />
                  </div>
                  <div>
                    <label for="localVentaValor">Valor</label>
                    <input id="localVentaValor" type="text" inputmode="numeric" placeholder="0" class="valor-moneda" />
                  </div>
                  <div>
                    <label for="localVentaCliente">Cliente</label>
                    <input id="localVentaCliente" type="text" placeholder="Nombre del cliente" />
                  </div>
                  <div>
                    <label for="localVentaAsesor">Asesor</label>
                    <select id="localVentaAsesor"><option value="">—</option></select>
                  </div>
                </div>
                <div class="toolbar" style="margin-top:12px; justify-content:flex-end">
                  <button class="btn primary" type="button" id="btnLocalVentaGuardar"><i class="fas fa-floppy-disk"></i> Guardar Venta</button>
                </div>
              </div>
            </details>

            <details class="china-form-section">
              <summary><i class="fas fa-money-bill-transfer"></i> Registrar Egreso</summary>
              <div class="china-form-content">
                <div class="china-form-grid">
                  <div>
                    <label for="localEgresoFecha">Fecha</label>
                    <input id="localEgresoFecha" type="date" />
                  </div>
                  <div>
                    <label for="localEgresoValor">Valor</label>
                    <input id="localEgresoValor" type="text" inputmode="numeric" placeholder="0" class="valor-moneda" />
                  </div>
                </div>
                <div style="margin-top:10px">
                  <label for="localEgresoObs">Observación / Motivo</label>
                  <textarea id="localEgresoObs" placeholder="Describe el motivo del egreso..."></textarea>
                </div>
                <div class="toolbar" style="margin-top:12px; justify-content:flex-end">
                  <button class="btn primary" style="background:linear-gradient(135deg,#f59e0b,#d97706)" type="button" id="btnLocalEgresoGuardar"><i class="fas fa-floppy-disk"></i> Guardar Egreso</button>
                </div>
              </div>
            </details>

            <details class="china-form-section">
              <summary><i class="fas fa-plus-circle"></i> Registrar Ingreso de Dinero (Base)</summary>
              <div class="china-form-content">
                <div style="background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(5,150,105,.05));padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(16,185,129,.2)">
                  <div style="font-weight:800;font-size:13px;color:#059669;margin-bottom:6px"><i class="fas fa-info-circle"></i> Ingreso Base</div>
                  <div style="font-size:12px;color:#6b7280">Usa este formulario para registrar dinero que entra a caja (ej: base inicial, reposición, etc.)</div>
                </div>
                <div class="china-form-grid">
                  <div>
                    <label for="localIngresoFecha">Fecha</label>
                    <input id="localIngresoFecha" type="date" />
                  </div>
                  <div>
                    <label for="localIngresoValor">Valor</label>
                    <input id="localIngresoValor" type="text" inputmode="numeric" placeholder="0" class="valor-moneda" />
                  </div>
                </div>
                <div style="margin-top:10px">
                  <label for="localIngresoObs">Observación</label>
                  <textarea id="localIngresoObs" placeholder="Notas adicionales..."></textarea>
                </div>
                <div class="toolbar" style="margin-top:12px; justify-content:flex-end">
                  <button class="btn primary" style="background:linear-gradient(135deg,#10b981,#059669)" type="button" id="btnLocalIngresoGuardar"><i class="fas fa-floppy-disk"></i> Guardar Ingreso</button>
                </div>
              </div>
            </details>
          </div>

          <!-- Módulos: Fletes pendientes (colapsable) -->
          <details class="china-form-section" style="margin-top:16px">
            <summary style="cursor:pointer">
              <i class="fas fa-truck"></i> Fletes (Novedades Resueltas)
              <span class="china-module-badge ok" id="localFletesCount" style="margin-left:8px">0 fletes</span>
              <span class="china-module-badge" style="background:rgba(37,99,235,.15);color:#2563eb;margin-left:4px" id="localFletesSum">$0</span>
            </summary>
            <div class="china-form-content" id="localFletesList">
              <div class="china-empty"><i class="fas fa-inbox"></i> Sin fletes pendientes de agregar</div>
            </div>
          </details>

          <!-- Historial de movimientos -->
          <details class="china-form-section" style="margin-top:16px" open>
            <summary><i class="fas fa-list"></i> Historial de Movimientos (<span id="localMovCount">0</span>)</summary>
            <div class="china-form-content">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
                <div class="chips">
                  <span class="chip ok" id="localTotalIngresos">Ingresos: $0</span>
                  <span class="chip danger" id="localTotalEgresos">Egresos: $0</span>
                  <span class="chip" id="localSaldo">Saldo: $0</span>
                </div>
                <button class="btn ghost" type="button" id="btnLocalVerTodos"><i class="fas fa-expand"></i> Ver todos</button>
              </div>
              <div id="cajaListLocal" class="list"></div>
            </div>
          </details>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" type="button" onclick="closeCaja()">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
      authDomain: "lazapateria-c4157.firebaseapp.com",
      projectId: "lazapateria-c4157",
      storageBucket: "lazapateria-c4157.firebasestorage.app",
      messagingSenderId: "300241769138",
      appId: "1:300241769138:web:8ca1847de3c4fb5042afab",
      measurementId: "G-HVG7615JEE"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const $ = (id) => document.getElementById(id);

    const COL_REGISTROS = db.collection('registros');
    const COL_USUARIOS = db.collection('usuarios');
    const COL_REF_LINKS = db.collection('auditoria_fondos_refs');
    const COL_CAJA = db.collection('caja_menor');

    // Conexión a la segunda base de datos (chinainventario - lazapateria-ce24f)
    const chinaFirebaseConfig = {
      apiKey: "AIzaSyCwGpyvoUfbXE4rpPfLmHSdOK_VI4mT24M",
      authDomain: "lazapateria-ce24f.firebaseapp.com",
      projectId: "lazapateria-ce24f",
      storageBucket: "lazapateria-ce24f.firebaseapp.com",
      messagingSenderId: "642571845821",
      appId: "1:642571845821:web:45858a0abc0df728fd77d4"
    };
    const chinaApp = firebase.initializeApp(chinaFirebaseConfig, 'chinaApp');
    const dbChina = chinaApp.firestore();
    const COL_FACTURAS_CHINA = dbChina.collection('facturas');

    let facturasChina = [];
    let facturasLoaded = false;

    let currentUser = null;
    let cachedOperadores = [];
    let cachedBodegueros = [];
    let allRegistros = [];
    let consignacionesIndex = [];

    const PAGE_SIZE = 5;
    let currentPage = 1;

    let usedRefsSet = new Set();

    let consignacionesLoaded = false;
    let consignacionesLoadPromise = null;

    function showError(msg){ const el = $('errorBox'); if (!el) return; el.style.display='block'; el.textContent=msg; }
    function clearError(){ const el = $('errorBox'); if (!el) return; el.style.display='none'; el.textContent=''; }
    function setLoading(v){ const el = $('loadingBox'); if (!el) return; el.style.display = v ? 'block' : 'none'; }
    function showSuccessMessage(msg){
      // Crear notificación temporal de éxito
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:14px 20px;border-radius:12px;font-weight:700;font-size:14px;box-shadow:0 10px 30px rgba(16,185,129,.4);z-index:9999;animation:slideIn .3s ease';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity .3s'; }, 2500);
      setTimeout(() => toast.remove(), 3000);
    }

    function safeStr(v){ return String(v || '').trim(); }
    function normalizeRef(v){ return safeStr(v).toUpperCase(); }
    function fmtCOP(n){ return '$' + new Intl.NumberFormat('es-CO').format(Number(n || 0)); }
    function tsToDate(ts){ try { return ts && ts.toDate ? ts.toDate() : null; } catch { return null; } }
    function formatDateTime(ts){ const d = tsToDate(ts); return d ? d.toLocaleString('es-CO') : ''; }
    function sumAbonos(abonos){ return (Array.isArray(abonos) ? abonos : []).reduce((acc,a)=> acc + Number((a && a.monto) || 0), 0); }

    // Formateo de moneda colombiana para campos de valor
    function formatMonedaCO(valor){
      // Eliminar todo excepto dígitos
      const soloNumeros = String(valor).replace(/\D/g, '');
      if (!soloNumeros) return '';
      // Formatear con puntos como separador de miles
      return new Intl.NumberFormat('es-CO').format(Number(soloNumeros));
    }

    function parseMonedaCO(valorFormateado){
      // Extraer solo dígitos y convertir a número
      const soloNumeros = String(valorFormateado).replace(/\D/g, '');
      return Number(soloNumeros) || 0;
    }

    function initCamposMoneda(){
      document.querySelectorAll('.valor-moneda').forEach(input => {
        input.addEventListener('input', (e) => {
          const cursorPos = e.target.selectionStart;
          const valorAnterior = e.target.value;
          const valorFormateado = formatMonedaCO(e.target.value);
          e.target.value = valorFormateado;
          // Ajustar posición del cursor
          const diff = valorFormateado.length - valorAnterior.length;
          const newPos = Math.max(0, cursorPos + diff);
          e.target.setSelectionRange(newPos, newPos);
        });
        input.addEventListener('blur', (e) => {
          if (e.target.value) {
            e.target.value = formatMonedaCO(e.target.value);
          }
        });
      });
    }

    function buildRegistroRefsFlat(r){
      if (Array.isArray(r.referencias_bancarias_refs)) return r.referencias_bancarias_refs.map(normalizeRef).filter(Boolean);
      if (Array.isArray(r.referencias_bancarias)) return r.referencias_bancarias.map(x => normalizeRef(x && x.referencia)).filter(Boolean);
      return [];
    }

    function openHistory(){ $('historyModal').classList.add('open'); }
    function closeHistory(){ $('historyModal').classList.remove('open'); }
    function openCaja(){ 
      $('cajaModal').classList.add('open'); 
      // Cargar facturas de China al abrir
      if (cajaActiveTab === 'tiras') loadFacturasChina();
    }
    function closeCaja(){ 
      $('cajaModal').classList.remove('open');
      // Cancelar listeners en tiempo real al cerrar
      if (unsubscribeFacturasChina) {
        unsubscribeFacturasChina();
        unsubscribeFacturasChina = null;
      }
      if (unsubscribeCajaMovimientos) {
        unsubscribeCajaMovimientos();
        unsubscribeCajaMovimientos = null;
      }
      console.log('[RT] Listeners cancelados al cerrar modal');
    }

    function setModeAuditoria(){
      $('modeModal').classList.remove('open');
      $('filtersCard').style.display='';
      $('resultsCard').style.display='';
    }
    function setModeCaja(){
      $('modeModal').classList.remove('open');
      $('filtersCard').style.display='none';
      $('resultsCard').style.display='none';
      openCaja();
    }

    let cajaActiveTab = 'tiras';

    function todayISO(){
      // Usar zona horaria de Colombia para consistencia
      const now = new Date();
      return now.toLocaleString('en-CA', { timeZone: 'America/Bogota', year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function parseDateToTimestamp(dateStr){
      const s = safeStr(dateStr);
      if (!s) return null;
      const d = new Date(s + 'T12:00:00');
      if (Number.isNaN(d.getTime())) return null;
      return firebase.firestore.Timestamp.fromDate(d);
    }

    function dateInRange(ts, fromStr, toStr){
      const d = tsToDate(ts);
      if (!d) return false;
      const f = safeStr(fromStr) ? new Date(fromStr + 'T00:00:00') : null;
      const t = safeStr(toStr) ? new Date(toStr + 'T23:59:59') : null;
      if (f && d < f) return false;
      if (t && d > t) return false;
      return true;
    }

    function setCajaTab(tab){
      cajaActiveTab = (tab === 'local') ? 'local' : 'tiras';
      const isT = cajaActiveTab === 'tiras';
      $('cajaTabTiras').style.display = isT ? '' : 'none';
      $('cajaTabLocal').style.display = isT ? 'none' : '';
      $('btnCajaTabTiras').className = isT ? 'btn primary' : 'btn ghost';
      $('btnCajaTabLocal').className = isT ? 'btn ghost' : 'btn primary';
      // Cargar facturas de China cuando se cambia a esa pestaña
      if (isT) loadFacturasChina();
    }

    let cachedCajaAsesores = [];

    // Variables para listeners en tiempo real
    let unsubscribeFacturasChina = null;
    let unsubscribeCajaMovimientos = null;

    // Función para filtrar facturas por rango de fechas
    function filterFacturasByDate(facturas, fromStr, toStr) {
      return facturas.filter(f => {
        let fechaStr = safeStr(f.fechaHora) || safeStr(f.fecha) || '';
        if (fechaStr.includes('T')) fechaStr = fechaStr.split('T')[0];
        if (fechaStr.includes(' ')) fechaStr = fechaStr.split(' ')[0];
        if (!fechaStr) {
          if (f.createdAt && f.createdAt.toDate) {
            const d = f.createdAt.toDate();
            fechaStr = d.toISOString().split('T')[0];
          }
        }
        if (!fechaStr) return false;
        const d = new Date(fechaStr + 'T12:00:00');
        const from = new Date(fromStr + 'T00:00:00');
        const to = new Date(toStr + 'T23:59:59');
        return d >= from && d <= to;
      });
    }

    // Función para iniciar listener en tiempo real de facturas China
    function startFacturasChinaListener(){
      const fromStr = safeStr($('cajaFrom').value) || todayISO();
      const toStr = safeStr($('cajaTo').value) || todayISO();
      console.log('[China RT] Iniciando listener tiempo real, rango:', fromStr, '-', toStr);

      // Cancelar listener anterior si existe
      if (unsubscribeFacturasChina) {
        unsubscribeFacturasChina();
        unsubscribeFacturasChina = null;
      }

      // Crear nuevo listener en tiempo real
      unsubscribeFacturasChina = COL_FACTURAS_CHINA.orderBy('createdAt', 'desc').limit(500)
        .onSnapshot(snap => {
          facturasChina = snap.docs.map(doc => ({ id: doc.id, ...(doc.data() || {}) }));
          facturasLoaded = true;
          console.log('[China RT] Actualización en tiempo real, total:', facturasChina.length);
          
          const filtered = filterFacturasByDate(facturasChina, fromStr, toStr);
          console.log('[China RT] Facturas filtradas:', filtered.length);
          renderFacturasChina(filtered);
        }, err => {
          console.error('[China RT] Error en listener:', err);
        });
    }

    // Función para cargar facturas de China (compatible con código existente)
    async function loadFacturasChina(){
      const fromStr = safeStr($('cajaFrom').value) || todayISO();
      const toStr = safeStr($('cajaTo').value) || todayISO();
      console.log('[China] Cargando facturas, rango:', fromStr, '-', toStr);

      // Iniciar listener en tiempo real
      startFacturasChinaListener();
    }

    function renderFacturasChina(facturas){
      const listCompras = $('chinaComprasList');
      const listPendientes = $('chinaPendientesList');
      const listPagados = $('chinaPagadosList');

      console.log('[China] Facturas recibidas para render:', facturas.length);
      facturas.forEach(f => console.log('[China] Factura:', f.codigoRegistro, 'tipoPago:', f.tipoPago, 'recibido:', f.recibido, 'saldoPendiente:', f.saldoPendiente));

      // Separar: Contado = necesita recibido/verificado, Crédito = Pendientes de pago
      // Contado sin recibir = pendiente de recibir dinero
      // Contado recibido = ya recibido
      const getTipoPagoNorm = (f) => {
        const raw = safeStr((f && (f.tipoPago ?? f.tipo_pago ?? f.tipo)) || '').toLowerCase();
        if (raw.includes('cont')) return 'contado';
        if (raw.includes('cred')) return 'credito';
        return raw;
      };
      const getMetodoPagoNorm = (f) => {
        const raw = safeStr((f && (f.metodoPago ?? f.metodo_pago ?? f.metodo)) || '').toLowerCase();
        if (raw.includes('trans')) return 'transferencia';
        if (raw.includes('efec')) return 'efectivo';
        return raw;
      };

      // Función para calcular total abonado de una factura
      const getTotalAbonado = (f) => {
        const abonos = f.abonos || [];
        return abonos.reduce((sum, a) => sum + Number(a.montoAbono || a.monto || 0), 0);
      };

      // Función para obtener saldo pendiente (maneja el caso de saldoPendiente = 0 correctamente)
      const getSaldoPendiente = (f) => {
        // Si saldoPendiente existe (incluso si es 0), usarlo
        if (f.saldoPendiente !== undefined && f.saldoPendiente !== null) {
          return Number(f.saldoPendiente);
        }
        // Si no existe, usar valorTotal como fallback (factura nueva sin abonos)
        return Number(f.valorTotal || 0);
      };

      const contadoPendiente = facturas.filter(f => getTipoPagoNorm(f) === 'contado' && f.recibido !== true);
      const contadoRecibido = facturas.filter(f => getTipoPagoNorm(f) === 'contado' && f.recibido === true);
      // Crédito pendiente: saldo > 0
      const creditoPendiente = facturas.filter(f => getTipoPagoNorm(f) === 'credito' && getSaldoPendiente(f) > 0);
      // Crédito pagado: saldo = 0 (completamente abonado)
      const creditoPagado = facturas.filter(f => getTipoPagoNorm(f) === 'credito' && getSaldoPendiente(f) <= 0 && Number(f.valorTotal || 0) > 0);
      
      console.log('[China] Contado pendiente:', contadoPendiente.length, 'Contado recibido:', contadoRecibido.length, 'Crédito pendiente:', creditoPendiente.length, 'Crédito pagado:', creditoPagado.length);

      let totalRecibido = 0;
      let totalPorRecibir = 0;
      let totalCredito = 0;
      let totalIngresadoCaja = 0;

      // Calcular totales
      // Contado recibido pero NO ingresado a caja aún (pendiente de ingresar)
      contadoRecibido.forEach(f => {
        if (f.ingresadoACaja === true) {
          totalIngresadoCaja += Number(f.valorTotal || 0);
        }
      });
      // Contado pendiente de recibir
      contadoPendiente.forEach(f => totalPorRecibir += Number(f.valorTotal || 0));
      // Crédito pendiente (saldo por cobrar)
      creditoPendiente.forEach(f => totalCredito += getSaldoPendiente(f));
      // Créditos pagados que fueron ingresados a caja
      creditoPagado.forEach(f => {
        if (f.ingresadoACaja === true) {
          totalIngresadoCaja += Number(f.valorTotal || 0);
        }
      });
      // Sumar abonos individuales ingresados a caja (de facturas pendientes)
      creditoPendiente.forEach(f => {
        const abonos = f.abonos || [];
        abonos.forEach(a => {
          if (a.ingresadoACaja === true) {
            totalIngresadoCaja += Number(a.montoAbono || a.monto || 0);
          }
        });
      });

      // Renderizar Contado (por recibir + recibidos)
      if (listCompras) {
        const allContado = [...contadoPendiente, ...contadoRecibido];
        if (!allContado.length) {
          listCompras.innerHTML = '<div class="china-empty"><i class="fas fa-inbox"></i> Sin ventas de contado en el rango</div>';
        } else {
          listCompras.innerHTML = '';
          const frag = document.createDocumentFragment();
          allContado.forEach(f => {
            const item = document.createElement('div');
            item.className = 'china-item';
            const metodo = getMetodoPagoNorm(f) || 'efectivo';
            const esTransferencia = metodo === 'transferencia';
            const productos = (f.productos || []).map(p => safeStr(p.referenciaColor)).join(', ') || 'Sin productos';
            const recibido = f.recibido === true;
            const yaIngresado = f.ingresadoACaja === true;
            
            let btnHtml = '';
            let btnCajaHtml = '';
            if (recibido) {
              btnHtml = `<span class="chip ok"><i class="fas fa-check-circle"></i> ${esTransferencia ? 'Verificado' : 'Recibido'}</span>`;
              // Botón para ingresar a caja (solo si ya fue recibido/verificado)
              btnCajaHtml = yaIngresado 
                ? `<span class="chip" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;font-size:11px"><i class="fas fa-vault"></i> En Caja</span>`
                : `<button type="button" class="btn primary" style="padding:4px 10px;font-size:11px;background:linear-gradient(135deg,#f59e0b,#d97706)" data-ingresar-caja="${f.id}" data-valor="${f.valorTotal}" data-cliente="${safeStr(f.cliente)}" data-factura="${safeStr(f.codigoRegistro)}"><i class="fas fa-cash-register"></i> Ingresar a Caja</button>`;
            } else {
              if (esTransferencia) {
                btnHtml = `<button class="btn primary" style="background:linear-gradient(135deg,#3b82f6,#2563eb)" type="button" data-recibir-fac="${f.id}" data-metodo="transferencia"><i class="fas fa-clipboard-check"></i> Verificar</button>`;
              } else {
                btnHtml = `<button class="btn primary" style="background:linear-gradient(135deg,#10b981,#059669)" type="button" data-recibir-fac="${f.id}" data-metodo="efectivo"><i class="fas fa-hand-holding-dollar"></i> Recibido</button>`;
              }
            }
            
            const menuHtml = `
              <div class="mov-menu" style="position:relative;display:inline-block;margin-left:8px">
                <button type="button" class="btn ghost mov-menu-btn" style="padding:4px 8px;font-size:12px" data-fac-menu="${f.id}"><i class="fas fa-cog"></i></button>
                <div class="mov-menu-dropdown" id="facMenu_${f.id}" style="display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:100;min-width:120px">
                  <button type="button" class="mov-menu-item" data-edit-fac="${f.id}" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:13px;color:#374151"><i class="fas fa-edit" style="margin-right:6px;color:#3b82f6"></i>Editar</button>
                  <button type="button" class="mov-menu-item" data-delete-fac="${f.id}" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:13px;color:#ef4444"><i class="fas fa-trash" style="margin-right:6px"></i>Eliminar</button>
                </div>
              </div>
            `;

            const recibidoPorTxt = recibido && f.recibidoPor ? `<br>📋 ${esTransferencia ? 'Verificado' : 'Recibido'} por: <strong>${safeStr(f.recibidoPor)}</strong>` : '';
            const ingresadoPorTxt = yaIngresado && f.ingresadoACajaPor ? `<br>🏦 Ingresado a caja por: <strong>${safeStr(f.ingresadoACajaPor)}</strong>` : '';
            const creadoPorTxt = f.creadoPor ? `<br>👤 Creado por: <strong>${safeStr(f.creadoPor)}</strong>` : '';
            
            item.innerHTML = `
              <div class="china-item-info">
                <div class="china-item-title">Factura #${safeStr(f.codigoRegistro)} • ${fmtCOP(f.valorTotal || 0)}</div>
                <div class="china-item-meta">
                  Cliente: <strong>${safeStr(f.cliente)}</strong><br>
                  Fecha: <strong>${safeStr(f.fechaHora)}</strong><br>
                  Productos: ${productos}<br>
                  Método: <strong>${esTransferencia ? '💳 Transferencia' : '💵 Efectivo'}</strong>${creadoPorTxt}${recibidoPorTxt}${ingresadoPorTxt}
                </div>
              </div>
              <div class="china-item-actions" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                ${btnHtml}
                ${btnCajaHtml}
                ${menuHtml}
              </div>
            `;
            frag.appendChild(item);
          });
          listCompras.appendChild(frag);

          // Event listeners para menú de opciones (tuerca)
          attachFacMenuListeners(listCompras);
          // Event listeners para ingresar a caja
          attachIngresarCajaListeners(listCompras);

          // Event listeners para recibir/verificar
          Array.from(listCompras.querySelectorAll('button[data-recibir-fac]')).forEach(btn => {
            btn.addEventListener('click', async () => {
              const facId = btn.getAttribute('data-recibir-fac');
              const metodo = btn.getAttribute('data-metodo');
              if (!facId) return;
              const msgConfirm = metodo === 'transferencia' 
                ? '¿Confirmas que verificaste el comprobante de transferencia?' 
                : '¿Confirmas que recibiste el dinero en efectivo?';
              if (!confirm(msgConfirm)) return;
              try {
                await COL_FACTURAS_CHINA.doc(facId).update({ 
                  recibido: true, 
                  recibidoAt: new Date(), 
                  recibidoPor: safeStr(currentUser && currentUser.nombreCompleto),
                  tipoRecepcion: metodo
                });
                showError('');
                await loadFacturasChina();
              } catch (e) {
                showError('Error: ' + (e.message || e));
              }
            });
          });
        }
      }

      // Renderizar Crédito (pendientes de pago)
      if (listPendientes) {
        if (!creditoPendiente.length) {
          listPendientes.innerHTML = '<div class="china-empty"><i class="fas fa-inbox"></i> Sin créditos pendientes en el rango</div>';
        } else {
          listPendientes.innerHTML = '';
          const frag = document.createDocumentFragment();
          creditoPendiente.forEach(f => {
            const saldo = getSaldoPendiente(f);
            const totalAbonado = getTotalAbonado(f);
            const numAbonos = (f.abonos || []).length;
            const item = document.createElement('div');
            item.className = 'china-item';
            const productos = (f.productos || []).map(p => safeStr(p.referenciaColor)).join(', ') || 'Sin productos';
            
            const menuHtml = `
              <div class="mov-menu" style="position:relative;display:inline-block;margin-left:8px">
                <button type="button" class="btn ghost mov-menu-btn" style="padding:4px 8px;font-size:12px" data-fac-menu="${f.id}"><i class="fas fa-cog"></i></button>
                <div class="mov-menu-dropdown" id="facMenu_${f.id}" style="display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:100;min-width:120px">
                  <button type="button" class="mov-menu-item" data-edit-fac="${f.id}" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:13px;color:#374151"><i class="fas fa-edit" style="margin-right:6px;color:#3b82f6"></i>Editar</button>
                  <button type="button" class="mov-menu-item" data-delete-fac="${f.id}" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:13px;color:#ef4444"><i class="fas fa-trash" style="margin-right:6px"></i>Eliminar</button>
                </div>
              </div>
            `;

            // Info de abonos
            const abonosInfo = totalAbonado > 0 
              ? `<div style="margin-top:6px;padding:6px 10px;background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(5,150,105,.05));border-radius:6px;border:1px solid rgba(16,185,129,.2)">
                   <span style="color:#10b981;font-weight:600;font-size:12px"><i class="fas fa-coins"></i> Abonado: ${fmtCOP(totalAbonado)}</span>
                   <span style="color:#6b7280;font-size:11px;margin-left:8px">(${numAbonos} abono${numAbonos > 1 ? 's' : ''})</span>
                 </div>`
              : '';

            // Botón ver abonos
            const btnVerAbonos = `<button type="button" class="btn ghost" style="padding:4px 8px;font-size:11px;color:#3b82f6" data-ver-abonos='${JSON.stringify({id:f.id,codigo:f.codigoRegistro,cliente:f.cliente,total:f.valorTotal,saldo:saldo,abonos:f.abonos||[]})}'><i class="fas fa-list-check"></i> Ver Abonos</button>`;

            const creadoPorTxt = f.creadoPor ? `<br>👤 Creado por: <strong>${safeStr(f.creadoPor)}</strong>` : '';
            
            item.innerHTML = `
              <div class="china-item-info">
                <div class="china-item-title">Factura #${safeStr(f.codigoRegistro)} • Saldo: ${fmtCOP(saldo)}</div>
                <div class="china-item-meta">
                  Cliente: <strong>${safeStr(f.cliente)}</strong><br>
                  Fecha: <strong>${safeStr(f.fechaHora)}</strong><br>
                  Productos: ${productos}<br>
                  Total factura: <strong>${fmtCOP(f.valorTotal || 0)}</strong>${creadoPorTxt}
                  ${abonosInfo}
                </div>
              </div>
              <div class="china-item-actions" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                <span class="chip danger"><i class="fas fa-clock"></i> Pendiente</span>
                ${btnVerAbonos}
                ${menuHtml}
              </div>
            `;
            frag.appendChild(item);
          });
          listPendientes.appendChild(frag);
          
          // Event listeners para menú de opciones (tuerca)
          attachFacMenuListeners(listPendientes);
          // Event listeners para ver abonos
          attachVerAbonosListeners(listPendientes);
        }
      }

      // Renderizar Créditos Pagados (saldo = 0)
      if (listPagados) {
        if (!creditoPagado.length) {
          listPagados.innerHTML = '<div class="china-empty"><i class="fas fa-inbox"></i> Sin créditos pagados en el rango</div>';
        } else {
          listPagados.innerHTML = '';
          const frag = document.createDocumentFragment();
          creditoPagado.forEach(f => {
            const totalAbonado = getTotalAbonado(f);
            const numAbonos = (f.abonos || []).length;
            const item = document.createElement('div');
            item.className = 'china-item';
            const productos = (f.productos || []).map(p => safeStr(p.referenciaColor)).join(', ') || 'Sin productos';
            const yaIngresado = f.ingresadoACaja === true;
            
            const menuHtml = `
              <div class="mov-menu" style="position:relative;display:inline-block;margin-left:8px">
                <button type="button" class="btn ghost mov-menu-btn" style="padding:4px 8px;font-size:12px" data-fac-menu="${f.id}"><i class="fas fa-cog"></i></button>
                <div class="mov-menu-dropdown" id="facMenu_${f.id}" style="display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:100;min-width:120px">
                  <button type="button" class="mov-menu-item" data-edit-fac="${f.id}" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:13px;color:#374151"><i class="fas fa-edit" style="margin-right:6px;color:#3b82f6"></i>Editar</button>
                  <button type="button" class="mov-menu-item" data-delete-fac="${f.id}" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:13px;color:#ef4444"><i class="fas fa-trash" style="margin-right:6px"></i>Eliminar</button>
                </div>
              </div>
            `;

            // Botón ver abonos
            const btnVerAbonos = `<button type="button" class="btn ghost" style="padding:4px 8px;font-size:11px;color:#3b82f6" data-ver-abonos='${JSON.stringify({id:f.id,codigo:f.codigoRegistro,cliente:f.cliente,total:f.valorTotal,saldo:0,abonos:f.abonos||[]})}'><i class="fas fa-list-check"></i> Ver Abonos (${numAbonos})</button>`;

            // Botón ingresar a caja (solo si no ha sido ingresado)
            const btnIngresarCaja = yaIngresado 
              ? `<span class="chip" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;font-size:11px"><i class="fas fa-vault"></i> En Caja</span>`
              : `<button type="button" class="btn primary" style="padding:4px 10px;font-size:11px;background:linear-gradient(135deg,#f59e0b,#d97706)" data-ingresar-caja="${f.id}" data-valor="${f.valorTotal}" data-cliente="${safeStr(f.cliente)}" data-factura="${safeStr(f.codigoRegistro)}"><i class="fas fa-cash-register"></i> Ingresar a Caja</button>`;

            const creadoPorTxt = f.creadoPor ? `<br>👤 Creado por: <strong>${safeStr(f.creadoPor)}</strong>` : '';
            const ingresadoPorTxt = yaIngresado && f.ingresadoACajaPor ? `<br>🏦 Ingresado a caja por: <strong>${safeStr(f.ingresadoACajaPor)}</strong>` : '';
            
            item.innerHTML = `
              <div class="china-item-info">
                <div class="china-item-title">Factura #${safeStr(f.codigoRegistro)} • ${fmtCOP(f.valorTotal || 0)}</div>
                <div class="china-item-meta">
                  Cliente: <strong>${safeStr(f.cliente)}</strong><br>
                  Fecha: <strong>${safeStr(f.fechaHora)}</strong><br>
                  Productos: ${productos}<br>
                  <span style="color:#10b981;font-weight:600"><i class="fas fa-check-circle"></i> Pagado en ${numAbonos} abono${numAbonos > 1 ? 's' : ''}</span>${creadoPorTxt}${ingresadoPorTxt}
                </div>
              </div>
              <div class="china-item-actions" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                <span class="chip ok"><i class="fas fa-check-double"></i> Pagado</span>
                ${btnIngresarCaja}
                ${btnVerAbonos}
                ${menuHtml}
              </div>
            `;
            frag.appendChild(item);
          });
          listPagados.appendChild(frag);
          
          // Event listeners para menú de opciones (tuerca)
          attachFacMenuListeners(listPagados);
          // Event listeners para ver abonos
          attachVerAbonosListeners(listPagados);
          // Event listeners para ingresar a caja
          attachIngresarCajaListeners(listPagados);
        }
      }

      // Actualizar estadísticas del dashboard
      if ($('chinaStatCompras')) $('chinaStatCompras').textContent = fmtCOP(totalIngresadoCaja); // DINERO RECIBIDO (en caja)
      if ($('chinaStatPendientes')) $('chinaStatPendientes').textContent = fmtCOP(totalPorRecibir + totalCredito); // POR RECIBIR / CRÉDITOS
      if ($('chinaStatBalance')) $('chinaStatBalance').textContent = fmtCOP(totalIngresadoCaja); // TOTAL RECIBIDO
      if ($('chinaStatIngresos')) $('chinaStatIngresos').textContent = fmtCOP(totalIngresadoCaja + totalPorRecibir + totalCredito); // TOTAL VENTAS
      
      // Actualizar contadores
      if ($('chinaComprasCount')) $('chinaComprasCount').textContent = contadoPendiente.length + contadoRecibido.length;
      if ($('chinaPendientesCount')) $('chinaPendientesCount').textContent = creditoPendiente.length;
      if ($('chinaPagadosCount')) $('chinaPagadosCount').textContent = creditoPagado.length;
    }

    // Variables para edición de facturas China
    let editingFacId = null;
    let editingFacData = null;

    function attachFacMenuListeners(container){
      // Toggle menú dropdown
      container.querySelectorAll('button[data-fac-menu]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const facId = btn.getAttribute('data-fac-menu');
          const menu = document.getElementById('facMenu_' + facId);
          if (!menu) return;
          // Cerrar otros menús
          document.querySelectorAll('.mov-menu-dropdown').forEach(m => {
            if (m.id !== 'facMenu_' + facId) m.style.display = 'none';
          });
          menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        });
      });

      // Editar factura
      container.querySelectorAll('button[data-edit-fac]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const facId = btn.getAttribute('data-edit-fac');
          const fac = facturasChina.find(f => f.id === facId);
          if (fac) openEditFacModal(fac);
        });
      });

      // Eliminar factura
      container.querySelectorAll('button[data-delete-fac]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const facId = btn.getAttribute('data-delete-fac');
          if (!confirm('¿Eliminar esta factura? Esta acción no se puede deshacer.')) return;
          setLoading(true);
          try {
            await COL_FACTURAS_CHINA.doc(facId).delete();
            showSuccessMessage('Factura eliminada correctamente');
            await loadFacturasChina();
          } catch (err) {
            showError('Error al eliminar: ' + (err.message || err));
          } finally {
            setLoading(false);
          }
        });
      });
    }

    function openEditFacModal(fac){
      editingFacId = fac.id;
      editingFacData = fac;
      $('editFacValor').value = formatMonedaCO(fac.valorTotal || 0);
      $('editFacCliente').value = fac.cliente || '';
      $('editFacModal').classList.add('open');
    }

    function closeEditFacModal(){
      editingFacId = null;
      editingFacData = null;
      $('editFacModal').classList.remove('open');
    }

    async function saveEditFac(){
      if (!editingFacId) return;
      const nuevoValor = parseMonedaCO($('editFacValor').value);
      const nuevoCliente = safeStr($('editFacCliente').value);
      if (nuevoValor <= 0) { showError('El valor debe ser mayor a 0'); return; }
      if (!nuevoCliente) { showError('El cliente es requerido'); return; }
      setLoading(true);
      try {
        const updateData = {
          valorTotal: nuevoValor,
          cliente: nuevoCliente,
          updatedAt: firebase.firestore.Timestamp.fromDate(new Date()),
          updatedBy: safeStr(currentUser && currentUser.nombreCompleto)
        };
        // Si era crédito, actualizar saldo pendiente también
        if (editingFacData && editingFacData.tipoPago === 'credito') {
          const abonosTotal = (editingFacData.abonos || []).reduce((acc, a) => acc + Number(a.monto || 0), 0);
          updateData.saldoPendiente = Math.max(0, nuevoValor - abonosTotal);
        }
        await COL_FACTURAS_CHINA.doc(editingFacId).update(updateData);
        closeEditFacModal();
        showSuccessMessage('Factura actualizada correctamente');
        await loadFacturasChina();
      } catch (e) {
        showError('Error al guardar: ' + (e.message || e));
      } finally {
        setLoading(false);
      }
    }

    // Funciones para modal de Ver Abonos
    function attachVerAbonosListeners(container){
      container.querySelectorAll('button[data-ver-abonos]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          try {
            const data = JSON.parse(btn.getAttribute('data-ver-abonos'));
            openVerAbonosModal(data);
          } catch (err) {
            console.error('Error parsing abonos data:', err);
          }
        });
      });
    }

    // Variable para guardar datos del modal de abonos actual
    let currentAbonosModalData = null;

    function openVerAbonosModal(data){
      currentAbonosModalData = data;
      $('verAbonosFacCodigo').textContent = safeStr(data.codigo);
      $('verAbonosFacCliente').textContent = safeStr(data.cliente);
      $('verAbonosFacTotal').textContent = fmtCOP(data.total || 0);
      
      const abonos = data.abonos || [];
      const totalAbonado = abonos.reduce((sum, a) => sum + Number(a.montoAbono || a.monto || 0), 0);
      $('verAbonosFacAbonado').textContent = fmtCOP(totalAbonado);
      $('verAbonosFacSaldo').textContent = fmtCOP(data.saldo || 0);
      
      const listEl = $('verAbonosList');
      if (!abonos.length) {
        listEl.innerHTML = '<div class="china-empty" style="padding:20px"><i class="fas fa-inbox"></i> Sin abonos registrados</div>';
      } else {
        // Ordenar por fecha
        abonos.sort((a, b) => new Date(a.fechaAbono || a.fecha || 0) - new Date(b.fechaAbono || b.fecha || 0));
        
        let html = '<div style="display:flex;flex-direction:column;gap:8px">';
        abonos.forEach((a, i) => {
          const fecha = safeStr(a.fechaAbono || a.fecha);
          const monto = Number(a.montoAbono || a.monto || 0);
          const yaIngresado = a.ingresadoACaja === true;
          
          const btnCaja = yaIngresado
            ? `<span style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;font-size:10px;padding:3px 8px;border-radius:12px"><i class="fas fa-vault"></i> En Caja</span>`
            : `<button type="button" class="btn-ingresar-abono" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border:none;padding:4px 8px;border-radius:6px;font-size:10px;cursor:pointer" data-abono-index="${i}" data-abono-monto="${monto}" data-abono-fecha="${fecha}"><i class="fas fa-cash-register"></i> A Caja</button>`;
          
          const registradoPor = a.registradoPor ? `<br><span style="color:#6b7280;font-size:11px">👤 Por: <strong>${safeStr(a.registradoPor)}</strong></span>` : '';
          const ingresadoPor = yaIngresado && a.ingresadoACajaPor ? `<br><span style="color:#059669;font-size:11px">🏦 A caja por: <strong>${safeStr(a.ingresadoACajaPor)}</strong></span>` : '';
          
          html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f9fafb;border-radius:8px;border:1px solid #e5e7eb">
              <div>
                <span style="font-weight:600;color:#374151">Abono #${i + 1}</span>
                <span style="color:#6b7280;font-size:12px;margin-left:8px">${fecha}</span>
                ${registradoPor}${ingresadoPor}
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <span style="font-weight:700;color:#10b981">${fmtCOP(monto)}</span>
                ${btnCaja}
              </div>
            </div>
          `;
        });
        html += '</div>';
        listEl.innerHTML = html;
        
        // Attach listeners para botones de ingresar abono a caja
        listEl.querySelectorAll('.btn-ingresar-abono').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const idx = parseInt(btn.getAttribute('data-abono-index'));
            const monto = Number(btn.getAttribute('data-abono-monto') || 0);
            const fecha = btn.getAttribute('data-abono-fecha') || '';
            await ingresarAbonoACaja(idx, monto, fecha);
          });
        });
      }
      
      $('verAbonosModal').classList.add('open');
    }

    async function ingresarAbonoACaja(abonoIndex, monto, fecha){
      if (!currentAbonosModalData) return;
      const facId = currentAbonosModalData.id;
      const cliente = currentAbonosModalData.cliente;
      const factura = currentAbonosModalData.codigo;
      
      if (!confirm(`¿Ingresar abono de ${fmtCOP(monto)} a Caja Menor China?\n\nFactura #${factura}\nCliente: ${cliente}\nFecha abono: ${fecha}`)) return;
      
      setLoading(true);
      try {
        // 1. Crear movimiento de ingreso en caja_menor
        const movData = {
          tipo: 'ingreso',
          categoria: 'abono_credito',
          valor: monto,
          fecha: todayISO(),
          cliente: cliente,
          factura: factura,
          observaciones: `Abono factura #${factura} - Cliente: ${cliente} - Fecha abono: ${fecha}`,
          createdAt: firebase.firestore.Timestamp.fromDate(new Date()),
          createdBy: safeStr(currentUser && currentUser.nombreCompleto),
          origen: 'tiras'
        };
        await COL_CAJA.add(movData);
        
        // 2. Marcar el abono específico como ingresado en la factura
        const facDoc = await COL_FACTURAS_CHINA.doc(facId).get();
        if (facDoc.exists) {
          const facData = facDoc.data();
          const abonos = facData.abonos || [];
          if (abonos[abonoIndex]) {
            abonos[abonoIndex].ingresadoACaja = true;
            abonos[abonoIndex].ingresadoACajaAt = new Date().toISOString();
            abonos[abonoIndex].ingresadoACajaPor = safeStr(currentUser && currentUser.nombreCompleto);
            await COL_FACTURAS_CHINA.doc(facId).update({ abonos: abonos });
          }
        }
        
        showSuccessMessage(`Abono de ${fmtCOP(monto)} ingresado a Caja Menor China`);
        closeVerAbonosModal();
        await loadFacturasChina();
        await cajaCargar();
      } catch (err) {
        showError('Error al ingresar abono a caja: ' + (err.message || err));
      } finally {
        setLoading(false);
      }
    }

    function closeVerAbonosModal(){
      $('verAbonosModal').classList.remove('open');
    }

    // Función para manejar botón "Ingresar a Caja" en facturas pagadas de China
    function attachIngresarCajaListeners(container){
      container.querySelectorAll('button[data-ingresar-caja]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const facId = btn.getAttribute('data-ingresar-caja');
          const valor = Number(btn.getAttribute('data-valor') || 0);
          const cliente = btn.getAttribute('data-cliente') || '';
          const factura = btn.getAttribute('data-factura') || '';
          
          if (!confirm(`¿Ingresar ${fmtCOP(valor)} a Caja Menor China?\n\nFactura #${factura}\nCliente: ${cliente}`)) return;
          
          setLoading(true);
          try {
            // 1. Crear movimiento de ingreso en caja_menor (colección de tiras/china)
            const movData = {
              tipo: 'ingreso',
              categoria: 'venta_credito',
              valor: valor,
              fecha: todayISO(),
              cliente: cliente,
              factura: factura,
              observaciones: `Pago completo factura #${factura} - Cliente: ${cliente}`,
              createdAt: firebase.firestore.Timestamp.fromDate(new Date()),
              createdBy: safeStr(currentUser && currentUser.nombreCompleto),
              origen: 'tiras'
            };
            await COL_CAJA.add(movData);
            
            // 2. Marcar la factura como ingresada a caja
            await COL_FACTURAS_CHINA.doc(facId).update({
              ingresadoACaja: true,
              ingresadoACajaAt: firebase.firestore.Timestamp.fromDate(new Date()),
              ingresadoACajaPor: safeStr(currentUser && currentUser.nombreCompleto)
            });
            
            showSuccessMessage(`${fmtCOP(valor)} ingresado a Caja Menor China`);
            await loadFacturasChina();
            await cajaCargar();
          } catch (err) {
            showError('Error al ingresar a caja: ' + (err.message || err));
          } finally {
            setLoading(false);
          }
        });
      });
    }

    async function loadCajaAsesores(){
      cachedCajaAsesores = [];
      try {
        const snap = await COL_USUARIOS.where('permisos', 'in', ['Operador', 'operador', 'Administrador', 'administrador']).get();
        snap.forEach(doc => {
          const d = doc.data() || {};
          const n = safeStr(d.nombreCompleto || doc.id);
          if (n) cachedCajaAsesores.push(n);
        });
      } catch (e) {
        cachedCajaAsesores = [];
      }
      cachedCajaAsesores = Array.from(new Set(cachedCajaAsesores)).sort((a,b)=>a.localeCompare(b,'es'));

      const sel = $('localVentaAsesor');
      if (!sel) return;
      const prev = sel.value;
      sel.innerHTML = '<option value="">—</option>';
      cachedCajaAsesores.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
      });
      sel.value = (prev && cachedCajaAsesores.includes(prev)) ? prev : '';
    }

    async function cajaAddMovement(data){
      const who = safeStr(currentUser && (currentUser.nombreCompleto || currentUser.usuario));
      const payload = Object.assign({}, data || {});
      payload.usuario = who;
      payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      await COL_CAJA.add(payload);
    }

    async function cajaGuardarTirasIngreso(){
      clearError();
      const fechaStr = safeStr($('tirasIngresoFecha').value) || todayISO();
      const valor = parseMonedaCO($('tirasIngresoValor').value);
      const obs = safeStr($('tirasIngresoObs').value);
      if (!valor || valor <= 0) { showError('Caja menor: valor inválido.'); return; }
      const fecha = parseDateToTimestamp(fechaStr);
      setLoading(true);
      try {
        await cajaAddMovement({ subcaja: 'tiras', tipo: 'ingreso', categoria: 'ingreso_base', valor, fecha, fechaStr, observaciones: obs });
        $('tirasIngresoValor').value = '';
        $('tirasIngresoObs').value = '';
        await cajaCargar();
        // Abrir historial automáticamente para mostrar el movimiento
        const historialDetails = document.querySelector('#cajaTabTiras details:last-of-type');
        if (historialDetails) historialDetails.open = true;
        // Mostrar mensaje de éxito
        showSuccessMessage('✅ Ingreso guardado: ' + fmtCOP(valor));
      } catch (e) {
        showError(e && e.message ? e.message : String(e));
      } finally {
        setLoading(false);
      }
    }

    async function cajaGuardarTirasCierre(){
      clearError();
      const fechaStr = safeStr($('tirasCierreFecha').value) || todayISO();
      const valor = parseMonedaCO($('tirasCierreValor').value);
      const obs = safeStr($('tirasCierreObs').value);
      if (!Number.isFinite(valor) || valor < 0) { showError('Caja menor: valor inválido.'); return; }
      const fecha = parseDateToTimestamp(fechaStr);
      setLoading(true);
      try {
        await cajaAddMovement({ subcaja: 'tiras', tipo: 'cierre', categoria: 'cierre', valor, fecha, fechaStr, observaciones: obs });
        $('tirasCierreValor').value = '';
        $('tirasCierreObs').value = '';
        await cajaCargar();
        const historialDetails = document.querySelector('#cajaTabTiras details:last-of-type');
        if (historialDetails) historialDetails.open = true;
        showSuccessMessage('✅ Cuadre semanal guardado: ' + fmtCOP(valor));
      } catch (e) {
        showError(e && e.message ? e.message : String(e));
      } finally {
        setLoading(false);
      }
    }

    async function cajaGuardarTirasSalida(){
      clearError();
      const fechaStr = safeStr($('tirasSalidaFecha').value) || todayISO();
      const valor = parseMonedaCO($('tirasSalidaValor').value);
      const obs = safeStr($('tirasSalidaObs').value);
      if (!valor || valor <= 0) { showError('Caja menor: valor inválido.'); return; }
      const fecha = parseDateToTimestamp(fechaStr);
      setLoading(true);
      try {
        await cajaAddMovement({ subcaja: 'tiras', tipo: 'egreso', categoria: 'salida', valor, fecha, fechaStr, observaciones: obs });
        $('tirasSalidaValor').value = '';
        $('tirasSalidaObs').value = '';
        await cajaCargar();
        const historialDetails = document.querySelector('#cajaTabTiras details:last-of-type');
        if (historialDetails) historialDetails.open = true;
        showSuccessMessage('✅ Salida de dinero guardada: ' + fmtCOP(valor));
      } catch (e) {
        showError(e && e.message ? e.message : String(e));
      } finally {
        setLoading(false);
      }
    }

    async function cajaGuardarLocalVenta(){
      clearError();
      const fechaStr = safeStr($('localVentaFecha').value) || todayISO();
      const valor = parseMonedaCO($('localVentaValor').value);
      const cliente = safeStr($('localVentaCliente').value);
      const asesor = safeStr($('localVentaAsesor').value);
      if (!valor || valor <= 0) { showError('Caja menor: valor inválido.'); return; }
      const fecha = parseDateToTimestamp(fechaStr);
      setLoading(true);
      try {
        await cajaAddMovement({ subcaja: 'local', tipo: 'ingreso', categoria: 'venta', valor, fecha, fechaStr, cliente, asesor });
        $('localVentaValor').value = '';
        $('localVentaCliente').value = '';
        await cajaCargar();
        // Abrir historial automáticamente
        const historialDetails = document.querySelector('#cajaTabLocal details.china-form-section:last-of-type');
        if (historialDetails) historialDetails.open = true;
        showSuccessMessage('✅ Venta registrada: ' + fmtCOP(valor));
      } catch (e) {
        showError(e && e.message ? e.message : String(e));
      } finally {
        setLoading(false);
      }
    }

    async function cajaGuardarLocalEgreso(){
      clearError();
      const fechaStr = safeStr($('localEgresoFecha').value) || todayISO();
      const valor = parseMonedaCO($('localEgresoValor').value);
      const obs = safeStr($('localEgresoObs').value);
      if (!valor || valor <= 0) { showError('Caja menor: valor inválido.'); return; }
      const fecha = parseDateToTimestamp(fechaStr);
      setLoading(true);
      try {
        await cajaAddMovement({ subcaja: 'local', tipo: 'egreso', categoria: 'egreso', valor, fecha, fechaStr, observaciones: obs });
        $('localEgresoValor').value = '';
        $('localEgresoObs').value = '';
        await cajaCargar();
        const historialDetails = document.querySelector('#cajaTabLocal details.china-form-section:last-of-type');
        if (historialDetails) historialDetails.open = true;
        showSuccessMessage('✅ Egreso registrado: ' + fmtCOP(valor));
      } catch (e) {
        showError(e && e.message ? e.message : String(e));
      } finally {
        setLoading(false);
      }
    }

    async function cajaGuardarLocalIngreso(){
      clearError();
      const fechaStr = safeStr($('localIngresoFecha').value) || todayISO();
      const valor = parseMonedaCO($('localIngresoValor').value);
      const obs = safeStr($('localIngresoObs').value);
      if (!valor || valor <= 0) { showError('Caja menor: valor inválido.'); return; }
      const fecha = parseDateToTimestamp(fechaStr);
      setLoading(true);
      try {
        await cajaAddMovement({ subcaja: 'local', tipo: 'ingreso', categoria: 'ingreso', valor, fecha, fechaStr, observaciones: obs });
        $('localIngresoValor').value = '';
        $('localIngresoObs').value = '';
        await cajaCargar();
        const historialDetails = document.querySelector('#cajaTabLocal details.china-form-section:last-of-type');
        if (historialDetails) historialDetails.open = true;
        showSuccessMessage('✅ Ingreso registrado: ' + fmtCOP(valor));
      } catch (e) {
        showError(e && e.message ? e.message : String(e));
      } finally {
        setLoading(false);
      }
    }

    // Variables para modal de ver todos los movimientos de Local
    let localMovModalItems = [];
    let localMovModalPage = 1;
    const localMovModalPerPage = 15;

    function openLocalMovModal(){
      // Obtener todos los movimientos de local del rango actual
      const fromStr = safeStr($('cajaFrom').value) || todayISO();
      const toStr = safeStr($('cajaTo').value) || todayISO();

      COL_CAJA.orderBy('createdAt', 'desc').limit(800).get().then(snap => {
        const all = snap.docs.map(doc => ({ id: doc.id, ...(doc.data() || {}) }));
        localMovModalItems = all.filter(m => {
          if (safeStr(m.subcaja) !== 'local') return false;
          const dt = m.fecha || m.createdAt;
          return dateInRange(dt, fromStr, toStr);
        });
        localMovModalPage = 1;
        renderLocalMovModal();
        $('localMovModal').classList.add('open');
      }).catch(e => {
        showError('Error cargando movimientos: ' + (e.message || e));
      });
    }

    function closeLocalMovModal(){
      $('localMovModal').classList.remove('open');
    }

    function localMovModalPaginar(dir){
      const totalPages = Math.max(1, Math.ceil(localMovModalItems.length / localMovModalPerPage));
      localMovModalPage = Math.max(1, Math.min(totalPages, localMovModalPage + dir));
      renderLocalMovModal();
    }

    function renderLocalMovModal(){
      const listEl = $('localMovModalList');
      const totalPages = Math.max(1, Math.ceil(localMovModalItems.length / localMovModalPerPage));
      const start = (localMovModalPage - 1) * localMovModalPerPage;
      const end = start + localMovModalPerPage;
      const pageItems = localMovModalItems.slice(start, end);

      // Calcular totales
      let ingresos = 0, egresos = 0;
      localMovModalItems.forEach(m => {
        const val = Number(m.valor || 0);
        if (safeStr(m.tipo) === 'ingreso') ingresos += val;
        else if (safeStr(m.tipo) === 'egreso') egresos += val;
      });

      $('localMovModalIngresos').textContent = `Ingresos: ${fmtCOP(ingresos)}`;
      $('localMovModalEgresos').textContent = `Egresos: ${fmtCOP(egresos)}`;
      $('localMovModalSaldo').textContent = `Saldo: ${fmtCOP(ingresos - egresos)}`;
      $('localMovModalPaginacion').textContent = `Página ${localMovModalPage} de ${totalPages} (${localMovModalItems.length} movimientos)`;

      // Habilitar/deshabilitar botones
      $('localMovModalPrev').disabled = localMovModalPage <= 1;
      $('localMovModalNext').disabled = localMovModalPage >= totalPages;

      if (!pageItems.length) {
        listEl.innerHTML = '<div class="hint" style="text-align:center;padding:30px">Sin movimientos en el rango seleccionado.</div>';
        return;
      }

      const frag = document.createDocumentFragment();
      pageItems.forEach(m => {
        frag.appendChild(renderMovementCard(m, true));
      });
      listEl.innerHTML = '';
      listEl.appendChild(frag);

      // Agregar listeners para menú de opciones
      attachMovMenuListeners(listEl, pageItems);
    }

    // Variables para edición de movimientos
    let editingMovId = null;
    let editingMovData = null;

    function attachMovMenuListeners(listEl, items){
      // Toggle menú
      listEl.querySelectorAll('button[data-mov-menu]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.getAttribute('data-mov-menu');
          const menu = $('movMenu_' + id);
          if (!menu) return;
          // Cerrar otros menús
          document.querySelectorAll('.mov-menu-dropdown').forEach(m => { if (m !== menu) m.style.display = 'none'; });
          menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        });
      });

      // Eliminar
      listEl.querySelectorAll('button[data-delete-mov]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-delete-mov');
          if (!confirm('¿Estás seguro de eliminar este movimiento?')) return;
          setLoading(true);
          try {
            await COL_CAJA.doc(id).delete();
            showSuccessMessage('✅ Movimiento eliminado');
            await cajaCargar();
          } catch (e) {
            showError('Error al eliminar: ' + (e.message || e));
          } finally {
            setLoading(false);
          }
        });
      });

      // Editar
      listEl.querySelectorAll('button[data-edit-mov]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-edit-mov');
          const mov = items.find(m => String(m.id) === String(id));
          if (!mov) return;
          openEditMovModal(mov);
        });
      });

      // Cerrar menús al hacer click fuera
      document.addEventListener('click', () => {
        document.querySelectorAll('.mov-menu-dropdown').forEach(m => m.style.display = 'none');
      });
    }

    function openEditMovModal(mov){
      editingMovId = mov.id;
      editingMovData = mov;
      $('editMovValor').value = formatMonedaCO(mov.valor || 0);
      $('editMovObs').value = mov.observaciones || '';
      $('editMovModal').classList.add('open');
    }

    function closeEditMovModal(){
      editingMovId = null;
      editingMovData = null;
      $('editMovModal').classList.remove('open');
    }

    async function saveEditMov(){
      if (!editingMovId) return;
      const nuevoValor = parseMonedaCO($('editMovValor').value);
      const nuevaObs = safeStr($('editMovObs').value);
      if (nuevoValor <= 0) { showError('El valor debe ser mayor a 0'); return; }
      setLoading(true);
      try {
        await COL_CAJA.doc(editingMovId).update({
          valor: nuevoValor,
          observaciones: nuevaObs,
          updatedAt: firebase.firestore.Timestamp.fromDate(new Date()),
          updatedBy: safeStr(currentUser && currentUser.nombreCompleto)
        });
        closeEditMovModal();
        showSuccessMessage('✅ Movimiento actualizado');
        await cajaCargar();
      } catch (e) {
        showError('Error al actualizar: ' + (e.message || e));
      } finally {
        setLoading(false);
      }
    }

    async function loadPendingFletes(){
      const listEl = $('localFletesList');
      if (!listEl) return;
      listEl.innerHTML = '';

      let novedades = [];
      try {
        const snap = await db.collection('novedades').orderBy('updatedAt', 'desc').limit(400).get();
        novedades = snap.docs.map(d => Object.assign({ id: d.id }, d.data() || {}));
      } catch (e) {
        novedades = [];
      }

      // Obtener IDs de novedades ya agregadas a caja
      let novedadesEnCaja = new Set();
      try {
        const cajaSnap = await COL_CAJA.where('categoria', '==', 'flete').limit(500).get();
        cajaSnap.docs.forEach(doc => {
          const data = doc.data();
          if (data && data.novedadId) novedadesEnCaja.add(String(data.novedadId));
        });
      } catch (e) { /* ignore */ }

      const pending = (novedades || []).filter(n => {
        if (!n) return false;
        // Si ya está en caja, no mostrar
        if (novedadesEnCaja.has(String(n.id))) return false;
        const val = Number(n.fleteValor || 0);
        const pendiente = n.fletePendiente === true;
        const pagado = n.fletePagado === true;
        const resuelta = n.resuelta === true;
        // Mostrar si: tiene flete pendiente, o tiene flete > 0 (pagado o no), o está resuelta con flete
        if (pendiente) return true;
        if (val > 0) return true; // Incluir aunque esté pagado si no está en caja
        return false;
      }).slice(0, 120);

      const sum = pending.reduce((acc, n) => acc + Number(n.fleteValor || 0), 0);
      $('localFletesCount').textContent = `${pending.length} fletes`;
      $('localFletesSum').textContent = `Total: ${fmtCOP(sum)}`;

      if (!pending.length) {
        listEl.innerHTML = '<div class="hint">No hay fletes pendientes en novedades.</div>';
        return;
      }

      const frag = document.createDocumentFragment();
      pending.forEach(n => {
        const item = document.createElement('div');
        item.className = 'item';
        const code = safeStr(n.codigo_unico || n.registroId || '—');
        const cliente = safeStr(n.cliente || '—');
        const asesor = safeStr(n.asesor || '—');
        const desc = safeStr(n.descripcion || '');
        const val = Number(n.fleteValor || 0);
        const pend = n.fletePendiente === true;
        item.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
            <div>
              <div class="item-title">${code} • ${cliente}</div>
              <div class="hint">Asesor: <strong>${asesor}</strong></div>
              <div class="hint">${desc || '—'}</div>
              <div class="hint">Valor: <strong>${fmtCOP(val)}</strong> • ${pend ? '<span style="color:#f59e0b">⏳ Flete Pendiente</span>' : (n.fletePagado ? '<span style="color:#10b981">✓ Flete Pagado</span>' : '<span style="color:#6b7280">Sin pagar</span>')}${n.resuelta ? ' • <span style="color:#8b5cf6">Resuelta</span>' : ''}</div>
            </div>
            <div class="toolbar" style="justify-content:flex-end">
              <button class="btn primary" type="button" data-add-flete="${n.id}" style="background:linear-gradient(135deg,#3b82f6,#2563eb)"><i class="fas fa-plus"></i> Agregar a Caja</button>
            </div>
          </div>
        `;
        frag.appendChild(item);
      });
      listEl.appendChild(frag);

      Array.from(listEl.querySelectorAll('button[data-add-flete]')).forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-add-flete');
          const n = pending.find(x => String(x.id) === String(id));
          if (!n) return;
          clearError();
          setLoading(true);
          try {
            const fechaStr = safeStr($('cajaTo').value) || todayISO();
            const fecha = parseDateToTimestamp(fechaStr);
            await cajaAddMovement({
              subcaja: 'local',
              tipo: 'egreso',
              categoria: 'flete',
              valor: Number(n.fleteValor || 0),
              fecha,
              fechaStr,
              novedadId: String(n.id),
              codigo_unico: safeStr(n.codigo_unico || n.registroId || ''),
              cliente: safeStr(n.cliente || ''),
              asesor: safeStr(n.asesor || ''),
              fletePendiente: n.fletePendiente === true
            });
            showSuccessMessage('✅ Flete agregado a caja');
            await cajaCargar();
          } catch (e) {
            showError(e && e.message ? e.message : String(e));
          } finally {
            setLoading(false);
          }
        });
      });
    }

    function bindUi(){
      $('btnReload').addEventListener('click', () => refreshAll(false));
      $('btnOpenHistory').addEventListener('click', openHistory);
      $('btnSearchRef').addEventListener('click', searchByReference);
      $('btnCajaRecargar').addEventListener('click', () => {
        cajaCargar();
        if (cajaActiveTab === 'tiras') loadFacturasChina();
      });

      $('btnCajaTabTiras').addEventListener('click', () => setCajaTab('tiras'));
      $('btnCajaTabLocal').addEventListener('click', () => setCajaTab('local'));

      $('cajaFrom').addEventListener('change', () => { cajaCargar(); if (cajaActiveTab === 'tiras') loadFacturasChina(); });
      $('cajaTo').addEventListener('change', () => { cajaCargar(); if (cajaActiveTab === 'tiras') loadFacturasChina(); });

      $('btnTirasIngresoGuardar').addEventListener('click', cajaGuardarTirasIngreso);
      $('btnTirasCierreGuardar').addEventListener('click', cajaGuardarTirasCierre);
      $('btnTirasSalidaGuardar').addEventListener('click', cajaGuardarTirasSalida);

      $('btnLocalVentaGuardar').addEventListener('click', cajaGuardarLocalVenta);
      $('btnLocalEgresoGuardar').addEventListener('click', cajaGuardarLocalEgreso);
      $('btnLocalIngresoGuardar').addEventListener('click', cajaGuardarLocalIngreso);

      // Botón ver todos los movimientos de Local
      $('btnLocalVerTodos').addEventListener('click', openLocalMovModal);
      $('localMovModalPrev').addEventListener('click', () => localMovModalPaginar(-1));
      $('localMovModalNext').addEventListener('click', () => localMovModalPaginar(1));

      $('searchInput').addEventListener('input', renderResults);
      $('fromDate').addEventListener('change', () => refreshAll(false));
      $('toDate').addEventListener('change', () => refreshAll(false));
      $('empaqueSelect').addEventListener('change', () => { currentPage = 1; renderResults(); });
      $('bodeguerosSelect').addEventListener('change', () => { currentPage = 1; renderResults(); });
      $('asesorSelect').addEventListener('change', () => { currentPage = 1; renderResults(); });
      $('bloqueadoSelect').addEventListener('change', () => { currentPage = 1; renderResults(); });

      const prevBtn = $('btnPrevPage');
      const nextBtn = $('btnNextPage');
      if (prevBtn) prevBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderResults(); } });
      if (nextBtn) nextBtn.addEventListener('click', () => { currentPage++; renderResults(); });

      $('btnGoAuditoria').addEventListener('click', async () => {
        setModeAuditoria();
        await refreshAll(false);
        preloadAuditoriaData();
      });
      $('btnGoCaja').addEventListener('click', async () => {
        setModeCaja();
        setCajaTab('tiras');
        await cajaCargar();
      });
    }

    function loadCurrentUser(){
      const json = localStorage.getItem('datosUsuario');
      if (!json) { location.href='https://userlink2024.github.io/lazapateria/index.html'; return; }
      try{
        currentUser = JSON.parse(json);
        const label = (currentUser && (currentUser.nombreCompleto || currentUser.usuario)) ? (currentUser.nombreCompleto || currentUser.usuario) : 'Usuario';
        $('userPill').innerHTML = `<i class="fas fa-user"></i> <strong>${label}</strong>`;
      }catch{
        localStorage.removeItem('datosUsuario');
        location.href='https://userlink2024.github.io/lazapateria/index.html';
      }
    }

    async function refreshAll(loadHeavy){
      clearError();
      setLoading(true);
      try{
        if (loadHeavy) preloadAuditoriaData();
        await loadRegistros();
        updateAsesorSelectFromRegistros();
        currentPage = 1;
        renderResults();
      } catch (e) {
        showError(e && e.message ? e.message : String(e));
      } finally {
        setLoading(false);
      }
    }

    async function preloadAuditoriaData(){
      try { await loadUsuarios(); } catch (e) { /* no-op */ }
      try { await loadConsignacionesIndex(); } catch (e) { /* no-op */ }
    }

    function isRateLimitError(e){
      const code = (e && (e.code || e.status)) ? String(e.code || e.status) : '';
      const msg = (e && e.message) ? String(e.message) : '';
      return code === '429' || code === 'resource-exhausted' || msg.includes('429') || msg.toLowerCase().includes('resource') || msg.toLowerCase().includes('exhausted');
    }

    function isAlreadyExistsError(e){
      const code = (e && (e.code || e.status)) ? String(e.code || e.status) : '';
      const msg = (e && e.message) ? String(e.message) : '';
      return code === 'already-exists' || msg.toLowerCase().includes('already exists');
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function withRetry(fn, { retries = 2, baseDelay = 1200 } = {}){
      let last;
      for (let i = 0; i <= retries; i++) {
        try {
          return await fn();
        } catch (e) {
          last = e;
          if (!isRateLimitError(e) || i === retries) throw e;
          const jitter = Math.floor(Math.random() * 120);
          const delay = Math.min(5000, baseDelay * Math.pow(2, i) + jitter);
          await sleep(delay);
        }
      }
      throw last;
    }

    async function ensureConsignacionesLoaded(){
      if (consignacionesLoaded) return;
      if (!consignacionesLoadPromise) {
        consignacionesLoadPromise = (async () => {
          await loadConsignacionesIndex();
        })().finally(() => {
          consignacionesLoaded = true;
        });
      }
      await consignacionesLoadPromise;
    }

    function findBestReferencia(input){
      const q = normalizeRef(input);
      if (!q) return null;

      // Exact match first
      const exact = consignacionesIndex.find(x => x.referencia === q);
      if (exact && !usedRefsSet.has(exact.referencia)) return exact;

      const candidates = consignacionesIndex
        .filter(x => x && x.referencia && x.referencia.includes(q))
        .filter(x => !usedRefsSet.has(x.referencia));

      if (!candidates.length) return null;

      candidates.sort((a,b) => {
        const al = a.referencia.length;
        const bl = b.referencia.length;
        if (al !== bl) return al - bl;
        const ad = tsToDate(a.fecha) ? tsToDate(a.fecha).getTime() : 0;
        const bd = tsToDate(b.fecha) ? tsToDate(b.fecha).getTime() : 0;
        return bd - ad;
      });
      return candidates[0];
    }

    async function vincularReferenciaARegistro(registroId, registroData, consignacion){
      const ref = normalizeRef(consignacion && consignacion.referencia);
      if (!ref) throw new Error('Referencia inválida.');
      if (usedRefsSet.has(ref)) throw new Error(`La referencia ${ref} ya fue utilizada.`);

      const linkDoc = COL_REF_LINKS.doc(ref);
      const regDoc = COL_REGISTROS.doc(registroId);
      const who = safeStr(currentUser && (currentUser.nombreCompleto || currentUser.usuario));

      const r = registroData || {};
      try {
        await withRetry(() => db.collection('auditoria_fondos_refs').doc(ref).set({
          referencia: ref,
          valor: Number(consignacion.valor || 0),
          fecha: consignacion.fecha || null,
          cuentaId: safeStr(consignacion.cuentaId),
          consignacionId: safeStr(consignacion.consignacionId),
          path: safeStr(consignacion.path),
          linkedRegistroId: registroId,
          linkedCodigoUnico: safeStr(r.codigo_unico) || registroId,
          linkedAsesor: safeStr(r.asesor) || '',
          linkedCliente: safeStr(r.cliente) || '',
          linkedAt: firebase.firestore.FieldValue.serverTimestamp(),
          linkedBy: who
        }, { merge: false }));
      } catch (e) {
        if (isAlreadyExistsError(e)) {
          throw new Error(`La referencia ${ref} ya está vinculada.`);
        }
        throw e;
      }

      await withRetry(() => regDoc.update({
        referencias_bancarias: firebase.firestore.FieldValue.arrayUnion({
          referencia: ref,
          valor: Number(consignacion.valor || 0),
          fecha: consignacion.fecha || null,
          cuentaId: safeStr(consignacion.cuentaId),
          consignacionId: safeStr(consignacion.consignacionId),
          path: safeStr(consignacion.path)
        }),
        referencias_bancarias_refs: firebase.firestore.FieldValue.arrayUnion(ref)
      }));
    }

    async function bloquearRegistro(registro){
      const id = registro && registro.id;
      if (!id) throw new Error('ID inválido.');

      const refs = buildRegistroRefsFlat(registro);
      if (!refs.length) {
        throw new Error('Primero vincula al menos una referencia para poder bloquear el pedido.');
      }

      const who = safeStr(currentUser && (currentUser.nombreCompleto || currentUser.usuario));
      await withRetry(() => COL_REGISTROS.doc(id).set({
        bloqueado: true,
        bloqueadoPor: who
      }, { merge: true }));
    }

    async function loadUsuarios(){
      cachedOperadores = [];
      cachedBodegueros = [];

      const [operadoresSnapshot, bodeguerosSnapshot] = await Promise.all([
        COL_USUARIOS.where('permisos', 'in', ['Operador', 'operador']).get(),
        COL_USUARIOS.where('permisos', 'in', ['Bodeguero', 'bodeguero']).get()
      ]);

      operadoresSnapshot.forEach(doc => {
        const d = doc.data() || {};
        if (d.nombreCompleto) cachedOperadores.push(String(d.nombreCompleto));
      });
      bodeguerosSnapshot.forEach(doc => {
        const d = doc.data() || {};
        if (d.nombreCompleto) cachedBodegueros.push(String(d.nombreCompleto));
      });

      cachedOperadores = Array.from(new Set(cachedOperadores)).sort((a,b)=>a.localeCompare(b,'es'));
      cachedBodegueros = Array.from(new Set(cachedBodegueros)).sort((a,b)=>a.localeCompare(b,'es'));

      const sel = $('asesorSelect');
      const prev = sel.value;
      sel.innerHTML = '<option value="">Todos</option>';
      cachedOperadores.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
      });
      sel.value = prev;
    }

    function updateAsesorSelectFromRegistros(){
      const sel = $('asesorSelect');
      if (!sel) return;
      const prev = sel.value;

      const asesores = [];
      (allRegistros || []).forEach(r => {
        const a = safeStr(r && r.asesor);
        if (!a) return;
        if (cachedBodegueros && cachedBodegueros.length && cachedBodegueros.includes(a)) return;
        asesores.push(a);
      });

      const unique = Array.from(new Set(asesores)).sort((a,b)=>a.localeCompare(b,'es'));

      sel.innerHTML = '<option value="">Todos</option>';
      unique.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
      });

      sel.value = unique.includes(prev) ? prev : '';
    }

    async function fetchUsedRefsForList(refs){
      const ids = Array.from(new Set((Array.isArray(refs) ? refs : []).map(normalizeRef).filter(Boolean)));
      if (!ids.length) return;

      const fieldPath = firebase.firestore.FieldPath.documentId();
      for (let i = 0; i < ids.length; i += 10) {
        const chunk = ids.slice(i, i + 10);
        const snap = await withRetry(() => COL_REF_LINKS.where(fieldPath, 'in', chunk).get());
        snap.forEach(doc => {
          const ref = normalizeRef(doc.id);
          if (ref) usedRefsSet.add(ref);
        });
      }
    }

    async function loadConsignacionesIndex(){
      consignacionesIndex = [];

      const cuentasMap = new Map();
      try {
        const cuentasSnap = await db.collection('cuentas').get();
        cuentasSnap.forEach(doc => {
          const d = doc.data() || {};
          const nombre = safeStr(d.name || d.nombre || d.nombreCuenta || d.banco || doc.id);
          cuentasMap.set(doc.id, nombre || doc.id);
        });
      } catch (e) {
        // no-op
      }

      const snap = await db.collectionGroup('consignaciones').get();
      snap.forEach(doc => {
        const d = doc.data() || {};
        if (d.isSeparator === true) return;
        const ref = normalizeRef(d.referencia);
        if (!ref) return;
        const cuentaId = (doc.ref.parent && doc.ref.parent.parent) ? doc.ref.parent.parent.id : '';
        const cuentaNombre = cuentasMap.get(cuentaId) || cuentaId || '';
        consignacionesIndex.push({
          referencia: ref,
          valor: Number(d.valor || 0),
          fecha: d.fecha || null,
          cuentaId,
          cuentaNombre,
          consignacionId: doc.id,
          path: doc.ref.path
        });
      });
    }

    async function loadRegistros(){
      const from = $('fromDate').value;
      const to = $('toDate').value;

      let q = COL_REGISTROS.orderBy('fecha_hora', 'desc');

      const hasFrom = Boolean(from);
      const hasTo = Boolean(to);
      const now = new Date();

      if (hasFrom || hasTo) {
        if (hasFrom) {
          const d = new Date(from + 'T00:00:00');
          q = q.where('fecha_hora', '>=', firebase.firestore.Timestamp.fromDate(d));
        }
        if (hasTo) {
          const d = new Date(to + 'T23:59:59');
          q = q.where('fecha_hora', '<=', firebase.firestore.Timestamp.fromDate(d));
        }
      } else {
        const dTo = now;
        const dFrom = new Date(now);
        dFrom.setDate(dFrom.getDate() - 30);
        q = q.where('fecha_hora', '>=', firebase.firestore.Timestamp.fromDate(dFrom));
        q = q.where('fecha_hora', '<=', firebase.firestore.Timestamp.fromDate(dTo));
      }

      const snap = await q.get();
      allRegistros = snap.docs.map(doc => ({ id: doc.id, ...(doc.data() || {}) }));
    }

    function applyFilters(){
      const asesor = $('asesorSelect').value;
      const bloqueado = $('bloqueadoSelect').value;
      const empaque = $('empaqueSelect').value;
      const tieneBodegueros = $('bodeguerosSelect').value;
      const search = safeStr($('searchInput').value).toLowerCase();

      let list = allRegistros.slice();

      if (empaque === 'si') list = list.filter(r => r.enviadoAEmpaque === true);
      if (empaque === 'no') list = list.filter(r => r.enviadoAEmpaque !== true);

      const hasBodegueros = (r) => Array.isArray(r.bodegueros_encargados) && r.bodegueros_encargados.length > 0;
      if (tieneBodegueros === 'si') list = list.filter(r => hasBodegueros(r));
      if (tieneBodegueros === 'no') list = list.filter(r => !hasBodegueros(r));

      // Excluir bodegueros: elimina si el asesor está identificado como Bodeguero
      if (cachedBodegueros.length) list = list.filter(r => !cachedBodegueros.includes(String(r.asesor || '')));

      if (asesor) list = list.filter(r => String(r.asesor || '') === asesor);
      if (bloqueado === 'si') list = list.filter(r => r.bloqueado === true);
      if (bloqueado === 'no') list = list.filter(r => r.bloqueado !== true);

      if (search) {
        list = list.filter(r => {
          const productos = Array.isArray(r.productos) ? r.productos : [];
          const abonos = Array.isArray(r.abonos) ? r.abonos : [];
          const refs = Array.isArray(r.referencias_bancarias_refs) ? r.referencias_bancarias_refs : [];
          const bodegueros = Array.isArray(r.bodegueros_encargados) ? r.bodegueros_encargados : [];
          const prodText = productos.map(p => [p.referencia, p.color, p.talla, p.precio].filter(Boolean).join(' ')).join(' | ');
          const abonosText = abonos.map(a => [a.fecha, a.monto].filter(Boolean).join(' ')).join(' | ');
          const blob = safeStr([
            r.codigo_unico, r.cliente, r.asesor, r.usuario, r.observaciones,
            r.transportadora, r.saldo_a_favor, r.num_pares, r.valor_total,
            String(r.enviadoAEmpaque === true ? 'ENVIADO A EMPAQUE' : ''),
            bodegueros.join(' '),
            refs.join(' '), prodText, abonosText
          ].join(' ')).toLowerCase();
          return blob.includes(search);
        });
      }

      return list;
    }

    function renderResults(){
      const container = $('results');
      if (!container) return;
      container.innerHTML = '';

      const list = applyFilters();
      if (!list.length) {
        const pager = $('pager');
        if (pager) pager.style.display = 'none';
        container.innerHTML = '<div class="hint">No hay pedidos con esos filtros.</div>';
        return;
      }

      const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const start = (currentPage - 1) * PAGE_SIZE;
      const pageList = list.slice(start, start + PAGE_SIZE);

      const pager = $('pager');
      const pageLabel = $('pageLabel');
      const prevBtn = $('btnPrevPage');
      const nextBtn = $('btnNextPage');
      if (pager) pager.style.display = totalPages > 1 ? 'flex' : 'none';
      if (pageLabel) pageLabel.textContent = `Página ${currentPage} de ${totalPages} (${list.length} pedidos)`;
      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages;

      const frag = document.createDocumentFragment();
      pageList.forEach(r => {
        const item = document.createElement('div');
        item.className = 'item';

        const total = Number(r.valor_total || 0);
        const totalAbonos = sumAbonos(r.abonos);
        const coincide = Math.round(total) === Math.round(totalAbonos);

        const refs = buildRegistroRefsFlat(r);
        const saldoPendiente = Math.max(0, Math.round(total - totalAbonos));

        const productos = Array.isArray(r.productos) ? r.productos : [];
        const abonos = Array.isArray(r.abonos) ? r.abonos : [];

        item.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
            <div>
              <div class="item-title">${safeStr(r.cliente) || 'Cliente'} <span class="hint">• ${safeStr(r.asesor) || 'Asesor'}</span></div>
              <div class="hint">Código único: <strong>${safeStr(r.codigo_unico) || r.id}</strong> • Registro: <strong>${r.id}</strong> • Fecha: <strong>${formatDateTime(r.fecha_hora)}</strong></div>
              <div class="hint">Valor total: <strong>${fmtCOP(total)}</strong> • Abonos: <strong style="color:${coincide ? 'var(--ok)' : 'var(--danger)'}">${fmtCOP(totalAbonos)}</strong> • Pendiente: <strong>${fmtCOP(saldoPendiente)}</strong></div>
              <div class="hint">Pares: <strong>${Number(r.num_pares || 0)}</strong> • Usuario: <strong>${safeStr(r.usuario) || 'N/A'}</strong> • Transportadora: <strong>${safeStr(r.transportadora) || 'N/A'}</strong></div>
            </div>
            <div class="chips">
              ${r.bloqueado === true ? '<span class="chip danger"><i class="fas fa-lock"></i> Bloqueado</span>' : '<span class="chip ok"><i class="fas fa-unlock"></i> No bloqueado</span>'}
              ${coincide ? '<span class="chip ok"><i class="fas fa-check"></i> Abonos OK</span>' : '<span class="chip danger"><i class="fas fa-triangle-exclamation"></i> Abonos NO</span>'}
            </div>
          </div>
          <div style="margin-top:12px;display:grid;gap:10px">
            <div class="hint">Observaciones: <strong>${safeStr(r.observaciones) || 'N/A'}</strong></div>
            <div class="hint">Referencias vinculadas: <strong>${refs.length ? refs.join(', ') : 'Ninguna'}</strong></div>

            <div class="grid">
              <div>
                <label>Productos</label>
                <div class="hint" style="line-height:1.6">
                  ${productos.length ? productos.map(p => `• ${(p.referencia||'')}${p.color ? ' ' + p.color : ''}${p.talla ? ' T:' + p.talla : ''}${p.precio != null ? ' $' + p.precio : ''}`).join('<br>') : 'Sin productos'}
                </div>
              </div>
              <div>
                <label>Abonos</label>
                <div class="hint" style="line-height:1.6">
                  ${abonos.length ? abonos.map(a => `• ${(a.fecha||'')}: ${fmtCOP(a.monto || 0)}`).join('<br>') : 'Sin abonos'}
                </div>
              </div>
            </div>

            <div class="grid" style="grid-template-columns: 1fr auto auto">
              <div>
                <label>Vincular referencia</label>
                <div class="ref-suggest">
                  <input type="text" placeholder="Escribe mínimo 3 caracteres y selecciona la referencia" data-ref-input="${r.id}" autocomplete="off" />
                  <div class="ref-suggest-list" id="refSuggest_${r.id}"></div>
                </div>
                <div class="hint" id="refInfo_${r.id}" style="display:none;margin-top:6px"></div>
              </div>
              <div style="display:flex;align-items:end">
                <button class="btn primary" type="button" data-btn-vincular="${r.id}"><i class="fas fa-link"></i> Vincular</button>
              </div>
              <div style="display:flex;align-items:end">
                <button class="btn danger" type="button" data-btn-bloquear="${r.id}"><i class="fas fa-lock"></i> Bloquear</button>
              </div>
            </div>
            <div class="hint">Solo permite referencias existentes en consignaciones y que no estén usadas.</div>
          </div>
        `;
        frag.appendChild(item);
      });
      container.appendChild(frag);

      attachRowHandlers(pageList);
    }

    function attachRowHandlers(currentList){
      const listById = new Map(currentList.map(r => [String(r.id), r]));

      const inputs = Array.from(document.querySelectorAll('input[data-ref-input]'));
      inputs.forEach(input => {
        input.addEventListener('input', async () => {
          const id = input.getAttribute('data-ref-input');
          await updateRefSuggestions(id, input.value);
        });
        input.addEventListener('focus', async () => {
          const id = input.getAttribute('data-ref-input');
          await updateRefSuggestions(id, input.value);
        });
        input.addEventListener('keydown', async (e) => {
          if (e.key !== 'Enter') return;
          e.preventDefault();
          const id = input.getAttribute('data-ref-input');
          await doLink(id, input.value);
          input.value = '';
          hideRefSuggest(id);
        });
      });

      const btnsLink = Array.from(document.querySelectorAll('button[data-btn-vincular]'));
      btnsLink.forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-btn-vincular');
          const input = document.querySelector(`input[data-ref-input="${id}"]`);
          const val = input ? input.value : '';
          await doLink(id, val);
          if (input) input.value = '';
        });
      });

      const btnsBlock = Array.from(document.querySelectorAll('button[data-btn-bloquear]'));
      btnsBlock.forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-btn-bloquear');
          const r = listById.get(String(id));
          if (!r) return;
          clearError();
          setLoading(true);
          try{
            await bloquearRegistro(r);
            await refreshAll(false);
          }catch(e){
            showError(e && e.message ? e.message : String(e));
          }finally{
            setLoading(false);
          }
        });
      });
    }

    async function doLink(registroId, rawInput){
      clearError();
      const q = normalizeRef(rawInput);
      if (!q || q.length < 3) {
        showError('Escribe al menos 3 caracteres de la referencia.');
        return;
      }

      await ensureConsignacionesLoaded();

      try { await fetchUsedRefsForList([q]); } catch (e) { /* no-op */ }

      const exact = consignacionesIndex.find(x => x && x.referencia === q);
      if (!exact) {
        showError('Selecciona una referencia válida de la lista.');
        return;
      }
      if (usedRefsSet.has(q)) {
        showError(`La referencia ${q} ya fue utilizada.`);
        return;
      }

      const registroData = allRegistros.find(r => String(r.id) === String(registroId)) || null;
      if (!registroData) {
        showError('No se pudo encontrar el pedido en pantalla. Recarga e intenta de nuevo.');
        return;
      }

      setLoading(true);
      try{
        await vincularReferenciaARegistro(registroId, registroData, exact);
        usedRefsSet.add(q);
        if (registroData) {
          const refsFlat = buildRegistroRefsFlat(registroData);
          if (!refsFlat.includes(q)) {
            if (!Array.isArray(registroData.referencias_bancarias)) registroData.referencias_bancarias = [];
            registroData.referencias_bancarias.push({
              referencia: q,
              valor: Number(exact.valor || 0),
              fecha: exact.fecha || null,
              cuentaId: safeStr(exact.cuentaId),
              consignacionId: safeStr(exact.consignacionId),
              path: safeStr(exact.path)
            });
            registroData.referencias_bancarias_refs = refsFlat.concat([q]);
          }
        }
        renderResults();
      }catch(e){
        showError(e && e.message ? e.message : String(e));
      }finally{
        setLoading(false);
      }
    }

    async function updateRefSuggestions(registroId, rawInput){
      const q = normalizeRef(rawInput);
      const box = document.getElementById(`refSuggest_${registroId}`);
      if (!box) return;
      box.innerHTML = '';

      if (!q || q.length < 3) { hideRefSuggest(registroId); return; }

      await ensureConsignacionesLoaded();

      const candidates = consignacionesIndex
        .filter(x => x && x.referencia && x.referencia.includes(q));

      if (!candidates.length) { hideRefSuggest(registroId); return; }

      candidates.sort((a,b) => {
        const al = a.referencia.length;
        const bl = b.referencia.length;
        if (al !== bl) return al - bl;
        const ad = tsToDate(a.fecha) ? tsToDate(a.fecha).getTime() : 0;
        const bd = tsToDate(b.fecha) ? tsToDate(b.fecha).getTime() : 0;
        return bd - ad;
      });

      const top = candidates.slice(0, 18);
      await fetchUsedRefsForList(top.map(x => x.referencia));
      top.forEach(c => {
        const isUsed = usedRefsSet.has(c.referencia);
        const row = document.createElement('div');
        row.className = 'ref-opt' + (isUsed ? ' disabled' : '');
        const cuenta = safeStr(c.cuentaNombre || c.cuentaId || '');
        const valor = fmtCOP(Number(c.valor || 0));
        row.innerHTML = `
          <div class="ref-meta">
            <span class="ref-badge ${isUsed ? 'bad' : 'ok'}">
              <i class="fas ${isUsed ? 'fa-xmark' : 'fa-check'}"></i>
              ${isUsed ? 'Vinculada' : 'Disponible'}
            </span>
            <span class="ref-code">${c.referencia}</span>
          </div>
          <div class="ref-right">
            <span class="hint" style="font-weight:900;color:var(--text)">${valor}</span>
            <span class="hint">${cuenta || 'Cuenta'}</span>
          </div>
        `;
        if (!isUsed) {
          row.addEventListener('click', () => {
            const input = document.querySelector(`input[data-ref-input="${registroId}"]`);
            if (input) input.value = c.referencia;
            const info = document.getElementById(`refInfo_${registroId}`);
            if (info) {
              info.style.display = '';
              info.textContent = `Cuenta: ${cuenta || 'N/A'} • Valor: ${valor}`;
            }
            hideRefSuggest(registroId);
          });
        }
        box.appendChild(row);
      });

      showRefSuggest(registroId);
    }

    function showRefSuggest(registroId){
      const box = document.getElementById(`refSuggest_${registroId}`);
      if (!box) return;
      box.classList.add('open');
    }

    function hideRefSuggest(registroId){
      const box = document.getElementById(`refSuggest_${registroId}`);
      if (!box) return;
      box.classList.remove('open');
    }

    async function searchByReference(){
      const container = $('historyResults');
      if (!container) return;
      container.innerHTML = '';

      const ref = normalizeRef($('historyRef').value);
      if (!ref) {
        container.innerHTML = '<div class="hint">Ingresa una referencia.</div>';
        return;
      }

      clearError();
      setLoading(true);
      try{
        const [snap, linkSnap] = await Promise.all([
          COL_REGISTROS.where('referencias_bancarias_refs', 'array-contains', ref).get(),
          COL_REF_LINKS.doc(ref).get()
        ]);
        const rows = snap.docs.map(doc => ({ id: doc.id, ...(doc.data() || {}) }));
        if (!rows.length) {
          container.innerHTML = '<div class="hint">No se encontraron pedidos vinculados a esa referencia.</div>';
          return;
        }

        const linkData = linkSnap && linkSnap.exists ? (linkSnap.data() || {}) : null;

        const frag = document.createDocumentFragment();
        rows.forEach(r => {
          const item = document.createElement('div');
          item.className = 'item';
          item.innerHTML = `
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
              <div>
                <div class="item-title">${safeStr(r.cliente) || 'Cliente'} <span class="hint">• ${safeStr(r.asesor) || 'Asesor'}</span></div>
                <div class="hint">Código único: <strong>${safeStr(r.codigo_unico) || r.id}</strong> • Fecha: <strong>${formatDateTime(r.fecha_hora)}</strong></div>
              </div>
              <div class="chips">
                <span class="chip"><i class="fas fa-hashtag"></i> ${ref}</span>
                ${r.bloqueado === true ? '<span class="chip danger"><i class="fas fa-lock"></i> Bloqueado</span>' : ''}
              </div>
            </div>
            <div class="hint" style="margin-top:10px">Observaciones: <strong>${safeStr(r.observaciones) || 'N/A'}</strong></div>
            ${linkData ? `<div class="hint" style="margin-top:8px">Cuenta: <strong>${safeStr(linkData.cuentaId) || 'N/A'}</strong> • Valor: <strong>${fmtCOP(Number(linkData.valor || 0))}</strong> • Vinculada por: <strong>${safeStr(linkData.linkedBy) || 'N/A'}</strong></div>` : ''}
            <div class="toolbar" style="margin-top:12px; justify-content:flex-end; gap:10px">
              <button class="btn ghost" type="button" data-hist-edit="${r.id}"><i class="fas fa-pen-to-square"></i> Editar</button>
              <button class="btn danger" type="button" data-hist-del="${r.id}"><i class="fas fa-trash"></i> Eliminar</button>
            </div>
          `;
          frag.appendChild(item);
        });
        container.appendChild(frag);

        attachHistoryHandlers(ref, rows, linkData);
      }catch(e){
        showError(e && e.message ? e.message : String(e));
      }finally{
        setLoading(false);
      }
    }

    async function getRegistroByIdOrCodigo(input){
      const q = safeStr(input);
      if (!q) return null;

      const direct = await COL_REGISTROS.doc(q).get();
      if (direct.exists) return { id: direct.id, ...(direct.data() || {}) };

      const snap = await COL_REGISTROS.where('codigo_unico', '==', q).limit(1).get();
      if (snap.empty) return null;
      const doc = snap.docs[0];
      return { id: doc.id, ...(doc.data() || {}) };
    }

    async function unlinkRefFromRegistro(registroId, ref){
      const regDoc = COL_REGISTROS.doc(registroId);
      const snap = await regDoc.get();
      if (!snap.exists) return;
      const d = snap.data() || {};

      const refsArr = Array.isArray(d.referencias_bancarias_refs) ? d.referencias_bancarias_refs : [];
      const refsNew = refsArr.filter(x => normalizeRef(x) !== normalizeRef(ref));

      const objsArr = Array.isArray(d.referencias_bancarias) ? d.referencias_bancarias : [];
      const objsNew = objsArr.filter(x => normalizeRef(x && x.referencia) !== normalizeRef(ref));

      await regDoc.set({
        referencias_bancarias_refs: refsNew,
        referencias_bancarias: objsNew
      }, { merge: true });
    }

    async function linkRefToRegistro(registroId, registroData, ref, linkData){
      const regDoc = COL_REGISTROS.doc(registroId);

      let payload = linkData;
      if (!payload) {
        try { await ensureConsignacionesLoaded(); } catch (e) { /* no-op */ }
        const found = findBestReferencia(ref);
        payload = found ? {
          referencia: normalizeRef(found.referencia),
          valor: Number(found.valor || 0),
          fecha: found.fecha || null,
          cuentaId: safeStr(found.cuentaId),
          consignacionId: safeStr(found.consignacionId),
          path: safeStr(found.path)
        } : { referencia: normalizeRef(ref) };
      }

      const obj = {
        referencia: normalizeRef(payload.referencia || ref),
        valor: Number(payload.valor || 0),
        fecha: payload.fecha || null,
        cuentaId: safeStr(payload.cuentaId),
        consignacionId: safeStr(payload.consignacionId),
        path: safeStr(payload.path)
      };

      const current = await regDoc.get();
      const d = current.exists ? (current.data() || {}) : {};
      const refsArr = Array.isArray(d.referencias_bancarias_refs) ? d.referencias_bancarias_refs : [];
      const objsArr = Array.isArray(d.referencias_bancarias) ? d.referencias_bancarias : [];

      const refNorm = normalizeRef(obj.referencia);
      const refsNew = Array.from(new Set(refsArr.concat([refNorm])));
      const objsNew = objsArr.filter(x => normalizeRef(x && x.referencia) !== refNorm).concat([obj]);

      await regDoc.set({
        referencias_bancarias_refs: refsNew,
        referencias_bancarias: objsNew
      }, { merge: true });

      const who = safeStr(currentUser && (currentUser.nombreCompleto || currentUser.usuario));
      const r = registroData || {};
      await COL_REF_LINKS.doc(refNorm).set({
        referencia: refNorm,
        valor: Number(obj.valor || 0),
        fecha: obj.fecha || null,
        cuentaId: safeStr(obj.cuentaId),
        consignacionId: safeStr(obj.consignacionId),
        path: safeStr(obj.path),
        linkedRegistroId: registroId,
        linkedCodigoUnico: safeStr(r.codigo_unico) || registroId,
        linkedAsesor: safeStr(r.asesor) || '',
        linkedCliente: safeStr(r.cliente) || '',
        linkedAt: firebase.firestore.FieldValue.serverTimestamp(),
        linkedBy: who
      }, { merge: false });
    }

    function attachHistoryHandlers(ref, rows, linkData){
      const editBtns = Array.from(document.querySelectorAll('button[data-hist-edit]'));
      const delBtns = Array.from(document.querySelectorAll('button[data-hist-del]'));

      editBtns.forEach(btn => {
        btn.addEventListener('click', async () => {
          const oldRegistroId = btn.getAttribute('data-hist-edit');
          const input = prompt('Ingresa el ID del registro o el código único al que deseas mover esta referencia:');
          if (!input) return;

          setLoading(true);
          clearError();
          try {
            const newRegistro = await getRegistroByIdOrCodigo(input);
            if (!newRegistro) throw new Error('No se encontró el registro destino con ese ID/código único.');
            const refNorm = normalizeRef(ref);

            if (newRegistro.id === oldRegistroId) return;

            const currentLink = await COL_REF_LINKS.doc(refNorm).get();
            const currentLinkData = currentLink.exists ? (currentLink.data() || {}) : linkData;

            await withRetry(() => unlinkRefFromRegistro(oldRegistroId, refNorm));
            await withRetry(() => COL_REF_LINKS.doc(refNorm).delete());

            await withRetry(() => linkRefToRegistro(newRegistro.id, newRegistro, refNorm, currentLinkData));

            await searchByReference();
          } catch (e) {
            showError(e && e.message ? e.message : String(e));
          } finally {
            setLoading(false);
          }
        });
      });

      delBtns.forEach(btn => {
        btn.addEventListener('click', async () => {
          const registroId = btn.getAttribute('data-hist-del');
          const ok = confirm('¿Eliminar esta referencia del historial? Esto la desvincula del pedido y borra el registro de auditoría.');
          if (!ok) return;

          setLoading(true);
          clearError();
          try {
            const refNorm = normalizeRef(ref);
            await withRetry(() => unlinkRefFromRegistro(registroId, refNorm));
            await withRetry(() => COL_REF_LINKS.doc(refNorm).delete());
            usedRefsSet.delete(refNorm);
            await searchByReference();
          } catch (e) {
            showError(e && e.message ? e.message : String(e));
          } finally {
            setLoading(false);
          }
        });
      });
    }

    // Funciones globales para renderizado de movimientos
    function moveTitle(m){
      const cat = safeStr(m.categoria);
      if (cat === 'ingreso_base') return 'Ingreso (base)';
      if (cat === 'compra_proveedor') return 'Compra proveedor';
      if (cat === 'pendiente_proveedor') return 'Pendiente proveedor';
      if (cat === 'cierre') return 'Cierre / Cuadre';
      if (cat === 'salida') return 'Salida de dinero';
      if (cat === 'venta') return 'Ingreso (venta)';
      if (cat === 'egreso') return 'Egreso';
      if (cat === 'ingreso') return 'Ingreso';
      if (cat === 'flete') return 'Flete (novedad)';
      return safeStr(m.tipo) || 'Movimiento';
    }

    function renderMovementCard(m, isLocal){
      const item = document.createElement('div');
      item.className = 'item';
      item.style.position = 'relative';
      const fechaTxt = safeStr(m.fechaStr) || (tsToDate(m.fecha || m.createdAt) ? tsToDate(m.fecha || m.createdAt).toLocaleDateString('es-CO') : '');
      const proveedor = safeStr(m.proveedor);
      const factura = safeStr(m.factura);
      const obs = safeStr(m.observaciones);
      const cliente = safeStr(m.cliente);
      const asesor = safeStr(m.asesor);
      const code = safeStr(m.codigo_unico);

      const metaParts = [
        fechaTxt ? ('Fecha: <strong>' + fechaTxt + '</strong>') : '',
        proveedor ? ('Proveedor: <strong>' + proveedor + '</strong>') : '',
        factura ? ('Factura: <strong>' + factura + '</strong>') : '',
        cliente ? ('Cliente: <strong>' + cliente + '</strong>') : '',
        asesor ? ('Asesor: <strong>' + asesor + '</strong>') : '',
        code ? ('Código: <strong>' + code + '</strong>') : ''
      ].filter(Boolean).join(' • ');

      const tipo = safeStr(m.tipo);
      const val = Number(m.valor || 0);

      const menuHtml = isLocal ? `
        <div class="mov-menu" style="position:relative;display:inline-block">
          <button type="button" class="btn ghost mov-menu-btn" style="padding:4px 8px;font-size:12px" data-mov-menu="${m.id}"><i class="fas fa-cog"></i></button>
          <div class="mov-menu-dropdown" id="movMenu_${m.id}" style="display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:100;min-width:120px">
            <button type="button" class="mov-menu-item" data-edit-mov="${m.id}" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:13px;color:#374151"><i class="fas fa-edit" style="margin-right:6px;color:#3b82f6"></i>Editar</button>
            <button type="button" class="mov-menu-item" data-delete-mov="${m.id}" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:13px;color:#ef4444"><i class="fas fa-trash" style="margin-right:6px"></i>Eliminar</button>
          </div>
        </div>
      ` : '';

      item.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
          <div style="flex:1">
            <div class="item-title">${moveTitle(m)} • ${fmtCOP(val)}</div>
            <div class="hint">${metaParts || ''}</div>
            <div class="hint">Usuario: <strong>${safeStr(m.usuario) || 'N/A'}</strong></div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="chip ${tipo === 'egreso' ? 'danger' : (tipo === 'pendiente' ? 'danger' : 'ok')}"><i class="fas fa-circle"></i> ${tipo || '—'}</span>
            ${menuHtml}
          </div>
        </div>
        ${obs ? `<div class="hint" style="margin-top:10px">${obs}</div>` : ''}
      `;
      return item;
    }

    // Función para renderizar movimientos de caja (separada para reutilizar)
    function renderCajaMovimientos(itemsAll, fromStr, toStr) {
      const items = itemsAll.filter(m => {
        const dt = m.fecha || m.createdAt;
        return dateInRange(dt, fromStr, toStr);
      });

      const tirasList = $('cajaListTiras');
      const localList = $('cajaListLocal');
      if (tirasList) tirasList.innerHTML = '';
      if (localList) localList.innerHTML = '';

      const tirasItems = items.filter(m => safeStr(m.subcaja) === 'tiras' || !m.subcaja);
      const localItems = items.filter(m => safeStr(m.subcaja) === 'local');

      let tirasIngresos = 0;
      let tirasEgresos = 0;
      let localIngresos = 0;
      let localEgresos = 0;

      function accumulate(m, isLocal){
        const tipo = safeStr(m.tipo);
        const val = Number(m.valor || 0);
        if (tipo === 'ingreso') {
          if (isLocal) localIngresos += val; else tirasIngresos += val;
        } else if (tipo === 'egreso') {
          if (isLocal) localEgresos += val; else tirasEgresos += val;
        }
      }

      const tirasFrag = document.createDocumentFragment();
      const tirasFiltered = tirasItems.filter(m => !(safeStr(m.tipo) === 'pendiente' && safeStr(m.categoria) === 'pendiente_proveedor'));
      tirasFiltered.forEach(m => {
        accumulate(m, false);
        tirasFrag.appendChild(renderMovementCard(m, true));
      });
      if (tirasList) {
        if (!tirasFiltered.length) {
          tirasList.innerHTML = '<div class="hint">Sin movimientos en el rango.</div>';
        } else {
          tirasList.appendChild(tirasFrag);
          attachMovMenuListeners(tirasList, tirasFiltered);
        }
      }

      const localFrag = document.createDocumentFragment();
      localItems.forEach(m => {
        accumulate(m, true);
        localFrag.appendChild(renderMovementCard(m, true));
      });
      if (localList) {
        if (!localItems.length) localList.innerHTML = '<div class="hint">Sin movimientos en el rango.</div>';
        else {
          localList.appendChild(localFrag);
          attachMovMenuListeners(localList, localItems);
        }
      }

      // Actualizar resumen de movimientos de China
      if ($('tirasResumenIngresos')) $('tirasResumenIngresos').textContent = fmtCOP(tirasIngresos);
      if ($('tirasResumenEgresos')) $('tirasResumenEgresos').textContent = fmtCOP(tirasEgresos);
      if ($('tirasResumenSaldo')) $('tirasResumenSaldo').textContent = fmtCOP(tirasIngresos - tirasEgresos);
      if ($('tirasMovCount')) $('tirasMovCount').textContent = tirasItems.filter(m => !(safeStr(m.tipo) === 'pendiente' && safeStr(m.categoria) === 'pendiente_proveedor')).length;
      console.log('[Caja RT] Movimientos tiras:', tirasItems.length, 'Ingresos:', fmtCOP(tirasIngresos), 'Egresos:', fmtCOP(tirasEgresos));

      $('localTotalIngresos').textContent = `Ingresos: ${fmtCOP(localIngresos)}`;
      $('localTotalEgresos').textContent = `Egresos: ${fmtCOP(localEgresos)}`;
      $('localSaldo').textContent = `Saldo: ${fmtCOP(localIngresos - localEgresos)}`;

      // Actualizar dashboard resumen de Local
      if ($('localResumenIngresos')) $('localResumenIngresos').textContent = fmtCOP(localIngresos);
      if ($('localResumenEgresos')) $('localResumenEgresos').textContent = fmtCOP(localEgresos);
      if ($('localResumenSaldo')) $('localResumenSaldo').textContent = fmtCOP(localIngresos - localEgresos);
      if ($('localMovCount')) $('localMovCount').textContent = localItems.length;
      console.log('[Caja RT] Movimientos local:', localItems.length, 'Ingresos:', fmtCOP(localIngresos), 'Egresos:', fmtCOP(localEgresos));
    }

    // Función para iniciar listener en tiempo real de movimientos de caja
    function startCajaMovimientosListener() {
      const fromStr = safeStr($('cajaFrom').value) || todayISO();
      const toStr = safeStr($('cajaTo').value) || todayISO();
      console.log('[Caja RT] Iniciando listener tiempo real, rango:', fromStr, '-', toStr);

      // Cancelar listener anterior si existe
      if (unsubscribeCajaMovimientos) {
        unsubscribeCajaMovimientos();
        unsubscribeCajaMovimientos = null;
      }

      // Crear nuevo listener en tiempo real
      unsubscribeCajaMovimientos = COL_CAJA.orderBy('createdAt', 'desc').limit(800)
        .onSnapshot(snap => {
          const itemsAll = snap.docs.map(doc => ({ id: doc.id, ...(doc.data() || {}) }));
          console.log('[Caja RT] Actualización en tiempo real, total:', itemsAll.length);
          renderCajaMovimientos(itemsAll, fromStr, toStr);
        }, err => {
          console.error('[Caja RT] Error en listener:', err);
        });
    }

    async function cajaCargar(){
      clearError();
      setLoading(true);
      try{
        const fromStr = safeStr($('cajaFrom').value) || todayISO();
        const toStr = safeStr($('cajaTo').value) || todayISO();
        if (!$('cajaFrom').value) $('cajaFrom').value = fromStr;
        if (!$('cajaTo').value) $('cajaTo').value = toStr;

        if (!$('tirasIngresoFecha').value) $('tirasIngresoFecha').value = toStr;
        if (!$('tirasCierreFecha').value) $('tirasCierreFecha').value = toStr;
        if (!$('tirasSalidaFecha').value) $('tirasSalidaFecha').value = toStr;
        if (!$('localVentaFecha').value) $('localVentaFecha').value = toStr;
        if (!$('localEgresoFecha').value) $('localEgresoFecha').value = toStr;
        if (!$('localIngresoFecha').value) $('localIngresoFecha').value = toStr;

        await loadCajaAsesores();

        // Iniciar listener en tiempo real
        startCajaMovimientosListener();

        await loadPendingFletes();
      }catch(e){
        showError(e && e.message ? e.message : String(e));
      }finally{
        setLoading(false);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadCurrentUser();
      bindUi();
      initCamposMoneda();
      $('filtersCard').style.display='none';
      $('resultsCard').style.display='none';
      $('fromDate').value = '';
      $('toDate').value = '';

      document.addEventListener('click', (e) => {
        const t = e.target;
        if (!(t instanceof Element)) return;
        const inside = t.closest('.ref-suggest');
        if (inside) return;
        document.querySelectorAll('.ref-suggest-list.open').forEach(el => el.classList.remove('open'));
      });
    });
  </script>
</body>
</html>
