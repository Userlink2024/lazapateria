<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Consignaciones (Con Firebase)</title>
  <style>
    :root{--bg:#f7f7f9;--card:#fff;--accent:#0d6efd;--muted:#6c757d}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;background:var(--bg);margin:0;padding:20px;color:#222}
    .container{max-width:1200px;margin:0 auto}
    .card{background:var(--card);border-radius:8px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center}
    .col{flex:1}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], select, textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
    button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    button.ghost{background:#eee;color:#222}
    .account-list{max-height:220px;overflow:auto;border:1px dashed #e3e3e3;padding:8px;border-radius:6px}
    .account-item{padding:8px;border-radius:6px;cursor:pointer}
    .account-item:hover{background:#f1f7ff}
    .account-item.selected{background:#e8f0ff;border-left:4px solid var(--accent)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border:1px solid #e9e9ee;text-align:left;font-size:14px}
    tr.verified-admin{background:#e9ecef;color:#555}
    tr.verified-manager{background:#fff3bf;color:#555}
    tr.separator{background:#f8f9fa;font-weight:700;text-align:center}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center}
    .modal .card{width:720px;max-width:95%}
    .hidden{display:none}
    .gear{cursor:pointer;padding:6px;border-radius:6px;border:1px solid #ddd;background:#fafafa}
    .muted{color:var(--muted)}
    .center{display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div class="container">
    <h2>Sistema de Consignaciones (Firebase)</h2>

    <div class="card" id="auth-panel">
      <div id="welcome" class="row">
        <div style="flex:1">
          <label>Usuario autenticado:</label>
          <div id="user-info" class="small muted">No autenticado</div>
        </div>
        <div style="flex:0.4;display:flex;gap:8px;align-items:end">
          <button id="btn-signin">Iniciar Sesión</button>
          <button id="btn-signout" class="ghost hidden">Cerrar sesión</button>
        </div>
      </div>
    </div>

    <div id="app" class="hidden">
      <div class="card" id="main-panel">
        <div class="row">
          <div class="col" style="flex:0.6">
            <label>Buscar por nombre</label>
            <input id="search-name" type="text" placeholder="Escribe nombre...">
          </div>
          <div class="col" style="flex:0.6">
            <label>Buscar por número de cuenta</label>
            <input id="search-account" type="text" placeholder="1234567890">
          </div>
          <div style="flex:0.8">
            <label>Agregar nueva cuenta</label>
            <div style="display:flex;gap:8px">
              <input id="new-account-name" type="text" placeholder="Nombre">
              <input id="new-account-number" type="text" placeholder="Número de cuenta">
              <button id="add-account">Agregar</button>
            </div>
          </div>
          <div style="flex:0.3">
            <label>Opciones</label>
            <div style="display:flex;gap:8px">
              <button id="open-options">Opciones</button>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px">
          <div style="width:320px">
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <strong>Cuentas</strong>
                <span class="small" id="accounts-count">0</span>
              </div>
              <div class="account-list" id="accounts-list"></div>
            </div>
          </div>

          <div style="flex:1">
            <div class="card">
              <strong>Consignación - cuenta seleccionada</strong>
              <div id="selected-account-info" class="small muted">Ninguna cuenta seleccionada</div>
              <hr>
              <div class="row">
                <div class="col">
                  <label>FECHA (DD/MM/AAAA)</label>
                  <div style="display:flex;gap:8px;align-items:center">
                    <label><input type="radio" name="date-option" value="today"> Hoy</label>
                    <label><input type="radio" name="date-option" value="yesterday"> Ayer</label>
                    <label><input type="radio" name="date-option" value="daybefore"> Antier</label>
                    <input id="date-picker" type="date">
                  </div>
                </div>
                <div class="col">
                  <label>FECHA DE OBSERVACIÓN (DD/MM/AAAA)</label>
                  <div style="display:flex;gap:8px;align-items:center">
                    <label><input type="radio" name="obsdate-option" value="today"> Hoy</label>
                    <label><input type="radio" name="obsdate-option" value="yesterday"> Ayer</label>
                    <label><input type="radio" name="obsdate-option" value="daybefore"> Antier</label>
                    <input id="obsdate-picker" type="date">
                  </div>
                </div>
              </div>

              <div style="margin-top:8px">
                <label>OBSERVACIONES (texto)</label>
                <textarea id="observations" rows="2" placeholder="Observaciones..."></textarea>
              </div>

              <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                <div style="flex:1">
                  <label>VALOR (COP)</label>
                  <input id="valor" type="number" placeholder="0">
                </div>
                <div style="width:180px;align-self:flex-end">
                  <button id="add-consign">Agregar consignación</button>
                </div>
              </div>

            </div>

            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <strong>Lista de consignaciones</strong>
                <div class="controls">
                  <button id="btn-verify">Verificado (marcar)</button>
                  <button id="btn-unverify" class="ghost">Desverificar</button>
                  <button id="btn-delete" class="ghost hidden">Eliminar (Gerente)</button>
                  <button id="btn-cuadrar" class="ghost hidden">Cuadrar (Gerente)</button>
                </div>
              </div>
              <div style="margin-top:8px;overflow:auto;max-height:360px">
                <table id="consigns-table">
                  <thead>
                    <tr><th style="width:40px">Sel</th><th>FECHA</th><th>VALOR</th><th>OBSERVACION</th><th>ESTADO</th></tr>
                  </thead>
                  <tbody id="consigns-body">
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Login Modal -->
    <div id="modal-login" class="modal hidden">
      <div class="card">
        <h3>Iniciar sesión</h3>
        <div style="margin-top:8px">
          <label>Email</label>
          <input id="login-email" type="text">
        </div>
        <div style="margin-top:8px">
          <label>Contraseña</label>
          <input id="login-pass" type="password">
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <button id="login-submit">Entrar</button>
          <button id="login-cancel" class="ghost">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Options modal (shows role info) -->
    <div id="modal-options" class="modal hidden">
      <div class="card">
        <h3>Acceso y Opciones</h3>
        <div id="role-info" class="small muted">Cargando...</div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button id="close-options" class="ghost">Cerrar</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ------------------------------------------------
    // CONFIG: usar la configuración encontrada en tu archivo
    // (la extracción del archivo 'generar_pedidos (1).html').
    // ------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
      authDomain: "lazapateria-c4157.firebaseapp.com",
      projectId: "lazapateria-c4157",
      storageBucket: "lazapateria-c4157.firebasestorage.app",
      measurementId: "G-HVG7615JEE"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Estado
    let currentUser = null;
    let currentUserDoc = null; // documento de 'usuarios'
    let role = null; // 'Administrador' => gerente
    let selectedAccountId = null;

    // Elementos
    const $ = id => document.getElementById(id);

    // ----------------- Auth UI -----------------
    $('btn-signin').addEventListener('click', ()=>{ $('modal-login').classList.remove('hidden'); });
    $('login-cancel').addEventListener('click', ()=>{ $('modal-login').classList.add('hidden'); });
    $('login-submit').addEventListener('click', async ()=>{ const email=$('login-email').value.trim(); const pass=$('login-pass').value; if(!email||!pass){ alert('Email y contraseña son requeridos'); return } try{ await auth.signInWithEmailAndPassword(email,pass); $('modal-login').classList.add('hidden'); }catch(e){ alert('Error login: '+e.message) } });
    $('btn-signout').addEventListener('click', ()=>{ auth.signOut(); });

    // ----------------- On Auth State -----------------
    auth.onAuthStateChanged(async user =>{
      if(user){
        currentUser = user;
        $('user-info').textContent = user.email + ' (verificando rol...)';
        $('btn-signin').classList.add('hidden');
        $('btn-signout').classList.remove('hidden');
        // buscar doc de usuario en collection 'usuarios' (según tu archivo fuente)
        try{
          const docRef = db.collection('usuarios').doc(user.uid);
          const docSnap = await docRef.get();
          if(!docSnap.exists){
            alert('Usuario no registrado en colección usuarios. Acceso denegado.');
            await auth.signOut();
            return;
          }
          currentUserDoc = docSnap.data();
          role = currentUserDoc.permisos || currentUserDoc.role || 'Operador';
          $('user-info').textContent = user.email + ' — ' + role;

          // SOLO permitimos Administrador
          if(role.toLowerCase() !== 'administrador'){
            alert('Acceso denegado. Solo administradores pueden ingresar.');
            await auth.signOut();
            return;
          }

          // si pasa, mostrar app
          $('app').classList.remove('hidden');
          $('auth-panel').classList.add('hidden');
          initAppListeners();
          subscribeAccounts();
        }catch(err){ console.error(err); alert('Error comprobando rol: '+err.message); await auth.signOut(); }
      } else {
        // salir a estado no autenticado
        currentUser = null; currentUserDoc = null; role = null; selectedAccountId=null;
        $('user-info').textContent = 'No autenticado';
        $('btn-signin').classList.remove('hidden');
        $('btn-signout').classList.add('hidden');
        $('app').classList.add('hidden');
        $('auth-panel').classList.remove('hidden');
      }
    });

    // ----------------- Firestore: accounts & consigns -----------------
    function uid(prefix='id'){return prefix + '_' + Math.random().toString(36).slice(2,9)}
    function fmtDateISOToDDMMYYYY(iso){ if(!iso) return ''; const d=new Date(iso); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}` }

    // Real-time subscribe accounts list
    let accountsUnsub = null;
    function subscribeAccounts(){ if(accountsUnsub) accountsUnsub(); accountsUnsub = db.collection('cuentas').orderBy('name').onSnapshot(snapshot=>{
      const list = $('accounts-list'); list.innerHTML=''; snapshot.forEach(doc=>{ const a = { id: doc.id, ...doc.data() }; const div=document.createElement('div'); div.className='account-item'+(selectedAccountId===a.id? ' selected':''); div.innerHTML=`<strong>${a.name}</strong><div class="small">${a.number||''}</div>`; div.onclick=()=>{ selectedAccountId=a.id; renderSelectedAccount(); }; list.appendChild(div); }); $('accounts-count').textContent = snapshot.size; if(!selectedAccountId && snapshot.size>0){ const first = snapshot.docs[0].data(); selectedAccountId = snapshot.docs[0].id; renderSelectedAccount(); } }); }

    // Render consigns for selected account via real-time listener
    let consignsUnsub = null;
    function renderSelectedAccount(){ const info=$('selected-account-info'); if(!selectedAccountId){ info.textContent='Ninguna cuenta seleccionada'; $('consigns-body').innerHTML=''; return } db.collection('cuentas').doc(selectedAccountId).get().then(d=>{ const acc = d.data(); info.innerHTML = `<strong>${acc.name}</strong> — <span class="small">${acc.number||''}</span>`; subscribeConsigns(selectedAccountId); }); }

    function subscribeConsigns(accId){ if(consignsUnsub) consignsUnsub(); const tbody=$('consigns-body'); tbody.innerHTML=''; consignsUnsub = db.collection('cuentas').doc(accId).collection('consignaciones').orderBy('fecha','asc').onSnapshot(snapshot=>{
      tbody.innerHTML=''; snapshot.forEach(doc=>{ const c = doc.data(); const tr=document.createElement('tr'); if(c.isSeparator){ tr.className='separator'; tr.innerHTML=`<td></td><td colspan="3">--- CUADRE: ${c.label} — TOTAL HASTA AHÍ: ${new Intl.NumberFormat('es-CO').format(c.total)}</td><td></td>`; tbody.appendChild(tr); return } let stateText='Sin verificar'; if(c.verifiedBy){ stateText = c.verifiedRole==='Administrador' ? 'Verificado (Gerente)' : 'Verificado (Admin)'; tr.className = c.verifiedRole==='Administrador' ? 'verified-manager' : 'verified-admin' } tr.innerHTML = `
          <td><input type="checkbox" data-id="${doc.id}"></td>
          <td>${fmtDateISOToDDMMYYYY(c.fecha && c.fecha.toDate ? c.fecha.toDate().toISOString() : c.fecha)}<br><small class="small">ObsFecha: ${fmtDateISOToDDMMYYYY(c.obsdate && c.obsdate.toDate ? c.obsdate.toDate().toISOString() : c.obsdate)}</small></td>
          <td>${new Intl.NumberFormat('es-CO').format(c.valor||0)}</td>
          <td>${(c.observaciones||'')}</td>
          <td>${stateText}</td>
        `; tbody.appendChild(tr);
      }); }); }

    // ----------------- Actions -----------------
    function parseDateOption(name){const els=[...document.querySelectorAll(`input[name="${name}"]`)]; for(const e of els){ if(e.checked) return e.value } return null }

    $('add-account').addEventListener('click', async ()=>{
      const name = $('new-account-name').value.trim(); const number = $('new-account-number').value.trim(); if(!name||!number){ alert('Nombre y número requerido'); return }
      try{ await db.collection('cuentas').add({ name, number }); $('new-account-name').value=''; $('new-account-number').value=''; }catch(e){ alert('Error creando cuenta: '+e.message) }
    });

    $('search-name').addEventListener('input', (e)=>{ const q=e.target.value.toLowerCase(); Array.from(document.querySelectorAll('.account-item')).forEach(it=>{ it.style.display = it.textContent.toLowerCase().includes(q) ? '' : 'none' }) });
    $('search-account').addEventListener('input', (e)=>{ const q=e.target.value.toLowerCase(); Array.from(document.querySelectorAll('.account-item')).forEach(it=>{ it.style.display = it.textContent.toLowerCase().includes(q) ? '' : 'none' }) });

    $('add-consign').addEventListener('click', async ()=>{
      if(!selectedAccountId){ alert('Seleccione una cuenta'); return }
      // fecha
      let fecha=null; const dateOpt = parseDateOption('date-option'); if(dateOpt==='today') fecha=new Date(); else if(dateOpt==='yesterday'){ const d=new Date(); d.setDate(d.getDate()-1); fecha=d } else if(dateOpt==='daybefore'){ const d=new Date(); d.setDate(d.getDate()-2); fecha=d } else { const v=$('date-picker').value; if(v) fecha=new Date(v); }
      let obsdate=null; const od=parseDateOption('obsdate-option'); if(od==='today') obsdate=new Date(); else if(od==='yesterday'){ const d=new Date(); d.setDate(d.getDate()-1); obsdate=d } else if(od==='daybefore'){ const d=new Date(); d.setDate(d.getDate()-2); obsdate=d } else { const v=$('obsdate-picker').value; if(v) obsdate=new Date(v); }
      const observaciones = $('observations').value.trim(); const valor = Number($('valor').value) || 0; if(!fecha){ alert('Seleccione o indique una fecha válida'); return }
      const obj = { fecha: firebase.firestore.Timestamp.fromDate(fecha), obsdate: obsdate ? firebase.firestore.Timestamp.fromDate(obsdate) : null, observaciones, valor, verifiedBy:null, verifiedAt:null, verifiedRole:null }
      try{ await db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').add(obj); $('observations').value=''; $('valor').value=''; }catch(e){ alert('Error agregando consignación: '+e.message) }
    });

    function getSelectedConsignIds(){ return Array.from(document.querySelectorAll('#consigns-body input[type="checkbox"]')).filter(c=>c.checked).map(c=>c.dataset.id) }

    $('btn-verify').addEventListener('click', async ()=>{
      if(!selectedAccountId){ alert('Seleccione cuenta'); return }
      const ids = getSelectedConsignIds(); if(ids.length===0){ alert('Seleccione al menos una consignación'); return }
      const batch = db.batch(); const colRef = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones'); ids.forEach(id=>{ const ref = colRef.doc(id); batch.update(ref,{ verifiedBy: currentUser.uid, verifiedAt: firebase.firestore.FieldValue.serverTimestamp(), verifiedRole: 'Administrador' }); });
      try{ await batch.commit(); }catch(e){ alert('Error al verificar: '+e.message) }
    });

    $('btn-unverify').addEventListener('click', async ()=>{
      if(!selectedAccountId){ alert('Seleccione cuenta'); return }
      const ids = getSelectedConsignIds(); if(ids.length===0){ alert('Seleccione al menos una consignación'); return }
      const batch = db.batch(); const colRef = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones'); ids.forEach(id=>{ const ref = colRef.doc(id); batch.update(ref,{ verifiedBy: null, verifiedAt: null, verifiedRole: null }); });
      try{ await batch.commit(); }catch(e){ alert('Error al desverificar: '+e.message) }
    });

    $('btn-delete').addEventListener('click', async ()=>{
      // solo visible para admin
      if(role.toLowerCase()!=='administrador'){ alert('Solo administrador puede eliminar'); return }
      if(!selectedAccountId){ alert('Seleccione cuenta'); return }
      const ids = getSelectedConsignIds(); if(ids.length===0){ alert('Seleccione al menos una consignación'); return }
      if(!confirm('Eliminar '+ids.length+' consignación(es)?')) return;
      const batch = db.batch(); const colRef = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones'); ids.forEach(id=>{ batch.delete(colRef.doc(id)); });
      try{ await batch.commit(); }catch(e){ alert('Error al eliminar: '+e.message) }
    });

    $('btn-cuadrar').addEventListener('click', async ()=>{
      if(role.toLowerCase()!=='administrador'){ alert('Solo administrador puede cuadrar'); return }
      if(!selectedAccountId){ alert('Seleccione cuenta'); return }
      // sumar todas las consignaciones que no sean separators
      const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
      const snap = await col.get(); let total=0; snap.forEach(d=>{ const data=d.data(); if(!data.isSeparator) total += Number(data.valor||0); });
      const sep = { isSeparator:true, label: new Date().toLocaleString(), total }; try{ await col.add(sep); }catch(e){ alert('Error al cuadrar: '+e.message) }
    });

    // UI: open options modal
    $('open-options').addEventListener('click', ()=>{ $('modal-options').classList.remove('hidden'); $('role-info').textContent = `Usuario: ${currentUser.email} — Rol: ${role}`; if(role.toLowerCase()==='administrador'){ $('btn-delete').classList.remove('hidden'); $('btn-cuadrar').classList.remove('hidden'); } else { $('btn-delete').classList.add('hidden'); $('btn-cuadrar').classList.add('hidden'); } });
    $('close-options').addEventListener('click', ()=>{ $('modal-options').classList.add('hidden'); });

    function initAppListeners(){ /* reserved for any extra listeners */ }

    // Initialize: render nothing until auth
    // but expose a manual function to subscribe accounts after auth

    // Helper: in case we need to programmatically subscribe after successful auth
    async function subscribeAccountsIfNeeded(){ if(currentUser){ subscribeAccounts(); } }

    // Ensure sign-in modal appears if user clicks sign-in and if auth state is null user can log in.

    // Before unload, clean listeners
    window.addEventListener('beforeunload', ()=>{ if(accountsUnsub) accountsUnsub(); if(consignsUnsub) consignsUnsub(); });

    // Small convenience: if developer wants to auto-login for testing, uncomment below and put a test account
    // auth.signInWithEmailAndPassword('test@example.com','password123')
  </script>
</body>
</html>
