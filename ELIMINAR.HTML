<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novedades - La Zapatería</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #0d6efd;
            --primary-dark: #0b5ed7;
            --bg: #f8f9fa;
            --card: #ffffff;
            --border: #dee2e6;
            --text: #212529;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--card);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            width: 95%;
            max-width: 1200px;
            box-sizing: border-box;
            border: 1px solid var(--border);
        }

        h2 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 20px;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f1f3f5;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: var(--primary-dark);
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .filters {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .table-container {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2><i class="fas fa-clipboard-list"></i> Novedades reportadas</h2>
        
        <div id="messageContainer"></div>
        
        <div class="filters">
            <div class="filter-group">
                <label for="fechaDesde">Desde:</label>
                <input type="date" id="fechaDesde">
            </div>
            <div class="filter-group">
                <label for="fechaHasta">Hasta:</label>
                <input type="date" id="fechaHasta">
            </div>
            <div class="filter-group">
                <label for="estadoFiltro">Estado:</label>
                <select id="estadoFiltro">
                    <option value="">Todas</option>
                    <option value="pendiente" selected>Pendientes</option>
                    <option value="resuelta">Resueltas</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="busqueda">Buscar (código/cliente/asesor/texto):</label>
                <input type="text" id="busqueda" placeholder="Escribe para buscar...">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button onclick="cargarNovedades()">Buscar</button>
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button onclick="limpiarFiltros()" class="btn-secondary">Limpiar</button>
            </div>
        </div>

        <div class="actions">
            <button onclick="exportarExcel()" class="btn-success">
                <i class="fas fa-file-excel"></i> Exportar Excel (novedades)
            </button>
            <button onclick="cargarNovedades()" class="btn-secondary">Recargar</button>
            <button onclick="seleccionarTodos()" id="btnSeleccionarTodos">Seleccionar Todos</button>
            <button onclick="deseleccionarTodos()" id="btnDeseleccionarTodos">Deseleccionar Todos</button>
            <button onclick="eliminarSeleccionados()" id="btnEliminar" disabled>
                <i class="fas fa-trash"></i> Eliminar seleccionadas (<span id="contadorSeleccion">0</span>)
            </button>
        </div>

        <div class="table-container">
            <table id="tablaReferencias">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>Estado</th>
                        <th>Código</th>
                        <th>Cliente</th>
                        <th>Asesor</th>
                        <th>Fecha reporte</th>
                        <th>Descripción</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="tablaBody">
                    <tr>
                        <td colspan="8" class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Cargando novedades...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <button onclick="paginaAnterior()" id="btnAnterior" disabled>Anterior</button>
            <span class="pagination-info">
                Página <span id="paginaActual">1</span> de <span id="totalPaginas">1</span>
                (<span id="totalRegistros">0</span> registros)
            </span>
            <button onclick="paginaSiguiente()" id="btnSiguiente" disabled>Siguiente</button>
        </div>
    </div>

    <div id="detalleModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; padding:20px; z-index:9999;">
        <div style="background:#fff; width:100%; max-width:760px; border-radius:12px; border:1px solid var(--border); box-shadow:0 10px 40px rgba(0,0,0,0.18); overflow:hidden;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border);">
                <h3 style="margin:0; font-size:16px;">Detalle de novedad</h3>
                <button type="button" onclick="cerrarDetalle()" style="border:0; background:transparent; font-size:20px; cursor:pointer; padding:4px 10px;">×</button>
            </div>
            <div style="padding:14px 16px;" id="detalleBody"></div>
            <div style="padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end;">
                <button type="button" onclick="cerrarDetalle()" class="btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="editModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; padding:20px; z-index:10000;">
        <div style="background:#fff; width:100%; max-width:760px; border-radius:12px; border:1px solid var(--border); box-shadow:0 10px 40px rgba(0,0,0,0.18); overflow:hidden;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border);">
                <h3 style="margin:0; font-size:16px;">Editar novedad</h3>
                <button type="button" onclick="cerrarEditar()" style="border:0; background:transparent; font-size:20px; cursor:pointer; padding:4px 10px;">×</button>
            </div>
            <div style="padding:14px 16px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div>
                        <label style="font-weight:800; color:#495057;">Código</label>
                        <input id="editCodigo" type="text" style="width:100%; padding:8px 12px; border:1px solid #ced4da; border-radius:4px;" />
                    </div>
                    <div>
                        <label style="font-weight:800; color:#495057;">Asesor</label>
                        <input id="editAsesor" type="text" style="width:100%; padding:8px 12px; border:1px solid #ced4da; border-radius:4px;" />
                    </div>
                    <div style="grid-column:1 / -1;">
                        <label style="font-weight:800; color:#495057;">Cliente</label>
                        <input id="editCliente" type="text" style="width:100%; padding:8px 12px; border:1px solid #ced4da; border-radius:4px;" />
                    </div>
                    <div style="grid-column:1 / -1;">
                        <label style="font-weight:800; color:#495057;">Descripción</label>
                        <textarea id="editDesc" rows="4" style="width:100%; padding:8px 12px; border:1px solid #ced4da; border-radius:4px;"></textarea>
                    </div>
                    <div>
                        <label style="font-weight:800; color:#495057;">Valor flete</label>
                        <input id="editFleteValor" type="number" min="0" step="1" style="width:100%; padding:8px 12px; border:1px solid #ced4da; border-radius:4px;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:10px; padding-top:22px;">
                        <label style="display:flex; align-items:center; gap:10px; font-weight:800; color:#495057;">
                            <input id="editFletePendiente" type="checkbox" />
                            Flete pendiente (valor por definir)
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; font-weight:800; color:#495057;">
                            <input id="editFletePagado" type="checkbox" />
                            Flete pagado
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; font-weight:800; color:#495057;">
                            <input id="editResuelta" type="checkbox" />
                            Resuelta
                        </label>
                    </div>
                </div>
            </div>
            <div style="padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px;">
                <button type="button" onclick="cerrarEditar()" class="btn-secondary">Cancelar</button>
                <button type="button" onclick="guardarEdicion()" class="btn-success"><i class="fas fa-save"></i> Guardar cambios</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBz_sHLN3RjYtKJZC5d7O8dQn9QvLzWqE",
            authDomain: "lazapateria-c4157.firebaseapp.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.appspot.com",
            messagingSenderId: "10387654321",
            appId: "1:10387654321:web:abc123def456"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variables globales
        let todasLasReferencias = [];
        let referenciasFiltradas = [];
        let paginaActual = 1;
        const registrosPorPagina = 50;
        let seleccionados = new Set();

        // Inicialización
        document.addEventListener('DOMContentLoaded', async () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const iso = `${yyyy}-${mm}-${dd}`;
            document.getElementById('fechaHasta').value = iso;
            document.getElementById('fechaDesde').value = '2024-01-01';

            ['fechaDesde', 'fechaHasta', 'estadoFiltro'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', () => { aplicarFiltros(); });
            });
            const busq = document.getElementById('busqueda');
            if (busq) busq.addEventListener('input', () => { aplicarFiltros(); });

            await cargarNovedades();
        });

        function tsToDate(ts) {
            if (!ts) return null;
            if (ts instanceof Date && !Number.isNaN(ts.getTime())) return ts;
            if (typeof ts.toDate === 'function') return ts.toDate();
            const d = new Date(ts);
            return Number.isNaN(d.getTime()) ? null : d;
        }

        function formatDateTime(ts) {
            const d = tsToDate(ts);
            if (!d) return '';
            return d.toLocaleString('es-CO', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        async function cargarNovedades() {
            const desde = document.getElementById('fechaDesde').value;
            const hasta = document.getElementById('fechaHasta').value;
            if (!desde || !hasta) {
                mostrarError('Selecciona Desde y Hasta.');
                return;
            }
            const from = new Date(desde + 'T00:00:00');
            const to = new Date(hasta + 'T23:59:59');
            if (Number.isNaN(from.getTime()) || Number.isNaN(to.getTime()) || from > to) {
                mostrarError('Rango de fechas inválido.');
                return;
            }

            try {
                mostrarLoading();
                todasLasReferencias = [];

                const fromTs = firebase.firestore.Timestamp.fromDate(from);
                const toTs = firebase.firestore.Timestamp.fromDate(to);

                const LIMIT = 600;

                const qCreatedAt = db.collection('novedades')
                    .orderBy('createdAt', 'desc')
                    .where('createdAt', '>=', fromTs)
                    .where('createdAt', '<=', toTs)
                    .limit(LIMIT);

                const qRegistroFecha = db.collection('novedades')
                    .orderBy('registroFecha', 'desc')
                    .where('registroFecha', '>=', fromTs)
                    .where('registroFecha', '<=', toTs)
                    .limit(LIMIT);

                const [snap1, snap2] = await Promise.all([
                    qCreatedAt.get().catch(() => ({ forEach: () => { } })),
                    qRegistroFecha.get().catch(() => ({ forEach: () => { } }))
                ]);

                const byId = new Map();
                snap1.forEach(doc => {
                    const d = doc.data() || {};
                    d.id = doc.id;
                    byId.set(doc.id, d);
                });
                snap2.forEach(doc => {
                    const d = doc.data() || {};
                    d.id = doc.id;
                    byId.set(doc.id, d);
                });

                todasLasReferencias = Array.from(byId.values());

                aplicarFiltros();
                mostrarExito('Novedades cargadas: ' + todasLasReferencias.length);
            } catch (error) {
                console.error('Error cargando novedades:', error);
                mostrarError('Error cargando novedades: ' + error.message);
            }
        }

        // Aplicar filtros
        function aplicarFiltros() {
            const fechaDesde = document.getElementById('fechaDesde').value;
            const fechaHasta = document.getElementById('fechaHasta').value;
            const estado = document.getElementById('estadoFiltro').value;
            const q = String(document.getElementById('busqueda').value || '').trim().toLowerCase();

            referenciasFiltradas = todasLasReferencias.filter(n => {
                const d = tsToDate(n.createdAt);
                if (!d) return false;
                if (fechaDesde) {
                    const fd = new Date(fechaDesde + 'T00:00:00');
                    if (d < fd) return false;
                }
                if (fechaHasta) {
                    const fh = new Date(fechaHasta + 'T23:59:59');
                    if (d > fh) return false;
                }

                if (estado === 'pendiente' && n.resuelta === true) return false;
                if (estado === 'resuelta' && n.resuelta !== true) return false;

                if (q) {
                    const blob = [
                        n.codigo_unico,
                        n.registroId,
                        n.cliente,
                        n.asesor,
                        n.asesorUserId,
                        n.descripcion,
                        n.assignedBodegueroNombre,
                        n.assignedBodegueroUserId,
                        n.createdByNombre,
                        n.createdByUserId
                    ].map(x => String(x || '')).join(' ').toLowerCase();
                    if (!blob.includes(q)) return false;
                }
                return true;
            });
            
            paginaActual = 1;
            renderTabla();
            actualizarPaginacion();
        }

        // Limpiar filtros
        function limpiarFiltros() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const iso = `${yyyy}-${mm}-${dd}`;
            document.getElementById('fechaHasta').value = iso;
            document.getElementById('fechaDesde').value = iso;
            document.getElementById('estadoFiltro').value = 'pendiente';
            document.getElementById('busqueda').value = '';
            aplicarFiltros();
        }

        // Renderizar tabla
        function renderTabla() {
            const tbody = document.getElementById('tablaBody');
            const inicio = (paginaActual - 1) * registrosPorPagina;
            const fin = inicio + registrosPorPagina;
            const pagina = referenciasFiltradas.slice(inicio, fin);
            
            if (pagina.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No hay novedades con los filtros actuales.</td></tr>';
                return;
            }
            
            tbody.innerHTML = pagina.map(n => {
                const estado = n.resuelta === true
                    ? '<span style="display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; background:#d4edda; color:#155724; border:1px solid #c3e6cb;">RESUELTA</span>'
                    : '<span style="display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; background:#fff3cd; color:#856404; border:1px solid #ffeeba;">PENDIENTE</span>';
                const code = escapeHtml(n.codigo_unico || n.registroId || '—');
                const cliente = escapeHtml(n.cliente || '—');
                const asesor = escapeHtml(n.asesor || '—');
                const fecha = escapeHtml(formatDateTime(n.createdAt));
                const desc = escapeHtml(n.descripcion || '—');
                const id = escapeHtml(n.id || '');
                return `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" value="${id}" ${seleccionados.has(id) ? 'checked' : ''} onchange="toggleSeleccion('${id}')">
                        </td>
                        <td>${estado}</td>
                        <td style="font-family: monospace; font-weight: 800;">${code}</td>
                        <td>${cliente}</td>
                        <td>${asesor}</td>
                        <td class="date-cell">${fecha}</td>
                        <td>${desc}</td>
                        <td>
                            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start;">
                                <button type="button" class="btn-secondary" onclick="verDetalle('${id}')">Ver</button>
                                <button type="button" class="btn-success" onclick="abrirEditar('${id}')"><i class="fas fa-pen"></i> Editar</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            actualizarContadorSeleccion();
        }

        // Actualizar paginación
        function actualizarPaginacion() {
            const totalPaginas = Math.max(1, Math.ceil(referenciasFiltradas.length / registrosPorPagina));
            
            document.getElementById('paginaActual').textContent = paginaActual;
            document.getElementById('totalPaginas').textContent = totalPaginas;
            document.getElementById('totalRegistros').textContent = referenciasFiltradas.length;
            
            document.getElementById('btnAnterior').disabled = paginaActual === 1;
            document.getElementById('btnSiguiente').disabled = paginaActual === totalPaginas;
        }

        // Navegación de paginación
        function paginaAnterior() {
            if (paginaActual > 1) {
                paginaActual--;
                renderTabla();
                actualizarPaginacion();
            }
        }

        function paginaSiguiente() {
            const totalPaginas = Math.ceil(referenciasFiltradas.length / registrosPorPagina);
            if (paginaActual < totalPaginas) {
                paginaActual++;
                renderTabla();
                actualizarPaginacion();
            }
        }

        // Selección
        function toggleSeleccion(id) {
            if (!id) return;
            if (seleccionados.has(id)) {
                seleccionados.delete(id);
            } else {
                seleccionados.add(id);
            }
            actualizarContadorSeleccion();
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#tablaBody input[type="checkbox"]');

            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const id = cb.value;
                if (checkbox.checked) {
                    seleccionados.add(id);
                } else {
                    seleccionados.delete(id);
                }
            });

            actualizarContadorSeleccion();
        }

        function seleccionarTodos() {
            referenciasFiltradas.forEach(n => {
                if (n && n.id) seleccionados.add(String(n.id));
            });
            renderTabla();
            actualizarContadorSeleccion();
        }

        function deseleccionarTodos() {
            seleccionados.clear();
            renderTabla();
            actualizarContadorSeleccion();
        }

        function actualizarContadorSeleccion() {
            document.getElementById('contadorSeleccion').textContent = seleccionados.size;
            document.getElementById('btnEliminar').disabled = seleccionados.size === 0;
            document.getElementById('selectAll').checked = false;
        }

        // Eliminar novedades seleccionadas
        async function eliminarSeleccionados() {
            if (seleccionados.size === 0) return;
            
            const confirmar = confirm(`¿Estás seguro de eliminar ${seleccionados.size} novedad(es)? Esta acción no se puede deshacer.`);
            if (!confirmar) return;
            
            try {
                mostrarLoading();
                
                const batch = db.batch();
                let count = 0;

                for (const id of Array.from(seleccionados)) {
                    if (!id) continue;
                    batch.delete(db.collection('novedades').doc(String(id)));
                    count++;
                }

                await batch.commit();

                seleccionados.clear();
                mostrarExito(`Se eliminaron ${count} novedad(es) correctamente.`);
                await cargarNovedades();
                
            } catch (error) {
                console.error('Error eliminando referencias:', error);
                mostrarError('Error eliminando referencias: ' + error.message);
            }
        }

        // Exportar a Excel
        function exportarExcel() {
            if (referenciasFiltradas.length === 0) {
                mostrarError('No hay datos para exportar.');
                return;
            }
            
            const datos = referenciasFiltradas.map(n => ({
                'Estado': n.resuelta === true ? 'RESUELTA' : 'PENDIENTE',
                'Código': n.codigo_unico || n.registroId || '',
                'Cliente': n.cliente || '',
                'Asesor': n.asesor || '',
                'AsesorUserId': n.asesorUserId || '',
                'Fecha reporte': formatDateTime(n.createdAt),
                'Fecha pedido': formatDateTime(n.registroFecha),
                'Asignado': n.assignedBodegueroNombre || n.assignedBodegueroUserId || '',
                'Descripción': n.descripcion || '',
                'Flete valor': Number(n.fleteValor || 0),
                'Flete pendiente': n.fletePendiente === true ? 'SI' : 'NO',
                'Flete pagado': n.fletePagado === true ? 'SI' : 'NO',
                'Creado por': n.createdByNombre || n.createdByUserId || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Novedades');
            XLSX.writeFile(wb, `novedades_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function verDetalle(id) {
            const n = todasLasReferencias.find(x => String(x.id) === String(id));
            if (!n) {
                mostrarError('No se encontró el registro.');
                return;
            }
            const el = document.getElementById('detalleBody');
            const rows = [
                ['Cliente', n.cliente || ''],
                ['Estado', n.resuelta === true ? 'RESUELTA' : 'PENDIENTE'],
                ['Código', n.codigo_unico || n.registroId || ''],
                ['Asesor', n.asesor || ''],
                ['AsesorUserId', n.asesorUserId || ''],
                ['Fecha pedido', formatDateTime(n.registroFecha)],
                ['Fecha reporte', formatDateTime(n.createdAt)],
                ['Asignado', n.assignedBodegueroNombre || n.assignedBodegueroUserId || ''],
                ['Descripción', n.descripcion || ''],
                ['Flete valor', formatValor(n.fleteValor || 0)],
                ['Flete pendiente', n.fletePendiente === true ? 'SI' : 'NO'],
                ['Flete pagado', n.fletePagado === true ? 'SI' : 'NO'],
                ['Creado por', n.createdByNombre || n.createdByUserId || '']
            ];
            el.innerHTML = '<div style="display:grid; grid-template-columns: 180px 1fr; gap:10px 12px;">' + rows.map(r => {
                return `<div style="color:#6c757d; font-weight:800;">${escapeHtml(r[0])}</div><div style="font-weight:700;">${escapeHtml(r[1])}</div>`;
            }).join('') + '</div>';
            const m = document.getElementById('detalleModal');
            m.style.display = 'flex';
        }

        function cerrarDetalle() {
            const m = document.getElementById('detalleModal');
            m.style.display = 'none';
        }

        let editingId = null;

        function abrirEditar(id) {
            const n = todasLasReferencias.find(x => String(x.id) === String(id));
            if (!n) {
                mostrarError('No se encontró el registro para editar.');
                return;
            }
            editingId = String(id);
            document.getElementById('editCodigo').value = String(n.codigo_unico || n.registroId || '');
            document.getElementById('editAsesor').value = String(n.asesor || '');
            document.getElementById('editCliente').value = String(n.cliente || '');
            document.getElementById('editDesc').value = String(n.descripcion || '');

            const fletePendiente = n.fletePendiente === true;
            const fleteValor = Number(n.fleteValor || 0);
            const fletePagado = n.fletePagado === true;
            const resuelta = n.resuelta === true;

            document.getElementById('editFletePendiente').checked = fletePendiente;
            document.getElementById('editFleteValor').value = fletePendiente ? '' : (Number.isFinite(fleteValor) && fleteValor > 0 ? String(fleteValor) : '0');
            document.getElementById('editFletePagado').checked = (!fletePendiente && fletePagado);
            document.getElementById('editResuelta').checked = resuelta;

            syncEditFleteControls();
            const m = document.getElementById('editModal');
            m.style.display = 'flex';
        }

        function cerrarEditar() {
            const m = document.getElementById('editModal');
            m.style.display = 'none';
            editingId = null;
        }

        function syncEditFleteControls() {
            const pend = document.getElementById('editFletePendiente').checked === true;
            const fleteEl = document.getElementById('editFleteValor');
            const pagadoEl = document.getElementById('editFletePagado');
            const resueltaEl = document.getElementById('editResuelta');

            if (pend) {
                fleteEl.value = '';
                fleteEl.disabled = true;
                pagadoEl.checked = false;
                pagadoEl.disabled = true;
            } else {
                fleteEl.disabled = false;
                pagadoEl.disabled = false;
            }

            const flete = pend ? 0 : Number(fleteEl.value || 0);
            const requiresPago = Number.isFinite(flete) && flete > 0;
            if (requiresPago && pagadoEl.checked !== true) {
                resueltaEl.checked = false;
                resueltaEl.disabled = true;
            } else {
                resueltaEl.disabled = false;
            }
        }

        document.getElementById('editFletePendiente').addEventListener('change', syncEditFleteControls);
        document.getElementById('editFletePagado').addEventListener('change', syncEditFleteControls);
        document.getElementById('editFleteValor').addEventListener('input', syncEditFleteControls);

        async function guardarEdicion() {
            if (!editingId) return;

            const codigo = String(document.getElementById('editCodigo').value || '').trim();
            const asesor = String(document.getElementById('editAsesor').value || '').trim();
            const cliente = String(document.getElementById('editCliente').value || '').trim();
            const descripcion = String(document.getElementById('editDesc').value || '').trim();

            const fletePendiente = document.getElementById('editFletePendiente').checked === true;
            const fleteRaw = fletePendiente ? 0 : Number(document.getElementById('editFleteValor').value || 0);
            if (!Number.isFinite(fleteRaw) || fleteRaw < 0) {
                mostrarError('Valor de flete inválido.');
                return;
            }
            const fleteValor = fletePendiente ? 0 : fleteRaw;

            const requiresPago = !fletePendiente && Number.isFinite(fleteValor) && fleteValor > 0;
            const fletePagado = requiresPago ? (document.getElementById('editFletePagado').checked === true) : false;
            const resuelta = document.getElementById('editResuelta').checked === true;

            if (resuelta && requiresPago && !fletePagado) {
                mostrarError('Para marcar como resuelta, primero debes marcar el flete como pagado.');
                return;
            }

            try {
                const now = firebase.firestore.Timestamp.fromDate(new Date());
                const update = {
                    codigo_unico: codigo,
                    asesor: asesor,
                    cliente: cliente,
                    descripcion: descripcion,
                    fletePendiente: fletePendiente,
                    fleteValor: fleteValor,
                    fletePagado: fletePagado,
                    resuelta: resuelta,
                    updatedAt: now
                };

                await db.collection('novedades').doc(editingId).update(update);

                const idx = todasLasReferencias.findIndex(x => String(x.id) === String(editingId));
                if (idx >= 0) {
                    todasLasReferencias[idx] = Object.assign({}, todasLasReferencias[idx], update);
                }

                cerrarEditar();
                aplicarFiltros();
                mostrarExito('Novedad actualizada correctamente.');
            } catch (e) {
                console.error('Error actualizando novedad:', e);
                mostrarError('Error actualizando novedad: ' + (e && e.message ? e.message : String(e)));
            }
        }

        // Utilidades
        function formatFecha(fecha) {
            if (!fecha) return '';
            const date = fecha.toDate ? fecha.toDate() : new Date(fecha);
            return date.toLocaleDateString('es-CO', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function formatValor(valor) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP'
            }).format(valor || 0);
        }

        function mostrarLoading() {
            document.getElementById('tablaBody').innerHTML = `
                <tr>
                    <td colspan="8" class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Cargando...
                    </td>
                </tr>
            `;
        }

        function mostrarError(mensaje) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="error">${mensaje}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function mostrarExito(mensaje) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="success">${mensaje}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>
</body>
</html>
