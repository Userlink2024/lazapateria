<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración de Citas - La Zapatería</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 15px rgba(0,0,0,0.1); /* shadow-xl */
            width: 90%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280; /* gray-500 */
        }
        select option:disabled {
            color: #cccccc;
            background-color: #f0f0f0;
        }
        /* Custom styles for multi-select date filter */
        #filterFecha {
            height: 100px; /* Adjust height as needed */
            overflow-y: auto;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen py-10 px-4 sm:px-6 lg:px-8">

    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mb-8">
        <h1 class="text-3xl font-bold text-center text-green-600 mb-8">Panel de Administración de Citas</h1>
        <p class="text-center text-gray-600 mb-6">Gestiona las citas agendadas para el Show Room de La Zapatería.</p>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded-lg shadow-md">
                <thead class="bg-green-600 text-white">
                    <tr>
                        <th class="py-3 px-4 text-left text-sm font-semibold rounded-tl-lg">Fabricante</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">Teléfono</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">Fecha</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">Hora</th>
                        <th class="py-3 px-4 text-center text-sm font-semibold rounded-tr-lg">Acciones</th>
                    </tr>
                    <tr class="bg-green-700">
                        <th class="py-2 px-4">
                            <input type="text" id="filterFabricante" placeholder="Filtrar fabricante..."
                                   class="w-full text-sm text-gray-900 px-2 py-1 rounded-md bg-white border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="py-2 px-4">
                            <input type="text" id="filterTelefono" placeholder="Filtrar teléfono..."
                                   class="w-full text-sm text-gray-900 px-2 py-1 rounded-md bg-white border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="py-2 px-4">
                            <select id="filterFecha" multiple size="4"
                                    class="w-full text-sm text-gray-900 px-2 py-1 rounded-md bg-white border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                </select>
                        </th>
                        <th class="py-2 px-4">
                            <select id="filterHora"
                                    class="w-full text-sm text-gray-900 px-2 py-1 rounded-md bg-white border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todas las horas</option>
                                </select>
                        </th>
                        <th class="py-2 px-4 text-center">
                            <button id="clearFiltersButton" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded-md">
                                Limpiar Filtros
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody id="citasTableBody" class="divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="text-center py-4 text-gray-500">Cargando citas...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="editModal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeEditModal()">&times;</button>
            <h2 class="text-2xl font-bold text-green-600 mb-6">Editar Cita</h2>
            <form id="editCitaForm" class="space-y-4">
                <input type="hidden" id="editCitaId">
                <div>
                    <label for="editFabricante" class="block text-sm font-medium text-gray-700 text-left mb-1">Fabricante:</label>
                    <input type="text" id="editFabricante" name="fabricante" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>
                <div>
                    <label for="editTelefono" class="block text-sm font-medium text-gray-700 text-left mb-1">Teléfono:</label>
                    <input type="tel" id="editTelefono" name="telefono" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>
                <div>
                    <label for="editDia" class="block text-sm font-medium text-gray-700 text-left mb-1">Día:</label>
                    <select id="editDia" name="dia" required
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                        </select>
                </div>
                <div>
                    <label for="editHora" class="block text-sm font-medium text-gray-700 text-left mb-1">Hora:</label>
                    <select id="editHora" name="hora" required
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                        </select>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditModal()"
                            class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeDeleteConfirmModal()">&times;</button>
            <h2 class="text-2xl font-bold text-red-600 mb-6">Confirmar Eliminación</h2>
            <p class="text-lg mb-6">¿Está seguro de que desea eliminar esta cita?</p>
            <div class="flex justify-center space-x-4">
                <button type="button" onclick="closeDeleteConfirmModal()"
                        class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancelar
                </button>
                <button type="button" id="confirmDeleteButton"
                        class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <div id="feedbackModal" class="modal" style="display: none;">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg mb-4"></p>
            <div class="modal-buttons">
                <button id="modalOkButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
            authDomain: "lazapateria-c4157.firebaseapp.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.firebasestorage.app",
            messagingSenderId: "300241769138",
            appId: "1:300241769138:web:8ca1847de3c4fb5042afab",
            measurementId: "G-HVG7615JEE"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const citasCollection = db.collection('citasShowroom');

        // --- Definición de Días y Horarios ---
        const currentYear = new Date().getFullYear();
        const yearForEvent = (new Date().getMonth() > 6 || (new Date().getMonth() === 6 && new Date().getDate() > 19)) ? currentYear + 1 : currentYear;

        const diasDisponibles = [
            { value: `${yearForEvent}-07-16`, text: `16 de Julio de ${yearForEvent} (Miércoles)` },
            { value: `${yearForEvent}-07-17`, text: `17 de Julio de ${yearForEvent} (Jueves)` },
            { value: `${yearForEvent}-07-18`, text: `18 de Julio de ${yearForEvent} (Viernes)` },
            { value: `${yearForEvent}-07-19`, text: `19 de Julio de ${yearForEvent} (Sábado)` }
        ];

        const todosLosHorarios = {
            morning: ["08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30"],
            afternoon: ["14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30"]
        };

        // --- Elementos del DOM ---
        const citasTableBody = document.getElementById('citasTableBody');
        const editModal = document.getElementById('editModal');
        const editCitaForm = document.getElementById('editCitaForm');
        const editCitaId = document.getElementById('editCitaId');
        const editFabricante = document.getElementById('editFabricante');
        const editTelefono = document.getElementById('editTelefono');
        const editDia = document.getElementById('editDia');
        const editHora = document.getElementById('editHora');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const feedbackModal = document.getElementById('feedbackModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalOkButton = document.getElementById('modalOkButton');

        // Elementos de Filtro
        const filterFabricante = document.getElementById('filterFabricante');
        const filterTelefono = document.getElementById('filterTelefono');
        const filterFecha = document.getElementById('filterFecha');
        const filterHora = document.getElementById('filterHora');
        const clearFiltersButton = document.getElementById('clearFiltersButton');

        let citaToDeleteId = null; // Variable para almacenar el ID de la cita a eliminar
        let allCitasData = []; // Almacena todas las citas sin filtrar

        // --- Funciones de Utilidad ---

        // Convertir hora de formato 24h a 12h (AM/PM)
        function convertTo12HourFormat(time24) {
            if (!time24) return "";
            const [hours, minutes] = time24.split(':');
            let h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12;
            return `${h}:${minutes} ${ampm}`;
        }

        // Obtener horarios para un día específico (en formato 24h)
        function obtenerHorariosParaDia(fechaValue) {
            if (fechaValue === `${yearForEvent}-07-19`) { // Sábado 19 de julio
                return todosLosHorarios.morning;
            }
            return [...todosLosHorarios.morning, ...todosLosHorarios.afternoon];
        }

        // Mostrar modal de feedback
        function mostrarFeedback(message, isError = false) {
            modalMessage.textContent = message;
            modalMessage.className = isError ? 'text-lg mb-4 text-red-600' : 'text-lg mb-4 text-green-700';
            feedbackModal.style.display = 'flex'; // Usar flex para centrar
        }

        // Cerrar modal de feedback
        modalOkButton.onclick = function() {
            feedbackModal.style.display = "none";
        }

        // --- Funciones para Modales ---

        function openEditModal(cita) {
            editCitaId.value = cita.id;
            editFabricante.value = cita.fabricante;
            editTelefono.value = cita.telefono;

            // Poblar días en el modal de edición
            editDia.innerHTML = '<option value="" disabled>Seleccione un día</option>';
            diasDisponibles.forEach(dia => {
                const option = document.createElement('option');
                option.value = dia.value;
                option.textContent = dia.text;
                editDia.appendChild(option);
            });
            editDia.value = cita.fecha; // Seleccionar el día actual de la cita

            // Actualizar horas al cambiar el día en el modal de edición
            editDia.onchange = async function() {
                await updateEditModalHours(editDia.value, cita.id);
            };

            // Cargar las horas para el día seleccionado, marcando las ocupadas
            updateEditModalHours(cita.fecha, cita.id, cita.hora);
            
            editModal.style.display = 'flex'; // Usar flex para centrar
        }

        async function updateEditModalHours(fechaSeleccionada, currentCitaId, selectedHora = null) {
            editHora.innerHTML = '<option value="" disabled selected>Seleccione una hora</option>';
            try {
                const querySnapshot = await citasCollection.where('fecha', '==', fechaSeleccionada).get();
                const horariosOcupados = querySnapshot.docs
                    .filter(doc => doc.id !== currentCitaId) // Excluir la cita actual que estamos editando
                    .map(doc => doc.data().hora);
                
                const horariosBase = obtenerHorariosParaDia(fechaSeleccionada);
                
                horariosBase.forEach(hora24 => {
                    const option = document.createElement('option');
                    option.value = hora24;
                    option.textContent = convertTo12HourFormat(hora24);
                    if (horariosOcupados.includes(hora24)) {
                        option.disabled = true;
                        option.textContent += ' (Ocupado)';
                    }
                    editHora.appendChild(option);
                });
                if (selectedHora && !horariosOcupados.includes(selectedHora)) {
                    editHora.value = selectedHora; // Seleccionar la hora actual de la cita si no está ocupada por otra
                } else if (selectedHora && horariosOcupados.includes(selectedHora) && editCitaId.value === currentCitaId) {
                     // Si la hora actual está ocupada por ESTA cita, mantenerla seleccionada y habilitada.
                     const currentOption = Array.from(editHora.options).find(opt => opt.value === selectedHora);
                     if (currentOption) {
                         currentOption.disabled = false;
                         editHora.value = selectedHora;
                     }
                }
            } catch (error) {
                console.error("Error actualizando horarios del modal de edición: ", error);
                mostrarFeedback("Error al cargar horarios para edición.", true);
            }
        }


        function closeEditModal() {
            editModal.style.display = 'none';
            editCitaForm.reset();
        }

        function openDeleteConfirmModal(citaId) {
            citaToDeleteId = citaId;
            deleteConfirmModal.style.display = 'flex'; // Usar flex para centrar
        }

        function closeDeleteConfirmModal() {
            citaToDeleteId = null;
            deleteConfirmModal.style.display = 'none';
        }

        // --- Lógica de Filtros ---
        function applyFilters() {
            let filteredCitas = [...allCitasData]; // Trabajar sobre una copia de los datos originales

            const filterFabricanteVal = filterFabricante.value.toLowerCase().trim();
            const filterTelefonoVal = filterTelefono.value.toLowerCase().trim();
            const filterFechasVal = Array.from(filterFecha.selectedOptions).map(option => option.value);
            const filterHoraVal = filterHora.value;

            if (filterFabricanteVal) {
                filteredCitas = filteredCitas.filter(cita => 
                    cita.fabricante && cita.fabricante.toLowerCase().includes(filterFabricanteVal)
                );
            }
            if (filterTelefonoVal) {
                filteredCitas = filteredCitas.filter(cita => 
                    cita.telefono && cita.telefono.toLowerCase().includes(filterTelefonoVal)
                );
            }
            if (filterFechasVal.length > 0) {
                filteredCitas = filteredCitas.filter(cita => 
                    filterFechasVal.includes(cita.fecha)
                );
            }
            if (filterHoraVal) {
                filteredCitas = filteredCitas.filter(cita => 
                    cita.hora === filterHoraVal
                );
            }

            renderCitas(filteredCitas);
        }

        function clearAllFilters() {
            filterFabricante.value = '';
            filterTelefono.value = '';
            // Deseleccionar todas las opciones en el multi-select de fecha
            Array.from(filterFecha.options).forEach(option => option.selected = false);
            filterHora.value = '';
            applyFilters(); // Re-aplicar filtros para mostrar todo
        }


        // --- Manejo de Datos y Renderizado ---

        // Renderizar citas en la tabla
        function renderCitas(citasToRender) {
            citasTableBody.innerHTML = ''; // Limpiar tabla
            if (citasToRender.length === 0) {
                citasTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay citas registradas que coincidan con los filtros.</td></tr>`;
                return;
            }

            citasToRender.forEach(cita => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 whitespace-nowrap text-sm font-medium text-gray-900">${cita.fabricante}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-700">${cita.telefono}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-700">${new Date(cita.fecha + 'T00:00:00').toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-700">${convertTo12HourFormat(cita.hora)}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-center text-sm font-medium">
                        <button onclick="handleEdit('${cita.id}', '${cita.fabricante.replace(/'/g, "\\'")}', '${cita.telefono}', '${cita.fecha}', '${cita.hora}')"
                                class="text-blue-600 hover:text-blue-900 mr-3 inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            <span class="hidden sm:inline-block">Editar</span>
                        </button>
                        <button onclick="handleDelete('${cita.id}')"
                                class="text-red-600 hover:text-red-900 mr-3 inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            <span class="hidden sm:inline-block">Eliminar</span>
                        </button>
                        <button onclick="handleGeneratePdf('${cita.fabricante.replace(/'/g, "\\'")}', '${cita.telefono}', '${new Date(cita.fecha + 'T00:00:00').toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}', '${convertTo12HourFormat(cita.hora)}')"
                                class="text-purple-600 hover:text-purple-900 inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                            </svg>
                            <span class="hidden sm:inline-block">PDF</span>
                        </button>
                    </td>
                `;
                citasTableBody.appendChild(row);
            });
        }

        // Poblar opciones de filtro de fecha y hora
        function populateFilterOptions() {
            // Fecha
            filterFecha.innerHTML = '';
            diasDisponibles.forEach(dia => {
                const option = document.createElement('option');
                option.value = dia.value;
                option.textContent = dia.text;
                filterFecha.appendChild(option);
            });

            // Hora
            filterHora.innerHTML = '<option value="">Todas las horas</option>';
            const allHours = [...new Set([...todosLosHorarios.morning, ...todosLosHorarios.afternoon])].sort(); // Obtener horas únicas y ordenarlas
            allHours.forEach(hora24 => {
                const option = document.createElement('option');
                option.value = hora24;
                option.textContent = convertTo12HourFormat(hora24);
                filterHora.appendChild(option);
            });
        }


        // Escuchar cambios en tiempo real en la colección 'citasShowroom'
        // Se eliminó el orderBy de la consulta de Firestore para evitar el error de índice.
        citasCollection.onSnapshot(snapshot => {
            allCitasData = []; // Resetear el array de datos completos
            snapshot.forEach(doc => {
                allCitasData.push({ id: doc.id, ...doc.data() });
            });
            // Ordenar los datos en el cliente (JavaScript) por fecha y luego por hora
            allCitasData.sort((a, b) => {
                const dateA = new Date(a.fecha + 'T' + a.hora);
                const dateB = new Date(b.fecha + 'T' + b.hora);
                return dateA - dateB;
            });
            applyFilters(); // Aplicar filtros después de obtener y ordenar los datos más recientes
        }, error => {
            console.error("Error al escuchar citas: ", error);
            mostrarFeedback("Error al cargar las citas en tiempo real.", true);
        });

        // --- Manejadores de Eventos ---

        // Manejar edición de cita
        window.handleEdit = function(id, fabricante, telefono, fecha, hora) {
            // Unescape single quotes that might be in the fabricant name for JS function call
            const unescapedFabricante = fabricante.replace(/\\'/g, "'");
            openEditModal({ id, fabricante: unescapedFabricante, telefono, fecha, hora });
        };

        editCitaForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const id = editCitaId.value;
            const updatedFabricante = editFabricante.value;
            const updatedTelefono = editTelefono.value;
            const updatedFecha = editDia.value;
            const updatedHora = editHora.value;

            if (!updatedFabricante || !updatedTelefono || !updatedFecha || !updatedHora) {
                mostrarFeedback("Por favor, complete todos los campos para actualizar la cita.", true);
                return;
            }

            try {
                // Verificar si el nuevo horario ya está ocupado por OTRA cita
                const snapshot = await citasCollection
                    .where('fecha', '==', updatedFecha)
                    .where('hora', '==', updatedHora)
                    .get();

                const isOccupiedByAnother = snapshot.docs.some(doc => doc.id !== id);

                if (isOccupiedByAnother) {
                    mostrarFeedback("Lo sentimos, el horario seleccionado ya está ocupado por otra cita. Por favor, elija otro.", true);
                    return;
                }

                await citasCollection.doc(id).update({
                    fabricante: updatedFabricante,
                    telefono: updatedTelefono,
                    fecha: updatedFecha,
                    hora: updatedHora
                });
                mostrarFeedback("Cita actualizada con éxito.");
                closeEditModal();
            } catch (error) {
                console.error("Error al actualizar la cita: ", error);
                mostrarFeedback("Error al actualizar la cita. Inténtelo de nuevo.", true);
            }
        });

        // Manejar eliminación de cita
        window.handleDelete = function(id) {
            openDeleteConfirmModal(id);
        };

        confirmDeleteButton.addEventListener('click', async function() {
            if (citaToDeleteId) {
                try {
                    await citasCollection.doc(citaToDeleteId).delete();
                    mostrarFeedback("Cita eliminada con éxito.");
                    closeDeleteConfirmModal();
                } catch (error) {
                    console.error("Error al eliminar la cita: ", error);
                    mostrarFeedback("Error al eliminar la cita. Inténtelo de nuevo.", true);
                }
            }
        });

        // Manejar generación de PDF de cita individual
        window.handleGeneratePdf = function(fabricante, telefono, fecha, hora) {
            const citaDetails = { fabricante, telefono, fecha, hora };
            generarCitaPDF(citaDetails);
        };

        // Función para generar el PDF de la cita agendada (reutilizada y adaptada)
        function generarCitaPDF(citaDetails) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const margen = 20;
            let yPos = margen;

            // Header con logo (placeholder) y título
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(46, 139, 87); // Verde mar
            doc.text("Confirmación de Cita", margen, yPos);
            yPos += 10;
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0); // Negro
            doc.text("Show Room La Zapatería", margen, yPos);
            yPos += 20;

            // Línea separadora
            doc.setDrawColor(46, 139, 87); // Verde mar
            doc.setLineWidth(0.5);
            doc.line(margen, yPos, doc.internal.pageSize.width - margen, yPos);
            yPos += 15;

            // Detalles de la cita
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(51, 51, 51); // Gris oscuro

            doc.text("Estimado/a Fabricante:", margen, yPos);
            yPos += 10;
            doc.text("Su cita ha sido agendada con éxito. A continuación, los detalles:", margen, yPos);
            yPos += 15;

            doc.setFont(undefined, 'bold');
            doc.text("Fabricante:", margen, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(citaDetails.fabricante, margen + 30, yPos);
            yPos += 10;

            doc.setFont(undefined, 'bold');
            doc.text("Teléfono:", margen, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(citaDetails.telefono, margen + 30, yPos);
            yPos += 10;

            doc.setFont(undefined, 'bold');
            doc.text("Fecha:", margen, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(citaDetails.fecha, margen + 30, yPos);
            yPos += 10;

            doc.setFont(undefined, 'bold');
            doc.text("Hora:", margen, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(citaDetails.hora, margen + 30, yPos);
            yPos += 20;

            // Mensaje final
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.text("Agradecemos su preferencia. ¡Le esperamos!", margen, yPos);
            yPos += 15;

            // Footer
            doc.setDrawColor(46, 139, 87); // Verde mar
            doc.line(margen, doc.internal.pageSize.height - margen - 10, doc.internal.pageSize.width - margen, doc.internal.pageSize.height - margen - 10);
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100); // Gris
            doc.text("La Zapatería - Evento Show Room", margen, doc.internal.pageSize.height - margen);
            doc.text(`Generado el: ${new Date().toLocaleDateString('es-CO')} ${new Date().toLocaleTimeString('es-CO')}`, doc.internal.pageSize.width - margen, doc.internal.pageSize.height - margen, { align: 'right' });


            doc.save(`Cita_ShowRoom_${citaDetails.fabricante}.pdf`);
        }

        // Inicialización: Asegurarse de que los modales se cierren al hacer clic fuera
        window.onclick = function(event) {
            if (event.target == editModal) {
                closeEditModal();
            }
            if (event.target == deleteConfirmModal) {
                closeDeleteConfirmModal();
            }
            if (event.target == feedbackModal) {
                feedbackModal.style.display = "none";
            }
        }

        // Event listeners para los filtros
        filterFabricante.addEventListener('input', applyFilters);
        filterTelefono.addEventListener('input', applyFilters);
        filterFecha.addEventListener('change', applyFilters);
        filterHora.addEventListener('change', applyFilters);
        clearFiltersButton.addEventListener('click', clearAllFilters);

        // Poblar las opciones de los filtros al cargar
        populateFilterOptions();
    </script>
</body>
</html>
