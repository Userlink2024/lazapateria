<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración de Citas - La Zapatería</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos base para el cuerpo y la fuente */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para los modales (ventanas emergentes) */
        .modal {
            display: none; /* Oculto por defecto */
            position: fixed; /* Permanece en su lugar */
            z-index: 100; /* Se superpone a otros elementos */
            left: 0;
            top: 0;
            width: 100%; /* Ancho completo */
            height: 100%; /* Alto completo */
            overflow: auto; /* Habilita el scroll si el contenido es muy grande */
            background-color: rgba(0,0,0,0.4); /* Fondo semi-transparente */
            display: flex; /* Para centrar el contenido del modal */
            align-items: center; /* Centrado vertical */
            justify-content: center; /* Centrado horizontal */
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px; /* Relleno interno */
            border-radius: 0.75rem; /* Bordes redondeados */
            box-shadow: 0 10px 15px rgba(0,0,0,0.1); /* Sombra */
            width: 90%; /* Ancho del modal en pantallas pequeñas */
            max-width: 500px; /* Ancho máximo del modal en pantallas grandes */
            text-align: center;
            position: relative;
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280; /* Color gris */
        }
        /* Estilos para opciones deshabilitadas en selectores */
        select option:disabled {
            color: #cccccc;
            background-color: #f0f0f0;
        }
        /* Estilos personalizados para el filtro de fecha multi-selección */
        #filterFecha {
            height: 100px; /* Altura fija para el selector de fecha */
            overflow-y: auto; /* Scroll vertical si hay muchas opciones */
        }

        /* Ajustes para la tabla en pantallas pequeñas */
        @media (max-width: 640px) {
            table thead {
                display: none; /* Oculta el encabezado de la tabla en móviles */
            }
            table, table tbody, table tr, table td {
                display: block; /* Hace que los elementos de la tabla se comporten como bloques */
                width: 100%; /* Ancho completo */
            }
            table tr {
                margin-bottom: 1rem; /* Espacio entre filas */
                border: 1px solid #e2e8f0; /* Borde para cada fila */
                border-radius: 0.5rem; /* Bordes redondeados */
                padding: 0.5rem; /* Relleno para cada fila */
            }
            table td {
                text-align: right; /* Alinea el texto a la derecha */
                padding-left: 50%; /* Espacio para la etiqueta */
                position: relative;
            }
            table td::before {
                content: attr(data-label); /* Usa el atributo data-label para mostrar la etiqueta */
                position: absolute;
                left: 0.5rem;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
            }
            /* Ajuste para los filtros en el encabezado de la tabla en móvil */
            table thead tr:last-child {
                display: flex;
                flex-direction: column;
                padding: 0;
                border: none;
            }
            table thead tr:last-child th {
                width: 100%;
                padding: 0.5rem 0.75rem;
                text-align: left;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen py-4 sm:py-10 px-2 sm:px-6 lg:px-8">

    <div class="bg-white p-4 sm:p-8 rounded-lg shadow-xl w-full max-w-4xl mb-4 sm:mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-green-600 mb-4 sm:mb-8">Panel de Administración de Citas</h1>
        <p class="text-sm sm:text-base text-center text-gray-600 mb-4 sm:mb-6">Gestiona las citas agendadas para el Show Room de La Zapatería.</p>

        <div class="mb-4 flex justify-end">
            <button id="addCitaButton" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm flex items-center text-sm sm:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Agregar Cita
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded-lg shadow-md">
                <thead class="bg-green-600 text-white">
                    <tr>
                        <th class="py-3 px-4 text-left text-sm font-semibold rounded-tl-lg">Fabricante</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">Fecha</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">Hora</th>
                        <th class="py-3 px-4 text-center text-sm font-semibold rounded-tr-lg">Acciones</th>
                    </tr>
                    <tr class="bg-green-700">
                        <th class="py-2 px-4">
                            <input type="text" id="filterFabricante" placeholder="Filtrar fabricante..."
                                   class="w-full text-sm text-gray-900 px-2 py-1 rounded-md bg-white border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="py-2 px-4">
                            <select id="filterFecha" multiple size="4"
                                    class="w-full text-sm text-gray-900 px-2 py-1 rounded-md bg-white border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </select>
                        </th>
                        <th class="py-2 px-4">
                            <select id="filterHora"
                                    class="w-full text-sm text-gray-900 px-2 py-1 rounded-md bg-white border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todas las horas</option>
                            </select>
                        </th>
                        <th class="py-2 px-4 text-center flex flex-col space-y-2">
                            <button id="clearFiltersButton" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded-md">
                                Limpiar Filtros
                            </button>
                            <button id="exportExcelButton" class="w-full text-sm bg-green-500 hover:bg-green-600 text-white py-1 px-2 rounded-md">
                                Exportar a Excel
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody id="citasTableBody" class="divide-y divide-gray-200">
                    <tr>
                        <td colspan="4" class="text-center py-4 text-gray-500">Cargando citas...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="editModal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeEditModal()">&times;</button>
            <h2 class="text-xl sm:text-2xl font-bold text-green-600 mb-4 sm:mb-6">Editar Cita</h2>
            <form id="editCitaForm" class="space-y-3 sm:space-y-4">
                <input type="hidden" id="editCitaId">
                <div>
                    <label for="editFabricante" class="block text-sm font-medium text-gray-700 text-left mb-1">Fabricante:</label>
                    <input type="text" id="editFabricante" name="fabricante" required
                           class="mt-1 block w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm">
                </div>
                <div>
                    <label for="editDia" class="block text-sm font-medium text-gray-700 text-left mb-1">Día:</label>
                    <select id="editDia" name="dia" required
                            class="mt-1 block w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm">
                    </select>
                </div>
                <div>
                    <label for="editHora" class="block text-sm font-medium text-gray-700 text-left mb-1">Hora:</label>
                    <select id="editHora" name="hora" required
                            class="mt-1 block w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm">
                    </select>
                </div>
                <div class="flex justify-end space-x-2 sm:space-x-3 mt-4 sm:mt-6">
                    <button type="button" onclick="closeEditModal()"
                            class="py-2 px-3 sm:px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="py-2 px-3 sm:px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="addModal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeAddModal()">&times;</button>
            <h2 class="text-xl sm:text-2xl font-bold text-purple-600 mb-4 sm:mb-6">Agregar Nueva Cita</h2>
            <form id="addCitaForm" class="space-y-3 sm:space-y-4">
                <div>
                    <label for="addFabricante" class="block text-sm font-medium text-gray-700 text-left mb-1">Fabricante:</label>
                    <input type="text" id="addFabricante" name="fabricante" required
                           class="mt-1 block w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm">
                </div>
                <div>
                    <label for="addDia" class="block text-sm font-medium text-gray-700 text-left mb-1">Día:</label>
                    <select id="addDia" name="dia" required
                            class="mt-1 block w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm">
                        <option value="" disabled selected>Seleccione un día</option>
                    </select>
                </div>
                <div>
                    <label for="addHora" class="block text-sm font-medium text-gray-700 text-left mb-1">Hora:</label>
                    <select id="addHora" name="hora" required disabled
                            class="mt-1 block w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm disabled:bg-gray-50">
                        <option value="" disabled selected>Seleccione una hora</option>
                    </select>
                    <p id="loading-add-hours" class="text-xs text-gray-500 mt-1" style="display: none;">Cargando horarios disponibles...</p>
                </div>
                <div class="flex justify-end space-x-2 sm:space-x-3 mt-4 sm:mt-6">
                    <button type="button" onclick="closeAddModal()"
                            class="py-2 px-3 sm:px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="py-2 px-3 sm:px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        Agregar Cita
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeDeleteConfirmModal()">&times;</button>
            <h2 class="text-xl sm:text-2xl font-bold text-red-600 mb-4 sm:mb-6">Confirmar Eliminación</h2>
            <p class="text-base sm:text-lg mb-4 sm:mb-6">¿Está seguro de que desea eliminar esta cita?</p>
            <div class="flex justify-center space-x-2 sm:space-x-4">
                <button type="button" onclick="closeDeleteConfirmModal()"
                        class="py-2 px-3 sm:px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancelar
                </button>
                <button type="button" id="confirmDeleteButton"
                        class="py-2 px-3 sm:px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <div id="feedbackModal" class="modal" style="display: none;">
        <div class="modal-content">
            <p id="modalMessage" class="text-base sm:text-lg mb-3 sm:mb-4"></p>
            <div class="modal-buttons">
                <button id="modalOkButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm sm:text-base">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
            authDomain: "lazapateria-c4157.firebaseapp.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.firebasestorage.app",
            messagingSenderId: "300241769138",
            appId: "1:300241769138:web:8ca1847de3c4fb5042afab",
            measurementId: "G-HVG7615JEE"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const citasCollection = db.collection('citasShowroom');

        // --- Definición de Días y Horarios ---
        const currentYear = new Date().getFullYear();
        const yearForEvent = (new Date().getMonth() > 6 || (new Date().getMonth() === 6 && new Date().getDate() > 19)) ?
            currentYear + 1 : currentYear;

        const diasDisponibles = [
            { value: `${yearForEvent}-07-16`, text: `16 de Julio de ${yearForEvent} (Miércoles)` },
            { value: `${yearForEvent}-07-17`, text: `17 de Julio de ${yearForEvent} (Jueves)` },
            { value: `${yearForEvent}-07-18`, text: `18 de Julio de ${yearForEvent} (Viernes)` },
            { value: `${yearForEvent}-07-19`, text: `19 de Julio de ${yearForEvent} (Sábado)` }
        ];

        const todosLosHorarios = {
            morning: ["08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30"],
            afternoon: ["14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30"]
        };
        // --- Elementos del DOM ---
        const citasTableBody = document.getElementById('citasTableBody');
        const editModal = document.getElementById('editModal');
        const editCitaForm = document.getElementById('editCitaForm');
        const editCitaId = document.getElementById('editCitaId');
        const editFabricante = document.getElementById('editFabricante');
        const editDia = document.getElementById('editDia');
        const editHora = document.getElementById('editHora');

        const addModal = document.getElementById('addModal');
        const addCitaForm = document.getElementById('addCitaForm');
        const addFabricante = document.getElementById('addFabricante');
        const addDia = document.getElementById('addDia');
        const addHora = document.getElementById('addHora');
        const loadingAddHoursP = document.getElementById('loading-add-hours');


        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const feedbackModal = document.getElementById('feedbackModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalOkButton = document.getElementById('modalOkButton');
        // Elementos de Filtro
        const filterFabricante = document.getElementById('filterFabricante');
        const filterFecha = document.getElementById('filterFecha');
        const filterHora = document.getElementById('filterHora');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const exportExcelButton = document.getElementById('exportExcelButton');
        const addCitaButton = document.getElementById('addCitaButton');

        let citaToDeleteId = null;
        let allCitasData = [];
        let displayedCitas = [];

        // --- Funciones de Utilidad ---

        function convertTo12HourFormat(time24) {
            if (!time24) return "";
            const [hours, minutes] = time24.split(':');
            let h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12;
            return `${h}:${minutes} ${ampm}`;
        }

        function obtenerHorariosParaDia(fechaValue) {
            if (fechaValue === `${yearForEvent}-07-19`) {
                return todosLosHorarios.morning;
            }
            return [...todosLosHorarios.morning, ...todosLosHorarios.afternoon];
        }

        function mostrarFeedback(message, isError = false) {
            modalMessage.textContent = message;
            modalMessage.className = isError ? 'text-lg mb-4 text-red-600' : 'text-lg mb-4 text-green-700';
            feedbackModal.style.display = 'flex';
        }

        modalOkButton.onclick = function() {
            feedbackModal.style.display = "none";
        }

        // --- Funciones para Modales ---

        function openEditModal(cita) {
            editCitaId.value = cita.id;
            editFabricante.value = cita.fabricante;

            editDia.innerHTML = '<option value="" disabled>Seleccione un día</option>';
            diasDisponibles.forEach(dia => {
                const option = document.createElement('option');
                option.value = dia.value;
                option.textContent = dia.text;
                editDia.appendChild(option);
            });
            editDia.value = cita.fecha;

            editDia.onchange = async function() {
                await updateHoursDropdown(editDia, editHora, null, cita.id);
            };
            updateHoursDropdown(editDia, editHora, cita.hora, cita.id); // Pass cita.id to exclude
            
            editModal.style.display = 'flex';
        }

        function closeEditModal() {
            editModal.style.display = 'none';
            editCitaForm.reset();
        }

        function openAddModal() {
            addCitaForm.reset();
            addDia.innerHTML = '<option value="" disabled selected>Seleccione un día</option>';
            diasDisponibles.forEach(dia => {
                const option = document.createElement('option');
                option.value = dia.value;
                option.textContent = dia.text;
                addDia.appendChild(option);
            });
            addHora.innerHTML = '<option value="" disabled selected>Seleccione una hora</option>';
            addHora.disabled = true;
            loadingAddHoursP.style.display = 'none';
            addDia.onchange = async function() {
                await updateHoursDropdown(addDia, addHora, null, null, loadingAddHoursP);
            };
            addModal.style.display = 'flex';
        }

        function closeAddModal() {
            addModal.style.display = 'none';
            addCitaForm.reset();
        }

        // Reusable function to update hours dropdown for both edit and add modals
        async function updateHoursDropdown(daySelectElement, hourSelectElement, selectedHora = null, excludeCitaId = null, loadingElement = null) {
            const fechaSeleccionada = daySelectElement.value;
            hourSelectElement.innerHTML = '<option value="" disabled selected>Seleccione una hora</option>';
            hourSelectElement.disabled = true;
            if (loadingElement) loadingElement.style.display = 'block';
            if (!fechaSeleccionada) {
                if (loadingElement) loadingElement.style.display = 'none';
                return;
            }

            try {
                const querySnapshot = await citasCollection.where('fecha', '==', fechaSeleccionada).get();
                let horariosOcupados = querySnapshot.docs.map(doc => doc.data().hora);
                
                // If editing, remove the current cita's hour from occupied list
                if (excludeCitaId) {
                    const currentCitaDoc = querySnapshot.docs.find(doc => doc.id === excludeCitaId);
                    if (currentCitaDoc) {
                        horariosOcupados = horariosOcupados.filter(hora => hora !== currentCitaDoc.data().hora);
                    }
                }
                
                const horariosBase = obtenerHorariosParaDia(fechaSeleccionada);
                horariosBase.forEach(hora24 => {
                    const option = document.createElement('option');
                    option.value = hora24;
                    option.textContent = convertTo12HourFormat(hora24);
                    if (horariosOcupados.includes(hora24)) {
                        option.disabled = true;
                        option.textContent += ' (Ocupado)';
                    }
                    hourSelectElement.appendChild(option);
                });

                // Set selected hour if provided and not occupied by another appointment
                if (selectedHora && !horariosOcupados.includes(selectedHora)) {
                    hourSelectElement.value = selectedHora;
                } else if (selectedHora && excludeCitaId) { // If it's the current cita's hour, re-enable it
                    const currentOption = Array.from(hourSelectElement.options).find(opt => opt.value === selectedHora);
                    if (currentOption) {
                        currentOption.disabled = false;
                        hourSelectElement.value = selectedHora;
                    }
                }

                hourSelectElement.disabled = false;
            } catch (error) {
                console.error("Error actualizando horarios del modal: ", error);
                mostrarFeedback("Error al cargar horarios. Intente de nuevo.", true);
            } finally {
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }


        function openDeleteConfirmModal(citaId) {
            citaToDeleteId = citaId;
            deleteConfirmModal.style.display = 'flex';
        }

        function closeDeleteConfirmModal() {
            citaToDeleteId = null;
            deleteConfirmModal.style.display = 'none';
        }

        // --- Lógica de Filtros ---
        function applyFilters() {
            let filteredCitas = [...allCitasData];
            const filterFabricanteVal = filterFabricante.value.toLowerCase().trim();
            const filterFechasVal = Array.from(filterFecha.selectedOptions).map(option => option.value);
            const filterHoraVal = filterHora.value;
            if (filterFabricanteVal) {
                filteredCitas = filteredCitas.filter(cita =>
                    cita.fabricante && cita.fabricante.toLowerCase().includes(filterFabricanteVal)
                );
            }
            if (filterFechasVal.length > 0) {
                filteredCitas = filteredCitas.filter(cita =>
                    filterFechasVal.includes(cita.fecha)
                );
            }
            if (filterHoraVal) {
                filteredCitas = filteredCitas.filter(cita =>
                    cita.hora === filterHoraVal
                );
            }

            displayedCitas = filteredCitas;
            renderCitas(filteredCitas);
        }

        function clearAllFilters() {
            filterFabricante.value = '';
            Array.from(filterFecha.options).forEach(option => option.selected = false);
            filterHora.value = '';
            applyFilters();
        }


        // --- Manejo de Datos y Renderizado ---

        function renderCitas(citasToRender) {
            citasTableBody.innerHTML = '';
            if (citasToRender.length === 0) {
                citasTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No hay citas registradas que coincidan con los filtros.</td></tr>`;
                return;
            }

            citasToRender.forEach(cita => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 whitespace-nowrap text-sm font-medium text-gray-900" data-label="Fabricante:">${cita.fabricante}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-700" data-label="Fecha:">${new Date(cita.fecha + 'T00:00:00').toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-700" data-label="Hora:">${convertTo12HourFormat(cita.hora)}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-center text-sm font-medium">
                        <button onclick="handleEdit('${cita.id}', '${cita.fabricante.replace(/'/g, "\\'")}', '${cita.fecha}', '${cita.hora}')"
                                class="text-blue-600 hover:text-blue-900 mr-1 sm:mr-3 inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            <span class="hidden sm:inline-block">Editar</span>
                        </button>
                        <button onclick="handleDelete('${cita.id}')"
                                class="text-red-600 hover:text-red-900 mr-1 sm:mr-3 inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            <span class="hidden sm:inline-block">Eliminar</span>
                        </button>
                        <button onclick="handleGeneratePdf('${cita.fabricante.replace(/'/g, "\\'")}', '${new Date(cita.fecha + 'T00:00:00').toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}', '${convertTo12HourFormat(cita.hora)}')"
                                class="text-purple-600 hover:text-purple-900 inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                            </svg>
                            <span class="hidden sm:inline-block">PDF</span>
                        </button>
                    </td>
                `;
                citasTableBody.appendChild(row);
            });
        }

        // Poblar opciones de filtro de fecha y hora
        function populateFilterOptions() {
            filterFecha.innerHTML = '';
            diasDisponibles.forEach(dia => {
                const option = document.createElement('option');
                option.value = dia.value;
                option.textContent = dia.text;
                filterFecha.appendChild(option);
            });
            filterHora.innerHTML = '<option value="">Todas las horas</option>';
            const allHours = [...new Set([...todosLosHorarios.morning, ...todosLosHorarios.afternoon])].sort();
            allHours.forEach(hora24 => {
                const option = document.createElement('option');
                option.value = hora24;
                option.textContent = convertTo12HourFormat(hora24);
                filterHora.appendChild(option);
            });
        }

        function exportToExcel() {
            if (displayedCitas.length === 0) {
                mostrarFeedback("No hay citas para exportar.", true);
                return;
            }

            const headers = ["Fabricante", "Fecha", "Hora"];
            let csvContent = headers.join(";") + "\n";

            displayedCitas.forEach(cita => {
                const row = [
                    `"${cita.fabricante.replace(/"/g, '""')}"`,
                    `"${new Date(cita.fecha + 'T00:00:00').toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' }).replace(/"/g, '""')}"`,
                    `"${convertTo12HourFormat(cita.hora).replace(/"/g, '""')}"`
                ];
                csvContent += row.join(";") + "\n";
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'citas_showroom.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                mostrarFeedback("Citas exportadas a Excel con éxito.");
            } else {
                mostrarFeedback("Su navegador no soporta la descarga de archivos. Intente copiar los datos manualmente.", true);
            }
        }

        citasCollection.onSnapshot(snapshot => {
            allCitasData = [];
            snapshot.forEach(doc => {
                allCitasData.push({ id: doc.id, ...doc.data() });
            });
            allCitasData.sort((a, b) => {
                const dateA = new Date(a.fecha + 'T' + a.hora);
                const dateB = new Date(b.fecha + 'T' + b.hora);
                return dateA - dateB;
            });
            applyFilters();
        }, error => {
            console.error("Error al escuchar citas: ", error);
            mostrarFeedback("Error al cargar las citas en tiempo real.", true);
        });
        // --- Manejadores de Eventos ---

        window.handleEdit = function(id, fabricante, fecha, hora) {
            const unescapedFabricante = fabricante.replace(/\\'/g, "'");
            openEditModal({ id, fabricante: unescapedFabricante, fecha, hora });
        };

        editCitaForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const id = editCitaId.value;
            const updatedFabricante = editFabricante.value;
            const updatedFecha = editDia.value;
            const updatedHora = editHora.value;

            if (!updatedFabricante || !updatedFecha || !updatedHora) {
                mostrarFeedback("Por favor, complete todos los campos para actualizar la cita.", true);
                return;
            }

            try {
                const snapshot = await citasCollection
                    .where('fecha', '==', updatedFecha)
                    .where('hora', '==', updatedHora)
                    .get();

                const isOccupiedByAnother = snapshot.docs.some(doc => doc.id !== id);

                if (isOccupiedByAnother) {
                    mostrarFeedback("Lo sentimos, el horario seleccionado ya está ocupado por otra cita. Por favor, elija otro.", true);
                    return;
                }

                await citasCollection.doc(id).update({
                    fabricante: updatedFabricante,
                    fecha: updatedFecha,
                    hora: updatedHora
                });
                mostrarFeedback("Cita actualizada con éxito.");
                closeEditModal();
            } catch (error) {
                console.error("Error al actualizar la cita: ", error);
                mostrarFeedback("Error al actualizar la cita. Inténtelo de nuevo.", true);
            }
        });

        // Manejador para agregar nueva cita
        addCitaForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const fabricante = addFabricante.value;
            const fecha = addDia.value;
            const hora = addHora.value;
            if (!fabricante || !fecha || !hora) {
                mostrarFeedback("Por favor, complete todos los campos para agregar la cita.", true);
                return;
            }

            try {
                const snapshot = await citasCollection
                    .where('fecha', '==', fecha)
                    .where('hora', '==', hora)
                    .get();
                if (!snapshot.empty) {
                    mostrarFeedback("Lo sentimos, este horario ya está ocupado. Por favor, seleccione otro.", true);
                    return;
                }

                await citasCollection.add({
                    fabricante: fabricante,
                    fecha: fecha,
                    hora: hora,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                mostrarFeedback("Nueva cita agregada con éxito.");
                closeAddModal();
            } catch (error) {
                console.error("Error al agregar la cita: ", error);
                mostrarFeedback("Error al agregar la cita. Inténtelo de nuevo.", true);
            }
        });
        window.handleDelete = function(id) {
            openDeleteConfirmModal(id);
        };
        confirmDeleteButton.addEventListener('click', async function() {
            if (citaToDeleteId) {
                try {
                    await citasCollection.doc(citaToDeleteId).delete();
                    mostrarFeedback("Cita eliminada con éxito.");
                    closeDeleteConfirmModal();
                } catch (error) {
                    console.error("Error al eliminar la cita: ", error);
                    mostrarFeedback("Error al eliminar la cita. Inténtelo de nuevo.", true);
                }
            }
        });

        window.handleGeneratePdf = function(fabricante, fecha, hora) {
            const citaDetails = { fabricante, fecha, hora };
            generarCitaPDF(citaDetails);
        };

        function generarCitaPDF(citaDetails) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const margen = 20;
            let yPos = margen;

            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(46, 139, 87);
            doc.text("Confirmación de Cita", margen, yPos);
            yPos += 10;
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("Show Room La Zapatería", margen, yPos);
            yPos += 20;

            doc.setDrawColor(46, 139, 87);
            doc.setLineWidth(0.5);
            doc.line(margen, yPos, doc.internal.pageSize.width - margen, yPos);
            yPos += 15;

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(51, 51, 51);

            doc.text("Estimado/a Fabricante:", margen, yPos);
            yPos += 10;
            doc.text("Su cita ha sido agendada con éxito. A continuación, los detalles:", margen, yPos);
            yPos += 15;

            doc.setFont(undefined, 'bold');
            doc.text("Fabricante:", margen, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(citaDetails.fabricante, margen + 30, yPos);
            yPos += 10;

            doc.setFont(undefined, 'bold');
            doc.text("Fecha:", margen, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(citaDetails.fecha, margen + 30, yPos);
            yPos += 10;

            doc.setFont(undefined, 'bold');
            doc.text("Hora:", margen, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(citaDetails.hora, margen + 30, yPos);
            yPos += 20;

            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.text("Agradecemos su preferencia. ¡Le esperamos!", margen, yPos);
            yPos += 15;

            doc.setDrawColor(46, 139, 87);
            doc.line(margen, doc.internal.pageSize.height - margen - 10, doc.internal.pageSize.width - margen, doc.internal.pageSize.height - margen - 10);
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text("La Zapatería - Evento Show Room", margen, doc.internal.pageSize.height - margen);
            doc.text(`Generado el: ${new Date().toLocaleDateString('es-CO')} ${new Date().toLocaleTimeString('es-CO')}`, doc.internal.pageSize.width - margen, doc.internal.pageSize.height - margen, { align: 'right' });


            doc.save(`Cita_ShowRoom_${citaDetails.fabricante}.pdf`);
        }

        window.onclick = function(event) {
            if (event.target == editModal) {
                closeEditModal();
            }
            if (event.target == addModal) {
                closeAddModal();
            }
            if (event.target == deleteConfirmModal) {
                closeDeleteConfirmModal();
            }
            if (event.target == feedbackModal) {
                feedbackModal.style.display = "none";
            }
        }

        filterFabricante.addEventListener('input', applyFilters);
        filterFecha.addEventListener('change', applyFilters);
        filterHora.addEventListener('change', applyFilters);
        clearFiltersButton.addEventListener('click', clearAllFilters);
        exportExcelButton.addEventListener('click', exportToExcel);
        addCitaButton.addEventListener('click', openAddModal);

        populateFilterOptions();
    </script>
</body>
</html>
