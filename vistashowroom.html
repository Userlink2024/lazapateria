<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración de Citas - La Zapatería</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 15px rgba(0,0,0,0.1); /* shadow-xl */
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        /* Alineación para formularios dentro de modales */
        .modal-content form > div {
            text-align: left;
        }
        .modal-content label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4B5563; /* text-gray-700 */
        }
        .modal-content input[type="text"],
        .modal-content input[type="tel"],
        .modal-content select {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid #D1D5DB; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* shadow-sm */
            font-size: 0.875rem; /* sm:text-sm */
        }
        .modal-content button {
            margin-top: 1rem;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            padding: 0.625rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: white;
            transition: background-color 0.15s ease-in-out;
        }
        .modal-content .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #9CA3AF;
        }
        .modal-content .close-button:hover {
            color: #4B5563;
        }
        select option:disabled {
            color: #cccccc;
            background-color: #f0f0f0;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen py-10">

    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-5xl mb-8">
        <h1 class="text-3xl font-bold text-center text-blue-600 mb-8">Panel de Administración de Citas</h1>
        <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
            <div class="flex-grow flex flex-wrap items-center gap-4">
                <input type="text" id="filterFabricante" placeholder="Filtrar por fabricante"
                       class="flex-1 min-w-[150px] px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                <select id="filterFecha"
                        class="flex-1 min-w-[150px] px-4 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">Todas las fechas</option>
                </select>
                <select id="filterHora"
                        class="flex-1 min-w-[150px] px-4 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">Todas las horas</option>
                </select>
            </div>
            <div class="flex-shrink-0 flex gap-2">
                <button id="clearFiltersButton"
                        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Limpiar Filtros
                </button>
                <button id="exportExcelButton"
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Exportar a Excel
                </button>
                <button id="addCitaButton"
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Agregar Cita
                </button>
            </div>
        </div>


        <div class="overflow-x-auto rounded-lg shadow">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fabricante</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="citasTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
        <p id="noCitasMessage" class="text-center text-gray-500 mt-4" style="display: none;">No hay citas que coincidan con los filtros.</p>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Editar Cita</h2>
            <form id="editForm" class="space-y-4">
                <div>
                    <label for="editFabricante">Fabricante:</label>
                    <input type="text" id="editFabricante" name="fabricante" required>
                </div>
                <div>
                    <label for="editDia">Día de la Cita:</label>
                    <select id="editDia" name="dia" required></select>
                </div>
                <div>
                    <label for="editHora">Hora de la Cita:</label>
                    <select id="editHora" name="hora" required></select>
                </div>
                <button type="submit" class="bg-blue-500 hover:bg-blue-600">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-center">Confirmar Eliminación</h2>
            <p class="mb-6">¿Estás seguro de que quieres eliminar esta cita?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmDeleteButton" class="bg-red-500 hover:bg-red-600">Eliminar</button>
                <button onclick="closeDeleteConfirmModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAddModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Agregar Nueva Cita</h2>
            <form id="addForm" class="space-y-4">
                <div>
                    <label for="addFabricante">Fabricante:</label>
                    <input type="text" id="addFabricante" name="fabricante" required>
                </div>
                <div>
                    <label for="addDia">Día de la Cita:</label>
                    <select id="addDia" name="dia" required></select>
                </div>
                <div>
                    <label for="addHora">Hora de la Cita:</label>
                    <select id="addHora" name="hora" required></select>
                </div>
                <button type="submit" class="bg-green-500 hover:bg-green-600">Agregar Cita</button>
            </form>
        </div>
    </div>

    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg mb-4"></p>
            <div class="modal-buttons flex justify-center items-center">
                <button id="modalOkButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">OK</button>
                <button id="generarCitaPdfButton" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg ml-3" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    Generar PDF Cita
                </button>
            </div>
        </div>
    </div>


    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
            authDomain: "lazapateria-c4157.firebaseapp.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.firebasestorage.app",
            messagingSenderId: "300241769138",
            appId: "1:300241769138:web:8ca1847de3c4fb5042afab",
            measurementId: "G-HVG7615JEE"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const citasCollection = db.collection('citasShowroom');

        // --- Definición de Días y Horarios (igual que en Showroom.txt) ---
        const currentYear = new Date().getFullYear();
        const yearForEvent = (new Date().getMonth() > 6 || (new Date().getMonth() === 6 && new Date().getDate() > 19)) ? currentYear + 1 : currentYear;

        const diasDisponibles = [
            { value: `${yearForEvent}-07-16`, text: `16 de Julio de ${yearForEvent} (Miércoles)` },
            { value: `${yearForEvent}-07-17`, text: `17 de Julio de ${yearForEvent} (Jueves)` },
            { value: `${yearForEvent}-07-18`, text: `18 de Julio de ${yearForEvent} (Viernes)` },
            { value: `${yearForEvent}-07-19`, text: `19 de Julio de ${yearForEvent} (Sábado)` }
        ];

        const todosLosHorarios = {
            morning: ["08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30"],
            afternoon: ["14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30"]
        };
        function obtenerHorariosParaDia(fechaValue) {
            if (fechaValue === `${yearForEvent}-07-19`) {
                return todosLosHorarios.morning;
            }
            return [...todosLosHorarios.morning, ...todosLosHorarios.afternoon];
        }


        // --- Elementos del DOM ---
        const citasTableBody = document.getElementById('citasTableBody');
        const noCitasMessage = document.getElementById('noCitasMessage');

        // Filtros
        const filterFabricante = document.getElementById('filterFabricante');
        // const filterTelefono = document.getElementById('filterTelefono'); // ELIMINADO
        const filterFecha = document.getElementById('filterFecha');
        const filterHora = document.getElementById('filterHora');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const exportExcelButton = document.getElementById('exportExcelButton');

        // Modales y sus elementos
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editFabricante = document.getElementById('editFabricante');
        // const editTelefono = document.getElementById('editTelefono'); // ELIMINADO
        const editDia = document.getElementById('editDia');
        const editHora = document.getElementById('editHora');

        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');

        const addModal = document.getElementById('addModal');
        const addForm = document.getElementById('addForm');
        const addFabricante = document.getElementById('addFabricante');
        // const addTelefono = document.getElementById('addTelefono'); // ELIMINADO
        const addDia = document.getElementById('addDia');
        const addHora = document.getElementById('addHora');
        const addCitaButton = document.getElementById('addCitaButton');

        const feedbackModal = document.getElementById('feedbackModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalOkButton = document.getElementById('modalOkButton');
        const generarCitaPdfButton = document.getElementById('generarCitaPdfButton');

        let currentEditingCitaId = null;
        let citaToDeleteId = null;
        let lastBookedAppointment = null; // Para generar PDF de la cita recién añadida

        // --- Funciones de Utilidad ---
        function convertTo12HourFormat(time24) {
            if (!time24) return "";
            const [hours, minutes] = time24.split(':');
            let h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12;
            return `${h}:${minutes} ${ampm}`;
        }

        function convertTo24HourFormat(time12) {
            if (!time12) return "";
            const [time, ampm] = time12.split(' ');
            let [hours, minutes] = time.split(':');
            hours = parseInt(hours);
            if (ampm === 'PM' && hours < 12) hours += 12;
            if (ampm === 'AM' && hours === 12) hours = 0; // Midnight (12 AM) is 00
            return `${String(hours).padStart(2, '0')}:${minutes}`;
        }

        function formatDateForDisplay(dateString) {
            const date = new Date(dateString + 'T00:00:00'); // Añadir 'T00:00:00' para evitar problemas de zona horaria
            return date.toLocaleDateString('es-CO', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        // --- Funciones para Cargar y Renderizar Citas ---
        async function loadCitas() {
            citasTableBody.innerHTML = '';
            noCitasMessage.style.display = 'none';
            try {
                let query = citasCollection.orderBy('timestamp', 'desc');

                const fabricanteFilter = filterFabricante.value.toLowerCase();
                // const telefonoFilter = filterTelefono.value; // ELIMINADO
                const fechaFilter = filterFecha.value;
                const horaFilter = filterHora.value;

                let citas = [];
                const snapshot = await query.get();
                snapshot.forEach(doc => {
                    citas.push({ id: doc.id, ...doc.data() });
                });

                const filteredCitas = citas.filter(cita => {
                    const matchesFabricante = fabricanteFilter ? cita.fabricante.toLowerCase().includes(fabricanteFilter) : true;
                    // const matchesTelefono = telefonoFilter ? cita.telefono.includes(telefonoFilter) : true; // ELIMINADO
                    const matchesFecha = fechaFilter ? cita.fecha === fechaFilter : true;
                    const matchesHora = horaFilter ? cita.hora === horaFilter : true;

                    return matchesFabricante && matchesFecha && matchesHora; // Se eliminó 'matchesTelefono'
                });

                if (filteredCitas.length === 0) {
                    noCitasMessage.style.display = 'block';
                    return;
                }

                filteredCitas.forEach(cita => {
                    const row = citasTableBody.insertRow();
                    row.className = 'hover:bg-gray-100';

                    row.insertCell(0).textContent = cita.fabricante;
                    // row.insertCell(1).textContent = cita.telefono; // ELIMINADO
                    row.insertCell(1).textContent = formatDateForDisplay(cita.fecha);
                    row.insertCell(2).textContent = convertTo12HourFormat(cita.hora);

                    const actionsCell = row.insertCell(3);
                    actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';

                    const editButton = document.createElement('button');
                    editButton.textContent = 'Editar';
                    editButton.className = 'text-indigo-600 hover:text-indigo-900 mr-4';
                    editButton.onclick = () => openEditModal(cita.id);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Eliminar';
                    deleteButton.className = 'text-red-600 hover:text-red-900';
                    deleteButton.onclick = () => openDeleteConfirmModal(cita.id);
                    actionsCell.appendChild(deleteButton);
                });

            } catch (error) {
                console.error("Error al cargar citas: ", error);
                alert("Error al cargar citas. Consulte la consola para más detalles.");
            }
        }

        // --- Funciones para Populares Filtros ---
        async function populateFilterOptions() {
            // Populate Fecha
            diasDisponibles.forEach(dia => {
                const option = document.createElement('option');
                option.value = dia.value;
                option.textContent = dia.text;
                filterFecha.appendChild(option);
            });

            // Populate Hora
            const allHours = [...new Set([...todosLosHorarios.morning, ...todosLosHorarios.afternoon])].sort();
            allHours.forEach(hora24 => {
                const option = document.createElement('option');
                option.value = hora24;
                option.textContent = convertTo12HourFormat(hora24);
                filterHora.appendChild(option);
            });

            loadCitas(); // Cargar citas después de popular los filtros
        }

        // --- Funciones de Filtrado ---
        function applyFilters() {
            loadCitas(); // Re-cargar citas con los filtros aplicados
        }

        function clearAllFilters() {
            filterFabricante.value = '';
            // filterTelefono.value = ''; // ELIMINADO
            filterFecha.value = '';
            filterHora.value = '';
            loadCitas();
        }

        // --- Funciones del Modal de Edición ---
        async function openEditModal(citaId) {
            currentEditingCitaId = citaId;
            try {
                const doc = await citasCollection.doc(citaId).get();
                if (doc.exists) {
                    const data = doc.data();
                    editFabricante.value = data.fabricante;
                    // editTelefono.value = data.telefono; // ELIMINADO
                    
                    // Poblar días en el modal de edición
                    editDia.innerHTML = '';
                    diasDisponibles.forEach(dia => {
                        const option = document.createElement('option');
                        option.value = dia.value;
                        option.textContent = dia.text;
                        editDia.appendChild(option);
                    });
                    editDia.value = data.fecha;

                    // Poblar horas para el día seleccionado en el modal de edición
                    await updateEditModalHours(data.fecha, data.hora);

                    editModal.style.display = 'flex'; // Usar flex para centrar
                } else {
                    alert("Cita no encontrada.");
                }
            } catch (error) {
                console.error("Error al abrir modal de edición: ", error);
                alert("Error al cargar datos de la cita.");
            }
        }

        function closeEditModal() {
            editModal.style.display = 'none';
            editForm.reset();
        }

        async function updateEditModalHours(selectedDate, currentHour = null) {
            editHora.innerHTML = '<option value="" disabled selected>Seleccione una hora</option>';
            const horariosBase = obtenerHorariosParaDia(selectedDate);

            try {
                const querySnapshot = await citasCollection.where('fecha', '==', selectedDate).get();
                const horariosOcupados = querySnapshot.docs.map(doc => doc.data().hora);

                horariosBase.forEach(hora24 => {
                    const option = document.createElement('option');
                    option.value = hora24;
                    option.textContent = convertTo12HourFormat(hora24);
                    
                    // Si la hora está ocupada y no es la hora actual de la cita que se está editando
                    if (horariosOcupados.includes(hora24) && hora24 !== currentHour) {
                        option.disabled = true;
                        option.textContent += ' (Ocupado)';
                    }
                    editHora.appendChild(option);
                });

                if (currentHour) {
                    editHora.value = currentHour;
                }

            } catch (error) {
                console.error("Error al cargar horarios para edición: ", error);
            }
        }

        editDia.addEventListener('change', () => updateEditModalHours(editDia.value));


        editForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!currentEditingCitaId) return;

            const updatedFabricante = editFabricante.value;
            // const updatedTelefono = editTelefono.value; // ELIMINADO
            const updatedFecha = editDia.value;
            const updatedHora = editHora.value;

            try {
                // Verificar si el nuevo horario ya está ocupado por otra cita (que no sea la que estamos editando)
                const snapshot = await citasCollection
                    .where('fecha', '==', updatedFecha)
                    .where('hora', '==', updatedHora)
                    .get();

                const isOccupiedByAnother = snapshot.docs.some(doc => doc.id !== currentEditingCitaId);

                if (isOccupiedByAnother) {
                    mostrarFeedback("Este horario ya está ocupado por otra cita. Por favor, seleccione otro.", true);
                    return;
                }

                await citasCollection.doc(currentEditingCitaId).update({
                    fabricante: updatedFabricante,
                    // telefono: updatedTelefono, // ELIMINADO
                    fecha: updatedFecha,
                    hora: updatedHora
                });
                mostrarFeedback("Cita actualizada con éxito.", false);
                closeEditModal();
                loadCitas();
            } catch (error) {
                console.error("Error al actualizar cita: ", error);
                mostrarFeedback("Error al actualizar cita. Inténtelo de nuevo.", true);
            }
        });

        // --- Funciones del Modal de Borrado ---
        function openDeleteConfirmModal(citaId) {
            citaToDeleteId = citaId;
            deleteConfirmModal.style.display = 'flex';
        }

        function closeDeleteConfirmModal() {
            deleteConfirmModal.style.display = 'none';
            citaToDeleteId = null;
        }

        confirmDeleteButton.addEventListener('click', async function() {
            if (!citaToDeleteId) return;
            try {
                await citasCollection.doc(citaToDeleteId).delete();
                mostrarFeedback("Cita eliminada con éxito.", false);
                closeDeleteConfirmModal();
                loadCitas();
            } catch (error) {
                console.error("Error al eliminar cita: ", error);
                mostrarFeedback("Error al eliminar cita. Inténtelo de nuevo.", true);
            }
        });

        // --- Funciones del Modal de Agregar Cita ---
        function openAddModal() {
            addForm.reset();
            // Poblar días en el modal de agregar
            addDia.innerHTML = '<option value="" disabled selected>Seleccione un día</option>';
            diasDisponibles.forEach(dia => {
                const option = document.createElement('option');
                option.value = dia.value;
                option.textContent = dia.text;
                addDia.appendChild(option);
            });
            addHora.innerHTML = '<option value="" disabled selected>Seleccione una hora</option>';
            addHora.disabled = true; // Deshabilitar horas hasta que se seleccione un día
            addModal.style.display = 'flex';
        }

        function closeAddModal() {
            addModal.style.display = 'none';
            addForm.reset();
        }

        // Event listener para el cambio de día en el modal de agregar
        addDia.addEventListener('change', async function() {
            const selectedDate = addDia.value;
            addHora.innerHTML = '<option value="" disabled selected>Seleccione una hora</option>'; // Reset
            addHora.disabled = true;

            if (!selectedDate) return;

            try {
                const horariosBase = obtenerHorariosParaDia(selectedDate);
                const querySnapshot = await citasCollection.where('fecha', '==', selectedDate).get();
                const horariosOcupados = querySnapshot.docs.map(doc => doc.data().hora);

                horariosBase.forEach(hora24 => {
                    const option = document.createElement('option');
                    option.value = hora24;
                    option.textContent = convertTo12HourFormat(hora24);
                    if (horariosOcupados.includes(hora24)) {
                        option.disabled = true;
                        option.textContent += ' (Ocupado)';
                    }
                    addHora.appendChild(option);
                });
                addHora.disabled = false;
            } catch (error) {
                console.error("Error cargando horarios para agregar cita: ", error);
            }
        });


        addForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const fabricante = addFabricante.value;
            // const telefono = addTelefono.value; // ELIMINADO
            const fecha = addDia.value;
            const hora24 = addHora.value;

            if (!fabricante || !fecha || !hora24) { // Se eliminó 'telefono'
                mostrarFeedback("Por favor, complete todos los campos.", true);
                return;
            }

            try {
                const snapshot = await citasCollection.where('fecha', '==', fecha).where('hora', '==', hora24).get();
                if (!snapshot.empty) {
                    mostrarFeedback("Lo sentimos, este horario ya está ocupado. Por favor, seleccione otro.", true);
                    // Actualizar horarios del modal de agregar si está abierto
                    addDia.dispatchEvent(new Event('change'));
                    return;
                }

                await citasCollection.add({
                    fabricante: fabricante,
                    // telefono: telefono, // ELIMINADO
                    fecha: fecha,
                    hora: hora24,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                const hora12Display = convertTo12HourFormat(hora24);
                const fechaFormateada = formatDateForDisplay(fecha);
                
                // Guardar los detalles de la cita recién agendada para el PDF
                lastBookedAppointment = {
                    fabricante: fabricante,
                    // telefono: telefono, // ELIMINADO
                    fecha: fechaFormateada,
                    hora: hora12Display
                };

                mostrarFeedback(`¡Cita para ${fabricante} el ${fechaFormateada} a las ${hora12Display} agregada con éxito!`, false, true);
                closeAddModal();
                loadCitas();
            } catch (error) {
                console.error("Error al agregar cita: ", error);
                mostrarFeedback("Error al agregar la cita. Inténtelo de nuevo.", true, false);
            }
        });

        // --- Funciones para Exportar a Excel ---
        async function exportToExcel() {
            try {
                const querySnapshot = await citasCollection.orderBy('timestamp', 'desc').get();
                const data = [];
                querySnapshot.forEach(doc => {
                    const cita = doc.data();
                    data.push({
                        Fabricante: cita.fabricante,
                        // Teléfono: cita.telefono, // ELIMINADO
                        Fecha: formatDateForDisplay(cita.fecha),
                        Hora: convertTo12HourFormat(cita.hora),
                        'Fecha de Creación': cita.timestamp ? new Date(cita.timestamp.toDate()).toLocaleString('es-CO') : 'N/A'
                    });
                });

                if (data.length === 0) {
                    alert("No hay datos para exportar.");
                    return;
                }

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Citas Showroom");
                XLSX.writeFile(wb, "Citas_Showroom.xlsx");

            } catch (error) {
                console.error("Error al exportar a Excel: ", error);
                alert("Error al exportar datos a Excel.");
            }
        }

        // Función para generar el PDF de la cita agendada
        function generarCitaPDF(citaDetails) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const margen = 20;
            let yPos = margen;
            // Header con logo (placeholder) y título
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(46, 139, 87); // Verde mar
            doc.text("Confirmación de Cita", margen, yPos);
            yPos += 10;
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0); // Negro
            doc.text("Show Room La Zapatería", margen, yPos);
            yPos += 20;

            // Línea separadora
            doc.setDrawColor(46, 139, 87); // Verde mar
            doc.setLineWidth(0.5);
            doc.line(margen, yPos, doc.internal.pageSize.width - margen, yPos);
            yPos += 15;

            // Detalles de la cita
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(51, 51, 51); // Gris oscuro

            doc.text("Estimado/a Fabricante:", margen, yPos);
            yPos += 10;
            doc.text("Su cita ha sido agendada con éxito. A continuación, los detalles:", margen, yPos);
            yPos += 15;
            doc.setFont(undefined, 'bold');
            doc.text("Fabricante:", margen, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(citaDetails.fabricante, margen + 30, yPos);
            yPos += 10;

            // Se eliminó la línea de teléfono del PDF
            /*
            doc.setFont(undefined, 'bold');
            doc.text("Teléfono:", margen, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(citaDetails.telefono, margen + 30, yPos);
            yPos += 10;
            */

            doc.setFont(undefined, 'bold');
            doc.text("Fecha:", margen, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(citaDetails.fecha, margen + 30, yPos);
            yPos += 10;

            doc.setFont(undefined, 'bold');
            doc.text("Hora:", margen, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(citaDetails.hora, margen + 30, yPos);
            yPos += 20;

            // Mensaje final
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.text("Agradecemos su preferencia. ¡Le esperamos!", margen, yPos);
            yPos += 15;
            // Footer
            doc.setDrawColor(46, 139, 87); // Verde mar
            doc.line(margen, doc.internal.pageSize.height - margen - 10, doc.internal.pageSize.width - margen, doc.internal.pageSize.height - margen - 10);
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100); // Gris
            doc.text("La Zapatería - Evento Show Room", margen, doc.internal.pageSize.height - margen);
            doc.text(`Generado el: ${new Date().toLocaleDateString('es-CO')} ${new Date().toLocaleTimeString('es-CO')}`, doc.internal.pageSize.width - margen, doc.internal.pageSize.height - margen, { align: 'right' });


            doc.save(`Cita_ShowRoom_${citaDetails.fabricante}.pdf`);
        }


        // --- Event Listeners Globales ---
        filterFabricante.addEventListener('input', applyFilters);
        // filterTelefono.addEventListener('input', applyFilters); // ELIMINADO
        filterFecha.addEventListener('change', applyFilters);
        filterHora.addEventListener('change', applyFilters);
        clearFiltersButton.addEventListener('click', clearAllFilters);
        exportExcelButton.addEventListener('click', exportToExcel);
        addCitaButton.addEventListener('click', openAddModal);

        // Event listener para el botón de PDF de la cita en el modal de feedback
        generarCitaPdfButton.addEventListener('click', function() {
            if (lastBookedAppointment) {
                generarCitaPDF(lastBookedAppointment);
            } else {
                modalMessage.textContent = "No hay una cita reciente para generar el PDF.";
                modalMessage.className = 'text-lg mb-4 text-red-600';
                generarCitaPdfButton.style.display = 'none'; // Asegurarse de que no se muestre si no hay cita
            }
        });

        // Funciones de control de modales
        modalOkButton.onclick = function() {
            feedbackModal.style.display = "none";
        }
        function mostrarFeedback(message, isError = false, showCitaPdfButton = false) {
            modalMessage.textContent = message;
            modalMessage.className = isError ? 'text-lg mb-4 text-red-600' : 'text-lg mb-4 text-green-700';
            if (showCitaPdfButton) {
                generarCitaPdfButton.style.display = 'inline-block';
            } else {
                generarCitaPdfButton.style.display = 'none';
            }
            feedbackModal.style.display = 'flex'; // Usar flex para centrar
        }
        window.onclick = function(event) {
            if (event.target == editModal) {
                closeEditModal();
            }
            if (event.target == addModal) { // Cerrar modal de agregar
                closeAddModal();
            }
            if (event.target == deleteConfirmModal) {
                closeDeleteConfirmModal();
            }
            if (event.target == feedbackModal) {
                feedbackModal.style.display = "none";
            }
        }
        
        // --- Inicialización ---
        populateFilterOptions();
    </script>
</body>
</html>
