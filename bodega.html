<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Bodega</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
  h1 { text-align: center; color: #2e7d32; }
  .top-bar { display: flex; justify-content: center; margin: 10px 0 20px; }
  .btn { background-color: #2e7d32; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; transition: background 0.2s ease; font-size: 0.95em; margin: 0 5px; }
  .btn:hover { background-color: #256628; }
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
  .card { background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 20px; text-align: center; cursor: pointer; transition: transform 0.2s ease; }
  .card:hover { transform: translateY(-5px); }
  .nombre { font-weight: 600; font-size: 1.1em; color: #333; }
  .contador { font-size: 2.5em; font-weight: 700; margin: 10px 0; border-radius: 50%; width: 80px; height: 80px; line-height: 80px; display: inline-block; color: white; }
  .verde { background-color: #28a745; }
  .naranja { background-color: #ffc107; }
  .rojo { background-color: #dc3545; }
  .ultimo-update { font-size: 0.8em; color: #777; margin-top: 10px; }

  /* Modal */
  .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  .modal-content { background-color: #fff; border-radius: 12px; padding: 20px; width: 95%; max-width: 900px; max-height: 85%; overflow-y: auto; box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .modal-header h2 { margin: 0; color: #2e7d32; }
  .close { cursor: pointer; font-size: 1.5em; color: #333; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95em; }
  th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; }
  th { background-color: #f8f8f8; }
  #listaBodegueros { margin-top: 10px; }
  #listaBodegueros label { display: block; margin-bottom: 5px; cursor: pointer; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
  authDomain: "lazapateria-c4157.firebaseapp.com",
  projectId: "lazapateria-c4157",
  storageBucket: "lazapateria-c4157.firebasestorage.app",
  messagingSenderId: "300241769138",
  appId: "1:300241769138:web:8ca1847de3c4fb5042afab",
  measurementId: "G-HVG7615JEE"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let cacheRegistros = [];
let modoHistorial = false;
let bodeguerosDisponibles = [];

// Cargar todos los bodegueros desde Firebase
async function cargarBodegueros() {
  try {
    const snapshot = await db.collection('usuarios').get();
    bodeguerosDisponibles = snapshot.docs
      .map(d => {
        const data = d.data();
        if (data.permisos === "Bodeguero") {
          return data.nombreCompleto || d.id;
        }
        return null;
      })
      .filter(n => n !== null);
    console.log("Bodegueros disponibles:", bodeguerosDisponibles);
  } catch (error) {
    console.error("Error cargando bodegueros:", error);
    bodeguerosDisponibles = [];
  }
}

// Cargar panel de bodega
async function cargarPanelBodega() {
  await cargarBodegueros();
  const contenedor = document.getElementById('panel');
  contenedor.innerHTML = '<p>Cargando informaciÃ³n...</p>';

  db.collectionGroup('registros').onSnapshot(snapshot => {
    const conteo = {};
    cacheRegistros = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      cacheRegistros.push({ id: doc.id, ...data });

      const despachado = data.despachado === true || data.despachado === "si" || data.despachado === "despachado";
      if (modoHistorial && !despachado) return;
      if (!modoHistorial && despachado) return;

      if (Array.isArray(data.bodegueros_encargados)) {
        data.bodegueros_encargados.forEach(nombre => {
          if (nombre && nombre.trim() !== "") {
            conteo[nombre] = (conteo[nombre] || 0) + 1;
          }
        });
      }
    });

    renderizarPanel(contenedor, conteo);
  });
}

// Renderizar panel
function renderizarPanel(contenedor, conteo) {
  contenedor.innerHTML = '';
  const nombres = Object.keys(conteo);
  if (nombres.length === 0) {
    contenedor.innerHTML = '<p style="text-align:center;color:#666;">No hay registros en este momento.</p>';
    return;
  }
  nombres.sort((a,b) => conteo[b]-conteo[a]);

  nombres.forEach(nombre=>{
    const cantidad = conteo[nombre];
    let color='verde';
    if(cantidad>=16 && cantidad<=22) color='naranja';
    if(cantidad>=23) color='rojo';
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <div class="nombre">${nombre}</div>
      <div class="contador ${color}">${cantidad}</div>
      <div class="ultimo-update">Actualizado: ${new Date().toLocaleTimeString()}</div>
    `;
    card.onclick=()=>mostrarDetalles(nombre);
    contenedor.appendChild(card);
  });
}

// Mostrar detalles
function mostrarDetalles(nombre){
  const modal=document.getElementById('detalleModal');
  const body=document.getElementById('modalBody');
  modal.style.display='flex';
  body.innerHTML='<p>Cargando informaciÃ³n...</p>';

  const registrosBodeguero = cacheRegistros.filter(r=>{
    const despachado = r.despachado===true || r.despachado==="si" || r.despachado==="despachado";
    if(modoHistorial && !despachado) return false;
    if(!modoHistorial && despachado) return false;
    return Array.isArray(r.bodegueros_encargados) && r.bodegueros_encargados.includes(nombre);
  });

  if(registrosBodeguero.length===0){
    body.innerHTML=`<p style="text-align:center;color:#555;">No hay ${modoHistorial?'registros despachados':'despachos activos'} para ${nombre}.</p>`;
    return;
  }

  let totalValor=0;
  let totalPares=0;
  const filas=registrosBodeguero.map(r=>{
    const cliente=r.cliente||'â€”';
    const asesor=r.asesor||r.asesor_asignado||'â€”';
    const valor=Number(r.valor_total||r.valor||0);
    const paresField=Object.keys(r).find(k=>k.toLowerCase().includes('pares'));
    const pares=Number(r[paresField]||0);
    const fechaCampo=Object.keys(r).find(k=>k.toLowerCase().includes('fecha')||k.toLowerCase().includes('hora'));
    let fechaAsignacion='â€”';
    if(fechaCampo && r[fechaCampo]){
      const f=r[fechaCampo];
      fechaAsignacion=f.toDate?f.toDate().toLocaleString():new Date(f).toLocaleString();
    }
    totalValor+=valor;
    totalPares+=pares;
    return `<tr>
      <td>${cliente}</td>
      <td>${asesor}</td>
      <td>${valor.toLocaleString('es-CO')}</td>
      <td>${pares}</td>
      <td>${fechaAsignacion}</td>
      <td><button class="btn" onclick="editarRegistro('${r.id}')">Editar</button></td>
    </tr>`;
  }).join('');

  body.innerHTML=`
    <table>
      <thead>
        <tr><th>Cliente</th><th>Asesor</th><th>Valor</th><th>Pares</th><th>Hora AsignaciÃ³n</th><th>Editar</th></tr>
      </thead>
      <tbody>${filas}</tbody>
    </table>
    <p><strong>Total valor:</strong> ${totalValor.toLocaleString('es-CO')} â€” <strong>Total pares:</strong> ${totalPares}</p>
  `;
}

// Cerrar modal
function cerrarModal(){ document.getElementById('detalleModal').style.display='none'; }
function cambiarModo(historial){ modoHistorial=historial; document.getElementById('tituloPanel').innerText=historial?'Historial de Bodega':'Panel de Bodega'; cargarPanelBodega(); }

// === EDITAR CON CHECKBOX ===
async function editarRegistro(id) {
  const registro = cacheRegistros.find(r => r.id === id);
  if (!registro) return alert("Registro no encontrado");

  const body = document.getElementById('modalBody');
  body.innerHTML = `
    <h3>Selecciona los bodegueros</h3>
    <div id="listaBodegueros"></div>
    <button class="btn" style="margin-top:10px;" onclick="guardarEdicion('${id}')">Guardar</button>
  `;

  const lista = document.getElementById('listaBodegueros');
  bodeguerosDisponibles.forEach(b => {
    const div = document.createElement('div');
    div.innerHTML = `
      <label>
        <input type="checkbox" value="${b}" ${registro.bodegueros_encargados.includes(b) ? 'checked' : ''}>
        ${b}
      </label>
    `;
    lista.appendChild(div);
  });
}

async function guardarEdicion(id) {
  const checkboxes = document.querySelectorAll('#listaBodegueros input[type="checkbox"]:checked');
  const seleccionados = Array.from(checkboxes).map(c => c.value);

  try {
    const registrosSnapshot = await db.collectionGroup('registros').where('id', '==', id).get();
    if (!registrosSnapshot.empty) {
      const docRef = registrosSnapshot.docs[0].ref;
      await docRef.update({ bodegueros_encargados: seleccionados });
    }
    alert("Bodegueros actualizados correctamente");
    cerrarModal();
    cargarPanelBodega();
  } catch (e) {
    console.error(e);
    alert("Error al actualizar");
  }
}

window.onload = cargarPanelBodega;
</script>
</head>
<body>
<h1 id="tituloPanel">Panel de Bodega</h1>
<div class="top-bar">
  <button class="btn" onclick="cambiarModo(false)">ðŸ“¦ Despachos Activos</button>
  <button class="btn" onclick="cambiarModo(true)">ðŸ•’ Historial</button>
</div>
<div id="panel" class="grid"></div>

<!-- Modal -->
<div id="detalleModal" class="modal" onclick="if(event.target===this)cerrarModal()">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Detalles del Bodeguero</h2>
      <span class="close" onclick="cerrarModal()">&times;</span>
    </div>
    <div id="modalBody"></div>
  </div>
</div>
</body>
</html>
