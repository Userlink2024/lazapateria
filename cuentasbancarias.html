<!-- ================= PARTE 1 ================= -->
<!-- Estructura completa del HTML (SIN el <script>) -->

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Consignaciones - Actualizado</title>

  <style>
    :root{
      --bg:#f3f6fb; --card:#fff; --accent:#2563eb; --muted:#6b7280;
      --border:#e6e9ef; --danger:#dc2626; --ok:#10b981;
      --admin-gray:#e5e7eb; /* gris pedido */
      --manager-yellow:#fff7c2; /* amarillo pedido */
    }
    *{box-sizing:border-box}
    body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#0f172a}
    #topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:var(--card);border-bottom:1px solid var(--border)}
    .layout{display:flex;height:calc(100vh - 56px)}
    .sidebar{width:320px;padding:16px;background:#fff;border-right:1px solid var(--border);overflow:auto}
    .main{flex:1;padding:18px;overflow:auto}
    h2,h3{margin:0 0 8px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], input[type=date], select, textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:#fff}
    textarea{resize:vertical}
    .btn{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn.ghost{background:#f1f5f9;color:#0f172a}
    .btn.danger{background:var(--danger)}
    .panel{background:var(--card);padding:12px;border-radius:8px;border:1px solid var(--border);box-shadow:0 2px 6px rgba(15,23,42,0.03);margin-bottom:12px}
    .account-item{padding:10px;border-radius:6px;border:1px solid var(--border);margin-bottom:8px;cursor:pointer;background:#fff}
    .account-item.selected{border-left:4px solid var(--accent);background:#f0f6ff}
    .flex-row{display:flex;gap:8px;align-items:center}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border:1px solid var(--border);background:transparent}
    tr.verified-admin{background:var(--admin-gray)}
    tr.verified-gerente{background:var(--manager-yellow)}
    tr.separator{background:#eef2ff;font-weight:700;text-align:center}
    tr.sep-green{background:#d1fae5!important}
    tr.sep-red{background:#fee2e2!important}
    .muted{color:var(--muted);font-size:13px}
    .top-totals{display:flex;gap:12px;align-items:center}
    .top-totals .card{padding:8px;border-radius:8px;border:1px solid var(--border);background:#fff}
    .small{font-size:12px;color:var(--muted)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center}
    .modal .card{width:720px;max-width:96%;padding:16px}
    .hidden{display:none}
    .gear{cursor:pointer;padding:6px;border-radius:6px;border:1px solid var(--border);background:#fff}
  </style>
</head>
<body>

  <div id="topbar">
    <div style="display:flex;gap:12px;align-items:center">
      <strong>Sistema de Consignaciones</strong>
      <div class="small">Formato: FECHA / VALOR / FECHA OBS</div>
    </div>

    <div class="top-totals">
      <div class="card small">
        <div class="muted">Total general (todas las cuentas)</div>
        <div id="total-general">0</div>
      </div>
      <div class="card small">
        <div class="muted">Total cuenta seleccionada</div>
        <div id="total-cuenta">0</div>
      </div>
      <div class="card small">
        <div class="muted">Sesión</div>
        <div id="user-info">cargando...</div>
      </div>
      <button id="open-options" class="btn ghost">Opciones</button>
      <button id="logout" class="btn ghost">Salir</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <h3>Buscar / Cuentas</h3>

      <label>Buscar por nombre</label>
      <input id="search-name" type="text" placeholder="Nombre...">

      <label style="margin-top:10px">Buscar por número de cuenta</label>
      <input id="search-account" type="text" placeholder="000000...">

      <div style="margin-top:12px" class="panel">
        <h4 style="margin-bottom:8px">Agregar nueva cuenta</h4>
        <label>Nombre</label>
        <input id="new-account-name" type="text">
        <label style="margin-top:8px">Número</label>
        <input id="new-account-number" type="text">
        <div style="margin-top:8px" class="flex-row">
          <button id="add-account" class="btn" style="flex:1">Agregar</button>
        </div>
      </div>

      <div>
        <div class="muted" style="margin-bottom:6px">Cuentas</div>
        <div id="accounts-list" style="max-height:50vh;overflow:auto"></div>
      </div>
    </div>

    <div class="main">

      <div class="panel">
        <h3>Agregar consignación</h3>
        <div id="selected-account-info" class="muted" style="margin-bottom:8px">Ninguna cuenta seleccionada</div>

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label>FECHA</label>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label><input type="radio" name="dateOpt" value="today"> Hoy</label>
              <label><input type="radio" name="dateOpt" value="yesterday"> Ayer</label>
              <label><input type="radio" name="dateOpt" value="daybefore"> Antier</label>
              <label style="margin-left:6px">Manual</label>
              <input id="date-picker" type="date">
            </div>
          </div>

          <div style="flex:1">
            <label>FECHA DE OBSERVACIÓN</label>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label><input type="radio" name="obsOpt" value="today"> Hoy</label>
              <label><input type="radio" name="obsOpt" value="yesterday"> Ayer</label>
              <label><input type="radio" name="obsOpt" value="daybefore"> Antier</label>
              <label style="margin-left:6px">Manual</label>
              <input id="obsdate-picker" type="date">
            </div>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:end">
          <div style="flex:1">
            <label>VALOR (COP)</label>
            <input id="valor" type="number" placeholder="0">
          </div>
          <div style="width:220px">
            <button id="add-consign" class="btn" style="width:100%">Agregar consignación</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Lista de consignaciones (FECHA / VALOR / FECHA OBS)</h

<!-- ================= PARTE 2 ================= -->
<!-- SCRIPT COMPLETO -->
<script>
// ======================== VARIABLES GLOBALES ========================
const $ = id => document.getElementById(id);
let selectedAccountId = null;
let sessionRole = null;   // "Admin" o "Gerente"
let usuario = {};
let managerPass = "1234"; // Ajustable

// ======================== MODALES ========================
function showModal(msg, type="info"){
  const box = document.getElementById("app-modal-box");
  const colors = {
    info: "#2563eb",
    success: "#16a34a",
    warning: "#facc15",
    error: "#dc2626"
  };
  box.style.border = `3px solid ${colors[type]}`;
  $("app-modal-msg").innerHTML = msg;
  $("app-modal").classList.remove("hidden");
}
function hideModal(){ $("app-modal").classList.add("hidden"); }

// Modal tipo PROMPT (clave gerente)
let promptCallback = null;
function showPromptModal(msg, cb){
  promptCallback = cb;
  $("prompt-message").innerHTML = msg;
  $("prompt-input").value = "";
  $("prompt-modal").classList.remove("hidden");
  setTimeout(() => $("prompt-input").focus(), 50);
}
function submitPrompt(){
  const val = $("prompt-input").value;
  $("prompt-modal").classList.add("hidden");
  if (promptCallback) promptCallback(val);
}
function closePrompt(){
  $("prompt-modal").classList.add("hidden");
  if(promptCallback) promptCallback(null);
}

// ======================== FIREBASE ========================
const firebaseConfig = {
  apiKey: "xxxx",
  authDomain: "xxxx",
  projectId: "xxxx",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ======================== SESIÓN ========================
function loadSession(){
  usuario = { usuario:"Gerente", rol:"Gerente" };
  sessionRole = usuario.rol;
  $("user-info").innerHTML = `${usuario.usuario} / ${sessionRole}`;
}
loadSession();

// ======================== LISTAR CUENTAS ========================
async function loadAccounts(){
  const cont = $("accounts-list");
  cont.innerHTML = "Cargando...";
  const snap = await db.collection("cuentas").get();
  let html = "";
  snap.forEach(doc =>{
    const d = doc.data();
    html += `<div class='account-item' data-id='${doc.id}'>${d.nombre}<br><span class='small'>${d.numero}</span></div>`;
  });
  cont.innerHTML = html;

  [...cont.querySelectorAll('.account-item')].forEach(el=>{
    el.onclick = ()=> selectAccount(el.dataset.id, el);
  });
}
loadAccounts();

// ======================== SELECCIONAR CUENTA ========================
function selectAccount(id, el){
  selectedAccountId = id;
  [...document.querySelectorAll('.account-item')].forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
  $("selected-account-info").innerHTML = `Cuenta seleccionada: ${el.innerText}`;
  loadConsigns();
}

// ======================== AGREGAR CUENTA ========================
$("add-account").onclick = async () =>{
  const nombre = $("new-account-name").value.trim();
  const numero = $("new-account-number").value.trim();
  if(!nombre || !numero) return showModal("Debe llenar todos los campos", "warning");

  await db.collection("cuentas").add({nombre, numero});
  showModal("Cuenta agregada", "success");
  loadAccounts();
};

// ======================== AGREGAR CONSIGNACIÓN ========================
$("add-consign").onclick = async ()=>{
  if(!selectedAccountId) return showModal("Seleccione una cuenta", "warning");

  const valor = Number($("valor").value);
  if(!valor) return showModal("Ingrese un valor válido", "warning");

  let fecha = getDateFromRadios("dateOpt", "date-picker");
  let fechaObs = getDateFromRadios("obsOpt", "obsdate-picker");

  const col = db.collection("cuentas").doc(selectedAccountId).collection("consignaciones");
  await col.add({
    fecha,
    fechaObs,
    valor,
    verifiedBy:null,
    verifiedRole:null,
    isSeparator:false,
    locked:false,
    timestamp: firebase.firestore.Timestamp.now()
  });

  showModal("Consignación agregada", "success");
  loadConsigns();
};

function getDateFromRadios(name, picker){
  const val = document.querySelector(`input[name="${name}"]:checked`);
  let d = new Date();
  if(val){
    if(val.value === "yesterday") d.setDate(d.getDate()-1);
    if(val.value === "daybefore") d.setDate(d.getDate()-2);
    return d.toISOString().substring(0,10);
  }
  const pk = $(picker).value;
  return pk || new Date().toISOString().substring(0,10);
}

// ======================== CARGAR CONSIGNACIONES ========================
async function loadConsigns(){
  if(!selectedAccountId) return;
  const tbody = document.querySelector('#cons-table-body');
  if(!tbody) return;

  const snap = await db.collection("cuentas")
    .doc(selectedAccountId)
    .collection("consignaciones")
    .orderBy('timestamp','asc')
    .get();

  let html = "";
  let totalCuenta = 0;

  snap.forEach(doc=>{
    const d = doc.data();
    if(d.isSeparator){
      html += `<tr class='separator ${d.type==="green"?"sep-green":"sep-red"}'><td colspan='4'>${d.label} — ${d.total || ""}</td></tr>`;
      return;
    }

    totalCuenta += Number(d.valor || 0);

    let cls = "";
    if(d.verifiedRole === "Admin") cls = "verified-admin";
    if(d.verifiedRole === "Gerente") cls = "verified-gerente";

    html += `
    <tr class='${cls}'>
      <td><input type='checkbox' data-id='${doc.id}'></td>
      <td>${d.fecha}</td>
      <td>${Number(d.valor).toLocaleString()}</td>
      <td>${d.fechaObs}</td>
    </tr>`;
  });

  tbody.innerHTML = html;
  $("total-cuenta").innerHTML = totalCuenta.toLocaleString();
}

// ======================== SELECCIÓN ========================
function getSelectedConsignIds(){
  return [...document.querySelectorAll('#cons-table-body input[type=checkbox]:checked')]
    .map(x => x.dataset.id);
}

// ======================== SEGURIDAD PARA BLOQUEADAS ========================
async function verifyAccessForLocked(id){
  const col = db.collection("cuentas").doc(selectedAccountId).collection("consignaciones");
  const doc = await col.doc(id).get();
  const d = doc.data();

  if(!d.locked) return true;
  if(sessionRole !== "Gerente"){
    showModal("Esta consignación pertenece a un bloque cerrado.", "error");
    return false;
  }

  return new Promise(resolve=>{
    showPromptModal("Consignación cerrada. Ingrese clave del Gerente:", (v)=>{
      if(v===managerPass) resolve(true);
      else{
        showModal("Clave incorrecta", "error");
        resolve(false);
      }
    });
  });
}

// ======================== VERIFICAR ========================
$("btn-verify").onclick = async ()=>{
  const ids = getSelectedConsignIds();
  if(ids.length===0) return showModal("Seleccione consignaciones", "warning");

  const col = db.collection("cuentas").doc(selectedAccountId).collection("consignaciones");

  for(let id of ids){
    const ok = await verifyAccessForLocked(id);
    if(!ok) return;
  }

  const batch = db.batch();
  ids.forEach(id => batch.update(col.doc(id),{ verifiedBy:usuario.usuario, verifiedRole:sessionRole }));
  await batch.commit();
  showModal("Verificadas", "success");
  loadConsigns();
};

// ======================== DESVERIFICAR ========================
$("btn-unverify").onclick = async ()=>{
  const ids = getSelectedConsignIds();
  if(ids.length===0) return showModal("Seleccione consignaciones", "warning");

  const col = db.collection("cuentas").doc(selectedAccountId).collection("consignaciones");
  const snap = await col.get();

  for(let id of ids){
    const d = snap.docs.find(x=>x.id===id).data();
    if(d.verifiedRole === "Gerente" && sessionRole!=="Gerente")
      return showModal("Solo el Gerente puede desverificar lo verificado por Gerente","error");
  }
  for(let id of ids){
    const ok = await verifyAccess


<!-- ================= CONTINUACIÓN PARTE 2 ================= -->
<script>
// Continúa el bloque que quedó cortado:

// ======= Continuación DESVERIFICAR =======
    const ok2 = await verifyAccessForLocked(id);
    if(!ok2) return;
  }

  try{
    const batch2 = db.batch();
    ids.forEach(id => batch2.update(col.doc(id), {
      verifiedBy:null,
      verifiedRole:null
    }));
    await batch2.commit();
    showModal("Desverificadas.", "success");
    loadConsigns();
  }catch(e){ console.error(e); showModal("Error: "+e.message, "error"); }
};

// ======================== ELIMINAR ========================
$("btn-delete").onclick = async ()=>{
  if(sessionRole !== "Gerente") return showModal("Solo Gerente puede eliminar.", "error");

  const ids = getSelectedConsignIds();
  if(ids.length===0) return showModal("Seleccione consignaciones", "warning");

  // verificar locked
  for(let id of ids){
    const ok = await verifyAccessForLocked(id);
    if(!ok) return;
  }

  showPromptModal("Confirme eliminando: ingrese clave del Gerente", async v=>{
    if(v!==managerPass) return showModal("Clave incorrecta","error");

    const col = db.collection("cuentas").doc(selectedAccountId).collection("consignaciones");

    try{
      const batch = db.batch();
      ids.forEach(id => batch.delete(col.doc(id)));
      await batch.commit();
      showModal("Eliminadas", "success");
      loadConsigns();
    }catch(e){ console.error(e); showModal("Error: "+e.message, "error"); }
  });
};

// ======================== CUADRAR ========================
$("btn-cuadrar").onclick = async ()=>{
  if(sessionRole !== "Gerente") return showModal("Solo el Gerente puede cuadrar.", "error");
  if(!selectedAccountId) return showModal("Seleccione una cuenta.", "warning");

  const col = db.collection("cuentas").doc(selectedAccountId).collection("consignaciones");
  const snap = await col.orderBy('timestamp','asc').get();
  if(snap.empty) return showModal("No hay consignaciones.", "warning");

  // validar que TODAS estén verificadas por GERENTE
  let okAll = true;
  let total = 0;
  snap.forEach(doc=>{
    const d = doc.data();
    if(!d.isSeparator){
      if(d.verifiedRole !== "Gerente") okAll = false;
      total += Number(d.valor||0);
    }
  });
  if(!okAll) return showModal("Hay consignaciones sin verificar por GERENTE.", "error");

  const fecha = new Date();
  const txt = fecha.toLocaleDateString();

  try{
    const batch = db.batch();
    // bloquear todas
    snap.forEach(doc=>{
      const d = doc.data();
      if(!d.isSeparator) batch.update(col.doc(doc.id), { locked:true });
    });

    // separador verde
    batch.set(col.doc(), {
      isSeparator:true,
      type:"green",
      label: txt,
      total,
      locked:false,
      timestamp: firebase.firestore.Timestamp.now()
    });

    // separador rojo
    batch.set(col.doc(), {
      isSeparator:true,
      type:"red",
      label:"CORTE - "+txt,
      total:0,
      locked:false,
      timestamp: firebase.firestore.Timestamp.now()
    });

    await batch.commit();
    showModal("Cuadre realizado.", "success");
    loadConsigns();

  }catch(e){ console.error(e); showModal("Error: "+e.message, "error"); }
};

// ======================== BUSCADORES ========================
$("search-name").oninput = ()=> filterAccounts();
$("search-account").oninput = ()=> filterAccounts();

async function filterAccounts(){
  const name = $("search-name").value.toLowerCase();
  const num = $("search-account").value.toLowerCase();

  const snap = await db.collection("cuentas").get();
  const cont = $("accounts-list");
  let html = "";
  snap.forEach(doc=>{
    const d = doc.data();
    if(d.nombre.toLowerCase().includes(name) && d.numero.toLowerCase().includes(num)){
      html += `<div class='account-item' data-id='${doc.id}'>${d.nombre}<br><span class='small'>${d.numero}</span></div>`;
    }
  });
  cont.innerHTML = html;
  [...cont.querySelectorAll('.account-item')].forEach(el=>{
    el.onclick = ()=> selectAccount(el.dataset.id, el);
  });
}

// ======================== OPCIONES ========================
$("open-options").onclick = ()=>{
  showModal("Panel de opciones próximamente.", "info");
};

</script>
