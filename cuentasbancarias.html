<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Consignaciones (Integrado con login del sistema)</title>
  <style>
    :root{--bg:#f7f7f9;--card:#fff;--accent:#0d6efd;--muted:#6c757d}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#222}
    .container{max-width:1200px;margin:0 auto}
    .card{background:var(--card);border-radius:8px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center}
    .col{flex:1}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input, textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
    button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    button.ghost{background:#eee;color:#222}
    .account-list{max-height:220px;overflow:auto;border:1px dashed #e3e3e3;padding:8px;border-radius:6px}
    .account-item{padding:8px;border-radius:6px;cursor:pointer}
    .account-item:hover{background:#f1f7ff}
    .account-item.selected{background:#e8f0ff;border-left:4px solid var(--accent)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border:1px solid #e9e9ee;text-align:left;font-size:14px}
    tr.verified-admin{background:#e9ecef;color:#555}
    tr.verified-manager{background:#fff3bf;color:#555}
    tr.separator{background:#f8f9fa;font-weight:700;text-align:center}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <h2>Sistema de Consignaciones</h2>

    <div class="card" id="user-panel">
      <label>Usuario actual:</label>
      <div id="user-info" class="small muted">Cargando...</div>
      <button id="logout" class="ghost">Cerrar sesión</button>
    </div>

    <div id="app" class="hidden">
      <div class="card" id="main-panel">
        <div class="row">
          <div class="col" style="flex:0.6">
            <label>Buscar por nombre</label>
            <input id="search-name" type="text">
          </div>
          <div class="col" style="flex:0.6">
            <label>Buscar por número</label>
            <input id="search-account" type="text">
          </div>
          <div style="flex:0.8">
            <label>Agregar nueva cuenta</label>
            <div style="display:flex;gap:8px">
              <input id="new-account-name" type="text" placeholder="Nombre">
              <input id="new-account-number" type="text" placeholder="Número de cuenta">
              <button id="add-account">Agregar</button>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px">
          <div style="width:320px">
            <div class="card">
              <strong>Cuentas</strong> <span id="accounts-count" class="small"></span>
              <div class="account-list" id="accounts-list"></div>
            </div>
          </div>

          <div style="flex:1">
            <div class="card">
              <strong>Consignación - cuenta seleccionada</strong>
              <div id="selected-account-info" class="small muted">Ninguna cuenta seleccionada</div>
              <hr>

              <label>Fecha</label>
              <input id="date-picker" type="date">

              <label>Fecha observación</label>
              <input id="obsdate-picker" type="date">

              <label>Observaciones</label>
              <textarea id="observations" rows="2"></textarea>

              <label>Valor (COP)</label>
              <input id="valor" type="number">

              <button id="add-consign" style="margin-top:10px">Agregar consignación</button>
            </div>

            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <strong>Consignaciones</strong>
                <div class="controls">
                  <button id="btn-verify">Verificar</button>
                  <button id="btn-unverify" class="ghost">Desverificar</button>
                  <button id="btn-delete" class="ghost hidden">Eliminar</button>
                  <button id="btn-cuadrar" class="ghost hidden">Cuadrar</button>
                </div>
              </div>

              <div style="margin-top:8px;overflow:auto;max-height:360px">
                <table>
                  <thead>
                    <tr>
                      <th>Sel</th>
                      <th>Fecha</th>
                      <th>Valor</th>
                      <th>Observación</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody id="consigns-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
      authDomain: "lazapateria-c4157.firebaseapp.com",
      projectId: "lazapateria-c4157",
      storageBucket: "lazapateria-c4157.firebasestorage.app",
      messagingSenderId: "300241769138",
      appId: "1:300241769138:web:8ca1847de3c4fb5042afab",
      measurementId: "G-HVG7615JEE"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Leer usuario desde localStorage
    const usuario = JSON.parse(localStorage.getItem('datosUsuario'));

    if (!usuario) {
      alert('No hay sesión iniciada');
      window.location.href = 'index.html';
    }

    document.getElementById('user-info').textContent = usuario.usuario + ' — ' + usuario.permisos;

    if (usuario.permisos !== 'Administrador') {
      alert('Acceso denegado. Solo administradores pueden ingresar.');
      window.location.href = 'index.html';
    }

    document.getElementById('app').classList.remove('hidden');

    document.getElementById('logout').onclick = ()=>{
      localStorage.removeItem('datosUsuario');
      window.location.href = 'index.html';
    };

    let selectedAccountId = null;

    function renderAccounts() {
      db.collection('cuentas').orderBy('name').onSnapshot(snapshot => {
        const list = document.getElementById('accounts-list');
        list.innerHTML = '';

        snapshot.forEach(doc => {
          const a = { id: doc.id, ...doc.data() };
          const div = document.createElement('div');
          div.className = 'account-item' + (selectedAccountId === a.id ? ' selected' : '');
          div.innerHTML = `<strong>${a.name}</strong><div class="small">${a.number}</div>`;
          div.onclick = ()=>{
            selectedAccountId = a.id;
            renderAccounts();
            renderConsigns();
          };
          list.appendChild(div);
        });

        document.getElementById('accounts-count').textContent = snapshot.size;
      });
    }

    renderAccounts();

    document.getElementById('add-account').onclick = async ()=>{
      const name = document.getElementById('new-account-name').value.trim();
      const number = document.getElementById('new-account-number').value.trim();
      if (!name || !number) return alert('Complete nombre y número');
      await db.collection('cuentas').add({ name, number });
    };

    function renderConsigns() {
      if (!selectedAccountId) return;

      const tbody = document.getElementById('consigns-body');
      tbody.innerHTML = '';

      db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').orderBy('fecha').onSnapshot(snapshot=>{
        tbody.innerHTML = '';

        snapshot.forEach(doc => {
          const c = doc.data();
          const tr = document.createElement('tr');

          if (c.isSeparator) {
            tr.className = 'separator';
            tr.innerHTML = `<td></td><td colspan='3'>--- CUADRE: ${c.label} TOTAL: ${c.total}</td><td></td>`;
            tbody.appendChild(tr);
            return;
          }

          let estado = 'Sin verificar';
          if (c.verifiedBy) estado = 'Verificado';

          tr.innerHTML = `
            <td><input type='checkbox' data-id='${doc.id}'></td>
            <td>${c.fecha ? new Date(c.fecha.toDate()).toLocaleDateString() : ''}</td>
            <td>${c.valor}</td>
            <td>${c.observaciones || ''}</td>
            <td>${estado}</td>
          `;

          tbody.appendChild(tr);
        });
      });
    }

    document.getElementById('add-consign').onclick = async ()=>{
      if (!selectedAccountId) return alert('Seleccione cuenta');

      const fecha = document.getElementById('date-picker').value;
      const obsdate = document.getElementById('obsdate-picker').value;
      const observaciones = document.getElementById('observations').value.trim();
      const valor = Number(document.getElementById('valor').value);

      if (!fecha) return alert('Seleccione fecha');

      await db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').add({
        fecha: firebase.firestore.Timestamp.fromDate(new Date(fecha)),
        obsdate: obsdate ? firebase.firestore.Timestamp.fromDate(new Date(obsdate)) : null,
        observaciones,
        valor,
        verifiedBy: null,
        verifiedRole: null
      });
    };

    function getSelectedConsignIds() {
      return Array.from(document.querySelectorAll('#consigns-body input[type="checkbox"]')).filter(c => c.checked).map(c => c.dataset.id);
    }

    document.getElementById('btn-verify').onclick = async ()=>{
      if (!selectedAccountId) return;
      const ids = getSelectedConsignIds();
      const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');

      ids.forEach(id => col.doc(id).update({ verifiedBy: usuario.usuario, verifiedRole: usuario.permisos }));
    };

    document.getElementById('btn-unverify').onclick = async ()=>{
      if (!selectedAccountId) return;
      const ids = getSelectedConsignIds();
      const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');

      ids.forEach(id => col.doc(id).update({ verifiedBy: null, verifiedRole: null }));
    };

    document.getElementById('btn-delete').onclick = async ()=>{
      if (usuario.permisos !== 'Administrador') return;
      const ids = getSelectedConsignIds();
      const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
      ids.forEach(id => col.doc(id).delete());
    };

    document.getElementById('btn-cuadrar').onclick = async ()=>{
      if (usuario.permisos !== 'Administrador') return;

      const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
      const snap = await col.get();
      let total = 0;

      snap.forEach(d => {
        if (!d.data().isSeparator) total += Number(d.data().valor || 0);
      });

      await col.add({ isSeparator:true, label:new Date().toLocaleString(), total });
    };

    if (usuario.permisos === 'Administrador') {
      document.getElementById('btn-delete').classList.remove('hidden');
      document.getElementById('btn-cuadrar').classList.remove('hidden');
    }
  </script>
</body>
</html>
