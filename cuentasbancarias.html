<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Consignaciones - Final</title>

  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f3f6fb; --card:#fff; --accent:#2563eb; --muted:#6b7280;
      --border:#e6e9ef; --danger:#dc2626; --ok:#10b981;
      --admin-gray:#e5e7eb;
      --manager-yellow:#fff7c2;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#0f172a}
    #topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:var(--card);border-bottom:1px solid var(--border)}
    .layout{display:flex;height:calc(100vh - 56px)}
    .sidebar{width:320px;padding:16px;background:#fff;border-right:1px solid var(--border);overflow:auto}
    .main{flex:1;padding:18px;overflow:auto}
    h2,h3{margin:0 0 8px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], input[type=date], select, textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:#fff}
    textarea{resize:vertical}
    .btn{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn.ghost{background:#f1f5f9;color:#0f172a}
    .btn.danger{background:var(--danger)}
    .btn.success{background:var(--ok)} /* Estilo boton excel */
    .panel{background:var(--card);padding:12px;border-radius:8px;border:1px solid var(--border);box-shadow:0 2px 6px rgba(15,23,42,0.03);margin-bottom:12px}
    
    .account-item{padding:10px;border-radius:6px;border:1px solid var(--border);margin-bottom:8px;cursor:pointer;background:#fff; position: relative;}
    .account-item.selected{border-left:4px solid var(--accent);background:#f0f6ff}
    .account-item .del-btn {
      position: absolute; top: 10px; right: 10px; 
      color: var(--danger); font-size: 16px; display: none; padding: 2px;
      border-radius: 4px;
    }
    .account-item .del-btn:hover { background: #fee2e2; }

    .flex-row{display:flex;gap:8px;align-items:center}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border:1px solid var(--border);background:transparent}
    tr.verified-admin{background:var(--admin-gray)}
    tr.verified-gerente{background:var(--manager-yellow)}
    
    /* Separadores */
    tr.separator{font-weight:700;text-align:center}
    tr.sep-green{background:#d1fae5!important; color: #065f46;}
    tr.sep-red{background:#fee2e2!important; color: #991b1b;}
    
    /* Foco teclado */
    tr.keyboard-focus { outline: 2px solid var(--accent); z-index: 10; position: relative; }

    .muted{color:var(--muted);font-size:13px}
    .top-totals{display:flex;gap:12px;align-items:center}
    .top-totals .card{padding:8px;border-radius:8px;border:1px solid var(--border);background:#fff}
    .small{font-size:12px;color:var(--muted)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center}
    .modal .card{width:720px;max-width:96%;padding:16px}
    .hidden{display:none}
    .gear{cursor:pointer;padding:6px;border-radius:6px;border:1px solid var(--border);background:#fff}
  </style>
</head>
<body>

  <div id="topbar">
    <div style="display:flex;gap:12px;align-items:center">
      <strong>Sistema de Consignaciones</strong>
      <div class="small">Gerencia</div>
    </div>

    <div class="top-totals">
      <div class="card small">
        <div class="muted">Total general</div>
        <div id="total-general">0</div>
      </div>
      <div class="card small">
        <div class="muted">Total cuenta actual</div>
        <div id="total-cuenta">0</div>
      </div>
      <div class="card small">
        <div class="muted">Usuario</div>
        <div id="user-info">...</div>
      </div>
      <button id="open-options" class="btn ghost">Opciones</button>
      <button id="logout" class="btn ghost">Salir</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <h3>Buscar / Cuentas</h3>
      <label>Buscar por nombre</label>
      <input id="search-name" type="text" placeholder="Nombre...">
      <label style="margin-top:10px">Buscar por n√∫mero</label>
      <input id="search-account" type="text" placeholder="000000...">

      <div style="margin-top:12px" class="panel">
        <h4 style="margin-bottom:8px">Nueva cuenta</h4>
        <label>Nombre</label>
        <input id="new-account-name" type="text">
        <label style="margin-top:8px">N√∫mero</label>
        <input id="new-account-number" type="text">
        <div style="margin-top:8px" class="flex-row">
          <button id="add-account" class="btn" style="flex:1">Agregar</button>
        </div>
      </div>

      <div>
        <div class="muted" style="margin-bottom:6px">Lista de Cuentas</div>
        <div id="accounts-list" style="max-height:50vh;overflow:auto"></div>
      </div>
    </div>

    <div class="main">
      <div class="panel">
        <h3>Agregar consignaci√≥n</h3>
        <div id="selected-account-info" class="muted" style="margin-bottom:8px">Ninguna cuenta seleccionada</div>
        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label>FECHA</label>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label><input type="radio" name="dateOpt" value="today"> Hoy</label>
              <label><input type="radio" name="dateOpt" value="yesterday"> Ayer</label>
              <label><input type="radio" name="dateOpt" value="daybefore"> Antier</label>
              <label style="margin-left:6px">Manual</label>
              <input id="date-picker" type="date">
            </div>
          </div>
          <div style="flex:1">
            <label>FECHA DE OBSERVACI√ìN</label>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label><input type="radio" name="obsOpt" value="today"> Hoy</label>
              <label><input type="radio" name="obsOpt" value="yesterday"> Ayer</label>
              <label><input type="radio" name="obsOpt" value="daybefore"> Antier</label>
              <label style="margin-left:6px">Manual</label>
              <input id="obsdate-picker" type="date">
            </div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:end">
          <div style="flex:1">
            <label>VALOR (COP)</label>
            <input id="valor" type="number" placeholder="0">
          </div>
          <div style="width:220px">
            <button id="add-consign" class="btn" style="width:100%">Agregar consignaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center; flex-wrap:wrap; gap:10px;">
          <h3 style="margin:0">Movimientos</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btn-export-excel" class="btn success">üì• Descargar Excel</button>
            <div style="width:1px; background:#e5e7eb; margin:0 4px;"></div>
            <button id="btn-verify" class="btn">Verificado</button>
            <button id="btn-unverify" class="btn ghost">Desverificar</button>
            <button id="btn-delete" class="btn danger" style="display:none">Eliminar</button>
            <button id="btn-sumar" class="btn ghost">Sumar</button>
            <button id="btn-cuadrar" class="btn ghost" style="display:none; border:1px solid var(--accent); color:var(--accent)">‚úÖ Cuadrar (Corte)</button>
          </div>
        </div>

        <div style="margin-top:12px;max-height:52vh;overflow:auto" tabindex="0" id="table-container">
          <table>
            <thead>
              <tr><th>Sel</th><th>FECHA</th><th>VALOR</th><th>FECHA OBS</th><th>ESTADO</th></tr>
            </thead>
            <tbody id="consigns-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-options" class="modal hidden">
    <div class="panel card" style="width:720px;max-width:96%">
      <h3>Opciones de Acceso</h3>
      <div style="margin-top:8px">
        <label><input type="radio" name="sessionRole" value="Administrativo" checked> Administrativo</label>
        <label style="margin-left:12px"><input type="radio" name="sessionRole" value="Gerente"> Gerente</label>
      </div>
      <div id="manager-pass-area" class="hidden" style="margin-top:12px">
        <label>Clave Gerente</label>
        <input id="manager-pass" type="password">
      </div>
      <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <span class="gear" id="gear-change" title="Cambiar clave">‚öôÔ∏è</span>
          <small class="muted" style="margin-left:8px">Configurar clave</small>
        </div>
        <div>
          <button id="options-continue" class="btn">Continuar</button>
          <button id="options-cancel" class="btn ghost">Cancelar</button>
        </div>
      </div>
      <div id="gear-panel" class="hidden" style="margin-top:14px">
        <label>Nueva clave Gerente</label>
        <input id="new-manager-pass" type="text" placeholder="Nueva clave">
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button id="save-manager-pass" class="btn">Guardar</button>
          <button id="cancel-gear" class="btn ghost">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
<script>
/* CONFIGURACI√ìN FIREBASE */
const firebaseConfig = {
  apiKey:"AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
  authDomain:"lazapateria-c4157.firebaseapp.com",
  projectId:"lazapateria-c4157",
  storageBucket:"lazapateria-c4157.firebasestorage.app",
  messagingSenderId:"300241769138",
  appId:"1:300241769138:web:8ca1847de3c4fb5042afab"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ESTADO GLOBAL */
const usuario = JSON.parse(localStorage.getItem('datosUsuario') || 'null');
if(!usuario){ alert('No hay sesi√≥n activa.'); location.href='index.html'; }
if(usuario.permisos !== 'Administrador'){ alert('Acceso denegado.'); location.href='index.html'; }

$('user-info').textContent = usuario.usuario;
$('logout').onclick = ()=>{ localStorage.removeItem('datosUsuario'); location.href='index.html'; };

let sessionRole = 'Administrativo';
let managerPass = localStorage.getItem('managerPass') || '0000';
let selectedAccountId = null;
let selectedAccountName = "SinNombre";
let currentConsignsSnapshot = []; // Cache de datos visibles

/* UTILIDADES */
function $(id){ return document.getElementById(id); }
function fmtCOP(n){ return new Intl.NumberFormat('es-CO').format(Number(n||0)); }
function parseDateRadio(name, pickerId){ const opts = document.getElementsByName(name); let sel=null; for(const r of opts) if(r.checked) sel=r.value; if(sel==='today') return new Date(); if(sel==='yesterday'){ const d=new Date(); d.setDate(d.getDate()-1); return d; } if(sel==='daybefore'){ const d=new Date(); d.setDate(d.getDate()-2); return d; } const v=$(pickerId).value; return v? new Date(v): null; }

/* MODAL DE OPCIONES Y ROLES */
$('open-options').addEventListener('click', ()=> {
  $('modal-options').classList.remove('hidden');
  document.querySelector('input[name="sessionRole"][value="Administrativo"]').checked = true;
  $('manager-pass-area').classList.add('hidden');
  $('manager-pass').value = '';
  $('gear-panel').classList.add('hidden');
});

document.querySelectorAll('input[name="sessionRole"]').forEach(r=>{
  r.addEventListener('change', (e)=>{
    if(e.target.value === 'Gerente') $('manager-pass-area').classList.remove('hidden');
    else $('manager-pass-area').classList.add('hidden');
  });
});

$('options-cancel').addEventListener('click', ()=> $('modal-options').classList.add('hidden'));
$('gear-change').addEventListener('click', ()=> $('gear-panel').classList.toggle('hidden'));
$('cancel-gear').addEventListener('click', ()=> $('gear-panel').classList.add('hidden'));
$('save-manager-pass').addEventListener('click', ()=>{
  const p = $('new-manager-pass').value.trim(); if(!p){ alert('Ingrese nueva clave'); return; }
  managerPass = p; localStorage.setItem('managerPass', managerPass); alert('Clave actualizada'); $('gear-panel').classList.add('hidden');
});

$('options-continue').addEventListener('click', ()=>{
  const chosen = document.querySelector('input[name="sessionRole"]:checked').value;
  if(chosen === 'Gerente'){
    if($('manager-pass').value !== managerPass){ alert('Clave incorrecta'); return; }
    sessionRole = 'Gerente';
  } else sessionRole = 'Administrativo';

  const isMgr = (sessionRole === 'Gerente');
  $('btn-delete').style.display = isMgr ? 'inline-block' : 'none';
  $('btn-cuadrar').style.display = isMgr ? 'inline-block' : 'none';
  document.querySelectorAll('.del-btn').forEach(b => b.style.display = isMgr ? 'block' : 'none');
  
  $('modal-options').classList.add('hidden');
  alert('Rol activo: ' + sessionRole);
});

/* GESTI√ìN DE CUENTAS */
function subscribeAccounts(){
  db.collection('cuentas').orderBy('name').onSnapshot(snapshot=>{
    const container = $('accounts-list'); container.innerHTML = '';
    snapshot.forEach(doc=>{
      const a = { id: doc.id, ...doc.data() };
      const div = document.createElement('div'); 
      div.className = 'account-item' + (selectedAccountId === a.id ? ' selected' : '');
      div.innerHTML = `
        <div style="font-weight:600; padding-right:20px;">${a.name}</div>
        <div class="muted">${a.number || ''}</div>
      `;
      
      const delBtn = document.createElement('span');
      delBtn.className = 'del-btn';
      delBtn.textContent = 'üóëÔ∏è';
      delBtn.title = "Eliminar cuenta";
      if(sessionRole === 'Gerente') delBtn.style.display = 'block';
      delBtn.onclick = (e) => { e.stopPropagation(); deleteAccount(a.id, a.name); };
      div.appendChild(delBtn);

      div.onclick = ()=>{ 
        selectedAccountId = a.id; 
        selectedAccountName = a.name;
        renderConsigns(); 
        $('selected-account-info').textContent = `Cuenta: ${a.name} ‚Äî ${a.number || ''}`; 
        updateSelectedTotals(); 
      };
      container.appendChild(div);
    });
    if(!selectedAccountId && snapshot.docs.length>0){ 
      const first = snapshot.docs[0];
      selectedAccountId = first.id; 
      selectedAccountName = first.data().name;
      renderConsigns(); 
    }
  });
}
subscribeAccounts();

async function deleteAccount(id, name){
    if(sessionRole !== 'Gerente') return alert("Solo Gerente.");
    if(!confirm(`¬øEliminar cuenta "${name}" permanentemente?`)) return;
    try {
        await db.collection('cuentas').doc(id).delete();
        if(selectedAccountId === id) { selectedAccountId=null; $('consigns-body').innerHTML=''; $('selected-account-info').textContent='...'; }
        alert("Cuenta eliminada.");
    } catch(e) { alert("Error: " + e.message); }
}

/* RENDER CONSIGNACIONES */
let consignsUnsub = null;
function renderConsigns(){ 
  if(consignsUnsub) consignsUnsub(); 
  const tbody = $('consigns-body'); tbody.innerHTML = '';
  currentConsignsSnapshot = [];

  if(!selectedAccountId) return;

  consignsUnsub = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').orderBy('fecha').onSnapshot(snapshot=>{
    tbody.innerHTML = '';
    currentConsignsSnapshot = [];
    snapshot.forEach(doc => currentConsignsSnapshot.push({id: doc.id, ...doc.data()}));

    // Renderizado
    currentConsignsSnapshot.forEach((c, index)=>{
      // Separadores
      if(c.isSeparator){
        const tr=document.createElement('tr');
        tr.classList.add('separator');
        if(c.type==='green') tr.classList.add('sep-green');
        if(c.type==='red') tr.classList.add('sep-red');
        let labelText = `--- ${c.label} ---`;
        if(c.type === 'green') labelText = `üí∞ TOTAL: ${fmtCOP(c.total)}`;
        if(c.type === 'red') labelText = `üõë CORTE (${c.label})`;
        tr.innerHTML = `<td></td><td colspan="3">${labelText}</td><td></td>`;
        tbody.appendChild(tr);
        return;
      }

      // Filas normales
      const tr = document.createElement('tr');
      tr.setAttribute('data-index', index); // Indice visual para el teclado
      if(c.verifiedRole === 'Administrativo') tr.classList.add('verified-admin');
      if(c.verifiedRole === 'Gerente') tr.classList.add('verified-gerente');
      
      const fechaText = c.fecha && c.fecha.toDate ? new Date(c.fecha.toDate()).toLocaleDateString() : '';
      const obsText = c.obsdate && c.obsdate.toDate ? new Date(c.obsdate.toDate()).toLocaleDateString() : '';
      
      tr.innerHTML = `
        <td style="width:56px; text-align:center;"><input type="checkbox" data-id="${c.id}" data-idx="${index}"></td>
        <td style="width:160px">${fechaText}</td>
        <td style="width:140px">${fmtCOP(c.valor)}</td>
        <td style="width:160px">${obsText}</td>
        <td style="width:160px">${c.verifiedRole ? (c.verifiedRole === 'Gerente' ? 'Verificado (G)' : 'Verificado (A)') : 'Pendiente'}</td>
      `;
      // Click en fila para seleccionar
      tr.addEventListener('click', (e)=>{
        if(e.target.type !== 'checkbox') {
            activeRowIndex = index;
            highlightRow(index);
        }
      });
      tbody.appendChild(tr);
    });
    updateSelectedTotals(); updateTotalGeneral();
  });
}

/* L√ìGICA DE TECLADO Y SELECCI√ìN (SOLUCIONADO SHIFT) */
let activeRowIndex = -1;
let anchorRowIndex = -1; // Donde empez√≥ la selecci√≥n

function getRows(){ return Array.from(document.querySelectorAll('#consigns-body tr:not(.separator)')); }

function highlightRow(idx){
    const rows = getRows();
    rows.forEach(r => r.classList.remove('keyboard-focus'));
    if(idx >= 0 && idx < rows.length){
        rows[idx].classList.add('keyboard-focus');
        rows[idx].scrollIntoView({block:'nearest'});
    }
}

// Escuchar checkboxes para actualizar el ancla si se hace click manual
$('consigns-body').addEventListener('change', (e)=>{
    if(e.target.type === 'checkbox'){
        const idx = parseInt(e.target.dataset.idx);
        // Si no hay shift presionado, este click se convierte en el nuevo ancla
        // (La deteccion de shift se hace en el evento 'click' o mousedown, 
        // pero aqui asumimos que si cambias uno manualmente reseteas el ancla logico)
        if(!lastShiftState) anchorRowIndex = idx;
    }
});

let lastShiftState = false;
document.addEventListener('keydown', e => { if(e.key === 'Shift') lastShiftState = true; });
document.addEventListener('keyup', e => { if(e.key === 'Shift') lastShiftState = false; });

document.addEventListener('keydown', e => {
    if(e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') return;
    
    const rows = getRows();
    if(rows.length === 0) return;

    if(['ArrowUp','ArrowDown'].includes(e.key)){
        e.preventDefault();
        
        // Si es la primera vez que movemos, inicializar
        if(activeRowIndex === -1) { activeRowIndex = 0; anchorRowIndex = 0; }

        let newIndex = activeRowIndex;
        if(e.key === 'ArrowDown') newIndex++;
        if(e.key === 'ArrowUp') newIndex--;
        
        // Limites
        newIndex = Math.max(0, Math.min(newIndex, rows.length - 1));

        if(e.shiftKey){
            // SELECCI√ìN CON SHIFT
            // 1. Definir rango desde Ancla hasta Nuevo Foco
            const start = Math.min(anchorRowIndex, newIndex);
            const end = Math.max(anchorRowIndex, newIndex);

            // 2. Recorrer y marcar SOLO los que est√°n en rango, desmarcar los que no
            // (Esta es la l√≥gica de Excel: la selecci√≥n es elastica desde el ancla)
            rows.forEach((r, i) => {
                const chk = r.querySelector('input[type="checkbox"]');
                if(chk){
                    if(i >= start && i <= end) chk.checked = true;
                    else chk.checked = false; 
                }
            });
        } else {
            // MOVIMIENTO SIMPLE (SIN SHIFT)
            // Actualizamos el ancla al nuevo punto
            anchorRowIndex = newIndex;
        }

        activeRowIndex = newIndex;
        highlightRow(activeRowIndex);
    }

    // ESPACIO para marcar/desmarcar el actual (y resetea ancla)
    if(e.key === ' '){
        e.preventDefault();
        if(activeRowIndex >= 0 && activeRowIndex < rows.length){
            const chk = rows[activeRowIndex].querySelector('input[type="checkbox"]');
            if(chk) {
                chk.checked = !chk.checked;
                anchorRowIndex = activeRowIndex;
            }
        }
    }
});


/* BOT√ìN EXPORTAR EXCEL */
$('btn-export-excel').addEventListener('click', () => {
  if(!selectedAccountId || currentConsignsSnapshot.length === 0) return alert("No hay datos para exportar");

  // Filtrar datos: quitar separadores y formatear
  const dataForExcel = currentConsignsSnapshot
    .filter(c => !c.isSeparator)
    .map(c => {
      const fecha = c.fecha && c.fecha.toDate ? new Date(c.fecha.toDate()).toLocaleDateString() : '';
      const obs = c.obsdate && c.obsdate.toDate ? new Date(c.obsdate.toDate()).toLocaleDateString() : '';
      return {
        FECHA: fecha,
        VALOR: Number(c.valor || 0),
        OBSERVACIONES: obs
      };
    });

  if(dataForExcel.length === 0) return alert("No hay movimientos v√°lidos (solo separadores).");

  // Crear Workbook y Worksheet
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(dataForExcel);

  // Ajustar anchos de columna (opcional pero est√©tico)
  const wscols = [
    {wch: 15}, // Fecha
    {wch: 15}, // Valor
    {wch: 20}  // Observaciones
  ];
  ws['!cols'] = wscols;

  XLSX.utils.book_append_sheet(wb, ws, selectedAccountName.substring(0, 31)); // Max 31 chars para nombre hoja excel

  // Descargar
  const fileName = `Consignaciones_${selectedAccountName.replace(/\s+/g,'_')}.xlsx`;
  XLSX.writeFile(wb, fileName);
});


/* OPERACIONES DE DATOS */
$('add-consign').addEventListener('click', async ()=>{
  if(!selectedAccountId) return alert('Seleccione cuenta.');
  const fecha = parseDateRadio('dateOpt','date-picker'); const obsdate = parseDateRadio('obsOpt','obsdate-picker'); const valor = Number($('valor').value || 0);
  if(!fecha) return alert('Fecha inv√°lida.');
  try{ 
    await db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').add({ 
        fecha: firebase.firestore.Timestamp.fromDate(fecha), 
        obsdate: obsdate? firebase.firestore.Timestamp.fromDate(obsdate): null, 
        valor, 
        verifiedBy:null, 
        verifiedRole:null 
    }); 
    $('valor').value=''; 
    $('valor').focus();
  }catch(e){ alert('Error: '+e.message); }
});

$('valor').addEventListener('keydown', e=>{ if(e.key==='Enter') $('add-consign').click(); });

function getSelectedConsignIds(){ return Array.from(document.querySelectorAll('#consigns-body input[type="checkbox"]:checked')).map(c=>c.dataset.id); }

$('btn-verify').addEventListener('click', async ()=>{
  const ids=getSelectedConsignIds(); if(ids.length===0) return;
  const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones'); 
  const batch = db.batch(); ids.forEach(id=> batch.update(col.doc(id), { verifiedBy: usuario.usuario, verifiedRole: sessionRole })); 
  await batch.commit();
});

$('btn-unverify').addEventListener('click', async ()=>{
  const ids=getSelectedConsignIds(); if(ids.length===0) return;
  const batch = db.batch(); const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
  ids.forEach(id=> batch.update(col.doc(id), { verifiedBy:null, verifiedRole:null })); 
  await batch.commit();
});

$('btn-delete').addEventListener('click', async ()=>{ 
  if(sessionRole!=='Gerente') return; const ids=getSelectedConsignIds(); if(ids.length===0) return;
  if(!confirm('¬øEliminar '+ids.length+' items?')) return; 
  const batch = db.batch(); const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
  ids.forEach(id=> batch.delete(col.doc(id))); await batch.commit(); 
});

$('btn-cuadrar').addEventListener('click', async () => {
  if (!selectedAccountId) return;
  
  // Buscar pendientes despu√©s del √∫ltimo corte
  let pendingItems = [];
  for(const item of currentConsignsSnapshot){
    if(item.isSeparator) pendingItems = [];
    else pendingItems.push(item);
  }
  if(pendingItems.length === 0) return alert("Nada nuevo para cuadrar.");

  // Validar amarillos
  const nonYellow = pendingItems.filter(i => i.verifiedRole !== 'Gerente');
  if(nonYellow.length > 0) return alert(`Hay ${nonYellow.length} items sin verificar por Gerente.`);

  const total = pendingItems.reduce((acc, curr) => acc + Number(curr.valor || 0), 0);
  if(!confirm(`¬øRealizar corte?\nTotal: ${fmtCOP(total)}`)) return;

  const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
  const batch = db.batch();
  const now = new Date();
  
  batch.set(col.doc(), { isSeparator:true, type:'green', label: now.toLocaleDateString(), total: total, fecha: firebase.firestore.Timestamp.fromDate(now) });
  batch.set(col.doc(), { isSeparator:true, type:'red', label: now.toLocaleDateString(), total: 0, fecha: firebase.firestore.Timestamp.fromDate(new Date(now.getTime()+1000)) });

  await batch.commit();
});

$('btn-sumar').addEventListener('click', ()=>{
  const rows = Array.from(document.querySelectorAll('#consigns-body input[type="checkbox"]:checked'));
  let suma = 0;
  rows.forEach(ch=>{
    const tr=ch.closest('tr'); 
    const val = tr.children[2].textContent.replace(/\./g,'').replace(/,/g,''); 
    suma += Number(val)||0; 
  });
  alert('Suma selecci√≥n: '+fmtCOP(suma));
});

/* CALCULOS TOTALES */
async function updateSelectedTotals(){ 
  if(!selectedAccountId){ $('total-cuenta').textContent = 0; return; }
  let total = 0; 
  currentConsignsSnapshot.forEach(d=>{ if(!d.isSeparator) total += Number(d.valor || 0); }); 
  $('total-cuenta').textContent = fmtCOP(total); 
}

async function updateTotalGeneral(){ 
  try{ 
    const snap = await db.collectionGroup('consignaciones').get(); 
    let total = 0; 
    snap.forEach(d=>{ if(!d.data().isSeparator) total += Number(d.data().valor || 0); }); 
    $('total-general').textContent = fmtCOP(total); 
  }catch(e){} 
}
setInterval(updateTotalGeneral,15000); updateTotalGeneral();

/* BUSQUEDA */
const filter = (id) => {
    const q = $(id).value.toLowerCase();
    document.querySelectorAll('#accounts-list .account-item').forEach(it => {
        it.style.display = it.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
};
$('search-name').addEventListener('input', () => filter('search-name'));
$('search-account').addEventListener('input', () => filter('search-account'));

window.addEventListener('load', ()=>{ $('modal-options').classList.remove('hidden'); $('manager-pass').value=''; });
window.addEventListener('beforeunload', ()=>{ if(consignsUnsub) consignsUnsub(); });

</script>
</body>
</html>
