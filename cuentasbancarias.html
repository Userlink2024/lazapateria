<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Consignaciones - Blindado y Final</title>

  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f3f6fb; --card:#fff; --accent:#2563eb; --muted:#6b7280;
      --border:#e6e9ef; --danger:#dc2626; --ok:#10b981;
      --admin-gray:#e5e7eb;
      --manager-yellow:#fff7c2;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#0f172a}
    #topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:var(--card);border-bottom:1px solid var(--border)}
    .layout{display:flex;height:calc(100vh - 56px)}
    .sidebar{width:320px;padding:16px;background:#fff;border-right:1px solid var(--border);overflow:auto}
    .main{flex:1;padding:18px;overflow:auto}
    h2,h3{margin:0 0 8px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], input[type=date], select, textarea, input[type=password]{width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:#fff}
    textarea{resize:vertical}
    .btn{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn.ghost{background:#f1f5f9;color:#0f172a}
    .btn.danger{background:var(--danger)}
    .btn.success{background:var(--ok)} 
    .panel{background:var(--card);padding:12px;border-radius:8px;border:1px solid var(--border);box-shadow:0 2px 6px rgba(15,23,42,0.03);margin-bottom:12px}
    
    .account-item{padding:10px;border-radius:6px;border:1px solid var(--border);margin-bottom:8px;cursor:pointer;background:#fff; position: relative;}
    .account-item.selected{border-left:4px solid var(--accent);background:#f0f6ff}
    .account-item .del-btn {
      position: absolute; top: 10px; right: 10px; 
      color: var(--danger); font-size: 16px; display: none; padding: 2px;
      border-radius: 4px;
    }
    .account-item .del-btn:hover { background: #fee2e2; }

    .flex-row{display:flex;gap:8px;align-items:center}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border:1px solid var(--border);background:transparent}
    tr.verified-admin{background:var(--admin-gray)}
    tr.verified-gerente{background:var(--manager-yellow)}
    
    /* Separadores */
    tr.separator{font-weight:700;text-align:center}
    tr.sep-green{background:#d1fae5!important; color: #065f46;}
    tr.sep-red{background:#fee2e2!important; color: #991b1b;}
    
    /* Foco teclado */
    tr.keyboard-focus { outline: 2px solid var(--accent); z-index: 10; position: relative; }

    .muted{color:var(--muted);font-size:13px}
    .top-totals{display:flex;gap:12px;align-items:center}
    .top-totals .card{padding:8px;border-radius:8px;border:1px solid var(--border);background:#fff}
    .small{font-size:12px;color:var(--muted)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:999;}
    .modal .card{width:720px;max-width:96%;padding:16px}
    .hidden{display:none}
    .gear{cursor:pointer;padding:6px;border-radius:6px;border:1px solid var(--border);background:#fff}
    
    /* Nuevo modal gen√©rico */
    #generic-modal .card{width:400px!important; max-width:96%; padding:16px; position:relative;}
    #modal-title{color:var(--accent); margin-bottom:12px;}
    #modal-body{margin-bottom:12px;}
    #modal-password-input{margin-top:4px;}
  </style>
</head>
<body>

  <div id="topbar">
    <div style="display:flex;gap:12px;align-items:center">
      <strong>Sistema de Consignaciones</strong>
      <div class="small">Gerencia</div>
    </div>

    <div class="top-totals">
      <div class="card small">
        <div class="muted">Total general</div>
        <div id="total-general">0</div>
      </div>
      <div class="card small">
        <div class="muted">Total cuenta actual</div>
        <div id="total-cuenta">0</div>
      </div>
      <div class="card small">
        <div class="muted">Usuario</div>
        <div id="user-info">...</div>
      </div>
      <button id="open-options" class="btn ghost">Opciones</button>
      <button id="logout" class="btn ghost">Salir</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <h3>Buscar / Cuentas</h3>
      <label>Buscar por nombre</label>
      <input id="search-name" type="text" placeholder="Nombre...">
      <label style="margin-top:10px">Buscar por n√∫mero</label>
      <input id="search-account" type="text" placeholder="000000...">

      <div style="margin-top:12px" class="panel">
        <h4 style="margin-bottom:8px">Nueva cuenta</h4>
        <label>Nombre</label>
        <input id="new-account-name" type="text">
        <label style="margin-top:8px">N√∫mero</label>
        <input id="new-account-number" type="text">
        <div style="margin-top:8px" class="flex-row">
          <button id="add-account" class="btn" style="flex:1">Agregar</button>
        </div>
      </div>

      <div>
        <div class="muted" style="margin-bottom:6px">Lista de Cuentas</div>
        <div id="accounts-list" style="max-height:50vh;overflow:auto"></div>
      </div>
    </div>

    <div class="main">
      <div class="panel">
        <h3>Agregar consignaci√≥n</h3>
        <div id="selected-account-info" class="muted" style="margin-bottom:8px">Ninguna cuenta seleccionada</div>
        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label>FECHA</label>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label><input type="radio" name="dateOpt" value="today"> Hoy</label>
              <label><input type="radio" name="dateOpt" value="yesterday"> Ayer</label>
              <label><input type="radio" name="dateOpt" value="daybefore"> Antier</label>
              <label style="margin-left:6px">Manual</label>
              <input id="date-picker" type="date">
            </div>
          </div>
          <div style="flex:1">
            <label>FECHA DE OBSERVACI√ìN</label>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label><input type="radio" name="obsOpt" value="today"> Hoy</label>
              <label><input type="radio" name="obsOpt" value="yesterday"> Ayer</label>
              <label><input type="radio" name="obsOpt" value="daybefore"> Antier</label>
              <label style="margin-left:6px">Manual</label>
              <input id="obsdate-picker" type="date">
            </div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:end">
          <div style="flex:1">
            <label>VALOR (COP)</label>
            <input id="valor" type="number" placeholder="0">
          </div>
          <div style="width:220px">
            <button id="add-consign" class="btn" style="width:100%">Agregar consignaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center; flex-wrap:wrap; gap:10px;">
          <h3 style="margin:0">Movimientos</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btn-export-excel" class="btn success">üì• Descargar Cuenta</button>
            <button id="btn-export-master" class="btn success" style="display:none; background:#7c3aed; color:white;">üì• Descargar Maestra (G)</button>

            <div style="width:1px; background:#e5e7eb; margin:0 4px;"></div>
            <button id="btn-verify" class="btn">Verificado</button>
            <button id="btn-unverify" class="btn ghost">Desverificar</button>
            <button id="btn-delete" class="btn danger" style="display:none">Eliminar</button>
            <button id="btn-sumar" class="btn ghost">Sumar</button>
            <button id="btn-cuadrar" class="btn ghost" style="display:none; border:1px solid var(--accent); color:var(--accent)">‚úÖ Cuadrar (Corte)</button>
          </div>
        </div>

        <div style="margin-top:12px;max-height:52vh;overflow:auto" tabindex="0" id="table-container">
          <table>
            <thead>
              <tr><th>Sel</th><th>FECHA</th><th>VALOR</th><th>FECHA OBS</th><th>ESTADO</th></tr>
            </thead>
            <tbody id="consigns-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-options" class="modal hidden">
    <div class="panel card" style="width:720px;max-width:96%">
      <h3>Opciones de Acceso</h3>
      <div style="margin-top:8px">
        <label><input type="radio" name="sessionRole" value="Administrativo" checked> Administrativo</label>
        <label style="margin-left:12px"><input type="radio" name="sessionRole" value="Gerente"> Gerente</label>
      </div>
      <div id="manager-pass-area" class="hidden" style="margin-top:12px">
        <label>Clave Gerente</label>
        <input id="manager-pass" type="password">
      </div>
      <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <span class="gear" id="gear-change" title="Cambiar clave">‚öôÔ∏è</span>
          <small class="muted" style="margin-left:8px">Configurar clave</small>
        </div>
        <div>
          <button id="options-continue" class="btn">Continuar</button>
          <button id="options-cancel" class="btn ghost">Cancelar</button>
        </div>
      </div>
      <div id="gear-panel" class="hidden" style="margin-top:14px">
        <label>Nueva clave Gerente</label>
        <input id="new-manager-pass" type="text" placeholder="Nueva clave">
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button id="save-manager-pass" class="btn">Guardar</button>
          <button id="cancel-gear" class="btn ghost">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="generic-modal" class="modal hidden">
    <div class="panel card">
        <h4 id="modal-title" style="margin-top:0;"></h4>
        <div id="modal-body"></div>
        <div id="modal-password-area" class="hidden" style="margin-top:12px">
            <label>CLAVE DE GERENTE</label>
            <input id="modal-password-input" type="password">
        </div>
        <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end">
            <button id="modal-cancel-btn" class="btn ghost hidden">Cancelar</button>
            <button id="modal-ok-btn" class="btn">Aceptar</button>
        </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
<script>
/* CONFIGURACI√ìN FIREBASE */
const firebaseConfig = {
  apiKey:"AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
  authDomain:"lazapateria-c4157.firebaseapp.com",
  projectId:"lazapateria-c4157",
  storageBucket:"lazapateria-c4157.firebasestorage.app",
  messagingSenderId:"300241769138",
  appId:"1:300241769138:web:8ca1847de3c4fb5042afab"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ESTADO GLOBAL */
const usuario = JSON.parse(localStorage.getItem('datosUsuario') || 'null');
if(!usuario){ showModal('Error', 'No hay sesi√≥n activa.', false, ()=>location.href='index.html'); }
if(usuario.permisos !== 'Administrador'){ showModal('Error', 'Acceso denegado.', false, ()=>location.href='index.html'); }

$('user-info').textContent = usuario.usuario;
$('logout').onclick = ()=>{ localStorage.removeItem('datosUsuario'); location.href='index.html'; };

let sessionRole = 'Administrativo';
let managerPass = localStorage.getItem('managerPass') || '0000';
let selectedAccountId = null;
let selectedAccountName = "SinNombre";
let currentConsignsSnapshot = []; 

/* UTILIDADES */
function $(id){ return document.getElementById(id); }
function fmtCOP(n){ return new Intl.NumberFormat('es-CO').format(Number(n||0)); }
function parseDateRadio(name, pickerId){ const opts = document.getElementsByName(name); let sel=null; for(const r of opts) if(r.checked) sel=r.value; if(sel==='today') return new Date(); if(sel==='yesterday'){ const d=new Date(); d.setDate(d.getDate()-1); return d; } if(sel==='daybefore'){ const d=new Date(); d.setDate(d.getDate()-2); return d; } const v=$(pickerId).value; return v? new Date(v): null; }

/* FUNCIONES DE MODAL GEN√âRICO */
function showModal(title, message, isConfirm, onOk, onCancel){
    $('modal-title').textContent = title;
    $('modal-body').textContent = message;
    $('modal-password-area').classList.add('hidden');
    $('modal-password-input').value = '';

    $('modal-cancel-btn').classList.toggle('hidden', !isConfirm);
    $('modal-ok-btn').onclick = () => { $('generic-modal').classList.add('hidden'); if(onOk) onOk(); };
    $('modal-cancel-btn').onclick = () => { $('generic-modal').classList.add('hidden'); if(onCancel) onCancel(); };

    $('generic-modal').classList.remove('hidden');
}

function showPasswordModal(title, message){
    return new Promise((resolve, reject) => {
        $('modal-title').textContent = title;
        $('modal-body').textContent = message;
        $('modal-password-area').classList.remove('hidden');
        $('modal-password-input').value = '';
        $('modal-password-input').focus();
        
        $('modal-cancel-btn').classList.remove('hidden');

        const checkPass = () => {
            const pass = $('modal-password-input').value;
            if (pass === managerPass) {
                $('generic-modal').classList.add('hidden');
                resolve(true);
            } else {
                showModal('Error de Seguridad', 'Clave incorrecta. Intente de nuevo.', false);
                $('modal-password-input').value = '';
                $('modal-password-input').focus();
            }
        };

        const handleCancel = () => {
            $('generic-modal').classList.add('hidden');
            reject(new Error("Acci√≥n cancelada."));
        };

        $('modal-ok-btn').onclick = checkPass;
        $('modal-cancel-btn').onclick = handleCancel;
        
        // Permite usar Enter en el input de contrase√±a
        $('modal-password-input').onkeydown = (e) => {
            if(e.key === 'Enter') { e.preventDefault(); checkPass(); }
        };

        $('generic-modal').classList.remove('hidden');
    }).catch(e => {
        if(e.message !== "Acci√≥n cancelada.") {
            showModal('Error', e.message, false);
        }
        throw e; // Re-throw to propagate rejection
    });
}

/* MODAL DE OPCIONES Y ROLES */
$('open-options').addEventListener('click', ()=> {
  $('modal-options').classList.remove('hidden');
  document.querySelector('input[name="sessionRole"][value="Administrativo"]').checked = true;
  $('manager-pass-area').classList.add('hidden');
  $('manager-pass').value = '';
  $('gear-panel').classList.add('hidden');
});

document.querySelectorAll('input[name="sessionRole"]').forEach(r=>{
  r.addEventListener('change', (e)=>{
    if(e.target.value === 'Gerente') $('manager-pass-area').classList.remove('hidden');
    else $('manager-pass-area').classList.add('hidden');
  });
});

$('options-cancel').addEventListener('click', ()=> $('modal-options').classList.add('hidden'));
$('gear-change').addEventListener('click', ()=> $('gear-panel').classList.toggle('hidden'));
$('cancel-gear').addEventListener('click', ()=> $('gear-panel').classList.add('hidden'));

$('save-manager-pass').addEventListener('click', ()=>{
  const p = $('new-manager-pass').value.trim(); if(!p){ showModal('Atenci√≥n', 'Ingrese nueva clave.', false); return; }
  managerPass = p; localStorage.setItem('managerPass', managerPass); 
  showModal('√âxito', 'Clave actualizada.', false); 
  $('gear-panel').classList.add('hidden');
});

$('options-continue').addEventListener('click', ()=>{
  const chosen = document.querySelector('input[name="sessionRole"]:checked').value;
  if(chosen === 'Gerente'){
    if($('manager-pass').value !== managerPass){ showModal('Error', 'Clave incorrecta.', false); return; }
    sessionRole = 'Gerente';
  } else sessionRole = 'Administrativo';

  const isMgr = (sessionRole === 'Gerente');
  $('btn-delete').style.display = isMgr ? 'inline-block' : 'none';
  $('btn-cuadrar').style.display = isMgr ? 'inline-block' : 'none';
  $('btn-export-master').style.display = isMgr ? 'inline-block' : 'none';
  document.querySelectorAll('.del-btn').forEach(b => b.style.display = isMgr ? 'block' : 'none');
  
  $('modal-options').classList.add('hidden');
  showModal('Acceso', 'Rol activo: ' + sessionRole, false);
});

/* SEGURIDAD EXTRA: Proteger cambios en items verificados */
async function checkSensitiveAction(selectedData) {
  const lockedItems = selectedData.filter(i => i.verifiedRole || i.isSeparator);
  
  if (lockedItems.length > 0) {
    try {
        await showPasswordModal(
            "‚ö†Ô∏è ACCI√ìN RESTRINGIDA ‚ö†Ô∏è", 
            "Est√° intentando modificar/eliminar registros VERIFICADOS o CORTES. Ingrese la CLAVE DE GERENTE para continuar:"
        );
        return true;
    } catch (e) {
        return false;
    }
  }
  return true; 
}

/* GESTI√ìN DE CUENTAS */
function subscribeAccounts(){
  db.collection('cuentas').orderBy('name').onSnapshot(snapshot=>{
    const container = $('accounts-list'); container.innerHTML = '';
    snapshot.forEach(doc=>{
      const a = { id: doc.id, ...doc.data() };
      const div = document.createElement('div'); 
      div.className = 'account-item' + (selectedAccountId === a.id ? ' selected' : '');
      div.innerHTML = `
        <div style="font-weight:600; padding-right:20px;">${a.name}</div>
        <div class="muted">${a.number || ''}</div>
      `;
      
      const delBtn = document.createElement('span');
      delBtn.className = 'del-btn';
      delBtn.textContent = 'üóëÔ∏è';
      delBtn.title = "Eliminar cuenta";
      if(sessionRole === 'Gerente') delBtn.style.display = 'block';
      delBtn.onclick = (e) => { e.stopPropagation(); deleteAccount(a.id, a.name); };
      div.appendChild(delBtn);

      div.onclick = ()=>{ 
        selectedAccountId = a.id; 
        selectedAccountName = a.name;
        renderConsigns(); 
        $('selected-account-info').textContent = `Cuenta: ${a.name} ‚Äî ${a.number || ''}`; 
        updateSelectedTotals(); 
      };
      container.appendChild(div);
    });
    if(!selectedAccountId && snapshot.docs.length>0){ 
      const first = snapshot.docs[0];
      selectedAccountId = first.id; 
      selectedAccountName = first.data().name;
      renderConsigns(); 
    }
  });
}
subscribeAccounts();

async function deleteAccount(id, name){
    if(sessionRole !== 'Gerente') return showModal('Error', "Solo Gerente puede eliminar cuentas.", false);
    
    showModal('Confirmaci√≥n', `¬øEliminar cuenta "${name}" permanentemente?`, true, async () => {
        try {
            await showPasswordModal(
                "‚ö†Ô∏è PELIGRO ‚ö†Ô∏è",
                `Va a eliminar la cuenta "${name}" y todo su historial. Ingrese CLAVE DE GERENTE para confirmar:`
            );

            await db.collection('cuentas').doc(id).delete();
            if(selectedAccountId === id) { selectedAccountId=null; $('consigns-body').innerHTML=''; $('selected-account-info').textContent='...'; }
            showModal('√âxito', "Cuenta eliminada.", false);
        } catch(e) { 
            if(e.message !== "Acci√≥n cancelada.") showModal('Error', "Error: " + e.message, false);
        }
    });
}

/* RENDER CONSIGNACIONES */
let consignsUnsub = null;
function renderConsigns(){ 
  if(consignsUnsub) consignsUnsub(); 
  const tbody = $('consigns-body'); tbody.innerHTML = '';
  currentConsignsSnapshot = [];

  if(!selectedAccountId) return;

  consignsUnsub = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').orderBy('fecha').onSnapshot(snapshot=>{
    tbody.innerHTML = '';
    currentConsignsSnapshot = [];
    snapshot.forEach(doc => currentConsignsSnapshot.push({id: doc.id, ...doc.data()}));

    currentConsignsSnapshot.forEach((c, index)=>{
      if(c.isSeparator){
        const tr=document.createElement('tr');
        tr.classList.add('separator');
        if(c.type==='green') tr.classList.add('sep-green');
        if(c.type==='red') tr.classList.add('sep-red');
        let labelText = `--- ${c.label} ---`;
        if(c.type === 'green') labelText = `üí∞ TOTAL: ${fmtCOP(c.total)}`;
        if(c.type === 'red') labelText = `üõë CORTE (${c.label})`;
        tr.innerHTML = `<td><input type="checkbox" data-id="${c.id}" data-idx="${index}" data-separator="true"></td><td colspan="3">${labelText}</td><td></td>`;
        tbody.appendChild(tr);
        return;
      }

      const tr = document.createElement('tr');
      tr.setAttribute('data-index', index);
      if(c.verifiedRole === 'Administrativo') tr.classList.add('verified-admin');
      if(c.verifiedRole === 'Gerente') tr.classList.add('verified-gerente');
      
      const fechaText = c.fecha && c.fecha.toDate ? new Date(c.fecha.toDate()).toLocaleDateString() : '';
      const obsText = c.obsdate && c.obsdate.toDate ? new Date(c.obsdate.toDate()).toLocaleDateString() : '';
      
      tr.innerHTML = `
        <td style="width:56px; text-align:center;"><input type="checkbox" data-id="${c.id}" data-idx="${index}"></td>
        <td style="width:160px">${fechaText}</td>
        <td style="width:140px">${fmtCOP(c.valor)}</td>
        <td style="width:160px">${obsText}</td>
        <td style="width:160px">${c.verifiedRole ? (c.verifiedRole === 'Gerente' ? 'Verificado (Amarillo)' : 'Verificado (Gris)') : 'Pendiente'}</td>
      `;
      tr.addEventListener('click', (e)=>{
        if(e.target.type !== 'checkbox') {
            activeRowIndex = index;
            highlightRow(index);
        }
      });
      tbody.appendChild(tr);
    });
    updateSelectedTotals(); updateTotalGeneral();
  });
}

/* L√ìGICA DE TECLADO Y SELECCI√ìN */
let activeRowIndex = -1;
let anchorRowIndex = -1;
function getRows(){ return Array.from(document.querySelectorAll('#consigns-body tr')); }
function highlightRow(idx){
    const rows = getRows();
    rows.forEach(r => r.classList.remove('keyboard-focus'));
    if(idx >= 0 && idx < rows.length){
        rows[idx].classList.add('keyboard-focus');
        rows[idx].scrollIntoView({block:'nearest'});
    }
}
$('consigns-body').addEventListener('change', (e)=>{
    if(e.target.type === 'checkbox'){
        const idx = parseInt(e.target.dataset.idx);
        if(!lastShiftState) anchorRowIndex = idx;
    }
});
let lastShiftState = false;
document.addEventListener('keydown', e => { if(e.key === 'Shift') lastShiftState = true; });
document.addEventListener('keyup', e => { if(e.key === 'Shift') lastShiftState = false; });
document.addEventListener('keydown', e => {
    if(e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') return;
    const rows = getRows();
    if(rows.length === 0) return;
    if(['ArrowUp','ArrowDown'].includes(e.key)){
        e.preventDefault();
        if(activeRowIndex === -1) { activeRowIndex = 0; anchorRowIndex = 0; }
        let newIndex = activeRowIndex;
        if(e.key === 'ArrowDown') newIndex++;
        if(e.key === 'ArrowUp') newIndex--;
        newIndex = Math.max(0, Math.min(newIndex, rows.length - 1));
        if(e.shiftKey){
            const start = Math.min(anchorRowIndex, newIndex);
            const end = Math.max(anchorRowIndex, newIndex);
            rows.forEach((r, i) => {
                const chk = r.querySelector('input[type="checkbox"]');
                if(chk) chk.checked = (i >= start && i <= end);
            });
        } else {
            anchorRowIndex = newIndex;
        }
        activeRowIndex = newIndex;
        highlightRow(activeRowIndex);
    }
    if(e.key === ' '){
        e.preventDefault();
        if(activeRowIndex >= 0 && activeRowIndex < rows.length){
            const chk = rows[activeRowIndex].querySelector('input[type="checkbox"]');
            if(chk) {
                chk.checked = !chk.checked;
                anchorRowIndex = activeRowIndex;
            }
        }
    }
});

/* BOTONES DE EXPORTACI√ìN (ACTUALIZADO FORMATO DE FECHA) */
// Funci√≥n de exportaci√≥n de cuenta seleccionada
$('btn-export-excel').addEventListener('click', () => {
  if(!selectedAccountId || currentConsignsSnapshot.length === 0) return showModal('Atenci√≥n', "No hay datos para exportar.", false);

  const dataForExcel = currentConsignsSnapshot
    .filter(c => !c.isSeparator)
    .map(c => {
      const fechaDate = c.fecha && c.fecha.toDate ? c.fecha.toDate() : null;
      const obsDate = c.obsdate && c.obsdate.toDate ? c.obsdate.toDate() : null;
      
      const estado = !c.verifiedRole 
          ? 'Pendiente' 
          : c.verifiedRole === 'Administrativo' 
            ? 'Verificado (Gris)' 
            : 'Verificado (Amarillo)';

      return {
        FECHA: fechaDate, 
        VALOR: Number(c.valor || 0),
        OBSERVACIONES: obsDate,
        'ESTADO/COLOR': estado // Nuevo campo
      };
    });

  if(dataForExcel.length === 0) return showModal('Atenci√≥n', "No hay movimientos v√°lidos (solo separadores).", false);

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(dataForExcel, { header: ["FECHA", "VALOR", "OBSERVACIONES", "ESTADO/COLOR"] }); // Nuevo header

  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let R = range.s.r + 1; R <= range.e.r; ++R) { 
      const cell_fecha_addr = XLSX.utils.encode_cell({ r: R, c: 0 }); 
      const cell_valor_addr = XLSX.utils.encode_cell({ r: R, c: 1 }); 
      const cell_obs_addr = XLSX.utils.encode_cell({ r: R, c: 2 }); 

      // FORMATO DE FECHA LARGO SOLICITADO
      const longDateFormat = '[$-es-ES]d\ \d\e\ mmmm\ \d\e\ aaaa'; 
      if (ws[cell_fecha_addr]) ws[cell_fecha_addr].z = longDateFormat; 
      if (ws[cell_obs_addr]) ws[cell_obs_addr].z = longDateFormat; 
      
      // Formato de moneda
      if (ws[cell_valor_addr]) ws[cell_valor_addr].z = '_("$"* #,##0_);_("$"* (#,##0);_("$"* "-"??_);_(@_)';
      // El nuevo campo ESTADO (columna 3) no necesita formato num√©rico o de fecha.
  }

  // Ajuste de anchos para incluir la nueva columna
  ws['!cols'] = [{wch: 25}, {wch: 15}, {wch: 25}, {wch: 20}];
  
  XLSX.utils.book_append_sheet(wb, ws, selectedAccountName.substring(0, 31)); 
  XLSX.writeFile(wb, `Consignaciones_${selectedAccountName.replace(/\s+/g,'_')}.xlsx`);
});

// Funci√≥n de exportaci√≥n de maestra
$('btn-export-master').addEventListener('click', async () => {
  if (sessionRole !== 'Gerente') return;
  
  try {
    await showPasswordModal(
        "‚ö†Ô∏è DESCARGA DE MAESTRA ‚ö†Ô∏è",
        "Esta acci√≥n descarga toda la informaci√≥n del sistema. Ingrese la CLAVE DE GERENTE para continuar:"
    );

    const accountsSnapshot = await db.collection('cuentas').get();
    const wb = XLSX.utils.book_new();

    for (const doc of accountsSnapshot.docs) {
      const account = { id: doc.id, ...doc.data() };
      const accountName = account.name.substring(0, 31).replace(/[\/\?\[\]\*\\\: ]/g, '_'); 

      const consignsSnapshot = await db.collection('cuentas').doc(account.id).collection('consignaciones').orderBy('fecha').get();

      const dataForExcel = consignsSnapshot.docs
        .map(d => d.data())
        .filter(c => !c.isSeparator)
        .map(c => {
          const fechaDate = c.fecha && c.fecha.toDate ? c.fecha.toDate() : null;
          const obsDate = c.obsdate && c.obsdate.toDate ? c.obsdate.toDate() : null;
          
          const estado = !c.verifiedRole 
              ? 'Pendiente' 
              : c.verifiedRole === 'Administrativo' 
                ? 'Verificado (Gris)' 
                : 'Verificado (Amarillo)';

          return {
            FECHA: fechaDate, 
            VALOR: Number(c.valor || 0),
            OBSERVACIONES: obsDate,
            'ESTADO/COLOR': estado // Nuevo campo
          };
        });

      if (dataForExcel.length === 0) continue; 

      const ws = XLSX.utils.json_to_sheet(dataForExcel, { header: ["FECHA", "VALOR", "OBSERVACIONES", "ESTADO/COLOR"] }); // Nuevo header

      if (ws['!ref']) {
          const range = XLSX.utils.decode_range(ws['!ref']);
          const longDateFormat = '[$-es-ES]d\ \d\e\ mmmm\ \d\e\ aaaa'; 
          for (let R = range.s.r + 1; R <= range.e.r; ++R) { 
              const cell_fecha_addr = XLSX.utils.encode_cell({ r: R, c: 0 }); 
              const cell_valor_addr = XLSX.utils.encode_cell({ r: R, c: 1 }); 
              const cell_obs_addr = XLSX.utils.encode_cell({ r: R, c: 2 }); 
              
              if (ws[cell_fecha_addr]) ws[cell_fecha_addr].z = longDateFormat; 
              if (ws[cell_obs_addr]) ws[cell_obs_addr].z = longDateFormat; 
              if (ws[cell_valor_addr]) ws[cell_valor_addr].z = '_("$"* #,##0_);_("$"* (#,##0);_("$"* "-"??_);_(@_)';
          }
           // Ajuste de anchos para incluir la nueva columna
           ws['!cols'] = [{wch: 25}, {wch: 15}, {wch: 25}, {wch: 20}];
      }

      XLSX.utils.book_append_sheet(wb, ws, accountName);
    }
    
    if (wb.SheetNames.length > 0) {
      XLSX.writeFile(wb, `Maestra_Consignaciones_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
    } else {
      showModal('Atenci√≥n', "No se encontraron movimientos en ninguna cuenta para exportar.", false);
    }
  } catch (e) {
    if(e.message !== "Acci√≥n cancelada.") showModal('Error', "Ocurri√≥ un error al intentar exportar la maestra: " + e.message, false);
  }
});


/* OPERACIONES DE DATOS */
$('add-consign').addEventListener('click', async ()=>{
  if(!selectedAccountId) return showModal('Atenci√≥n', 'Seleccione una cuenta.', false);
  const fecha = parseDateRadio('dateOpt','date-picker'); const obsdate = parseDateRadio('obsOpt','obsdate-picker'); const valor = Number($('valor').value || 0);
  if(!fecha) return showModal('Atenci√≥n', 'Fecha inv√°lida.', false);
  try{ 
    await db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').add({ 
        fecha: firebase.firestore.Timestamp.fromDate(fecha), obsdate: obsdate? firebase.firestore.Timestamp.fromDate(obsdate): null, valor, verifiedBy:null, verifiedRole:null 
    }); 
    $('valor').value=''; $('valor').focus();
    showModal('√âxito', 'Consignaci√≥n agregada.', false);
  }catch(e){ showModal('Error', 'Error al agregar consignaci√≥n: '+e.message, false); }
});

$('valor').addEventListener('keydown', e=>{ if(e.key==='Enter') $('add-consign').click(); });

function getSelectedConsignIds(){ return Array.from(document.querySelectorAll('#consigns-body input[type="checkbox"]:checked')).map(c=>c.dataset.id); }

$('btn-verify').addEventListener('click', async ()=>{
  const ids=getSelectedConsignIds(); if(ids.length===0) return showModal('Atenci√≥n', 'Seleccione al menos un movimiento para verificar.', false);
  const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones'); 
  const batch = db.batch(); ids.forEach(id=> batch.update(col.doc(id), { verifiedBy: usuario.usuario, verifiedRole: sessionRole })); 
  await batch.commit();
  showModal('√âxito', `${ids.length} movimientos verificados.`, false);
});

$('btn-unverify').addEventListener('click', async ()=>{
  const ids=getSelectedConsignIds(); if(ids.length===0) return showModal('Atenci√≥n', 'Seleccione al menos un movimiento para desverificar.', false);
  const selectedData = currentConsignsSnapshot.filter(c => ids.includes(c.id));
  
  if(!await checkSensitiveAction(selectedData)) return;

  const batch = db.batch(); const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
  ids.forEach(id=> batch.update(col.doc(id), { verifiedBy:null, verifiedRole:null })); 
  await batch.commit();
  showModal('√âxito', `${ids.length} movimientos desverificados.`, false);
});

// FUNCI√ìN DE ELIMINACI√ìN CORREGIDA CON RECALCULO GENERAL
$('btn-delete').addEventListener('click', async ()=>{ 
  if(sessionRole!=='Gerente') return showModal('Error', 'Solo Gerente puede eliminar movimientos.', false); 
  const ids=getSelectedConsignIds(); if(ids.length===0) return showModal('Atenci√≥n', 'Seleccione al menos un movimiento para eliminar.', false);
  const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
  const selectedData = currentConsignsSnapshot.filter(c => ids.includes(c.id));
  
  if(!await checkSensitiveAction(selectedData)) return;

  showModal('Confirmaci√≥n', `¬øEliminar ${ids.length} items permanentemente?`, true, async () => {
    try {
        // 1. Eliminar los documentos seleccionados
        const deletionBatch = db.batch(); 
        ids.forEach(id=> deletionBatch.delete(col.doc(id))); 
        await deletionBatch.commit();
        
        // --- L√ìGICA DE RECALCULO DE CORTES AFECTADOS ---
        const affectedGreenSeparatorIds = new Set();
        // Solo las consignaciones verificadas por Gerente que se acaban de borrar
        const deletedVerifiedConsigns = selectedData.filter(c => c.verifiedRole === 'Gerente' && !c.isSeparator);
        
        // 2. Identificar los cortes (separadores verdes) que conten√≠an el movimiento eliminado
        deletedVerifiedConsigns.forEach(deletedConsign => {
            const deletedDate = deletedConsign.fecha.toDate().getTime();

            // Buscar el NEXT green separator en el snapshot local (pre-delete)
            const affectedGreenSeparator = currentConsignsSnapshot.find(c => 
                c.type === 'green' && c.fecha.toDate().getTime() > deletedDate
            );
            
            if (affectedGreenSeparator) {
                affectedGreenSeparatorIds.add(affectedGreenSeparator.id);
            }
        });

        if (affectedGreenSeparatorIds.size > 0) {
            
            // 3. Obtener la lista de consignaciones REMANENTES (data fresca post-eliminaci√≥n)
            const updatedSnapshot = await col.orderBy('fecha').get();
            const updatedConsigns = [];
            updatedSnapshot.forEach(doc => updatedConsigns.push({id: doc.id, ...doc.data()}));

            const updateBatch = db.batch();
            let recalculationCount = 0;

            // 4. Recalcular cada corte afectado
            for (const greenId of affectedGreenSeparatorIds) {
                const affectedGreenSeparator = currentConsignsSnapshot.find(c => c.id === greenId);
                if (!affectedGreenSeparator) continue; // Si se elimin√≥ el separador o no se encontr√≥

                // Encontrar el RED separator inmediatamente precedente al corte afectado
                const greenIndex = currentConsignsSnapshot.indexOf(affectedGreenSeparator);
                let precedingRedSeparator = null;
                for (let i = greenIndex - 1; i >= 0; i--) {
                    if (currentConsignsSnapshot[i].type === 'red') {
                        precedingRedSeparator = currentConsignsSnapshot[i];
                        break;
                    }
                }

                // Definir el inicio del periodo de c√°lculo (fecha del rojo, o fecha de inicio)
                const queryStart = precedingRedSeparator ? precedingRedSeparator.fecha.toDate().getTime() : new Date(0).getTime();
                const queryEnd = affectedGreenSeparator.fecha.toDate().getTime();

                // Sumar las consignaciones restantes verificadas por Gerente en ese periodo
                const remainingConsignsInPeriod = updatedConsigns
                    .filter(c => 
                        !c.isSeparator && 
                        c.verifiedRole === 'Gerente' && 
                        c.fecha.toDate().getTime() > queryStart && 
                        c.fecha.toDate().getTime() < queryEnd
                    );

                const newCutTotal = remainingConsignsInPeriod.reduce((sum, c) => sum + Number(c.valor || 0), 0);
                
                // Aplicar la actualizaci√≥n al separador verde
                updateBatch.update(col.doc(greenId), { 
                    total: newCutTotal,
                    label: `üö® Recalculado ${new Date().toLocaleDateString()}` 
                });
                recalculationCount++;
            }
            
            await updateBatch.commit();
            showModal('¬°Atenci√≥n!', `Eliminaci√≥n exitosa. ${recalculationCount} CORTES afectados han sido recalculados y corregidos.`, false);
        } else {
            showModal('√âxito', `${ids.length} items eliminados.`, false);
        }

    } catch(e) { 
        if(e.message !== "Acci√≥n cancelada.") showModal('Error', 'Error al eliminar: '+e.message, false);
    }
  });
});

$('btn-cuadrar').addEventListener('click', async () => {
  if (!selectedAccountId) return showModal('Atenci√≥n', 'Seleccione una cuenta.', false);
  
  let pendingItems = [];
  for(const item of currentConsignsSnapshot){
    if(item.isSeparator) pendingItems = [];
    else pendingItems.push(item);
  }
  if(pendingItems.length === 0) return showModal('Atenci√≥n', "Nada nuevo para cuadrar. No hay movimientos pendientes desde el √∫ltimo corte.", false);

  const nonYellow = pendingItems.filter(i => i.verifiedRole !== 'Gerente');
  if(nonYellow.length > 0) return showModal('Atenci√≥n', `Hay ${nonYellow.length} items sin verificar por Gerente. Verifique todos los √≠tems primero.`, false);

  const total = pendingItems.reduce((acc, curr) => acc + Number(curr.valor || 0), 0);
  
  showModal('Confirmaci√≥n', `¬øRealizar corte?\nTotal a Cuadrar: ${fmtCOP(total)}`, true, async () => {
    const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
    const batch = db.batch();
    const now = new Date();
    
    batch.set(col.doc(), { isSeparator:true, type:'green', label: now.toLocaleDateString(), total: total, fecha: firebase.firestore.Timestamp.fromDate(now) });
    batch.set(col.doc(), { isSeparator:true, type:'red', label: now.toLocaleDateString(), total: 0, fecha: firebase.firestore.Timestamp.fromDate(new Date(now.getTime()+1000)) });

    await batch.commit();
    showModal('√âxito', '¬°Corte realizado con √©xito!', false);
  });
});

$('btn-sumar').addEventListener('click', ()=>{
  const rows = Array.from(document.querySelectorAll('#consigns-body input[type="checkbox"]:checked'));
  let suma = 0;
  rows.forEach(ch=>{
    const index = parseInt(ch.dataset.idx);
    const item = currentConsignsSnapshot[index];
    if(item && !item.isSeparator) {
        suma += Number(item.valor || 0);
    }
  });
  showModal('Suma de Selecci√≥n', `La suma de los √≠tems seleccionados es: ${fmtCOP(suma)}`, false);
});

/* CALCULOS TOTALES */
async function updateSelectedTotals(){ 
  if(!selectedAccountId){ $('total-cuenta').textContent = 0; return; }
  let total = 0; 
  currentConsignsSnapshot.forEach(d=>{ if(!d.isSeparator) total += Number(d.valor || 0); }); 
  $('total-cuenta').textContent = fmtCOP(total); 
}

async function updateTotalGeneral(){ 
  try{ 
    const snap = await db.collectionGroup('consignaciones').get(); 
    let total = 0; 
    snap.forEach(d=>{ if(!d.data().isSeparator) total += Number(d.data().valor || 0); }); 
    $('total-general').textContent = fmtCOP(total); 
  }catch(e){ console.error("Error al actualizar total general:", e); } 
}
setInterval(updateTotalGeneral,15000); updateTotalGeneral();

/* BUSQUEDA */
const filter = (id) => {
    const q = $(id).value.toLowerCase();
    document.querySelectorAll('#accounts-list .account-item').forEach(it => {
        it.style.display = it.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
};
$('search-name').addEventListener('input', () => filter('search-name'));
$('search-account').addEventListener('input', () => filter('search-account'));

window.addEventListener('load', ()=>{ 
    if(!usuario){ return; } 
    $('modal-options').classList.remove('hidden'); $('manager-pass').value=''; 
});
window.addEventListener('beforeunload', ()=>{ if(consignsUnsub) consignsUnsub(); });

</script>
</body>
</html>
