<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Consignaciones - Gerencia</title>

  <style>
    :root{
      --bg:#f3f6fb; --card:#fff; --accent:#2563eb; --muted:#6b7280;
      --border:#e6e9ef; --danger:#dc2626; --ok:#10b981;
      --admin-gray:#e5e7eb;
      --manager-yellow:#fff7c2;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#0f172a}
    #topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:var(--card);border-bottom:1px solid var(--border)}
    .layout{display:flex;height:calc(100vh - 56px)}
    .sidebar{width:320px;padding:16px;background:#fff;border-right:1px solid var(--border);overflow:auto}
    .main{flex:1;padding:18px;overflow:auto}
    h2,h3{margin:0 0 8px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], input[type=date], select, textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:#fff}
    textarea{resize:vertical}
    .btn{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn.ghost{background:#f1f5f9;color:#0f172a}
    .btn.danger{background:var(--danger)}
    .panel{background:var(--card);padding:12px;border-radius:8px;border:1px solid var(--border);box-shadow:0 2px 6px rgba(15,23,42,0.03);margin-bottom:12px}
    /* Estilos de la lista de cuentas */
    .account-item{padding:10px;border-radius:6px;border:1px solid var(--border);margin-bottom:8px;cursor:pointer;background:#fff; position: relative;}
    .account-item.selected{border-left:4px solid var(--accent);background:#f0f6ff}
    .account-item .del-btn {
      position: absolute; top: 10px; right: 10px; 
      color: var(--danger); font-size: 16px; display: none; padding: 2px;
      border-radius: 4px;
    }
    .account-item .del-btn:hover { background: #fee2e2; }

    .flex-row{display:flex;gap:8px;align-items:center}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border:1px solid var(--border);background:transparent}
    tr.verified-admin{background:var(--admin-gray)}
    tr.verified-gerente{background:var(--manager-yellow)}
    
    /* Separadores */
    tr.separator{font-weight:700;text-align:center}
    tr.sep-green{background:#d1fae5!important; color: #065f46;}
    tr.sep-red{background:#fee2e2!important; color: #991b1b;}
    
    .muted{color:var(--muted);font-size:13px}
    .top-totals{display:flex;gap:12px;align-items:center}
    .top-totals .card{padding:8px;border-radius:8px;border:1px solid var(--border);background:#fff}
    .small{font-size:12px;color:var(--muted)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center}
    .modal .card{width:720px;max-width:96%;padding:16px}
    .hidden{display:none}
    .gear{cursor:pointer;padding:6px;border-radius:6px;border:1px solid var(--border);background:#fff}
  </style>
</head>
<body>

  <div id="topbar">
    <div style="display:flex;gap:12px;align-items:center">
      <strong>Sistema de Consignaciones</strong>
      <div class="small">Formato: FECHA / VALOR / FECHA OBS</div>
    </div>

    <div class="top-totals">
      <div class="card small">
        <div class="muted">Total general (todas las cuentas)</div>
        <div id="total-general">0</div>
      </div>
      <div class="card small">
        <div class="muted">Total cuenta seleccionada</div>
        <div id="total-cuenta">0</div>
      </div>
      <div class="card small">
        <div class="muted">Sesi√≥n</div>
        <div id="user-info">cargando...</div>
      </div>
      <button id="open-options" class="btn ghost">Opciones</button>
      <button id="logout" class="btn ghost">Salir</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <h3>Buscar / Cuentas</h3>

      <label>Buscar por nombre</label>
      <input id="search-name" type="text" placeholder="Nombre...">

      <label style="margin-top:10px">Buscar por n√∫mero de cuenta</label>
      <input id="search-account" type="text" placeholder="000000...">

      <div style="margin-top:12px" class="panel">
        <h4 style="margin-bottom:8px">Agregar nueva cuenta</h4>
        <label>Nombre</label>
        <input id="new-account-name" type="text">
        <label style="margin-top:8px">N√∫mero</label>
        <input id="new-account-number" type="text">
        <div style="margin-top:8px" class="flex-row">
          <button id="add-account" class="btn" style="flex:1">Agregar</button>
        </div>
      </div>

      <div>
        <div class="muted" style="margin-bottom:6px">Cuentas</div>
        <div id="accounts-list" style="max-height:50vh;overflow:auto"></div>
      </div>
    </div>

    <div class="main">

      <div class="panel">
        <h3>Agregar consignaci√≥n</h3>
        <div id="selected-account-info" class="muted" style="margin-bottom:8px">Ninguna cuenta seleccionada</div>

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label>FECHA</label>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label><input type="radio" name="dateOpt" value="today"> Hoy</label>
              <label><input type="radio" name="dateOpt" value="yesterday"> Ayer</label>
              <label><input type="radio" name="dateOpt" value="daybefore"> Antier</label>
              <label style="margin-left:6px">Manual</label>
              <input id="date-picker" type="date">
            </div>
          </div>

          <div style="flex:1">
            <label>FECHA DE OBSERVACI√ìN</label>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label><input type="radio" name="obsOpt" value="today"> Hoy</label>
              <label><input type="radio" name="obsOpt" value="yesterday"> Ayer</label>
              <label><input type="radio" name="obsOpt" value="daybefore"> Antier</label>
              <label style="margin-left:6px">Manual</label>
              <input id="obsdate-picker" type="date">
            </div>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:end">
          <div style="flex:1">
            <label>VALOR (COP)</label>
            <input id="valor" type="number" placeholder="0">
          </div>
          <div style="width:220px">
            <button id="add-consign" class="btn" style="width:100%">Agregar consignaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Lista de consignaciones</h3>
          <div>
            <button id="btn-verify" class="btn">Verificado</button>
            <button id="btn-unverify" class="btn ghost">Desverificar</button>
            <button id="btn-delete" class="btn danger" style="display:none">Eliminar (Gerente)</button>
            <button id="btn-sumar" class="btn ghost">Sumar selecci√≥n</button>
            <button id="btn-cuadrar" class="btn ghost" style="display:none; border:1px solid var(--accent); color:var(--accent)">‚úÖ Cuadrar (Corte)</button>
          </div>
        </div>

        <div style="margin-top:12px;max-height:52vh;overflow:auto">
          <table>
            <thead>
              <tr><th>Sel</th><th>FECHA</th><th>VALOR</th><th>FECHA OBS</th><th>ESTADO</th></tr>
            </thead>
            <tbody id="consigns-body"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <div id="modal-options" class="modal hidden">
    <div class="panel card" style="width:720px;max-width:96%">
      <h3>Opciones de Acceso (seleccione)</h3>
      <div style="margin-top:8px">
        <label><input type="radio" name="sessionRole" value="Administrativo" checked> Administrativo</label>
        <label style="margin-left:12px"><input type="radio" name="sessionRole" value="Gerente"> Gerente</label>
      </div>

      <div id="manager-pass-area" class="hidden" style="margin-top:12px">
        <label>Clave Gerente</label>
        <input id="manager-pass" type="password" value="">
      </div>

      <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <span class="gear" id="gear-change" title="Cambiar clave">‚öôÔ∏è</span>
          <small class="muted" style="margin-left:8px">Usa la tuerca para cambiar la clave por defecto (0000)</small>
        </div>
        <div>
          <button id="options-continue" class="btn">Continuar</button>
          <button id="options-cancel" class="btn ghost">Cancelar</button>
        </div>
      </div>

      <div id="gear-panel" class="hidden" style="margin-top:14px">
        <label>Nueva clave Gerente</label>
        <input id="new-manager-pass" type="text" placeholder="Nueva clave (ej. 1234)">
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button id="save-manager-pass" class="btn">Guardar clave</button>
          <button id="cancel-gear" class="btn ghost">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
<script>
/* ============= CONFIG FIREBASE ============= */
const firebaseConfig = {
  apiKey:"AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU",
  authDomain:"lazapateria-c4157.firebaseapp.com",
  projectId:"lazapateria-c4157",
  storageBucket:"lazapateria-c4157.firebasestorage.app",
  messagingSenderId:"300241769138",
  appId:"1:300241769138:web:8ca1847de3c4fb5042afab"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============= ESTADO ============= */
const usuario = JSON.parse(localStorage.getItem('datosUsuario') || 'null');
if(!usuario){ alert('No hay sesi√≥n activa.'); location.href='index.html'; }
// Validaci√≥n simple de seguridad
if(usuario.permisos !== 'Administrador'){ alert('Acceso denegado. Solo administradores.'); location.href='index.html'; }

document.getElementById('user-info').textContent = usuario.usuario + ' ‚Äî ' + usuario.permisos;
document.getElementById('logout').onclick = ()=>{ localStorage.removeItem('datosUsuario'); location.href='index.html'; };

let sessionRole = 'Administrativo'; // 'Administrativo' | 'Gerente'
let managerPass = localStorage.getItem('managerPass') || '0000';
let selectedAccountId = null;
let currentConsignsSnapshot = []; // Cache local para validaciones r√°pidas

/* UTIL */
const $ = id => document.getElementById(id);
function fmtCOP(n){ return new Intl.NumberFormat('es-CO').format(Number(n||0)); }

/* MODAL OPCIONES */
$('open-options').addEventListener('click', ()=> {
  $('modal-options').classList.remove('hidden');
  document.querySelector('input[name="sessionRole"][value="Administrativo"]').checked = true;
  $('manager-pass-area').classList.add('hidden');
  $('manager-pass').value = '';
  $('gear-panel').classList.add('hidden');
});

document.querySelectorAll('input[name="sessionRole"]').forEach(r=>{
  r.addEventListener('change', (e)=>{
    if(e.target.value === 'Gerente') $('manager-pass-area').classList.remove('hidden');
    else $('manager-pass-area').classList.add('hidden');
  });
});

$('options-cancel').addEventListener('click', ()=> $('modal-options').classList.add('hidden'));
$('gear-change').addEventListener('click', ()=> $('gear-panel').classList.toggle('hidden'));
$('cancel-gear').addEventListener('click', ()=> $('gear-panel').classList.add('hidden'));
$('save-manager-pass').addEventListener('click', ()=>{
  const p = $('new-manager-pass').value.trim(); if(!p){ alert('Ingrese nueva clave'); return; }
  managerPass = p; localStorage.setItem('managerPass', managerPass); alert('Clave de gerente actualizada'); $('gear-panel').classList.add('hidden');
});

$('options-continue').addEventListener('click', ()=>{
  const chosen = document.querySelector('input[name="sessionRole"]:checked').value;
  if(chosen === 'Gerente'){
    const pass = $('manager-pass').value;
    if(pass !== managerPass){ alert('Clave de gerente incorrecta'); return; }
    sessionRole = 'Gerente';
  } else sessionRole = 'Administrativo';

  // Mostrar/Ocultar botones seg√∫n rol
  if(sessionRole === 'Gerente'){
    $('btn-delete').style.display = 'inline-block';
    $('btn-cuadrar').style.display = 'inline-block';
    // Mostrar botones de borrar cuenta en el sidebar
    document.querySelectorAll('.del-btn').forEach(b => b.style.display = 'block');
  } else {
    $('btn-delete').style.display = 'none';
    $('btn-cuadrar').style.display = 'none';
    document.querySelectorAll('.del-btn').forEach(b => b.style.display = 'none');
  }
  $('modal-options').classList.add('hidden');
  alert('Sesi√≥n como: ' + sessionRole);
});

/* SUBSCRIBE CUENTAS */
function subscribeAccounts(){
  db.collection('cuentas').orderBy('name').onSnapshot(snapshot=>{
    const container = $('accounts-list'); container.innerHTML = '';
    snapshot.forEach(doc=>{
      const a = { id: doc.id, ...doc.data() };
      
      const div = document.createElement('div'); 
      div.className = 'account-item' + (selectedAccountId === a.id ? ' selected' : '');
      
      // Contenido de la cuenta
      const content = `
        <div style="font-weight:600; padding-right:20px;">${a.name}</div>
        <div class="muted">${a.number || ''}</div>
      `;
      div.innerHTML = content;

      // === BOT√ìN DE ELIMINAR CUENTA (NUEVO) ===
      const delBtn = document.createElement('span');
      delBtn.className = 'del-btn';
      delBtn.textContent = 'üóëÔ∏è';
      delBtn.title = "Eliminar cuenta";
      // Solo visible si ya es gerente al cargar, o se actualiza al cambiar rol
      if(sessionRole === 'Gerente') delBtn.style.display = 'block';
      
      delBtn.onclick = (e) => {
        e.stopPropagation(); // Evitar seleccionar la cuenta al hacer click en borrar
        deleteAccount(a.id, a.name);
      };
      div.appendChild(delBtn);

      div.onclick = ()=>{ selectedAccountId = a.id; renderConsigns(); $('selected-account-info').textContent = `Cuenta: ${a.name} ‚Äî ${a.number || ''}`; updateSelectedTotals(); };
      container.appendChild(div);
    });
    if(!selectedAccountId && snapshot.docs.length>0){ selectedAccountId = snapshot.docs[0].id; renderConsigns(); }
  });
}
subscribeAccounts();

async function deleteAccount(id, name){
    if(sessionRole !== 'Gerente') return alert("Solo el Gerente puede eliminar cuentas.");
    if(!confirm(`¬øATENCI√ìN: Est√° seguro que desea eliminar la cuenta bancaria "${name}"?\nEsta acci√≥n no se puede deshacer.`)) return;
    
    try {
        await db.collection('cuentas').doc(id).delete();
        if(selectedAccountId === id) {
             selectedAccountId = null;
             $('consigns-body').innerHTML = '';
             $('selected-account-info').textContent = 'Ninguna cuenta seleccionada';
        }
        alert("Cuenta eliminada correctamente.");
    } catch(e) {
        console.error(e);
        alert("Error al eliminar: " + e.message);
    }
}

/* RENDER CONSIGNACIONES */
let consignsUnsub = null;
function renderConsigns(){ 
  if(consignsUnsub) consignsUnsub(); 
  const tbody = $('consigns-body'); tbody.innerHTML = '';
  currentConsignsSnapshot = []; // reset cache

  if(!selectedAccountId) return;

  consignsUnsub = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').orderBy('fecha').onSnapshot(snapshot=>{
    tbody.innerHTML = '';
    currentConsignsSnapshot = []; // Actualizar cache
    snapshot.forEach(doc => currentConsignsSnapshot.push({id: doc.id, ...doc.data()}));

    snapshot.forEach(doc=>{
      const c = doc.data();

      if(c.isSeparator){
        const tr=document.createElement('tr');
        tr.classList.add('separator');
        if(c.type==='green') tr.classList.add('sep-green');
        if(c.type==='red') tr.classList.add('sep-red');
        
        // Texto diferenciado seg√∫n tipo
        let labelText = `--- ${c.label} ---`;
        if(c.type === 'green') labelText = `üí∞ TOTAL CUADRE: ${fmtCOP(c.total)}`;
        if(c.type === 'red') labelText = `üõë CORTE REALIZADO CON CLIENTE (${c.label})`;

        tr.innerHTML = `<td></td><td colspan="3">${labelText}</td><td></td>`;
        tbody.appendChild(tr);
        return;
      }

      const tr = document.createElement('tr');
      if(c.verifiedRole === 'Administrativo') tr.classList.add('verified-admin');
      if(c.verifiedRole === 'Gerente') tr.classList.add('verified-gerente');
      const fechaText = c.fecha && c.fecha.toDate ? new Date(c.fecha.toDate()).toLocaleDateString() : '';
      const obsText = c.obsdate && c.obsdate.toDate ? new Date(c.obsdate.toDate()).toLocaleDateString() : '';
      tr.innerHTML = `
        <td style="width:56px"><input type="checkbox" data-id="${doc.id}"></td>
        <td style="width:160px">${fechaText}</td>
        <td style="width:140px">${fmtCOP(c.valor)}</td>
        <td style="width:160px">${obsText}</td>
        <td style="width:160px">${c.verifiedRole ? (c.verifiedRole === 'Gerente' ? 'Verificado (Gerente)' : 'Verificado (Admin)') : 'Sin verificar'}</td>
      `; tbody.appendChild(tr);
    });
    updateSelectedTotals(); updateTotalGeneral(); setupShiftSelection();
  });
}

// ENTER PARA AGREGAR
$('valor').addEventListener('keydown', e=>{
  if(e.key==='Enter') $('add-consign').click();
});

// SHIFT SELECCI√ìN
let lastCheckedIndex = null;
function setupShiftSelection(){
  const checks = Array.from(document.querySelectorAll('#consigns-body input[type="checkbox"]'));
  checks.forEach((chk, idx)=>{
    chk.addEventListener('click', e=>{
      if(!e.shiftKey || lastCheckedIndex===null){ lastCheckedIndex = idx; return; }
      const start = Math.min(lastCheckedIndex, idx);
      const end = Math.max(lastCheckedIndex, idx);
      for(let i=start;i<=end;i++) checks[i].checked = true;
    });
  });
}

$('add-account').addEventListener('click', async ()=>{
  const name = $('new-account-name').value.trim(); const number = $('new-account-number').value.trim(); if(!name||!number) return alert('Nombre y n√∫mero requeridos.');
  try{ await db.collection('cuentas').add({ name, number }); $('new-account-name').value=''; $('new-account-number').value=''; }catch(e){ console.error(e); alert('Error creando cuenta: '+e.message); }
});

function parseDateRadio(name, pickerId){ const opts = document.getElementsByName(name); let sel=null; for(const r of opts) if(r.checked) sel=r.value; if(sel==='today') return new Date(); if(sel==='yesterday'){ const d=new Date(); d.setDate(d.getDate()-1); return d; } if(sel==='daybefore'){ const d=new Date(); d.setDate(d.getDate()-2); return d; } const v=$(pickerId).value; return v? new Date(v): null; }

$('add-consign').addEventListener('click', async ()=>{
  if(!selectedAccountId) return alert('Seleccione una cuenta.');
  const fecha = parseDateRadio('dateOpt','date-picker'); const obsdate = parseDateRadio('obsOpt','obsdate-picker'); const valor = Number($('valor').value || 0);
  if(!fecha) return alert('Seleccione una fecha v√°lida.');
  try{ await db.collection('cuentas').doc(selectedAccountId).collection('consignaciones').add({ fecha: firebase.firestore.Timestamp.fromDate(fecha), obsdate: obsdate? firebase.firestore.Timestamp.fromDate(obsdate): null, valor, verifiedBy:null, verifiedRole:null }); $('valor').value=''; }catch(e){ console.error(e); alert('Error agregando consignaci√≥n: '+e.message); }
});

function getSelectedConsignIds(){ return Array.from(document.querySelectorAll('#consigns-body input[type="checkbox"]')).filter(c=>c.checked).map(c=>c.dataset.id); }

$('btn-verify').addEventListener('click', async ()=>{
  if(!selectedAccountId) return alert('Seleccione cuenta.'); const ids=getSelectedConsignIds(); if(ids.length===0) return alert('Seleccione al menos una consignaci√≥n.'); const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones'); try{ const batch = db.batch(); ids.forEach(id=> batch.update(col.doc(id), { verifiedBy: usuario.usuario, verifiedRole: sessionRole })); await batch.commit(); }catch(e){ console.error(e); alert('Error verificando: '+e.message); }
});

$('btn-unverify').addEventListener('click', async ()=>{
  if(!selectedAccountId) return alert('Seleccione cuenta.');
  const ids=getSelectedConsignIds(); if(ids.length===0) return alert('Seleccione al menos una consignaci√≥n.');
  const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
  // Chequeo de seguridad simple: si admin intenta quitar verificado de gerente
  // Nota: Esto requerir√≠a leer doc por doc, para agilidad lo dejamos al backend o confianza del frontend simple
  try{
    const batch = db.batch();
    ids.forEach(id=> batch.update(col.doc(id), { verifiedBy:null, verifiedRole:null }));
    await batch.commit();
  }catch(e){ console.error(e); alert('Error desverificando: '+e.message); }
});

$('btn-delete').addEventListener('click', async ()=>{ if(sessionRole!=='Gerente') return alert('Solo Gerente puede eliminar.'); if(!selectedAccountId) return alert('Seleccione cuenta.'); const ids=getSelectedConsignIds(); if(ids.length===0) return alert('Seleccione al menos una consignaci√≥n.'); if(!confirm('Eliminar '+ids.length+' consignaci√≥n(es)?')) return; const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones'); try{ const batch = db.batch(); ids.forEach(id=> batch.delete(col.doc(id))); await batch.commit(); }catch(e){ console.error(e); alert('Error eliminando: '+e.message); } });

/* =========== L√ìGICA DE CUADRE (CORTE) ACTUALIZADA =========== */
$('btn-cuadrar').addEventListener('click', async () => {
  if (!selectedAccountId) return alert('Seleccione una cuenta.');

  // 1. Identificar items pendientes de cuadre
  // Recorremos el snapshot actual. Si encontramos un separador, reiniciamos la lista de pendientes.
  // As√≠ obtenemos solo lo que est√° DESPU√âS del √∫ltimo corte.
  let pendingItems = [];
  
  for(const item of currentConsignsSnapshot){
    if(item.isSeparator){
      pendingItems = []; // Hubo un corte previo, descartar lo anterior
    } else {
      pendingItems.push(item);
    }
  }

  if(pendingItems.length === 0) return alert("No hay consignaciones nuevas para cuadrar desde el √∫ltimo corte.");

  // 2. Validar que TODOS est√©n en Amarillo (Gerente)
  // Constraint: "no deje cuadrar si no estan todas en amarillo"
  const nonYellow = pendingItems.filter(i => i.verifiedRole !== 'Gerente');
  
  if(nonYellow.length > 0){
    // Highlight visual simple (opcional) o solo alerta
    return alert(`NO SE PUEDE CUADRAR.\nHay ${nonYellow.length} consignaci√≥n(es) que no han sido verificadas por el Gerente (Color Amarillo).\nVerifique todo antes de hacer el corte.`);
  }

  // 3. Calcular Suma
  const total = pendingItems.reduce((acc, curr) => acc + Number(curr.valor || 0), 0);
  const fechaTxt = new Date().toLocaleDateString();

  // 4. Agregar Separadores (Verde y Rojo)
  if(!confirm(`¬øConfirmar cuadre?\n\nTotal a cortar: ${fmtCOP(total)}\n\nEsto agregar√° el corte verde (total) y el rojo (separador).`)) return;

  const col = db.collection('cuentas').doc(selectedAccountId).collection('consignaciones');
  const batch = db.batch();

  // Crear referencias para asegurar orden. Usamos fechas actuales.
  // Truco: Ponemos unos milisegundos de diferencia para que queden en orden Verde -> Rojo
  const now = new Date();
  const nowPlus1 = new Date(now.getTime() + 1000);

  // Registro Verde: El Total
  const refGreen = col.doc();
  batch.set(refGreen, {
    isSeparator: true,
    type: 'green',
    label: fechaTxt,
    total: total,
    fecha: firebase.firestore.Timestamp.fromDate(now) // Fecha para ordenamiento
  });

  // Registro Rojo: El Corte
  const refRed = col.doc();
  batch.set(refRed, {
    isSeparator: true,
    type: 'red',
    label: fechaTxt,
    total: 0, // No suma, solo corta
    fecha: firebase.firestore.Timestamp.fromDate(nowPlus1)
  });

  try {
    await batch.commit();
    alert("Cuadre y corte realizados exitosamente.");
  } catch (e) {
    console.error(e);
    alert("Error al realizar el cuadre: " + e.message);
  }
});

$('btn-sumar').addEventListener('click', ()=>{
  const rows = Array.from(document.querySelectorAll('#consigns-body input[type="checkbox"]'));
  let suma = 0;
  rows.forEach(ch=>{
    if(ch.checked){ const tr=ch.closest('tr'); const val = tr.children[2].textContent.replace(/\./g,'').replace(/,/g,''); suma += Number(val)||0; }
  });
  alert('Total seleccionado: '+fmtCOP(suma));
});

/* TOTALES - IGNORAR SEPARADORES */
async function updateSelectedTotals(){ 
  if(!selectedAccountId){ $('total-cuenta').textContent = fmtCOP(0); return; } 
  // Nota: Usamos la data en memoria currentConsignsSnapshot para evitar otra llamada,
  // pero cuidado con filtrado. La l√≥gica original sumaba TODO lo no separador.
  let total = 0; 
  currentConsignsSnapshot.forEach(d=>{ 
    if(!d.isSeparator) total += Number(d.valor || 0); 
  }); 
  $('total-cuenta').textContent = fmtCOP(total); 
}

async function updateTotalGeneral(){ 
  try{ 
    const snap = await db.collectionGroup('consignaciones').get(); 
    let total = 0; 
    snap.forEach(d=>{ 
      const data=d.data(); 
      if(!data.isSeparator) total += Number(data.valor || 0); 
    }); 
    $('total-general').textContent = fmtCOP(total); 
  }catch(e){ console.error(e); } 
}

setInterval(updateTotalGeneral,15000); updateTotalGeneral();

/* BUSCADOR */
$('search-name').addEventListener('input', ()=>{ const q=$('search-name').value.toLowerCase(); Array.from(document.querySelectorAll('#accounts-list .account-item')).forEach(it=>{ it.style.display = it.textContent.toLowerCase().includes(q) ? '' : 'none'; }); });
$('search-account').addEventListener('input', ()=>{ const q=$('search-account').value.toLowerCase(); Array.from(document.querySelectorAll('#accounts-list .account-item')).forEach(it=>{ it.style.display = it.textContent.toLowerCase().includes(q) ? '' : 'none'; }); });

/* NAV KEYBOARD */
let activeRowIndex = -1;
function getRows(){ return Array.from(document.querySelectorAll('#consigns-body tr')); }
function highlightActive(){ getRows().forEach((r,i)=>{ r.style.outline = (i===activeRowIndex)? '2px solid #3b82f6' : 'none'; }); }
function moveActive(delta){ const rows=getRows(); if(rows.length===0) return; activeRowIndex = Math.min(rows.length-1, Math.max(0, activeRowIndex+delta)); highlightActive(); rows[activeRowIndex].scrollIntoView({block:'nearest'}); }
$('consigns-body').addEventListener('click', e=>{
  const row = e.target.closest('tr'); if(!row) return;
  const rows=getRows(); activeRowIndex = rows.indexOf(row); highlightActive();
});
document.addEventListener('keydown', e=>{
  if(e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') return;
  if(['ArrowUp','ArrowDown','Shift',' '].includes(e.key)) e.preventDefault();
  const rows=getRows(); if(rows.length===0) return;
  if(e.key==='ArrowDown') moveActive(1);
  if(e.key==='ArrowUp') moveActive(-1);
  if(e.key===' ' && activeRowIndex>=0){ const chk=rows[activeRowIndex].querySelector('input[type="checkbox"]'); if(chk){ chk.checked=!chk.checked; }}
  if(e.shiftKey && (e.key==='ArrowDown' || e.key==='ArrowUp')){
    const target=activeRowIndex;
    const prev=lastCheckedIndex ?? target;
    const start=Math.min(prev,target);
    const end=Math.max(prev,target);
    const checks = Array.from(document.querySelectorAll('#consigns-body input[type="checkbox"]'));
    for(let i=start;i<=end;i++) checks[i].checked = true;
  }
});

window.addEventListener('load', ()=>{ $('modal-options').classList.remove('hidden'); $('manager-pass').value=''; });
window.addEventListener('beforeunload', ()=>{ if(consignsUnsub) consignsUnsub(); });

</script>
</body>
</html>
