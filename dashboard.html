<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP Dashboard de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <!-- Chart.js and XLSX -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Fondo suave */
            color: #334155; /* Color de texto principal */
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .sap-container {
            width: 100%;
            max-width: 1200px;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .tabs-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        .tab-button {
            padding: 1rem 2rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: #64748B;
            cursor: pointer;
            border: none;
            background-color: transparent;
            transition: all 0.3s ease;
            position: relative;
            top: 2px; /* Alinea con el borde inferior */
        }
        .tab-button.active {
            color: #3B82F6;
            border-bottom: 2px solid #3B82F6;
        }
        .tab-button:hover:not(.active) {
            color: #1E40AF;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        h1, h2 {
            color: #10B981; /* Emerald Green */
            text-align: center;
            font-weight: 700;
        }
        h1 {
            font-size: 2.25rem; /* text-4xl */
            margin-bottom: 1rem;
        }
        h2 {
            font-size: 1.875rem; /* text-3xl */
            margin-bottom: 1rem;
        }
        .card {
            background-color: #f8fafc; /* Light Gray */
            border-radius: 0.75rem; /* rounded-lg */
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .metric-value {
            font-size: 2.5rem; /* text-5xl */
            font-weight: 700; /* font-bold */
            color: #10B981; /* Emerald Green */
        }
        .metric-label {
            font-size: 1.125rem; /* text-lg */
            color: #475569; /* Dark Gray */
            margin-top: 0.5rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            border: none;
            text-decoration: none;
        }
        .btn-primary {
            background-color: #3B82F6; /* Primary Blue */
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        .btn-primary:hover {
            background-color: #2563EB; /* Darker Blue */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        .btn-secondary {
            background-color: #6B7280; /* Secondary Gray */
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(107, 114, 128, 0.2);
        }
        .btn-secondary:hover {
            background-color: #4B5563; /* Darker Gray */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        }
        .btn-danger {
            background-color: #EF4444; /* Red */
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }
        .btn-danger:hover {
            background-color: #DC2626; /* Darker Red */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }
        input[type="date"], input[type="file"], input[type="number"], select, input[type="text"] {
            padding: 0.75rem;
            border: 1px solid #cbd5e1; /* border-slate-300 */
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #475569;
            background-color: #ffffff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="date"]:focus, input[type="file"]:focus, input[type="number"]:focus, select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for charts */
            width: 100%;
            background-color: #f8fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Responsive adjustments */
        @media (min-width: 768px) { /* md breakpoint */
            .grid-cols-2-md {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .grid-cols-3-md {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .grid-cols-3-lg {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        /* Styles for Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2.5rem; /* Increased padding */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 500px; /* Max width for modal */
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modal-content .close {
            color: #aaa;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem; /* Larger close button */
            font-weight: bold;
            cursor: pointer;
        }

        .modal-content .close:hover,
        .modal-content .close:focus {
            color: black;
            text-decoration: none;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }

        .form-field label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #475569;
        }

        .form-field input[type="number"] {
            width: 100%;
            box-sizing: border-box;
        }
        /* Style for checkbox */
        .form-field-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.5rem; /* Space between checkbox and label */
        }
        .form-field-checkbox input[type="checkbox"] {
            width: auto; /* Override full width for checkbox */
            margin-top: 0;
        }


        /* Gear icon */
        .gear-icon {
            font-size: 2.5em; /* Larger icon */
            cursor: pointer;
            color: #64748B; /* Slate gray */
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .gear-icon:hover {
            transform: rotate(30deg);
            color: #334155;
        }
        /* Gear icon next to "Cargar Excel" */
        .excel-gear-icon {
            font-size: 1.5em; /* Smaller than main gear icon */
            cursor: pointer;
            color: #64748B;
            margin-left: 0.5rem; /* Space from label */
            transition: transform 0.3s ease;
        }
        .excel-gear-icon:hover {
            transform: rotate(30deg);
            color: #334155;
        }


        /* Commission Table Styles */
        .commission-table-container, .history-table-container {
            background-color: #f8fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            overflow-x: auto; /* For responsive tables */
        }

        .commission-table, .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .commission-table th,
        .commission-table td,
        .history-table th,
        .history-table td {
            border: 1px solid #e2e8f0; /* border-slate-200 */
            padding: 0.75rem;
            text-align: left;
        }

        .commission-table th,
        .history-table th {
            background-color: #e2e8f0; /* Light gray for headers */
            font-weight: 600;
            color: #475569;
        }

        .commission-table tr:nth-child(even),
        .history-table tr:nth-child(even) {
            background-color: #f8fafc; /* Alternate row color */
        }
        /* Updated info-text styles */
        .info-text {
            font-size: 0.95rem; /* Slightly larger font */
            color: #475569; /* Darker gray for better contrast */
            background-color: #e0f2fe; /* Light blue background */
            border: 1px solid #90cdf4; /* Blue border */
            border-radius: 0.5rem; /* Rounded corners */
            padding: 1rem; /* More padding */
            margin-top: 1.5rem; /* More space from elements above */
            text-align: center;
            line-height: 1.4; /* Improve readability */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }
        /* Loading overlay */
        .loading-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
        }
        .loading-spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3B82F6; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Confirmation Modal Specific Styles */
        .confirmation-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 400px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .confirmation-modal-content h2 {
            color: #EF4444; /* Red for warning */
            margin-bottom: 1rem;
        }
        .confirmation-modal-content p {
            font-size: 1.1rem;
            color: #475569;
            margin-bottom: 1.5rem;
        }
        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
    </style>
</head>
<body>
    <div class="sap-container">
        <h1 class="text-4xl">SAP Dashboard de Pedidos</h1>

        <div class="tabs-container">
            <button class="tab-button active" onclick="openTab(event, 'dashboard')">DASHBOARD</button>
            <button class="tab-button" onclick="openTab(event, 'comision_general')">COMISIÓN GENERAL</button>
            <button class="tab-button" onclick="openTab(event, 'comision_semanal')">COMISIÓN SEMANAL</button>
            <button class="tab-button" onclick="openTab(event, 'historial_ventas')">VER HISTORIAL</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col gap-4">
                <div class="flex items-center gap-2 w-full">
                    <label for="excel_file_input_dashboard" class="text-lg font-semibold text-gray-700">Cargar Excel:</label>
                    <input type="file" id="excel_file_input_dashboard" accept=".xlsx, .xls" class="flex-grow">
                    <button id="upload_excel_btn_dashboard" class="btn btn-primary">Subir Excel</button>
                    <button id="delete_excel_data_btn_dashboard" class="btn btn-danger">Eliminar Datos Excel</button>
                    <div class="form-field-checkbox ml-auto">
                        <input type="checkbox" id="include_excel_data_checkbox">
                        <label for="include_excel_data_checkbox">Incluir datos de Excel</label>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row items-center gap-4 w-full">
                    <label class="text-lg font-semibold text-gray-700">Filtro Personalizado:</label>
                    <label for="start_date_dashboard" class="text-gray-600">Desde:</label>
                    <input type="date" id="start_date_dashboard" class="flex-grow">
                    <label for="end_date_dashboard" class="text-gray-600">Hasta:</label>
                    <input type="date" id="end_date_dashboard" class="flex-grow">
                    <button id="filter_data_btn_dashboard" class="btn btn-primary w-full md:w-auto">
                        Aplicar Filtros
                    </button>
                </div>

                <div class="flex flex-col md:flex-row items-center gap-4 w-full">
                    <label class="text-lg font-semibold text-gray-700">Filtros Rápidos:</label>
                    <select id="month_selector_dashboard" class="flex-grow">
                        </select>
                    <button id="filter_current_week_btn_dashboard" class="btn btn-secondary w-full md:w-auto">
                        Semana Actual
                    </button>
                    <button id="filter_current_month_btn_dashboard" class="btn btn-secondary w-full md:w-auto">
                        Mes Actual

                    </button>
                </div>

                <button id="reset_dashboard_btn_dashboard" class="btn btn-danger w-full">
                    Reiniciar Dashboard
                </button>
            </div>
            <p class="info-text w-full">
                Para ver el rendimiento de un día específico, selecciona la misma fecha en 'Desde' y 'Hasta'.<br>
                Para un mes, selecciona el primer y último día del mes, o usa el selector de mes.<br>
                **Aplica un filtro para ver los datos del dashboard.**
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3-lg gap-4">
                <div class="card">
                    <div id="total_pares_metric_dashboard" class="metric-value">0</div>
                    <div class="metric-label">Total de Pares Vendidos</div>
                </div>
                <div class="card">
                    <div id="total_valor_metric_dashboard" class="metric-value">$0</div>
                    <div class="metric-label">Valor Total de Ventas</div>
                </div>
                <div class="card">
                    <div id="total_pedidos_metric_dashboard" class="metric-value">0</div>
                    <div class="metric-label">Total de Pedidos</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2-md gap-4">
                <div class="chart-container">
                    <canvas id="salesByDateChart_dashboard"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="salesByAsesorChart_dashboard"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="pairsByProductChart_dashboard"></canvas>
            </div>
        </div>

        <div id="comision_general" class="tab-content">
            <h2 class="text-3xl">Comisión General (Mensual)</h2>
            <span class="gear-icon" title="Configuración de Comisión General" onclick="mostrarModal('commission_general_settings_modal')">&#9881;</span>
            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col gap-4 mt-4">
                <div class="flex flex-col md:flex-row items-center gap-4 w-full">
                    <label class="text-lg font-semibold text-gray-700">Filtro por Mes:</label>
                    <select id="month_selector_general" class="flex-grow">
                        </select>
                    <button id="filter_data_btn_general" class="btn btn-primary w-full md:w-auto">
                        Aplicar Filtro General
                    </button>
                    <button id="reset_filter_btn_general" class="btn btn-danger w-full md:w-auto">
                        Reiniciar Filtro General
                    </button>
                </div>
            </div>
            <div class="commission-table-container mt-4">
                <div id="general_commission_summary">
                    <p class="text-center text-gray-500">Selecciona un mes para calcular la comisión general.</p>
                </div>
            </div>
        </div>

        <div id="comision_semanal" class="tab-content">
            <h2 class="text-3xl">Comisión Semanal</h2>
            <span class="gear-icon" title="Configuración de Comisión Semanal" onclick="mostrarModal('commission_weekly_settings_modal')">&#9881;</span>

            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col gap-4">
                <div class="flex flex-col md:flex-row items-center gap-4 w-full">
                    <label class="text-lg font-semibold text-gray-700">Filtro de Fechas:</label>
                    <label for="start_date_weekly" class="text-gray-600">Desde:</label>
                    <input type="date" id="start_date_weekly" class="flex-grow">
                    <label for="end_date_weekly" class="text-gray-600">Hasta:</label>
                    <input type="date" id="end_date_weekly" class="flex-grow">
                    <button id="filter_data_btn_weekly" class="btn btn-primary w-full md:w-auto">
                        Aplicar Filtro Semanal
                    </button>
                </div>
                <div class="flex flex-col md:flex-row items-center gap-4 w-full">
                    <label class="text-lg font-semibold text-gray-700">Filtros Rápidos:</label>
                    <button id="filter_current_week_btn_weekly" class="btn btn-secondary w-full md:w-auto">
                        Esta Semana
                    </button>
                    <button id="filter_last_week_btn_weekly" class="btn btn-secondary w-full md:w-auto">
                        Semana Pasada
                    </button>
                </div>
                <button id="reset_filter_btn_weekly" class="btn btn-danger w-full">
                    Reiniciar Filtro Semanal
                </button>
            </div>
            <div class="commission-table-container mt-4">
                <div id="weekly_commission_summary">
                    <p class="text-center text-gray-500">Selecciona un rango de fechas para calcular la comisión semanal.</p>
                </div>
            </div>
        </div>

        <div id="historial_ventas" class="tab-content">
            <h2 class="text-3xl">Historial de Ventas</h2>
            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col gap-4">
                <div class="flex flex-col md:flex-row items-center gap-4 w-full">
                    <label class="text-lg font-semibold text-gray-700">Filtrar Historial:</label>
                    <label for="filter_asesor_history" class="text-gray-600">Asesor:</label>
                    <select id="filter_asesor_history" class="flex-grow">
                        <option value="">Todos</option>
                    </select>
                    <label for="filter_month_history" class="text-gray-600">Mes:</label>
                    <select id="filter_month_history" class="flex-grow">
                        <option value="">Todos</option>
                    </select>
                    <button id="apply_filter_history_btn" class="btn btn-primary w-full md:w-auto">Aplicar Filtros</button>
                    <button id="reset_filter_history_btn" class="btn btn-danger w-full md:w-auto">Reiniciar Filtros</button>
                </div>
            </div>
            <div class="history-table-container mt-4">
                <div id="sales_history_list">
                    <p class="text-center text-gray-500">Aplica filtros para ver el historial de ventas.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="excel_actions_modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('excel_actions_modal')">&times;</span>
            <h2>Acciones de Archivo Excel</h2>
            <div class="form-field">
                <label for="excel_file_input_modal" class="text-lg font-semibold text-gray-700">Seleccionar archivo:</label>
                <input type="file" id="excel_file_input_modal" accept=".xlsx, .xls">
            </div>
            <button id="upload_excel_btn_modal" class="btn btn-primary">Subir Excel</button>
            <button id="delete_excel_data_btn_modal" class="btn btn-danger">Eliminar Datos Excel Cargados</button>
        </div>
    </div>

    <div id="delete_confirmation_modal" class="modal">
        <div class="confirmation-modal-content">
            <h2>Confirmar Eliminación</h2>
            <p>¿Estás seguro de que quieres eliminar TODOS los datos cargados desde archivos Excel? Esta acción es irreversible.</p>
            <div class="confirmation-buttons">
                <button class="btn btn-danger" onclick="confirmDeleteExcelData()">Eliminar Definitivamente</button>
                <button class="btn btn-secondary" onclick="cerrarModal('delete_confirmation_modal')">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="commission_general_settings_modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('commission_general_settings_modal')">&times;</span>
            <h2>Configuración de Comisión General</h2>
            <h3>Comisión Mensual (para el período filtrado)</h3>
            <div class="form-field">
                <label for="monthly_company_pairs_threshold_input">Tope de Pares (Empresa, ej: 17500):</label>
                <input type="number" id="monthly_company_pairs_threshold_input" value="17500" min="0" step="1">
            </div>
            <div class="form-field">
                <label for="monthly_company_commission_amount_input">Monto Comisión (Empresa, COP, ej: 200000):</label>
                <input type="number" id="monthly_company_commission_amount_input" value="200000" min="0" step="1000">
            </div>
            <div class="form-field">
                <label for="monthly_individual_pairs_threshold_input">Tope Pares (Asesor Individual, ej: 1200):</label>
                <input type="number" id="monthly_individual_pairs_threshold_input" value="1200" min="0" step="1">
            </div>
            <button class="btn btn-primary" onclick="saveCommissionGeneralSettings()">Guardar Configuración</button>
        </div>
    </div>

    <div id="commission_weekly_settings_modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('commission_weekly_settings_modal')">&times;</span>
            <h2>Configuración de Comisión Semanal</h2>
            <div class="form-field">
                <label for="weekly_value_base_threshold_input">Tope Valor Base (Semanal, COP, ej: 17500000):</label>
                <input type="number" id="weekly_value_base_threshold_input" value="17500000" min="0" step="1000">
            </div>
            <div class="form-field">
                <label for="weekly_base_commission_amount_input">Monto Comisión Base (Semanal, COP, ej: 80000):</label>
                <input type="number" id="weekly_base_commission_amount_input" value="80000" min="0" step="1000">
            </div>
            <div class="form-field">
                <label for="weekly_incremental_value_threshold_input">Valor para Bono Incremental (Semanal, COP, ej: 2000000):</label>
                <input type="number" id="weekly_incremental_value_threshold_input" value="2000000" min="0" step="1000">
            </div>
            <div class="form-field">
                <label for="weekly_incremental_bonus_amount_input">Monto Bono Incremental (Semanal, COP, ej: 10000):</label>
                <input type="number" id="weekly_incremental_bonus_amount_input" value="10000" min="0" step="1000">
            </div>
            <button class="btn btn-primary" onclick="saveCommissionWeeklySettings()">Guardar Configuración</button>
        </div>
    </div>

    <div id="message_modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('message_modal')">&times;</span>
            <h2 id="message_modal_title" class="text-2xl font-bold mb-4"></h2>
            <p id="message_modal_content" class="text-gray-700 mb-6"></p>
            <button class="btn btn-primary" onclick="cerrarModal('message_modal')">Aceptar</button>
        </div>
    </div>

    <div id="loading_overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="text-xl font-semibold text-gray-700">Cargando datos...</p>
    </div>

    <script>
        // Configuración de Firebase (de tu archivo original dashboard.html)
        const firebaseConfig = {
            apiKey: "AIzaSyChvezwN6DrYXdnBvGLxnjhi4I9xUaxKfU", 
            authDomain: "lazapateria-c4157.firebaseapp.com",
            projectId: "lazapateria-c4157",
            storageBucket: "lazapateria-c4157.firebasestorage.app",
            measurementId: "G-HVG7615JEE"
        };
        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log("Firebase configurado correctamente para el Dashboard SAP.");

        // --- Variables Globales ---
        // allOrdersData contendrá los datos combinados de 'registros' y 'excel_daily_summaries'
        let allOrdersData = []; 
        let salesByDateChart_dashboard, salesByAsesorChart_dashboard, pairsByProductChart_dashboard;

        // Configuración de la comisión (valores por defecto, se cargarán desde Firestore)
        let monthlyCompanyPairsThreshold = 17500;
        let monthlyCompanyCommissionAmount = 200000;
        let monthlyIndividualPairsThreshold = 1200;
        let weeklyValueBaseThreshold = 17500000;
        let weeklyBaseCommissionAmount = 80000;
        let weeklyIncrementalValueThreshold = 2000000;
        let weeklyIncrementalBonusAmount = 10000;

        // Banderas de estado para filtros
        let includeExcelData = true; // Por defecto true, se carga desde localStorage
        let currentDashboardFilterMode = 'custom_date_range'; // Para la pestaña Dashboard
        let currentGeneralMonthFilter = ''; // Para la pestaña Comisión General
        let currentWeeklyFilterMode = 'custom_date_range'; // Para la pestaña Comisión Semanal
        let currentHistoryAsesorFilter = ''; // Para la pestaña Historial
        let currentHistoryMonthFilter = ''; // Para la pestaña Historial

        // --- Elementos del DOM (para la pestaña Dashboard) ---
        const excelFileInputDashboard = document.getElementById('excel_file_input_dashboard');
        const uploadExcelBtnDashboard = document.getElementById('upload_excel_btn_dashboard');
        const deleteExcelDataBtnDashboard = document.getElementById('delete_excel_data_btn_dashboard');
        const includeExcelDataCheckbox = document.getElementById('include_excel_data_checkbox');
        const startDateInputDashboard = document.getElementById('start_date_dashboard');
        const endDateInputDashboard = document.getElementById('end_date_dashboard');
        const filterDataBtnDashboard = document.getElementById('filter_data_btn_dashboard');
        const monthSelectorDashboard = document.getElementById('month_selector_dashboard');
        const filterCurrentWeekBtnDashboard = document.getElementById('filter_current_week_btn_dashboard');
        const filterCurrentMonthBtnDashboard = document.getElementById('filter_current_month_btn_dashboard');
        const resetDashboardBtnDashboard = document.getElementById('reset_dashboard_btn_dashboard');
        const totalParesMetricDashboard = document.getElementById('total_pares_metric_dashboard');
        const totalValorMetricDashboard = document.getElementById('total_valor_metric_dashboard');
        const totalPedidosMetricDashboard = document.getElementById('total_pedidos_metric_dashboard');

        // --- Elementos del DOM (para la pestaña Comisión General) ---
        const monthSelectorGeneral = document.getElementById('month_selector_general');
        const filterDataBtnGeneral = document.getElementById('filter_data_btn_general');
        const resetFilterBtnGeneral = document.getElementById('reset_filter_btn_general');
        const generalCommissionSummaryDiv = document.getElementById('general_commission_summary');


        // --- Elementos del DOM (para la pestaña Comisión Semanal) ---
        const startDateInputWeekly = document.getElementById('start_date_weekly');
        const endDateInputWeekly = document.getElementById('end_date_weekly');
        const filterDataBtnWeekly = document.getElementById('filter_data_btn_weekly');
        const resetFilterBtnWeekly = document.getElementById('reset_filter_btn_weekly');
        const weeklyCommissionSummaryDiv = document.getElementById('weekly_commission_summary');
        const filterCurrentWeekBtnWeekly = document.getElementById('filter_current_week_btn_weekly');
        const filterLastWeekBtnWeekly = document.getElementById('filter_last_week_btn_weekly');

        // --- Elementos del DOM (para la pestaña Historial) ---
        const filterAsesorHistory = document.getElementById('filter_asesor_history');
        const filterMonthHistory = document.getElementById('filter_month_history');
        const applyFilterHistoryBtn = document.getElementById('apply_filter_history_btn');
        const resetFilterHistoryBtn = document.getElementById('reset_filter_history_btn');
        const salesHistoryList = document.getElementById('sales_history_list');

        // --- Elementos de los Modales de Configuración de Comisión ---
        const monthlyCompanyPairsThresholdInput = document.getElementById('monthly_company_pairs_threshold_input');
        const monthlyCompanyCommissionAmountInput = document.getElementById('monthly_company_commission_amount_input');
        const monthlyIndividualPairsThresholdInput = document.getElementById('monthly_individual_pairs_threshold_input');
        const weeklyValueBaseThresholdInput = document.getElementById('weekly_value_base_threshold_input');
        const weeklyBaseCommissionAmountInput = document.getElementById('weekly_base_commission_amount_input');
        const weeklyIncrementalValueThresholdInput = document.getElementById('weekly_incremental_value_threshold_input');
        const weeklyIncrementalBonusAmountInput = document.getElementById('weekly_incremental_bonus_amount_input');

        const loadingOverlay = document.getElementById('loading_overlay');

        // --- Funciones de Utilidad ---

        /**
         * Muestra la capa de carga (spinner).
         */
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        /**
         * Oculta la capa de carga (spinner).
         */
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        /**
         * Muestra un modal de mensaje general al usuario.
         * @param {string} title - El título del mensaje.
         * @param {string} message - El contenido del mensaje.
         */
        function showMessageModal(title, message) {
            document.getElementById('message_modal_title').textContent = title;
            document.getElementById('message_modal_content').textContent = message;
            mostrarModal('message_modal');
        }

        /**
         * Muestra un modal estableciendo su estilo de visualización a 'flex'.
         * @param {string} id - El ID del elemento modal a mostrar.
         */
        function mostrarModal(id) {
            document.getElementById(id).style.display = 'flex';
            // Carga los valores en los modales de configuración de comisión cuando se abren
            if (id === 'commission_general_settings_modal') {
                monthlyCompanyPairsThresholdInput.value = monthlyCompanyPairsThreshold;
                monthlyCompanyCommissionAmountInput.value = monthlyCompanyCommissionAmount;
                monthlyIndividualPairsThresholdInput.value = monthlyIndividualPairsThreshold;
            } else if (id === 'commission_weekly_settings_modal') {
                weeklyValueBaseThresholdInput.value = weeklyValueBaseThreshold;
                weeklyBaseCommissionAmountInput.value = weeklyBaseCommissionAmount;
                weeklyIncrementalValueThresholdInput.value = weeklyIncrementalValueThreshold;
                weeklyIncrementalBonusAmountInput.value = weeklyIncrementalBonusAmount;
            }
        }

        /**
         * Oculta un modal estableciendo su estilo de visualización a 'none'.
         * @param {string} id - El ID del elemento modal a ocultar.
         */
        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        /**
         * Cambia entre pestañas.
         * @param {Event} evt - El evento de clic.
         * @param {string} tabName - El ID del contenido de la pestaña a mostrar.
         */
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.className += " active";

            // Acciones específicas al abrir una pestaña
            if (tabName === 'dashboard') {
                initializeChartsDashboard();
                // Inicialmente, limpiar métricas y gráficos; los datos se cargan solo con el filtro
                totalParesMetricDashboard.textContent = '0';
                totalValorMetricDashboard.textContent = '$0';
                totalPedidosMetricDashboard.textContent = '0';
                salesByDateChart_dashboard.data.labels = [];
                salesByDateChart_dashboard.data.datasets[0].data = [];
                salesByDateChart_dashboard.update();
                salesByAsesorChart_dashboard.data.labels = [];
                salesByAsesorChart_dashboard.data.datasets[0].data = [];
                salesByAsesorChart_dashboard.update();
                pairsByProductChart_dashboard.data.labels = [];
                pairsByProductChart_dashboard.data.datasets[0].data = [];
                pairsByProductChart_dashboard.update();
            } else if (tabName === 'comision_general') {
                populateMonthSelector(monthSelectorGeneral); // Popula para la pestaña de comisión general
                generalCommissionSummaryDiv.innerHTML = '<p class="text-center text-gray-500">Selecciona un mes para calcular la comisión general.</p>';
            } else if (tabName === 'comision_semanal') {
                // La carga inicial para la comisión semanal ocurrirá cuando se aplique el filtro
                weeklyCommissionSummaryDiv.innerHTML = '<p class="text-center text-gray-500">Selecciona un rango de fechas para calcular la comisión semanal.</p>';
            } else if (tabName === 'historial_ventas') {
                populateHistoryFilters();
                salesHistoryList.innerHTML = '<p class="text-center text-gray-500">Aplica filtros para ver el historial de ventas.</p>';
            }
        }

        /**
         * Popula el selector de mes con los últimos 12 meses.
         * @param {HTMLElement} selectorElement - El elemento select a popular.
         */
        function populateMonthSelector(selectorElement) {
            const today = new Date();
            selectorElement.innerHTML = '<option value="">Todos los Meses</option>'; // Opción por defecto
            for (let i = 0; i < 12; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthName = date.toLocaleString('es-CO', { month: 'long', year: 'numeric' });
                const monthValue = date.toISOString().slice(0, 7); // Formato YYYY-MM
                const option = document.createElement('option');
                option.value = monthValue;
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1); // Capitaliza la primera letra
                selectorElement.appendChild(option);
            }
        }

        /**
         * Devuelve un identificador de semana consistente para una fecha dada, definiendo una semana de lunes a sábado.
         * El ID se basa en la fecha del lunes de esa semana (ej: "AAAA-MM-DD").
         * @param {Date} d - El objeto de fecha.
         * @returns {string} Una cadena en formato 'AAAA-MM-DD' que representa el lunes de la semana.
         */
        function getWeekIdentifier(d) {
            const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            const dayOfWeek = date.getDay(); // 0 = Domingo, 1 = Lunes, ..., 6 = Sábado

            // Calcula el lunes de la semana actual
            // Si es domingo (0), retrocede 6 días para llegar al lunes anterior.
            // De lo contrario, retrocede (dayOfWeek - 1) días para llegar al lunes actual.
            const daysToMonday = (dayOfWeek === 0) ? 6 : (dayOfWeek - 1);
            const mondayOfWeek = new Date(date);
            mondayOfWeek.setDate(date.getDate() - daysToMonday);
            
            // Formatea la fecha del lunes como el identificador de la semana (ej: "2024-03-04")
            return mondayOfWeek.toISOString().split('T')[0];
        }

        // --- Obtención de Datos de Firebase ---

        /**
         * Carga todos los pedidos de Firestore desde las colecciones 'registros' y 'excel_daily_summaries'.
         * @returns {Promise<Array>} Una promesa que se resuelve con un array de objetos de pedido combinados.
         */
        async function fetchAllOrdersFromFirestore() {
            showLoading();
            try {
                const orders = [];
                const ordersSnapshot = await db.collection('registros').get(); // No usar orderBy aquí para evitar errores de índice
                ordersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.fecha_hora && data.fecha_hora.toDate) {
                        data.fecha_hora = data.fecha_hora.toDate();
                    }
                    orders.push({ id: doc.id, source: 'registros', ...data });
                });
                console.log("Pedidos cargados de 'registros':", orders.length);

                let combinedData = [...orders];

                // Solo incluye datos de Excel si el checkbox está marcado
                if (includeExcelData) { 
                    const excelSummaries = [];
                    const excelSummariesSnapshot = await db.collection('excel_daily_summaries').get();
                    excelSummariesSnapshot.forEach(doc => {
                        const data = doc.data();
                        let fechaHoraDate = null;
                        if (data.fecha_hora && data.fecha_hora.toDate) {
                            fechaHoraDate = data.fecha_hora.toDate();
                        } else if (typeof data.fecha_hora === 'string') {
                            fechaHoraDate = new Date(data.fecha_hora);
                        } else if (data.fecha_hora && typeof data.fecha_hora.seconds === 'number') { // Fallback for Timestamp objects
                             fechaHoraDate = new Date(data.fecha_hora.seconds * 1000);
                        }

                        const excelDataEntry = {
                            id: doc.id,
                            source: 'excel_summary',
                            asesor: data.asesor || 'Desconocido',
                            num_pares: data.num_pares || 0,
                            valor_total: data.valor_total || 0,
                            fecha_hora: fechaHoraDate
                        };
                        excelSummaries.push(excelDataEntry);
                    });
                    console.log("Resúmenes cargados de 'excel_daily_summaries':", excelSummaries.length);
                    combinedData = combinedData.concat(excelSummaries);
                }

                // Ordena los datos combinados por fecha
                combinedData.sort((a, b) => {
                    const dateA = a.fecha_hora instanceof Date ? a.fecha_hora.getTime() : 0;
                    const dateB = b.fecha_hora instanceof Date ? b.fecha_hora.getTime() : 0;
                    return dateA - dateB;
                });
                allOrdersData = combinedData; // Actualiza el array de datos global
                return combinedData;

            }
            catch (error) {
                console.error("Error al obtener datos de Firestore:", error);
                showMessageModal("Error", "No se pudieron cargar los datos de la base de datos.");
                return [];
            }
            finally {
                hideLoading();
            }
        }

        /**
         * Configura los oyentes en tiempo real para todas las colecciones relevantes.
         */
        function setupRealtimeListeners() {
            // Se realiza una carga inicial para poblar allOrdersData
            fetchAllOrdersFromFirestore().then(() => {
                // Al cargar por primera vez, no aplicar filtros si no hay ninguno seleccionado.
                // Los datos se cargarán con los filtros por defecto (si los hay) o con el estado inicial.
                populateHistoryFilters(); // Siempre poblar los filtros de historial después de cargar los datos
            });

            // Oyente para la colección 'registros'
            db.collection('registros').onSnapshot(snapshot => {
                console.log("Actualización en tiempo real desde la colección 'registros'.");
                fetchAllOrdersFromFirestore().then(() => {
                    // Re-filtrar y actualizar si la pestaña está activa o si un filtro fue aplicado
                    if (document.getElementById('dashboard').classList.contains('active') && (startDateInputDashboard.value || endDateInputDashboard.value || monthSelectorDashboard.value)) {
                        loadAndFilterDashboardData();
                    } else if (document.getElementById('dashboard').classList.contains('active')) {
                        // Si la pestaña Dashboard está activa y no hay filtros específicos, mostrar todos los datos combinados
                        updateDashboardMetricsAndCharts(allOrdersData);
                    }
                    if (document.getElementById('comision_general').classList.contains('active') && currentGeneralMonthFilter) {
                        calculateAndDisplayGeneralCommissions();
                    }
                    if (document.getElementById('comision_semanal').classList.contains('active') && (startDateInputWeekly.value && endDateInputWeekly.value)) {
                        calculateAndDisplayWeeklyCommissions();
                    }
                    if (document.getElementById('historial_ventas').classList.contains('active') && (currentHistoryAsesorFilter || currentHistoryMonthFilter)) {
                        populateHistoryFilters(); 
                        loadAndFilterHistoryData();
                    } else if (document.getElementById('historial_ventas').classList.contains('active')) {
                        populateHistoryFilters(); // Actualiza los filtros de asesor/mes
                        displaySalesHistory(allOrdersData); // Mostrar todos los datos si no hay filtros específicos
                    }
                });
            }, error => {
                console.error("Error al escuchar la colección 'registros':", error);
                showMessageModal("Error de Conexión", "No se pudieron obtener actualizaciones en tiempo real de los pedidos.");
            });

            // Oyente para la colección 'excel_daily_summaries'
            db.collection('excel_daily_summaries').onSnapshot(snapshot => {
                console.log("Actualización en tiempo real desde la colección 'excel_daily_summaries'.");
                fetchAllOrdersFromFirestore().then(() => {
                    if (document.getElementById('dashboard').classList.contains('active') && (startDateInputDashboard.value || endDateInputDashboard.value || monthSelectorDashboard.value)) {
                        loadAndFilterDashboardData();
                    } else if (document.getElementById('dashboard').classList.contains('active')) {
                        updateDashboardMetricsAndCharts(allOrdersData);
                    }
                    if (document.getElementById('comision_general').classList.contains('active') && currentGeneralMonthFilter) {
                        calculateAndDisplayGeneralCommissions();
                    }
                    if (document.getElementById('comision_semanal').classList.contains('active') && (startDateInputWeekly.value && endDateInputWeekly.value)) {
                        calculateAndDisplayWeeklyCommissions();
                    }
                    if (document.getElementById('historial_ventas').classList.contains('active') && (currentHistoryAsesorFilter || currentHistoryMonthFilter)) {
                        populateHistoryFilters(); 
                        loadAndFilterHistoryData();
                    } else if (document.getElementById('historial_ventas').classList.contains('active')) {
                        populateHistoryFilters(); // Actualiza los filtros de asesor/mes
                        displaySalesHistory(allOrdersData); // Mostrar todos los datos si no hay filtros específicos
                    }
                });
            }, error => {
                console.error("Error al escuchar la colección 'excel_daily_summaries':", error);
                showMessageModal("Error de Conexión", "No se pudieron obtener actualizaciones en tiempo real de los datos de Excel.");
            });

            // Oyente para la configuración de comisiones
            db.collection('settings').doc('commission_settings').onSnapshot(doc => {
                if (doc.exists) {
                    const settings = doc.data();
                    monthlyCompanyPairsThreshold = settings.monthlyCompanyPairsThreshold || monthlyCompanyPairsThreshold;
                    monthlyCompanyCommissionAmount = settings.monthlyCompanyCommissionAmount || monthlyCompanyCommissionAmount;
                    monthlyIndividualPairsThreshold = settings.monthlyIndividualPairsThreshold || monthlyIndividualPairsThreshold;
                    weeklyValueBaseThreshold = settings.weeklyValueBaseThreshold || weeklyValueBaseThreshold;
                    weeklyBaseCommissionAmount = settings.weeklyBaseCommissionAmount || weeklyBaseCommissionAmount;
                    weeklyIncrementalValueThreshold = settings.weeklyIncrementalValueThreshold || weeklyIncrementalValueThreshold;
                    weeklyIncrementalBonusAmount = settings.weeklyIncrementalBonusAmount || weeklyIncrementalBonusAmount;
                    console.log("Configuración de comisión cargada de Firestore:", settings);

                    // Vuelve a calcular las comisiones si las pestañas relevantes están activas Y tienen filtros aplicados
                    if (document.getElementById('comision_general').classList.contains('active') && currentGeneralMonthFilter) {
                        calculateAndDisplayGeneralCommissions();
                    }
                    if (document.getElementById('comision_semanal').classList.contains('active') && (startDateInputWeekly.value && endDateInputWeekly.value)) {
                        calculateAndDisplayWeeklyCommissions();
                    }
                } else {
                    // Si el documento de configuración no existe, créalo con los valores por defecto
                    db.collection('settings').doc('commission_settings').set({
                        monthlyCompanyPairsThreshold: monthlyCompanyPairsThreshold,
                        monthlyCompanyCommissionAmount: monthlyCompanyCommissionAmount,
                        monthlyIndividualPairsThreshold: monthlyIndividualPairsThreshold,
                        weeklyValueBaseThreshold: weeklyValueBaseThreshold,
                        weeklyBaseCommissionAmount: weeklyBaseCommissionAmount,
                        weeklyIncrementalValueThreshold: weeklyIncrementalValueThreshold,
                        weeklyIncrementalBonusAmount: weeklyIncrementalBonusAmount
                    }).then(() => {
                        console.log("Configuración de comisión por defecto creada en Firestore.");
                    }).catch(error => {
                        console.error("Error al crear la configuración de comisión por defecto:", error);
                    });
                }
            }, error => {
                console.error("Error al escuchar la configuración de comisión:", error);
            });
        }


        // --- Funciones de la Pestaña DASHBOARD ---

        /**
         * Inicializa los gráficos con datos vacíos o por defecto.
         */
        function initializeChartsDashboard() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    if (context.dataset.label.includes('Valor')) { // Formatear como moneda para gráficos de ventas
                                        label += new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(context.parsed.y);
                                    } else { // Formatear como número para recuentos de pares
                                        label += context.parsed.y.toLocaleString('es-CO');
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            };

            // Destruye los gráficos existentes si existen
            if (salesByDateChart_dashboard) salesByDateChart_dashboard.destroy();
            if (salesByAsesorChart_dashboard) salesByAsesorChart_dashboard.destroy();
            if (pairsByProductChart_dashboard) pairsByProductChart_dashboard.destroy();

            // Gráfico de Ventas por Fecha (Línea)
            salesByDateChart_dashboard = new Chart(document.getElementById('salesByDateChart_dashboard'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Valor de Ventas',
                        data: [],
                        borderColor: '#3B82F6', // Azul
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: chartOptions
            });

            // Gráfico de Ventas por Asesor (Barra)
            salesByAsesorChart_dashboard = new Chart(document.getElementById('salesByAsesorChart_dashboard'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Valor Vendido',
                        data: [],
                        backgroundColor: '#10B981', // Verde Esmeralda
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });

            // Gráfico de Pares por Producto (Barra)
            pairsByProductChart_dashboard = new Chart(document.getElementById('pairsByProductChart_dashboard'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Número de Pares',
                        data: [],
                        backgroundColor: '#F59E0B', // Naranja
                        borderColor: '#D97706',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });
        }

        /**
         * Actualiza el dashboard con los datos filtrados, incluyendo métricas y gráficos.
         * @param {Array} data - Los datos de los pedidos a visualizar.
         */
        function updateDashboardMetricsAndCharts(data) {
            let totalPares = 0;
            let totalValor = 0;
            let totalPedidos = data.length;

            const salesByDate = {}; // { 'YYYY-MM-DD': totalSales }
            const asesorPerformance = {}; // { 'AsesorName': { totalSales: 0, totalPairs: 0 } }
            const pairsByProduct = {}; // { 'ProductName': totalPairs }

            data.forEach(order => {
                totalPares += order.num_pares || 0;
                totalValor += order.valor_total || 0;

                if (order.fecha_hora instanceof Date) {
                    const date = order.fecha_hora.toISOString().split('T')[0];
                    salesByDate[date] = (salesByDate[date] || 0) + (order.valor_total || 0);
                }

                if (order.asesor) {
                    if (!asesorPerformance[order.asesor]) {
                        asesorPerformance[order.asesor] = { totalSales: 0, totalPairs: 0 };
                    }
                    asesorPerformance[order.asesor].totalSales += (order.valor_total || 0);
                    asesorPerformance[order.asesor].totalPairs += (order.num_pares || 0);
                }

                // Asegúrate de que 'productos' es un array y contiene referencias
                if (Array.isArray(order.productos)) {
                    order.productos.forEach(product => {
                        // El campo 'referencia' podría ser directamente el valor si 'productos' no es un array de objetos
                        const productRef = typeof product === 'object' && product !== null && product.referencia ? product.referencia : product;
                        if (productRef) {
                            pairsByProduct[productRef] = (pairsByProduct[productRef] || 0) + 1;
                        }
                    });
                } else if (typeof order.productos === 'string') {
                    // Si 'productos' es una cadena (ej. "Zapato, Bota"), divídela
                    order.productos.split(',').forEach(productRef => {
                        const trimmedRef = productRef.trim();
                        if (trimmedRef) {
                            pairsByProduct[trimmedRef] = (pairsByProduct[trimmedRef] || 0) + 1;
                        }
                    });
                }
            });

            totalParesMetricDashboard.textContent = totalPares.toLocaleString('es-CO');
            totalValorMetricDashboard.textContent = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(totalValor);
            totalPedidosMetricDashboard.textContent = totalPedidos.toLocaleString('es-CO');

            const sortedDates = Object.keys(salesByDate).sort();
            salesByDateChart_dashboard.data.labels = sortedDates;
            salesByDateChart_dashboard.data.datasets[0].data = sortedDates.map(date => salesByDate[date]);
            salesByDateChart_dashboard.update();

            salesByAsesorChart_dashboard.data.labels = Object.keys(asesorPerformance);
            salesByAsesorChart_dashboard.data.datasets[0].data = Object.values(asesorPerformance).map(a => a.totalSales);
            salesByAsesorChart_dashboard.update();

            pairsByProductChart_dashboard.data.labels = Object.keys(pairsByProduct);
            pairsByProductChart_dashboard.data.datasets[0].data = Object.values(pairsByProduct);
            pairsByProductChart_dashboard.update();
        }

        /**
         * Aplica filtros de fecha a allOrdersData y actualiza el dashboard.
         */
        async function loadAndFilterDashboardData() {
            // allOrdersData ya se actualiza mediante el oyente en tiempo real
            let filteredData = [...allOrdersData]; // Trabaja con una copia

            const startDateValue = startDateInputDashboard.value;
            const endDateValue = endDateInputDashboard.value;

            let startDate = null;
            if (startDateValue) {
                // Crea la fecha de inicio al comienzo del día en la zona horaria local.
                const parts = startDateValue.split('-').map(Number);
                startDate = new Date(parts[0], parts[1] - 1, parts[2]); // Mes es 0-indexed
                startDate.setHours(0, 0, 0, 0);
            }

            let endDate = null;
            if (endDateValue) {
                // Crea la fecha de fin al final del día en la zona horaria local.
                const parts = endDateValue.split('-').map(Number);
                endDate = new Date(parts[0], parts[1] - 1, parts[2]); // Mes es 0-indexed
                endDate.setHours(23, 59, 59, 999); // Establece la hora al final del día
            }

            filteredData = filteredData.filter(order => {
                const orderDate = order.fecha_hora;
                if (!orderDate || !(orderDate instanceof Date)) return false;

                let matchesFilter = true;
                if (startDate) {
                    matchesFilter = matchesFilter && orderDate >= startDate;
                }
                if (endDate) {
                    matchesFilter = matchesFilter && orderDate <= endDate;
                }
                return matchesFilter;
            });

            updateDashboardMetricsAndCharts(filteredData);
        }

        /**
         * Maneja la carga de un archivo Excel y lo guarda en Firestore.
         */
        async function handleExcelUploadDashboard() {
            const file = excelFileInputDashboard.files[0];
            if (!file) {
                showMessageModal("Error de Archivo", "Por favor, selecciona un archivo Excel para subir.");
                return;
            }

            showLoading();

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    const dailySummariesToUpload = {};

                    json.forEach(row => {
                        let fechaHora;
                        // Usar el nombre de columna "Fecha y Hora"
                        const dateColumnName = 'Fecha y Hora'; 
                        
                        if (row[dateColumnName] !== undefined) {
                            if (typeof row[dateColumnName] === 'number') {
                                // Las fechas de Excel son números de serie. 
                                // Para convertirlas a Date de JS en hora local:
                                // El 25569 es la diferencia de días entre 1900-01-01 y 1970-01-01 (en formato de Excel).
                                // Multiplicamos por 86400000 ms por día.
                                fechaHora = new Date((row[dateColumnName] - 25569) * 86400 * 1000);
                                // Ajuste para la zona horaria local si es necesario (el constructor Date ya lo hace)
                                fechaHora.setMinutes(fechaHora.getMinutes() + fechaHora.getTimezoneOffset());
                            } else if (typeof row[dateColumnName] === 'string') {
                                // Para cadenas, parsear como fecha local al inicio del día
                                fechaHora = new Date(row[dateColumnName] + 'T00:00:00');
                            }
                        }

                        if (!fechaHora || isNaN(fechaHora.getTime())) {
                            console.warn("Fila ignorada debido a fecha inválida:", row);
                            return;
                        }

                        const dateKey = fechaHora.toISOString().split('T')[0];
                        const asesorName = row['Asesor'] || 'Desconocido'; // Usar el encabezado "Asesor"
                        const docId = `${dateKey}_${asesorName.replace(/\s/g, '_')}`; // Generar un ID limpio y único

                        if (!dailySummariesToUpload[docId]) {
                            dailySummariesToUpload[docId] = {
                                fecha_hora: fechaHora,
                                asesor: asesorName,
                                num_pares: 0,
                                valor_total: 0
                            };
                        }
                        dailySummariesToUpload[docId].num_pares += parseInt(row['Num Pares']) || 0; // Usar "Num Pares"
                        dailySummariesToUpload[docId].valor_total += parseFloat(row['Valor Total']) || 0; // Usar "Valor Total"
                    });

                    const batch = db.batch();
                    let uploadCount = 0;
                    for (const docId in dailySummariesToUpload) {
                        const dataToSave = dailySummariesToUpload[docId];
                        const docRef = db.collection('excel_daily_summaries').doc(docId);
                        batch.set(docRef, {
                            fecha_hora: firebase.firestore.Timestamp.fromDate(dataToSave.fecha_hora),
                            asesor: dataToSave.asesor,
                            num_pares: dataToSave.num_pares,
                            valor_total: dataToSave.valor_total,
                            source: 'excel_upload'
                        });
                        uploadCount++;
                    }

                    if (uploadCount > 0) {
                        await batch.commit();
                        showMessageModal("Carga Exitosa", `Archivo Excel procesado y ${uploadCount} resúmenes diarios subidos/actualizados en Firestore.`);
                    } else {
                        showMessageModal("Carga Completada", "Archivo Excel procesado, pero no se encontraron datos válidos para subir.");
                    }
                    
                    excelFileInputDashboard.value = '';
                    // El oyente en tiempo real se encargará de activar loadAndFilterDashboardData
                } catch (error) {
                    console.error("Error al procesar o subir el archivo Excel:", error);
                    showMessageModal("Error", "Error al procesar o subir el archivo Excel. Revisa la consola para más detalles.");
                } finally {
                    hideLoading();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        /**
         * Muestra un modal de confirmación antes de eliminar todos los datos de Excel.
         */
        function showDeleteConfirmationExcel() {
            mostrarModal('delete_confirmation_modal');
        }

        /**
         * Elimina todos los documentos de la colección 'excel_daily_summaries' en Firestore.
         */
        async function confirmDeleteExcelData() {
            cerrarModal('delete_confirmation_modal');
            showLoading();
            try {
                const collectionRef = db.collection('excel_daily_summaries');
                const snapshot = await collectionRef.get();
                
                if (snapshot.empty) {
                    showMessageModal("Información", "No hay datos de Excel cargados para eliminar.");
                    return;
                }

                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                showMessageModal("Eliminación Exitosa", `Se eliminaron ${snapshot.size} documentos de la colección 'excel_daily_summaries'.`);
                // El oyente en tiempo real se encargará de activar loadAndFilterDashboardData
            } catch (error) {
                console.error("Error al eliminar datos de Excel de Firestore:", error);
                showMessageModal("Error", "Error al eliminar datos de Excel. Revisa la consola para más detalles.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Establece el rango de fechas para la semana actual (lunes a sábado) y aplica el filtro para el dashboard.
         */
        function filterCurrentWeekDashboard() {
            currentDashboardFilterMode = 'quick_week';
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 para Domingo, 1 para Lunes, ..., 6 para Sábado
            
            const daysToMonday = (dayOfWeek === 0) ? 6 : (dayOfWeek - 1);
            const monday = new Date(today);
            monday.setDate(today.getDate() - daysToMonday);
            monday.setHours(0, 0, 0, 0);

            const saturday = new Date(monday);
            saturday.setDate(monday.getDate() + 5); 
            saturday.setHours(23, 59, 59, 999);

            startDateInputDashboard.value = monday.toISOString().split('T')[0];
            endDateInputDashboard.value = saturday.toISOString().split('T')[0];
            loadAndFilterDashboardData();
        }

        /**
         * Establece el rango de fechas para el mes actual y aplica el filtro para el dashboard.
         */
        function filterCurrentMonthDashboard() {
            currentDashboardFilterMode = 'quick_month';
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            firstDay.setHours(0, 0, 0, 0);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            lastDay.setHours(23, 59, 59, 999);

            startDateInputDashboard.value = firstDay.toISOString().split('T')[0];
            endDateInputDashboard.value = lastDay.toISOString().split('T')[0];
            loadAndFilterDashboardData();
        }

        /**
         * Maneja la selección de mes desde el desplegable para el dashboard.
         */
        function handleMonthSelectionDashboard() {
            currentDashboardFilterMode = 'quick_month';
            const selectedMonth = monthSelectorDashboard.value;
            if (selectedMonth) {
                const year = parseInt(selectedMonth.split('-')[0]);
                const month = parseInt(selectedMonth.split('-')[1]) - 1; // Mes es 0-indexed

                const firstDay = new Date(year, month, 1);
                firstDay.setHours(0, 0, 0, 0);
                const lastDay = new Date(year, month + 1, 0);
                lastDay.setHours(23, 59, 59, 999);

                startDateInputDashboard.value = firstDay.toISOString().split('T')[0];
                endDateInputDashboard.value = lastDay.toISOString().split('T')[0];
                loadAndFilterDashboardData();
            } else {
                startDateInputDashboard.value = '';
                endDateInputDashboard.value = '';
                // Si no se selecciona ningún mes, mostrar todos los datos de la fuente combinada
                updateDashboardMetricsAndCharts(allOrdersData); 
            }
        }

        /**
         * Reinicia los filtros del dashboard.
         */
        function resetDashboardFilters() {
            startDateInputDashboard.value = '';
            endDateInputDashboard.value = '';
            monthSelectorDashboard.value = '';
            includeExcelDataCheckbox.checked = true; // Reinicia a true por defecto
            localStorage.setItem('includeExcelData', true);
            includeExcelData = true; // Actualiza la bandera global
            currentDashboardFilterMode = 'custom_date_range'; // Reinicia el modo

            // Volver a obtener todos los datos para asegurar que los datos de Excel se incluyan nuevamente
            fetchAllOrdersFromFirestore().then(() => {
                // Después de reiniciar los filtros, mostrar todos los datos combinados.
                updateDashboardMetricsAndCharts(allOrdersData);
            });
            showMessageModal("Dashboard Reiniciado", "Los filtros del Dashboard han sido reiniciados. Todos los datos están ahora visibles.");
        }


        // --- Funciones de la Pestaña COMISION GENERAL ---

        /**
         * Calcula y muestra las comisiones generales (mensuales) según el mes seleccionado.
         */
        function calculateAndDisplayGeneralCommissions() {
            currentGeneralMonthFilter = monthSelectorGeneral.value;

            let filteredData = [...allOrdersData]; // Inicia con todos los datos

            // Aplica el filtro de mes si se selecciona un mes
            if (currentGeneralMonthFilter) {
                const [year, month] = currentGeneralMonthFilter.split('-').map(Number);
                // Crea las fechas de inicio y fin para el mes seleccionado (hora local)
                const firstDayOfMonth = new Date(year, month - 1, 1); // Mes es 0-indexed
                firstDayOfMonth.setHours(0, 0, 0, 0);
                const lastDayOfMonth = new Date(year, month, 0); // Último día del mes seleccionado
                lastDayOfMonth.setHours(23, 59, 59, 999); // Asegura que se incluya todo el día

                filteredData = filteredData.filter(order => {
                    const orderDate = order.fecha_hora;
                    // Asegura que orderDate sea un objeto Date válido para la comparación
                    return orderDate instanceof Date && orderDate >= firstDayOfMonth && orderDate <= lastDayOfMonth;
                });
            } else {
                // Si no se selecciona ningún mes, limpia la visualización o muestra un mensaje
                generalCommissionSummaryDiv.innerHTML = '<p class="text-center text-gray-500">Selecciona un mes para calcular la comisión general.</p>';
                return;
            }


            let totalCompanyPairsFilteredPeriod = 0;
            const asesorMonthlyPerformance = {}; // { 'AsesorName': { totalSales: 0, totalPairs: 0 } }

            filteredData.forEach(order => {
                totalCompanyPairsFilteredPeriod += order.num_pares || 0;
                if (order.asesor) {
                    if (!asesorMonthlyPerformance[order.asesor]) {
                        asesorMonthlyPerformance[order.asesor] = { totalSales: 0, totalPairs: 0 };
                    }
                    asesorMonthlyPerformance[order.asesor].totalSales += (order.valor_total || 0);
                    asesorMonthlyPerformance[order.asesor].totalPairs += (order.num_pares || 0);
                }
            });

            let commissionHtml = `
                <h3 class="text-xl font-semibold mb-4">Resumen de Comisión General ${currentGeneralMonthFilter ? `(Mes: ${new Date(currentGeneralMonthFilter + '-01').toLocaleDateString('es-CO', { month: 'long', year: 'numeric' })})` : '(Todos los períodos)'}</h3>
                <p class="mb-2"><strong>Tope de Pares (Empresa):</strong> ${monthlyCompanyPairsThreshold.toLocaleString('es-CO')} pares</p>
                <p class="mb-2"><strong>Total Pares Vendidos (Empresa en período filtrado):</strong> ${totalCompanyPairsFilteredPeriod.toLocaleString('es-CO')} pares</p>
                <p class="mb-4"><strong>Empresa cumple el tope:</strong> ${totalCompanyPairsFilteredPeriod >= monthlyCompanyPairsThreshold ? '<span class="text-green-600 font-bold">SÍ</span>' : '<span class="text-red-600 font-bold">NO</span>'}</p>
                <table class="commission-table">
                    <thead>
                        <tr>
                            <th>Asesor</th>
                            <th>Pares Vendidos</th>
                            <th>Valor Vendido</th>
                            <th>Comisión Mensual</th>
                            <th>Estado Individual</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const companyMeetsMonthlyPairsTarget = (monthlyCompanyPairsThreshold > 0 && totalCompanyPairsFilteredPeriod >= monthlyCompanyPairsThreshold);

            // Ordenar asesores alfabéticamente
            const sortedAsesores = Object.keys(asesorMonthlyPerformance).sort();

            if (sortedAsesores.length === 0) {
                 generalCommissionSummaryDiv.innerHTML = '<p class="text-center text-gray-500">No hay datos de asesores para calcular comisiones generales en el período seleccionado.</p>';
                 return;
            }

            sortedAsesores.forEach(asesor => {
                const { totalSales, totalPairs } = asesorMonthlyPerformance[asesor];
                let monthlyCommission = 0;
                let individualStatus = '';
                let statusColorClass = 'text-red-600';

                if (companyMeetsMonthlyPairsTarget) {
                    if (monthlyIndividualPairsThreshold > 0) {
                        if (totalPairs >= monthlyIndividualPairsThreshold) {
                            monthlyCommission = monthlyCompanyCommissionAmount;
                            individualStatus = `Cumple (${totalPairs.toLocaleString('es-CO')}/${monthlyIndividualPairsThreshold.toLocaleString('es-CO')} pares)`;
                            statusColorClass = 'text-green-600';
                        } else if (totalPairs >= (monthlyIndividualPairsThreshold / 2)) {
                            monthlyCommission = monthlyCompanyCommissionAmount / 2;
                            individualStatus = `Cumple (50% de tope: ${totalPairs.toLocaleString('es-CO')}/${monthlyIndividualPairsThreshold.toLocaleString('es-CO')} pares)`;
                            statusColorClass = 'text-orange-500'; // Un color diferente para cumplimiento parcial
                        } else {
                            individualStatus = `No cumple (${totalPairs.toLocaleString('es-CO')}/${monthlyIndividualPairsThreshold.toLocaleString('es-CO')} pares)`;
                        }
                    } else { // No hay tope individual establecido
                        monthlyCommission = monthlyCompanyCommissionAmount;
                        individualStatus = `Cumple (no requiere tope individual)`;
                        statusColorClass = 'text-green-600';
                    }
                } else {
                    individualStatus = `Empresa no cumple el tope general`;
                }

                commissionHtml += `
                    <tr>
                        <td>${asesor}</td>
                        <td>${totalPairs.toLocaleString('es-CO')}</td>
                        <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(totalSales)}</td>
                        <td class="${statusColorClass}">${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(monthlyCommission)}</td>
                        <td>${individualStatus}</td>
                    </tr>
                `;
            });
            commissionHtml += '</tbody></table>';
            generalCommissionSummaryDiv.innerHTML = commissionHtml;
        }

        /**
         * Guarda la configuración de la comisión general en Firestore.
         */
        async function saveCommissionGeneralSettings() {
            const newMonthlyCompanyPairsThreshold = parseFloat(monthlyCompanyPairsThresholdInput.value);
            const newMonthlyCompanyCommissionAmount = parseFloat(monthlyCompanyCommissionAmountInput.value);
            const newMonthlyIndividualPairsThreshold = parseFloat(monthlyIndividualPairsThresholdInput.value);

            if (isNaN(newMonthlyCompanyPairsThreshold) || newMonthlyCompanyPairsThreshold < 0 ||
                isNaN(newMonthlyCompanyCommissionAmount) || newMonthlyCompanyCommissionAmount < 0 ||
                isNaN(newMonthlyIndividualPairsThreshold) || newMonthlyIndividualPairsThreshold < 0) {
                showMessageModal("Error de Configuración", "Por favor, ingrese valores válidos y no negativos para todas las configuraciones.");
                return;
            }

            try {
                await db.collection('settings').doc('commission_settings').set({
                    monthlyCompanyPairsThreshold: newMonthlyCompanyPairsThreshold,
                    monthlyCompanyCommissionAmount: newMonthlyCompanyCommissionAmount,
                    monthlyIndividualPairsThreshold: newMonthlyIndividualPairsThreshold
                }, { merge: true }); // Usar merge para solo actualizar estos campos
                showMessageModal("Configuración Guardada", "Configuración de comisión general guardada correctamente.");
                cerrarModal('commission_general_settings_modal');
                // El oyente en tiempo real se encargará de activar calculateAndDisplayGeneralCommissions()
            } catch (error) {
                console.error("Error al guardar la configuración de comisión general:", error);
                showMessageModal("Error", "Error al guardar la configuración de comisión general.");
            }
        }

        /**
         * Reinicia el filtro de la comisión general.
         */
        function resetGeneralFilter() {
            monthSelectorGeneral.value = ''; // Reinicia el selector de mes
            currentGeneralMonthFilter = ''; // Reinicia la variable de filtro
            generalCommissionSummaryDiv.innerHTML = '<p class="text-center text-gray-500">Selecciona un mes para calcular la comisión general.</p>';
            showMessageModal("Filtro Reiniciado", "El filtro de Comisión General ha sido reiniciado. Selecciona un mes para ver los datos.");
        }


        // --- Funciones de la Pestaña COMISION SEMANAL (SIN CAMBIOS EN LA LÓGICA DE CÁLCULO) ---

        /**
         * Calculates and displays weekly commissions based on the selected date range.
         */
        function calculateAndDisplayWeeklyCommissions() {
            const startDateValue = startDateInputWeekly.value;
            const endDateValue = endDateInputWeekly.value;

            if (!startDateValue || !endDateValue) {
                weeklyCommissionSummaryDiv.innerHTML = '<p class="text-center text-gray-500">Por favor, selecciona un rango de fechas para calcular la comisión semanal.</p>';
                return;
            }

            // Parse dates to ensure they are interpreted in local time at the start of the day
            const startDateParts = startDateValue.split('-').map(Number); // [year, month, day]
            const startDate = new Date(startDateParts[0], startDateParts[1] - 1, startDateParts[2]); // Month is 0-indexed
            startDate.setHours(0, 0, 0, 0); // Set to start of day

            const endDateParts = endDateValue.split('-').map(Number);
            let endDate = new Date(endDateParts[0], endDateParts[1] - 1, endDateParts[2]); // Month is 0-indexed
            endDate.setHours(23, 59, 59, 999); // Set to end of the selected day

            const filteredData = allOrdersData.filter(order => {
                const orderDate = order.fecha_hora;
                return orderDate instanceof Date && orderDate >= startDate && orderDate <= endDate;
            });

            // Aggregate sales for each asesor within the selected custom period
            const asesorCustomPeriodPerformance = {}; // { 'AsesorName': { totalSales: 0, totalPairs: 0 } }

            filteredData.forEach(order => {
                if (order.asesor) {
                    if (!asesorCustomPeriodPerformance[order.asesor]) {
                        asesorCustomPeriodPerformance[order.asesor] = { totalSales: 0, totalPairs: 0 };
                    }
                    asesorCustomPeriodPerformance[order.asesor].totalSales += (order.valor_total || 0);
                    asesorCustomPeriodPerformance[order.asesor].totalPairs += (order.num_pares || 0);
                }
            });

            // For display purposes, use the values from the input fields directly
            const displayStartDate = new Date(startDateInputWeekly.value + 'T00:00:00'); 
            const displayEndDate = new Date(endDateInputWeekly.value + 'T00:00:00'); 

            let commissionHtml = `
                <h3 class="text-xl font-semibold mb-4">Resumen de Comisión Semanal (${displayStartDate.toLocaleDateString('es-CO')} - ${displayEndDate.toLocaleDateString('es-CO')})</h3>
                <table class="commission-table">
                    <thead>
                        <tr>
                            <th>Asesor</th>
                            <th>Valor Vendido (Período)</th>
                            <th>Comisión Semanal</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const sortedAsesores = Object.keys(asesorCustomPeriodPerformance).sort();

            sortedAsesores.forEach(asesor => {
                const { totalSales: customPeriodTotalSales } = asesorCustomPeriodPerformance[asesor];
                let currentCommission = 0;
                let details = [];
                let meetsCriteria = false;

                if (weeklyValueBaseThreshold > 0 && customPeriodTotalSales >= weeklyValueBaseThreshold) {
                    currentCommission += weeklyBaseCommissionAmount;
                    details.push(`Base: Cumple ($${customPeriodTotalSales.toLocaleString('es-CO')}/$${weeklyValueBaseThreshold.toLocaleString('es-CO')})`);
                    meetsCriteria = true;
                } else if (weeklyValueBaseThreshold > 0) {
                    details.push(`Base: No cumple ($${customPeriodTotalSales.toLocaleString('es-CO')}/$${weeklyValueBaseThreshold.toLocaleString('es-CO')})`);
                }

                if (weeklyIncrementalValueThreshold > 0 && customPeriodTotalSales > weeklyValueBaseThreshold) {
                    const excessValue = customPeriodTotalSales - weeklyValueBaseThreshold;
                    const increments = Math.floor(excessValue / weeklyIncrementalValueThreshold);
                    if (increments > 0) {
                        const incrementalBonus = increments * weeklyIncrementalBonusAmount;
                        currentCommission += incrementalBonus;
                        details.push(`Inc: $${incrementalBonus.toLocaleString('es-CO')} (${increments}x$${weeklyIncrementalValueThreshold.toLocaleString('es-CO')})`);
                        meetsCriteria = true;
                    }
                }

                const commissionColorClass = meetsCriteria ? 'text-green-600' : 'text-red-600';
                const formattedCurrentCommission = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(currentCommission);

                commissionHtml += `
                    <tr>
                        <td>${asesor}</td>
                        <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(customPeriodTotalSales)}</td>
                        <td class="${commissionColorClass}">${formattedCurrentCommission}</td>
                        <td>${details.join(', ') || (weeklyValueBaseThreshold === 0 && weeklyIncrementalValueThreshold === 0 ? 'Topes no configurados' : 'No cumple criterios')}</td>
                    </tr>
                `;
            });

            commissionHtml += '</tbody></table>';
            weeklyCommissionSummaryDiv.innerHTML = commissionHtml;

            if (Object.keys(asesorCustomPeriodPerformance).length === 0) {
                weeklyCommissionSummaryDiv.innerHTML = '<p class="text-center text-gray-500">No hay datos de ventas para el período seleccionado.</p>';
            }
        }

        /**
         * Saves weekly commission settings to Firestore.
         */
        async function saveCommissionWeeklySettings() {
            const newWeeklyValueBaseThreshold = parseFloat(weeklyValueBaseThresholdInput.value);
            const newWeeklyBaseCommissionAmount = parseFloat(weeklyBaseCommissionAmountInput.value);
            const newWeeklyIncrementalValueThreshold = parseFloat(weeklyIncrementalValueThresholdInput.value);
            const newWeeklyIncrementalBonusAmount = parseFloat(weeklyIncrementalBonusAmountInput.value);

            if (isNaN(newWeeklyValueBaseThreshold) || newWeeklyValueBaseThreshold < 0 ||
                isNaN(newWeeklyBaseCommissionAmount) || newWeeklyBaseCommissionAmount < 0 ||
                isNaN(newWeeklyIncrementalValueThreshold) || newWeeklyIncrementalValueThreshold < 0 ||
                isNaN(newWeeklyIncrementalBonusAmount) || newWeeklyIncrementalBonusAmount < 0) {
                showMessageModal("Error de Configuración", "Por favor, ingrese valores válidos y no negativos para todas las configuraciones.");
                return;
            }

            try {
                await db.collection('settings').doc('commission_settings').set({
                    weeklyValueBaseThreshold: newWeeklyValueBaseThreshold,
                    weeklyBaseCommissionAmount: newWeeklyBaseCommissionAmount,
                    weeklyIncrementalValueThreshold: newWeeklyIncrementalValueThreshold,
                    weeklyIncrementalBonusAmount: newWeeklyIncrementalBonusAmount
                }, { merge: true }); // Usar merge para solo actualizar estos campos
                showMessageModal("Configuración Guardada", "Configuración de comisión semanal guardada correctamente.");
                cerrarModal('commission_weekly_settings_modal');
                // El oyente en tiempo real se encargará de activar calculateAndDisplayWeeklyCommissions()
            } catch (error) {
                console.error("Error al guardar la configuración de comisión semanal:", error);
                showMessageModal("Error", "Error al guardar la configuración de comisión semanal.");
            }
        }

        /**
         * Establece el rango de fechas para la semana actual (lunes a sábado) y aplica el filtro para la comisión semanal.
         */
        function filterCurrentWeekWeekly() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 para Domingo, 1 para Lunes, ..., 6 para Sábado
            
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); // Ajusta a Lunes
            monday.setHours(0, 0, 0, 0); // Inicio del día

            const saturday = new Date(monday);
            saturday.setDate(monday.getDate() + 5); 
            saturday.setHours(0, 0, 0, 0); // Establece la hora al inicio del día para el input

            startDateInputWeekly.value = monday.toISOString().split('T')[0];
            endDateInputWeekly.value = saturday.toISOString().split('T')[0];
            calculateAndDisplayWeeklyCommissions();
        }

        /**
         * Establece el rango de fechas para la semana pasada (lunes a sábado) y aplica el filtro para la comisión semanal.
         */
        function filterLastWeekWeekly() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 para Domingo, 1 para Lunes, ..., 6 para Sábado
            
            const currentMonday = new Date(today);
            currentMonday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); // Ajusta al lunes actual
            currentMonday.setHours(0, 0, 0, 0); // Inicio del día

            const lastMonday = new Date(currentMonday);
            lastMonday.setDate(currentMonday.getDate() - 7); // Resta 7 días para obtener el lunes pasado
            lastMonday.setHours(0, 0, 0, 0); // Inicio del día

            const lastSaturday = new Date(lastMonday);
            lastSaturday.setDate(lastMonday.getDate() + 5); 
            lastSaturday.setHours(0, 0, 0, 0); // Establece la hora al inicio del día para el input

            startDateInputWeekly.value = lastMonday.toISOString().split('T')[0];
            endDateInputWeekly.value = lastSaturday.toISOString().split('T')[0];
            calculateAndDisplayWeeklyCommissions();
        }

        /**
         * Reinicia el filtro de la comisión semanal.
         */
        function resetWeeklyFilter() {
            startDateInputWeekly.value = '';
            endDateInputWeekly.value = '';
            weeklyCommissionSummaryDiv.innerHTML = '<p class="text-center text-gray-500">Selecciona un rango de fechas para calcular la comisión semanal.</p>';
            currentWeeklyFilterMode = 'custom_date_range'; // Reinicia el modo
        }


        // --- Funciones de la Pestaña VER HISTORIAL ---

        /**
         * Popula los filtros de asesor y mes para la pestaña de historial.
         */
        function populateHistoryFilters() {
            const asesores = new Set();
            const months = new Set();

            allOrdersData.forEach(order => {
                if (order.asesor) {
                    asesores.add(order.asesor);
                }
                if (order.fecha_hora instanceof Date) {
                    months.add(order.fecha_hora.toISOString().slice(0, 7)); // Formato YYYY-MM
                }
            });

            // Popula el filtro de Asesor
            filterAsesorHistory.innerHTML = '<option value="">Todos</option>';
            Array.from(asesores).sort().forEach(asesor => {
                const option = document.createElement('option');
                option.value = asesor;
                option.textContent = asesor;
                filterAsesorHistory.appendChild(option);
            });
            filterAsesorHistory.value = currentHistoryAsesorFilter; // Restaura la selección

            // Popula el filtro de Mes
            filterMonthHistory.innerHTML = '<option value="">Todos los Meses</option>';
            Array.from(months).sort().reverse().forEach(monthValue => { // Ordena de forma descendente para que los más recientes aparezcan primero
                const [year, month] = monthValue.split('-').map(Number);
                const date = new Date(year, month - 1, 1); // mes - 1 porque los meses de Date son 0-indexed
                const monthName = date.toLocaleString('es-CO', { month: 'long', year: 'numeric' });
                const option = document.createElement('option');
                option.value = monthValue;
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                filterMonthHistory.appendChild(option);
            });
            filterMonthHistory.value = currentHistoryMonthFilter; // Restaura la selección
        }

        /**
         * Carga y filtra los datos del historial de ventas.
         */
        function loadAndFilterHistoryData() {
            currentHistoryAsesorFilter = filterAsesorHistory.value;
            currentHistoryMonthFilter = filterMonthHistory.value;

            let filteredHistoryData = [...allOrdersData];

            if (currentHistoryAsesorFilter) {
                filteredHistoryData = filteredHistoryData.filter(order => order.asesor === currentHistoryAsesorFilter);
            }
            if (currentHistoryMonthFilter) {
                filteredHistoryData = filteredHistoryData.filter(order => {
                    if (order.fecha_hora instanceof Date) {
                        // Asegura que la comparación se haga correctamente con la cadena ISO
                        return order.fecha_hora.toISOString().startsWith(currentHistoryMonthFilter);
                    }
                    return false;
                });
            }

            displaySalesHistory(filteredHistoryData);
        }

        /**
         * Muestra el historial de ventas filtrado en una tabla.
         * @param {Array} data - Los datos de ventas filtrados.
         */
        function displaySalesHistory(data) {
            if (data.length === 0) {
                salesHistoryList.innerHTML = '<p class="text-center text-gray-500">No hay historial de ventas para los filtros seleccionados.</p>';
                return;
            }

            let totalParesHistory = 0;
            let totalValorHistory = 0;

            // Ordena los datos por fecha antes de mostrarlos
            data.sort((a, b) => {
                const dateA = a.fecha_hora instanceof Date ? a.fecha_hora.getTime() : 0;
                const dateB = b.fecha_hora instanceof Date ? b.fecha_hora.getTime() : 0;
                return dateA - dateB;
            });

            data.forEach(order => {
                totalParesHistory += order.num_pares || 0;
                totalValorHistory += order.valor_total || 0;
            });

            let historyHtml = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Asesor</th>
                            <th>Pares</th>
                            <th>Valor Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(order => {
                const dateFormatted = order.fecha_hora instanceof Date ? order.fecha_hora.toLocaleDateString('es-CO') : 'N/A';
                historyHtml += `
                    <tr>
                        <td>${dateFormatted}</td>
                        <td>${order.asesor || 'N/A'}</td>
                        <td>${order.num_pares || 0}</td>
                        <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(order.valor_total || 0)}</td>
                    </tr>
                `;
            });

            historyHtml += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2" class="text-right font-bold">Total General:</td>
                            <td class="font-bold">${totalParesHistory.toLocaleString('es-CO')}</td>
                            <td class="font-bold">${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(totalValorHistory)}</td>
                        </tr>
                    </tfoot>
                </table>
            `;
            salesHistoryList.innerHTML = historyHtml;
        }

        /**
         * Reinicia los filtros del historial.
         */
        function resetHistoryFilters() {
            filterAsesorHistory.value = '';
            filterMonthHistory.value = '';
            currentHistoryAsesorFilter = '';
            currentHistoryMonthFilter = '';
            salesHistoryList.innerHTML = '<p class="text-center text-gray-500">Aplica filtros para ver el historial de ventas.</p>';
            showMessageModal("Filtros Reiniciados", "Los filtros del historial de ventas han sido reiniciados. Aplica un nuevo filtro para ver los datos.");
        }


        // --- Oyentes de Eventos y Carga Inicial ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa los gráficos para la pestaña del dashboard
            initializeChartsDashboard();
            populateMonthSelector(monthSelectorDashboard); // Para el filtro de mes del dashboard

            // Carga el estado inicial del checkbox "Incluir datos de Excel"
            includeExcelData = (localStorage.getItem('includeExcelData') !== null) ? (localStorage.getItem('includeExcelData') === 'true') : true; 
            includeExcelDataCheckbox.checked = includeExcelData;

            // Configura los oyentes en tiempo real para todas las colecciones relevantes
            setupRealtimeListeners();

            // Activa la primera pestaña (DASHBOARD) al cargar, pero no carga los datos inmediatamente
            document.querySelector('.tab-button').click(); 

            // Oyentes de Eventos de la Pestaña Dashboard
            uploadExcelBtnDashboard.addEventListener('click', handleExcelUploadDashboard);
            deleteExcelDataBtnDashboard.addEventListener('click', showDeleteConfirmationExcel);
            filterDataBtnDashboard.addEventListener('click', () => {
                currentDashboardFilterMode = 'custom_date_range';
                loadAndFilterDashboardData();
            });
            monthSelectorDashboard.addEventListener('change', handleMonthSelectionDashboard);
            filterCurrentWeekBtnDashboard.addEventListener('click', filterCurrentWeekDashboard);
            filterCurrentMonthBtnDashboard.addEventListener('click', filterCurrentMonthDashboard);
            resetDashboardBtnDashboard.addEventListener('click', resetDashboardFilters);
            includeExcelDataCheckbox.addEventListener('change', () => {
                includeExcelData = includeExcelDataCheckbox.checked;
                localStorage.setItem('includeExcelData', includeExcelData);
                // Volver a obtener todos los datos para asegurar que los datos de Excel se incluyan/excluyan correctamente
                fetchAllOrdersFromFirestore().then(() => {
                    // Después de cambiar el checkbox, si hay filtros aplicados, re-aplicarlos; de lo contrario, mostrar todos.
                    if (startDateInputDashboard.value || endDateInputDashboard.value || monthSelectorDashboard.value || currentDashboardFilterMode !== 'custom_date_range') {
                         loadAndFilterDashboardData(); 
                    } else {
                        updateDashboardMetricsAndCharts(allOrdersData);
                    }
                    populateHistoryFilters(); // Actualizar los asesores y meses disponibles en el historial
                });
            });

            // Oyentes de Eventos de la Pestaña Comisión General
            filterDataBtnGeneral.addEventListener('click', calculateAndDisplayGeneralCommissions);
            resetFilterBtnGeneral.addEventListener('click', resetGeneralFilter);


            // Oyentes de Eventos de la Pestaña Comisión Semanal
            filterDataBtnWeekly.addEventListener('click', () => {
                currentWeeklyFilterMode = 'custom_date_range';
                calculateAndDisplayWeeklyCommissions();
            });
            resetFilterBtnWeekly.addEventListener('click', resetWeeklyFilter);
            filterCurrentWeekBtnWeekly.addEventListener('click', filterCurrentWeekWeekly); // Nuevo botón
            filterLastWeekBtnWeekly.addEventListener('click', filterLastWeekWeekly); // Nuevo botón

            // Oyentes de Eventos de la Pestaña Historial
            applyFilterHistoryBtn.addEventListener('click', loadAndFilterHistoryData);
            resetFilterHistoryBtn.addEventListener('click', resetHistoryFilters);
        });
    </script>
</body>
</html>
